{"posts":[{"title":"è§£æ mutableStateOf æºç ","text":"å…¶å®åŸç†æ€§åˆ†æçš„æ–‡ç« ï¼ŒçœŸçš„å¾ˆéš¾è®²çš„é€šä¿—æ˜“æ‡‚ï¼Œè®²çš„ç®€å•æµ…æ˜¾æ²¡å¿…è¦å†™ï¼Œè®²çš„ç¹çéš¾æ‡‚å¾€å¾€å¤§å®¶ä¹Ÿä¸ä¹æ„çœ‹ï¼Œæ‰€ä»¥æ€ä¹ˆæ‰¾ä¸ªå¥½çš„è§’åº¦æ…¢æ…¢é’»è¿›å»å°¤ä¸ºé‡è¦ï¼Œæ¯”å¦‚ï¼šBegin simple codeï¼Œå¦‚æœç¡®å®èƒ½å¸®åŠ©åˆ°å¤§å®¶å®Œå…¨ç†è§£äº†æ–‡ç« æ‰€è®²è¿°åˆ°çš„æºç ç†è®ºï¼Œé‚£å°±ç‚¹ä¸ªèµå§ï¼ å¼•å…¥è¯é¢˜ æ­£å¦‚æˆ‘ä¸Šé¢è¯´çš„ï¼Œç›´æ¥è®²åŸç†å¤ªæ¯ç‡¥ï¼ˆä½ ä¹Ÿä¼šå¾ˆæ‡µï¼‰ï¼Œæˆ‘å–œæ¬¢ä»ç®€å•ä»£ç å…¥æ‰‹ï¼Œå¸¦ä½ ä¸€ç‚¹ç‚¹è¿›å…¥ï¼Œç°åœ¨å¼€å§‹ã€‚å…ˆçœ‹ä¸€ä¸ªæœ€ç®€å•çš„ä»£ç ç¤ºä¾‹ï¼š 1234567891011121314class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) // è¿™ç§å®šä¹‰å˜é‡çš„æ–¹å¼éšå¤„å¯è§äº† val name = mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { Text(name.value) } } }} æˆ‘å…ˆæ¥ç®€å•è§£è¯»ä¸€ä¸‹è¿™æ®µä»£ç çš„åŸç†ï¼š å½“æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç”¨ mutableStateOf åŒ…èµ·æ¥åï¼Œå®ƒå°±å˜æˆäº†ä¸€ä¸ª MutableState ç±»å‹çš„å¯¹è±¡ã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬å–å€¼çš„è¯å°±å¿…é¡»è¦å†™ name.valueï¼Œè¿™æ ·èƒ½æ‰èƒ½å–åˆ° â€œComposeâ€ï¼Œå› ä¸ºname ä¸å†æ˜¯ä¸€ä¸ª Stringï¼Œè€Œæ˜¯ MutableState å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å«â€œçŠ¶æ€â€ ã€‚ æ­¤æ—¶ï¼Œname æ˜¯ä¸€ä¸ªè¢«è®¢é˜…çš„çŠ¶æ€ï¼Œname.value å°±æ˜¯ä¸€ä¸ªè¢«è®¢é˜…çš„å€¼ï¼Œå¦‚æœå®ƒå‘ç”Ÿå˜åŒ–ï¼ŒText() å‡½æ•°å°±ä¼šé‡æ–°æ‰§è¡Œä¸€éï¼Œæ›´æ–°åˆ°æœ€æ–°çš„å€¼ã€‚ ç°åœ¨æˆ‘ä»¬ä¿®æ”¹ä¸‹ä»£ç ï¼Œ3s åæ”¹å˜ name.value çš„å€¼ï¼š 123456789101112131415161718class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) val name = mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { Text(name.value) } LaunchedEffect(true) { delay(3000) // 3s å»¶è¿Ÿ name.value = &quot;Kotlin&quot; // ä¿®æ”¹ name.value } } }} è¿è¡Œä¸‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/141782121dd4b200a5d4e86a30eb3edf.gif =400x) ç°åœ¨å…³äº mutableStateOf çš„ç”¨æ³•ä½ å·²ç»æŒæ¡äº†ï¼Œä½†åŒæ—¶å°±ä¼šäº§ç”Ÿäº†ä¸€ä¸ªç–‘é—®ï¼Œname è¢«è‡ªåŠ¨è®¢é˜…äº†ï¼Œå®ƒçš„å€¼æ”¹å˜äº†å°±ä¼šè®©ç•Œé¢é‡æ–°åˆ·æ–°ï¼Œè¿™èƒŒåçš„â€œçŠ¶æ€è®¢é˜…&amp;åˆ·æ–°æœºåˆ¶â€çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ å¦‚æœä½ æƒ³æ·±å…¥äº†è§£ï¼Œé‚£ä¹ˆæ¥ç€å¾€ä¸‹çœ‹ã€‚ çŠ¶æ€è®¢é˜…&amp;è‡ªåŠ¨åˆ·æ–° åŸºäº androidx.compose.runtime:runtime:1.4.0 ç‰ˆæœ¬ ç¡¬æ ¸éƒ¨åˆ†èµ°èµ·ï¼ŒæŸ¥çœ‹ mutableStateOf() æºç ï¼š 1234fun &lt;T&gt; mutableStateOf( value: T, policy: SnapshotMutationPolicy&lt;T&gt; = structuralEqualityPolicy()): MutableState&lt;T&gt; = createSnapshotMutableState(value, policy) mutableStateOf() è¿”å›çš„æ˜¯ä¸€ä¸ª MutableState å¯¹è±¡ï¼Œè¿™ä¸ªæˆ‘ä»¬å‰é¢è¯´è¿‡ã€‚ mutableStateOf() åˆè°ƒç”¨äº†å¦ä¸€ä¸ªå‡½æ•°ï¼š**createSnapshotMutableState()**ã€‚ è¿›å…¥ **createSnapshotMutableState()**ï¼š 1234internal actual fun &lt;T&gt; createSnapshotMutableState( value: T, policy: SnapshotMutationPolicy&lt;T&gt;): SnapshotMutableState&lt;T&gt; = ParcelableSnapshotMutableState(value, policy) åˆè°ƒç”¨äº† ParcelableSnapshotMutableState() å‡½æ•°ï¼š 1234567internal class ParcelableSnapshotMutableState&lt;T&gt;( value: T, policy: SnapshotMutationPolicy&lt;T&gt;) : SnapshotMutableStateImpl&lt;T&gt;(value, policy), Parcelable { // è¿™é‡Œå†…éƒ¨çš„ä»£ç å…¨éƒ¨éƒ½æ˜¯å¯¹ Parcelable æ¥å£çš„å®ç°ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒï¼Œä¸æ˜¯æ ¸å¿ƒå†…å®¹ ... ...} å…³é”®åœ¨ SnapshotMutableStateImplï¼Œå®ƒé‡Œé¢æ‰æ˜¯æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788internal open class SnapshotMutableStateImpl&lt;T&gt;( value: T, override val policy: SnapshotMutationPolicy&lt;T&gt;) : StateObject, SnapshotMutableState&lt;T&gt; { @Suppress(&quot;UNCHECKED_CAST&quot;) override var value: T get() = next.readable(this).value set(value) = next.withCurrent { if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } } } private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) override val firstStateRecord: StateRecord get() = next override fun prependStateRecord(value: StateRecord) { @Suppress(&quot;UNCHECKED_CAST&quot;) next = value as StateStateRecord&lt;T&gt; } @Suppress(&quot;UNCHECKED_CAST&quot;) override fun mergeRecords( previous: StateRecord, current: StateRecord, applied: StateRecord ): StateRecord? { val previousRecord = previous as StateStateRecord&lt;T&gt; val currentRecord = current as StateStateRecord&lt;T&gt; val appliedRecord = applied as StateStateRecord&lt;T&gt; return if (policy.equivalent(currentRecord.value, appliedRecord.value)) current else { val merged = policy.merge( previousRecord.value, currentRecord.value, appliedRecord.value ) if (merged != null) { appliedRecord.create().also { (it as StateStateRecord&lt;T&gt;).value = merged } } else { null } } } override fun toString(): String = next.withCurrent { &quot;MutableState(value=${it.value})@${hashCode()}&quot; } private class StateStateRecord&lt;T&gt;(myValue: T) : StateRecord() { override fun assign(value: StateRecord) { @Suppress(&quot;UNCHECKED_CAST&quot;) this.value = (value as StateStateRecord&lt;T&gt;).value } override fun create(): StateRecord = StateStateRecord(value) var value: T = myValue } /** * The componentN() operators allow state objects to be used with the property destructuring * syntax * * ``` * var (foo, setFoo) = remember { mutableStateOf(0) } * setFoo(123) // set * foo == 123 // get * ``` */ override operator fun component1(): T = value override operator fun component2(): (T) -&gt; Unit = { value = it } /** * A function used by the debugger to display the value of the current value of the mutable * state object without triggering read observers. */ @Suppress(&quot;unused&quot;) val debuggerDisplayValue: T @JvmName(&quot;getDebuggerDisplayValue&quot;) get() = next.withCurrent { it }.value} å¥½é•¿å•Šï½ç®—äº†ï¼Œä¸çœ‹äº†ğŸ™ˆâ€¦ æ¥ä¸‹æ¥æˆ‘å¸¦ä½ ä¸€æ­¥æ­¥æ¢ç´¢å…¶ä¸­çš„å¥¥ç§˜ï¼ å…ˆçœ‹å¼€å¤´éƒ¨åˆ†ï¼š 12345678910111213141516171819internal open class SnapshotMutableStateImpl&lt;T&gt;( value: T, override val policy: SnapshotMutationPolicy&lt;T&gt;) : StateObject, SnapshotMutableState&lt;T&gt; { @Suppress(&quot;UNCHECKED_CAST&quot;) override var value: T get() = next.readable(this).value set(value) = next.withCurrent { if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } } } private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) override val firstStateRecord: StateRecord get() = next ... ...} ä¸€ä¸ª value å±æ€§å°å…¥çœ¼å¸˜ï¼Œè¿™å°±æ˜¯æ–‡ç« å¼€å¤´ä»£ç é‡Œé¢ç”¨åˆ°çš„ name.valueã€‚ value æœ‰ get() å’Œ set() å‡½æ•°ï¼Œå¹¶ä¸”éƒ½æœ‰å…·ä½“çš„å®ç°ã€‚ ğŸ““ next æ˜¯ä¸ªå•¥ï¼Ÿ æ— è®ºæ˜¯ get() è¿˜æ˜¯ set() éƒ½æœ‰ä¸€ä¸ª nextã€‚ 12get() = next.readable(this).valueset(value) = next.withCurrent {...} å®ƒæ˜¯ä¸ªå•¥ï¼Ÿæˆ‘ä»¬å¾—å…ˆææ˜ç™½è¿™ä¸ªã€‚ 1private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) å®ƒçš„ç±»å‹æ˜¯ StateStateRecordï¼Œé‚£ StateStateRecord æœ‰æ˜¯ä¸ªå•¥ï¼Ÿ 12345678910private class StateStateRecord&lt;T&gt;(myValue: T) : StateRecord() { override fun assign(value: StateRecord) { @Suppress(&quot;UNCHECKED_CAST&quot;) this.value = (value as StateStateRecord&lt;T&gt;).value } override fun create(): StateRecord = StateStateRecord(value) var value: T = myValue} StateStateRecord ç»§æ‰¿äº† StateRecordï¼Œé‚£ StateRecord åˆæ˜¯ä¸ªå•¥å‘¢ï¼Ÿ 123456abstract class StateRecord { internal var snapshotId: Int = currentSnapshot().id // è®°å½•å¿«ç…§ id internal var next: StateRecord? = null // ä¸‹ä¸€ä¸ªçŠ¶æ€è®°å½•çš„å¼•ç”¨ï¼ŒçŠ¶æ€è®°å½•å­˜å‚¨åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ abstract fun assign(value: StateRecord) // å¤åˆ¶ StateRecord abstract fun create(): StateRecord // åˆ›å»ºä¸€ä¸ªæ–°çš„è®°å½•ç›¸åŒçš„ StateRecord} ä½ åªè¦çŸ¥é“ StateRecord æ˜¯ä¸€ä¸ªé“¾è¡¨çš„æ•°æ®ç»“æ„å³å¯ï¼Œè€Œ StateStateRecord å®ç°äº†å®ƒï¼Œå¹¶ä¸”å°† value è¿›è¡Œäº†å°è£…ã€‚ ä¸‹é¢æˆ‘ä»¬è¦è®²åˆ«çš„äº†ï¼Œå…ˆè®°ä½ï¼šStateRecord æ˜¯ä¸€ä¸ªé“¾è¡¨çš„æ•°æ®ç»“æ„ï¼ æ¥ç€è¯´ï¼Œå¦‚æœä½ ä»”ç»†çœ‹ä»£ç çš„è¯ï¼Œä¼šå‘ç° SnapshotMutableStateImpl å…¶å®ç»§æ‰¿äº†ä¸¤ä¸ªæ¥å£ï¼š 123456internal open class SnapshotMutableStateImpl&lt;T&gt;( value: T, override val policy: SnapshotMutationPolicy&lt;T&gt;) : StateObject, SnapshotMutableState&lt;T&gt; { ... ...} ä¸€ä¸ª StateObjetã€ä¸€ä¸ª SnapshotMutableStateã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ SnapshotMutableStateï¼š 123456interface SnapshotMutableState&lt;T&gt; : MutableState&lt;T&gt; { /** * A policy to control how changes are handled in a mutable snapshot. */ val policy: SnapshotMutationPolicy&lt;T&gt;} SnapshotMutableState ç»§æ‰¿äº† MutableStateï¼Œæ­£å¥½å¯¹åº”ç€æˆ‘ä»¬æ–‡ç« å¼€å¤´è¯´çš„ï¼ŒmutableStateOf() è¿”å›çš„å°±æ˜¯ä¸€ä¸ª MutableStateï¼Œæˆ‘ä»¬è¯´æ˜¯å› ä¸ºå®ƒå®ç°äº†è®¢é˜…ä»è€Œå¯ä»¥åˆ·æ–°ï¼Œä½†ï¼ï¼ï¼çœŸæ­£çš„åŸå› å¹¶ä¸æ˜¯å› ä¸ºå®ƒï¼ çœŸæ­£å®ç°çŠ¶æ€è®¢é˜…æœºåˆ¶çš„æ˜¯å¦å¤–ä¸€ä¸ªæ¥å£ï¼šStateObjetï¼ æˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸‹ StateObject è¿™ä¸ªå¤§ä½¬å¹²äº†ä»€ä¹ˆäº‹ï¼š 1234567891011121314interface StateObject { /** * The first state record in a linked list of state records. */ val firstStateRecord: StateRecord fun prependStateRecord(value: StateRecord) fun mergeRecords( previous: StateRecord, current: StateRecord, applied: StateRecord ): StateRecord? = null} ä»£ç éå¸¸ç®€å•ï¼Œä½†é‡Œé¢æœ‰ä¸€ä¸ªæ ¸å¿ƒï¼š 1val firstStateRecord: StateRecord å®ƒæ˜¯å¹²å˜›ç”¨çš„ï¼Ÿæˆ‘ä»¬å»ç…ç…å“ªé‡Œç”¨äº†å®ƒï¼š 1234private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) override val firstStateRecord: StateRecord get() = next å“¦ï¼ŒåŸæ¥ firstStateRecord æ˜¯ç”¨æ¥è®°å½• StateRecord è¿™ä¸ªé“¾è¡¨çš„ å¤´èŠ‚ç‚¹ ç”¨çš„ã€‚ ğŸ““ get() ä¸Šé¢åº”è¯¥ç®—æ˜¯æŠŠ next æ˜¯ä»€ä¹ˆè®²æ¸…æ¥šäº†å§ï¼Ÿâ€“ å®ƒå°±æ˜¯ StateRecordï¼Œæ›´å‡†ç¡®çš„è¯´å°±æ˜¯ StateRecord é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚ ä¸‹é¢æˆ‘ä»¬å¼€å§‹æ‰’æ‰’ get() å…·ä½“çš„é€»è¾‘äº†ã€‚ 1get() = next.readable(this).value è¿›å…¥ readable() ï¼š 1234567891011fun &lt;T : StateRecord&gt; T.readable(state: StateObject): T { val snapshot = Snapshot.current // ç¬¬ä¸€ä»¶äº‹ snapshot.readObserver?.invoke(state) // ç¬¬äºŒä»¶äº‹ return readable(this, snapshot.id, snapshot.invalid) ?: sync { val syncSnapshot = Snapshot.current @Suppress(&quot;UNCHECKED_CAST&quot;) readable(state.firstStateRecord as T, syncSnapshot.id, syncSnapshot.invalid) ?: readError() }} å¹²äº†ä¸¤ä»¶äº‹ï¼Œç¬¬ä¸€ä»¶äº‹ï¼š 1snapshot.readObserver?.invoke(state) // ç¬¬ä¸€ä»¶äº‹ readObserver æ˜¯ä¸€ä¸ªè¯»æ“ä½œçš„è§‚å¯Ÿè€…ï¼Œè¿™ä¸ªæ“ä½œæ˜¯è®°å½• StateObject ä¸­çš„å€¼è¢«å“ªé‡Œè°ƒç”¨äº†ï¼Œæ¯”å¦‚å¼€å¤´çš„ä»£ç ç¤ºä¾‹ï¼š 1234567891011121314151617181920class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) val name = mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { // è¿™é‡Œè°ƒç”¨äº† name.valueï¼Œå°±ä¼šæ‰§è¡Œåˆ°ï¼š // get() --&gt; readServer() --&gt; è®°å½•è¿™é‡Œè°ƒç”¨äº† value å€¼ Text(name.value) } LaunchedEffect(true) { delay(3000) name.value = &quot;Kotlin&quot; } } }} æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªæ“ä½œç†è§£ä¸ºå®ƒæ˜¯ä¸€ä¸ªè®¢é˜…æ“ä½œï¼šè®¢é˜…çŠ¶æ€ï¼Œè®°å½• name.value åœ¨å“ªé‡Œè°ƒç”¨äº†ã€‚ ç¬¬äºŒä»¶äº‹ï¼š 12345return readable(this, snapshot.id, snapshot.invalid) ?: sync { val syncSnapshot = Snapshot.current @Suppress(&quot;UNCHECKED_CAST&quot;) readable(state.firstStateRecord as T, syncSnapshot.id, syncSnapshot.invalid) ?: readError()} è°ƒç”¨äº†ä¸‰å‚æ•°çš„ readable()ï¼š 1234567891011121314151617private fun &lt;T : StateRecord&gt; readable(r: T, id: Int, invalid: SnapshotIdSet): T? { // The readable record is the valid record with the highest snapshotId var current: StateRecord? = r var candidate: StateRecord? = null while (current != null) { if (valid(current, id, invalid)) { candidate = if (candidate == null) current else if (candidate.snapshotId &lt; current.snapshotId) current else candidate } current = current.next } if (candidate != null) { @Suppress(&quot;UNCHECKED_CAST&quot;) return candidate as T } return null} å‰è¾¹æˆ‘ä»¬è¯´é”™ï¼šStateRecord æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œä¸‰å‚æ•°é‡Œé¢çš„å·¥ä½œå°±æ˜¯é€šè¿‡è¡¨å¤´å¯¹è±¡éå†åˆ—è¡¨æ¥è·å– æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecordã€‚ æœ€ç»ˆè¿”å›ä¸€ä¸ª æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecordã€‚ï¼ˆä»€ä¹ˆæ˜¯æœ€æ–°çš„ã€æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªå¯ä»¥ä¸ç”¨å…³å¿ƒï¼Œè¿™è·Ÿè¦ç»“åˆ Snapshot å¿«ç…§ç³»ç»Ÿè¯´ï¼Œä½ ç›´æ¥è¿‡æ»¤å³å¯ï¼Œä¸å½±å“æˆ‘ä»¬åŸç†çš„ç†è§£ï¼‰ æ‰€ä»¥ï¼Œæ•´ä¸ª readable() æ–¹æ³•å°±å¹²äº†ä¸¤ä»¶äº‹ï¼š è¿”å›æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecord è®°å½•åœ¨å“ªé‡Œè°ƒç”¨äº† value 1get() = next.readable(this).value æœ€åè¿˜å‰©ä¸€ä¸ª valueï¼Œè¿™å°±å¾ˆç®€å•äº†ï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡ StateStateRecord (StateRecord çš„å®ç°ç±») ä¼šå¯¹ value è¿›è¡Œå°è£…ï¼Œè€Œ StateRecord å®ƒä»¬åªæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæˆ‘ä»¬è¦è·å–åˆ°å€¼ï¼Œå°±è¦å†è°ƒç”¨ value è·å–å†…éƒ¨è¢«åŒ…ç€çš„å€¼ã€‚ åˆ°è¿™é‡Œ get() å°±è®²å®Œäº†ï¼ ğŸ““ set() ç°åœ¨æ¥çœ‹ set() çš„å…·ä½“ä»£ç ï¼šï¼ˆç»†èŠ‚ç‚¹æ³¨æ„ï¼šè¿™è¾¹æˆ‘æŠŠä»£ç æˆªå›¾äº†ï¼Œè€Œä¸æ˜¯çº¯ä»£ç æ®µï¼Œä½ ç•™æ„ä¸€ä¸‹ï¼Œä¸‹é¢ä¼šå›å½’åˆ°è¿™é‡Œï¼‰ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/548aff88360d4dffda83386ed2ee80e3.png =500x) next æ˜¯å•¥ä¸ç”¨è¯´äº†å§ï¼Œé‚£ withCurrent æ˜¯ä»€ä¹ˆï¼Ÿ 12inline fun &lt;T : StateRecord, R&gt; T.withCurrent(block: (r: T) -&gt; R): R = block(current(this, Snapshot.current)) å®ƒåªæœ‰ä¸€ä¸ªå‚æ•° blockï¼Œè€Œ block æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å‚æ•°ï¼Œå®ƒçš„å·¥ä½œå¾ˆç›´æ¥ï¼Œç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ç±»å‹çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ withCurrent åé¢è·Ÿç€çš„ Lambda è¡¨è¾¾å¼ã€‚ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/63c3c244bd0959768487d28c00ed08ca.png =500x) block é‡Œé¢ä¼ å…¥äº†ä¸€ä¸ª current å‡½æ•°ï¼Œå®ƒåšäº†ä»€ä¹ˆï¼š 12internal fun &lt;T : StateRecord&gt; current(r: T, snapshot: Snapshot) = readable(r, snapshot.id, snapshot.invalid) ?: readError() å‘ç°äº†ä»€ä¹ˆï¼Ÿå®ƒè°ƒç”¨äº†ä¸€ä¸ªä¸‰å‚æ•°çš„ readable()ï¼Œä½ è¿˜è®°å¾—ä¸‰å‚æ•°çš„ readable() æ˜¯åšä»€ä¹ˆçš„å—ï¼Ÿ â‡’ è·å– æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecordã€‚ è¿™ä¸ªæ—¶å€™ä½ åœ¨çœ‹ä¸‹æˆ‘å¼€å¤´ä¸ºå•¥å¯¹ä»£ç åšäº†æˆªå›¾ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/df81d16a784a74cbb297037fdce6eda0.png =500x) æ‡‚å•¥æ„æ€æ²¡ï¼ŸwithCurrent ä¼ å…¥çš„ current å‡½æ•°çš„è¿”å›å€¼å°±å¯¹åº”ç€ä»£ç æç¤ºå™¨æç¤ºçš„ it å¯¹è±¡ï¼ˆä¸€ä¸ª StateStateRecordï¼‰ã€‚ æ¥ç€çœ‹ä»£ç ï¼š 123456set(value) = next.withCurrent { // åˆ¤æ–­æ–°æ—§å€¼ if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } }} if åˆ¤æ–­é‡Œé¢ä¼šåˆ¤æ–­å–åˆ°çš„ StateRecord çš„å€¼å’Œæ–°è®¾ç½®çš„å€¼æ˜¯å¦ç›¸åŒï¼Œæ²¡å˜ç›´æ¥ç»“æŸï¼Œå˜äº†å°±è¿›å…¥ä¸‹ä¸€æ­¥ overwritable()ã€‚ æˆ‘ä»¬çœ‹çœ‹å®ƒåšäº†ä»€ä¹ˆï¼š 123456789101112131415internal inline fun &lt;T : StateRecord, R&gt; T.overwritable( state: StateObject, candidate: T, block: T.() -&gt; R): R { var snapshot: Snapshot = snapshotInitializer return sync { // ç¬¬ä¸€ä»¶äº‹ snapshot = Snapshot.current // ç¬¬äºŒä»¶äº‹ this.overwritableRecord(state, snapshot, candidate).block() }.also { notifyWrite(snapshot, state) }} ä¹Ÿå¹²äº†ä¸¤ä»¶äº‹ï¼š è·å–å¿«ç…§ï¼›2. è°ƒç”¨äº†overwritableRecord() å‡½æ•°ï¼› Snapshot å¿«ç…§çš„çŸ¥è¯†æˆ‘ä»¬å¯ä»¥å…ˆå¿½ç•¥ï¼Œæ¥çœ‹ overwritableRecord() åšäº†ä»€ä¹ˆï¼š 12345678910111213141516171819internal fun &lt;T : StateRecord&gt; T.overwritableRecord( state: StateObject, snapshot: Snapshot, candidate: T): T { if (snapshot.readOnly) { snapshot.recordModified(state) } val id = snapshot.id if (candidate.snapshotId == id) return candidate val newData = newOverwritableRecord(state) newData.snapshotId = id snapshot.recordModified(state) return newData} è¿™æ®µä»£ç åˆæ¶‰åŠåˆ°äº†å¦å¤–ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šSnapshotï¼ˆå¿«ç…§ï¼‰ã€‚ æˆ‘ä»¬å°†ä»£ç åˆ†ä¸ºä¸¤ç«¯æ¥çœ‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/9b9068d1ad9357f3b556a0a502884f0c.png =700x) æ ¸å¿ƒä»£ç å— 1ï¼šå¦‚æœä¼ è¿›æ¥çš„ StateRecord çš„å¿«ç…§ id æ­£å¥½å¯¹åº”å½“å‰ snapshot çš„ idï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ã€‚ æ ¸å¿ƒä»£ç å— 2ï¼šå¦åˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æˆ–è€…è¿”å›ä¸€ä¸ªå¼ƒç”¨çš„ StateRecordï¼Œç„¶åå°†å¿«ç…§ id èµ‹äºˆæ–°çš„ StateRecordã€‚ è¯´ç™½äº†æœ€ç»ˆå°±æ˜¯è¦å–åˆ°ä¸€ä¸ªå¯¹åº”å½“å‰ snapshot çš„ StateRecordï¼ ğŸ¤” æ­¤æ—¶å°±å­˜åœ¨ä¸€ä¸ªå¾ˆå¤§çš„ç–‘é—®äº†ï¼Ÿä»€ä¹ˆæ˜¯ Snapshotï¼ˆå¿«ç…§ï¼‰ï¼ŸSnapshot æ€ä¹ˆå’Œ StateRecord ç»‘åœ¨ä¸€èµ·äº†ï¼Ÿ å…³äº Compose çš„ Snapshot æœºåˆ¶ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç«  æ­ç§˜ Jetpack Composeå¿«ç…§ç³»ç»Ÿ ï¼Œè®²çš„å¾ˆå¥½ã€‚ ä½†ç”±äº Snapshot çœŸçš„ä¸æ˜¯ä¸€ä¸¤å¥å°±èƒ½è¯´æ¸…æ¥šçš„ï¼Œä½†æˆ‘ä»ç„¶å‘Šè¯‰ä½ å®ƒä¸å½±å“ä½ å¯¹è¿™ç¯‡æ–‡ç« åŸç†çš„ç†è§£ã€‚ ç»§ç»­å›åˆ°ä»£ç ï¼š 1234567891011121314internal inline fun &lt;T : StateRecord, R&gt; T.overwritable( state: StateObject, candidate: T, block: T.() -&gt; R): R { var snapshot: Snapshot = snapshotInitializer return sync { snapshot = Snapshot.current // å–åˆ°ä¸€ä¸ªå¯¹åº”å½“å‰ snapshot çš„ StateRecord this.overwritableRecord(state, snapshot, candidate).block() }.also { notifyWrite(snapshot, state) }} å–åˆ°å¯¹åº”å½“å‰ snapshot çš„ StateRecord åï¼Œç´§æ¥ç€è°ƒç”¨äº† block()ï¼Œå®ƒæ˜¯ä¼ è¿›æ¥çš„å‚æ•°ï¼Œæ˜¯å¤–é¢ä¼ è¿›æ¥çš„ï¼Œä¹Ÿå°±æ˜¯ {this.value = value}ã€‚ 123456set(value) = next.withCurrent { // åˆ¤æ–­æ–°æ—§å€¼ if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } }} åˆæ‹å›æ¥äº†ï¼ŒæŠŠä¼ å…¥çš„æ–°å€¼èµ‹å€¼ç»™æ‹¿åˆ°çš„ StateRecord å†…éƒ¨çš„ valueï¼Œè¿™ä¸å°±æ˜¯å†™æ–°å€¼çš„æ“ä½œä¹ˆï¼Ÿ åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯ set() æµç¨‹æ˜¯ä¸æ˜¯æˆ‘ä»¬å°±è®²å®Œäº†ï¼Ÿ Noï½ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ overwritable() æ–¹æ³•å†…éƒ¨ï¼š 1234567891011121314internal inline fun &lt;T : StateRecord, R&gt; T.overwritable( state: StateObject, candidate: T, block: T.() -&gt; R): R { var snapshot: Snapshot = snapshotInitializer return sync { snapshot = Snapshot.current // è¿™é‡Œè®²å®Œäº† this.overwritableRecord(state, snapshot, candidate).block() }.also { notifyWrite(snapshot, state) // ä½†è¿™é‡Œè¿˜æœ‰ä¸ª notifyWrite }} è¿˜æœ‰ä¸€è¡Œæˆ‘ä»¬é—æ¼äº†ï¼ŒnotifyWrite() åˆåšäº†ä»€ä¹ˆï¼Ÿ 123internal fun notifyWrite(snapshot: Snapshot, state: StateObject) { snapshot.writeObserver?.invoke(state)} æœ‰ç§ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿè§‰ï¼Œåœ¨å‰é¢åˆ†æ get() å‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿‡å•å‚æ•°çš„ readable() é‡Œé¢æœ‰ä¸€è¡Œï¼š 1snapshot.readObserver?.invoke(state) é‚£è¿™é‡Œçš„ä½œç”¨å‘¢ï¼Ÿ â‡’ å¯»æ‰¾å˜é‡åœ¨å“ªé‡Œè¢«è¯»äº†ï¼Œç„¶åå°†è¿™éƒ¨åˆ†å†…å®¹çš„ç»„åˆæ ‡è®°ä¸ºå¤±æ•ˆï¼Œç­‰åˆ°ä¸‹ä¸€å¸§çš„æ—¶å€™ä¼šé‡ç»„åˆ·æ–°ã€‚ æ‰€ä»¥ï¼Œæ•´ä¸ª set() æ–¹æ³•å°±å¹²äº†ä¸¤ä»¶äº‹ï¼š å°†ä¼ å…¥çš„å€¼èµ‹å€¼ç»™ StateRecord å†…éƒ¨çš„ value å†™å…¥é€šçŸ¥åˆ·æ–° åˆ°è¿™é‡Œæˆ‘ä»¬å°±åŸºæœ¬ä¸Šèƒ½å¤Ÿå¾ˆæ¸…æ™°çš„æ˜ç™½äº†çŠ¶æ€è®¢é˜…&amp;è‡ªåŠ¨åˆ·æ–°æœºåˆ¶çš„åŸç†äº†ï¼š å½“ get() è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¸ä»…è¿”å›å€¼ï¼Œè¿˜ä¼šè®°å½•è¯»å€¼çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯å“ªé‡Œè°ƒç”¨äº†ï¼ˆç›¸å½“äºè®¢é˜…ï¼‰ã€‚ å½“ set() è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¸ä»…ä¿®æ”¹å€¼ï¼Œè¿˜ä¼šæŸ¥æ‰¾è¯»å€¼çš„åœ°æ–¹ï¼Œç„¶åè¿›è¡Œåˆ·æ–°æ“ä½œï¼ˆç›¸å½“äºé€šçŸ¥ï¼‰ã€‚ ğŸ““ by åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¦‚æœæ¯æ¬¡è·å–å€¼éƒ½è¦åŠ ä¸Š value ä¼šæ˜¾å¾—å¾ˆå†—ä½™ï¼Œæ‰€ä»¥ Compose ç»™æˆ‘ä»¬æä¾›äº†ä¸€ç§æ›´æ–¹ä¾¿çš„å†™æ³•ï¼šbyã€‚å®ƒæ˜¯ Kotlin çš„ä¸€ä¸ªå…³é”®å­—ï¼Œè¡¨ç¤ºå·¦è¾¹çš„å˜é‡ç”¨å³è¾¹çš„å¯¹è±¡ä½œä¸ºä»£ç†ï¼ˆå§”æ‰˜ï¼‰ã€‚ 12345678910111213class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) val name by mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { Text(name) // å¯ä»¥ç›´æ¥ nameï¼Œè€Œä¸éœ€è¦ name.value } } }} å¦‚æœä½ è¿™ä¹ˆå†™ï¼ŒIDLE ä¼šæç¤ºæŠ¥é”™ï¼Œå› ä¸º name å§”æ‰˜ç»™äº† mutableStateOfï¼Œå¦‚æœæˆ‘ä»¬è¦è·å– name çš„å€¼ï¼Œé‚£å§”æ‰˜å¯¹è±¡éœ€è¦è°ƒç”¨ getValue() å’Œ setValue() ä¸¤ä¸ªå‡½æ•°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°éœ€è¦è‡ªå·±å®ç°ã€‚ ä½†å®é™…ä¸Šå¹¶ä¸éœ€è¦æˆ‘ä»¬å®ç°ï¼Œä½ é€šè¿‡æç¤ºä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¼å…¥ï¼Œå› ä¸º Compose å†…éƒ¨å·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº†è¿™ä¸ªæ–¹æ³•ã€‚ 12import androidx.compose.runtime.getValueimport androidx.compose.runtime.setValue è‡ªæ­¤ï¼Œå…³äº Compose çš„çŠ¶æ€è®¢é˜…&amp;è‡ªåŠ¨åˆ·æ–°æœºåˆ¶çš„åŸç†ç®—æ˜¯è®²æ˜ç™½äº†å§â€¦","link":"/2024/07/05/compose/Compose%20--%20%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85%20&%20%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%20--%2001.%20%E8%A7%A3%E6%9E%90%20mutableStateOf%20%E6%BA%90%E7%A0%81/"},{"title":"Jetpackã€Œä¿å§†æ•™ç¨‹ã€-- ROOM","text":"","link":"/2025/05/20/jetpack/Jetpack%20%E4%BF%9D%E5%A7%86%E6%95%99%E7%A8%8B%20--%20ROOM/"},{"title":"è¿™æ˜¯ä¸€ç¯‡é€šä¿—æ˜“æ‡‚çš„ã€Œåç¨‹ã€å…¥é—¨æŒ‡å—","text":"","link":"/2025/06/20/kotlin/Kotlin%20--%20%E5%8D%8F%E7%A8%8B%20--%2001.%20%E5%8D%8F%E7%A8%8B%E5%85%A5%E9%97%A8/"},{"title":"Settingsã€Œæºç è§£æç³»åˆ—ã€-- å•&#x2F;åŒæ åŸç†","text":"åŸºäº Google Git: android-14.0.0_r75 ç‰ˆæœ¬ Source Codes: git clone https://android.googlesource.com/platform/packages/apps/Settings Android 12L ä¹‹åç³»ç»Ÿå¯¹å¤§å±è®¾å¤‡æ˜¾ç¤ºè¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ¯”å¦‚ Settings ä»åŸæ¥çš„ å•åˆ— å˜æˆ åŒåˆ— æ˜¾ç¤ºï¼Œä¾é çš„æ˜¯ã€ŒActivity åµŒå…¥ã€åŸç†ã€‚ åœ¨ Settings ä¸­å†³å®šæ˜¯å¦åµŒå…¥å¼æ˜¾ç¤ºåœ¨ SettingsHomepageActivity çš„ onCreate æ–¹æ³•ä¸­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125public class SettingsHomepageActivity extends FragmentActivity implements CategoryMixin.CategoryHandler { @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); // Ensure device is provisioned in order to access Settings home // TODO(b/331254029): This should later be replaced in favor of an allowlist // ç”¨äºç¡®ä¿è®¾å¤‡å·²ç»å®Œæˆé¦–æ¬¡å¯åŠ¨åˆå§‹åŒ–æµç¨‹ï¼Œåç»­å¯èƒ½ä¼šä»¥ allowlist ç™½åå•æ–¹å¼æ›¿ä»£ // æ£€æŸ¥ç³»ç»Ÿæ•°æ®åº“ä¸­çš„ DEVICE_PROVISIONED å­—æ®µæ˜¯å¦ä¸º 0 // â€¢ 0 è¡¨ç¤ºè®¾å¤‡å°šæœªåˆå§‹åŒ–å®Œæˆï¼ˆé¦–æ¬¡å¯åŠ¨æµç¨‹æœªå®Œæˆï¼‰ // â€¢ è¿™é€šå¸¸ç”¨äºé˜²æ­¢ç”¨æˆ·ç»•è¿‡ SetupWizard æå‰è¿›å…¥è®¾ç½®é¡µ boolean unprovisioned = android.provider.Settings.Global.getInt(getContentResolver(), android.provider.Settings.Global.DEVICE_PROVISIONED, 0) == 0; if (unprovisioned) { Log.e(TAG, &quot;Device is not provisioned, exiting Settings&quot;); // å¦‚æœè®¾å¤‡æœªåˆå§‹åŒ–ï¼Œæ‰“å°æ—¥å¿—å¹¶ç«‹å³å…³é—­å½“å‰ Activityï¼Œé˜²æ­¢è¿›å…¥è®¾ç½®ä¸»ç•Œé¢ finish(); } // åˆ¤æ–­æ˜¯å¦å¯ç”¨åŒæ åµŒå¥—æ˜¾ç¤ºèƒ½åŠ›ï¼ŒèƒŒåé€»è¾‘æ˜¯çœ‹ç³»ç»Ÿæ˜¯å¦æ”¯æŒ WindowEmbedding ç»„ä»¶ mIsEmbeddingActivityEnabled = ActivityEmbeddingUtils.isEmbeddingActivityEnabled(this); // å¦‚æœæ”¯æŒåµŒå¥—å¸ƒå±€ï¼Œå°±è¿›ä¸€æ­¥åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ï¼šç®¡ç†å‹é…ç½®æ–‡ä»¶ï¼ˆManaged Profileï¼‰ï¼Œå³ä¼ä¸š/å…¬å¸ Profile if (mIsEmbeddingActivityEnabled) { final UserManager um = getSystemService(UserManager.class); final UserInfo userInfo = um.getUserInfo(getUserId()); // å¦‚æœæ˜¯ ManagedProfile ç”¨æˆ· if (userInfo.isManagedProfile()) { final Intent intent = new Intent(getIntent()) .addFlags(Intent.FLAG_ACTIVITY_FORWARD_RESULT) .putExtra(EXTRA_USER_HANDLE, getUser()) .putExtra(EXTRA_INITIAL_REFERRER, getCurrentReferrer()); if (TextUtils.equals(intent.getAction(), ACTION_SETTINGS_EMBED_DEEP_LINK_ACTIVITY) &amp;&amp; this instanceof DeepLinkHomepageActivity) { intent.setClass(this, DeepLinkHomepageActivityInternal.class); } intent.removeFlags(Intent.FLAG_ACTIVITY_NEW_TASK); startActivityAsUser(intent, um.getProfileParent(userInfo.id).getUserHandle()); finish(); return; } } // å¯ç”¨æ²‰æµ¸å¼çŠ¶æ€æ /å¯¼èˆªæ å¸ƒå±€ setupEdgeToEdge(); // è®¾ç½® UI å¸ƒå±€ï¼Œè¿™æ˜¯åŒæ ä¸»ç•Œé¢çš„æ ¹å¸ƒå±€ï¼Œå…¶ä¸­åŒ…å«å·¦æ ã€å³æ å®¹å™¨ç­‰ setContentView(R.layout.settings_homepage_container); // åˆ¤æ–­å½“å‰æ˜¯å¦å·²ç»å¤„äºåµŒå¥—ï¼ˆåŒæ ï¼‰æ¨¡å¼ mIsTwoPane = ActivityEmbeddingUtils.isAlreadyEmbedded(this); // æ›´æ–°é¡¶éƒ¨ AppBar çš„æœ€å°é«˜åº¦ï¼Œä¿è¯æ²‰æµ¸æ¨¡å¼ä¸‹æ˜¾ç¤ºåˆç† updateAppBarMinHeight(); initHomepageContainer(); // åˆå§‹åŒ–é¡µé¢å®¹å™¨ updateHomepageAppBar(); // å§‹åŒ–AppBar æ ·å¼ updateHomepageBackground(); // å§‹åŒ–èƒŒæ™¯è‰² mLoadedListeners = new ArraySet&lt;&gt;(); // åˆå§‹åŒ–ç›‘å¬å™¨é›†åˆï¼Œåç»­å¯èƒ½åœ¨å­ fragment ä¸­ç”¨äºé€šçŸ¥åŠ è½½å®Œæˆ initSearchBarView(); // åˆå§‹åŒ–æœç´¢æ¡† // æ³¨å†Œç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€… HideNonSystemOverlayMixinï¼Œç”¨äºé˜²æ­¢æµ®çª—ï¼ˆå¦‚æ¶æ„æ‚¬æµ®çª—ï¼‰å¹²æ‰° // Android 13+ ä¸­å¸¸ç”¨äºå®‰å…¨é˜²æŠ¤ getLifecycle().addObserver(new HideNonSystemOverlayMixin(this)); // åˆå§‹åŒ–å¹¶æ³¨å†Œåˆ†ç±»å¤„ç†å™¨ CategoryMixinï¼Œç”¨äºæ”¯æŒä¸»ç•Œé¢åˆ†ç±»å’Œæœç´¢ç´¢å¼• mCategoryMixin = new CategoryMixin(this); getLifecycle().addObserver(mCategoryMixin); // è·å–å½“å‰éœ€è¦é«˜äº®çš„èœå• keyï¼ˆæ¯”å¦‚é€šè¿‡ intent å‚æ•°ä¼ å…¥ï¼Œæˆ–ä¸Šä¸€æ¬¡æ“ä½œè®°å¿†ï¼‰ final String highlightMenuKey = getHighlightMenuKey(); // Only allow features on high ram devices. // åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯ä½å†…å­˜è®¾å¤‡ï¼ˆlow-RAMï¼‰ if (!getSystemService(ActivityManager.class).isLowRamDevice()) { // åˆå§‹åŒ–ç”¨æˆ·å¤´åƒ initAvatarView(); // åˆ¤æ–­æ˜¯å¦éœ€è¦æ»šåŠ¨åˆ°é«˜äº®èœå•é¡¹ï¼ˆä»…åœ¨åŒæ  + éé»˜è®¤ key çš„æƒ…å†µä¸‹å¯ç”¨ï¼‰ final boolean scrollNeeded = mIsEmbeddingActivityEnabled &amp;&amp; !TextUtils.equals(getString(DEFAULT_HIGHLIGHT_MENU_KEY), highlightMenuKey); // æ˜¾ç¤º SuggestionFragmentï¼ˆGoogle æç¤ºé¡µæ¨¡å—ï¼‰ showSuggestionFragment(scrollNeeded); // å¦‚æœå¯ç”¨äº† CONTEXTUAL_HOME ç‰¹æ€§ï¼Œåˆ™å±•ç¤ºä¸Šä¸‹æ–‡æ¨èå¡ç‰‡ï¼ˆæ¯”å¦‚å¤œé—´æ¨¡å¼æ¨èã€éŸ³é‡è°ƒèŠ‚ç­‰ï¼‰ // åŒæ—¶å¯ç”¨åŠ¨ç”»æ”¯æŒ if (FeatureFlagUtils.isEnabled(this, FeatureFlags.CONTEXTUAL_HOME)) { showFragment(() -&gt; new ContextualCardsFragment(), R.id.contextual_cards_content); ((FrameLayout) findViewById(R.id.main_content)) .getLayoutTransition().enableTransitionType(LayoutTransition.CHANGING); } } // åˆ›å»ºä¸» Fragmentï¼ˆå·¦æ ï¼‰ï¼Œæ˜¯ TopLevelSettings å®ä¾‹ // å°†é«˜äº®èœå• key ä½œä¸ºå‚æ•°ä¼ å…¥ï¼ŒåŠ è½½åˆ° main_content å®¹å™¨ï¼ˆå³å·¦æ ï¼‰ mMainFragment = showFragment(() -&gt; { final TopLevelSettings fragment = new TopLevelSettings(); fragment.getArguments().putString(SettingsActivity.EXTRA_FRAGMENT_ARG_KEY, highlightMenuKey); return fragment; }, R.id.main_content); // Launch the intent from deep link for large screen devices. // å¦‚æœæ˜¯ DeepLink è·³è½¬ï¼Œå¹¶ä¸”å¤„äºå¤§å±ï¼Œåˆ™æŠŠå³æ ä¹Ÿè‡ªåŠ¨è·³è½¬æ˜¾ç¤ºç›®æ ‡é¡µé¢ if (shouldLaunchDeepLinkIntentToRight()) { launchDeepLinkIntentToRight(); } // Settings app may be launched on an existing task. Reset SplitPairRule of SubSettings here // to prevent SplitPairRule of an existing task applied on a new started Settings app. // å¦‚æœæ”¯æŒåŒæ ï¼Œä¸”é€šè¿‡ FLAG_ACTIVITY_CLEAR_TOP å¯åŠ¨ï¼ˆé‡è¿›é¦–é¡µï¼‰ï¼Œåˆ™é‡æ–°åˆå§‹åŒ–åµŒå¥—è§„åˆ™ // é˜²æ­¢ä¹‹å‰çš„é¡µé¢å¯¹æ–° Task æœ‰å½±å“ if (mIsEmbeddingActivityEnabled &amp;&amp; (getIntent().getFlags() &amp; Intent.FLAG_ACTIVITY_CLEAR_TOP) != 0) { initSplitPairRules(); } updateHomepagePaddings(); // æ›´æ–°ç•Œé¢ paddingï¼Œé€‚é…æ˜¯å¦æ˜¯åŒæ  updateSplitLayout(); // åŒæ—¶åˆ·æ–°å¸ƒå±€ï¼Œå¼ºåˆ¶è®¡ç®—ä¸€æ¬¡åˆ†å±åŒºåŸŸ // å¯ç”¨ Task å±‚çº§çš„å¤šè¯­è¨€æ”¯æŒï¼ˆä» Android 13 èµ·æ”¯æŒï¼‰ // å…è®¸æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹è¯­è¨€ï¼ˆæ¯”å¦‚ä¸€ä¸ªä»»åŠ¡æ˜¯è‹±æ–‡ï¼Œå¦ä¸€ä¸ªæ˜¯ä¸­æ–‡ï¼‰ enableTaskLocaleOverride(); } } æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ¢³ç†ä¸‹ onCreate æ–¹æ³•çš„å…³é”®é€»è¾‘ï¼š æ¨¡å— ä½œç”¨ å‰ç½®æ ¡éªŒ æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²åˆå§‹åŒ–ã€æ˜¯å¦æ˜¯ä¼ä¸š Profile åµŒå¥—åˆ¤æ–­ æ˜¯å¦æ”¯æŒåŒæ åµŒå¥—ã€æ˜¯å¦å·²åµŒå¥— é¡µé¢åˆå§‹åŒ– è®¾ç½®å¸ƒå±€ã€åŠ è½½å·¦æ ã€å³æ å†…å®¹ã€SuggestionFragment deepLink è·³è½¬ æ ¹æ® intent è‡ªåŠ¨æ‹‰èµ·å³æ é¡µé¢ Split è§„åˆ™åˆå§‹åŒ– æ¸…ç©ºæ—§è§„åˆ™ï¼Œæ³¨å†ŒåµŒå¥—åˆ†å±è§„åˆ™ åŒæ é€‚é… paddingã€èƒŒæ™¯ã€AppBarã€è¯­è¨€ç­‰å¤šç»´åº¦é€‚é… ActivityEmbeddingUtilsåˆ†æ çš„æ ¸å¿ƒä»£ç é€»è¾‘ä¸ºï¼š 12// åˆ¤æ–­æ˜¯å¦å¯ç”¨åŒæ åµŒå¥—æ˜¾ç¤ºèƒ½åŠ›ï¼ŒèƒŒåé€»è¾‘æ˜¯çœ‹ç³»ç»Ÿæ˜¯å¦æ”¯æŒ WindowEmbedding ç»„ä»¶mIsEmbeddingActivityEnabled = ActivityEmbeddingUtils.isEmbeddingActivityEnabled(this); è¿½è¸ªä¸‹ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public class ActivityEmbeddingUtils { /** * Checks whether to support embedding activity feature with following conditions: * &lt;ul&gt; * &lt;li&gt;Whether {@link #isSettingsSplitEnabled(Context)}&lt;/li&gt; * &lt;li&gt;Whether {@link FeatureFlagUtils#SETTINGS_SUPPORT_LARGE_SCREEN} is enabled&lt;/li&gt; * &lt;li&gt;Whether User setup is completed&lt;/li&gt; * &lt;/ul&gt; * * æ³¨é‡Šè§£é‡Šå¾—å¾ˆæ¸…æ¥šäº†ï¼šåŒæ åŠŸèƒ½ç”Ÿæ•ˆçš„å‰ææ¡ä»¶æœ‰ 3 ä¸ªï¼š * 1. isSettingsSplitEnabled(context) ä¸º trueï¼Œè¡¨ç¤ºç³»ç»Ÿæ”¯æŒåµŒå¥—ç»„ä»¶ * 2. FeatureFlagUtils ä¸­è®¾ç½®çš„å¼€å…³ï¼ˆSETTINGS_SUPPORT_LARGE_SCREENï¼‰æ˜¯æ‰“å¼€çš„ * 3. ç”¨æˆ·å·²ç»å®Œæˆé¦–æ¬¡è®¾å¤‡åˆå§‹åŒ– */ public static boolean isEmbeddingActivityEnabled(Context context) { // Activity Embedding feature is not enabled if Settings doesn't enable large screen // optimization or the device is not supported. // åˆ¤æ–­æ˜¯å¦å¯ç”¨äº†åˆ†å±æ”¯æŒï¼Œå¦‚æœç³»ç»Ÿå‹æ ¹ä¸æ”¯æŒå¤§å±é€‚é…ï¼Œè¿™é‡Œç›´æ¥è¿”å› false if (!isSettingsSplitEnabled(context)) { Log.d(TAG, &quot;isSettingsSplitSupported = false&quot;); return false; } // Activity Embedding feature is not enabled if a user chooses to disable the feature. // åˆ¤æ–­ FeatureFlagUtils ä¸­æ§åˆ¶å¤§å±é€‚é…çš„å¼€å…³æ˜¯å¦æ‰“å¼€ // è¿™æ˜¯ Google ä¸ºäº†åŠ¨æ€æ§åˆ¶æ–°ç‰¹æ€§è€Œè®¾è®¡çš„ flag ç³»ç»Ÿ if (!FeatureFlagUtils.isEnabled(context, FeatureFlagUtils.SETTINGS_SUPPORT_LARGE_SCREEN)) { Log.d(TAG, &quot;isFlagEnabled = false&quot;); return false; } // Don't enable Activity embedding for setup wizard. // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»å®Œæˆ Setup Wizard // å¦‚æœæ˜¯é¦–æ¬¡å¯åŠ¨ã€å°šæœªå®Œæˆåˆå§‹å¼•å¯¼æµç¨‹ï¼Œä¸å…è®¸è¿›å…¥åµŒå¥—æ˜¾ç¤ºï¼ˆé¿å…å¹²æ‰°å¼•å¯¼ç•Œé¢ï¼‰ if (!WizardManagerHelper.isUserSetupComplete(context)) { Log.d(TAG, &quot;isUserSetupComplete = false&quot;); return false; } // æ»¡è¶³ä»¥ä¸Š 3 ä¸ªæ¡ä»¶åï¼Œæ‰çœŸæ­£å¯ç”¨åµŒå¥— Activity åŠŸèƒ½ Log.d(TAG, &quot;isEmbeddingActivityEnabled = true&quot;); return true; }} æ€»ç»“ï¼šåŒæ åŠŸèƒ½æ˜¯å¦å¯ç”¨ï¼Œå—ä»¥ä¸‹ 3 ä¸ªæ¡ä»¶å…±åŒæ§åˆ¶ï¼š æ¡ä»¶ æ–¹æ³•/å¼€å…³ è¯´æ˜ ç³»ç»Ÿæ˜¯å¦æ”¯æŒåµŒå¥— isSettingsSplitEnabled() åº•å±‚æ”¯æŒï¼ˆå¦‚ SplitController å¯ç”¨ï¼‰ é¡¹ç›®æ˜¯å¦å¼€å¯æ”¯æŒ FeatureFlagUtils.SETTINGS_SUPPORT_LARGE_SCREEN é¡¹ç›®çº§ç‰¹æ€§å¼€å…³ ç”¨æˆ·æ˜¯å¦å®Œæˆå¼•å¯¼ WizardManagerHelper.isUserSetupComplete() é˜²æ­¢è¿›å…¥æœªåˆå§‹åŒ–è®¾å¤‡çš„åŒæ ç•Œé¢ isSettingsSplitEnabled()123456789101112131415public class ActivityEmbeddingUtils { /** * Returns {@code true} to indicate that Settings app support the Activity Embedding feature on * this device. Returns {@code false}, otherwise. * * è¿™ä¸ªæ–¹æ³•æ˜¯åˆ¤æ–­å½“å‰è®¾å¤‡æ˜¯å¦æ”¯æŒ Settings çš„åµŒå¥—ï¼ˆActivity Embeddingï¼‰åŠŸèƒ½ */ public static boolean isSettingsSplitEnabled(Context context) { return SHOULD_ENABLE_LARGE_SCREEN_OPTIMIZATION &amp;&amp; SplitController.getInstance(context).getSplitSupportStatus() == SplitController.SplitSupportStatus.SPLIT_AVAILABLE; }} SHOULD_ENABLE_LARGE_SCREEN_OPTIMIZATION æ˜¯ä¸€ä¸ªé™æ€å¸ƒå°”å¸¸é‡ï¼Œåœ¨ ActivityEmbeddingUtils ç±»ä¸­è¢«å®šä¹‰ï¼š 12private static final boolean SHOULD_ENABLE_LARGE_SCREEN_OPTIMIZATION = SystemProperties.getBoolean(&quot;persist.settings.large_screen_opt.enabled&quot;, false);","link":"/2025/06/26/settings/Settings%20--%20%E5%8F%8C%E6%A0%8F%E8%A7%A3%E6%9E%90/"}],"tags":[{"name":"çŠ¶æ€è®¢é˜… &amp; è‡ªåŠ¨æ›´æ–°","slug":"çŠ¶æ€è®¢é˜…-è‡ªåŠ¨æ›´æ–°","link":"/tags/%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/"},{"name":"åç¨‹","slug":"åç¨‹","link":"/tags/%E5%8D%8F%E7%A8%8B/"},{"name":"æºç è§£æ","slug":"æºç è§£æ","link":"/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"}],"categories":[{"name":"Compose","slug":"Compose","link":"/categories/Compose/"},{"name":"Kotlin","slug":"Kotlin","link":"/categories/Kotlin/"},{"name":"çŠ¶æ€è®¢é˜… &amp; è‡ªåŠ¨æ›´æ–°","slug":"Compose/çŠ¶æ€è®¢é˜…-è‡ªåŠ¨æ›´æ–°","link":"/categories/Compose/%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/"},{"name":"åç¨‹","slug":"Kotlin/åç¨‹","link":"/categories/Kotlin/%E5%8D%8F%E7%A8%8B/"},{"name":"Android","slug":"Android","link":"/categories/Android/"},{"name":"Settings","slug":"Android/Settings","link":"/categories/Android/Settings/"}],"pages":[]}