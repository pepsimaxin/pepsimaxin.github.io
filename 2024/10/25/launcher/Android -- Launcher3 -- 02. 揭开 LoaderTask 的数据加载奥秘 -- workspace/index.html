<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- Workspace - wikiHow</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="wikiHow"><meta name="msapplication-TileImage" content="/img/wiki.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="wikiHow"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="è¿™æ˜¯ä¸€ç¯‡å…³äº..."><meta property="og:type" content="blog"><meta property="og:title" content="æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- Workspace"><meta property="og:url" content="http://example.com/2024/10/25/launcher/Android%20--%20Launcher3%20--%2002.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%20--%20workspace/"><meta property="og:site_name" content="wikiHow"><meta property="og:description" content="è¿™æ˜¯ä¸€ç¯‡å…³äº..."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/gallery/covers/android/launcher_1.jpg"><meta property="article:published_time" content="2024-10-24T16:00:00.000Z"><meta property="article:modified_time" content="2025-07-20T08:04:23.525Z"><meta property="article:author" content="Marco"><meta property="article:tag" content="Launcher3"><meta property="article:tag" content="Android 14.0"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/gallery/covers/android/launcher_1.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2024/10/25/launcher/Android%20--%20Launcher3%20--%2002.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%20--%20workspace/"},"headline":"æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- Workspace","image":["http://example.com/gallery/covers/android/launcher_1.jpg"],"datePublished":"2024-10-24T16:00:00.000Z","dateModified":"2025-07-20T08:04:23.525Z","author":{"@type":"Person","name":"Marco"},"publisher":{"@type":"Organization","name":"wikiHow","logo":{"@type":"ImageObject","url":"http://example.com/img/wikihow.svg"}},"description":"è¿™æ˜¯ä¸€ç¯‡å…³äº..."}</script><link rel="canonical" href="http://example.com/2024/10/25/launcher/Android%20--%20Launcher3%20--%2002.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%20--%20workspace/"><link rel="icon" href="/img/wiki.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/wikihow.svg" alt="wikiHow" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/pepsimaxin"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="ç›®å½•" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="æœç´¢" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/gallery/covers/android/launcher_1.jpg" alt="æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- Workspace"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-10-24T16:00:00.000Z" title="2024/10/25 00:00:00">2024-10-25</time>å‘è¡¨</span><span class="level-item"><time dateTime="2025-07-20T08:04:23.525Z" title="2025/7/20 16:04:23">2025-07-20</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/Launcher3/">Launcher3</a><span>Â /Â </span><a class="link-muted" href="/categories/Launcher3/Android-14-0/">Android 14.0</a></span></div></div><h1 class="title is-3 is-size-4-mobile">æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- Workspace</h1><div class="content"><hr>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æˆ‘ä»¬å…ˆå¤§æ¦‚äº†è§£æœ¬ç¯‡æ–‡ç« æ¶‰åŠåˆ°çš„å‡ ä¸ªé‡è¦çš„ç±»ï¼š</p>
<table>
<thead>
<tr>
<th align="left">æ ¸å¿ƒç±»</th>
<th align="left">è·¯å¾„</th>
</tr>
</thead>
<tbody><tr>
<td align="left">LauncherModel</td>
<td align="left">Launcher æ•°æ®å¤„ç†æ ¸å¿ƒç±»</td>
</tr>
<tr>
<td align="left">LoaderTask</td>
<td align="left">ä¸»è¦ä»»åŠ¡è´Ÿè´£åŠ è½½æ•°æ®ï¼ˆworkspaceã€all appsï¼‰å’Œç»‘å®šæ•°æ®ï¼ˆworkspaceã€all appsï¼‰</td>
</tr>
<tr>
<td align="left">AutoInstallsLayout</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">InvariantDeviceProfile</td>
<td align="left">æ¡Œé¢çš„ä¸€äº›é…ç½®ï¼Œæ¯”å¦‚é»˜è®¤å¸ƒå±€æ–‡ä»¶</td>
</tr>
<tr>
<td align="left">BgDataModel</td>
<td align="left">ç”¨æ¥æ”¾å¸ƒå±€ç›¸å…³çš„é›†åˆ</td>
</tr>
<tr>
<td align="left">WorkspaceItemInfo<br>FolderInfo<br>LauncherAppWidgetInfo</td>
<td align="left">éƒ½æ˜¯ç»§æ‰¿è‡ª ItemInfoï¼Œä¿å­˜æ¡Œé¢å›¾æ ‡çš„ä¸€äº›ä¿¡æ¯ï¼šå›¾æ ‡ä½ç½®ï¼Œå®½é«˜ï¼Œç±»å‹ç­‰ä¿¡æ¯</td>
</tr>
</tbody></table>
<hr>
<article class="message is-info"><div class="message-header">
<p>Step1: Workspace</p>
</div><div class="message-body">
<p>Workspace çš„å·¥ä½œä¸»è¦åˆ†ä¸ºï¼š<font color="#085DFF">ã€ŒåŠ è½½ã€</font>å’Œ<font color="#FF8C00">ã€Œç»‘å®šã€</font>ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥åˆ†æã€‚</p>
</div></article>

<h1 id="åŠ è½½-Workspace-æµç¨‹è§£æ"><a href="#åŠ è½½-Workspace-æµç¨‹è§£æ" class="headerlink" title="åŠ è½½ Workspace æµç¨‹è§£æ"></a>åŠ è½½ Workspace æµç¨‹è§£æ</h1><p>æ ¸å¿ƒæ–¹æ³•ï¼š<font color="#085DFF">loadWorkspace()</font> è´Ÿè´£åŠ è½½ Workspaceï¼Œå®ƒä¸»è¦åš 2 ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>è·å–æ•°æ®åº“</li>
<li>ä»æ•°æ®åº“è¯»å–ä¿¡æ¯å­˜æ”¾åˆ° sBgDataModel ä¸­</li>
</ul>
<p>ä½ å…ˆæœ‰ä¸ªæ¦‚å¿µï¼Œç„¶åæˆ‘ä»¬å¼€å§‹åˆ†ææºç ï¼Œä»£ç èµ°èµ·ï½</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * run() -&gt; loadWorkspace(allShortcuts, &quot;&quot;, memoryLogger);</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *     1. allDeepShortcuts: å­˜å‚¨åº”ç”¨å¿«æ·æ–¹å¼çš„åˆ—è¡¨ï¼Œé»˜è®¤æ˜¯ç©ºçš„</span></span><br><span class="line"><span class="comment">     *     2. selection: å¯ä»¥æŒ‡å®šé€‰æ‹©æ¡ä»¶ï¼Œç”¨äºè¿‡æ»¤ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ä¼ å…¥ä»»ä½•æ¡ä»¶çš„</span></span><br><span class="line"><span class="comment">     *     3. memoryLogger: æ˜¯ä¸€ä¸ª LoaderMemoryLoggerï¼Œæ˜¯ä¸€ä¸ªè¾…åŠ©è®°å½•å™¨ï¼Œç”¨äºæ•è·è®°å½•</span></span><br><span class="line"><span class="comment">     *        LoaderTask çš„ run() æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿçš„å¼‚å¸¸åŠå†…å­˜ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">loadWorkspace</span><span class="params">(</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts,</span></span><br><span class="line"><span class="params">            String selection,</span></span><br><span class="line"><span class="params">            LoaderMemoryLogger memoryLogger)</span> &#123;</span><br><span class="line">        <span class="comment">// å¼€å§‹æ€§èƒ½è¿½è¸ªï¼Œç”¨äºæ€§èƒ½è°ƒè¯•å’Œç›‘æ§</span></span><br><span class="line">        Trace.beginSection(<span class="string">&quot;LoadWorkspace&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/***********************************</span></span><br><span class="line"><span class="comment">             * æ ¸å¿ƒæ–¹æ³•ï¼šè´Ÿè´£åŠ è½½å·¥ä½œåŒºå†…å®¹çš„ä¸»è¦é€»è¾‘</span></span><br><span class="line"><span class="comment">             ***********************************/</span></span><br><span class="line">            loadWorkspaceImpl(allDeepShortcuts, selection, memoryLogger);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// ç»“æŸæ€§èƒ½è·Ÿè¸ª</span></span><br><span class="line">            Trace.endSection();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®°å½•å·¥ä½œåŒºåŠ è½½è¿‡ç¨‹çš„æ—¥å¿—ï¼Œç”¨äºæ€§èƒ½åˆ†ææˆ–è°ƒè¯•</span></span><br><span class="line">        logASplit(<span class="string">&quot;loadWorkspace&quot;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) &#123;</span><br><span class="line">            <span class="comment">// ç¡®ä¿ Loader åŠ è½½è¿‡ç¨‹æ²¡æœ‰è¢«ä¸­æ­¢</span></span><br><span class="line">            verifyNotStopped();</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ ModelDelegate åŠ è½½å¹¶ç»‘å®šå·¥ä½œåŒºé¡¹ï¼ˆWorkspace Itemsï¼‰</span></span><br><span class="line">            mModelDelegate.loadAndBindWorkspaceItems(mUserManagerState,</span><br><span class="line">                    mLauncherBinder.mCallbacksList, mShortcutKeyToPinnedShortcuts);</span><br><span class="line">            <span class="comment">// æ ‡è®° ModelDelegate ä¸ºæ´»åŠ¨çŠ¶æ€ï¼Œè¡¨ç¤ºå®ƒå·²æˆåŠŸåŠ è½½å¹¶ç»‘å®šå·¥ä½œåŒºé¡¹ã€‚</span></span><br><span class="line">            mModelDelegate.markActive();</span><br><span class="line">            logASplit(<span class="string">&quot;workspaceDelegateItems&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç»§ç»­è·Ÿè¸ª <font color="#085DFF">loadWorkspaceImpl()</font> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> LauncherAppState mApp;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * run() -&gt; loadWorkspace(allShortcuts, &quot;&quot;, memoryLogger);</span></span><br><span class="line"><span class="comment">     *       -&gt; loadWorkspaceImpl(allDeepShortcuts, selection, memoryLogger);</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *     1. allDeepShortcuts: å­˜å‚¨åº”ç”¨å¿«æ·æ–¹å¼çš„åˆ—è¡¨ï¼Œé»˜è®¤æ˜¯ç©ºçš„</span></span><br><span class="line"><span class="comment">     *     2. selection: å¯ä»¥æŒ‡å®šé€‰æ‹©æ¡ä»¶ï¼Œç”¨äºè¿‡æ»¤ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ä¼ å…¥ä»»ä½•æ¡ä»¶çš„</span></span><br><span class="line"><span class="comment">     *     3. memoryLogger: æ˜¯ä¸€ä¸ª LoaderMemoryLoggerï¼Œæ˜¯ä¸€ä¸ªè¾…åŠ©è®°å½•å™¨ï¼Œç”¨äºæ•è·è®°å½•</span></span><br><span class="line"><span class="comment">     *        LoaderTask çš„ run() æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿçš„å¼‚å¸¸åŠå†…å­˜ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadWorkspaceImpl</span><span class="params">(</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts,</span></span><br><span class="line"><span class="params">            String selection,</span></span><br><span class="line"><span class="params">            <span class="meta">@Nullable</span> LoaderMemoryLogger memoryLogger)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mApp å°±æ˜¯ï¼šLauncherAppStateï¼Œå®ƒä¼šæŒæœ‰åº”ç”¨çš„ Context å¯¹è±¡ï¼Œä½¿å¾—åº”ç”¨çš„å„ä¸ªéƒ¨åˆ†</span></span><br><span class="line">        <span class="comment">// èƒ½å¤Ÿè®¿é—®å…¨å±€çš„ Contextï¼Œä»è€Œè¿›è¡Œèµ„æºè®¿é—®ã€å¯åŠ¨æœåŠ¡ã€å¹¿æ’­ç­‰æ“ä½œ</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> mApp.getContext();</span><br><span class="line">        <span class="comment">// åç»­ç”¨äºæŸ¥è¯¢ã€æ’å…¥ã€åˆ é™¤æˆ–æ›´æ–°æ•°æ®</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ContentResolver</span> <span class="variable">contentResolver</span> <span class="operator">=</span> context.getContentResolver();</span><br><span class="line">        <span class="comment">// è‡ªå®šä¹‰çš„åŒ…ç®¡ç†çš„è¾…åŠ©ç±»</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">PackageManagerHelper</span> <span class="variable">pmHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageManagerHelper</span>(context);</span><br><span class="line">        <span class="comment">// æ£€æŸ¥è®¾å¤‡æ˜¯å¦å¤„äºå®‰å…¨æ¨¡å¼</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isSafeMode</span> <span class="operator">=</span> pmHelper.isSafeMode();</span><br><span class="line">        <span class="comment">// æ£€æŸ¥è®¾å¤‡çš„å¯åŠ¨æ˜¯å¦å·²å®Œæˆï¼Œé€šå¸¸è¿™æ„å‘³ç€ SD å¡å·²ç»æŒ‚è½½å¹¶å¯ä»¥è®¿é—®</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isSdCardReady</span> <span class="operator">=</span> Utilities.isBootCompleted();</span><br><span class="line">        <span class="comment">// ç”¨äºç®¡ç†æ¡Œé¢å°éƒ¨ä»¶çš„å¸®åŠ©ç±»</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">WidgetManagerHelper</span> <span class="variable">widgetHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WidgetManagerHelper</span>(context);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// è®¾å®šäº†ä¸€ä¸ªæ¸…é™¤æ•°æ®åº“çš„æ ‡å¿—ä½</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">clearDb</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** æ£€æŸ¥æ˜¯å¦éœ€è¦è¿›è¡Œæ•°æ®åº“è¿ç§»ã€‚å¦‚æœè¿ç§»å¤±è´¥ï¼Œåˆ™æ¸…ç†æ•´ä¸ªæ•°æ®åº“ï¼Œè¿™é€šå¸¸å‘ç”Ÿåœ¨æ•°æ®æ¨¡å‹å‘ç”Ÿè¾ƒå¤§å˜æ›´æ—¶</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  mApp.getModel()                        -&gt; LauncherModel</span></span><br><span class="line"><span class="comment">         *  mApp.getModel().getModelDbController() -&gt; ModelDbController</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * ä¸€èˆ¬æ˜¯æ— éœ€è¿ç§»çš„ï¼Œè¿™è¾¹é»˜è®¤ä¸º trueï¼Œæ‰€ä»¥ä¸ä¼šèµ°æ­¤åˆ†æ”¯ï¼ŒclearDb ä»ä¸º false</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!mApp.getModel().getModelDbController().migrateGridIfNeeded()) &#123;</span><br><span class="line">            <span class="comment">// Migration failed. Clear workspace.</span></span><br><span class="line">            <span class="comment">// è¿ç§»å¤±è´¥</span></span><br><span class="line">            clearDb = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é‡ç½®æ•°æ®åº“</span></span><br><span class="line">        <span class="keyword">if</span> (clearDb) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;loadWorkspace: resetting launcher database&quot;</span>);</span><br><span class="line">            Settings.call(contentResolver, Settings.METHOD_CREATE_EMPTY_DB);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        Log.d(TAG, <span class="string">&quot;loadWorkspace: loading default favorites&quot;</span>);</span><br><span class="line">        <span class="comment">/*********************************************************************</span></span><br><span class="line"><span class="comment">         *  æ ¸å¿ƒå…³æ³¨ç‚¹ 1ï¼šåŠ è½½é»˜è®¤æ¡Œé¢å¸ƒå±€</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  ä¼šè°ƒç”¨åˆ° LauncherProvider çš„ loadDefaultFavoritesIfNecessary() æ–¹æ³•ï¼Œ</span></span><br><span class="line"><span class="comment">         *  è¿™ä¸ªæ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åŠ è½½é»˜è®¤çš„å¸ƒå±€ï¼Œå¦‚æœæ¸…é™¤äº†æ¡Œé¢æ•°æ®</span></span><br><span class="line"><span class="comment">         *  æˆ–è€…æ‰‹æœºæ¢å¤äº†å‡ºå‚è®¾ç½®ï¼Œå°±ä¼šåŠ è½½é»˜è®¤çš„å¸ƒå±€</span></span><br><span class="line"><span class="comment">         ********************************************************************/</span></span><br><span class="line">        Settings.call(contentResolver, Settings.METHOD_LOAD_DEFAULT_FAVORITES);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// åŠ è½½æ•°æ®åº“ï¼ˆæˆ‘ä»¬æ”¾åœ¨åé¢åˆ†æï¼‰</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åŠ è½½é»˜è®¤æ¡Œé¢å¸ƒå±€"><a href="#åŠ è½½é»˜è®¤æ¡Œé¢å¸ƒå±€" class="headerlink" title="åŠ è½½é»˜è®¤æ¡Œé¢å¸ƒå±€"></a>åŠ è½½é»˜è®¤æ¡Œé¢å¸ƒå±€</h2><p><code>Settings.call()</code> æ˜¯ <code>LauncherSettings</code> å†…éƒ¨çš„é™æ€æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/LauncherSettings.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LauncherSettings</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Launcher settings</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Settings</span> &#123;</span><br><span class="line">        <span class="comment">// CONTENT_URI æ˜¯ä¸€ä¸ª Uri å¯¹è±¡ï¼Œè¡¨ç¤ºå†…å®¹æä¾›è€…çš„ URI åœ°å€ï¼Œè¿™æ˜¯ä¸ LauncherProvider äº¤äº’çš„å…¥å£ç‚¹</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Uri</span> <span class="variable">CONTENT_URI</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;content://&quot;</span> +</span><br><span class="line">                LauncherProvider.AUTHORITY + <span class="string">&quot;/settings&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">METHOD_LOAD_DEFAULT_FAVORITES</span> <span class="operator">=</span> <span class="string">&quot;load_default_favorites&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Bundle <span class="title function_">call</span><span class="params">(ContentResolver cr, String method)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> call(cr, method, <span class="literal">null</span> <span class="comment">/* arg */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Bundle <span class="title function_">call</span><span class="params">(ContentResolver cr, String method, String arg)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> cr.call(CONTENT_URI, method, arg, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç´§æ¥ç€è¿›å…¥ <code>LauncherProvider.call()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/LauncherProvider.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LauncherProvider</span> <span class="keyword">extends</span> <span class="title class_">ContentProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * method: &quot;load_default_favorites&quot;</span></span><br><span class="line"><span class="comment">     * arg.  : null</span></span><br><span class="line"><span class="comment">     * extras: null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Bundle <span class="title function_">call</span><span class="params">(String method, <span class="keyword">final</span> String arg, <span class="keyword">final</span> Bundle extras)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Settings.METHOD_LOAD_DEFAULT_FAVORITES: &#123;</span><br><span class="line">                getModelDbController().loadDefaultFavoritesIfNecessary();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­è·Ÿè¸ª <code>loadDefaultFavoritesIfNecessary()</code> ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/ModelDbController.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModelDbController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Loads the default workspace based on the following priority scheme:</span></span><br><span class="line"><span class="comment">     *   1) From the app restrictions</span></span><br><span class="line"><span class="comment">     *   2) From a package provided by play store</span></span><br><span class="line"><span class="comment">     *   3) From a partner configuration APK, already in the system image</span></span><br><span class="line"><span class="comment">     *   4) The default configuration for the particular device</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   1) æ¥è‡ªåº”ç”¨é™åˆ¶</span></span><br><span class="line"><span class="comment">     *   2) æ¥è‡ª Play å•†åº—æä¾›çš„è½¯ä»¶åŒ…</span></span><br><span class="line"><span class="comment">     *   3) æ¥è‡ªå·²é›†æˆåœ¨ image ä¸­çš„åˆä½œä¼™ä¼´é…ç½®çš„ APK</span></span><br><span class="line"><span class="comment">     *   4) ç‰¹å®šè®¾å¤‡çš„é»˜è®¤é…ç½®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@WorkerThread</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">loadDefaultFavoritesIfNecessary</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ç¡®ä¿æ•°æ®åº“å·²åˆ›å»ºã€‚å¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“æ–‡ä»¶</span></span><br><span class="line">        createDbIfNotExists();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†ç©ºæ•°æ®åº“ï¼Œå¦‚æœæ¸…é™¤äº† Launcher æ•°æ®ï¼Œåˆ™ä¼šä¸º true</span></span><br><span class="line">        <span class="keyword">if</span> (LauncherPrefs.get(mContext).get(getEmptyDbCreatedKey(mOpenHelper.getDatabaseName()))) &#123;</span><br><span class="line">            <span class="comment">// LauncherWidgetHolder æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†å°éƒ¨ä»¶çš„å®¹å™¨ï¼Œåœ¨åŠ è½½å¸ƒå±€æ—¶ç”¨æ¥ä¿å­˜å’Œå¤„ç†å°éƒ¨ä»¶ä¿¡æ¯</span></span><br><span class="line">            <span class="type">LauncherWidgetHolder</span> <span class="variable">widgetHolder</span> <span class="operator">=</span> mOpenHelper.newLauncherWidgetHolder();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1. å°è¯•ä»ç³»ç»Ÿé…ç½®çš„ launcher3.layout.provider æä¾›çš„ provider é‡Œé¢è·å–å¸ƒå±€èµ„æº</span></span><br><span class="line">                <span class="type">AutoInstallsLayout</span> <span class="variable">loader</span> <span class="operator">=</span> createWorkspaceLoaderFromAppRestriction(widgetHolder);</span><br><span class="line">                <span class="keyword">if</span> (loader == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 2. å°è¯•ä»å¸¦æœ‰</span></span><br><span class="line"><span class="comment">                     *    android.autoinstalls.config.action.PLAY_AUTO_INSTALL çš„ apk é‡Œé¢</span></span><br><span class="line"><span class="comment">                     *    è·å–å¸ƒå±€èµ„æº</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    loader = AutoInstallsLayout.get(mContext, widgetHolder, mOpenHelper);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (loader == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 3. å°è¯•ä»ç³»ç»Ÿå†…ç½®çš„ Partner åº”ç”¨é‡Œè·å– workspace é»˜è®¤é…ç½®</span></span><br><span class="line"><span class="comment">                     *    è¿™ä¸ªåŠŸèƒ½æ˜¯æä¾›ç»™æä¾›å¸ƒå±€çš„ç¬¬ä¸‰æ–¹åº”ç”¨</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">Partner</span> <span class="variable">partner</span> <span class="operator">=</span> Partner.get(mContext.getPackageManager());</span><br><span class="line">                    <span class="keyword">if</span> (partner != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">workspaceResId</span> <span class="operator">=</span> partner.getXmlResId(RES_PARTNER_DEFAULT_LAYOUT);</span><br><span class="line">                        <span class="keyword">if</span> (workspaceResId != <span class="number">0</span>) &#123;</span><br><span class="line">                            loader = <span class="keyword">new</span> <span class="title class_">DefaultLayoutParser</span>(mContext, widgetHolder,</span><br><span class="line">                                    mOpenHelper, partner.getResources(), workspaceResId);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// ç¡®å®šæ˜¯å¦ä½¿ç”¨äº†å¤–éƒ¨æä¾›çš„å¸ƒå±€</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">usingExternallyProvidedLayout</span> <span class="operator">=</span> loader != <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (loader == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 4. å°è¯•è·å– Launcher é‡Œçš„é»˜è®¤èµ„æºï¼Œæ¯”å¦‚ @xml/default_workspace_5x5</span></span><br><span class="line">                    loader = getDefaultLayoutParser(widgetHolder);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// There might be some partially restored DB items, due to buggy restore logic in</span></span><br><span class="line">                <span class="comment">// previous versions of launcher.</span></span><br><span class="line">                <span class="comment">// æ¸…ç©ºæ•°æ®åº“</span></span><br><span class="line">                mOpenHelper.createEmptyDB(mOpenHelper.getWritableDatabase());</span><br><span class="line">                <span class="comment">// Populate favorites table with initial favorites</span></span><br><span class="line">                <span class="comment">// è§£æå¸ƒå±€æ–‡ä»¶å¹¶å†™å…¥æ•°æ®åº“</span></span><br><span class="line">                <span class="comment">// é¦–å…ˆä½¿ç”¨ä¸Šé¢å¾—åˆ°çš„ loader è·å–ï¼Œå¦‚æœè¯¥ loader æä¾›çš„æ–¹å¼é‡Œé¢ä¸ºç©ºçš„å¸ƒå±€ï¼Œ</span></span><br><span class="line">                <span class="comment">// é‚£ä¹ˆè¿˜æ˜¯ä½¿ç”¨ä¸Šé¢ç¬¬ 4 æ­¥çš„ loader</span></span><br><span class="line">                <span class="keyword">if</span> ((mOpenHelper.loadFavorites(mOpenHelper.getWritableDatabase(), loader) &lt;= <span class="number">0</span>)</span><br><span class="line">                        &amp;&amp; usingExternallyProvidedLayout) &#123;</span><br><span class="line">                    <span class="comment">// Unable to load external layout. Cleanup and load the internal layout.</span></span><br><span class="line">                    mOpenHelper.createEmptyDB(mOpenHelper.getWritableDatabase());</span><br><span class="line">                    mOpenHelper.loadFavorites(mOpenHelper.getWritableDatabase(),</span><br><span class="line">                            getDefaultLayoutParser(widgetHolder));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ¸…ç†ç©ºæ•°æ®åº“åˆ›å»ºçš„æ ‡å¿—ï¼Œè¡¨ç¤ºæ•°æ®åº“å·²ç»å‡†å¤‡å¥½äº†ã€‚</span></span><br><span class="line">                clearFlagEmptyDbCreated();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// æ— è®ºæ–¹æ³•æ˜¯å¦æˆåŠŸæ‰§è¡Œï¼Œéƒ½é”€æ¯ widgetHolder å®ä¾‹ï¼Œé‡Šæ”¾ç›¸å…³èµ„æº</span></span><br><span class="line">                widgetHolder.destroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ç¬¬ 4 æ­¥åŠ è½½ Launcher é»˜è®¤çš„å¸ƒå±€èµ„æºç›¸å…³é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/ModelDbController.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModelDbController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultLayoutParser <span class="title function_">getDefaultLayoutParser</span><span class="params">(LauncherWidgetHolder widgetHolder)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è·å– InvariantDeviceProfile å®ä¾‹ï¼Œå®ƒä»£è¡¨äº†è®¾å¤‡çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å¸ƒå±€ç›¸å…³çš„è®¾ç½®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">InvariantDeviceProfile</span> <span class="variable">idp</span> <span class="operator">=</span> LauncherAppState.getIDP(mContext);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è·å–é»˜è®¤å¸ƒå±€èµ„æºidï¼Œæ¯”å¦‚ï¼š<span class="doctag">@xml</span>/default_workspace_5x5</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * demoModeLayoutIdï¼šæ˜¯å¦ä¸ºæ¼”ç¤ºæ¨¡å¼</span></span><br><span class="line"><span class="comment">         *     1. å¦‚æœæ˜¯åˆ™è°ƒç”¨æ¼”ç¤ºæ¨¡å¼çš„å¸ƒå±€ id -&gt; idp.demoModeLayoutId</span></span><br><span class="line"><span class="comment">         *     2. å¦‚ä¸æ˜¯åˆ™è°ƒç”¨å†…éƒ¨é»˜è®¤çš„å¸ƒå±€ id -&gt; idp.defaultLayoutId -&gt; æˆ‘ä»¬åªéœ€è¦å…³å¿ƒè¿™ä¸ª</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">defaultLayout</span> <span class="operator">=</span> idp.demoModeLayoutId != <span class="number">0</span></span><br><span class="line">                &amp;&amp; mContext.getSystemService(UserManager.class).isDemoUser()</span><br><span class="line">                ? idp.demoModeLayoutId : idp.defaultLayoutId;</span><br><span class="line">                </span><br><span class="line">        <span class="comment">// åˆ›å»º DefaultLayoutParser å®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultLayoutParser</span>(mContext, widgetHolder,</span><br><span class="line">                mOpenHelper, mContext.getResources(), defaultLayout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¦æƒ³å¼„æ¸…æ¥š <font color="#FF8C00">idp.defaultLayoutId</font> æ˜¯å“ªä¸ªå¸ƒå±€ï¼Œæˆ‘ä»¬å¾—å…ˆæ¥çœ‹ <font color="#085DFF">LauncherAppState.getIDP()</font> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/LauncherAppState.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LauncherAppState</span> <span class="keyword">implements</span> <span class="title class_">SafeCloseable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> InvariantDeviceProfile <span class="title function_">getIDP</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å– InvariantDeviceProfile å•ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> InvariantDeviceProfile.INSTANCE.get(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­è·Ÿè¸ªæºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvariantDeviceProfile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">InvariantDeviceProfile</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çš„ç½‘æ ¼åç§°</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">gridName</span> <span class="operator">=</span> getCurrentGridName(context);</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ç½‘æ ¼ï¼Œå¯èƒ½ä¼šè¿”å›æ–°çš„ç½‘æ ¼åç§°</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">newGridName</span> <span class="operator">=</span> initGrid(context, gridName);</span><br><span class="line">        <span class="keyword">if</span> (!newGridName.equals(gridName)) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ–°çš„ç½‘æ ¼åç§°ä¸å½“å‰ç½‘æ ¼åç§°ä¸åŒï¼Œåˆ™æ›´æ–° LauncherPrefs ä¸­çš„ç½‘æ ¼åç§°</span></span><br><span class="line">            LauncherPrefs.get(context).put(GRID_NAME, newGridName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å½“ç”¨æˆ·è§£é”æ—¶æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œ</span></span><br><span class="line">        LockedUserState.get(context).runOnUserUnlocked(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸€ä¸ª DeviceGridState å®ä¾‹å¹¶è°ƒç”¨ writeToPrefs(context)ï¼Œ</span></span><br><span class="line">            <span class="comment">// å°†è®¾å¤‡ç½‘æ ¼çŠ¶æ€å†™å…¥åå¥½è®¾ç½®</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DeviceGridState</span>(<span class="built_in">this</span>).writeToPrefs(context);</span><br><span class="line">        &#125;);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸€ä¸ªç›‘å¬å™¨æ¥å¤„ç†è®¾å¤‡æ˜¾ç¤ºé…ç½®çš„æ›´æ”¹</span></span><br><span class="line">        DisplayController.INSTANCE.get(context).setPriorityListener(</span><br><span class="line">                (displayContext, info, flags) -&gt; &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•æ£€æŸ¥æ ‡å¿— flags æ˜¯å¦åŒ…å«é…ç½®æ›´æ”¹çš„</span></span><br><span class="line"><span class="comment">                     * ç›¸å…³æ ‡å¿—ï¼ˆå¦‚å¯†åº¦ã€æ”¯æŒçš„è¾¹ç•Œã€å¯¼èˆªæ¨¡å¼ç­‰ï¼‰</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span> ((flags &amp; (CHANGE_DENSITY | CHANGE_SUPPORTED_BOUNDS</span><br><span class="line">                            | CHANGE_NAVIGATION_MODE)) != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// å¦‚æœæœ‰å˜åŒ–ï¼Œè°ƒç”¨ onConfigChanged() æ–¹æ³•å¤„ç†è¿™äº›å˜åŒ–</span></span><br><span class="line">                        onConfigChanged(displayContext);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…³æ³¨ <font color="#085DFF">initGrid()</font> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvariantDeviceProfile</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">initGrid</span><span class="params">(Context context, String gridName)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰è®¾å¤‡çš„æ˜¾ç¤ºä¿¡æ¯</span></span><br><span class="line">        <span class="type">Info</span> <span class="variable">displayInfo</span> <span class="operator">=</span> DisplayController.INSTANCE.get(context).getInfo();</span><br><span class="line">        <span class="comment">// æ ¹æ®æ˜¾ç¤ºä¿¡æ¯ç¡®å®šè®¾å¤‡ç±»å‹ï¼ˆå¦‚æ‰‹æœºã€å¹³æ¿ç­‰ï¼‰</span></span><br><span class="line">        <span class="meta">@DeviceType</span> <span class="type">int</span> <span class="variable">deviceType</span> <span class="operator">=</span> getDeviceType(displayInfo);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// æ ¹æ®ä¸Šä¸‹æ–‡ã€ç½‘æ ¼åç§°ã€è®¾å¤‡ç±»å‹å’Œæ•°æ®åº“æ¢å¤ä»»åŠ¡çš„çŠ¶æ€ï¼Œè·å–æ‰€æœ‰é¢„å®šä¹‰çš„æ˜¾ç¤ºé€‰é¡¹</span></span><br><span class="line">        ArrayList&lt;DisplayOption&gt; allOptions =</span><br><span class="line">                getPredefinedDeviceProfiles(context, gridName, deviceType,</span><br><span class="line">                        RestoreDbTask.isPending(context));</span><br><span class="line">        <span class="comment">// ä½¿ç”¨åŠ æƒæ’å€¼æ–¹æ³•ä»æ‰€æœ‰é¢„å®šä¹‰çš„æ˜¾ç¤ºé€‰é¡¹ä¸­é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„é€‰é¡¹ï¼Œ</span></span><br><span class="line">        <span class="comment">// æ­¤æ–¹æ³•è€ƒè™‘è®¾å¤‡çš„æ˜¾ç¤ºä¿¡æ¯å’Œè®¾å¤‡ç±»å‹æ¥åšå‡ºé€‰æ‹©ã€‚</span></span><br><span class="line">        <span class="type">DisplayOption</span> <span class="variable">displayOption</span> <span class="operator">=</span></span><br><span class="line">                invDistWeightedInterpolate(displayInfo, allOptions, deviceType);</span><br><span class="line">        <span class="comment">// ä½¿ç”¨é€‰å®šçš„æ˜¾ç¤ºé€‰é¡¹åˆå§‹åŒ–ç½‘æ ¼ï¼Œè¿™ä¸ªæ–¹æ³•å¯èƒ½ä¼šè®¾ç½®è®¾å¤‡çš„æ˜¾ç¤ºç½‘æ ¼ä»¥é€‚åº”æ‰€é€‰çš„æ˜¾ç¤ºé€‰é¡¹</span></span><br><span class="line">        initGrid(context, displayInfo, displayOption, deviceType);</span><br><span class="line">        <span class="comment">// è¿”å›æ‰€é€‰æ˜¾ç¤ºé€‰é¡¹çš„ç½‘æ ¼åç§°</span></span><br><span class="line">        <span class="keyword">return</span> displayOption.grid.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨é‡ç‚¹å°±æ¥åˆ°äº† <font color="#085DFF">getPredefinedDeviceProfiles()</font> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvariantDeviceProfile</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;DisplayOption&gt; <span class="title function_">getPredefinedDeviceProfiles</span><span class="params">(Context context,</span></span><br><span class="line"><span class="params">            String gridName, <span class="meta">@DeviceType</span> <span class="type">int</span> deviceType, <span class="type">boolean</span> allowDisabledGrid)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ DisplayOption åˆ—è¡¨ï¼Œprofiles ç”¨äºå­˜å‚¨ä» XML è§£æå‡ºçš„æ‰€æœ‰æ˜¾ç¤ºé…ç½®æ–‡ä»¶</span></span><br><span class="line">        ArrayList&lt;DisplayOption&gt; profiles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¼€å§‹è§£æ XML       -&gt; è§£æå“ªä¸ª XML ï¼Ÿ</span></span><br><span class="line"><span class="comment">         * ç†Ÿæ‚‰çš„ XML æ–‡ä»¶æ¥äº† -&gt; device_profiles.xml</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * ä½¿ç”¨ XmlResourceParser è§£æ R.xml.device_profiles èµ„æºæ–‡ä»¶ï¼Œ</span></span><br><span class="line"><span class="comment">         * è¯¥æ–‡ä»¶åŒ…å«æ‰€æœ‰é¢„å®šä¹‰çš„è®¾å¤‡é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">XmlResourceParser</span> <span class="variable">parser</span> <span class="operator">=</span> context.getResources().getXml(R.xml.device_profiles)) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰ XML æ ‡ç­¾çš„æ·±åº¦ï¼Œç”¨äºç¡®å®šè§£æç»“æŸçš„æ¡ä»¶</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">depth</span> <span class="operator">=</span> parser.getDepth();</span><br><span class="line">            <span class="type">int</span> type;</span><br><span class="line">            <span class="comment">// å¾ªç¯è§£æ XML æ–‡ä»¶ï¼Œç›´åˆ°é‡åˆ° END_TAGï¼ˆæ ‡ç­¾ç»“æŸï¼‰æˆ–æ–‡æ¡£ç»“æŸ</span></span><br><span class="line">            <span class="keyword">while</span> (((type = parser.next()) != XmlPullParser.END_TAG ||</span><br><span class="line">                    parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * çœ‹ if åˆ¤æ–­é‡Œé¢çš„ GridOption.TAG_NAME -&gt; &quot;grid-option&quot; -&gt; æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ ï¼Ÿ</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * æ’æ’­ä¸€ç‚¹ device_profiles.xml çš„å†…å®¹</span></span><br><span class="line"><span class="comment">                 * &lt;grid-option</span></span><br><span class="line"><span class="comment">                 *     launcher:name=&quot;4_by_6&quot;</span></span><br><span class="line"><span class="comment">                 *     launcher:numRows=&quot;6&quot;</span></span><br><span class="line"><span class="comment">                 *     launcher:defaultLayoutId=&quot;<span class="doctag">@xml</span>/default_workspace_4x6&quot;</span></span><br><span class="line"><span class="comment">                 *     launcher:deviceCategory=&quot;phone|multi_display&quot;</span></span><br><span class="line"><span class="comment">                 *     ... /&gt;</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 *     &lt;display-option</span></span><br><span class="line"><span class="comment">                 *         launcher:name=&quot;Large Phone&quot;</span></span><br><span class="line"><span class="comment">                 *         ... /&gt;</span></span><br><span class="line"><span class="comment">                 * &lt;/grid-option&gt;</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> ((type == XmlPullParser.START_TAG)</span><br><span class="line">                        &amp;&amp; GridOption.TAG_NAME.equals(parser.getName())) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * å½“é‡åˆ° &quot;grid-option&quot; å¯¹åº”æ ‡ç­¾ï¼Œåˆ›å»ºä¸€ä¸ª GridOption å®ä¾‹</span></span><br><span class="line"><span class="comment">                     *</span></span><br><span class="line"><span class="comment">                     * GridOption çš„æºç æˆ‘ä»¬ä¸€ä¼šå°±è¦è·Ÿï¼Œè¿™é‡Œå…ˆæ³¨æ„ä¸€ä¸‹ï¼ï¼ï¼</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="type">GridOption</span> <span class="variable">gridOption</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GridOption</span>(context, Xml.asAttributeSet(parser));</span><br><span class="line">                    <span class="comment">// æ£€æŸ¥ GridOption æ˜¯å¦å¯ç”¨ï¼Œæˆ–æ ¹æ® allowDisabledGrid å‚æ•°å†³å®šæ˜¯å¦å¤„ç†ç¦ç”¨çš„ç½‘æ ¼é€‰é¡¹</span></span><br><span class="line">                    <span class="keyword">if</span> (gridOption.isEnabled(deviceType) || allowDisabledGrid) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">displayDepth</span> <span class="operator">=</span> parser.getDepth();</span><br><span class="line">                        <span class="keyword">while</span> (((type = parser.next()) != XmlPullParser.END_TAG</span><br><span class="line">                                || parser.getDepth() &gt; displayDepth)</span><br><span class="line">                                &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œç»§ç»­è§£æè¿™ä¸ªç½‘æ ¼é€‰é¡¹ä¸‹çš„ display-option æ ‡ç­¾</span></span><br><span class="line">                            <span class="keyword">if</span> ((type == XmlPullParser.START_TAG) &amp;&amp; <span class="string">&quot;display-option&quot;</span>.equals(</span><br><span class="line">                                    parser.getName())) &#123;</span><br><span class="line">                                <span class="comment">// å°†å…¶æ·»åŠ åˆ° profiles åˆ—è¡¨ä¸­</span></span><br><span class="line">                                profiles.add(<span class="keyword">new</span> <span class="title class_">DisplayOption</span>(gridOption, context,</span><br><span class="line">                                        Xml.asAttributeSet(parser)));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | XmlPullParserException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">// åˆ›å»ºä¸€ä¸ªç©ºçš„ filteredProfiles åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨ç¬¦åˆæ¡ä»¶çš„ DisplayOption</span></span><br><span class="line">        ArrayList&lt;DisplayOption&gt; filteredProfiles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¦‚æœæä¾›äº† gridNameï¼Œåˆ™éå† profiles åˆ—è¡¨ï¼Œæ‰¾åˆ°ä¸ gridName åŒ¹é…ä¸”å¯ç”¨çš„é€‰é¡¹ï¼Œ</span></span><br><span class="line"><span class="comment">         * å°†å…¶æ·»åŠ åˆ° filteredProfiles åˆ—è¡¨ä¸­</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * æˆ‘çš„è®¾å¤‡æµ‹è¯• Logï¼š</span></span><br><span class="line"><span class="comment">         * [ @@@ Pepsimarco ] æ—¥å¿—è¾“å‡ºï¼š===&gt; gridName = 5_by_5</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(gridName)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (DisplayOption option : profiles) &#123;</span><br><span class="line">                <span class="keyword">if</span> (gridName.equals(option.grid.name)</span><br><span class="line">                        &amp;&amp; (option.grid.isEnabled(deviceType) || allowDisabledGrid)) &#123;</span><br><span class="line">                    filteredProfiles.add(option);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¦‚æœ filteredProfiles ä¸ºç©ºï¼ˆå³æ²¡æœ‰åŒ¹é…åˆ°åˆé€‚çš„æ˜¾ç¤ºé€‰é¡¹ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (filteredProfiles.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// No grid found, use the default options</span></span><br><span class="line">            <span class="comment">// åˆ™ä» profiles åˆ—è¡¨ä¸­é€‰æ‹©å¯ä»¥ä½œä¸ºé»˜è®¤é€‰é¡¹ (canBeDefault) çš„æ˜¾ç¤ºé€‰é¡¹</span></span><br><span class="line">            <span class="keyword">for</span> (DisplayOption option : profiles) &#123;</span><br><span class="line">                <span class="keyword">if</span> (option.canBeDefault) &#123;</span><br><span class="line">                    filteredProfiles.add(option);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (filteredProfiles.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;No display option with canBeDefault=true&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¿”å› filteredProfilesï¼Œå³ç¬¦åˆæ¡ä»¶çš„æ˜¾ç¤ºé€‰é¡¹åˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">return</span> filteredProfiles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œå¯¹äº <font color="#008B45">device_profiles.xml</font> çš„è§£æï¼Œæˆ‘ä»¬å·²ç»å®Œå…¨æŒæ¡äº†ï¼Œè¿˜è®°å¾—æˆ‘ä»¬å‰é¢è¿˜é—æ¼çš„ <font color="#FF8C00">GridOption</font> å—ï¼Ÿ</p>
<p>æˆ‘ä»¬æ¥è·Ÿæºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvariantDeviceProfile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">GridOption</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * GridOption ä¸»è¦åŠŸèƒ½ï¼š</span></span><br><span class="line"><span class="comment">         *   1. ä»ä¼ å…¥çš„ AttributeSet ä¸­è·å–å¹¶è§£æä¸ç½‘æ ¼å¸ƒå±€ç›¸å…³çš„å±æ€§ï¼›</span></span><br><span class="line"><span class="comment">         *   2. åˆå§‹åŒ– GridOption ç±»çš„æˆå‘˜å˜é‡ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨è¿™äº›é…ç½®å‚æ•°æ¥è®¾ç½®æˆ–è°ƒæ•´åº”ç”¨ç¨‹åºçš„æ˜¾ç¤ºå¸ƒå±€ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">GridOption</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">            <span class="type">TypedArray</span> <span class="variable">a</span> <span class="operator">=</span> context.obtainStyledAttributes(</span><br><span class="line">                    attrs, R.styleable.GridDisplayOption);</span><br><span class="line">            <span class="comment">// ç½‘æ ¼å¸ƒå±€çš„åç§°</span></span><br><span class="line">            name = a.getString(R.styleable.GridDisplayOption_name);</span><br><span class="line">            <span class="comment">// ç½‘æ ¼çš„è¡Œæ•°</span></span><br><span class="line">            numRows = a.getInt(R.styleable.GridDisplayOption_numRows, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// ç½‘æ ¼çš„åˆ—æ•°</span></span><br><span class="line">            numColumns = a.getInt(R.styleable.GridDisplayOption_numColumns, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// æœç´¢å®¹å™¨çš„åˆ—æ•°ï¼Œå¦‚æœæœªæŒ‡å®šï¼Œåˆ™é»˜è®¤ä¸ numColumns ä¸€è‡´</span></span><br><span class="line">            numSearchContainerColumns = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numSearchContainerColumns, numColumns);</span><br><span class="line">            <span class="comment">// æ•°æ®åº“æ–‡ä»¶çš„åç§°</span></span><br><span class="line">            dbFile = a.getString(R.styleable.GridDisplayOption_dbFile);</span><br><span class="line">            <span class="comment">// é»˜è®¤å¸ƒå±€èµ„æº ID</span></span><br><span class="line">            defaultLayoutId = a.getResourceId(</span><br><span class="line">                    R.styleable.GridDisplayOption_defaultLayoutId, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// æ¼”ç¤ºæ¨¡å¼ä¸‹çš„å¸ƒå±€èµ„æº IDï¼Œå¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä½¿ç”¨ defaultLayoutId</span></span><br><span class="line">            demoModeLayoutId = a.getResourceId(</span><br><span class="line">                    R.styleable.GridDisplayOption_demoModeLayoutId, defaultLayoutId);</span><br><span class="line">            <span class="comment">// æŠ½å±‰çš„æ ·å¼èµ„æº ID</span></span><br><span class="line">            allAppsStyle = a.getResourceId(R.styleable.GridDisplayOption_allAppsStyle,</span><br><span class="line">                    R.style.AllAppsStyleDefault);</span><br><span class="line">            <span class="comment">// æŠ½å±‰ä¸­çš„åˆ—æ•°</span></span><br><span class="line">            numAllAppsColumns = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numAllAppsColumns, numColumns);</span><br><span class="line">            <span class="comment">// æ•°æ®åº“ä¸­åº”ç”¨ç¨‹åºæŠ½å±‰çš„æ‰©å±•åˆ—æ•°ï¼Œé»˜è®¤ä¸º numAllAppsColumns çš„ä¸¤å€</span></span><br><span class="line">            numDatabaseAllAppsColumns = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numExtendedAllAppsColumns, <span class="number">2</span> * numAllAppsColumns);</span><br><span class="line">            <span class="comment">// HotSeat å›¾æ ‡æ•°é‡</span></span><br><span class="line">            numHotseatIcons = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numHotseatIcons, numColumns);</span><br><span class="line">            <span class="comment">// æ•°æ®åº“ä¸­ Hotseat çš„æ‰©å±•å›¾æ ‡æ•°é‡ï¼Œé»˜è®¤ä¸º numHotseatIcons çš„ä¸¤å€</span></span><br><span class="line">            numDatabaseHotseatIcons = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numExtendedHotseatIcons, <span class="number">2</span> * numHotseatIcons);</span><br><span class="line">            <span class="comment">// Hotseat åœ¨ä¸åŒå±å¹•æ–¹å‘å’Œæ¨¡å¼ä¸‹çš„åˆ—è·¨åº¦</span></span><br><span class="line">            hotseatColumnSpan[INDEX_DEFAULT] = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_hotseatColumnSpan, numColumns);</span><br><span class="line">            hotseatColumnSpan[INDEX_LANDSCAPE] = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_hotseatColumnSpanLandscape, numColumns);</span><br><span class="line">            hotseatColumnSpan[INDEX_TWO_PANEL_LANDSCAPE] = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_hotseatColumnSpanTwoPanelLandscape,</span><br><span class="line">                    numColumns);</span><br><span class="line">            hotseatColumnSpan[INDEX_TWO_PANEL_PORTRAIT] = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_hotseatColumnSpanTwoPanelPortrait,</span><br><span class="line">                    numColumns);</span><br><span class="line">            <span class="comment">// å¯¼èˆªæŒ‰é’® End é—´è·èµ„æº ID</span></span><br><span class="line">            inlineNavButtonsEndSpacing =</span><br><span class="line">                    a.getResourceId(R.styleable.GridDisplayOption_inlineNavButtonsEndSpacing,</span><br><span class="line">                            R.dimen.taskbar_button_margin_default);</span><br><span class="line">            <span class="comment">// æ–‡ä»¶å¤¹å†…çš„è¡Œæ•°</span></span><br><span class="line">            numFolderRows = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numFolderRows, numRows);</span><br><span class="line">            <span class="comment">// æ–‡ä»¶å¤¹å†…çš„åˆ—æ•°</span></span><br><span class="line">            numFolderColumns = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numFolderColumns, numColumns);</span><br><span class="line">            <span class="comment">// æ–‡ä»¶å¤¹çš„æ ·å¼èµ„æº ID</span></span><br><span class="line">            folderStyle = a.getResourceId(R.styleable.GridDisplayOption_folderStyle,</span><br><span class="line">                    INVALID_RESOURCE_HANDLE);</span><br><span class="line">            <span class="comment">// å•å…ƒæ ¼çš„æ ·å¼èµ„æº ID</span></span><br><span class="line">            cellStyle = a.getResourceId(R.styleable.GridDisplayOption_cellStyle,</span><br><span class="line">                    R.style.CellStyleDefault);</span><br><span class="line">            <span class="comment">// ç½‘æ ¼æ˜¯å¦å¯ä»¥ç¼©æ”¾</span></span><br><span class="line">            isScalable = a.getBoolean(</span><br><span class="line">                    R.styleable.GridDisplayOption_isScalable, <span class="literal">false</span>);</span><br><span class="line">            <span class="comment">// è®¾å¤‡å¡«å……çš„èµ„æº ID</span></span><br><span class="line">            devicePaddingId = a.getResourceId(</span><br><span class="line">                    R.styleable.GridDisplayOption_devicePaddingId, INVALID_RESOURCE_HANDLE);</span><br><span class="line">            <span class="comment">// è®¾å¤‡ç±»åˆ«</span></span><br><span class="line">            deviceCategory = a.getInt(R.styleable.GridDisplayOption_deviceCategory,</span><br><span class="line">                    DEVICE_CATEGORY_ALL);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// å·¥ä½œåŒºè§„æ ¼çš„èµ„æº ID</span></span><br><span class="line">            <span class="keyword">if</span> (FeatureFlags.ENABLE_RESPONSIVE_WORKSPACE.get()) &#123;</span><br><span class="line">                mWorkspaceSpecsId = a.getResourceId(</span><br><span class="line">                        R.styleable.GridDisplayOption_workspaceSpecsId, INVALID_RESOURCE_HANDLE);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mWorkspaceSpecsId = INVALID_RESOURCE_HANDLE;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// æœç´¢æ åœ¨ä¸åŒå±å¹•æ–¹å‘å’Œæ¨¡å¼ä¸‹æ˜¯å¦å†…è”</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">inlineForRotation</span> <span class="operator">=</span> a.getInt(R.styleable.GridDisplayOption_inlineQsb,</span><br><span class="line">                    DONT_INLINE_QSB);</span><br><span class="line">            inlineQsb[INDEX_DEFAULT] =</span><br><span class="line">                    (inlineForRotation &amp; INLINE_QSB_FOR_PORTRAIT) == INLINE_QSB_FOR_PORTRAIT;</span><br><span class="line">            inlineQsb[INDEX_LANDSCAPE] =</span><br><span class="line">                    (inlineForRotation &amp; INLINE_QSB_FOR_LANDSCAPE) == INLINE_QSB_FOR_LANDSCAPE;</span><br><span class="line">            inlineQsb[INDEX_TWO_PANEL_PORTRAIT] =</span><br><span class="line">                    (inlineForRotation &amp; INLINE_QSB_FOR_TWO_PANEL_PORTRAIT)</span><br><span class="line">                            == INLINE_QSB_FOR_TWO_PANEL_PORTRAIT;</span><br><span class="line">            inlineQsb[INDEX_TWO_PANEL_LANDSCAPE] =</span><br><span class="line">                    (inlineForRotation &amp; INLINE_QSB_FOR_TWO_PANEL_LANDSCAPE)</span><br><span class="line">                            == INLINE_QSB_FOR_TWO_PANEL_LANDSCAPE;</span><br><span class="line">            <span class="comment">// é‡Šæ”¾ TypedArrayï¼Œä»¥é¿å…å†…å­˜æ³„æ¼</span></span><br><span class="line">            a.recycle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å†æ¥çœ‹ <font color="#085DFF">idp.defaultLayoutId</font>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvariantDeviceProfile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> defaultLayoutId;    <span class="comment">// è¿™ä¸ªé»˜è®¤å¸ƒå±€æ˜¯å“ªä¸ªï¼Œä½ æ¸…æ¥šäº†å—ï¼Ÿ</span></span><br><span class="line">    </span><br><span class="line">    ==&gt; defaultLayoutId = a.getResourceId(</span><br><span class="line">                R.styleable.GridDisplayOption_defaultLayoutId, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ==&gt; å°±çœ‹ä½ çš„ gridName æ˜¯å“ªä¸ªï¼Œæ¯”å¦‚æˆ‘çš„è®¾å¤‡æ˜¯ï¼š5_by_5</span><br><span class="line">    </span><br><span class="line">    ==&gt; </span><br><span class="line">	    &lt;grid-option</span><br><span class="line">	        launcher:name=<span class="string">&quot;5_by_5&quot;</span></span><br><span class="line">	        launcher:numRows=<span class="string">&quot;5&quot;</span></span><br><span class="line">	        launcher:numColumns=<span class="string">&quot;5&quot;</span></span><br><span class="line">	        launcher:numFolderRows=<span class="string">&quot;4&quot;</span></span><br><span class="line">	        launcher:numFolderColumns=<span class="string">&quot;4&quot;</span></span><br><span class="line">	        launcher:numHotseatIcons=<span class="string">&quot;5&quot;</span></span><br><span class="line">	        launcher:numExtendedHotseatIcons=<span class="string">&quot;6&quot;</span></span><br><span class="line">	        launcher:dbFile=<span class="string">&quot;launcher.db&quot;</span></span><br><span class="line">	        launcher:inlineNavButtonsEndSpacing=<span class="string">&quot;@dimen/taskbar_button_margin_split&quot;</span></span><br><span class="line">	        launcher:defaultLayoutId=<span class="string">&quot;@xml/default_workspace_5x5&quot;</span></span><br><span class="line">	        launcher:deviceCategory=<span class="string">&quot;phone|multi_display&quot;</span> &gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®²åˆ°è¿™ï¼Œæˆ‘ä»¬å°±å®Œå…¨è®²é€šäº† Launcher ä½•æ—¶ä¼šè§£æ <font color="#008B45">device_profiles.xml</font> æ–‡ä»¶ï¼Œå¹¶ä¸”å»æ‰¾å¯¹åº”çš„æŸä¸€ä¸ª <font color="#008B45">default_workspace_xxx</font> äº†ã€‚</p>
<hr>
<h2 id="åŠ è½½æ•°æ®åº“"><a href="#åŠ è½½æ•°æ®åº“" class="headerlink" title="åŠ è½½æ•°æ®åº“"></a>åŠ è½½æ•°æ®åº“</h2><p>åˆ†æå®Œé»˜è®¤å¸ƒå±€çš„æµç¨‹å¤–ï¼Œæˆ‘ä»¬ç»§ç»­ <code>loadWorkspaceImpl()</code> ä¸­é—ç•™çš„æ•°æ®åº“çš„åŠ è½½é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> LauncherAppState mApp;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadWorkspaceImpl</span><span class="params">(</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts,</span></span><br><span class="line"><span class="params">            String selection,</span></span><br><span class="line"><span class="params">            <span class="meta">@Nullable</span> LoaderMemoryLogger memoryLogger)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*********************************************************************</span></span><br><span class="line"><span class="comment">         *  æ ¸å¿ƒ 1: åŠ è½½é»˜è®¤æ¡Œé¢å¸ƒå±€</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  ä¼šè°ƒç”¨åˆ° LauncherProvider çš„ loadDefaultFavoritesIfNecessary() æ–¹æ³•ï¼Œ</span></span><br><span class="line"><span class="comment">         *  è¿™ä¸ªæ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åŠ è½½é»˜è®¤çš„å¸ƒå±€ï¼Œå¦‚æœæ¸…é™¤äº†æ¡Œé¢æ•°æ®</span></span><br><span class="line"><span class="comment">         *  æˆ–è€…æ‰‹æœºæ¢å¤äº†å‡ºå‚è®¾ç½®ï¼Œå°±ä¼šåŠ è½½é»˜è®¤çš„å¸ƒå±€</span></span><br><span class="line"><span class="comment">         ********************************************************************/</span></span><br><span class="line">        Settings.call(contentResolver, Settings.METHOD_LOAD_DEFAULT_FAVORITES);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/*********************************************************************</span></span><br><span class="line"><span class="comment">         *  æ ¸å¿ƒ 2:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  åŠ è½½æ•°æ®åº“</span></span><br><span class="line"><span class="comment">         ********************************************************************/</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mBgDataModel) &#123;</span><br><span class="line">            mBgDataModel.clear();       <span class="comment">// æ¸…é™¤æ•°æ®æ¨¡å‹ï¼ˆå†…å­˜ä¸­çš„å·¥ä½œåŒºæ•°æ®ï¼‰</span></span><br><span class="line">            mPendingPackages.clear();   <span class="comment">// æ¸…é™¤å¾…å¤„ç†çš„åº”ç”¨åŒ…ä¿¡æ¯</span></span><br><span class="line">    </span><br><span class="line">            <span class="comment">// è·å–å½“å‰æ­£åœ¨è¿›è¡Œçš„å®‰è£…ä¼šè¯çš„åˆ—è¡¨</span></span><br><span class="line">            <span class="keyword">final</span> HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs =</span><br><span class="line">                    mSessionHelper.getActiveSessions();</span><br><span class="line">            <span class="comment">// å°†æ¯ä¸ªå®‰è£…ä¼šè¯çš„ä¿¡æ¯æ›´æ–°åˆ°å›¾æ ‡ç¼“å­˜ä¸­ (IconCache)ï¼Œç¡®ä¿ Launcher èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºåº”ç”¨å®‰è£…çŠ¶æ€</span></span><br><span class="line">            installingPkgs.forEach(mApp.getIconCache()::updateSessionCache);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// ç”¨äºæš‚å­˜åŒ…åå’Œç”¨æˆ·é”®å€¼çš„ä¸´æ—¶å¯¹è±¡</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">PackageUserKey</span> <span class="variable">tempPackageKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageUserKey</span>(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªå¹¿æ’­å¯¹è±¡ï¼Œç”¨äºåœ¨ Launcher åŠ è½½æ—¶å¹¿æ’­çŠ¶æ€ä¿¡æ¯</span></span><br><span class="line">            mFirstScreenBroadcast = <span class="keyword">new</span> <span class="title class_">FirstScreenBroadcast</span>(installingPkgs);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// å­˜å‚¨å›ºå®šåœ¨ Launcher ä¸Šçš„å¿«æ·æ–¹å¼ä¿¡æ¯çš„æ˜ å°„</span></span><br><span class="line">            mShortcutKeyToPinnedShortcuts = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="type">ModelDbController</span> <span class="variable">dbController</span> <span class="operator">=</span> mApp.getModel().getModelDbController();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/***********************************************</span></span><br><span class="line"><span class="comment">             * é€šè¿‡ LoaderCursor æŸ¥è¯¢æ•°æ®åº“ï¼Œè·å–å·¥ä½œç©ºé—´çš„æ•°æ®é¡¹</span></span><br><span class="line"><span class="comment">             ***********************************************/</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">LoaderCursor</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoaderCursor</span>(</span><br><span class="line">                    dbController.query(TABLE_NAME, <span class="literal">null</span>, selection, <span class="literal">null</span>, <span class="literal">null</span>),</span><br><span class="line">                    mApp, mUserManagerState);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">extras</span> <span class="operator">=</span> c.getExtras();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä»æ•°æ®åº“æŸ¥è¯¢ç»“æœçš„é¢å¤–ä¿¡æ¯ (extras) ä¸­è·å–æ•°æ®åº“åç§° -&gt; launcher.db</span></span><br><span class="line">            mDbName = extras == <span class="literal">null</span> ? <span class="literal">null</span> : extras.getString(Settings.EXTRA_DB_NAME);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ä¸€ä¸ªç¨€ç–æ•°ç»„ (LongSparseArray)ï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·çš„è§£é”çŠ¶æ€</span></span><br><span class="line">                <span class="keyword">final</span> LongSparseArray&lt;Boolean&gt; unlockedUsers = <span class="keyword">new</span> <span class="title class_">LongSparseArray</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">                mUserManagerState.init(mUserCache, mUserManager);</span><br><span class="line">                <span class="comment">// éå†ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼Œå¯¹æ¯ä¸ªç”¨æˆ·ï¼š</span></span><br><span class="line">                <span class="keyword">for</span> (UserHandle user : mUserCache.getUserProfiles()) &#123;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">serialNo</span> <span class="operator">=</span> mUserCache.getSerialNumberForUser(user);</span><br><span class="line">                    <span class="comment">// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è§£é”</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">userUnlocked</span> <span class="operator">=</span> mUserManager.isUserUnlocked(user);</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// å‘ LauncherAppsService è·å– Pinned Shortcuts</span></span><br><span class="line">                    <span class="keyword">if</span> (userUnlocked) &#123;</span><br><span class="line">                        <span class="type">QueryResult</span> <span class="variable">pinnedShortcuts</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShortcutRequest</span>(context, user)</span><br><span class="line">                                .query(ShortcutRequest.PINNED);</span><br><span class="line">                        <span class="keyword">if</span> (pinnedShortcuts.wasSuccess()) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (ShortcutInfo shortcut : pinnedShortcuts) &#123;</span><br><span class="line">                                <span class="comment">// å¦‚æœç”¨æˆ·è§£é”ï¼ŒæŸ¥è¯¢å›ºå®šçš„å¿«æ·æ–¹å¼ï¼Œ</span></span><br><span class="line">                                <span class="comment">// å¹¶å°†å…¶å­˜å‚¨åœ¨ mShortcutKeyToPinnedShortcuts ä¸­</span></span><br><span class="line">                                mShortcutKeyToPinnedShortcuts.put(ShortcutKey.fromInfo(shortcut),</span><br><span class="line">                                        shortcut);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// Shortcut manager can fail due to some race condition when the</span></span><br><span class="line">                            <span class="comment">// lock state changes too frequently. For the purpose of the loading</span></span><br><span class="line">                            <span class="comment">// shortcuts, consider the user is still locked.</span></span><br><span class="line">                            userUnlocked = <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å°†ç”¨æˆ·çš„è§£é”çŠ¶æ€å­˜å‚¨åœ¨ unlockedUsers ä¸­</span></span><br><span class="line">                    unlockedUsers.put(serialNo, userUnlocked);</span><br><span class="line">                &#125;</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// ä¸€ä¸ªåˆ—è¡¨ï¼Œå­˜å‚¨äº†éœ€è¦æ‰¹é‡åŠ è½½çš„å›¾æ ‡è¯·æ±‚ä¿¡æ¯</span></span><br><span class="line">                List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * å¼€å§‹éå†æ•°æ®åº“ï¼Œä¸€æ¬¡è¯»å–æ•°æ®åº“å†…å®¹ï¼Œéå† LoaderCursor ä¸­çš„æ¯ä¸€è¡Œï¼Œ</span></span><br><span class="line"><span class="comment">                 * ä½¿ç”¨ processWorkspaceItem() æ–¹æ³•</span></span><br><span class="line"><span class="comment">                 * å¤„ç†æ¯ä¸ªå·¥ä½œç©ºé—´é¡¹ç›®ï¼ŒåŒ…æ‹¬åº”ç”¨å›¾æ ‡ã€å°éƒ¨ä»¶å’Œå¿«æ·æ–¹å¼</span></span><br><span class="line"><span class="comment">                 * </span></span><br><span class="line"><span class="comment">                 * æ ¸å¿ƒæ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬è¦è·Ÿè¸ªï¼ï¼ï¼</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">while</span> (!mStopped &amp;&amp; c.moveToNext()) &#123;</span><br><span class="line">                    processWorkspaceItem(c, memoryLogger, installingPkgs, isSdCardReady,</span><br><span class="line">                            tempPackageKey, widgetHelper, pmHelper,</span><br><span class="line">                            iconRequestInfos, unlockedUsers, isSafeMode, allDeepShortcuts);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ‰¹é‡åŠ è½½å·¥ä½œç©ºé—´å›¾æ ‡ï¼Œä»¥æé«˜åŠ è½½æ€§èƒ½</span></span><br><span class="line">                tryLoadWorkspaceIconsInBulk(iconRequestInfos);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                IOUtils.closeSilently(c);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (!FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) &#123;</span><br><span class="line">                <span class="comment">// mModelDelegate: è´Ÿè´£å°†æ•°æ®ç»‘å®šåˆ° UI ä¸Šçš„å§”æ‰˜å¯¹è±¡</span></span><br><span class="line">                <span class="comment">// åŠ è½½å¹¶ç»‘å®š WorkspaceItems</span></span><br><span class="line">                mModelDelegate.loadAndBindWorkspaceItems(mUserManagerState,</span><br><span class="line">                        mLauncherBinder.mCallbacksList, mShortcutKeyToPinnedShortcuts);</span><br><span class="line">                <span class="comment">// åŠ è½½å¹¶ç»‘å®š AllAppsItems</span></span><br><span class="line">                mModelDelegate.loadAndBindAllAppsItems(mUserManagerState,</span><br><span class="line">                        mLauncherBinder.mCallbacksList, mShortcutKeyToPinnedShortcuts);</span><br><span class="line">                <span class="comment">// åŠ è½½å¹¶ç»‘å®š OtherItems</span></span><br><span class="line">                mModelDelegate.loadAndBindOtherItems(mLauncherBinder.mCallbacksList);</span><br><span class="line">                <span class="comment">// æ ‡è®°åŠ è½½è¿‡ç¨‹å®Œæˆï¼ŒLauncher å¯ä»¥å¼€å§‹å“åº”ç”¨æˆ·æ“ä½œ</span></span><br><span class="line">                mModelDelegate.markActive();</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// Break early if we have stopped loading</span></span><br><span class="line">            <span class="keyword">if</span> (mStopped) &#123;</span><br><span class="line">                mBgDataModel.clear();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// Remove dead itemsï¼Œåˆ é™¤ processWorkspaceItem ä¸­æ ‡è®° delete çš„æ•°æ®</span></span><br><span class="line">            mItemsDeleted = c.commitDeleted();</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// Sort the folder items, update ranks, and make sure all preview items are high res.</span></span><br><span class="line">            <span class="comment">// æ–‡ä»¶å¤¹å†…å®¹çš„æ’åºå’Œæ›´æ–°</span></span><br><span class="line">            <span class="comment">// FolderGridOrganizer: ç”¨äºç»„ç»‡å’ŒéªŒè¯æ–‡ä»¶å¤¹ç½‘æ ¼å¸ƒå±€</span></span><br><span class="line">            <span class="type">FolderGridOrganizer</span> <span class="variable">verifier</span> <span class="operator">=</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">FolderGridOrganizer</span>(mApp.getInvariantDeviceProfile());</span><br><span class="line">            <span class="comment">// éå†æ¯ä¸€ä¸ªæ–‡ä»¶å¤¹</span></span><br><span class="line">            <span class="keyword">for</span> (FolderInfo folder : mBgDataModel.folders) &#123;</span><br><span class="line">                <span class="comment">// å¯¹æ–‡ä»¶å¤¹å†…å®¹è¿›è¡Œæ’åº</span></span><br><span class="line">                Collections.sort(folder.contents, Folder.ITEM_POS_COMPARATOR);</span><br><span class="line">                verifier.setFolderInfo(folder);</span><br><span class="line">                <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> folder.contents.size();</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// Update ranks here to ensure there are no gaps caused by removed folder items.</span></span><br><span class="line">                <span class="comment">// Ranks are the source of truth for folder items, so cellX and cellY can be ignored</span></span><br><span class="line">                <span class="comment">// for now. Database will be updated once user manually modifies folder.</span></span><br><span class="line">                <span class="comment">// æ›´æ–°é¡¹ç›®çš„ rankï¼Œç¡®ä¿æ˜¾ç¤ºé¡ºåºæ­£ç¡®</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rank</span> <span class="operator">=</span> <span class="number">0</span>; rank &lt; size; ++rank) &#123;</span><br><span class="line">                    <span class="type">WorkspaceItemInfo</span> <span class="variable">info</span> <span class="operator">=</span> folder.contents.get(rank);</span><br><span class="line">                    info.rank = rank;</span><br><span class="line">                    <span class="comment">// å¯¹äºä½¿ç”¨ä½åˆ†è¾¨ç‡å›¾æ ‡ä¸”æ˜¾ç¤ºåœ¨æ–‡ä»¶å¤¹é¢„è§ˆä¸­çš„é¡¹ç›®ï¼ŒåŠ è½½é«˜åˆ†è¾¨ç‡å›¾æ ‡</span></span><br><span class="line">                    <span class="keyword">if</span> (info.usingLowResIcon()</span><br><span class="line">                            &amp;&amp; info.itemType == Favorites.ITEM_TYPE_APPLICATION</span><br><span class="line">                            &amp;&amp; verifier.isItemInPreview(info.rank)) &#123;</span><br><span class="line">                        mIconCache.getTitleAndIcon(info, <span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// æœ€åï¼Œå°†æ‰€æœ‰å¤„ç†åçš„å·¥ä½œåŒºé¡¹æäº¤åˆ°æ•°æ®åº“ä¸­</span></span><br><span class="line">            c.commitRestoredItems();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¼€å§‹é‡ç‚¹åˆ†æ <font color="#085DFF">processWorkspaceItem()</font> çš„æºç äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†ä»æ•°æ®åº“åŠ è½½çš„æ¡Œé¢é¡¹ç›®ï¼ˆå¦‚å¿«æ·æ–¹å¼ã€æ–‡ä»¶å¤¹ã€åº”ç”¨å°éƒ¨ä»¶ç­‰ï¼‰</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   c               : ç”¨äºè¯»å–æ•°æ®åº“ä¸­å­˜å‚¨çš„æ¡Œé¢é¡¹ç›®æ•°æ®çš„æ¸¸æ ‡</span></span><br><span class="line"><span class="comment">     *   memoryLogger    : ç”¨äºè®°å½•å†…å­˜æ¶ˆè€—çš„æ—¥å¿—å·¥å…·</span></span><br><span class="line"><span class="comment">     *   installingPkgs  : ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œç”¨äºè·Ÿè¸ªæ­£åœ¨å®‰è£…çš„åº”ç”¨åŒ…</span></span><br><span class="line"><span class="comment">     *   isSdCardReady   : æ ‡è¯† SD å¡æ˜¯å¦å·²å‡†å¤‡å°±ç»ªçš„æ ‡å¿—</span></span><br><span class="line"><span class="comment">     *   tempPackageKey  : ä¸€ä¸ªä¸´æ—¶çš„ PackageUserKey å¯¹è±¡ï¼Œç”¨äºå¤„ç†åŒ…åå’Œç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *   widgetHelper    : ç”¨äºç®¡ç†å°éƒ¨ä»¶çš„è¾…åŠ©ç±»</span></span><br><span class="line"><span class="comment">     *   pmHelper        : ç”¨äºå¤„ç†åŒ…ç®¡ç†çš„è¾…åŠ©ç±»</span></span><br><span class="line"><span class="comment">     *   iconRequestInfos: ç”¨äºå­˜å‚¨è¦åŠ è½½å›¾æ ‡çš„è¯·æ±‚ä¿¡æ¯çš„åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     *   unlockedUsers   : ç”¨äºå­˜å‚¨å·²è§£é”ç”¨æˆ·çš„æ ‡è¯†ç¬¦çš„ç¨€ç–æ•°ç»„</span></span><br><span class="line"><span class="comment">     *   isSafeMode      : æ˜¯å¦å¤„äºå®‰å…¨æ¨¡å¼çš„æ ‡å¿—</span></span><br><span class="line"><span class="comment">     *   allDeepShortcuts: ç”¨äºå­˜å‚¨æ‰€æœ‰æ·±å±‚å¿«æ·æ–¹å¼çš„ä¿¡æ¯åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processWorkspaceItem</span><span class="params">(LoaderCursor c,</span></span><br><span class="line"><span class="params">            LoaderMemoryLogger memoryLogger,</span></span><br><span class="line"><span class="params">            HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSdCardReady,</span></span><br><span class="line"><span class="params">            PackageUserKey tempPackageKey,</span></span><br><span class="line"><span class="params">            WidgetManagerHelper widgetHelper,</span></span><br><span class="line"><span class="params">            PackageManagerHelper pmHelper,</span></span><br><span class="line"><span class="params">            List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos,</span></span><br><span class="line"><span class="params">            LongSparseArray&lt;Boolean&gt; unlockedUsers,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSafeMode,</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (c.user == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// User has been deleted, remove the item.</span></span><br><span class="line">                <span class="comment">// é¦–å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ ‡è®°ä¸ºåˆ é™¤</span></span><br><span class="line">                c.markDeleted(<span class="string">&quot;User has been deleted&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// ç”¨äºæ ‡è®°æ˜¯å¦å…è®¸ä¸¢å¤±ç›®æ ‡åº”ç”¨çš„æƒ…å†µ</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">allowMissingTarget</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ¥ä¸‹æ¥å°±æ˜¯å®é™…çš„å¤„ç†é€»è¾‘äº†ï¼Œå¼€å§‹å¤„ç†ä¸åŒç±»å‹çš„æ¡Œé¢é¡¹ç›®ï¼š</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             *   Favorites.ITEM_TYPE_SHORTCUT     : å¤„ç†æ™®é€šå¿«æ·æ–¹å¼</span></span><br><span class="line"><span class="comment">             *   Favorites.ITEM_TYPE_APPLICATION  : å¤„ç†åº”ç”¨å¿«æ·æ–¹å¼</span></span><br><span class="line"><span class="comment">             *   Favorites.ITEM_TYPE_DEEP_SHORTCUT: å¤„ç†æ·±å±‚å¿«æ·æ–¹å¼</span></span><br><span class="line"><span class="comment">             *   Favorites.ITEM_TYPE_FOLDER       : å¤„ç†æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">             *   Favorites.ITEM_TYPE_APPWIDGET    : å¤„ç†åº”ç”¨å°éƒ¨ä»¶</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">switch</span> (c.itemType) &#123;</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_SHORTCUT:        <span class="comment">// å¦‚æœæ˜¯å¿«æ·æ–¹å¼</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPLICATION:     <span class="comment">// å¦‚æœæ˜¯åº”ç”¨ç¨‹åº</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_DEEP_SHORTCUT:   <span class="comment">// å¦‚æœæ˜¯æ·±å±‚å¿«æ·æ–¹å¼</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_FOLDER           <span class="comment">// å¦‚æœæ˜¯æ–‡ä»¶å¤¹</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPWIDGET        <span class="comment">// å¦‚æœæ˜¯åº”ç”¨å°éƒ¨ä»¶</span></span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">// ä»£ç å¤ªå¤šï¼Œæˆ‘ä»¬åˆ†ç±»åˆ†æ</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Desktop items loading interrupted&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åº”ç”¨-å¿«æ·æ–¹å¼"><a href="#åº”ç”¨-å¿«æ·æ–¹å¼" class="headerlink" title="åº”ç”¨&#x2F;å¿«æ·æ–¹å¼"></a>åº”ç”¨&#x2F;å¿«æ·æ–¹å¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processWorkspaceItem</span><span class="params">(LoaderCursor c,</span></span><br><span class="line"><span class="params">            LoaderMemoryLogger memoryLogger,</span></span><br><span class="line"><span class="params">            HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSdCardReady,</span></span><br><span class="line"><span class="params">            PackageUserKey tempPackageKey,</span></span><br><span class="line"><span class="params">            WidgetManagerHelper widgetHelper,</span></span><br><span class="line"><span class="params">            PackageManagerHelper pmHelper,</span></span><br><span class="line"><span class="params">            List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos,</span></span><br><span class="line"><span class="params">            LongSparseArray&lt;Boolean&gt; unlockedUsers,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSafeMode,</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (c.itemType) &#123;</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_SHORTCUT:        <span class="comment">// å¦‚æœæ˜¯å¿«æ·æ–¹å¼</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPLICATION:     <span class="comment">// å¦‚æœæ˜¯åº”ç”¨ç¨‹åº</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_DEEP_SHORTCUT:   <span class="comment">// å¦‚æœæ˜¯æ·±å±‚å¿«æ·æ–¹å¼</span></span><br><span class="line">                    <span class="comment">// ä» LoaderCursor ä¸­è§£æ Intent å¯¹è±¡</span></span><br><span class="line">                    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> c.parseIntent();</span><br><span class="line">                    <span class="comment">// éªŒè¯ intent æœ‰æ•ˆæ€§</span></span><br><span class="line">                    <span class="keyword">if</span> (intent == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// å¦‚æœ Intent ä¸ºç©ºæˆ–æ— æ•ˆï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤</span></span><br><span class="line">                        c.markDeleted(<span class="string">&quot;Invalid or null intent&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// æ ¹æ®ç”¨æˆ·ç®¡ç†å™¨çŠ¶æ€åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦ä¸ºé™é»˜ç”¨æˆ·</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">disabledState</span> <span class="operator">=</span> mUserManagerState.isUserQuiet(c.serialNumber)</span><br><span class="line">                            ? WorkspaceItemInfo.FLAG_DISABLED_QUIET_USER : <span class="number">0</span>;</span><br><span class="line">                    <span class="comment">// ä» Intent ä¸­è·å–ç»„ä»¶åç§°</span></span><br><span class="line">                    <span class="type">ComponentName</span> <span class="variable">cn</span> <span class="operator">=</span> intent.getComponent();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">targetPkg</span> <span class="operator">=</span> cn == <span class="literal">null</span> ? intent.getPackage() : cn.getPackageName();</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// å¦‚æœç›®æ ‡åŒ…åä¸ºç©ºä¸”é¡¹ç›®ç±»å‹ä¸æ˜¯å¿«æ·æ–¹å¼ï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤</span></span><br><span class="line">                    <span class="keyword">if</span> (TextUtils.isEmpty(targetPkg)</span><br><span class="line">                            &amp;&amp; c.itemType != Favorites.ITEM_TYPE_SHORTCUT) &#123;</span><br><span class="line">                        c.markDeleted(<span class="string">&quot;Only legacy shortcuts can have null package&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// æ£€æŸ¥ç›®æ ‡åŒ…æ˜¯å¦æœ‰æ•ˆï¼ˆå¦‚æœæ²¡æœ‰ç›®æ ‡åŒ…åï¼Œåˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªéšå¼ Intentï¼Œå§‹ç»ˆæœ‰æ•ˆï¼‰</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">validTarget</span> <span class="operator">=</span> TextUtils.isEmpty(targetPkg)</span><br><span class="line">                            || mLauncherApps.isPackageEnabled(targetPkg, c.user);</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// å¦‚æœç»„ä»¶åä¸ä¸ºç©ºä¸”ç›®æ ‡æœ‰æ•ˆä¸”é¡¹ç›®ä¸æ˜¯æ·±åº¦å¿«æ·æ–¹å¼</span></span><br><span class="line">                    <span class="keyword">if</span> (cn != <span class="literal">null</span> &amp;&amp; validTarget &amp;&amp; c.itemType</span><br><span class="line">                            != Favorites.ITEM_TYPE_DEEP_SHORTCUT) &#123;</span><br><span class="line">                        <span class="comment">// If the apk is present and the shortcut points to a specific component.</span></span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// å¦‚æœç›®æ ‡æ´»åŠ¨å­˜åœ¨ï¼Œæ ‡è®°é¡¹ç›®ä¸ºå·²æ¢å¤</span></span><br><span class="line">                        <span class="keyword">if</span> (mLauncherApps.isActivityEnabled(cn, c.user)) &#123;</span><br><span class="line">                            <span class="comment">// no special handling necessary for this item</span></span><br><span class="line">                            c.markRestored();  <span class="comment">// æ ‡è®°ä¸ºå·²æ¢å¤</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// å¦åˆ™ï¼Œå°è¯•æ‰¾åˆ°ä¸€ä¸ªå¤‡ç”¨çš„å¯åŠ¨æ´»åŠ¨</span></span><br><span class="line">                            intent = pmHelper.getAppLaunchIntent(targetPkg, c.user);</span><br><span class="line">                            <span class="comment">// å¦‚æœæ‰¾åˆ°äº†å¯åŠ¨æ´»åŠ¨ï¼Œæ›´æ–° Intent å¹¶é‡ç½®æ¢å¤æ ‡å¿—</span></span><br><span class="line">                            <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</span><br><span class="line">                                c.restoreFlag = <span class="number">0</span>;</span><br><span class="line">                                c.updater().put(</span><br><span class="line">                                        Favorites.INTENT,</span><br><span class="line">                                        intent.toUri(<span class="number">0</span>)).commit();</span><br><span class="line">                                <span class="comment">// æ›´æ–°ç»„ä»¶åç§°</span></span><br><span class="line">                                cn = intent.getComponent();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// å¦‚æœæ‰¾ä¸åˆ°å¯åŠ¨æ´»åŠ¨ï¼Œåˆ™æ ‡è®°é¡¹ç›®ä¸ºå·²åˆ é™¤å¹¶è¿”å›</span></span><br><span class="line">                                c.markDeleted(<span class="string">&quot;Unable to find a launch target&quot;</span>);</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// å¦‚æœç›®æ ‡åŒ…æ— æ•ˆï¼Œåˆ™å¤„ç†æ¢å¤çŠ¶æ€</span></span><br><span class="line">                    <span class="keyword">if</span> (!TextUtils.isEmpty(targetPkg) &amp;&amp; !validTarget) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (c.restoreFlag != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœåº”ç”¨ç¨‹åºè¿˜æœªæ¢å¤</span></span><br><span class="line">                            FileLog.d(TAG, <span class="string">&quot;package not yet restored: &quot;</span> + targetPkg);</span><br><span class="line">    </span><br><span class="line">                            tempPackageKey.update(targetPkg, c.user);</span><br><span class="line">                            <span class="keyword">if</span> (c.hasRestoreFlag(WorkspaceItemInfo.FLAG_RESTORE_STARTED)) &#123;</span><br><span class="line">                                <span class="comment">// æ¢å¤å·²ç»å¼€å§‹ï¼Œä¸åšä»»ä½•æ“ä½œ</span></span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installingPkgs.containsKey(tempPackageKey)) &#123;</span><br><span class="line">                                <span class="comment">// æ¢å¤æ­£åœ¨è¿›è¡Œï¼Œæ›´æ–°æ¢å¤æ ‡è®°</span></span><br><span class="line">                                c.restoreFlag |= WorkspaceItemInfo.FLAG_RESTORE_STARTED;</span><br><span class="line">                                c.updater().put(Favorites.RESTORED,</span><br><span class="line">                                        c.restoreFlag).commit();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// å¦åˆ™æ ‡è®°é¡¹ç›®ä¸ºå·²åˆ é™¤å¹¶è¿”å›</span></span><br><span class="line">                                c.markDeleted(<span class="string">&quot;Unrestored app removed: &quot;</span> + targetPkg);</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pmHelper.isAppOnSdcard(targetPkg, c.user)) &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœåŒ…åœ¨ SD å¡ä¸Šä½†ä¸å¯ç”¨ï¼Œæ ‡è®°åº”ç”¨ä¸å¯ç”¨</span></span><br><span class="line">                            disabledState |= WorkspaceItemInfo.FLAG_DISABLED_NOT_AVAILABLE;</span><br><span class="line">                            <span class="comment">// å…è®¸ä¸¢å¤±ç›®æ ‡ï¼Œä»ç„¶å°†å›¾æ ‡æ·»åŠ åˆ°å·¥ä½œåŒº</span></span><br><span class="line">                            allowMissingTarget = <span class="literal">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isSdCardReady) &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœ SD å¡æœªå‡†å¤‡å¥½ï¼Œå°†åŒ…åæ·»åŠ åˆ°å¾…å¤„ç†åˆ—è¡¨ä¸­</span></span><br><span class="line">                            Log.d(TAG, <span class="string">&quot;Missing pkg, will check later: &quot;</span> + targetPkg);</span><br><span class="line">                            mPendingPackages.add(<span class="keyword">new</span> <span class="title class_">PackageUserKey</span>(targetPkg, c.user));</span><br><span class="line">                            <span class="comment">// å…è®¸ä¸¢å¤±ç›®æ ‡ï¼Œä»ç„¶å°†å›¾æ ‡æ·»åŠ åˆ°å·¥ä½œåŒº</span></span><br><span class="line">                            allowMissingTarget = <span class="literal">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœåŒ…æ— æ•ˆä¸” SD å¡å·²å‡†å¤‡å¥½ï¼Œæ ‡è®°é¡¹ç›®ä¸ºå·²åˆ é™¤å¹¶è¿”å›</span></span><br><span class="line">                            c.markDeleted(<span class="string">&quot;Invalid package removed: &quot;</span> + targetPkg);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// å¦‚æœæ¢å¤æ ‡å¿—åŒ…å« Web UI æ”¯æŒæ ‡å¿—ï¼Œè®¾ç½®ç›®æ ‡æ— æ•ˆ</span></span><br><span class="line">                    <span class="keyword">if</span> ((c.restoreFlag &amp; WorkspaceItemInfo.FLAG_SUPPORTS_WEB_UI) != <span class="number">0</span>) &#123;</span><br><span class="line">                        validTarget = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="keyword">if</span> (validTarget) &#123;</span><br><span class="line">                        <span class="comment">// å¦‚æœå¿«æ·æ–¹å¼æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„ç›®æ ‡ï¼Œæ ‡è®°ä¸ºå·²æ¢å¤</span></span><br><span class="line">                        c.markRestored();</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// å†³å®šæ˜¯å¦ä½¿ç”¨ä½åˆ†è¾¨ç‡çš„å›¾æ ‡</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">useLowResIcon</span> <span class="operator">=</span> !c.isOnWorkspaceOrHotseat();</span><br><span class="line">    </span><br><span class="line">                    WorkspaceItemInfo info;</span><br><span class="line">                    <span class="keyword">if</span> (c.restoreFlag != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// å¦‚æœæ¢å¤æ ‡è®°ä¸ä¸º 0ï¼Œè·å–æ¢å¤çš„ item ä¿¡æ¯</span></span><br><span class="line">                        info = c.getRestoredItemInfo(intent);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c.itemType == Favorites.ITEM_TYPE_APPLICATION) &#123;</span><br><span class="line">                        <span class="comment">// åˆ›å»ºåº”ç”¨ç¨‹åºå¿«æ·æ–¹å¼ä¿¡æ¯</span></span><br><span class="line">                        info = c.getAppShortcutInfo(</span><br><span class="line">                                intent, allowMissingTarget, useLowResIcon, <span class="literal">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c.itemType == Favorites.ITEM_TYPE_DEEP_SHORTCUT) &#123;</span><br><span class="line">                        <span class="comment">// å¤„ç†æ·±å±‚å¿«æ·æ–¹å¼</span></span><br><span class="line">                        <span class="type">ShortcutKey</span> <span class="variable">key</span> <span class="operator">=</span> ShortcutKey.fromIntent(intent, c.user);</span><br><span class="line">                        <span class="keyword">if</span> (unlockedUsers.get(c.serialNumber)) &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœç”¨æˆ·å·²è§£é”ï¼Œè·å–æ·±åº¦å¿«æ·æ–¹å¼ä¿¡æ¯</span></span><br><span class="line">                            <span class="type">ShortcutInfo</span> <span class="variable">pinnedShortcut</span> <span class="operator">=</span> mShortcutKeyToPinnedShortcuts.get(key);</span><br><span class="line">                            <span class="keyword">if</span> (pinnedShortcut == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// å¦‚æœæœªæ‰¾åˆ°å›ºå®šå¿«æ·æ–¹å¼ï¼Œæ ‡è®°é¡¹ç›®ä¸ºå·²åˆ é™¤å¹¶è¿”å›</span></span><br><span class="line">                                c.markDeleted(<span class="string">&quot;Pinned shortcut not found&quot;</span>);</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// åˆ›å»ºæ·±åº¦å¿«æ·æ–¹å¼çš„ä¿¡æ¯å¯¹è±¡</span></span><br><span class="line">                            info = <span class="keyword">new</span> <span class="title class_">WorkspaceItemInfo</span>(pinnedShortcut, mApp.getContext());</span><br><span class="line">                            <span class="comment">// If the pinned deep shortcut is no longer published,</span></span><br><span class="line">                            <span class="comment">// use the last saved icon instead of the default.</span></span><br><span class="line">                            mIconCache.getShortcutIcon(info, pinnedShortcut, c::loadIcon);</span><br><span class="line">    </span><br><span class="line">                            <span class="comment">// æ£€æŸ¥åº”ç”¨æ˜¯å¦è¢«æŒ‚èµ·</span></span><br><span class="line">                            <span class="keyword">if</span> (pmHelper.isAppSuspended(</span><br><span class="line">                                    pinnedShortcut.getPackage(), info.user)) &#123;</span><br><span class="line">                                info.runtimeStatusFlags |= FLAG_DISABLED_SUSPENDED;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// æ›´æ–° Intent</span></span><br><span class="line">                            intent = info.getIntent();</span><br><span class="line">                            allDeepShortcuts.add(pinnedShortcut);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœç”¨æˆ·è¢«é”å®šï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„å·¥ä½œåŒºé¡¹ç›®ä¿¡æ¯</span></span><br><span class="line">                            info = c.loadSimpleWorkspaceItem();</span><br><span class="line">                            info.runtimeStatusFlags |= FLAG_DISABLED_LOCKED_USER;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// å¤„ç†æ™®é€šå¿«æ·æ–¹å¼</span></span><br><span class="line">                        info = c.loadSimpleWorkspaceItem();</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// Shortcuts are only available on the primary profile</span></span><br><span class="line">                        <span class="keyword">if</span> (!TextUtils.isEmpty(targetPkg)</span><br><span class="line">                                &amp;&amp; pmHelper.isAppSuspended(targetPkg, c.user)) &#123;</span><br><span class="line">                            disabledState |= FLAG_DISABLED_SUSPENDED;</span><br><span class="line">                        &#125;</span><br><span class="line">                        info.options = c.getOptions();</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// App shortcuts that used to be automatically added to Launcher</span></span><br><span class="line">                        <span class="comment">// did not always have the correct intent flags set, so do that here</span></span><br><span class="line">                        <span class="comment">// ä¿®å¤æŸäº›æ—§å¿«æ·æ–¹å¼çš„ Intent æ ‡å¿—</span></span><br><span class="line">                        <span class="keyword">if</span> (intent.getAction() != <span class="literal">null</span></span><br><span class="line">                                &amp;&amp; intent.getCategories() != <span class="literal">null</span></span><br><span class="line">                                &amp;&amp; intent.getAction().equals(Intent.ACTION_MAIN)</span><br><span class="line">                                &amp;&amp; intent.getCategories().contains(Intent.CATEGORY_LAUNCHER)) &#123;</span><br><span class="line">                            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">                                    | Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// æ£€æŸ¥ info æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                    <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (info.itemType != Favorites.ITEM_TYPE_DEEP_SHORTCUT) &#123;</span><br><span class="line">                            <span class="comment">// Skip deep shortcuts; their title and icons have already been</span></span><br><span class="line">                            <span class="comment">// loaded above.</span></span><br><span class="line">                            <span class="comment">// å°†å›¾æ ‡è¯·æ±‚ä¿¡æ¯æ·»åŠ åˆ°åˆ—è¡¨</span></span><br><span class="line">                            iconRequestInfos.add(c.createIconRequestInfo(info, useLowResIcon));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// åº”ç”¨é€šç”¨å±æ€§</span></span><br><span class="line">                        c.applyCommonProperties(info);</span><br><span class="line">                        <span class="comment">// æ›´æ–°ä¿¡æ¯å¯¹è±¡çš„ Intent å’Œå…¶ä»–å±æ€§</span></span><br><span class="line">                        info.intent = intent;</span><br><span class="line">                        info.rank = c.getRank();</span><br><span class="line">                        info.spanX = <span class="number">1</span>;</span><br><span class="line">                        info.spanY = <span class="number">1</span>;</span><br><span class="line">                        info.runtimeStatusFlags |= disabledState;</span><br><span class="line">                        <span class="comment">// å¦‚æœå¤„äºå®‰å…¨æ¨¡å¼ä¸”ç›®æ ‡åº”ç”¨ä¸æ˜¯ç³»ç»Ÿåº”ç”¨ï¼Œæ ‡è®°å…¶ä¸ºç¦ç”¨</span></span><br><span class="line">                        <span class="keyword">if</span> (isSafeMode &amp;&amp; !isSystemApp(mApp.getContext(), intent)) &#123;</span><br><span class="line">                            info.runtimeStatusFlags |= FLAG_DISABLED_SAFEMODE;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// è·å–å¯åŠ¨æ´»åŠ¨ä¿¡æ¯</span></span><br><span class="line">                        <span class="type">LauncherActivityInfo</span> <span class="variable">activityInfo</span> <span class="operator">=</span> c.getLauncherActivityInfo();</span><br><span class="line">                        <span class="keyword">if</span> (activityInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// è®¾ç½®ä¸‹è½½è¿›åº¦</span></span><br><span class="line">                            info.setProgressLevel(</span><br><span class="line">                                    PackageManagerHelper.getLoadingProgress(activityInfo),</span><br><span class="line">                                    PackageInstallInfo.STATUS_INSTALLED_DOWNLOADING);</span><br><span class="line">                        &#125;</span><br><span class="line">    </span><br><span class="line">                        <span class="keyword">if</span> (c.restoreFlag != <span class="number">0</span> &amp;&amp; !TextUtils.isEmpty(targetPkg)) &#123;</span><br><span class="line">                            tempPackageKey.update(targetPkg, c.user);</span><br><span class="line">                            <span class="type">SessionInfo</span> <span class="variable">si</span> <span class="operator">=</span> installingPkgs.get(tempPackageKey);</span><br><span class="line">                            <span class="keyword">if</span> (si == <span class="literal">null</span>) &#123;</span><br><span class="line">                                info.runtimeStatusFlags</span><br><span class="line">                                        &amp;= ~ItemInfoWithIcon.FLAG_INSTALL_SESSION_ACTIVE;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activityInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="type">int</span> <span class="variable">installProgress</span> <span class="operator">=</span> (<span class="type">int</span>) (si.getProgress() * <span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">                                info.setProgressLevel(installProgress,</span><br><span class="line">                                        PackageInstallInfo.STATUS_INSTALLING);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// æ£€æŸ¥å¹¶æ·»åŠ  item ä¿¡æ¯åˆ°æ•°æ®æ¨¡å‹</span></span><br><span class="line">                        c.checkAndAddItem(info, mBgDataModel, memoryLogger);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unexpected null WorkspaceItemInfo&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// ===&gt;&gt;&gt; åº”ç”¨/å¿«æ·æ–¹å¼å¤„ç†å®Œæ¯•</span></span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Desktop items loading interrupted&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹ <code>checkAndAddItem()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderCursor.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderCursor</span> <span class="keyword">extends</span> <span class="title class_">CursorWrapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥å¹¶æ·»åŠ ä¸€ä¸ª ItemInfo é¡¹ç›®åˆ°æ•°æ®æ¨¡å‹ä¸­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkAndAddItem</span><span class="params">(</span></span><br><span class="line"><span class="params">            ItemInfo info, BgDataModel dataModel, LoaderMemoryLogger logger)</span> &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥é¡¹ç›®ç±»å‹æ˜¯å¦ä¸ºæ·±å±‚å¿«æ·æ–¹å¼</span></span><br><span class="line">        <span class="keyword">if</span> (info.itemType == Favorites.ITEM_TYPE_DEEP_SHORTCUT) &#123;</span><br><span class="line">            <span class="comment">// ä» ItemInfo ä¸­ç”Ÿæˆ ShortcutKeyã€‚è¿™æ˜¯ç¡®ä¿å¿«æ·æ–¹å¼çš„ Intent æ˜¯æœ‰æ•ˆçš„ï¼Œ</span></span><br><span class="line">            <span class="comment">// å¦‚æœ ShortcutKey åˆ›å»ºå¤±è´¥ï¼Œå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œè·³è¿‡åŠ è½½è¯¥é¡¹ç›®</span></span><br><span class="line">            ShortcutKey.fromItemInfo(info);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éªŒè¯é¡¹ç›®åœ¨å¸ƒå±€ä¸­çš„ä½ç½®æ˜¯å¦æœ‰æ•ˆï¼ˆä¾‹å¦‚ï¼Œæ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–é¡¹ç›®é‡å ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (checkItemPlacement(info)) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * é‡ç‚¹æ–¹æ³•ï¼šå¦‚æœä½ç½®æœ‰æ•ˆï¼Œå°†é¡¹ç›®æ·»åŠ åˆ° dataModel ä¸­</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            dataModel.addItem(mContext, info, <span class="literal">false</span>, logger);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä½ç½®æ— æ•ˆï¼Œè°ƒç”¨ markDeleted æ–¹æ³•æ ‡è®°é¡¹ç›®ä¸ºå·²åˆ é™¤ï¼Œ</span></span><br><span class="line">            <span class="comment">// åŸå› æ˜¯ â€œItem position overlapâ€ï¼ˆé¡¹ç›®ä½ç½®é‡å ï¼‰</span></span><br><span class="line">            markDeleted(<span class="string">&quot;Item position overlap&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¸ª <code>BgDataModel</code> çš„ <code>addItem()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BgDataModel.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BgDataModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">addItem</span><span class="params">(</span></span><br><span class="line"><span class="params">            Context context, ItemInfo item, <span class="type">boolean</span> newItem, <span class="meta">@Nullable</span> LoaderMemoryLogger logger)</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¥å¿—è®°å½•</span></span><br><span class="line">        <span class="keyword">if</span> (logger != <span class="literal">null</span>) &#123;</span><br><span class="line">            logger.addLog(</span><br><span class="line">                    Log.DEBUG,</span><br><span class="line">                    TAG,</span><br><span class="line">                    String.format(<span class="string">&quot;Adding item to ID map: %s&quot;</span>, item.toString()),</span><br><span class="line">                    <span class="comment">/* stackTrace= */</span> <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°† ItemInfo çš„ ID å’Œé¡¹ç›®æœ¬èº«æ·»åŠ åˆ° itemsIdMap æ˜ å°„ä¸­ã€‚è¿™æ˜¯ä¸€ä¸ª ID åˆ° ItemInfo å¯¹è±¡çš„æ˜ å°„ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾é¡¹ç›®</span></span><br><span class="line">        itemsIdMap.put(item.id, item);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ ¹æ® ItemInfo ç±»å‹è¿›è¡Œåˆ†ç±»å¤„ç†</span></span><br><span class="line">        <span class="keyword">switch</span> (item.itemType) &#123;</span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_FOLDER:         <span class="comment">// æ–‡ä»¶å¤¹</span></span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APP_PAIR:       <span class="comment">// åº”ç”¨å¯¹</span></span><br><span class="line">                <span class="comment">// å°†æ–‡ä»¶å¤¹çš„ ID å’Œ FolderInfo å¯¹è±¡å­˜å‚¨åˆ° folders æ˜ å°„ä¸­</span></span><br><span class="line">                folders.put(item.id, (FolderInfo) item);</span><br><span class="line">                <span class="comment">// åŒæ—¶æ·»åŠ åˆ° workspaceItems é›†åˆï¼Œä»¥ä¾¿åœ¨å·¥ä½œåŒºæ˜¾ç¤º</span></span><br><span class="line">                workspaceItems.add(item);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_DEEP_SHORTCUT:  <span class="comment">// æ·±å±‚å¿«æ·æ–¹å¼</span></span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPLICATION:    <span class="comment">// åº”ç”¨</span></span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_SHORTCUT:       <span class="comment">// å¿«æ·æ–¹å¼</span></span><br><span class="line">                <span class="comment">// æ£€æŸ¥ container å€¼å†³å®šå­˜å‚¨ä½ç½®</span></span><br><span class="line">                <span class="keyword">if</span> (item.container == LauncherSettings.Favorites.CONTAINER_DESKTOP ||</span><br><span class="line">                        item.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœæ˜¯æ¡Œé¢æˆ–è€… HotSeat åŒºåŸŸï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ° workspaceItems</span></span><br><span class="line">                    workspaceItems.add(item);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœ item åº”æ·»åŠ åˆ°æ–‡ä»¶å¤¹å†…éƒ¨ï¼Œå…ˆæ£€æŸ¥è¯¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">                    <span class="keyword">if</span> (newItem) &#123;</span><br><span class="line">                        <span class="comment">// è‹¥æ˜¯æ–° item ä¸”æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œè®°å½•é”™è¯¯æ—¥å¿—ï¼Œè¡¨æ˜å°è¯•æ·»åŠ åˆ°ä¸å­˜åœ¨çš„æ–‡ä»¶å¤¹</span></span><br><span class="line">                        <span class="keyword">if</span> (!folders.containsKey(item.container)) &#123;</span><br><span class="line">                            <span class="comment">// Adding an item to a nonexistent collection.</span></span><br><span class="line">                            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;attempted to add item: &quot;</span> + item + <span class="string">&quot; to a nonexistent app&quot;</span></span><br><span class="line">                                    + <span class="string">&quot; collection&quot;</span>;</span><br><span class="line">                            Log.e(TAG, msg);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// è‹¥æ–‡ä»¶å¤¹å­˜åœ¨ï¼Œè°ƒç”¨ findOrMakeFolder æ–¹æ³•è·å–æ–‡ä»¶å¤¹ï¼Œå¹¶å°†é¡¹ç›®æ·»åŠ åˆ°è¯¥æ–‡ä»¶å¤¹</span></span><br><span class="line">                        findOrMakeFolder(item.container).add((WorkspaceItemInfo) item, <span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPWIDGET:          <span class="comment">// å°éƒ¨ä»¶</span></span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_CUSTOM_APPWIDGET:   <span class="comment">// è‡ªå®šä¹‰å°éƒ¨ä»¶</span></span><br><span class="line">                <span class="comment">// å¼ºåˆ¶è½¬æ¢ä¸º LauncherAppWidgetInfo ç±»å‹ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° appWidgets é›†åˆ</span></span><br><span class="line">                appWidgets.add((LauncherAppWidgetInfo) item);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœ item æ˜¯æ–°æ·»åŠ çš„æ·±å±‚å¿«æ·æ–¹å¼ï¼Œè°ƒç”¨ updateShortcutPinnedState æ–¹æ³•æ›´æ–°å¿«æ·æ–¹å¼çš„å›ºå®šçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (newItem &amp;&amp; item.itemType == LauncherSettings.Favorites.ITEM_TYPE_DEEP_SHORTCUT) &#123;</span><br><span class="line">            <span class="comment">// è¯¥æ–¹æ³•ä½¿ç”¨ä¸Šä¸‹æ–‡å’Œç”¨æˆ·ä¿¡æ¯æ›´æ–°å¿«æ·æ–¹å¼çš„å›ºå®šçŠ¶æ€ï¼ˆPinned çŠ¶æ€ï¼‰</span></span><br><span class="line">            updateShortcutPinnedState(context, item.user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ–‡ä»¶å¤¹"><a href="#æ–‡ä»¶å¤¹" class="headerlink" title="æ–‡ä»¶å¤¹"></a>æ–‡ä»¶å¤¹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processWorkspaceItem</span><span class="params">(LoaderCursor c,</span></span><br><span class="line"><span class="params">            LoaderMemoryLogger memoryLogger,</span></span><br><span class="line"><span class="params">            HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSdCardReady,</span></span><br><span class="line"><span class="params">            PackageUserKey tempPackageKey,</span></span><br><span class="line"><span class="params">            WidgetManagerHelper widgetHelper,</span></span><br><span class="line"><span class="params">            PackageManagerHelper pmHelper,</span></span><br><span class="line"><span class="params">            List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos,</span></span><br><span class="line"><span class="params">            LongSparseArray&lt;Boolean&gt; unlockedUsers,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSafeMode,</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (c.itemType) &#123;</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_SHORTCUT:        <span class="comment">// å¦‚æœæ˜¯å¿«æ·æ–¹å¼</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPLICATION:     <span class="comment">// å¦‚æœæ˜¯åº”ç”¨ç¨‹åº</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_DEEP_SHORTCUT:   <span class="comment">// å¦‚æœæ˜¯æ·±å±‚å¿«æ·æ–¹å¼</span></span><br><span class="line">                     ... <span class="comment">// åº”ç”¨/å¿«æ·æ–¹å¼å¤„ç†é€»è¾‘</span></span><br><span class="line">                ----------------------------------------------------------------------</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_FOLDER:          <span class="comment">// å¦‚æœæ˜¯æ–‡ä»¶å¤¹ç±»å‹</span></span><br><span class="line">                    <span class="comment">// ä»åå°æ•°æ®æ¨¡å‹ä¸­æŸ¥æ‰¾æˆ–åˆ›å»ºæ–‡ä»¶å¤¹ä¿¡æ¯å¯¹è±¡</span></span><br><span class="line">                    <span class="type">FolderInfo</span> <span class="variable">folderInfo</span> <span class="operator">=</span> mBgDataModel.findOrMakeFolder(c.id);</span><br><span class="line">                    <span class="comment">// åº”ç”¨é€šç”¨å±æ€§åˆ°æ–‡ä»¶å¤¹ä¿¡æ¯å¯¹è±¡</span></span><br><span class="line">                    c.applyCommonProperties(folderInfo);</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// ä¸è¦ä½¿ç”¨ c.getTitle()ï¼Œå› ä¸ºæ­¤æ–¹æ³•å·²å°†å…¶ç¼“å­˜åœ¨ FolderInfo ä¸­</span></span><br><span class="line">                    folderInfo.title = c.getString(c.mTitleIndex);</span><br><span class="line">                    <span class="comment">// è®¾ç½®æ–‡ä»¶å¤¹åœ¨å·¥ä½œåŒºçš„å ç”¨å®½åº¦å’Œé«˜åº¦ï¼ˆå•ä½æ˜¯æ ¼å­ï¼‰</span></span><br><span class="line">                    folderInfo.spanX = <span class="number">1</span>;</span><br><span class="line">                    folderInfo.spanY = <span class="number">1</span>;</span><br><span class="line">                    <span class="comment">// åº”ç”¨æ–‡ä»¶å¤¹çš„å…¶ä»–é€‰é¡¹</span></span><br><span class="line">                    folderInfo.options = c.getOptions();</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// æ¢å¤æ ‡è®°ä¸ºå·²æ¢å¤ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†æ¢å¤çš„æ–‡ä»¶å¤¹</span></span><br><span class="line">                    c.markRestored();</span><br><span class="line">                    <span class="comment">// æ£€æŸ¥å¹¶æ·»åŠ æ–‡ä»¶å¤¹ä¿¡æ¯åˆ°æ•°æ®æ¨¡å‹ï¼Œå¹¶è®°å½•å†…å­˜ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">                    c.checkAndAddItem(folderInfo, mBgDataModel, memoryLogger);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// ===&gt;&gt;&gt; æ–‡ä»¶å¤¹ç±»å‹å¤„ç†å®Œæ¯•</span></span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Desktop items loading interrupted&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬çœ‹ä¸‹ <code>findOrMakeFolder()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BgDataModel.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BgDataModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> FolderInfo <span class="title function_">findOrMakeFolder</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡ id ä» folders æ˜ å°„ä¸­è·å–å¯¹åº”çš„ FolderInfo å¯¹è±¡</span></span><br><span class="line">        <span class="type">FolderInfo</span> <span class="variable">folderInfo</span> <span class="operator">=</span> folders.get(id);</span><br><span class="line">        <span class="keyword">if</span> (folderInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ FolderInfo å®ä¾‹</span></span><br><span class="line">            folderInfo = <span class="keyword">new</span> <span class="title class_">FolderInfo</span>();</span><br><span class="line">            <span class="comment">// æ–°çš„ FolderInfo å®ä¾‹ä»¥ id ä¸ºé”®å­˜å…¥ folders æ˜ å°„ä¸­ï¼Œ</span></span><br><span class="line">            <span class="comment">// ç¡®ä¿ä¸‹æ¬¡è®¿é—®åŒä¸€ id æ—¶å¯ä»¥ç›´æ¥è·å–è¯¥å¯¹è±¡</span></span><br><span class="line">            folders.put(id, folderInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> folderInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Widget"><a href="#Widget" class="headerlink" title="Widget"></a>Widget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processWorkspaceItem</span><span class="params">(LoaderCursor c,</span></span><br><span class="line"><span class="params">            LoaderMemoryLogger memoryLogger,</span></span><br><span class="line"><span class="params">            HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSdCardReady,</span></span><br><span class="line"><span class="params">            PackageUserKey tempPackageKey,</span></span><br><span class="line"><span class="params">            WidgetManagerHelper widgetHelper,</span></span><br><span class="line"><span class="params">            PackageManagerHelper pmHelper,</span></span><br><span class="line"><span class="params">            List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos,</span></span><br><span class="line"><span class="params">            LongSparseArray&lt;Boolean&gt; unlockedUsers,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSafeMode,</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (c.itemType) &#123;</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_SHORTCUT:        <span class="comment">// å¦‚æœæ˜¯å¿«æ·æ–¹å¼</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPLICATION:     <span class="comment">// å¦‚æœæ˜¯åº”ç”¨ç¨‹åº</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_DEEP_SHORTCUT:   <span class="comment">// å¦‚æœæ˜¯æ·±å±‚å¿«æ·æ–¹å¼</span></span><br><span class="line">                    ... <span class="comment">// åº”ç”¨/å¿«æ·æ–¹å¼å¤„ç†é€»è¾‘</span></span><br><span class="line">                ----------------------------------------------------------------------</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_FOLDER:          <span class="comment">// å¦‚æœæ˜¯æ–‡ä»¶å¤¹ç±»å‹</span></span><br><span class="line">                    ... <span class="comment">// æ–‡ä»¶å¤¹ç±»å‹å¤„ç†é€»è¾‘</span></span><br><span class="line">                ----------------------------------------------------------------------</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPWIDGET:       <span class="comment">// å¦‚æœç±»å‹æ˜¯åº”ç”¨å°éƒ¨ä»¶</span></span><br><span class="line">                    <span class="comment">// æ£€æŸ¥æ˜¯å¦ç¦ç”¨æ‰€æœ‰å°éƒ¨ä»¶ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å›</span></span><br><span class="line">                    <span class="keyword">if</span> (WidgetsModel.GO_DISABLE_WIDGETS) &#123;</span><br><span class="line">                        c.markDeleted(<span class="string">&quot;Only legacy shortcuts can have null package&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Follow throughï¼Œç»§ç»­å¤„ç†å…¶ä»–å°éƒ¨ä»¶ç±»å‹</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_CUSTOM_APPWIDGET:  <span class="comment">// å¦‚æœç±»å‹æ˜¯è‡ªå®šä¹‰çš„åº”ç”¨å°éƒ¨ä»¶</span></span><br><span class="line">                    <span class="comment">// è¯»å–æ‰€æœ‰ Launcher ç‰¹å®šçš„å°éƒ¨ä»¶è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">customWidget</span> <span class="operator">=</span> c.itemType</span><br><span class="line">                            == Favorites.ITEM_TYPE_CUSTOM_APPWIDGET;</span><br><span class="line">                    <span class="comment">// è·å–å°éƒ¨ä»¶çš„ ID</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">appWidgetId</span> <span class="operator">=</span> c.getAppWidgetId();</span><br><span class="line">                    <span class="comment">// ä¸ºåº”ç”¨å°éƒ¨ä»¶æ¢å¤è·å– Provider çš„å­—ç¬¦ä¸²</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">savedProvider</span> <span class="operator">=</span> c.getAppWidgetProvider();</span><br><span class="line">                    <span class="keyword">final</span> ComponentName component;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// å¦‚æœé€‰é¡¹ä¸­åŒ…å«æœç´¢å°éƒ¨ä»¶æ ‡å¿—</span></span><br><span class="line">                    <span class="keyword">if</span> ((c.getOptions() &amp; LauncherAppWidgetInfo.OPTION_SEARCH_WIDGET) != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// è·å–æœç´¢å°éƒ¨ä»¶çš„ç»„ä»¶åç§°</span></span><br><span class="line">                        component  = QsbContainerView.getSearchComponentName(mApp.getContext());</span><br><span class="line">                        <span class="keyword">if</span> (component == <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœç»„ä»¶ä¸ºç©ºï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å›</span></span><br><span class="line">                            c.markDeleted(<span class="string">&quot;Discarding SearchWidget without packagename &quot;</span>);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// ä»ä¿å­˜çš„å­—ç¬¦ä¸²ä¸­è§£æç»„ä»¶åç§°</span></span><br><span class="line">                        component = ComponentName.unflattenFromString(savedProvider);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// æ£€æŸ¥å°éƒ¨ä»¶çš„ ID æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isIdValid</span> <span class="operator">=</span></span><br><span class="line">                            !c.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID);</span><br><span class="line">                    <span class="comment">// æ£€æŸ¥å°éƒ¨ä»¶çš„ Provider æ˜¯å¦å·²å‡†å¤‡å¥½</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">wasProviderReady</span> <span class="operator">=</span></span><br><span class="line">                            !c.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY);</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// åˆ›å»ºä¸€ä¸ªåŒ…å«ç»„ä»¶åç§°å’Œç”¨æˆ·çš„ ComponentKey</span></span><br><span class="line">                    <span class="type">ComponentKey</span> <span class="variable">providerKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentKey</span>(component, c.user);</span><br><span class="line">                    <span class="comment">// å¦‚æœ mWidgetProvidersMap ä¸åŒ…å«è¯¥é”®ï¼Œåˆ™æŸ¥æ‰¾å¹¶æ·»åŠ å°éƒ¨ä»¶ Provider</span></span><br><span class="line">                    <span class="keyword">if</span> (!mWidgetProvidersMap.containsKey(providerKey)) &#123;</span><br><span class="line">                        mWidgetProvidersMap.put(providerKey,</span><br><span class="line">                                widgetHelper.findProvider(component, c.user));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// ä» mWidgetProvidersMap ä¸­è·å–å°éƒ¨ä»¶ Provider ä¿¡æ¯</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">AppWidgetProviderInfo</span> <span class="variable">provider</span> <span class="operator">=</span> mWidgetProvidersMap.get(providerKey);</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// æ£€æŸ¥å°éƒ¨ä»¶ Provider æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isProviderReady</span> <span class="operator">=</span> isValidProvider(provider);</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸æ˜¯å®‰å…¨æ¨¡å¼ã€ä¸æ˜¯è‡ªå®šä¹‰å°éƒ¨ä»¶ã€å°éƒ¨ä»¶ Provider æ›¾ç»å‡†å¤‡å¥½ä½†ç°åœ¨ä¸å†å‡†å¤‡å¥½</span></span><br><span class="line">                    <span class="keyword">if</span> (!isSafeMode &amp;&amp; !customWidget &amp;&amp; wasProviderReady &amp;&amp; !isProviderReady) &#123;</span><br><span class="line">                        <span class="comment">// æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å›</span></span><br><span class="line">                        c.markDeleted(<span class="string">&quot;Deleting widget that isn&#x27;t installed anymore: &quot;</span> + provider);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// å¤„ç†å°éƒ¨ä»¶æ¢å¤çŠ¶æ€</span></span><br><span class="line">                        LauncherAppWidgetInfo appWidgetInfo;</span><br><span class="line">                        <span class="keyword">if</span> (isProviderReady) &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœå°éƒ¨ä»¶ Provider å‡†å¤‡å¥½ï¼Œåˆ™åˆ›å»ºå°éƒ¨ä»¶ä¿¡æ¯</span></span><br><span class="line">                            appWidgetInfo =</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">LauncherAppWidgetInfo</span>(appWidgetId, provider.provider);</span><br><span class="line">    </span><br><span class="line">                            <span class="comment">// Provider å¯ç”¨ï¼Œå°éƒ¨ä»¶è¦ä¹ˆå¯ç”¨ï¼Œè¦ä¹ˆä¸å¯ç”¨ï¼Œä¸éœ€è¦è·Ÿè¸ªæœªæ¥çš„æ¢å¤æ›´æ–°</span></span><br><span class="line">                            <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> c.restoreFlag</span><br><span class="line">                                    &amp; ~LauncherAppWidgetInfo.FLAG_RESTORE_STARTED</span><br><span class="line">                                    &amp; ~LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY;</span><br><span class="line">                            <span class="keyword">if</span> (!wasProviderReady) &#123;</span><br><span class="line">                                <span class="comment">// å¦‚æœ Provider ä¹‹å‰æœªå‡†å¤‡å¥½ï¼Œåˆ™æ›´æ–°çŠ¶æ€å’Œ UI æ ‡å¿—</span></span><br><span class="line">                                <span class="keyword">if</span> (isIdValid) &#123;</span><br><span class="line">                                    status |= LauncherAppWidgetInfo.FLAG_UI_NOT_READY;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            appWidgetInfo.restoreStatus = status;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœ Provider ä¸å¯ç”¨ï¼Œè®°å½•æ¢å¤çŠ¶æ€å¹¶åˆ›å»ºå°éƒ¨ä»¶ä¿¡æ¯</span></span><br><span class="line">                            Log.v(TAG, <span class="string">&quot;Widget restore pending id=&quot;</span> + c.id</span><br><span class="line">                                    + <span class="string">&quot; appWidgetId=&quot;</span> + appWidgetId</span><br><span class="line">                                    + <span class="string">&quot; status =&quot;</span> + c.restoreFlag);</span><br><span class="line">                            appWidgetInfo = <span class="keyword">new</span> <span class="title class_">LauncherAppWidgetInfo</span>(appWidgetId, component);</span><br><span class="line">                            appWidgetInfo.restoreStatus = c.restoreFlag;</span><br><span class="line">    </span><br><span class="line">                            <span class="comment">// æ›´æ–°ä¸´æ—¶åŒ…é”®å¹¶è·å–å®‰è£…è¿›åº¦</span></span><br><span class="line">                            tempPackageKey.update(component.getPackageName(), c.user);</span><br><span class="line">                            <span class="type">SessionInfo</span> <span class="variable">si</span> <span class="operator">=</span> installingPkgs.get(tempPackageKey);</span><br><span class="line">                            <span class="type">Integer</span> <span class="variable">installProgress</span> <span class="operator">=</span> si == <span class="literal">null</span></span><br><span class="line">                                    ? <span class="literal">null</span></span><br><span class="line">                                    : (<span class="type">int</span>) (si.getProgress() * <span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">                            <span class="keyword">if</span> (c.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_RESTORE_STARTED)) &#123;</span><br><span class="line">                                <span class="comment">// æ¢å¤å·²ç»å¼€å§‹ä¸€æ¬¡</span></span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installProgress != <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// åº”ç”¨æ¢å¤å·²ç»å¼€å§‹ï¼Œæ›´æ–°æ ‡å¿—</span></span><br><span class="line">                                appWidgetInfo.restoreStatus</span><br><span class="line">                                        |= LauncherAppWidgetInfo.FLAG_RESTORE_STARTED;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isSafeMode) &#123;</span><br><span class="line">                                <span class="comment">// å¦‚æœä¸æ˜¯å®‰å…¨æ¨¡å¼ï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å›</span></span><br><span class="line">                                c.markDeleted(<span class="string">&quot;Unrestored widget removed: &quot;</span> + component);</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">    </span><br><span class="line">                            <span class="comment">// è®¾ç½®å®‰è£…è¿›åº¦</span></span><br><span class="line">                            appWidgetInfo.installProgress =</span><br><span class="line">                                    installProgress == <span class="literal">null</span> ? <span class="number">0</span> : installProgress;</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// å¦‚æœæ¢å¤æ ‡å¿—åŒ…å«ç›´æ¥é…ç½®æ ‡å¿—ï¼Œåˆ™è®¾ç½®ç»‘å®šé€‰é¡¹</span></span><br><span class="line">                        <span class="keyword">if</span> (appWidgetInfo.hasRestoreFlag(</span><br><span class="line">                                LauncherAppWidgetInfo.FLAG_DIRECT_CONFIG)) &#123;</span><br><span class="line">                            appWidgetInfo.bindOptions = c.parseIntent();</span><br><span class="line">                        &#125;</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// åº”ç”¨é€šç”¨å±æ€§åˆ°å°éƒ¨ä»¶ä¿¡æ¯</span></span><br><span class="line">                        c.applyCommonProperties(appWidgetInfo);</span><br><span class="line">                        <span class="comment">// è®¾ç½®å°éƒ¨ä»¶çš„å ç”¨æ ¼å­æ•°é‡</span></span><br><span class="line">                        appWidgetInfo.spanX = c.getSpanX();</span><br><span class="line">                        appWidgetInfo.spanY = c.getSpanY();</span><br><span class="line">                        <span class="comment">// è®¾ç½®å°éƒ¨ä»¶çš„é€‰é¡¹</span></span><br><span class="line">                        appWidgetInfo.options = c.getOptions();</span><br><span class="line">                        <span class="comment">// è®¾ç½®ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">                        appWidgetInfo.user = c.user;</span><br><span class="line">                        <span class="comment">// è®¾ç½®å°éƒ¨ä»¶çš„æ¥æºå®¹å™¨</span></span><br><span class="line">                        appWidgetInfo.sourceContainer = c.getAppWidgetSource();</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// å¦‚æœå°éƒ¨ä»¶çš„å¤§å°æ— æ•ˆï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å›</span></span><br><span class="line">                        <span class="keyword">if</span> (appWidgetInfo.spanX &lt;= <span class="number">0</span> || appWidgetInfo.spanY &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            c.markDeleted(<span class="string">&quot;Widget has invalid size: &quot;</span></span><br><span class="line">                                    + appWidgetInfo.spanX + <span class="string">&quot;x&quot;</span> + appWidgetInfo.spanY);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// è·å–å°éƒ¨ä»¶ Provider çš„ä¿¡æ¯å¹¶æ£€æŸ¥å…¶æœ€å°å°ºå¯¸è¦æ±‚</span></span><br><span class="line">                        <span class="type">LauncherAppWidgetProviderInfo</span> <span class="variable">widgetProviderInfo</span> <span class="operator">=</span></span><br><span class="line">                                widgetHelper.getLauncherAppWidgetInfo(appWidgetId);</span><br><span class="line">                        <span class="keyword">if</span> (widgetProviderInfo != <span class="literal">null</span></span><br><span class="line">                                &amp;&amp; (appWidgetInfo.spanX &lt; widgetProviderInfo.minSpanX</span><br><span class="line">                                || appWidgetInfo.spanY &lt; widgetProviderInfo.minSpanY)) &#123;</span><br><span class="line">                            FileLog.d(TAG, <span class="string">&quot;Widget &quot;</span> + widgetProviderInfo.getComponent()</span><br><span class="line">                                    + <span class="string">&quot; minSizes not meet: span=&quot;</span> + appWidgetInfo.spanX</span><br><span class="line">                                    + <span class="string">&quot;x&quot;</span> + appWidgetInfo.spanY + <span class="string">&quot; minSpan=&quot;</span></span><br><span class="line">                                    + widgetProviderInfo.minSpanX + <span class="string">&quot;x&quot;</span></span><br><span class="line">                                    + widgetProviderInfo.minSpanY);</span><br><span class="line">                            logWidgetInfo(mApp.getInvariantDeviceProfile(),</span><br><span class="line">                                    widgetProviderInfo);</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// å¦‚æœå°éƒ¨ä»¶ä¸åœ¨å·¥ä½œåŒºæˆ– HotSeat ä¸­ï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å›</span></span><br><span class="line">                        <span class="keyword">if</span> (!c.isOnWorkspaceOrHotseat()) &#123;</span><br><span class="line">                            c.markDeleted(<span class="string">&quot;Widget found where container != CONTAINER_DESKTOP&quot;</span></span><br><span class="line">                                    + <span class="string">&quot;nor CONTAINER_HOTSEAT - ignoring!&quot;</span>);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// å¦‚æœä¸æ˜¯è‡ªå®šä¹‰å°éƒ¨ä»¶ï¼Œæ£€æŸ¥ Provider åç§°æ˜¯å¦åŒ¹é…ï¼Œæ›´æ–°çŠ¶æ€</span></span><br><span class="line">                        <span class="keyword">if</span> (!customWidget) &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">providerName</span> <span class="operator">=</span> appWidgetInfo.providerName.flattenToString();</span><br><span class="line">                            <span class="keyword">if</span> (!providerName.equals(savedProvider)</span><br><span class="line">                                    || (appWidgetInfo.restoreStatus != c.restoreFlag)) &#123;</span><br><span class="line">                                c.updater()</span><br><span class="line">                                        .put(Favorites.APPWIDGET_PROVIDER,</span><br><span class="line">                                                providerName)</span><br><span class="line">                                        .put(Favorites.RESTORED,</span><br><span class="line">                                                appWidgetInfo.restoreStatus)</span><br><span class="line">                                        .commit();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// å¦‚æœæ¢å¤çŠ¶æ€ä¸æ˜¯å®Œæˆï¼Œåˆ™åˆ›å»ºå¾…å¤„ç†çš„å°éƒ¨ä»¶ä¿¡æ¯å¹¶è·å–æ ‡é¢˜å’Œå›¾æ ‡</span></span><br><span class="line">                        <span class="keyword">if</span> (appWidgetInfo.restoreStatus</span><br><span class="line">                                != LauncherAppWidgetInfo.RESTORE_COMPLETED) &#123;</span><br><span class="line">                            appWidgetInfo.pendingItemInfo = WidgetsModel.newPendingItemInfo(</span><br><span class="line">                                    mApp.getContext(),</span><br><span class="line">                                    appWidgetInfo.providerName,</span><br><span class="line">                                    appWidgetInfo.user);</span><br><span class="line">                            mIconCache.getTitleAndIconForApp(</span><br><span class="line">                                    appWidgetInfo.pendingItemInfo, <span class="literal">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// æ£€æŸ¥å¹¶æ·»åŠ å°éƒ¨ä»¶ä¿¡æ¯åˆ°æ•°æ®æ¨¡å‹ä¸­</span></span><br><span class="line">                        c.checkAndAddItem(appWidgetInfo, mBgDataModel);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Desktop items loading interrupted&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œ<font color="#085DFF">loadWorkspace()</font> çš„å·¥ä½œç®—æ˜¯åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ç»‘å®šçš„æµç¨‹ï¼</p>
<hr>
<h1 id="ç»‘å®š-Workspace-æµç¨‹è§£æ"><a href="#ç»‘å®š-Workspace-æµç¨‹è§£æ" class="headerlink" title="ç»‘å®š Workspace æµç¨‹è§£æ"></a>ç»‘å®š Workspace æµç¨‹è§£æ</h1><p>ç»‘å®š Workspace æ˜¯é€šè¿‡ <code>LauncherBinder</code> çš„ <font color="#FF8C00">bindWorkspace()</font> å‡½æ•°ï¼Œåœ¨å…¶çˆ¶ç±» <code>BaseLauncherBinder</code> ä¸­å®šä¹‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLauncherBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Binds all loaded data to actual views on the main thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bindWorkspace</span><span class="params">(<span class="type">boolean</span> incrementBindId, <span class="type">boolean</span> isBindSync)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ENABLE_WORKSPACE_LOADING_OPTIMIZATION æ ‡å¿—ä¸»è¦ç”¨äºï¼š</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         *     æ§åˆ¶ä¸€ç³»åˆ—ä¸å·¥ä½œåŒºåŠ è½½è¿‡ç¨‹ç›¸å…³çš„ä¼˜åŒ–æªæ–½ã€‚è¿™äº›ä¼˜åŒ–å¯èƒ½æ¶µç›–äº†åŠ è½½é€Ÿåº¦ã€</span></span><br><span class="line"><span class="comment">         *     å†…å­˜ä½¿ç”¨ã€I/O æ“ä½œç­‰æ–¹é¢çš„æ”¹è¿›ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒã€‚</span></span><br><span class="line"><span class="comment">         *     Log å®æµ‹ä¸º falseï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç•¥è¿‡è¿™ä¸ªæ¡ä»¶åˆ¤æ–­ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (FeatureFlags.ENABLE_WORKSPACE_LOADING_OPTIMIZATION.get()) &#123;</span><br><span class="line">            <span class="type">DisjointWorkspaceBinder</span> <span class="variable">workspaceBinder</span> <span class="operator">=</span></span><br><span class="line">                    initWorkspaceBinder(incrementBindId, mBgDataModel.collectWorkspaceScreens());</span><br><span class="line">            workspaceBinder.bindCurrentWorkspacePages(isBindSync);</span><br><span class="line">            workspaceBinder.bindOtherWorkspacePages();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            bindWorkspaceAllAtOnce(incrementBindId, isBindSync);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ï¼Œç°åœ¨æˆ‘ä»¬ç»§ç»­è·Ÿè¸ª <code>bindWorkspaceAllAtOnce()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLauncherBinder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸€æ¬¡æ€§ç»‘å®šå·¥ä½œåŒºä¸­çš„æ‰€æœ‰é¡¹ç›®ï¼ˆåº”ç”¨å›¾æ ‡ã€å°éƒ¨ä»¶ã€å±å¹•ç­‰ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindWorkspaceAllAtOnce</span><span class="params">(<span class="type">boolean</span> incrementBindId, <span class="type">boolean</span> isBindSync)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * åˆå§‹åŒ–é›†åˆï¼š</span></span><br><span class="line"><span class="comment">         *     workspaceItems  : ç”¨äºå­˜å‚¨å·¥ä½œåŒºä¸­çš„é¡¹ç›®ï¼ˆåº”ç”¨å›¾æ ‡ã€å¿«æ·æ–¹å¼ç­‰ï¼‰</span></span><br><span class="line"><span class="comment">         *     appWidgets      : ç”¨äºå­˜å‚¨å·¥ä½œåŒºä¸­çš„å°éƒ¨ä»¶</span></span><br><span class="line"><span class="comment">         *     orderedScreenIds: ä¿å­˜å·¥ä½œåŒºçš„å±å¹• IDï¼Œç¡®ä¿æ‰€æœ‰ Item æŒ‰å±å¹•é¡ºåºæ’åˆ—</span></span><br><span class="line"><span class="comment">         *     extraItems      : å­˜å‚¨å›ºå®šå®¹å™¨ä¸­çš„é¢å¤–é¡¹ç›®ï¼Œé€šå¸¸æ˜¯ä¸€äº›ç‰¹æ®Šçš„å›ºå®šå…ƒç´ </span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ArrayList&lt;ItemInfo&gt; workspaceItems = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        ArrayList&lt;LauncherAppWidgetInfo&gt; appWidgets = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">IntArray</span> <span class="variable">orderedScreenIds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntArray</span>();</span><br><span class="line">        ArrayList&lt;FixedContainerItems&gt; extraItems = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> workspaceItemCount;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ä»åå°æ•°æ®æ¨¡å‹ä¸­è·å–æ•°æ®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mBgDataModel) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å°† mBgDataModel ä¸­çš„æ‰€æœ‰å·¥ä½œåŒºé¡¹ç›®å¤åˆ¶åˆ° workspaceItems</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            workspaceItems.addAll(mBgDataModel.workspaceItems);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å°†æ‰€æœ‰å°éƒ¨ä»¶å¤åˆ¶åˆ° appWidgets</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            appWidgets.addAll(mBgDataModel.appWidgets);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ä» mBgDataModel ä¸­æ”¶é›†å¹¶æ’åºå±å¹• ID</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            orderedScreenIds.addAll(mBgDataModel.collectWorkspaceScreens());</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å¤åˆ¶å›ºå®šå®¹å™¨ä¸­çš„é¢å¤–é¡¹ç›®</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            mBgDataModel.extraItems.forEach(extraItems::add);</span><br><span class="line">            <span class="keyword">if</span> (incrementBindId) &#123;</span><br><span class="line">                mBgDataModel.lastBindId++;</span><br><span class="line">            &#125;</span><br><span class="line">            mMyBindingId = mBgDataModel.lastBindId;</span><br><span class="line">            workspaceItemCount = mBgDataModel.itemsIdMap.size();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ‰¹é‡ç»‘å®šåˆ°å‰å°</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * éå†å›è°ƒåˆ—è¡¨ mCallbacksListï¼Œå¯¹æ¯ä¸ªå›è°ƒå®ä¾‹æ‰§è¡Œç»‘å®šæ“ä½œ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (Callbacks cb : mCallbacksList) &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»º UnifiedWorkspaceBinder å®ä¾‹å¹¶è°ƒç”¨å…¶ bind æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">UnifiedWorkspaceBinder</span>(cb, mUiExecutor, mApp, mBgDataModel, mMyBindingId,</span><br><span class="line">                    workspaceItems, appWidgets, extraItems, orderedScreenIds)</span><br><span class="line">                    .bind(isBindSync, workspaceItemCount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ä¸­ï¼Œåˆ›å»ºäº† <code>workspaceItems</code>ã€<code>appWidgets</code>ã€<code>orderedScreenIds</code>ï¼ˆå±å¹•æ•°ï¼‰ç­‰ä¿¡æ¯çš„æ•°ç»„ã€‚ç„¶ååˆ›å»º <code>UnifiedWorkspaceBinder</code>ï¼Œè°ƒç”¨å…¶ bind() å‡½æ•°å¼€å§‹ç»‘å®šã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLauncherBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">UnifiedWorkspaceBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æŒ‰é¡ºåºå°†å·¥ä½œåŒºä¸­çš„é¡¹ç›®ç»‘å®šåˆ° UI ä¸Šï¼Œåˆ†æ‰¹åŠ è½½å½“å‰å±å¹•å’Œå…¶ä»–å±å¹•çš„é¡¹ç›®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">boolean</span> isBindSync, <span class="type">int</span> workspaceItemCount)</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * è·å–å½“å‰å±å¹• ID é›†åˆ</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">IntSet</span> <span class="variable">currentScreenIds</span> <span class="operator">=</span></span><br><span class="line">                    mCallbacks.getPagesToBindSynchronously(mOrderedScreenIds);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ä¿è·å–åˆ°çš„å±å¹• ID é›†åˆéç©ºï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            Objects.requireNonNull(currentScreenIds, <span class="string">&quot;Null screen ids provided by &quot;</span> + mCallbacks);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ç­›é€‰å½“å‰å±å¹•çš„é¡¹ç›®ï¼š</span></span><br><span class="line"><span class="comment">             *     currentWorkspaceItems: å½“å‰å±å¹•çš„åº”ç”¨é¡¹ç›®</span></span><br><span class="line"><span class="comment">             *     otherWorkspaceItems  : å…¶ä»–å±å¹•çš„åº”ç”¨é¡¹ç›®</span></span><br><span class="line"><span class="comment">             *     currentAppWidgets    : å½“å‰å±å¹•çš„å°éƒ¨ä»¶</span></span><br><span class="line"><span class="comment">             *     otherAppWidgets      : å…¶ä»–å±å¹•çš„å°éƒ¨ä»¶</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ArrayList&lt;ItemInfo&gt; currentWorkspaceItems = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            ArrayList&lt;ItemInfo&gt; otherWorkspaceItems = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            ArrayList&lt;LauncherAppWidgetInfo&gt; currentAppWidgets = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            ArrayList&lt;LauncherAppWidgetInfo&gt; otherAppWidgets = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å°† mWorkspaceItems å’Œ mAppWidgets ä¸­çš„é¡¹ç›®åˆ†æˆå½“å‰å±å¹•å’Œå…¶ä»–å±å¹•çš„ä¸¤éƒ¨åˆ†</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            filterCurrentWorkspaceItems(currentScreenIds, mWorkspaceItems, currentWorkspaceItems,</span><br><span class="line">                    otherWorkspaceItems);</span><br><span class="line">            filterCurrentWorkspaceItems(currentScreenIds, mAppWidgets, currentAppWidgets,</span><br><span class="line">                    otherAppWidgets);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ç©ºé—´æ’åº</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * è·å–è®¾å¤‡é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å±å¹•å¸ƒå±€å’Œç½‘æ ¼ä¿¡æ¯</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">InvariantDeviceProfile</span> <span class="variable">idp</span> <span class="operator">=</span> mApp.getInvariantDeviceProfile();</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å½“å‰å±å¹•å’Œå…¶ä»–å±å¹•çš„é¡¹ç›®åˆ†åˆ«è¿›è¡Œç©ºé—´æ’åºï¼Œç¡®ä¿é¡¹ç›®åœ¨å±å¹•ä¸ŠæŒ‰ä½ç½®æ˜¾ç¤º</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            sortWorkspaceItemsSpatially(idp, currentWorkspaceItems);</span><br><span class="line">            sortWorkspaceItemsSpatially(idp, otherWorkspaceItems);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * é€šçŸ¥ UI å¼€å§‹ç»‘å®š</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            executeCallbacksTask(c -&gt; &#123;</span><br><span class="line">                c.clearPendingBinds();    <span class="comment">// æ¸…é™¤ UI ä¸­å¾…ç»‘å®šçš„é¡¹ç›®ï¼Œå‡†å¤‡æ–°é¡¹ç›®çš„ç»‘å®š</span></span><br><span class="line">                c.startBinding();         <span class="comment">// é€šçŸ¥å›è°ƒå¼€å§‹ç»‘å®šæ“ä½œ</span></span><br><span class="line">            &#125;, mUiExecutor);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ç»‘å®šå±å¹• ID</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            executeCallbacksTask(c -&gt; c.bindScreens(mOrderedScreenIds), mUiExecutor);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å¾€å½“å‰çš„å±å¹•ä¸Šç»‘å®šæ•°æ®å†…å®¹</span></span><br><span class="line"><span class="comment">             *     bindWorkspaceItems : å°†å½“å‰å±å¹•çš„åº”ç”¨é¡¹ç›®ç»‘å®šåˆ° UI</span></span><br><span class="line"><span class="comment">             *     bindAppWidgets     : å°†å½“å‰å±å¹•çš„å°éƒ¨ä»¶ç»‘å®šåˆ° UI</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            bindWorkspaceItems(currentWorkspaceItems, mUiExecutor);</span><br><span class="line">            bindAppWidgets(currentAppWidgets, mUiExecutor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ç»‘å®šé¢å¤–å®¹å™¨ä¸­çš„é¡¹ç›®</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (!FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) &#123;</span><br><span class="line">                mExtraItems.forEach(item -&gt;</span><br><span class="line">                        executeCallbacksTask(c -&gt; c.bindExtraContainerItems(item), mUiExecutor));</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * åŠ è½½å…¶ä»–å±å¹•çš„é¡¹ç›®</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * åˆ›å»ºä¸€ä¸ª RunnableList ç”¨äºæ”¶é›†å…¶ä»–å±å¹•çš„é¡¹ç›®ç»‘å®šä»»åŠ¡ï¼Œå°†ä»»åŠ¡æ·»åŠ åˆ° pendingTasks åˆ—è¡¨</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">RunnableList</span> <span class="variable">pendingTasks</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RunnableList</span>();</span><br><span class="line">            <span class="type">Executor</span> <span class="variable">pendingExecutor</span> <span class="operator">=</span> pendingTasks::add;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å°†å…¶ä»–å±å¹•çš„åº”ç”¨é¡¹ç›®å’Œå°éƒ¨ä»¶ç»‘å®šåˆ°å¾…æ‰§è¡Œåˆ—è¡¨ï¼Œå»¶åæ˜¾ç¤º</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            bindWorkspaceItems(otherWorkspaceItems, pendingExecutor);</span><br><span class="line">            bindAppWidgets(otherAppWidgets, pendingExecutor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * åœ¨å…¶ä»–å±å¹•çš„é¡¹ç›®åŠ è½½å®Œæˆåï¼Œé€šçŸ¥ UI ç»‘å®šå·²å®Œæˆ</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            executeCallbacksTask(c -&gt; c.finishBindingItems(currentScreenIds), pendingExecutor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ‰§è¡Œå¼‚æ­¥åŠ è½½å®Œæˆæ“ä½œ</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            pendingExecutor.execute(</span><br><span class="line">                    () -&gt; &#123;</span><br><span class="line">                        MODEL_EXECUTOR.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT);</span><br><span class="line">                        ItemInstallQueue.INSTANCE.get(mApp.getContext())</span><br><span class="line">                                .resumeModelPush(FLAG_LOADER_RUNNING);</span><br><span class="line">                    &#125;);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å›è°ƒåˆå§‹ç»‘å®šå®Œæˆäº‹ä»¶</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            executeCallbacksTask(</span><br><span class="line">                    c -&gt; &#123;</span><br><span class="line">                        MODEL_EXECUTOR.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">                        c.onInitialBindComplete(</span><br><span class="line">                                currentScreenIds, pendingTasks, workspaceItemCount, isBindSync);</span><br><span class="line">                    &#125;, mUiExecutor);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ç»‘å®šå­—ç¬¦ä¸²ç¼“å­˜</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            mCallbacks.bindStringCache(mBgDataModel.stringCache.clone());</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UnifiedWorkspaceBinder</code> çš„ <code>bind()</code> å‡½æ•°ä¸­ï¼Œé¦–å…ˆæ‹¿åˆ°å½“å‰å±å¹•ï¼ˆå°±æ˜¯å‘ˆç°ç»™ç”¨æˆ·çš„ç¬¬ä¸€ä¸ªå±å¹•ï¼‰IDï¼Œç„¶åä¼˜å…ˆå¾€ç¬¬ä¸€ä¸ªå±å¹•ä¸Šç»‘å®šå†…å®¹ï¼Œä¹‹åå†ç»‘å®šå…¶ä»–å±å¹•çš„å†…å®¹ã€‚</p>
<h2 id="ç»‘å®šå±å¹•"><a href="#ç»‘å®šå±å¹•" class="headerlink" title="ç»‘å®šå±å¹•"></a>ç»‘å®šå±å¹•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Launcher.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Launcher</span> <span class="keyword">extends</span> <span class="title class_">StatefulActivity</span>&lt;LauncherState&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LauncherExterns</span>, Callbacks, InvariantDeviceProfile.OnIDPChangeListener,</span><br><span class="line">        PluginListener&lt;LauncherOverlayPlugin&gt; &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bindScreens</span><span class="params">(IntArray orderedScreenIds)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ä¹‰ç¬¬ä¸€ä¸ªå±å¹•çš„ä½ç½®ç´¢å¼•ï¼Œé€šå¸¸ä¸º 0</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">firstScreenPosition</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è°ƒæ•´é¦–å±ï¼ˆé»˜è®¤å±å¹•ï¼‰çš„ä½ç½®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (FeatureFlags.QSB_ON_FIRST_SCREEN &amp;&amp;</span><br><span class="line">                orderedScreenIds.indexOf(Workspace.FIRST_SCREEN_ID) != firstScreenPosition) &#123;</span><br><span class="line">            <span class="comment">// è¿™ä¸€æ“ä½œç¡®ä¿åœ¨å¯ç”¨äº† QSB_ON_FIRST_SCREEN (Google Search æ¡†)çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤å±å¹•å§‹ç»ˆä½äºç¬¬ä¸€ä¸ªä½ç½®</span></span><br><span class="line">            orderedScreenIds.removeValue(Workspace.FIRST_SCREEN_ID);</span><br><span class="line">            orderedScreenIds.add(firstScreenPosition, Workspace.FIRST_SCREEN_ID);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!FeatureFlags.QSB_ON_FIRST_SCREEN &amp;&amp; orderedScreenIds.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœç‰¹æ€§æœªå¯ç”¨ä¸”æ²¡æœ‰ä»»ä½•å±å¹•ï¼Œåˆ™æ·»åŠ ä¸€ä¸ªç©ºå±å¹•</span></span><br><span class="line">            mWorkspace.addExtraEmptyScreens();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å°† orderedScreenIds ç»‘å®šåˆ°å·¥ä½œåŒºï¼Œè¿™ä¸€æ­¥ä¼šå°†å±å¹• ID åˆ—è¡¨æ­£å¼æ·»åŠ åˆ° UI ä¸­ï¼Œä½¿è¿™äº›å±å¹•å‡ºç°åœ¨å·¥ä½œåŒº</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        bindAddScreens(orderedScreenIds);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è§£é”å£çº¸åç§»é”å®šï¼Œç¡®ä¿å±å¹•å¸ƒå±€åå£çº¸ä½ç½®æ­£ç¡®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mWorkspace.unlockWallpaperFromDefaultPageOnNextLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç»§ç»­è·Ÿè¸ª Launcher.bindAddScreens() æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Launcher.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Launcher</span> <span class="keyword">extends</span> <span class="title class_">StatefulActivity</span>&lt;LauncherState&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LauncherExterns</span>, Callbacks, InvariantDeviceProfile.OnIDPChangeListener,</span><br><span class="line">        PluginListener&lt;LauncherOverlayPlugin&gt; &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindAddScreens</span><span class="params">(IntArray orderedScreenIds)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ£€æŸ¥è®¾å¤‡é…ç½® mDeviceProfile æ˜¯å¦å¯ç”¨äº†åŒé¢æ¿æ¨¡å¼ï¼ˆä¾‹å¦‚å¹³æ¿æˆ–å¤§å±æ‰‹æœºåœ¨æ¨ªå±æ¨¡å¼ä¸‹æ˜¾ç¤ºå·¦å³åˆ†å±ï¼‰</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * è¿™é‡Œæˆ‘ä»¬å¯ä»¥æš‚æ—¶ä¸ç”¨å…³æ³¨</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mDeviceProfile.isTwoPanels) &#123;</span><br><span class="line">            <span class="comment">// Some empty pages might have been removed while the phone was in a single panel</span></span><br><span class="line">            <span class="comment">// mode, so we want to add those empty pages back.</span></span><br><span class="line">            <span class="type">IntSet</span> <span class="variable">screenIds</span> <span class="operator">=</span> IntSet.wrap(orderedScreenIds);</span><br><span class="line">            orderedScreenIds.forEach(screenId -&gt; screenIds.add(mWorkspace.getScreenPair(screenId)));</span><br><span class="line">            orderedScreenIds = screenIds.getArray();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è·å–å±å¹• ID åˆ—è¡¨çš„æ€»æ•°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> orderedScreenIds.size();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * éå† orderedScreenIds ä¸­çš„æ¯ä¸ªå±å¹• IDï¼Œä¾æ¬¡è¿›è¡Œç»‘å®šå¤„ç†</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">screenId</span> <span class="operator">=</span> orderedScreenIds.get(i);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å¦‚æœ QSB_ON_FIRST_SCREEN ç‰¹æ€§å¯ç”¨ï¼Œå¹¶ä¸”å½“å‰å±å¹• ID ä¸ºé»˜è®¤é¦–å± IDï¼Œåˆ™è·³è¿‡ç»‘å®š</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * åŸå› ï¼šé»˜è®¤é¦–å±åœ¨åˆå§‹åŒ–æ—¶é€šå¸¸å·²ç»ç»‘å®šï¼Œå› æ­¤æ— éœ€é‡å¤ç»‘å®šï¼ŒèŠ‚çœæ€§èƒ½å¼€é”€</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (FeatureFlags.QSB_ON_FIRST_SCREEN &amp;&amp; screenId == Workspace.FIRST_SCREEN_ID) &#123;</span><br><span class="line">                <span class="comment">// No need to bind the first screen, as its always bound.</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ’å…¥æ–°çš„å±å¹•</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * å¯¹äºæœªè·³è¿‡çš„å±å¹• IDï¼Œå°†å±å¹•æ’å…¥åˆ°ç©ºå±ä¹‹å‰ã€‚è¿™ç¡®ä¿å±å¹•åˆ—è¡¨çš„æœ‰åºæ˜¾ç¤ºï¼Œä¸”ç©ºå±åœ¨å±å¹•åºåˆ—çš„æœ€åæ˜¾ç¤ºã€‚</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            mWorkspace.insertNewWorkspaceScreenBeforeEmptyScreen(screenId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­è·Ÿè¸ª Workspace.insertNewWorkspaceScreenBeforeEmptyScreen() æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Workspace.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Workspace</span>&lt;T <span class="keyword">extends</span> <span class="title class_">View</span> &amp; PageIndicator&gt; <span class="keyword">extends</span> <span class="title class_">PagedView</span>&lt;T&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">DropTarget</span>, DragSource, View.OnTouchListener,</span><br><span class="line">        DragController.DragListener, Insettable, StateHandler&lt;LauncherState&gt;,</span><br><span class="line">        WorkspaceLayoutManager, LauncherBindableItemsContainer, LauncherOverlayCallbacks &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†æ–°å±å¹•æ’å…¥åˆ°ç©ºå±ï¼ˆå¦‚æœå­˜åœ¨ç©ºå±ï¼‰ä¹‹å‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertNewWorkspaceScreenBeforeEmptyScreen</span><span class="params">(<span class="type">int</span> screenId)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * é¦–å…ˆæŸ¥æ‰¾ EXTRA_EMPTY_SCREEN_ID åœ¨ mScreenOrder ä¸­çš„ä½ç½®</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * mScreenOrder ç»´æŠ¤äº†å½“å‰å±å¹•çš„é¡ºåº</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insertIndex</span> <span class="operator">=</span> mScreenOrder.indexOf(EXTRA_EMPTY_SCREEN_ID);</span><br><span class="line">        <span class="keyword">if</span> (insertIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å¦‚æœæœªæ‰¾åˆ°ç©ºå±ï¼Œè¡¨ç¤ºå°†æ–°å±å¹•æ’å…¥åˆ°æœ€å</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            insertIndex = mScreenOrder.size();</span><br><span class="line">        &#125;</span><br><span class="line">        insertNewWorkspaceScreen(screenId, insertIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¸ª Workspace.insertNewWorkspaceScreen() æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Workspace.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Workspace</span>&lt;T <span class="keyword">extends</span> <span class="title class_">View</span> &amp; PageIndicator&gt; <span class="keyword">extends</span> <span class="title class_">PagedView</span>&lt;T&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">DropTarget</span>, DragSource, View.OnTouchListener,</span><br><span class="line">        DragController.DragListener, Insettable, StateHandler&lt;LauncherState&gt;,</span><br><span class="line">        WorkspaceLayoutManager, LauncherBindableItemsContainer, LauncherOverlayCallbacks &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è´Ÿè´£å®é™…çš„å±å¹•å¸ƒå±€åˆ›å»ºå’Œæ’å…¥æ“ä½œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CellLayout <span class="title function_">insertNewWorkspaceScreen</span><span class="params">(<span class="type">int</span> screenId, <span class="type">int</span> insertIndex)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ£€æŸ¥å±å¹•æ˜¯å¦å·²å­˜åœ¨</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * å¦‚æœ mWorkspaceScreens ä¸­å·²ç»å­˜åœ¨ç›¸åŒçš„ screenIdï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…é‡å¤æ’å…¥ç›¸åŒ ID çš„å±å¹•</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mWorkspaceScreens.containsKey(screenId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Screen id &quot;</span> + screenId + <span class="string">&quot; already exists!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è·å–è®¾å¤‡é…ç½® DeviceProfileï¼Œç”¨äºå†³å®šå¸ƒå±€æ–‡ä»¶çš„é€‰æ‹©</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">DeviceProfile</span> <span class="variable">dp</span> <span class="operator">=</span> mLauncher.getDeviceProfile();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å®šä¹‰æ–°çš„ CellLayout å®ä¾‹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        CellLayout newScreen;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * é€‰æ‹©å¸ƒå±€æ–‡ä»¶ï¼Œæ ¹æ®ç‰¹æ€§æ ‡å¿— FOLDABLE_SINGLE_PAGE å’Œè®¾å¤‡æ˜¯å¦ä¸ºåŒé¢æ¿æ¨¡å¼é€‰æ‹©å¸ƒå±€æ–‡ä»¶</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         *     æŠ˜å è®¾å¤‡ï¼šå¦‚æœä¸ºæŠ˜å å±è®¾å¤‡å¹¶å¤„äºåŒé¢æ¿æ¨¡å¼ï¼Œä½¿ç”¨ R.layout.workspace_screen_foldable å¸ƒå±€æ–‡ä»¶</span></span><br><span class="line"><span class="comment">         *     æ™®é€šè®¾å¤‡ï¼šå¦åˆ™ä½¿ç”¨æ ‡å‡†å¸ƒå±€æ–‡ä»¶ R.layout.workspace_screen</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (FOLDABLE_SINGLE_PAGE.get() &amp;&amp; dp.isTwoPanels) &#123;</span><br><span class="line">            newScreen = (CellLayout) LayoutInflater.from(getContext()).inflate(</span><br><span class="line">                    R.layout.workspace_screen_foldable, <span class="built_in">this</span>, <span class="literal">false</span> <span class="comment">/* attachToRoot */</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            newScreen = (CellLayout) LayoutInflater.from(getContext()).inflate(</span><br><span class="line">                    R.layout.workspace_screen, <span class="built_in">this</span>, <span class="literal">false</span> <span class="comment">/* attachToRoot */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å°†æ–°åˆ›å»ºçš„ CellLayout ä»¥ screenId ä¸ºé”®æ·»åŠ åˆ° mWorkspaceScreens æ˜ å°„ä¸­</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mWorkspaceScreens.put(screenId, newScreen);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å°† screenId æŒ‰é¡ºåºæ’å…¥ mScreenOrder ä¸­ï¼Œä»¥ç»´æŠ¤æ­£ç¡®çš„å±å¹•é¡ºåº</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mScreenOrder.add(insertIndex, screenId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å°†æ–°å±å¹•å¸ƒå±€è§†å›¾æ’å…¥åˆ° Workspace è§†å›¾çš„ insertIndex ä½ç½®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        addView(newScreen, insertIndex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ ¹æ®å½“å‰çŠ¶æ€ä¸ºæ–°å±å¹•åº”ç”¨è¿‡æ¸¡åŠ¨ç”»ï¼Œç¡®ä¿æ–°å±å¹•ä»¥æ­£ç¡®çš„åŠ¨ç”»æ•ˆæœå‡ºç°åœ¨å·¥ä½œåŒºä¸­</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mStateTransitionAnimation.applyChildState(</span><br><span class="line">                mLauncher.getStateManager().getState(), newScreen, insertIndex);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ›´æ–°é¡µé¢æ»šåŠ¨å€¼ï¼Œä½¿å¾—é¡µé¢æ»šåŠ¨æ•ˆæœé€‚åº”æ–°å¸ƒå±€</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        updatePageScrollValues();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ•´æ–°å¸ƒå±€çš„å¡«å……ï¼ˆpaddingï¼‰ï¼Œç¡®ä¿å¸ƒå±€ä¹‹é—´çš„é—´è·ç»Ÿä¸€</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        updateCellLayoutPadding();</span><br><span class="line">        <span class="keyword">return</span> newScreen;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç»‘å®šæ•°æ®å†…å®¹"><a href="#ç»‘å®šæ•°æ®å†…å®¹" class="headerlink" title="ç»‘å®šæ•°æ®å†…å®¹"></a>ç»‘å®šæ•°æ®å†…å®¹</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLauncherBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">UnifiedWorkspaceBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å°†å·¥ä½œåŒºä¸­çš„é¡¹ç›®åˆ†å—ç»‘å®šåˆ° UI</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindWorkspaceItems</span><span class="params">(</span></span><br><span class="line"><span class="params">                <span class="keyword">final</span> ArrayList&lt;ItemInfo&gt; workspaceItems, <span class="keyword">final</span> Executor executor)</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * è·å– workspaceItems åˆ—è¡¨ä¸­çš„é¡¹ç›®æ€»æ•°</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> workspaceItems.size();</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * åˆ†å—ç»‘å®šé¡¹ç›®</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * ITEMS_CHUNK æ˜¯å—å¤§å°çš„å¸¸é‡ï¼Œç”¨äºå®šä¹‰æ¯æ¬¡ç»‘å®šçš„æœ€å¤§é¡¹ç›®æ•°é‡ï¼Œé»˜è®¤ä¸º 6</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i += ITEMS_CHUNK) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * å—çš„èµ·å§‹ä½ç½®</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> i;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * å½“å‰å—çš„å¤§å°</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">chunkSize</span> <span class="operator">=</span> (i + ITEMS_CHUNK &lt;= count) ? ITEMS_CHUNK : (count - i);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * æ‰§è¡Œç»‘å®šä»»åŠ¡</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                executeCallbacksTask(</span><br><span class="line">                        c -&gt; c.bindItems(workspaceItems.subList(start, start + chunkSize), <span class="literal">false</span>),</span><br><span class="line">                        executor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ Launcher.bindItems() æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Launcher.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Launcher</span> <span class="keyword">extends</span> <span class="title class_">StatefulActivity</span>&lt;LauncherState&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LauncherExterns</span>, Callbacks, InvariantDeviceProfile.OnIDPChangeListener,</span><br><span class="line">        PluginListener&lt;LauncherOverlayPlugin&gt; &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bindItems</span><span class="params">(<span class="keyword">final</span> List&lt;ItemInfo&gt; items, <span class="keyword">final</span> <span class="type">boolean</span> forceAnimateIcons)</span> &#123;</span><br><span class="line">        bindItems(items, forceAnimateIcons, <span class="comment">/* focusFirstItemForAccessibility= */</span> <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bindItems</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> List&lt;ItemInfo&gt; items,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="type">boolean</span> forceAnimateIcons,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="type">boolean</span> focusFirstItemForAccessibility)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç”¨äºå­˜å‚¨æ–° Item çš„åŠ¨ç”»æ•ˆæœ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">final</span> Collection&lt;Animator&gt; bounceAnims = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * åˆ¤æ–­æ˜¯å¦å…è®¸é¡µé¢åˆ‡æ¢åŠ¨ç”»</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">canAnimatePageChange</span> <span class="operator">=</span> canAnimatePageChange();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * workspace        : è·å–å·¥ä½œåŒºå¼•ç”¨ï¼Œä¾¿äºæ“ä½œå±å¹•å’Œå¸ƒå±€</span></span><br><span class="line"><span class="comment">         * newItemsScreenId : ç”¨äºè·Ÿè¸ªæ–°é¡¹ç›®çš„å±å¹• IDï¼Œä»¥ä¾¿åç»­é¡µé¢åˆ‡æ¢</span></span><br><span class="line"><span class="comment">         * newView          : å°†ä¿å­˜ç¬¬ä¸€ä¸ªç»‘å®šçš„è§†å›¾ï¼Œä»¥ä¾¿åœ¨æ— éšœç¢æ¨¡å¼ä¸‹è·å¾—ç„¦ç‚¹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Workspace&lt;?&gt; workspace = mWorkspace;</span><br><span class="line">        <span class="type">int</span> <span class="variable">newItemsScreenId</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> items.size();</span><br><span class="line">        <span class="type">View</span> <span class="variable">newView</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * éå† items åˆ—è¡¨ä¸­çš„æ¯ä¸ª ItemInfo é¡¹ç›®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; end; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ItemInfo</span> <span class="variable">item</span> <span class="operator">=</span> items.get(i);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å¦‚æœé¡¹ç›®å±äº Hotseat å®¹å™¨ï¼Œä½† mHotseat ä¸º nullï¼Œåˆ™è·³è¿‡è¯¥é¡¹ç›®ï¼Œ</span></span><br><span class="line"><span class="comment">             * å› ä¸º Hotseat ä¸ºç©ºæ—¶ä¸èƒ½åŠ è½½è¿™äº›é¡¹ç›®</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (item.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT &amp;&amp;</span><br><span class="line">                    mHotseat == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ ¹æ® item ç±»å‹åˆ›å»ºè§†å›¾</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">final</span> View view;</span><br><span class="line">            <span class="keyword">switch</span> (item.itemType) &#123;</span><br><span class="line">                <span class="comment">// å¿«æ·æ–¹å¼æˆ–åº”ç”¨</span></span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPLICATION:</span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_SHORTCUT:</span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_DEEP_SHORTCUT: &#123;</span><br><span class="line">                    <span class="type">WorkspaceItemInfo</span> <span class="variable">info</span> <span class="operator">=</span> (WorkspaceItemInfo) item;</span><br><span class="line">                    <span class="comment">// åˆ›å»ºå¿«æ·æ–¹å¼è§†å›¾</span></span><br><span class="line">                    view = createShortcut(info);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ–‡ä»¶å¤¹</span></span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_FOLDER: &#123;</span><br><span class="line">                    <span class="comment">// åˆ›å»ºæ–‡ä»¶å¤¹è§†å›¾</span></span><br><span class="line">                    view = FolderIcon.inflateFolderAndIcon(R.layout.folder_icon, <span class="built_in">this</span>,</span><br><span class="line">                            (ViewGroup) workspace.getChildAt(workspace.getCurrentPage()),</span><br><span class="line">                            (FolderInfo) item);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åº”ç”¨å¯¹</span></span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APP_PAIR: &#123;</span><br><span class="line">                    <span class="type">FolderInfo</span> <span class="variable">info</span> <span class="operator">=</span> (FolderInfo) item;</span><br><span class="line">                    <span class="comment">// TODO (jeremysim b/274189428): Create app pair icon</span></span><br><span class="line">                    <span class="comment">// æš‚æœªå®ç°ç»‘å®šé€»è¾‘</span></span><br><span class="line">                    view = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å°éƒ¨ä»¶</span></span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPWIDGET:</span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_CUSTOM_APPWIDGET: &#123;</span><br><span class="line">                    <span class="comment">// ç”Ÿæˆå°éƒ¨ä»¶è§†å›¾</span></span><br><span class="line">                    view = inflateAppWidget((LauncherAppWidgetInfo) item);</span><br><span class="line">                    <span class="keyword">if</span> (view == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å…¶ä»–ç±»å‹å°†æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Invalid Item Type&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ä¸»è¦å¤„ç†ä½ç½®å†²çª</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * presenterPos: æ˜ å°„é¡¹ç›®åœ¨å¸ƒå±€ä¸­çš„ä½ç½®</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">CellPos</span> <span class="variable">presenterPos</span> <span class="operator">=</span> getCellPosMapper().mapModelToPresenter(item);</span><br><span class="line">            <span class="keyword">if</span> (item.container == CONTAINER_DESKTOP) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * æ£€æŸ¥ CellLayout ä¸­çš„ä½ç½®æ˜¯å¦å·²è¢«å ç”¨</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="type">CellLayout</span> <span class="variable">cl</span> <span class="operator">=</span> mWorkspace.getScreenWithId(presenterPos.screenId);</span><br><span class="line">                <span class="keyword">if</span> (cl != <span class="literal">null</span> &amp;&amp; cl.isOccupied(presenterPos.cellX, presenterPos.cellY)) &#123;</span><br><span class="line">                    <span class="type">View</span> <span class="variable">v</span> <span class="operator">=</span> cl.getChildAt(presenterPos.cellX, presenterPos.cellY);</span><br><span class="line">                    <span class="keyword">if</span> (v == <span class="literal">null</span>) &#123;</span><br><span class="line">                        Log.e(TAG, <span class="string">&quot;bindItems failed when removing colliding item=&quot;</span> + item);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">tag</span> <span class="operator">=</span> v.getTag();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">desc</span> <span class="operator">=</span> <span class="string">&quot;Collision while binding workspace item: &quot;</span> + item</span><br><span class="line">                            + <span class="string">&quot;. Collides with &quot;</span> + tag;</span><br><span class="line">                    <span class="keyword">if</span> (FeatureFlags.IS_STUDIO_BUILD) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> (<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(desc));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                         * ä»æ•°æ®åº“åˆ é™¤å†²çªé¡¹ç›®ï¼Œé¿å…é‡å¤æ˜¾ç¤º</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        getModelWriter().deleteItemFromDatabase(item, desc);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å°†é¡¹ç›®è§†å›¾æ·»åŠ åˆ°å·¥ä½œåŒºçš„æŒ‡å®šå±å¹•å’Œä½ç½®</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            workspace.addInScreenFromBind(view, item);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * åŠ¨ç”»å¤„ç†</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * å¦‚æœ forceAnimateIcons ä¸º trueï¼Œä¸ºæ–°æ·»åŠ çš„é¡¹ç›®æ‰§è¡ŒåŠ¨ç”»</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (forceAnimateIcons) &#123;</span><br><span class="line">                <span class="comment">// åˆå§‹åŒ–è§†å›¾çš„é€æ˜åº¦å’Œç¼©æ”¾ï¼Œå‡†å¤‡åŠ¨ç”»</span></span><br><span class="line">                view.setAlpha(<span class="number">0f</span>);</span><br><span class="line">                view.setScaleX(<span class="number">0f</span>);</span><br><span class="line">                view.setScaleY(<span class="number">0f</span>);</span><br><span class="line">                <span class="comment">// åˆ›å»ºå¹¶æ·»åŠ  &quot;å¼¹è·³&quot; åŠ¨ç”»</span></span><br><span class="line">                bounceAnims.add(createNewAppBounceAnimation(view, i));</span><br><span class="line">                newItemsScreenId = presenterPos.screenId;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (newView == <span class="literal">null</span>) &#123;</span><br><span class="line">                newView = view;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="type">View</span> <span class="variable">viewToFocus</span> <span class="operator">=</span> newView;</span><br><span class="line">        <span class="comment">// Animate to the correct pager</span></span><br><span class="line">        <span class="keyword">if</span> (forceAnimateIcons &amp;&amp; newItemsScreenId &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">AnimatorSet</span> <span class="variable">anim</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnimatorSet</span>();</span><br><span class="line">            anim.playTogether(bounceAnims);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ— éšœç¢ç„¦ç‚¹</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (focusFirstItemForAccessibility &amp;&amp; viewToFocus != <span class="literal">null</span>) &#123;</span><br><span class="line">                anim.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                         * å¦‚æœå¯ç”¨äº†æ— éšœç¢ç„¦ç‚¹å¹¶ä¸”æœ‰å¯èšç„¦è§†å›¾ï¼Œåˆ™åœ¨åŠ¨ç”»ç»“æŸåè§¦å‘æ— éšœç¢äº‹ä»¶</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        viewToFocus.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_FOCUSED);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * é¡µé¢åˆ‡æ¢é€»è¾‘</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">currentScreenId</span> <span class="operator">=</span> mWorkspace.getScreenIdForPageIndex(mWorkspace.getNextPage());</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">newScreenIndex</span> <span class="operator">=</span> mWorkspace.getPageIndexForScreenId(newItemsScreenId);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">startBounceAnimRunnable</span> <span class="operator">=</span> anim::start;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (canAnimatePageChange &amp;&amp; newItemsScreenId != currentScreenId) &#123;</span><br><span class="line">                <span class="comment">// We post the animation slightly delayed to prevent slowdowns</span></span><br><span class="line">                <span class="comment">// when we are loading right after we return to launcher.</span></span><br><span class="line">                mWorkspace.postDelayed(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mWorkspace != <span class="literal">null</span>) &#123;</span><br><span class="line">                            closeOpenViews(<span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line">                            mWorkspace.snapToPage(newScreenIndex);</span><br><span class="line">                            mWorkspace.postDelayed(startBounceAnimRunnable,</span><br><span class="line">                                    NEW_APPS_ANIMATION_DELAY);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, NEW_APPS_PAGE_MOVE_DELAY);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mWorkspace.postDelayed(startBounceAnimRunnable, NEW_APPS_ANIMATION_DELAY);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (focusFirstItemForAccessibility &amp;&amp; viewToFocus != <span class="literal">null</span>) &#123;</span><br><span class="line">            viewToFocus.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_FOCUSED);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * åˆ·æ–°å·¥ä½œåŒºå¸ƒå±€ï¼Œç¡®ä¿é¡¹ç›®æ­£ç¡®æ˜¾ç¤º</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        workspace.requestLayout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¸ª WorkspaceLayoutManager.addInScreenFromBind() æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/WorkspaceLayoutManager.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WorkspaceLayoutManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">addInScreenFromBind</span><span class="params">(View child, ItemInfo info)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å°† ItemInfo çš„å¸ƒå±€ä¿¡æ¯æ˜ å°„åˆ°è§†å›¾çš„å‘ˆç°ä½ç½®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">CellPos</span> <span class="variable">presenterPos</span> <span class="operator">=</span> getCellPosMapper().mapModelToPresenter(info);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * x å’Œ y æ˜¯é¡¹ç›®åœ¨å·¥ä½œåŒºå¸ƒå±€ä¸­çš„ç½‘æ ¼åæ ‡ï¼Œåˆå§‹å€¼ä¸ºæ˜ å°„å¾—åˆ°çš„ cellX å’Œ cellY</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> presenterPos.cellX;</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> presenterPos.cellY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¦‚æœ ItemInfo è¡¨ç¤ºçš„é¡¹ç›®å±äº Hotseat å®¹å™¨ï¼Œåˆ™éœ€è¦æ ¹æ® Hotseat çš„ä½ç½®è§„åˆ™æ¥è®¡ç®—å‡†ç¡®çš„åæ ‡</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (info.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT</span><br><span class="line">                || info.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT_PREDICTION) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">screenId</span> <span class="operator">=</span> presenterPos.screenId;</span><br><span class="line">            x = getHotseat().getCellXFromOrder(screenId);</span><br><span class="line">            y = getHotseat().getCellYFromOrder(screenId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å°† child è§†å›¾æ·»åŠ åˆ°å·¥ä½œåŒºä¸­</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        addInScreen(child, info.container, presenterPos.screenId, x, y, info.spanX, info.spanY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¸ª WorkspaceLayoutManager.addInScreen() æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/WorkspaceLayoutManager.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WorkspaceLayoutManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * child      ï¼šè¦æ·»åŠ çš„è§†å›¾ç»„ä»¶</span></span><br><span class="line"><span class="comment">     * container  ï¼šå®¹å™¨ç±»å‹ï¼Œå†³å®šäº†è§†å›¾åº”æ”¾ç½®çš„ä½ç½®ï¼ˆä¾‹å¦‚æ¡Œé¢æˆ– Hotseatï¼‰</span></span><br><span class="line"><span class="comment">     * screenId   ï¼šå±å¹• IDï¼Œç”¨äºæ ‡è¯†è§†å›¾æ‰€åœ¨çš„å±å¹•</span></span><br><span class="line"><span class="comment">     * x/y        ï¼šè§†å›¾åœ¨ç½‘æ ¼ä¸­çš„åæ ‡</span></span><br><span class="line"><span class="comment">     * spanX/spanYï¼šè§†å›¾å ç”¨çš„ç½‘æ ¼è·¨åº¦ï¼Œå†³å®šäº†è§†å›¾çš„å¤§å°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">addInScreen</span><span class="params">(View child, <span class="type">int</span> container, <span class="type">int</span> screenId, <span class="type">int</span> x, <span class="type">int</span> y,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> spanX, <span class="type">int</span> spanY)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ£€æŸ¥ Desktop å±å¹•çš„æœ‰æ•ˆæ€§</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * è‹¥å®¹å™¨ä¸º Desktopï¼ˆæ¡Œé¢ï¼‰ï¼Œé¦–å…ˆæ£€æŸ¥ screenId æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line"><span class="comment">         * å¦‚æœå¯¹åº”çš„å±å¹•ä¸å­˜åœ¨ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯å¹¶æ‰“å°å †æ ˆè·Ÿè¸ªï¼Œä¾¿äºè°ƒè¯•ï¼Œç„¶åç›´æ¥è¿”å›ï¼Œè·³è¿‡æ·»åŠ æ“ä½œ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (container == LauncherSettings.Favorites.CONTAINER_DESKTOP) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getScreenWithId(screenId) == <span class="literal">null</span>) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Skipping child, screenId &quot;</span> + screenId + <span class="string">&quot; not found&quot;</span>);</span><br><span class="line">                <span class="comment">// DEBUGGING - Print out the stack trace to see where we are adding from</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Throwable</span>().printStackTrace();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ£€æŸ¥æ˜¯å¦ä¸ºé¢å¤–çš„ç©ºå±</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (EXTRA_EMPTY_SCREEN_IDS.contains(screenId)) &#123;</span><br><span class="line">            <span class="comment">// This should never happen</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Screen id should not be extra empty screen: &quot;</span> + screenId);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ ¹æ®å®¹å™¨ç±»å‹ï¼ˆDesktop æˆ– Hotseatï¼‰ç¡®å®šç›®æ ‡å¸ƒå±€</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">final</span> CellLayout layout;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å®¹å™¨ç±»å‹ï¼šHotseat</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (container == LauncherSettings.Favorites.CONTAINER_HOTSEAT</span><br><span class="line">                || container == LauncherSettings.Favorites.CONTAINER_HOTSEAT_PREDICTION) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * è°ƒç”¨ getHotseat() è·å– Hotseat å¸ƒå±€</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            layout = getHotseat();</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * éšè—æ–‡ä»¶å¤¹å›¾æ ‡çš„æ ‡é¢˜ï¼ˆFolderIconï¼‰</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (child <span class="keyword">instanceof</span> FolderIcon) &#123;</span><br><span class="line">                ((FolderIcon) child).setTextVisible(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å®¹å™¨ç±»å‹ï¼šDesktop</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * æ˜¾ç¤ºæ–‡ä»¶å¤¹å›¾æ ‡çš„æ ‡é¢˜</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (child <span class="keyword">instanceof</span> FolderIcon) &#123;</span><br><span class="line">                ((FolderIcon) child).setTextVisible(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * é€šè¿‡ screenId è·å–å±å¹•å¯¹åº”çš„ CellLayout</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            layout = getScreenWithId(screenId);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è®¾ç½®å¸ƒå±€å‚æ•°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ViewGroup.<span class="type">LayoutParams</span> <span class="variable">genericLp</span> <span class="operator">=</span> child.getLayoutParams();</span><br><span class="line">        CellLayoutLayoutParams lp;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ–°å»ºæˆ–é‡ç”¨å¸ƒå±€å‚æ•°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (genericLp == <span class="literal">null</span> || !(genericLp <span class="keyword">instanceof</span> CellLayoutLayoutParams)) &#123;</span><br><span class="line">            lp = <span class="keyword">new</span> <span class="title class_">CellLayoutLayoutParams</span>(x, y, spanX, spanY);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lp = (CellLayoutLayoutParams) genericLp;</span><br><span class="line">            lp.setCellX(x);</span><br><span class="line">            lp.setCellY(y);</span><br><span class="line">            lp.cellHSpan = spanX;</span><br><span class="line">            lp.cellVSpan = spanY;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ˜¯å¦é”å®šç½‘æ ¼</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (spanX &lt; <span class="number">0</span> &amp;&amp; spanY &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            lp.isLockedToGrid = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è·å–å­è§†å›¾çš„å”¯ä¸€ ID</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * è·å–è§†å›¾çš„ ItemInfo æ•°æ®ï¼Œä»ä¸­æå–å”¯ä¸€çš„ childIdï¼Œä¾¿äºåç»­åœ¨å¸ƒå±€ä¸­æ ‡è¯†è¯¥è§†å›¾</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">ItemInfo</span> <span class="variable">info</span> <span class="operator">=</span> (ItemInfo) child.getTag();</span><br><span class="line">        <span class="type">int</span> <span class="variable">childId</span> <span class="operator">=</span> info.getViewId();</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¦‚æœè§†å›¾æ˜¯æ–‡ä»¶å¤¹ï¼ˆFolderï¼‰ï¼Œä¸æ ‡è®°å•å…ƒæ ¼ä¸ºå·²å ç”¨ï¼Œå¦åˆ™æ ‡è®°ä¸ºå·²å ç”¨</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">markCellsAsOccupied</span> <span class="operator">=</span> !(child <span class="keyword">instanceof</span> Folder);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è°ƒç”¨ layout.addViewToCellLayout å°†è§†å›¾æ·»åŠ åˆ°å¸ƒå±€ç½‘æ ¼ä¸­</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!layout.addViewToCellLayout(child, -<span class="number">1</span>, childId, lp, markCellsAsOccupied)) &#123;</span><br><span class="line">            <span class="comment">// è‹¥æ·»åŠ å¤±è´¥ï¼ˆå³è§†å›¾è¶…å‡ºç½‘æ ¼é™åˆ¶ï¼‰ï¼Œè®°å½•é”™è¯¯æ—¥å¿—</span></span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Failed to add to item at (&quot;</span> + lp.getCellX() + <span class="string">&quot;,&quot;</span> + lp.getCellY()</span><br><span class="line">                    + <span class="string">&quot;) to CellLayout&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç¦ç”¨è§¦è§‰åé¦ˆ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        child.setHapticFeedbackEnabled(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è®¾ç½®é•¿æŒ‰ç›‘å¬å™¨ï¼Œä»¥æ”¯æŒé•¿æŒ‰æ“ä½œï¼ˆé€šå¸¸ç”¨äºæ‹–æ”¾æˆ–æ˜¾ç¤ºé€‰é¡¹ï¼‰</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        child.setOnLongClickListener(getWorkspaceChildOnLongClickListener());</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¦‚æœè§†å›¾æ˜¯ DropTargetï¼ˆå¯æ‹–æ”¾çš„ç›®æ ‡ï¼‰ï¼Œè°ƒç”¨ onAddDropTarget è¿›è¡Œæ³¨å†Œ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (child <span class="keyword">instanceof</span> DropTarget) &#123;</span><br><span class="line">            onAddDropTarget((DropTarget) child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­è·Ÿè¸ªï¼šCellLayout.addViewToCellLayout()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/CellLayout.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CellLayout</span> <span class="keyword">extends</span> <span class="title class_">ViewGroup</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addViewToCellLayout</span><span class="params">(View child, <span class="type">int</span> index, <span class="type">int</span> childId,</span></span><br><span class="line"><span class="params">            CellLayoutLayoutParams params, <span class="type">boolean</span> markCells)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å°†ä¼ å…¥çš„å¸ƒå±€å‚æ•° params èµ‹å€¼ç»™ lpï¼Œä¾¿äºåç»­ä½¿ç”¨</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">CellLayoutLayoutParams</span> <span class="variable">lp</span> <span class="operator">=</span> params;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¤„ç† Hotseat å›¾æ ‡æ–‡æœ¬å¯è§æ€§</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (child <span class="keyword">instanceof</span> BubbleTextView) &#123;</span><br><span class="line">            <span class="type">BubbleTextView</span> <span class="variable">bubbleChild</span> <span class="operator">=</span> (BubbleTextView) child;</span><br><span class="line">            bubbleChild.setTextVisibility(mContainerType != HOTSEAT);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * è®¾ç½®è§†å›¾ç¼©æ”¾</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        child.setScaleX(mChildScale);</span><br><span class="line">        child.setScaleY(mChildScale);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * éªŒè¯å¹¶è®¾ç½®ä½ç½®å’Œè·¨åº¦</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (lp.getCellX() &gt;= <span class="number">0</span> &amp;&amp; lp.getCellX() &lt;= mCountX - <span class="number">1</span></span><br><span class="line">                &amp;&amp; lp.getCellY() &gt;= <span class="number">0</span> &amp;&amp; lp.getCellY() &lt;= mCountY - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// If the horizontal or vertical span is set to -1, it is taken to</span></span><br><span class="line">            <span class="comment">// mean that it spans the extent of the CellLayout</span></span><br><span class="line">            <span class="keyword">if</span> (lp.cellHSpan &lt; <span class="number">0</span>) lp.cellHSpan = mCountX;</span><br><span class="line">            <span class="keyword">if</span> (lp.cellVSpan &lt; <span class="number">0</span>) lp.cellVSpan = mCountY;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ä¸º child è§†å›¾è®¾ç½®å”¯ä¸€çš„ IDï¼ˆchildIdï¼‰ï¼Œä¾¿äºåç»­æ“ä½œä¸­å”¯ä¸€æ ‡è¯†è¯¥è§†å›¾</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            child.setId(childId);</span><br><span class="line">            <span class="keyword">if</span> (LOGD) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;Adding view to ShortcutsAndWidgetsContainer: &quot;</span> + child);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å°†è§†å›¾æ·»åŠ åˆ° mShortcutsAndWidgetsï¼ˆåŒ…å«æ‰€æœ‰å›¾æ ‡å’Œå°éƒ¨ä»¶çš„å®¹å™¨ï¼‰ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment">             * ä½ç½®ç”± index æŒ‡å®šï¼Œå¸ƒå±€å‚æ•°ç”± lp æä¾›</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            mShortcutsAndWidgets.addView(child, index, lp);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ ‡è®°å•å…ƒæ ¼ä¸ºå·²å ç”¨ï¼Œé˜²æ­¢å…¶ä»–é¡¹ç›®é‡å åœ¨ç›¸åŒä½ç½®</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (markCells) markCellsAsOccupiedForView(child);</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç»‘å®š-Widget"><a href="#ç»‘å®š-Widget" class="headerlink" title="ç»‘å®š Widget"></a>ç»‘å®š Widget</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLauncherBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">UnifiedWorkspaceBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindAppWidgets</span><span class="params">(List&lt;LauncherAppWidgetInfo&gt; appWidgets, Executor executor)</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * è®¡ç®—å°éƒ¨ä»¶åˆ—è¡¨çš„å¤§å°ï¼Œä»¥ä¾¿åœ¨å¾ªç¯ä¸­é€ä¸ªç»‘å®šæ¯ä¸ªå°éƒ¨ä»¶</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> appWidgets.size();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * éå† appWidgets åˆ—è¡¨ä¸­çš„æ¯ä¸ªå°éƒ¨ä»¶</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * å°†å½“å‰å°éƒ¨ä»¶ä¿¡æ¯ä¿å­˜åˆ° widget å˜é‡ä¸­</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">ItemInfo</span> <span class="variable">widget</span> <span class="operator">=</span> appWidgets.get(i);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * å°†å½“å‰å°éƒ¨ä»¶ç»‘å®šåˆ°å·¥ä½œåŒº</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                executeCallbacksTask(</span><br><span class="line">                        c -&gt; c.bindItems(Collections.singletonList(widget), <span class="literal">false</span>), executor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ Launcher.bindItems() æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Launcher.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Launcher</span> <span class="keyword">extends</span> <span class="title class_">StatefulActivity</span>&lt;LauncherState&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LauncherExterns</span>, Callbacks, InvariantDeviceProfile.OnIDPChangeListener,</span><br><span class="line">        PluginListener&lt;LauncherOverlayPlugin&gt; &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bindItems</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> List&lt;ItemInfo&gt; items,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="type">boolean</span> forceAnimateIcons,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="type">boolean</span> focusFirstItemForAccessibility)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * éå† items åˆ—è¡¨ä¸­çš„æ¯ä¸ª ItemInfo é¡¹ç›®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; end; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ItemInfo</span> <span class="variable">item</span> <span class="operator">=</span> items.get(i);</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * æ ¹æ® item ç±»å‹åˆ›å»ºè§†å›¾</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">final</span> View view;</span><br><span class="line">            <span class="keyword">switch</span> (item.itemType) &#123;</span><br><span class="line">                ...</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å°éƒ¨ä»¶</span></span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPWIDGET:</span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_CUSTOM_APPWIDGET: &#123;</span><br><span class="line">                    <span class="comment">// ç”Ÿæˆå°éƒ¨ä»¶è§†å›¾</span></span><br><span class="line">                    view = inflateAppWidget((LauncherAppWidgetInfo) item);</span><br><span class="line">                    <span class="keyword">if</span> (view == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å…¶ä»–ç±»å‹å°†æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Invalid Item Type&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * åˆ·æ–°å·¥ä½œåŒºå¸ƒå±€ï¼Œç¡®ä¿é¡¹ç›®æ­£ç¡®æ˜¾ç¤º</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        workspace.requestLayout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬ç»§ç»­è·Ÿè¸ª <code>inflateAppWidget()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">ğŸ“„ æºç è·¯å¾„ï¼š<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Launcher.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Launcher</span> <span class="keyword">extends</span> <span class="title class_">StatefulActivity</span>&lt;LauncherState&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LauncherExterns</span>, Callbacks, InvariantDeviceProfile.OnIDPChangeListener,</span><br><span class="line">        PluginListener&lt;LauncherOverlayPlugin&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> View <span class="title function_">inflateAppWidget</span><span class="params">(LauncherAppWidgetInfo item)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æœç´¢å°éƒ¨ä»¶å¤„ç†</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (item.hasOptionFlag(LauncherAppWidgetInfo.OPTION_SEARCH_WIDGET)) &#123;</span><br><span class="line">            item.providerName = QsbContainerView.getSearchComponentName(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (item.providerName == <span class="literal">null</span>) &#123;</span><br><span class="line">                getModelWriter().deleteItemFromDatabase(item,</span><br><span class="line">                        <span class="string">&quot;search widget removed because search component cannot be found&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> AppWidgetHostView view;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å¦‚æœè®¾å¤‡å¤„äºå®‰å…¨æ¨¡å¼ï¼Œä½¿ç”¨ PendingAppWidgetHostView åˆ›å»ºä¸€ä¸ªæŒ‚èµ·çš„å°éƒ¨ä»¶è§†å›¾ï¼Œå¹¶è¿”å›è¯¥è§†å›¾</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mIsSafeModeEnabled) &#123;</span><br><span class="line">            view = <span class="keyword">new</span> <span class="title class_">PendingAppWidgetHostView</span>(<span class="built_in">this</span>, item, mIconCache, <span class="literal">true</span>);</span><br><span class="line">            prepareAppWidget(view, item);</span><br><span class="line">            <span class="keyword">return</span> view;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ€§èƒ½è·Ÿè¸ªåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">traceToken</span> <span class="operator">=</span> TraceHelper.INSTANCE.beginSection(<span class="string">&quot;BIND_WIDGET_id=&quot;</span> + item.appWidgetId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç»‘å®šå°éƒ¨ä»¶çš„çŠ¶æ€æ£€æŸ¥ä¸å¤„ç†</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> LauncherAppWidgetProviderInfo appWidgetInfo;</span><br><span class="line">            <span class="type">String</span> <span class="variable">removalReason</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * è¡¨ç¤ºå°éƒ¨ä»¶æä¾›è€…æœªå‡†å¤‡å¥½</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY)) &#123;</span><br><span class="line">                <span class="comment">// If the provider is not ready, bind as a pending widget.</span></span><br><span class="line">                appWidgetInfo = <span class="literal">null</span>;</span><br><span class="line">                removalReason = <span class="string">&quot;the provider isn&#x27;t ready.&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID)) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * å°éƒ¨ä»¶ ID æ— æ•ˆï¼Œï¼Œæ ¹æ® providerName æ‰¾åˆ°å°éƒ¨ä»¶çš„æä¾›è€…</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                appWidgetInfo = mAppWidgetManager.findProvider(item.providerName, item.user);</span><br><span class="line">                <span class="keyword">if</span> (appWidgetInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (WidgetsModel.GO_DISABLE_WIDGETS) &#123;</span><br><span class="line">                        removalReason = <span class="string">&quot;widgets are disabled on go device.&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        removalReason =</span><br><span class="line">                                <span class="string">&quot;WidgetManagerHelper cannot find a provider from provider info.&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * æ­£å¸¸ç»‘å®š</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                appWidgetInfo = mAppWidgetManager.getLauncherAppWidgetInfo(item.appWidgetId);</span><br><span class="line">                <span class="keyword">if</span> (appWidgetInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (item.appWidgetId &lt;= LauncherAppWidgetInfo.CUSTOM_WIDGET_ID) &#123;</span><br><span class="line">                        removalReason =</span><br><span class="line">                                <span class="string">&quot;CustomWidgetManager cannot find provider from that widget id.&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        removalReason = <span class="string">&quot;AppWidgetManager cannot find provider for that widget id.&quot;</span></span><br><span class="line">                                + <span class="string">&quot; It could be because AppWidgetService is not available, or the&quot;</span></span><br><span class="line">                                + <span class="string">&quot; appWidgetId has not been bound to a the provider yet, or you&quot;</span></span><br><span class="line">                                + <span class="string">&quot; don&#x27;t have access to that appWidgetId.&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the provider is ready, but the width is not yet restored, try to restore it.</span></span><br><span class="line">            <span class="keyword">if</span> (!item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY)</span><br><span class="line">                    &amp;&amp; (item.restoreStatus != LauncherAppWidgetInfo.RESTORE_COMPLETED)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (appWidgetInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                    getModelWriter().deleteItemFromDatabase(item,</span><br><span class="line">                            <span class="string">&quot;Removing restored widget: id=&quot;</span> + item.appWidgetId</span><br><span class="line">                                    + <span class="string">&quot; belongs to component &quot;</span> + item.providerName + <span class="string">&quot; user &quot;</span> + item.user</span><br><span class="line">                                    + <span class="string">&quot;, as the provider is null and &quot;</span> + removalReason);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If we do not have a valid id, try to bind an id.</span></span><br><span class="line">                <span class="keyword">if</span> (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_ALLOCATED)) &#123;</span><br><span class="line">                        <span class="comment">// Id has not been allocated yet. Allocate a new id.</span></span><br><span class="line">                        item.appWidgetId = mAppWidgetHolder.allocateAppWidgetId();</span><br><span class="line">                        item.restoreStatus |= LauncherAppWidgetInfo.FLAG_ID_ALLOCATED;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Also try to bind the widget. If the bind fails, the user will be shown</span></span><br><span class="line">                        <span class="comment">// a click to setup UI, which will ask for the bind permission.</span></span><br><span class="line">                        <span class="type">PendingAddWidgetInfo</span> <span class="variable">pendingInfo</span> <span class="operator">=</span></span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">PendingAddWidgetInfo</span>(appWidgetInfo, item.sourceContainer);</span><br><span class="line">                        pendingInfo.spanX = item.spanX;</span><br><span class="line">                        pendingInfo.spanY = item.spanY;</span><br><span class="line">                        pendingInfo.minSpanX = item.minSpanX;</span><br><span class="line">                        pendingInfo.minSpanY = item.minSpanY;</span><br><span class="line">                        <span class="type">Bundle</span> <span class="variable">options</span> <span class="operator">=</span> pendingInfo.getDefaultSizeOptions(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">isDirectConfig</span> <span class="operator">=</span></span><br><span class="line">                                item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_DIRECT_CONFIG);</span><br><span class="line">                        <span class="keyword">if</span> (isDirectConfig &amp;&amp; item.bindOptions != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="type">Bundle</span> <span class="variable">newOptions</span> <span class="operator">=</span> item.bindOptions.getExtras();</span><br><span class="line">                            <span class="keyword">if</span> (options != <span class="literal">null</span>) &#123;</span><br><span class="line">                                newOptions.putAll(options);</span><br><span class="line">                            &#125;</span><br><span class="line">                            options = newOptions;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> mAppWidgetManager.bindAppWidgetIdIfAllowed(</span><br><span class="line">                                item.appWidgetId, appWidgetInfo, options);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// We tried to bind once. If we were not able to bind, we would need to</span></span><br><span class="line">                        <span class="comment">// go through the permission dialog, which means we cannot skip the config</span></span><br><span class="line">                        <span class="comment">// activity.</span></span><br><span class="line">                        item.bindOptions = <span class="literal">null</span>;</span><br><span class="line">                        item.restoreStatus &amp;= ~LauncherAppWidgetInfo.FLAG_DIRECT_CONFIG;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Bind succeeded</span></span><br><span class="line">                        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                            <span class="comment">// If the widget has a configure activity, it is still needs to set it</span></span><br><span class="line">                            <span class="comment">// up, otherwise the widget is ready to go.</span></span><br><span class="line">                            item.restoreStatus = (appWidgetInfo.configure == <span class="literal">null</span>) || isDirectConfig</span><br><span class="line">                                    ? LauncherAppWidgetInfo.RESTORE_COMPLETED</span><br><span class="line">                                    : LauncherAppWidgetInfo.FLAG_UI_NOT_READY;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        getModelWriter().updateItemInDatabase(item);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_UI_NOT_READY)</span><br><span class="line">                        &amp;&amp; (appWidgetInfo.configure == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    <span class="comment">// The widget was marked as UI not ready, but there is no configure activity to</span></span><br><span class="line">                    <span class="comment">// update the UI.</span></span><br><span class="line">                    item.restoreStatus = LauncherAppWidgetInfo.RESTORE_COMPLETED;</span><br><span class="line">                    getModelWriter().updateItemInDatabase(item);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_UI_NOT_READY)</span><br><span class="line">                        &amp;&amp; appWidgetInfo.configure != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mAppWidgetManager.isAppWidgetRestored(item.appWidgetId)) &#123;</span><br><span class="line">                        item.restoreStatus = LauncherAppWidgetInfo.RESTORE_COMPLETED;</span><br><span class="line">                        getModelWriter().updateItemInDatabase(item);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å°éƒ¨ä»¶è§†å›¾åˆ›å»ºä¸è¿”å›</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (item.restoreStatus == LauncherAppWidgetInfo.RESTORE_COMPLETED) &#123;</span><br><span class="line">                <span class="comment">// Verify that we own the widget</span></span><br><span class="line">                <span class="keyword">if</span> (appWidgetInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                    FileLog.e(TAG, <span class="string">&quot;Removing invalid widget: id=&quot;</span> + item.appWidgetId);</span><br><span class="line">                    getModelWriter().deleteWidgetInfo(item, getAppWidgetHolder(), removalReason);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                item.minSpanX = appWidgetInfo.minSpanX;</span><br><span class="line">                item.minSpanY = appWidgetInfo.minSpanY;</span><br><span class="line">                view = mAppWidgetHolder.createView(<span class="built_in">this</span>, item.appWidgetId, appWidgetInfo);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID)</span><br><span class="line">                    &amp;&amp; appWidgetInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                mAppWidgetHolder.addPendingView(item.appWidgetId,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">PendingAppWidgetHostView</span>(<span class="built_in">this</span>, item, mIconCache, <span class="literal">false</span>));</span><br><span class="line">                view = mAppWidgetHolder.createView(<span class="built_in">this</span>, item.appWidgetId, appWidgetInfo);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                view = <span class="keyword">new</span> <span class="title class_">PendingAppWidgetHostView</span>(<span class="built_in">this</span>, item, mIconCache, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * å°éƒ¨ä»¶å‡†å¤‡</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            prepareAppWidget(view, item);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            TraceHelper.INSTANCE.endSection(traceToken);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- Workspace</p><p><a href="http://example.com/2024/10/25/launcher/Android -- Launcher3 -- 02. æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- workspace/">http://example.com/2024/10/25/launcher/Android -- Launcher3 -- 02. æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- workspace/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>ä½œè€…</h6><p>Marco</p></div></div><div class="level-item is-narrow"><div><h6>å‘å¸ƒäº</h6><p>2024-10-25</p></div></div><div class="level-item is-narrow"><div><h6>æ›´æ–°äº</h6><p>2025-07-20</p></div></div><div class="level-item is-narrow"><div><h6>è®¸å¯åè®®</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Launcher3/">Launcher3</a><a class="link-muted mr-2" rel="tag" href="/tags/Android-14-0/">Android 14.0</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/11/01/launcher/Android%20--%20Launcher3%20--%2003.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%20--%20allapps/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- AllApps</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/10/23/launcher/Android%20--%20Launcher3%20--%2001.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%EF%BC%88%E5%88%9D%E6%8E%A2%EF%BC%89/"><span class="level-item">LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- åˆæ¢</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">æœ€æ–°æ–‡ç« </h3><article class="media"><figure class="media-left"><a class="image" href="/2025/08/01/compose/Compose%20--%20%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85%20&amp;%20%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%20--%2001.%20%E8%A7%A3%E6%9E%90%20mutableStateOf%20%E6%BA%90%E7%A0%81/"><img src="/gallery/covers/compose/cover_compose_1.png" alt="è§£æ mutableStateOf æºç "></a></figure><div class="media-content"><p class="date"><time dateTime="2025-07-31T16:00:00.000Z">2025-08-01</time></p><p class="title"><a href="/2025/08/01/compose/Compose%20--%20%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85%20&amp;%20%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%20--%2001.%20%E8%A7%A3%E6%9E%90%20mutableStateOf%20%E6%BA%90%E7%A0%81/">è§£æ mutableStateOf æºç </a></p><p class="categories"><a href="/categories/Compose/">Compose</a> / <a href="/categories/Compose/%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/">çŠ¶æ€è®¢é˜… &amp; è‡ªåŠ¨æ›´æ–°</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/07/25/kotlin/Kotlin%20--%20%E5%8D%8F%E7%A8%8B%20--%2002.%20Channel_Flow/"><img src="/gallery/covers/kotlin/channel_flow.png" alt="Channel &amp; Flow"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-07-24T16:00:00.000Z">2025-07-25</time></p><p class="title"><a href="/2025/07/25/kotlin/Kotlin%20--%20%E5%8D%8F%E7%A8%8B%20--%2002.%20Channel_Flow/">Channel &amp; Flow</a></p><p class="categories"><a href="/categories/Kotlin/">Kotlin</a> / <a href="/categories/Kotlin/Channel/">Channel</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/07/20/kotlin/Kotlin%20--%20%E5%8D%8F%E7%A8%8B%20--%2001.%20%E5%8D%8F%E7%A8%8B%E5%85%A5%E9%97%A8%20copy/"><img src="/gallery/covers/kotlin/coroutines.jpg" alt="è¿™æ˜¯ä¸€ç¯‡é€šä¿—æ˜“æ‡‚çš„ã€Œåç¨‹ã€å…¥é—¨æŒ‡å—"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-07-19T16:00:00.000Z">2025-07-20</time></p><p class="title"><a href="/2025/07/20/kotlin/Kotlin%20--%20%E5%8D%8F%E7%A8%8B%20--%2001.%20%E5%8D%8F%E7%A8%8B%E5%85%A5%E9%97%A8%20copy/">è¿™æ˜¯ä¸€ç¯‡é€šä¿—æ˜“æ‡‚çš„ã€Œåç¨‹ã€å…¥é—¨æŒ‡å—</a></p><p class="categories"><a href="/categories/Kotlin/">Kotlin</a> / <a href="/categories/Kotlin/%E5%8D%8F%E7%A8%8B/">åç¨‹</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/06/26/settings/Settings%20--%20%E5%8F%8C%E6%A0%8F%E8%A7%A3%E6%9E%90/"><img src="/gallery/covers/android/settings.jpg" alt="Settingsã€Œæºç è§£æç³»åˆ—ã€-- å•/åŒæ åŸç†"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-06-25T16:00:00.000Z">2025-06-26</time></p><p class="title"><a href="/2025/06/26/settings/Settings%20--%20%E5%8F%8C%E6%A0%8F%E8%A7%A3%E6%9E%90/">Settingsã€Œæºç è§£æç³»åˆ—ã€-- å•/åŒæ åŸç†</a></p><p class="categories"><a href="/categories/Android/">Android</a> / <a href="/categories/Android/Settings/">Settings</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/05/20/jetpack/Jetpack%20%E4%BF%9D%E5%A7%86%E6%95%99%E7%A8%8B%20--%20ROOM/"><img src="/gallery/covers/jetpack/room.jpg" alt="Jetpackã€Œä¿å§†æ•™ç¨‹ã€-- ROOM"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-19T16:00:00.000Z">2025-05-20</time></p><p class="title"><a href="/2025/05/20/jetpack/Jetpack%20%E4%BF%9D%E5%A7%86%E6%95%99%E7%A8%8B%20--%20ROOM/">Jetpackã€Œä¿å§†æ•™ç¨‹ã€-- ROOM</a></p><p class="categories"><a href="/categories/Kotlin/">Kotlin</a> / <a href="/categories/Kotlin/%E5%8D%8F%E7%A8%8B/">åç¨‹</a></p></div></article></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">ç›®å½•</h3><ul class="menu-list"><li><a class="level is-mobile" href="#å‰è¨€"><span class="level-left"><span class="level-item">1</span><span class="level-item">å‰è¨€</span></span></a></li><li><a class="level is-mobile" href="#åŠ è½½-Workspace-æµç¨‹è§£æ"><span class="level-left"><span class="level-item">2</span><span class="level-item">åŠ è½½ Workspace æµç¨‹è§£æ</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#åŠ è½½é»˜è®¤æ¡Œé¢å¸ƒå±€"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">åŠ è½½é»˜è®¤æ¡Œé¢å¸ƒå±€</span></span></a></li><li><a class="level is-mobile" href="#åŠ è½½æ•°æ®åº“"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">åŠ è½½æ•°æ®åº“</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#åº”ç”¨-å¿«æ·æ–¹å¼"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">åº”ç”¨/å¿«æ·æ–¹å¼</span></span></a></li><li><a class="level is-mobile" href="#æ–‡ä»¶å¤¹"><span class="level-left"><span class="level-item">2.2.2</span><span class="level-item">æ–‡ä»¶å¤¹</span></span></a></li><li><a class="level is-mobile" href="#Widget"><span class="level-left"><span class="level-item">2.2.3</span><span class="level-item">Widget</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#ç»‘å®š-Workspace-æµç¨‹è§£æ"><span class="level-left"><span class="level-item">3</span><span class="level-item">ç»‘å®š Workspace æµç¨‹è§£æ</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ç»‘å®šå±å¹•"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">ç»‘å®šå±å¹•</span></span></a></li><li><a class="level is-mobile" href="#ç»‘å®šæ•°æ®å†…å®¹"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">ç»‘å®šæ•°æ®å†…å®¹</span></span></a></li><li><a class="level is-mobile" href="#ç»‘å®š-Widget"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">ç»‘å®š Widget</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/wikihow.svg" alt="wikiHow" height="28"></a><p class="is-size-7"><span>&copy; 2025 Marco</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">Â© Honey Badger Team</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/pepsimaxin"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="å›åˆ°é¡¶ç«¯" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "æ­¤ç½‘ç«™ä½¿ç”¨Cookieæ¥æ”¹å–„æ‚¨çš„ä½“éªŒã€‚",
          dismiss: "çŸ¥é“äº†ï¼",
          allow: "å…è®¸ä½¿ç”¨Cookie",
          deny: "æ‹’ç»",
          link: "äº†è§£æ›´å¤š",
          policy: "Cookieæ”¿ç­–",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ...","untitled":"(æ— æ ‡é¢˜)","posts":"æ–‡ç« ","pages":"é¡µé¢","categories":"åˆ†ç±»","tags":"æ ‡ç­¾"});
        });</script></body></html>