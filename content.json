{"posts":[{"title":"LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- åˆæ¢","text":"æ ¸å¿ƒç±» è·¯å¾„ Launcher.java package/app/Launcher3/src/com/android/launcher3/Launcher.java LoaderTask package/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java LauncherSettings.java package/app/Launcher3/src/com/android/launcher3/LauncherSettings.java LauncherProvider.java package/app/Launcher3/src/com/android/launcher3/LauncherProvider.java ModelDbController.java package/app/Launcher3/src/com/android/launcher3/model/ModelDbController.java InvariantDeviceProfile.java package/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java LauncherAppState.java package/app/Launcher3/src/com/android/launcher3/LauncherAppState.java Launcher.oncreate()Launcher è¢« AMS æ‹‰èµ·åï¼Œå°±è¿›å…¥äº†è‡ªå·±çš„ç”Ÿå‘½æµç¨‹ï¼ŒLauncher.java ä¸­çš„ onCreate() å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå‡†å¤‡å¼€å§‹åŠ è½½æ¡Œé¢ã€‚ 12345678910111213141516171819202122232425ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/Launcher.javapublic class Launcher extends StatefulActivity&lt;LauncherState&gt; implements LauncherExterns, Callbacks, InvariantDeviceProfile.OnIDPChangeListener, PluginListener&lt;LauncherOverlayPlugin&gt; { private LauncherModel mModel; protected void onCreate(Bundle savedInstanceState) { ... LauncherAppState app = LauncherAppState.getInstance(this); mModel = app.getModel(); // æ‰§è¡Œ LauncherModel çš„ addCallbacksAndLoad() æ–¹æ³• if (!mModel.addCallbacksAndLoad(this)) { if (!internalStateHandled) { mOnInitialBindListener = Boolean.FALSE::booleanValue; } } ... } } æˆ‘ä»¬æ¥çœ‹çœ‹ addCallbacksAndLoad() åœ¨ LauncherModel.java ä¸­å®ç°ã€‚ 12345678910111213ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/LauncherModel.javapublic class LauncherModel extends LauncherApps.Callback implements InstallSessionTracker.Callback { public boolean addCallbacksAndLoad(@NonNull final Callbacks callbacks) { synchronized (mLock) { addCallbacks(callbacks); // è°ƒç”¨ startLoader() æ–¹æ³• return startLoader(new Callbacks[] { callbacks }); } }} è°ƒç”¨äº† startLoader() æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/LauncherModel.javapublic class LauncherModel extends LauncherApps.Callback implements InstallSessionTracker.Callback { private boolean startLoader(@NonNull final Callbacks[] newCallbacks) { // Enable queue before starting loader. It will get disabled in Launcher#finishBindingItems ItemInstallQueue.INSTANCE.get(mApp.getContext()) .pauseModelPush(ItemInstallQueue.FLAG_LOADER_RUNNING); synchronized (mLock) { ... if (callbacksList.length &gt; 0) { # Clear any pending bind-runnables from the synchronized load process. for (Callbacks cb : callbacksList) { MAIN_EXECUTOR.execute(cb::clearPendingBinds); } LauncherBinder launcherBinder = new LauncherBinder( mApp, mBgDataModel, mBgAllAppsList, callbacksList); // éé¦–æ¬¡å¯åŠ¨ï¼ŒLauncher ç›´æ¥ä»æ•°æ®åº“ä¸­åŒæ­¥åŠ è½½ if (bindDirectly) { launcherBinder.bindWorkspace(bindAllCallbacks, /* isBindSync= */ true); launcherBinder.bindAllApps(); launcherBinder.bindDeepShortcuts(); launcherBinder.bindWidgets(); launcherBinder.updateIconTheme(); if (FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) { mModelDelegate.bindAllModelExtras(callbacksList); } return true; } else { stopLoader(); // é¦–æ¬¡å¯åŠ¨èµ°è¿™é‡Œ mLoaderTask = new LoaderTask( mApp, mBgAllAppsList, mBgDataModel, mModelDelegate, launcherBinder); MODEL_EXECUTOR.post(mLoaderTask); } } } return false; }} åœ¨ startLoader() æ–¹æ³•ä¸­ä¼šåˆ›å»º LauncherBinder å¯¹è±¡ã€‚å¦‚æœæ˜¯é¦–æ¬¡å¯åŠ¨æƒ…å†µä¸‹ï¼Œä¼šåˆ›å»º LoaderTask å¯¹è±¡ï¼Œç„¶åä¼šæ‰§è¡Œ LoaderTask.run() æ–¹æ³•ï¼Œåˆ©ç”¨ä¹‹å‰åˆ›å»ºçš„ LauncherBinder å¼€å§‹åŠ è½½æ¡Œé¢ã€‚ LoaderTask.run()æŸ¥çœ‹ run() æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java/** * Runnable for the thread that loads the contents of the launcher: * - workspace icons * - widgets * - all apps icons * - deep shortcuts within apps */public class LoaderTask implements Runnable { public void run() { synchronized (this) { // å¦‚æœå·²ç»åœæ­¢ï¼Œåˆ™å¿«é€Ÿè·³è¿‡ if (mStopped) { return; } } Object traceToken = TraceHelper.INSTANCE.beginSection(TAG); LoaderMemoryLogger memoryLogger = new LoaderMemoryLogger(); // è¿™é‡Œä¸ LauncherModel.LoaderTransaction å…³è”ä¸Š try (LauncherModel.LoaderTransaction transaction = mApp.getModel().beginLoader(this)) { List&lt;ShortcutInfo&gt; allShortcuts = new ArrayList&lt;&gt;(); --------------------------------------------------------------------------- // ç¬¬ 1 æ­¥ï¼šåŠ è½½å·¥ä½œåŒº loadWorkspace(allShortcuts, &quot;&quot;, memoryLogger); // æ ¹æ®ä»æ•°æ®åº“åŠ è½½çš„å·¥ä½œç©ºé—´ï¼Œæ¸…ç†æ•°æ®é‡æ–°åŒæ­¥å°éƒ¨ä»¶å¿«æ·æ–¹å¼ if (mApp.getInvariantDeviceProfile().dbFile.equals(mDbName)) { verifyNotStopped(); sanitizeFolders(mItemsDeleted); sanitizeWidgetsShortcutsAndPackages(); logASplit(&quot;sanitizeData&quot;); } verifyNotStopped(); // ç»‘å®š Workspace æ•°æ®ï¼ˆç»‘å®šå›¾æ ‡ä¹‹ç±»çš„æ•°æ®ï¼Œæ¡Œé¢åŠå…¶ä¸Šå†…å®¹å¼€å§‹å‘ˆç°ï¼‰ mLauncherBinder.bindWorkspace(true /* incrementBindId */, /* isBindSync= */ false); logASplit(&quot;bindWorkspace&quot;); mModelDelegate.workspaceLoadComplete(); // å‘é€é¦–å±å¹¿æ’­ï¼ˆå¼€æœºåé»˜è®¤æ˜¾ç¤ºçš„ç¬¬ä¸€ä¸ª Screenï¼Œå¦‚æœå›¾æ ‡å¤šçš„è¯ï¼Œ // ä¼šè¢«åˆ†æˆå¤šä¸ª Screenï¼Œé€šè¿‡å·¦å³æ»‘åŠ¨æ˜¾ç¤ºå…¶ä»–çš„ï¼‰ sendFirstScreenActiveInstallsBroadcast(); logASplit(&quot;sendFirstScreenActiveInstallsBroadcast&quot;); // ç­‰å¾…æ¡Œé¢ (workspace) åŠ è½½å®Œæˆå†åŠ è½½æŠ½å±‰ (Allapps) waitForIdle(); logASplit(&quot;step 1 complete&quot;); verifyNotStopped(); --------------------------------------------------------------------------- // ç¬¬ 2 æ­¥ï¼šåŠ è½½å…¨éƒ¨åº”ç”¨ Trace.beginSection(&quot;LoadAllApps&quot;); List&lt;LauncherActivityInfo&gt; allActivityList; try { allActivityList = loadAllApps(); } finally { Trace.endSection(); } logASplit(&quot;loadAllApps&quot;); if (FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) { mModelDelegate.loadAndBindAllAppsItems(mUserManagerState, mLauncherBinder.mCallbacksList, mShortcutKeyToPinnedShortcuts); logASplit(&quot;allAppsDelegateItems&quot;); } verifyNotStopped(); // ç»‘å®š All Apps mLauncherBinder.bindAllApps(); logASplit(&quot;bindAllApps&quot;); verifyNotStopped(); IconCacheUpdateHandler updateHandler = mIconCache.getUpdateHandler(); setIgnorePackages(updateHandler); updateHandler.updateIcons(allActivityList, LauncherActivityCachingLogic.newInstance(mApp.getContext()), mApp.getModel()::onPackageIconsUpdated); logASplit(&quot;update icon cache&quot;); verifyNotStopped(); logASplit(&quot;save shortcuts in icon cache&quot;); updateHandler.updateIcons(allShortcuts, new ShortcutCachingLogic(), mApp.getModel()::onPackageIconsUpdated); // ç­‰å¾…ä¸Šä¸€æ“ä½œåŠ è½½å®Œæˆï¼Œå†è¿›è¡ŒåŠ è½½åº”ç”¨ç¨‹åºå¿«æ·æ–¹å¼ waitForIdle(); logASplit(&quot;step 2 complete&quot;); verifyNotStopped(); --------------------------------------------------------------------------- // ç¬¬ 3 æ­¥ï¼šåŠ è½½åº”ç”¨ç¨‹åºå¿«æ·æ–¹å¼ List&lt;ShortcutInfo&gt; allDeepShortcuts = loadDeepShortcuts(); logASplit(&quot;loadDeepShortcuts&quot;); verifyNotStopped(); // æ•°æ®åŒæ­¥ç»‘å®šåº”ç”¨ç¨‹åºå¿«æ·æ–¹å¼ mLauncherBinder.bindDeepShortcuts(); logASplit(&quot;bindDeepShortcuts&quot;); verifyNotStopped(); logASplit(&quot;save deep shortcuts in icon cache&quot;); // ç¼“å­˜å¯¹åº”å›¾æ ‡ updateHandler.updateIcons(allDeepShortcuts, new ShortcutCachingLogic(), (pkgs, user) -&gt; { }); // ç­‰å¾…ä¸Šä¸€æ­¥æ“ä½œå®Œæˆï¼Œå†è¿›è¡ŒåŠ è½½å°éƒ¨ä»¶ç­‰ waitForIdle(); logASplit(&quot;step 3 complete&quot;); verifyNotStopped(); --------------------------------------------------------------------------- // ç¬¬ 4 æ­¥ï¼šåŠ è½½æ¡Œé¢å°éƒ¨ä»¶ List&lt;ComponentWithLabelAndIcon&gt; allWidgetsList = mBgDataModel.widgetsModel.update(mApp, null); logASplit(&quot;load widgets&quot;); verifyNotStopped(); // ç»‘å®š Widgets mLauncherBinder.bindWidgets(); logASplit(&quot;bindWidgets&quot;); verifyNotStopped(); if (FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) { mModelDelegate.loadAndBindOtherItems(mLauncherBinder.mCallbacksList); logASplit(&quot;otherDelegateItems&quot;); verifyNotStopped(); } // å°†å°éƒ¨ä»¶è¿›è¡Œç¼“å­˜ updateHandler.updateIcons(allWidgetsList, new ComponentWithIconCachingLogic(mApp.getContext(), true), mApp.getModel()::onWidgetLabelsUpdated); logASplit(&quot;save widgets in icon cache&quot;); --------------------------------------------------------------------------- // ç¬¬ 5 æ­¥ï¼šåŠ è½½æ–‡ä»¶å¤¹åç§° loadFolderNames(); verifyNotStopped(); updateHandler.finish(); logASplit(&quot;finish icon update&quot;); mModelDelegate.modelLoadComplete(); // æäº¤å®Œæˆ transaction.commit(); memoryLogger.clearLogs(); } catch (CancellationException e) { // Loader stopped, ignore logASplit(&quot;Cancelled&quot;); } catch (Exception e) { memoryLogger.printLogs(); throw e; } TraceHelper.INSTANCE.endSection(traceToken); }} æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ™°çš„å‘ç° LoaderTask åšäº†ä»¥ä¸‹äº”ä»¶äº‹ï¼š Step 1: Workspaceï¼šåŠ è½½å·¥ä½œåŒº+ ç»‘å®š Workspace step 1.1: loading workspace step 1.2: bind workspace step 1.3: send first screen broadcast step 1 completed, wait for idle Step 2: AllAppsï¼šåŠ è½½å…¨éƒ¨åº”ç”¨ + ç»‘å®šå…¨éƒ¨åº”ç”¨ step 2.1: loading all apps step 2.2: bind all apps step 2.3: update icon cache step 2 completed, wait for idle Step 3: DeepShortcutsï¼šåŠ è½½åº”ç”¨ç¨‹åºå¿«æ·æ–¹å¼ + ç»‘å®šåº”ç”¨ç¨‹åºå¿«æ·æ–¹å¼ step 3.1: loading deep shortcuts step 3.2: bind deep shortcuts step 3 completed, wait for idle Step 4: Widgetsï¼šåŠ è½½æ¡Œé¢å°éƒ¨ä»¶ + ç»‘å®šæ¡Œé¢å°éƒ¨ä»¶ step 4.1: loading widgets step 4.2: bind widgets step 4.3: Update icon cache Step 5: FolderNamesï¼šåŠ è½½æ–‡ä»¶å¤¹åç§° step 5: loading folder names æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šæ·±å…¥æºç ï¼Œæ·±åº¦è§£è¯» LoaderTask çš„æ¯ä¸€æ­¥å·¥ä½œï¼","link":"/2024/10/23/Android%20--%20Launcher3%20--%2001.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%EF%BC%88%E5%88%9D%E6%8E%A2%EF%BC%89/"},{"title":"æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- Folder","text":"Step5: FolderNames åŠ è½½æ–‡ä»¶å¤¹åç§° åŠ è½½æ–‡ä»¶å¤¹åç§°æ ¸å¿ƒæ–¹æ³•ï¼šloadFolderNames() è´Ÿè´£åŠ è½½æ–‡ä»¶å¤¹åç§°ï¼š 12345678910111213141516171819202122232425262728ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/LoaderTask.javapublic class LoaderTask implements Runnable { private void loadFolderNames() { // åˆ›å»ºä¸€ä¸ªæ–°çš„ FolderNameProvider å®ä¾‹ // è¿™ä¸ªæä¾›è€…ç±»ç”¨äºç”Ÿæˆæ–‡ä»¶å¤¹åç§°ï¼Œé€šå¸¸åŸºäºæ–‡ä»¶å¤¹å†…çš„åº”ç”¨æ¥ç”Ÿæˆåˆé€‚çš„åç§°ã€‚ FolderNameProvider provider = FolderNameProvider.newInstance(mApp.getContext(), mBgAllAppsList.data, mBgDataModel.folders); // åŒæ­¥åŠ è½½æ–‡ä»¶å¤¹åç§° synchronized (mBgDataModel) { // éå†æ–‡ä»¶å¤¹æ•°æ®åˆ—è¡¨ for (int i = 0; i &lt; mBgDataModel.folders.size(); i++) { FolderNameInfos suggestionInfos = new FolderNameInfos(); // è·å–æ–‡ä»¶å¤¹çš„ FolderInfo å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«äº†æ–‡ä»¶å¤¹çš„å†…å®¹åŠç›¸å…³ä¿¡æ¯ FolderInfo info = mBgDataModel.folders.valueAt(i); // ç”Ÿæˆåç§°å»ºè®® if (info.suggestedFolderNames == null) { provider.getSuggestedFolderName(mApp.getContext(), info.contents, suggestionInfos); info.suggestedFolderNames = suggestionInfos; } } } }}","link":"/2024/11/23/Android%20--%20Launcher3%20--%2006.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%20--%20folder/"},{"title":"Android 14.0 Launcher -- Folder è§£æ","text":"å…ˆä¸»è§‚æ„Ÿå—ä¸‹åŸç”Ÿ AOSP é»˜è®¤çš„ Folder æ•ˆæœï¼š åŠ è½½æ–‡ä»¶å¤¹12345678910111213141516171819202122ğŸ“„ æºç è·¯å¾„ï¼špackages/app/Launcher3/src/com/android/launcher3/model/LoaderTask.javapublic class LoaderTask implements Runnable { private void loadFolderNames() { FolderNameProvider provider = FolderNameProvider.newInstance(mApp.getContext(), mBgAllAppsList.data, mBgDataModel.folders); synchronized (mBgDataModel) { for (int i = 0; i &lt; mBgDataModel.folders.size(); i++) { FolderNameInfos suggestionInfos = new FolderNameInfos(); FolderInfo info = mBgDataModel.folders.valueAt(i); if (info.suggestedFolderNames == null) { provider.getSuggestedFolderName(mApp.getContext(), info.contents, suggestionInfos); info.suggestedFolderNames = suggestionInfos; } } } }} FolderIconFolderIcon.java æ˜¯ Launcher3 æ¡Œé¢ç»˜åˆ¶æ–‡ä»¶å¤¹å›¾æ ‡çš„ä¸€ä¸ªå…³é”®çš„ç±»ã€‚ init()1234567891011121314151617181920212223242526272829ğŸ“„ æºç è·¯å¾„ï¼špackages/app/Launcher3/src/com/android/launcher3/folder/FolderIcon.javapublic class FolderIcon extends FrameLayout implements FolderListener, IconLabelDotView, DraggableView, Reorderable { ClippedFolderIconLayoutRule mPreviewLayoutRule; private PreviewItemManager mPreviewItemManager; public FolderIcon(Context context, AttributeSet attrs) { super(context, attrs); // è°ƒç”¨ init() æ–¹æ³•åˆå§‹åŒ– init(); } public FolderIcon(Context context) { super(context); init(); } private void init() { mLongPressHelper = new CheckLongPressHelper(this); // åˆ›å»º ClippedFolderIconLayoutRule å¯¹è±¡ï¼Œè®°ä½è¿™ä¸ª mPreviewLayoutRule ï¼ mPreviewLayoutRule = new ClippedFolderIconLayoutRule(); // åˆ›å»º PreviewItemManager å¯¹è±¡ mPreviewItemManager = new PreviewItemManager(this); mDotParams = new DotRenderer.DrawParams(); }} dispatchDraw()123456789101112131415161718192021222324252627282930313233ğŸ“„ æºç è·¯å¾„ï¼špackages/app/Launcher3/src/com/android/launcher3/folder/FolderIcon.javapublic class FolderIcon extends FrameLayout implements FolderListener, IconLabelDotView, DraggableView, Reorderable { private PreviewItemManager mPreviewItemManager; @Override protected void dispatchDraw(Canvas canvas) { super.dispatchDraw(canvas); if (!mBackgroundIsVisible) return; // æ ¸å¿ƒ 1: é‡æ–°è®¡ç®—å›¾æ ‡çš„å„é¡¹å‚æ•° mPreviewItemManager.recomputePreviewDrawingParams(); if (!mBackground.drawingDelegated()) { mBackground.drawBackground(canvas); } if (mCurrentPreviewItems.isEmpty() &amp;&amp; !mAnimating) return; // æ ¸å¿ƒ 2: ç»˜åˆ¶æ–‡ä»¶å¤¹é¢„è§ˆå›¾ mPreviewItemManager.draw(canvas); if (!mBackground.drawingDelegated()) { mBackground.drawBackgroundStroke(canvas); } drawDot(canvas); }} PreviewItemManagerPreviewItemManager.java ç±»æ˜¯ç”¨æ¥ç®¡ç† FolderIconã€Œæ–‡ä»¶å¤¹é¢„è§ˆå›¾ã€ä¸­ PreviewItemDrawingParamsã€Œæ–‡ä»¶å¤¹ä¸­åº”ç”¨é¢„è§ˆé¡¹ã€â€“ ã€Œç»˜å›¾ã€å’Œã€ŒåŠ¨ç”»å‚æ•°ã€çš„ã€‚ é‡æ–°è®¡ç®—å›¾æ ‡å‚æ•°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100ğŸ“„ æºç è·¯å¾„ï¼špackages/app/Launcher3/src/com/android/launcher3/folder/PreviewItemManager.javapublic class PreviewItemManager { public void recomputePreviewDrawingParams() { if (mReferenceDrawable != null) { // è°ƒç”¨ computePreviewDrawingParams() æ–¹æ³• computePreviewDrawingParams(mReferenceDrawable.getIntrinsicWidth(), mIcon.getMeasuredWidth()); } } private void computePreviewDrawingParams(int drawableSize, int totalSize) { if (mIntrinsicIconSize != drawableSize || mTotalWidth != totalSize || mPrevTopPadding != mIcon.getPaddingTop()) { mIntrinsicIconSize = drawableSize; mTotalWidth = totalSize; mPrevTopPadding = mIcon.getPaddingTop(); mIcon.mBackground.setup(mIcon.getContext(), mIcon.mActivity, mIcon, mTotalWidth, mIcon.getPaddingTop()); // è°ƒç”¨äº† FolderIcon.mPreviewLayoutRule.init() æ–¹æ³•åšä¸€äº›åˆå§‹åŒ–å·¥ä½œ mIcon.mPreviewLayoutRule.init(mIcon.mBackground.previewSize, mIntrinsicIconSize, Utilities.isRtl(mIcon.getResources())); // è°ƒç”¨ updatePreviewItems() æ–¹æ³•ï¼Œæ³¨æ„å‚æ•°ä¼ çš„æ˜¯ false updatePreviewItems(false); } } void updatePreviewItems(boolean animate) { int numOfPrevItemsAux = mFirstPageParams.size(); // è°ƒç”¨ buildParamsForPage() æ–¹æ³•ï¼Œæ³¨æ„ï¼šç¬¬ 3 ä¸ªå‚æ•°æ˜¯ false buildParamsForPage(0, mFirstPageParams, animate); mNumOfPrevItems = numOfPrevItemsAux; } void buildParamsForPage(int page, ArrayList&lt;PreviewItemDrawingParams&gt; params, boolean animate) { // è¿™ä¸ª items æ˜¯ç”¨æ¥å­˜å‚¨å½“å‰åº”ç”¨å›¾æ ‡é¢„è§ˆé¡¹åˆ—è¡¨çš„ List&lt;WorkspaceItemInfo&gt; items = mIcon.getPreviewItemsOnPage(page); // We adjust the size of the list to match the number of items in the preview. while (items.size() &lt; params.size()) { // å…ˆç§»é™¤ params ä¸­çš„ items params.remove(params.size() - 1); } while (items.size() &gt; params.size()) { // å†ä¸€ä¸ªä¸ªæ·»åŠ è¿›å» params.add(new PreviewItemDrawingParams(0, 0, 0)); } int numItemsInFirstPagePreview = page == 0 ? items.size() : MAX_NUM_ITEMS_IN_PREVIEW; for (int i = 0; i &lt; params.size(); i++) { // æ‹¿åˆ°å•ä¸ª PreviewItemDrawingParams å¯¹è±¡ï¼Œè¿™é‡Œçš„ PreviewItemDrawingParams å°±æ˜¯å•ä¸ªåº”ç”¨å›¾æ ‡é¢„è§ˆé¡¹ PreviewItemDrawingParams p = params.get(i); setDrawable(p, items.get(i)); // ä¸Šé¢ä¼ é€’ç¬¬ä¸‰ä¸ªå‚æ•° animate ä¸º falseï¼Œæ‰€ä»¥ä¼šè¿›å…¥è¿™ä¸ª if åˆ¤æ–­ if (!animate) { if (p.anim != null) { p.anim.cancel(); } // è°ƒç”¨ computePreviewItemDrawingParams() æ–¹æ³• computePreviewItemDrawingParams(i, numItemsInFirstPagePreview, p); if (mReferenceDrawable == null) { mReferenceDrawable = p.drawable; } } else { FolderPreviewItemAnim anim = new FolderPreviewItemAnim(this, p, i, mNumOfPrevItems, i, numItemsInFirstPagePreview, DROP_IN_ANIMATION_DURATION, null); if (p.anim != null) { if (p.anim.hasEqualFinalState(anim)) { // do nothing, let the current animation finish continue; } p.anim.cancel(); } p.anim = anim; p.anim.start(); } } } PreviewItemDrawingParams computePreviewItemDrawingParams(int index, int curNumItems, PreviewItemDrawingParams params) { // We use an index of -1 to represent an icon on the workspace for the destroy and // create animations // index ä¸ºæ–‡ä»¶å¤¹ä¸­åº”ç”¨é¢„è§ˆé¡¹çš„ä¸‹æ ‡ï¼Œä¸€èˆ¬æ¥è¯´ &gt;=0 if (index == -1) { return getFinalIconParams(params); } // è°ƒç”¨äº† FolderIcon.mPreviewLayoutRule.computePreviewItemDrawingParams() æ–¹æ³• return mIcon.mPreviewLayoutRule.computePreviewItemDrawingParams(index, curNumItems, params); } private final FolderIcon mIcon;} è¿˜è®°å¾— FolderIcon.mPreviewLayoutRule æ˜¯ä»€ä¹ˆå—ï¼Ÿâ€“ ClippedFolderIconLayoutRule å¯¹è±¡ï¼ ç»˜åˆ¶æ–‡ä»¶å¤¹é¢„è§ˆå›¾12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364```javağŸ“„ æºç è·¯å¾„ï¼špackages/app/Launcher3/src/com/android/launcher3/folder/PreviewItemManager.javapublic class PreviewItemManager { public void draw(Canvas canvas) { int saveCount = canvas.getSaveCount(); // The items are drawn in coordinates relative to the preview offset PreviewBackground bg = mIcon.getFolderBackground(); Path clipPath = bg.getClipPath(); float firstPageItemsTransX = 0; if (mShouldSlideInFirstPage) { PointF firstPageOffset = new PointF(bg.basePreviewOffsetX + mCurrentPageItemsTransX, bg.basePreviewOffsetY); boolean shouldClip = mCurrentPageItemsTransX &gt; mClipThreshold; drawParams(canvas, mCurrentPageParams, firstPageOffset, shouldClip, clipPath); firstPageItemsTransX = -ITEM_SLIDE_IN_OUT_DISTANCE_PX + mCurrentPageItemsTransX; } PointF firstPageOffset = new PointF(bg.basePreviewOffsetX + firstPageItemsTransX, bg.basePreviewOffsetY); boolean shouldClipFirstPage = firstPageItemsTransX &lt; -mClipThreshold; // è°ƒç”¨ drawParams() æ–¹æ³• drawParams(canvas, mFirstPageParams, firstPageOffset, shouldClipFirstPage, clipPath); canvas.restoreToCount(saveCount); } public void drawParams(Canvas canvas, ArrayList&lt;PreviewItemDrawingParams&gt; params, PointF offset, boolean shouldClipPath, Path clipPath) { // è¿™é‡Œä¼ è¿›æ¥çš„ ArrayList&lt;PreviewItemDrawingParams&gt; params å°±æ˜¯æ¯ä¸ªæ–‡ä»¶å¤¹ä¸­åº”ç”¨å›¾æ ‡çš„ List // The first item should be drawn last (ie. on top of later items) for (int i = params.size() - 1; i &gt;= 0; i--) { PreviewItemDrawingParams p = params.get(i); if (!p.hidden) { // Exiting param should always be clipped. boolean isExiting = p.index == EXIT_INDEX; // éå†æ–‡ä»¶å¤¹ä¸­æ¯ä¸ªå›¾æ ‡ï¼Œè¿›è¡Œç»˜åˆ¶ drawPreviewItem(canvas, p, offset, isExiting | shouldClipPath, clipPath); } } } private void drawPreviewItem(Canvas canvas, PreviewItemDrawingParams params, PointF offset, boolean shouldClipPath, Path clipPath) { canvas.save(); if (shouldClipPath) { canvas.clipPath(clipPath); } canvas.translate(offset.x + params.transX, offset.y + params.transY); canvas.scale(params.scale, params.scale); Drawable d = params.drawable; if (d != null) { Rect bounds = d.getBounds(); canvas.save(); canvas.translate(-bounds.left, -bounds.top); canvas.scale(mIntrinsicIconSize / bounds.width(), mIntrinsicIconSize / bounds.height()); d.draw(canvas); canvas.restore(); } canvas.restore(); } } ClippedFolderIconLayoutRule æ–‡ä»¶å¤¹å›¾æ ‡å†…éƒ¨æ˜¾ç¤ºå°å›¾æ ‡ç¼©ç•¥å›¾çš„è®¡ç®—ç±»ï¼Œå¦‚æœä½ è¦å®šåˆ¶ Folderï¼Œè®©å…¶ç¼©ç•¥å›¾æ˜¾ç¤ºä¸º 9 å®«æ ¼çš„æ ·å¼ï¼Œé‚£ä¹ˆæ­¤ç±»æ˜¯å…³é”®ï¼ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166ğŸ“„ æºç è·¯å¾„ï¼špackages/app/Launcher3/src/com/android/launcher3/folder/ClippedFolderIconLayoutRule.javapublic class ClippedFolderIconLayoutRule { // æ–‡ä»¶å¤¹é¢„è§ˆä¸­çš„æœ€å¤§/æœ€å°æ˜¾ç¤ºå›¾æ ‡æ•° public static final int MAX_NUM_ITEMS_IN_PREVIEW = 4; private static final int MIN_NUM_ITEMS_IN_PREVIEW = 2; // ç¼©æ”¾å› å­ï¼šå½“é¢„è§ˆä¸­çš„å›¾æ ‡æ•°é‡è¾ƒå¤šæ—¶ä½¿ç”¨ MIN_SCALEï¼Œè¾ƒå°‘æ—¶ä½¿ç”¨ MAX_SCALE private static final float MIN_SCALE = 0.44f; private static final float MAX_SCALE = 0.51f; // æœ€å¤§åŠå¾„è†¨èƒ€æ¯”ä¾‹ private static final float MAX_RADIUS_DILATION = 0.25f; // é‡å ç³»æ•°ï¼šå…è®¸å›¾æ ‡éƒ¨åˆ†é‡å ä»¥ä¼˜åŒ–è§†è§‰æ•ˆæœ public static final float ICON_OVERLAP_FACTOR = 1 + (MAX_RADIUS_DILATION / 2f); private static final float ITEM_RADIUS_SCALE_FACTOR = 1.15f; // è¡¨ç¤ºè¿›å…¥æˆ–é€€å‡ºæ–‡ä»¶å¤¹æ—¶çš„å›¾æ ‡ç´¢å¼•ï¼Œç”¨äºåŠ¨ç”»é€»è¾‘ public static final int EXIT_INDEX = -2; public static final int ENTER_INDEX = -3; // ä¸´æ—¶æ•°ç»„ï¼Œç”¨äºå­˜å‚¨è®¡ç®—åçš„ x å’Œ y åæ ‡ private float[] mTmpPoint = new float[2]; private float mAvailableSpace; // é¢„è§ˆåŒºåŸŸçš„å¯ç”¨ç©ºé—´ private float mRadius; // å¸ƒå±€ä¸­ç”¨äºæ’åˆ—å›¾æ ‡çš„åœ†å½¢åŠå¾„ private float mIconSize; // å›¾æ ‡å¤§å° private boolean mIsRtl; // æ ‡è¯†å¸ƒå±€æ˜¯å¦ä¸º RTL private float mBaselineIconScale; // åŸºå‡†ç¼©æ”¾å› å­ /** * åˆå§‹åŒ–æ–‡ä»¶å¤¹å›¾æ ‡å¸ƒå±€çš„å…³é”®å‚æ•°ï¼šç©ºé—´å¤§å°ã€å›¾æ ‡å¤§å°å’Œå¸ƒå±€æ–¹å‘ï¼ˆRTLï¼‰ */ public void init(int availableSpace, float intrinsicIconSize, boolean rtl) { mAvailableSpace = availableSpace; mRadius = ITEM_RADIUS_SCALE_FACTOR * availableSpace / 2f; mIconSize = intrinsicIconSize; mIsRtl = rtl; mBaselineIconScale = availableSpace / (intrinsicIconSize * 1f); } /** * è®¡ç®—é¢„è§ˆä¸­çš„å›¾æ ‡ç»˜åˆ¶å‚æ•° */ public PreviewItemDrawingParams computePreviewItemDrawingParams(int index, int curNumItems, PreviewItemDrawingParams params) { float totalScale = scaleForItem(curNumItems); float transX; float transY; if (index == EXIT_INDEX) { // 0 1 * &lt;-- Exit position (row 0, col 2) // 2 3 getGridPosition(0, 2, mTmpPoint); } else if (index == ENTER_INDEX) { // 0 1 // 2 3 * &lt;-- Enter position (row 1, col 2) getGridPosition(1, 2, mTmpPoint); } else if (index &gt;= MAX_NUM_ITEMS_IN_PREVIEW) { // Items beyond those displayed in the preview are animated to the center mTmpPoint[0] = mTmpPoint[1] = mAvailableSpace / 2 - (mIconSize * totalScale) / 2; } else { getPosition(index, curNumItems, mTmpPoint); } transX = mTmpPoint[0]; transY = mTmpPoint[1]; if (params == null) { params = new PreviewItemDrawingParams(transX, transY, totalScale); } else { params.update(transX, transY, totalScale); } return params; } /** * Builds a grid based on the positioning of the items when there are * {@link #MAX_NUM_ITEMS_IN_PREVIEW} in the preview. * * Positions in the grid: 0 1 // 0 is row 0, col 1 * 2 3 // 3 is row 1, col 1 */ /** * ç½‘æ ¼ä½ç½®è®¡ç®—é€»è¾‘ */ private void getGridPosition(int row, int col, float[] result) { // è·å–ç½‘æ ¼ä¸­å·¦ä¸Šè§’ï¼ˆ0å·ä½ç½®ï¼‰çš„åæ ‡ getPosition(0, 4, result); float left = result[0]; float top = result[1]; // è·å–ç½‘æ ¼ä¸­å³ä¸‹è§’ï¼ˆ3å·ä½ç½®ï¼‰çš„åæ ‡ getPosition(3, 4, result); float dx = result[0] - left; float dy = result[1] - top; result[0] = left + (col * dx); result[1] = top + (row * dy); } /** * è®¡ç®—å…·ä½“ä½ç½® */ private void getPosition(int index, int curNumItems, float[] result) { // ç¡®ä¿å½“å‰æ˜¾ç¤ºçš„å›¾æ ‡æ•°é‡è‡³å°‘ä¸º 2 curNumItems = Math.max(curNumItems, 2); // We model the preview as a circle of items starting in the appropriate piece of the // upper left quadrant (to achieve horizontal and vertical symmetry). double theta0 = mIsRtl ? 0 : Math.PI; // In RTL we go counterclockwise int direction = mIsRtl ? 1 : -1; // æ ¹æ®å›¾æ ‡æ•°é‡è°ƒæ•´åˆå§‹è§’åº¦ double thetaShift = 0; if (curNumItems == 3) { thetaShift = Math.PI / 2; } else if (curNumItems == 4) { thetaShift = Math.PI / 4; } theta0 += direction * thetaShift; // We want the items to appear in reading order. For the case of 1, 2 and 3 items, this // is natural for the circular model. With 4 items, however, we need to swap the 3rd and // 4th indices to achieve reading order. if (curNumItems == 4 &amp;&amp; index == 3) { index = 2; } else if (curNumItems == 4 &amp;&amp; index == 2) { index = 3; } // We bump the radius up between 0 and MAX_RADIUS_DILATION % as the number of items increase float radius = mRadius * (1 + MAX_RADIUS_DILATION * (curNumItems - MIN_NUM_ITEMS_IN_PREVIEW) / (MAX_NUM_ITEMS_IN_PREVIEW - MIN_NUM_ITEMS_IN_PREVIEW)); double theta = theta0 + index * (2 * Math.PI / curNumItems) * direction; float halfIconSize = (mIconSize * scaleForItem(curNumItems)) / 2; // Map the location along the circle, and offset the coordinates to represent the center // of the icon, and to be based from the top / left of the preview area. The y component // is inverted to match the coordinate system. result[0] = mAvailableSpace / 2 + (float) (radius * Math.cos(theta) / 2) - halfIconSize; result[1] = mAvailableSpace / 2 + (float) (- radius * Math.sin(theta) / 2) - halfIconSize; } /** * ç¼©æ”¾å› å­è®¡ç®— */ public float scaleForItem(int numItems) { // Scale is determined by the number of items in the preview. final float scale; if (numItems &lt;= 3) { scale = MAX_SCALE; } else { scale = MIN_SCALE; } return scale * mBaselineIconScale; } public float getIconSize() { return mIconSize; }} è®¡ç®—å›¾æ ‡ä½ç½®ï¼šgetPosition()12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667private void getPosition(int index, int curNumItems, float[] result) { // ç¡®ä¿å½“å‰æ˜¾ç¤ºçš„å›¾æ ‡æ•°é‡è‡³å°‘ä¸º 2 curNumItems = Math.max(curNumItems, 2); /** * ç¡®å®šåˆå§‹è§’åº¦ï¼ŒRTL å¸ƒå±€ä» 0 åº¦å¼€å§‹ï¼Œé RTL ä» Ï€ï¼ˆ180 åº¦ï¼‰å¼€å§‹ * * è¿™é‡Œæˆ‘ä»¬ä¸è€ƒè™‘ RTL çš„æƒ…å†µï¼Œæ‰€ä»¥åç»­åˆ†æé»˜è®¤ä»¥ 0 åº¦ä¸ºåˆå§‹è§’åº¦ */ double theta0 = mIsRtl ? 0 : Math.PI; /** * ç¡®å®šæ–¹å‘ï¼šRTL é¡ºæ—¶é’ˆï¼Œé RTL é€†æ—¶é’ˆ * * è¿™é‡Œæˆ‘ä»¬ä¸è€ƒè™‘ RTL çš„æƒ…å†µï¼Œæ‰€ä»¥åç»­é»˜è®¤ä¸ºï¼šé€†æ—¶é’ˆæ–¹å‘ */ int direction = mIsRtl ? 1 : -1; /** * æ ¹æ®å­é¡¹æ•°é‡è°ƒæ•´è§’åº¦åç§» * * æˆ‘ä»¬å…ˆä»¥ curNumItems = 4 ä¸ªå›¾æ ‡ä¸ºä¾‹ */ double thetaShift = 0; if (curNumItems == 3) { thetaShift = Math.PI / 2; // 90 åº¦åç§» } else if (curNumItems == 4) { thetaShift = Math.PI / 4; // 45 åº¦åç§» } /** * åˆå§‹è§’åº¦ï¼šdirection -&gt; -1 * index: 0 -&gt; theta0 = 135 åº¦ï¼ˆ2.356194490192345ï¼‰ * index: 1 -&gt; theta0 = 135 åº¦ï¼ˆ2.356194490192345ï¼‰ * index: 2 -&gt; theta0 = 135 åº¦ï¼ˆ2.356194490192345ï¼‰ * index: 3 -&gt; theta0 = 135 åº¦ï¼ˆ2.356194490192345ï¼‰ */ theta0 += direction * thetaShift; // ç¡®ä¿ 4 ä¸ªå­é¡¹æ—¶ï¼Œç¬¬ 3 å’Œç¬¬ 4 é¡¹äº’æ¢ï¼Œä¿è¯é˜…è¯»é¡ºåº if (curNumItems == 4 &amp;&amp; index == 3) { index = 2; } else if (curNumItems == 4 &amp;&amp; index == 2) { index = 3; } // æ ¹æ®å­é¡¹æ•°é‡å¢åŠ åŠå¾„ï¼Œè¶Šå¤šå›¾æ ‡ï¼ŒåŠå¾„è¶Šå¤§ï¼Œç¡®ä¿å›¾æ ‡åˆç†åœ°åˆ†æ•£å¼€ // MAX_RADIUS_DILATION æ§åˆ¶äº†å›¾æ ‡æœ€å¤§èƒ½è†¨èƒ€çš„æ¯”ä¾‹ float radius = mRadius * (1 + MAX_RADIUS_DILATION * (curNumItems - MIN_NUM_ITEMS_IN_PREVIEW) / (MAX_NUM_ITEMS_IN_PREVIEW - MIN_NUM_ITEMS_IN_PREVIEW)); /** * è®¡ç®—å½“å‰å­é¡¹çš„è§’åº¦ï¼š * index: 0 -&gt; theta = PI*3/4 - 0 = PI*3/4 (2.356194490192345) * index: 1 -&gt; theta = PI*3/4 - PI*1/2 = PI/4 (0.7853981633974483) * index: 2 -&gt; theta = PI*3/4 - PI = -PI/4 (-0.7853981633974483) * index: 3 -&gt; theta = PI*3/4 - PI*3/2 = -PI*3/4 (-2.356194490192345) */ double theta = theta0 + index * (2 * Math.PI / curNumItems) * direction; // è®¡ç®—å›¾æ ‡å¤§å°çš„ä¸€åŠï¼Œç”¨äºè°ƒæ•´ä½ç½®åˆ°å›¾æ ‡ä¸­å¿ƒ float halfIconSize = (mIconSize * scaleForItem(curNumItems)) / 2; // ä½¿ç”¨æåæ ‡è®¡ç®— x å’Œ y åæ ‡ï¼Œå¹¶è°ƒæ•´ä¸ºä»é¢„è§ˆåŒºåŸŸçš„ä¸­å¿ƒå¼€å§‹ result[0] = mAvailableSpace / 2 + (float) (radius * Math.cos(theta) / 2) - halfIconSize; result[1] = mAvailableSpace / 2 + (float) (- radius * Math.sin(theta) / 2) - halfIconSize;} æ€»ç»“ä¸‹ getPosition() æ–¹æ³•çš„è®¡ç®—æ€è·¯ï¼š 1. åœ¨æ–‡ä»¶å¤¹é¢„è§ˆå›¾æ ‡å¸ƒå±€ä¸­ï¼Œå›¾æ ‡ä¸æ˜¯éšæœºåˆ†å¸ƒçš„ï¼Œè€Œæ˜¯ã€Œå›´ç»•æ–‡ä»¶å¤¹å›¾æ ‡ä¸­å¿ƒã€å‡åŒ€æ’åˆ—çš„ã€‚ å®ç°æ–¹æ³•å°±æ˜¯ï¼šä»¥ä¸­å¿ƒç‚¹ä¸ºåœ†å¿ƒç»˜åˆ¶ä¸€ä¸ªåœ†ï¼Œå„ä¸ªåº”ç”¨çš„å›¾æ ‡ä¸­å¿ƒéƒ½åœ¨åœ†ä¸Šï¼Œä¸”å„ä¸ªå›¾æ ‡ä¹‹é—´çš„è·ç¦»(è§’åº¦)ç›¸ç­‰å³å¯ï¼› 2. è®¡ç®—åº”ç”¨å›¾æ ‡ä¸­å¿ƒè·ç¦»æ–‡ä»¶å¤¹å›¾æ ‡ä¸­å¿ƒçš„åŠå¾„ å›¾æ ‡æ•°é‡ä¸åŒæ—¶ï¼Œç»˜åˆ¶çš„å¤§å°å’ŒåŒºåŸŸä¹Ÿä¸ä¸€æ ·ï¼Œè¿™é‡Œä½¿ç”¨ä¸€ä¸ªçº¿æ€§æ’å€¼å…¬å¼ï¼Œæ ¹æ®å½“å‰é¢„è§ˆå›¾æ ‡æ•°é‡(curNumItems)ç›¸å¯¹äºé¢„è§ˆå›¾æ ‡çš„æœ€å°å’Œæœ€å¤§æ•°é‡(2 å’Œ 4)çš„æ¯”ä¾‹ï¼Œæ¥è°ƒæ•´åŠå¾„ radius çš„å¤§å°ï¼š 1234567891011121314private static final float ITEM_RADIUS_SCALE_FACTOR = 1.15f;mRadius = ITEM_RADIUS_SCALE_FACTOR * availableSpace / 2f;// åˆå§‹ mRadius:mRadius = 1.15 * availableSpace / 2f;// æ ¹æ®é¢„è§ˆå›¾æ•°é‡é‡æ–°è®¾å®šåŠå¾„ radius:private static final float MAX_RADIUS_DILATION = 0.25f;float radius = mRadius * (1 + MAX_RADIUS_DILATION * (curNumItems - MIN_NUM_ITEMS_IN_PREVIEW) / (MAX_NUM_ITEMS_IN_PREVIEW - MIN_NUM_ITEMS_IN_PREVIEW));curNumItems = 2ï¼Œradius = mRadiuscurNumItems = 3ï¼Œradius = 1.125 * mRadiuscurNumItems = 4ï¼Œradius = 1.25 * mRadius 3. æ ¹æ®å½“å‰é¢„è§ˆå›¾æ ‡æ•°é‡(curNumItems)å°†è¿™ä¸ªåœ†å¹³å‡ï¼Œå¹¶æ ¹æ®ã€Œæåæ ‡ç³»ã€è®¡ç®—æ¯ä¸ªåº”ç”¨å›¾æ ‡ä¸­å¿ƒç‚¹çš„ã€Œæåæ ‡ã€ 123456789101112131415161718192021222324252627// è®¡ç®—æ¯ä¸ªåº”ç”¨çš„åˆå§‹åŒ–è§’åº¦double theta = theta0 + index * (2 * Math.PI / curNumItems) * direction;curNumItems = 2ï¼šä¸¤ä¸ªåº”ç”¨åœ¨ä¸­å¿ƒç‚¹çš„ä¸¤ä¾§ï¼Œä¸¤ä¸ªå›¾æ ‡åœ¨åŒä¸€æ°´å¹³çº¿ä¸Š | | index: 0 -&gt; theta = PI -(0)-+-(1)- index: 1 -&gt; theta = 0 | |curNumItems = 3ï¼šä¸‰ä¸ªå›¾æ ‡æŒ‰å“å­—æ’åˆ—ï¼Œç¬¬ä¸€ä¸ªåœ¨é¡¶éƒ¨ï¼Œé¡ºæ—¶é’ˆæ’åˆ— | (0) index: 0 -&gt; theta = PI/2 -----+----- index: 1 -&gt; theta = -PI/6 (2) | (1) index: 2 -&gt; theta = -PI*5/6ï¼› |curNumItems = 4ï¼šå››ä¸ªå›¾æ ‡æŒ‰ 2x2 æ’åˆ— | (0) | (1) index: 0 -&gt; theta = PI*3/4 -----+----- index: 1 -&gt; theta = PI/4 (2) | (3) index: 2 -&gt; index = 3 -&gt; theta = -PI/4 | index: 3 -&gt; index = 2 -&gt; theta = -PI*3/4 4. è®¡ç®—åº”ç”¨å›¾æ ‡å·¦ä¸Šè§’çš„ xã€y åæ ‡ 12result[0] = mAvailableSpace / 2 + (float) (radius * Math.cos(theta) / 2) - halfIconSize;result[1] = mAvailableSpace / 2 + (float) (-radius * Math.sin(theta) / 2) - halfIconSize; æˆ‘ä»¬æ¥çœ‹ä¸‹ 4 ä¸ªå›¾æ ‡çš„ä½ç½®ç¡®å®šè¿‡ç¨‹ï¼š ç¬¬ 1 ä¸ªå›¾æ ‡ï¼šindex = 0 theta = PI*3/4 ç¬¬ 2 ä¸ªå›¾æ ‡ï¼šindex = 1 theta = PI/4 è¿™ä¸¤å¼ å›¾å·²ç»å®Œç¾è¯ é‡Šäº†ä½ç½®è·å–çš„ç®—æ³•é€»è¾‘ï¼Œindex = 2 / index = 3 æˆ‘å°±ä¸å†ç”»å›¾äº†ï¼Œç•™ç»™å¤§å®¶è‡ªå·±ç ”ç©¶å§ã€‚ ç”±ä¸Šé¢çš„åˆ†ææˆ‘ä»¬å‘ç°ï¼Œå½±å“ä½ç½®è®¡ç®—ç»“æœçš„ä¸»è¦å‚æ•°ä¸ºï¼š mAvailableSpace: æ–‡ä»¶å¤¹å›¾æ ‡å¤§å°ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šå¯¹ä»–åšæ”¹åŠ¨ mIconSize: ç¼©æ”¾ç³»æ•° radius: åŠå¾„ï¼Œå½±å“åº”ç”¨å›¾æ ‡ç¦»ä¸­å¿ƒç‚¹çš„è·ç¦» theta: è§’åæ ‡ ä¹å®«æ ¼å®šåˆ¶ç¡¬æ ¸æ”¹æ³•å¦‚æœä½ ç†è§£é€å½»äº† getPosition() æ–¹æ³•çš„å›¾æ ‡è®¡ç®—é€»è¾‘ï¼Œé‚£æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è‡ªå·±åˆ†æå¤„ç† 9 å®«æ ¼çš„å¸ƒå±€ç®—æ³•ï¼š é€šç”¨æ”¹æ³• æ—¢ç„¶éœ€è¦æ”¯æŒ 9 å®«æ ¼å¸ƒå±€ï¼Œé‚£é¦–å…ˆæœ€å¤§æ”¯æŒå›¾æ ‡æ•°å¾—ä¿®æ”¹ä¸º 9: 1public static final int MAX_NUM_ITEMS_IN_PREVIEW = 9; æ„æ–™ä¹‹ä¸­çš„æƒ…å†µï¼Œæˆ‘ä»¬å¿…é¡»é‡æ–°å®šä¹‰ getPositon() çš„ç®—æ³•ï¼š 123456789101112131415161718192021222324252627282930public PreviewItemDrawingParams computePreviewItemDrawingParams(int index, int curNumItems, PreviewItemDrawingParams params) { float totalScale = scaleForItem(curNumItems); float transX; float transY; if (index == EXIT_INDEX) { ... } else { // getPosition(index, curNumItems, mTmpPoint); // å›ºå®šä¹å®«æ ¼çš„æ ·å¼ï¼Œæˆ‘ä»¬æ— éœ€ curNumItems å‚æ•° get9Position(index, mTmpPoint); } ...}// é‡æ–°å®šä¹‰ getPosition() ç®—æ³•private void get9Position(int index, float[] result) { int x = index % 3; // ç¬¬å‡ åˆ— int y = index / 3; // ç¬¬å‡ è¡Œ float iconSize = mAvailableSpace / 3; if (mIsRtl) { result[0] = iconSize * (2 - x); } else { result[0] = iconSize * x; } result[1] = iconSize * y;} å›¾æ ‡å¤ªå¤§äº†ï¼Œæˆ‘ä»¬è°ƒæ•´ä¸‹ç¼©æ”¾å› å­ï¼š 12// private static final float MIN_SCALE = 0.44f;private static final float MIN_SCALE = 0.28f; ç°åœ¨çš„å›¾æ ‡ä½ç½®æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¹‹å‰çš„ä»£ç æ˜¯å¼ºåˆ¶å›¾æ ‡å æ®ç©ºé—´ä¸ºï¼šmAvailableSpace/3ï¼Œæ˜¯éœ€è¦è¿›è¡Œè°ƒæ•´çš„ï¼š 1234567891011121314private void get9Position(int index, float[] result) { int x = index % 3; int y = index / 3; // float iconSize = mAvailableSpace / 3; float iconSize = mAvailableSpace * MIN_SCALE; if (mIsRtl) { result[0] = iconSize * (2 - x); } else { result[0] = iconSize * x; } result[1] = iconSize * y;} ç°åœ¨æˆ‘ä»¬å‰©ä¸‹æœ€åä¸€æ­¥ï¼Œå°±æ˜¯è°ƒæ•´ 9 å®«æ ¼å›¾ï¼Œè®©å›¾æ ‡å½¼æ­¤ä¹‹é—´çš„é—´è·å¹³å‡ï¼š 1234567891011121314151617181920212223// æ–°å®šä¹‰é¢„è§ˆå›¾é—´è· private float mPreviewGap; public void init(int availableSpace, float intrinsicIconSize, boolean rtl) { ... // æ€»å¯ç”¨ç©ºé—´ - 3 ä¸ªå›¾æ ‡å ç”¨ç©ºé—´ = å‰©ä½™ç©ºé—´ // å°†å‰©ä½™ç©ºé—´å¹³å‡åˆ†é…æˆ 4 æ®µï¼Œå› ä¸ºæœ‰ 3 ä¸ªå›¾æ ‡å°±æœ‰ 4 ä¸ªé—´éš” mPreviewGap = (mAvailableSpace - mAvailableSpace * MIN_SCALE * 3) / 4f; } private void get9Position(int index, float[] result) { int x = index % 3; int y = index / 3; float iconSize = mAvailableSpace * MIN_SCALE; if (mIsRtl) { result[0] = mPreviewGap + (iconSize + mPreviewGap) * (2 - x); } else { result[0] = mPreviewGap + (iconSize + mPreviewGap) * x; } result[1] = mPreviewGap + (iconSize + mPreviewGap) * y; } å‚è€ƒhttps://blog.csdn.net/baidu_41666295/article/details/134936794","link":"/2024/11/29/Android%20--%20Launcher3%20--%2011.%20Folder%20%E4%B9%9D%E5%AE%AB%E6%A0%BC%E8%A7%A3%E6%9E%90/"},{"title":"æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- Workspace","text":"å‰è¨€æˆ‘ä»¬å…ˆå¤§æ¦‚äº†è§£æœ¬ç¯‡æ–‡ç« æ¶‰åŠåˆ°çš„å‡ ä¸ªé‡è¦çš„ç±»ï¼š æ ¸å¿ƒç±» è·¯å¾„ LauncherModel Launcher æ•°æ®å¤„ç†æ ¸å¿ƒç±» LoaderTask ä¸»è¦ä»»åŠ¡è´Ÿè´£åŠ è½½æ•°æ®ï¼ˆworkspaceã€all appsï¼‰å’Œç»‘å®šæ•°æ®ï¼ˆworkspaceã€all appsï¼‰ AutoInstallsLayout InvariantDeviceProfile æ¡Œé¢çš„ä¸€äº›é…ç½®ï¼Œæ¯”å¦‚é»˜è®¤å¸ƒå±€æ–‡ä»¶ BgDataModel ç”¨æ¥æ”¾å¸ƒå±€ç›¸å…³çš„é›†åˆ WorkspaceItemInfoFolderInfoLauncherAppWidgetInfo éƒ½æ˜¯ç»§æ‰¿è‡ª ItemInfoï¼Œä¿å­˜æ¡Œé¢å›¾æ ‡çš„ä¸€äº›ä¿¡æ¯ï¼šå›¾æ ‡ä½ç½®ï¼Œå®½é«˜ï¼Œç±»å‹ç­‰ä¿¡æ¯ Step1: Workspace Workspace çš„å·¥ä½œä¸»è¦åˆ†ä¸ºï¼šã€ŒåŠ è½½ã€å’Œã€Œç»‘å®šã€ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥åˆ†æã€‚ åŠ è½½ Workspace æµç¨‹è§£ææ ¸å¿ƒæ–¹æ³•ï¼šloadWorkspace() è´Ÿè´£åŠ è½½ Workspaceï¼Œå®ƒä¸»è¦åš 2 ä»¶äº‹æƒ…ï¼š è·å–æ•°æ®åº“ ä»æ•°æ®åº“è¯»å–ä¿¡æ¯å­˜æ”¾åˆ° sBgDataModel ä¸­ ä½ å…ˆæœ‰ä¸ªæ¦‚å¿µï¼Œç„¶åæˆ‘ä»¬å¼€å§‹åˆ†ææºç ï¼Œä»£ç èµ°èµ·ï½ 12345678910111213141516171819202122232425262728293031323334353637383940414243ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/LoaderTask.javapublic class LoaderTask implements Runnable { /** * run() -&gt; loadWorkspace(allShortcuts, &quot;&quot;, memoryLogger); * * 1. allDeepShortcuts: å­˜å‚¨åº”ç”¨å¿«æ·æ–¹å¼çš„åˆ—è¡¨ï¼Œé»˜è®¤æ˜¯ç©ºçš„ * 2. selection: å¯ä»¥æŒ‡å®šé€‰æ‹©æ¡ä»¶ï¼Œç”¨äºè¿‡æ»¤ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ä¼ å…¥ä»»ä½•æ¡ä»¶çš„ * 3. memoryLogger: æ˜¯ä¸€ä¸ª LoaderMemoryLoggerï¼Œæ˜¯ä¸€ä¸ªè¾…åŠ©è®°å½•å™¨ï¼Œç”¨äºæ•è·è®°å½• * LoaderTask çš„ run() æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿçš„å¼‚å¸¸åŠå†…å­˜ä½¿ç”¨æƒ…å†µ */ protected void loadWorkspace( List&lt;ShortcutInfo&gt; allDeepShortcuts, String selection, LoaderMemoryLogger memoryLogger) { // å¼€å§‹æ€§èƒ½è¿½è¸ªï¼Œç”¨äºæ€§èƒ½è°ƒè¯•å’Œç›‘æ§ Trace.beginSection(&quot;LoadWorkspace&quot;); try { /*********************************** * æ ¸å¿ƒæ–¹æ³•ï¼šè´Ÿè´£åŠ è½½å·¥ä½œåŒºå†…å®¹çš„ä¸»è¦é€»è¾‘ ***********************************/ loadWorkspaceImpl(allDeepShortcuts, selection, memoryLogger); } finally { // ç»“æŸæ€§èƒ½è·Ÿè¸ª Trace.endSection(); } // è®°å½•å·¥ä½œåŒºåŠ è½½è¿‡ç¨‹çš„æ—¥å¿—ï¼Œç”¨äºæ€§èƒ½åˆ†ææˆ–è°ƒè¯• logASplit(&quot;loadWorkspace&quot;); if (FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) { // ç¡®ä¿ Loader åŠ è½½è¿‡ç¨‹æ²¡æœ‰è¢«ä¸­æ­¢ verifyNotStopped(); // ä½¿ç”¨ ModelDelegate åŠ è½½å¹¶ç»‘å®šå·¥ä½œåŒºé¡¹ï¼ˆWorkspace Itemsï¼‰ mModelDelegate.loadAndBindWorkspaceItems(mUserManagerState, mLauncherBinder.mCallbacksList, mShortcutKeyToPinnedShortcuts); // æ ‡è®° ModelDelegate ä¸ºæ´»åŠ¨çŠ¶æ€ï¼Œè¡¨ç¤ºå®ƒå·²æˆåŠŸåŠ è½½å¹¶ç»‘å®šå·¥ä½œåŒºé¡¹ã€‚ mModelDelegate.markActive(); logASplit(&quot;workspaceDelegateItems&quot;); } }} æˆ‘ä»¬ç»§ç»­è·Ÿè¸ª loadWorkspaceImpl() æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/LoaderTask.javapublic class LoaderTask implements Runnable { protected final LauncherAppState mApp; /** * run() -&gt; loadWorkspace(allShortcuts, &quot;&quot;, memoryLogger); * -&gt; loadWorkspaceImpl(allDeepShortcuts, selection, memoryLogger); * * 1. allDeepShortcuts: å­˜å‚¨åº”ç”¨å¿«æ·æ–¹å¼çš„åˆ—è¡¨ï¼Œé»˜è®¤æ˜¯ç©ºçš„ * 2. selection: å¯ä»¥æŒ‡å®šé€‰æ‹©æ¡ä»¶ï¼Œç”¨äºè¿‡æ»¤ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ä¼ å…¥ä»»ä½•æ¡ä»¶çš„ * 3. memoryLogger: æ˜¯ä¸€ä¸ª LoaderMemoryLoggerï¼Œæ˜¯ä¸€ä¸ªè¾…åŠ©è®°å½•å™¨ï¼Œç”¨äºæ•è·è®°å½• * LoaderTask çš„ run() æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿçš„å¼‚å¸¸åŠå†…å­˜ä½¿ç”¨æƒ…å†µ */ private void loadWorkspaceImpl( List&lt;ShortcutInfo&gt; allDeepShortcuts, String selection, @Nullable LoaderMemoryLogger memoryLogger) { // mApp å°±æ˜¯ï¼šLauncherAppStateï¼Œå®ƒä¼šæŒæœ‰åº”ç”¨çš„ Context å¯¹è±¡ï¼Œä½¿å¾—åº”ç”¨çš„å„ä¸ªéƒ¨åˆ† // èƒ½å¤Ÿè®¿é—®å…¨å±€çš„ Contextï¼Œä»è€Œè¿›è¡Œèµ„æºè®¿é—®ã€å¯åŠ¨æœåŠ¡ã€å¹¿æ’­ç­‰æ“ä½œ final Context context = mApp.getContext(); // åç»­ç”¨äºæŸ¥è¯¢ã€æ’å…¥ã€åˆ é™¤æˆ–æ›´æ–°æ•°æ® final ContentResolver contentResolver = context.getContentResolver(); // è‡ªå®šä¹‰çš„åŒ…ç®¡ç†çš„è¾…åŠ©ç±» final PackageManagerHelper pmHelper = new PackageManagerHelper(context); // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å¤„äºå®‰å…¨æ¨¡å¼ final boolean isSafeMode = pmHelper.isSafeMode(); // æ£€æŸ¥è®¾å¤‡çš„å¯åŠ¨æ˜¯å¦å·²å®Œæˆï¼Œé€šå¸¸è¿™æ„å‘³ç€ SD å¡å·²ç»æŒ‚è½½å¹¶å¯ä»¥è®¿é—® final boolean isSdCardReady = Utilities.isBootCompleted(); // ç”¨äºç®¡ç†æ¡Œé¢å°éƒ¨ä»¶çš„å¸®åŠ©ç±» final WidgetManagerHelper widgetHelper = new WidgetManagerHelper(context); // è®¾å®šäº†ä¸€ä¸ªæ¸…é™¤æ•°æ®åº“çš„æ ‡å¿—ä½ boolean clearDb = false; /** æ£€æŸ¥æ˜¯å¦éœ€è¦è¿›è¡Œæ•°æ®åº“è¿ç§»ã€‚å¦‚æœè¿ç§»å¤±è´¥ï¼Œåˆ™æ¸…ç†æ•´ä¸ªæ•°æ®åº“ï¼Œè¿™é€šå¸¸å‘ç”Ÿåœ¨æ•°æ®æ¨¡å‹å‘ç”Ÿè¾ƒå¤§å˜æ›´æ—¶ * * mApp.getModel() -&gt; LauncherModel * mApp.getModel().getModelDbController() -&gt; ModelDbController * * ä¸€èˆ¬æ˜¯æ— éœ€è¿ç§»çš„ï¼Œè¿™è¾¹é»˜è®¤ä¸º trueï¼Œæ‰€ä»¥ä¸ä¼šèµ°æ­¤åˆ†æ”¯ï¼ŒclearDb ä»ä¸º false */ if (!mApp.getModel().getModelDbController().migrateGridIfNeeded()) { // Migration failed. Clear workspace. // è¿ç§»å¤±è´¥ clearDb = true; } // é‡ç½®æ•°æ®åº“ if (clearDb) { Log.d(TAG, &quot;loadWorkspace: resetting launcher database&quot;); Settings.call(contentResolver, Settings.METHOD_CREATE_EMPTY_DB); } Log.d(TAG, &quot;loadWorkspace: loading default favorites&quot;); /********************************************************************* * æ ¸å¿ƒå…³æ³¨ç‚¹ 1ï¼šåŠ è½½é»˜è®¤æ¡Œé¢å¸ƒå±€ * * ä¼šè°ƒç”¨åˆ° LauncherProvider çš„ loadDefaultFavoritesIfNecessary() æ–¹æ³•ï¼Œ * è¿™ä¸ªæ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åŠ è½½é»˜è®¤çš„å¸ƒå±€ï¼Œå¦‚æœæ¸…é™¤äº†æ¡Œé¢æ•°æ® * æˆ–è€…æ‰‹æœºæ¢å¤äº†å‡ºå‚è®¾ç½®ï¼Œå°±ä¼šåŠ è½½é»˜è®¤çš„å¸ƒå±€ ********************************************************************/ Settings.call(contentResolver, Settings.METHOD_LOAD_DEFAULT_FAVORITES); // åŠ è½½æ•°æ®åº“ï¼ˆæˆ‘ä»¬æ”¾åœ¨åé¢åˆ†æï¼‰ ... } } åŠ è½½é»˜è®¤æ¡Œé¢å¸ƒå±€Settings.call() æ˜¯ LauncherSettings å†…éƒ¨çš„é™æ€æ–¹æ³•ï¼š 1234567891011121314151617181920212223ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/LauncherSettings.javapublic class LauncherSettings { /** * Launcher settings */ public static final class Settings { // CONTENT_URI æ˜¯ä¸€ä¸ª Uri å¯¹è±¡ï¼Œè¡¨ç¤ºå†…å®¹æä¾›è€…çš„ URI åœ°å€ï¼Œè¿™æ˜¯ä¸ LauncherProvider äº¤äº’çš„å…¥å£ç‚¹ public static final Uri CONTENT_URI = Uri.parse(&quot;content://&quot; + LauncherProvider.AUTHORITY + &quot;/settings&quot;); public static final String METHOD_LOAD_DEFAULT_FAVORITES = &quot;load_default_favorites&quot;; public static Bundle call(ContentResolver cr, String method) { return call(cr, method, null /* arg */); } public static Bundle call(ContentResolver cr, String method, String arg) { return cr.call(CONTENT_URI, method, arg, null); } }} ç´§æ¥ç€è¿›å…¥ LauncherProvider.call() æ–¹æ³•ï¼š 123456789101112131415161718192021222324ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/LauncherProvider.javapublic class LauncherProvider extends ContentProvider { /** * method: &quot;load_default_favorites&quot; * arg. : null * extras: null */ @Override public Bundle call(String method, final String arg, final Bundle extras) { switch (method) { ... case LauncherSettings.Settings.METHOD_LOAD_DEFAULT_FAVORITES: { getModelDbController().loadDefaultFavoritesIfNecessary(); return null; } ... } }} ç»§ç»­è·Ÿè¸ª loadDefaultFavoritesIfNecessary() ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/ModelDbController.javapublic class ModelDbController { /** * Loads the default workspace based on the following priority scheme: * 1) From the app restrictions * 2) From a package provided by play store * 3) From a partner configuration APK, already in the system image * 4) The default configuration for the particular device * * 1) æ¥è‡ªåº”ç”¨é™åˆ¶ * 2) æ¥è‡ª Play å•†åº—æä¾›çš„è½¯ä»¶åŒ… * 3) æ¥è‡ªå·²é›†æˆåœ¨ image ä¸­çš„åˆä½œä¼™ä¼´é…ç½®çš„ APK * 4) ç‰¹å®šè®¾å¤‡çš„é»˜è®¤é…ç½® */ @WorkerThread public synchronized void loadDefaultFavoritesIfNecessary() { // ç¡®ä¿æ•°æ®åº“å·²åˆ›å»ºã€‚å¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“æ–‡ä»¶ createDbIfNotExists(); // æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†ç©ºæ•°æ®åº“ï¼Œå¦‚æœæ¸…é™¤äº† Launcher æ•°æ®ï¼Œåˆ™ä¼šä¸º true if (LauncherPrefs.get(mContext).get(getEmptyDbCreatedKey(mOpenHelper.getDatabaseName()))) { // LauncherWidgetHolder æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†å°éƒ¨ä»¶çš„å®¹å™¨ï¼Œåœ¨åŠ è½½å¸ƒå±€æ—¶ç”¨æ¥ä¿å­˜å’Œå¤„ç†å°éƒ¨ä»¶ä¿¡æ¯ LauncherWidgetHolder widgetHolder = mOpenHelper.newLauncherWidgetHolder(); try { // 1. å°è¯•ä»ç³»ç»Ÿé…ç½®çš„ launcher3.layout.provider æä¾›çš„ provider é‡Œé¢è·å–å¸ƒå±€èµ„æº AutoInstallsLayout loader = createWorkspaceLoaderFromAppRestriction(widgetHolder); if (loader == null) { /** * 2. å°è¯•ä»å¸¦æœ‰ * android.autoinstalls.config.action.PLAY_AUTO_INSTALL çš„ apk é‡Œé¢ * è·å–å¸ƒå±€èµ„æº */ loader = AutoInstallsLayout.get(mContext, widgetHolder, mOpenHelper); } if (loader == null) { /** * 3. å°è¯•ä»ç³»ç»Ÿå†…ç½®çš„ Partner åº”ç”¨é‡Œè·å– workspace é»˜è®¤é…ç½® * è¿™ä¸ªåŠŸèƒ½æ˜¯æä¾›ç»™æä¾›å¸ƒå±€çš„ç¬¬ä¸‰æ–¹åº”ç”¨ */ final Partner partner = Partner.get(mContext.getPackageManager()); if (partner != null) { int workspaceResId = partner.getXmlResId(RES_PARTNER_DEFAULT_LAYOUT); if (workspaceResId != 0) { loader = new DefaultLayoutParser(mContext, widgetHolder, mOpenHelper, partner.getResources(), workspaceResId); } } } // ç¡®å®šæ˜¯å¦ä½¿ç”¨äº†å¤–éƒ¨æä¾›çš„å¸ƒå±€ final boolean usingExternallyProvidedLayout = loader != null; if (loader == null) { // 4. å°è¯•è·å– Launcher é‡Œçš„é»˜è®¤èµ„æºï¼Œæ¯”å¦‚ @xml/default_workspace_5x5 loader = getDefaultLayoutParser(widgetHolder); } // There might be some partially restored DB items, due to buggy restore logic in // previous versions of launcher. // æ¸…ç©ºæ•°æ®åº“ mOpenHelper.createEmptyDB(mOpenHelper.getWritableDatabase()); // Populate favorites table with initial favorites // è§£æå¸ƒå±€æ–‡ä»¶å¹¶å†™å…¥æ•°æ®åº“ // é¦–å…ˆä½¿ç”¨ä¸Šé¢å¾—åˆ°çš„ loader è·å–ï¼Œå¦‚æœè¯¥ loader æä¾›çš„æ–¹å¼é‡Œé¢ä¸ºç©ºçš„å¸ƒå±€ï¼Œ // é‚£ä¹ˆè¿˜æ˜¯ä½¿ç”¨ä¸Šé¢ç¬¬ 4 æ­¥çš„ loader if ((mOpenHelper.loadFavorites(mOpenHelper.getWritableDatabase(), loader) &lt;= 0) &amp;&amp; usingExternallyProvidedLayout) { // Unable to load external layout. Cleanup and load the internal layout. mOpenHelper.createEmptyDB(mOpenHelper.getWritableDatabase()); mOpenHelper.loadFavorites(mOpenHelper.getWritableDatabase(), getDefaultLayoutParser(widgetHolder)); } // æ¸…ç†ç©ºæ•°æ®åº“åˆ›å»ºçš„æ ‡å¿—ï¼Œè¡¨ç¤ºæ•°æ®åº“å·²ç»å‡†å¤‡å¥½äº†ã€‚ clearFlagEmptyDbCreated(); } finally { // æ— è®ºæ–¹æ³•æ˜¯å¦æˆåŠŸæ‰§è¡Œï¼Œéƒ½é”€æ¯ widgetHolder å®ä¾‹ï¼Œé‡Šæ”¾ç›¸å…³èµ„æº widgetHolder.destroy(); } } }} æˆ‘ä»¬æ¥çœ‹ä¸‹ç¬¬ 4 æ­¥åŠ è½½ Launcher é»˜è®¤çš„å¸ƒå±€èµ„æºç›¸å…³é€»è¾‘ï¼š 123456789101112131415161718192021222324252627ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/ModelDbController.javapublic class ModelDbController { private DefaultLayoutParser getDefaultLayoutParser(LauncherWidgetHolder widgetHolder) { /** * è·å– InvariantDeviceProfile å®ä¾‹ï¼Œå®ƒä»£è¡¨äº†è®¾å¤‡çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å¸ƒå±€ç›¸å…³çš„è®¾ç½® */ InvariantDeviceProfile idp = LauncherAppState.getIDP(mContext); /** * è·å–é»˜è®¤å¸ƒå±€èµ„æºidï¼Œæ¯”å¦‚ï¼š@xml/default_workspace_5x5 * * demoModeLayoutIdï¼šæ˜¯å¦ä¸ºæ¼”ç¤ºæ¨¡å¼ * 1. å¦‚æœæ˜¯åˆ™è°ƒç”¨æ¼”ç¤ºæ¨¡å¼çš„å¸ƒå±€ id -&gt; idp.demoModeLayoutId * 2. å¦‚ä¸æ˜¯åˆ™è°ƒç”¨å†…éƒ¨é»˜è®¤çš„å¸ƒå±€ id -&gt; idp.defaultLayoutId -&gt; æˆ‘ä»¬åªéœ€è¦å…³å¿ƒè¿™ä¸ª */ int defaultLayout = idp.demoModeLayoutId != 0 &amp;&amp; mContext.getSystemService(UserManager.class).isDemoUser() ? idp.demoModeLayoutId : idp.defaultLayoutId; // åˆ›å»º DefaultLayoutParser å®ä¾‹ return new DefaultLayoutParser(mContext, widgetHolder, mOpenHelper, mContext.getResources(), defaultLayout); }} è¦æƒ³å¼„æ¸…æ¥š idp.defaultLayoutId æ˜¯å“ªä¸ªå¸ƒå±€ï¼Œæˆ‘ä»¬å¾—å…ˆæ¥çœ‹ LauncherAppState.getIDP() æ–¹æ³•ï¼š 12345678910ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/LauncherAppState.javapublic class LauncherAppState implements SafeCloseable { public static InvariantDeviceProfile getIDP(Context context) { // è·å– InvariantDeviceProfile å•ä¾‹ return InvariantDeviceProfile.INSTANCE.get(context); }} ç»§ç»­è·Ÿè¸ªæºç ï¼š 123456789101112131415161718192021222324252627282930313233343536ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.javapublic class InvariantDeviceProfile { private InvariantDeviceProfile(Context context) { // è·å–å½“å‰çš„ç½‘æ ¼åç§° String gridName = getCurrentGridName(context); // åˆå§‹åŒ–ç½‘æ ¼ï¼Œå¯èƒ½ä¼šè¿”å›æ–°çš„ç½‘æ ¼åç§° String newGridName = initGrid(context, gridName); if (!newGridName.equals(gridName)) { // å¦‚æœæ–°çš„ç½‘æ ¼åç§°ä¸å½“å‰ç½‘æ ¼åç§°ä¸åŒï¼Œåˆ™æ›´æ–° LauncherPrefs ä¸­çš„ç½‘æ ¼åç§° LauncherPrefs.get(context).put(GRID_NAME, newGridName); } // å½“ç”¨æˆ·è§£é”æ—¶æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œ LockedUserState.get(context).runOnUserUnlocked(() -&gt; { // åˆ›å»ºä¸€ä¸ª DeviceGridState å®ä¾‹å¹¶è°ƒç”¨ writeToPrefs(context)ï¼Œ // å°†è®¾å¤‡ç½‘æ ¼çŠ¶æ€å†™å…¥åå¥½è®¾ç½® new DeviceGridState(this).writeToPrefs(context); }); // è®¾ç½®ä¸€ä¸ªç›‘å¬å™¨æ¥å¤„ç†è®¾å¤‡æ˜¾ç¤ºé…ç½®çš„æ›´æ”¹ DisplayController.INSTANCE.get(context).setPriorityListener( (displayContext, info, flags) -&gt; { /** * ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•æ£€æŸ¥æ ‡å¿— flags æ˜¯å¦åŒ…å«é…ç½®æ›´æ”¹çš„ * ç›¸å…³æ ‡å¿—ï¼ˆå¦‚å¯†åº¦ã€æ”¯æŒçš„è¾¹ç•Œã€å¯¼èˆªæ¨¡å¼ç­‰ï¼‰ */ if ((flags &amp; (CHANGE_DENSITY | CHANGE_SUPPORTED_BOUNDS | CHANGE_NAVIGATION_MODE)) != 0) { // å¦‚æœæœ‰å˜åŒ–ï¼Œè°ƒç”¨ onConfigChanged() æ–¹æ³•å¤„ç†è¿™äº›å˜åŒ– onConfigChanged(displayContext); } }); } } æˆ‘ä»¬å…³æ³¨ initGrid() æ–¹æ³•ï¼š 12345678910111213141516171819202122232425ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.javapublic class InvariantDeviceProfile { private String initGrid(Context context, String gridName) { // è·å–å½“å‰è®¾å¤‡çš„æ˜¾ç¤ºä¿¡æ¯ Info displayInfo = DisplayController.INSTANCE.get(context).getInfo(); // æ ¹æ®æ˜¾ç¤ºä¿¡æ¯ç¡®å®šè®¾å¤‡ç±»å‹ï¼ˆå¦‚æ‰‹æœºã€å¹³æ¿ç­‰ï¼‰ @DeviceType int deviceType = getDeviceType(displayInfo); // æ ¹æ®ä¸Šä¸‹æ–‡ã€ç½‘æ ¼åç§°ã€è®¾å¤‡ç±»å‹å’Œæ•°æ®åº“æ¢å¤ä»»åŠ¡çš„çŠ¶æ€ï¼Œè·å–æ‰€æœ‰é¢„å®šä¹‰çš„æ˜¾ç¤ºé€‰é¡¹ ArrayList&lt;DisplayOption&gt; allOptions = getPredefinedDeviceProfiles(context, gridName, deviceType, RestoreDbTask.isPending(context)); // ä½¿ç”¨åŠ æƒæ’å€¼æ–¹æ³•ä»æ‰€æœ‰é¢„å®šä¹‰çš„æ˜¾ç¤ºé€‰é¡¹ä¸­é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„é€‰é¡¹ï¼Œ // æ­¤æ–¹æ³•è€ƒè™‘è®¾å¤‡çš„æ˜¾ç¤ºä¿¡æ¯å’Œè®¾å¤‡ç±»å‹æ¥åšå‡ºé€‰æ‹©ã€‚ DisplayOption displayOption = invDistWeightedInterpolate(displayInfo, allOptions, deviceType); // ä½¿ç”¨é€‰å®šçš„æ˜¾ç¤ºé€‰é¡¹åˆå§‹åŒ–ç½‘æ ¼ï¼Œè¿™ä¸ªæ–¹æ³•å¯èƒ½ä¼šè®¾ç½®è®¾å¤‡çš„æ˜¾ç¤ºç½‘æ ¼ä»¥é€‚åº”æ‰€é€‰çš„æ˜¾ç¤ºé€‰é¡¹ initGrid(context, displayInfo, displayOption, deviceType); // è¿”å›æ‰€é€‰æ˜¾ç¤ºé€‰é¡¹çš„ç½‘æ ¼åç§° return displayOption.grid.name; }} ç°åœ¨é‡ç‚¹å°±æ¥åˆ°äº† getPredefinedDeviceProfiles() æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.javapublic class InvariantDeviceProfile { private static ArrayList&lt;DisplayOption&gt; getPredefinedDeviceProfiles(Context context, String gridName, @DeviceType int deviceType, boolean allowDisabledGrid) { // åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ DisplayOption åˆ—è¡¨ï¼Œprofiles ç”¨äºå­˜å‚¨ä» XML è§£æå‡ºçš„æ‰€æœ‰æ˜¾ç¤ºé…ç½®æ–‡ä»¶ ArrayList&lt;DisplayOption&gt; profiles = new ArrayList&lt;&gt;(); /** * å¼€å§‹è§£æ XML -&gt; è§£æå“ªä¸ª XML ï¼Ÿ * ç†Ÿæ‚‰çš„ XML æ–‡ä»¶æ¥äº† -&gt; device_profiles.xml * * ä½¿ç”¨ XmlResourceParser è§£æ R.xml.device_profiles èµ„æºæ–‡ä»¶ï¼Œ * è¯¥æ–‡ä»¶åŒ…å«æ‰€æœ‰é¢„å®šä¹‰çš„è®¾å¤‡é…ç½®æ–‡ä»¶ */ try (XmlResourceParser parser = context.getResources().getXml(R.xml.device_profiles)) { // è·å–å½“å‰ XML æ ‡ç­¾çš„æ·±åº¦ï¼Œç”¨äºç¡®å®šè§£æç»“æŸçš„æ¡ä»¶ final int depth = parser.getDepth(); int type; // å¾ªç¯è§£æ XML æ–‡ä»¶ï¼Œç›´åˆ°é‡åˆ° END_TAGï¼ˆæ ‡ç­¾ç»“æŸï¼‰æˆ–æ–‡æ¡£ç»“æŸ while (((type = parser.next()) != XmlPullParser.END_TAG || parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) { /** * çœ‹ if åˆ¤æ–­é‡Œé¢çš„ GridOption.TAG_NAME -&gt; &quot;grid-option&quot; -&gt; æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ ï¼Ÿ * * æ’æ’­ä¸€ç‚¹ device_profiles.xml çš„å†…å®¹ * &lt;grid-option * launcher:name=&quot;4_by_6&quot; * launcher:numRows=&quot;6&quot; * launcher:defaultLayoutId=&quot;@xml/default_workspace_4x6&quot; * launcher:deviceCategory=&quot;phone|multi_display&quot; * ... /&gt; * * &lt;display-option * launcher:name=&quot;Large Phone&quot; * ... /&gt; * &lt;/grid-option&gt; */ if ((type == XmlPullParser.START_TAG) &amp;&amp; GridOption.TAG_NAME.equals(parser.getName())) { /** * å½“é‡åˆ° &quot;grid-option&quot; å¯¹åº”æ ‡ç­¾ï¼Œåˆ›å»ºä¸€ä¸ª GridOption å®ä¾‹ * * GridOption çš„æºç æˆ‘ä»¬ä¸€ä¼šå°±è¦è·Ÿï¼Œè¿™é‡Œå…ˆæ³¨æ„ä¸€ä¸‹ï¼ï¼ï¼ */ GridOption gridOption = new GridOption(context, Xml.asAttributeSet(parser)); // æ£€æŸ¥ GridOption æ˜¯å¦å¯ç”¨ï¼Œæˆ–æ ¹æ® allowDisabledGrid å‚æ•°å†³å®šæ˜¯å¦å¤„ç†ç¦ç”¨çš„ç½‘æ ¼é€‰é¡¹ if (gridOption.isEnabled(deviceType) || allowDisabledGrid) { final int displayDepth = parser.getDepth(); while (((type = parser.next()) != XmlPullParser.END_TAG || parser.getDepth() &gt; displayDepth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) { // å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œç»§ç»­è§£æè¿™ä¸ªç½‘æ ¼é€‰é¡¹ä¸‹çš„ display-option æ ‡ç­¾ if ((type == XmlPullParser.START_TAG) &amp;&amp; &quot;display-option&quot;.equals( parser.getName())) { // å°†å…¶æ·»åŠ åˆ° profiles åˆ—è¡¨ä¸­ profiles.add(new DisplayOption(gridOption, context, Xml.asAttributeSet(parser))); } } } } } } catch (IOException | XmlPullParserException e) { throw new RuntimeException(e); } // åˆ›å»ºä¸€ä¸ªç©ºçš„ filteredProfiles åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨ç¬¦åˆæ¡ä»¶çš„ DisplayOption ArrayList&lt;DisplayOption&gt; filteredProfiles = new ArrayList&lt;&gt;(); /** * å¦‚æœæä¾›äº† gridNameï¼Œåˆ™éå† profiles åˆ—è¡¨ï¼Œæ‰¾åˆ°ä¸ gridName åŒ¹é…ä¸”å¯ç”¨çš„é€‰é¡¹ï¼Œ * å°†å…¶æ·»åŠ åˆ° filteredProfiles åˆ—è¡¨ä¸­ * * æˆ‘çš„è®¾å¤‡æµ‹è¯• Logï¼š * [ @@@ Pepsimarco ] æ—¥å¿—è¾“å‡ºï¼š===&gt; gridName = 5_by_5 */ if (!TextUtils.isEmpty(gridName)) { for (DisplayOption option : profiles) { if (gridName.equals(option.grid.name) &amp;&amp; (option.grid.isEnabled(deviceType) || allowDisabledGrid)) { filteredProfiles.add(option); } } } // å¦‚æœ filteredProfiles ä¸ºç©ºï¼ˆå³æ²¡æœ‰åŒ¹é…åˆ°åˆé€‚çš„æ˜¾ç¤ºé€‰é¡¹ï¼‰ if (filteredProfiles.isEmpty()) { // No grid found, use the default options // åˆ™ä» profiles åˆ—è¡¨ä¸­é€‰æ‹©å¯ä»¥ä½œä¸ºé»˜è®¤é€‰é¡¹ (canBeDefault) çš„æ˜¾ç¤ºé€‰é¡¹ for (DisplayOption option : profiles) { if (option.canBeDefault) { filteredProfiles.add(option); } } } if (filteredProfiles.isEmpty()) { throw new RuntimeException(&quot;No display option with canBeDefault=true&quot;); } // è¿”å› filteredProfilesï¼Œå³ç¬¦åˆæ¡ä»¶çš„æ˜¾ç¤ºé€‰é¡¹åˆ—è¡¨ return filteredProfiles; }} è‡³æ­¤ï¼Œå¯¹äº device_profiles.xml çš„è§£æï¼Œæˆ‘ä»¬å·²ç»å®Œå…¨æŒæ¡äº†ï¼Œè¿˜è®°å¾—æˆ‘ä»¬å‰é¢è¿˜é—æ¼çš„ GridOption å—ï¼Ÿ æˆ‘ä»¬æ¥è·Ÿæºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.javapublic class InvariantDeviceProfile { public static final class GridOption { /** * GridOption ä¸»è¦åŠŸèƒ½ï¼š * 1. ä»ä¼ å…¥çš„ AttributeSet ä¸­è·å–å¹¶è§£æä¸ç½‘æ ¼å¸ƒå±€ç›¸å…³çš„å±æ€§ï¼› * 2. åˆå§‹åŒ– GridOption ç±»çš„æˆå‘˜å˜é‡ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨è¿™äº›é…ç½®å‚æ•°æ¥è®¾ç½®æˆ–è°ƒæ•´åº”ç”¨ç¨‹åºçš„æ˜¾ç¤ºå¸ƒå±€ã€‚ */ public GridOption(Context context, AttributeSet attrs) { TypedArray a = context.obtainStyledAttributes( attrs, R.styleable.GridDisplayOption); // ç½‘æ ¼å¸ƒå±€çš„åç§° name = a.getString(R.styleable.GridDisplayOption_name); // ç½‘æ ¼çš„è¡Œæ•° numRows = a.getInt(R.styleable.GridDisplayOption_numRows, 0); // ç½‘æ ¼çš„åˆ—æ•° numColumns = a.getInt(R.styleable.GridDisplayOption_numColumns, 0); // æœç´¢å®¹å™¨çš„åˆ—æ•°ï¼Œå¦‚æœæœªæŒ‡å®šï¼Œåˆ™é»˜è®¤ä¸ numColumns ä¸€è‡´ numSearchContainerColumns = a.getInt( R.styleable.GridDisplayOption_numSearchContainerColumns, numColumns); // æ•°æ®åº“æ–‡ä»¶çš„åç§° dbFile = a.getString(R.styleable.GridDisplayOption_dbFile); // é»˜è®¤å¸ƒå±€èµ„æº ID defaultLayoutId = a.getResourceId( R.styleable.GridDisplayOption_defaultLayoutId, 0); // æ¼”ç¤ºæ¨¡å¼ä¸‹çš„å¸ƒå±€èµ„æº IDï¼Œå¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä½¿ç”¨ defaultLayoutId demoModeLayoutId = a.getResourceId( R.styleable.GridDisplayOption_demoModeLayoutId, defaultLayoutId); // æŠ½å±‰çš„æ ·å¼èµ„æº ID allAppsStyle = a.getResourceId(R.styleable.GridDisplayOption_allAppsStyle, R.style.AllAppsStyleDefault); // æŠ½å±‰ä¸­çš„åˆ—æ•° numAllAppsColumns = a.getInt( R.styleable.GridDisplayOption_numAllAppsColumns, numColumns); // æ•°æ®åº“ä¸­åº”ç”¨ç¨‹åºæŠ½å±‰çš„æ‰©å±•åˆ—æ•°ï¼Œé»˜è®¤ä¸º numAllAppsColumns çš„ä¸¤å€ numDatabaseAllAppsColumns = a.getInt( R.styleable.GridDisplayOption_numExtendedAllAppsColumns, 2 * numAllAppsColumns); // HotSeat å›¾æ ‡æ•°é‡ numHotseatIcons = a.getInt( R.styleable.GridDisplayOption_numHotseatIcons, numColumns); // æ•°æ®åº“ä¸­ Hotseat çš„æ‰©å±•å›¾æ ‡æ•°é‡ï¼Œé»˜è®¤ä¸º numHotseatIcons çš„ä¸¤å€ numDatabaseHotseatIcons = a.getInt( R.styleable.GridDisplayOption_numExtendedHotseatIcons, 2 * numHotseatIcons); // Hotseat åœ¨ä¸åŒå±å¹•æ–¹å‘å’Œæ¨¡å¼ä¸‹çš„åˆ—è·¨åº¦ hotseatColumnSpan[INDEX_DEFAULT] = a.getInt( R.styleable.GridDisplayOption_hotseatColumnSpan, numColumns); hotseatColumnSpan[INDEX_LANDSCAPE] = a.getInt( R.styleable.GridDisplayOption_hotseatColumnSpanLandscape, numColumns); hotseatColumnSpan[INDEX_TWO_PANEL_LANDSCAPE] = a.getInt( R.styleable.GridDisplayOption_hotseatColumnSpanTwoPanelLandscape, numColumns); hotseatColumnSpan[INDEX_TWO_PANEL_PORTRAIT] = a.getInt( R.styleable.GridDisplayOption_hotseatColumnSpanTwoPanelPortrait, numColumns); // å¯¼èˆªæŒ‰é’® End é—´è·èµ„æº ID inlineNavButtonsEndSpacing = a.getResourceId(R.styleable.GridDisplayOption_inlineNavButtonsEndSpacing, R.dimen.taskbar_button_margin_default); // æ–‡ä»¶å¤¹å†…çš„è¡Œæ•° numFolderRows = a.getInt( R.styleable.GridDisplayOption_numFolderRows, numRows); // æ–‡ä»¶å¤¹å†…çš„åˆ—æ•° numFolderColumns = a.getInt( R.styleable.GridDisplayOption_numFolderColumns, numColumns); // æ–‡ä»¶å¤¹çš„æ ·å¼èµ„æº ID folderStyle = a.getResourceId(R.styleable.GridDisplayOption_folderStyle, INVALID_RESOURCE_HANDLE); // å•å…ƒæ ¼çš„æ ·å¼èµ„æº ID cellStyle = a.getResourceId(R.styleable.GridDisplayOption_cellStyle, R.style.CellStyleDefault); // ç½‘æ ¼æ˜¯å¦å¯ä»¥ç¼©æ”¾ isScalable = a.getBoolean( R.styleable.GridDisplayOption_isScalable, false); // è®¾å¤‡å¡«å……çš„èµ„æº ID devicePaddingId = a.getResourceId( R.styleable.GridDisplayOption_devicePaddingId, INVALID_RESOURCE_HANDLE); // è®¾å¤‡ç±»åˆ« deviceCategory = a.getInt(R.styleable.GridDisplayOption_deviceCategory, DEVICE_CATEGORY_ALL); // å·¥ä½œåŒºè§„æ ¼çš„èµ„æº ID if (FeatureFlags.ENABLE_RESPONSIVE_WORKSPACE.get()) { mWorkspaceSpecsId = a.getResourceId( R.styleable.GridDisplayOption_workspaceSpecsId, INVALID_RESOURCE_HANDLE); } else { mWorkspaceSpecsId = INVALID_RESOURCE_HANDLE; } // æœç´¢æ åœ¨ä¸åŒå±å¹•æ–¹å‘å’Œæ¨¡å¼ä¸‹æ˜¯å¦å†…è” int inlineForRotation = a.getInt(R.styleable.GridDisplayOption_inlineQsb, DONT_INLINE_QSB); inlineQsb[INDEX_DEFAULT] = (inlineForRotation &amp; INLINE_QSB_FOR_PORTRAIT) == INLINE_QSB_FOR_PORTRAIT; inlineQsb[INDEX_LANDSCAPE] = (inlineForRotation &amp; INLINE_QSB_FOR_LANDSCAPE) == INLINE_QSB_FOR_LANDSCAPE; inlineQsb[INDEX_TWO_PANEL_PORTRAIT] = (inlineForRotation &amp; INLINE_QSB_FOR_TWO_PANEL_PORTRAIT) == INLINE_QSB_FOR_TWO_PANEL_PORTRAIT; inlineQsb[INDEX_TWO_PANEL_LANDSCAPE] = (inlineForRotation &amp; INLINE_QSB_FOR_TWO_PANEL_LANDSCAPE) == INLINE_QSB_FOR_TWO_PANEL_LANDSCAPE; // é‡Šæ”¾ TypedArrayï¼Œä»¥é¿å…å†…å­˜æ³„æ¼ a.recycle(); } }} è‡³æ­¤ï¼Œæˆ‘ä»¬å†æ¥çœ‹ idp.defaultLayoutIdï¼š 12345678910111213141516171819202122232425ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.javapublic class InvariantDeviceProfile { public int defaultLayoutId; // è¿™ä¸ªé»˜è®¤å¸ƒå±€æ˜¯å“ªä¸ªï¼Œä½ æ¸…æ¥šäº†å—ï¼Ÿ ==&gt; defaultLayoutId = a.getResourceId( R.styleable.GridDisplayOption_defaultLayoutId, 0); ==&gt; å°±çœ‹ä½ çš„ gridName æ˜¯å“ªä¸ªï¼Œæ¯”å¦‚æˆ‘çš„è®¾å¤‡æ˜¯ï¼š5_by_5 ==&gt; &lt;grid-option launcher:name=&quot;5_by_5&quot; launcher:numRows=&quot;5&quot; launcher:numColumns=&quot;5&quot; launcher:numFolderRows=&quot;4&quot; launcher:numFolderColumns=&quot;4&quot; launcher:numHotseatIcons=&quot;5&quot; launcher:numExtendedHotseatIcons=&quot;6&quot; launcher:dbFile=&quot;launcher.db&quot; launcher:inlineNavButtonsEndSpacing=&quot;@dimen/taskbar_button_margin_split&quot; launcher:defaultLayoutId=&quot;@xml/default_workspace_5x5&quot; launcher:deviceCategory=&quot;phone|multi_display&quot; &gt;} è®²åˆ°è¿™ï¼Œæˆ‘ä»¬å°±å®Œå…¨è®²é€šäº† Launcher ä½•æ—¶ä¼šè§£æ device_profiles.xml æ–‡ä»¶ï¼Œå¹¶ä¸”å»æ‰¾å¯¹åº”çš„æŸä¸€ä¸ª default_workspace_xxx äº†ã€‚ åŠ è½½æ•°æ®åº“åˆ†æå®Œé»˜è®¤å¸ƒå±€çš„æµç¨‹å¤–ï¼Œæˆ‘ä»¬ç»§ç»­ loadWorkspaceImpl() ä¸­é—ç•™çš„æ•°æ®åº“çš„åŠ è½½é€»è¾‘ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/LoaderTask.javapublic class LoaderTask implements Runnable { protected final LauncherAppState mApp; private void loadWorkspaceImpl( List&lt;ShortcutInfo&gt; allDeepShortcuts, String selection, @Nullable LoaderMemoryLogger memoryLogger) { ... /********************************************************************* * æ ¸å¿ƒ 1: åŠ è½½é»˜è®¤æ¡Œé¢å¸ƒå±€ * * ä¼šè°ƒç”¨åˆ° LauncherProvider çš„ loadDefaultFavoritesIfNecessary() æ–¹æ³•ï¼Œ * è¿™ä¸ªæ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åŠ è½½é»˜è®¤çš„å¸ƒå±€ï¼Œå¦‚æœæ¸…é™¤äº†æ¡Œé¢æ•°æ® * æˆ–è€…æ‰‹æœºæ¢å¤äº†å‡ºå‚è®¾ç½®ï¼Œå°±ä¼šåŠ è½½é»˜è®¤çš„å¸ƒå±€ ********************************************************************/ Settings.call(contentResolver, Settings.METHOD_LOAD_DEFAULT_FAVORITES); /********************************************************************* * æ ¸å¿ƒ 2: * * åŠ è½½æ•°æ®åº“ ********************************************************************/ synchronized (mBgDataModel) { mBgDataModel.clear(); // æ¸…é™¤æ•°æ®æ¨¡å‹ï¼ˆå†…å­˜ä¸­çš„å·¥ä½œåŒºæ•°æ®ï¼‰ mPendingPackages.clear(); // æ¸…é™¤å¾…å¤„ç†çš„åº”ç”¨åŒ…ä¿¡æ¯ // è·å–å½“å‰æ­£åœ¨è¿›è¡Œçš„å®‰è£…ä¼šè¯çš„åˆ—è¡¨ final HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs = mSessionHelper.getActiveSessions(); // å°†æ¯ä¸ªå®‰è£…ä¼šè¯çš„ä¿¡æ¯æ›´æ–°åˆ°å›¾æ ‡ç¼“å­˜ä¸­ (IconCache)ï¼Œç¡®ä¿ Launcher èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºåº”ç”¨å®‰è£…çŠ¶æ€ installingPkgs.forEach(mApp.getIconCache()::updateSessionCache); // ç”¨äºæš‚å­˜åŒ…åå’Œç”¨æˆ·é”®å€¼çš„ä¸´æ—¶å¯¹è±¡ final PackageUserKey tempPackageKey = new PackageUserKey(null, null); // åˆå§‹åŒ–ä¸€ä¸ªå¹¿æ’­å¯¹è±¡ï¼Œç”¨äºåœ¨ Launcher åŠ è½½æ—¶å¹¿æ’­çŠ¶æ€ä¿¡æ¯ mFirstScreenBroadcast = new FirstScreenBroadcast(installingPkgs); // å­˜å‚¨å›ºå®šåœ¨ Launcher ä¸Šçš„å¿«æ·æ–¹å¼ä¿¡æ¯çš„æ˜ å°„ mShortcutKeyToPinnedShortcuts = new HashMap&lt;&gt;(); ModelDbController dbController = mApp.getModel().getModelDbController(); /*********************************************** * é€šè¿‡ LoaderCursor æŸ¥è¯¢æ•°æ®åº“ï¼Œè·å–å·¥ä½œç©ºé—´çš„æ•°æ®é¡¹ ***********************************************/ final LoaderCursor c = new LoaderCursor( dbController.query(TABLE_NAME, null, selection, null, null), mApp, mUserManagerState); final Bundle extras = c.getExtras(); // ä»æ•°æ®åº“æŸ¥è¯¢ç»“æœçš„é¢å¤–ä¿¡æ¯ (extras) ä¸­è·å–æ•°æ®åº“åç§° -&gt; launcher.db mDbName = extras == null ? null : extras.getString(Settings.EXTRA_DB_NAME); try { // ä¸€ä¸ªç¨€ç–æ•°ç»„ (LongSparseArray)ï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·çš„è§£é”çŠ¶æ€ final LongSparseArray&lt;Boolean&gt; unlockedUsers = new LongSparseArray&lt;&gt;(); mUserManagerState.init(mUserCache, mUserManager); // éå†ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼Œå¯¹æ¯ä¸ªç”¨æˆ·ï¼š for (UserHandle user : mUserCache.getUserProfiles()) { long serialNo = mUserCache.getSerialNumberForUser(user); // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è§£é” boolean userUnlocked = mUserManager.isUserUnlocked(user); // å‘ LauncherAppsService è·å– Pinned Shortcuts if (userUnlocked) { QueryResult pinnedShortcuts = new ShortcutRequest(context, user) .query(ShortcutRequest.PINNED); if (pinnedShortcuts.wasSuccess()) { for (ShortcutInfo shortcut : pinnedShortcuts) { // å¦‚æœç”¨æˆ·è§£é”ï¼ŒæŸ¥è¯¢å›ºå®šçš„å¿«æ·æ–¹å¼ï¼Œ // å¹¶å°†å…¶å­˜å‚¨åœ¨ mShortcutKeyToPinnedShortcuts ä¸­ mShortcutKeyToPinnedShortcuts.put(ShortcutKey.fromInfo(shortcut), shortcut); } } else { // Shortcut manager can fail due to some race condition when the // lock state changes too frequently. For the purpose of the loading // shortcuts, consider the user is still locked. userUnlocked = false; } } // å°†ç”¨æˆ·çš„è§£é”çŠ¶æ€å­˜å‚¨åœ¨ unlockedUsers ä¸­ unlockedUsers.put(serialNo, userUnlocked); } // ä¸€ä¸ªåˆ—è¡¨ï¼Œå­˜å‚¨äº†éœ€è¦æ‰¹é‡åŠ è½½çš„å›¾æ ‡è¯·æ±‚ä¿¡æ¯ List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos = new ArrayList&lt;&gt;(); /** * å¼€å§‹éå†æ•°æ®åº“ï¼Œä¸€æ¬¡è¯»å–æ•°æ®åº“å†…å®¹ï¼Œéå† LoaderCursor ä¸­çš„æ¯ä¸€è¡Œï¼Œ * ä½¿ç”¨ processWorkspaceItem() æ–¹æ³• * å¤„ç†æ¯ä¸ªå·¥ä½œç©ºé—´é¡¹ç›®ï¼ŒåŒ…æ‹¬åº”ç”¨å›¾æ ‡ã€å°éƒ¨ä»¶å’Œå¿«æ·æ–¹å¼ * * æ ¸å¿ƒæ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬è¦è·Ÿè¸ªï¼ï¼ï¼ */ while (!mStopped &amp;&amp; c.moveToNext()) { processWorkspaceItem(c, memoryLogger, installingPkgs, isSdCardReady, tempPackageKey, widgetHelper, pmHelper, iconRequestInfos, unlockedUsers, isSafeMode, allDeepShortcuts); } // æ‰¹é‡åŠ è½½å·¥ä½œç©ºé—´å›¾æ ‡ï¼Œä»¥æé«˜åŠ è½½æ€§èƒ½ tryLoadWorkspaceIconsInBulk(iconRequestInfos); } finally { IOUtils.closeSilently(c); } if (!FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) { // mModelDelegate: è´Ÿè´£å°†æ•°æ®ç»‘å®šåˆ° UI ä¸Šçš„å§”æ‰˜å¯¹è±¡ // åŠ è½½å¹¶ç»‘å®š WorkspaceItems mModelDelegate.loadAndBindWorkspaceItems(mUserManagerState, mLauncherBinder.mCallbacksList, mShortcutKeyToPinnedShortcuts); // åŠ è½½å¹¶ç»‘å®š AllAppsItems mModelDelegate.loadAndBindAllAppsItems(mUserManagerState, mLauncherBinder.mCallbacksList, mShortcutKeyToPinnedShortcuts); // åŠ è½½å¹¶ç»‘å®š OtherItems mModelDelegate.loadAndBindOtherItems(mLauncherBinder.mCallbacksList); // æ ‡è®°åŠ è½½è¿‡ç¨‹å®Œæˆï¼ŒLauncher å¯ä»¥å¼€å§‹å“åº”ç”¨æˆ·æ“ä½œ mModelDelegate.markActive(); } // Break early if we have stopped loading if (mStopped) { mBgDataModel.clear(); return; } // Remove dead itemsï¼Œåˆ é™¤ processWorkspaceItem ä¸­æ ‡è®° delete çš„æ•°æ® mItemsDeleted = c.commitDeleted(); // Sort the folder items, update ranks, and make sure all preview items are high res. // æ–‡ä»¶å¤¹å†…å®¹çš„æ’åºå’Œæ›´æ–° // FolderGridOrganizer: ç”¨äºç»„ç»‡å’ŒéªŒè¯æ–‡ä»¶å¤¹ç½‘æ ¼å¸ƒå±€ FolderGridOrganizer verifier = new FolderGridOrganizer(mApp.getInvariantDeviceProfile()); // éå†æ¯ä¸€ä¸ªæ–‡ä»¶å¤¹ for (FolderInfo folder : mBgDataModel.folders) { // å¯¹æ–‡ä»¶å¤¹å†…å®¹è¿›è¡Œæ’åº Collections.sort(folder.contents, Folder.ITEM_POS_COMPARATOR); verifier.setFolderInfo(folder); int size = folder.contents.size(); // Update ranks here to ensure there are no gaps caused by removed folder items. // Ranks are the source of truth for folder items, so cellX and cellY can be ignored // for now. Database will be updated once user manually modifies folder. // æ›´æ–°é¡¹ç›®çš„ rankï¼Œç¡®ä¿æ˜¾ç¤ºé¡ºåºæ­£ç¡® for (int rank = 0; rank &lt; size; ++rank) { WorkspaceItemInfo info = folder.contents.get(rank); info.rank = rank; // å¯¹äºä½¿ç”¨ä½åˆ†è¾¨ç‡å›¾æ ‡ä¸”æ˜¾ç¤ºåœ¨æ–‡ä»¶å¤¹é¢„è§ˆä¸­çš„é¡¹ç›®ï¼ŒåŠ è½½é«˜åˆ†è¾¨ç‡å›¾æ ‡ if (info.usingLowResIcon() &amp;&amp; info.itemType == Favorites.ITEM_TYPE_APPLICATION &amp;&amp; verifier.isItemInPreview(info.rank)) { mIconCache.getTitleAndIcon(info, false); } } } // æœ€åï¼Œå°†æ‰€æœ‰å¤„ç†åçš„å·¥ä½œåŒºé¡¹æäº¤åˆ°æ•°æ®åº“ä¸­ c.commitRestoredItems(); } } } æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¼€å§‹é‡ç‚¹åˆ†æ processWorkspaceItem() çš„æºç äº†ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/LoaderTask.javapublic class LoaderTask implements Runnable { /** * å¤„ç†ä»æ•°æ®åº“åŠ è½½çš„æ¡Œé¢é¡¹ç›®ï¼ˆå¦‚å¿«æ·æ–¹å¼ã€æ–‡ä»¶å¤¹ã€åº”ç”¨å°éƒ¨ä»¶ç­‰ï¼‰ * * c : ç”¨äºè¯»å–æ•°æ®åº“ä¸­å­˜å‚¨çš„æ¡Œé¢é¡¹ç›®æ•°æ®çš„æ¸¸æ ‡ * memoryLogger : ç”¨äºè®°å½•å†…å­˜æ¶ˆè€—çš„æ—¥å¿—å·¥å…· * installingPkgs : ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œç”¨äºè·Ÿè¸ªæ­£åœ¨å®‰è£…çš„åº”ç”¨åŒ… * isSdCardReady : æ ‡è¯† SD å¡æ˜¯å¦å·²å‡†å¤‡å°±ç»ªçš„æ ‡å¿— * tempPackageKey : ä¸€ä¸ªä¸´æ—¶çš„ PackageUserKey å¯¹è±¡ï¼Œç”¨äºå¤„ç†åŒ…åå’Œç”¨æˆ·ä¿¡æ¯ * widgetHelper : ç”¨äºç®¡ç†å°éƒ¨ä»¶çš„è¾…åŠ©ç±» * pmHelper : ç”¨äºå¤„ç†åŒ…ç®¡ç†çš„è¾…åŠ©ç±» * iconRequestInfos: ç”¨äºå­˜å‚¨è¦åŠ è½½å›¾æ ‡çš„è¯·æ±‚ä¿¡æ¯çš„åˆ—è¡¨ * unlockedUsers : ç”¨äºå­˜å‚¨å·²è§£é”ç”¨æˆ·çš„æ ‡è¯†ç¬¦çš„ç¨€ç–æ•°ç»„ * isSafeMode : æ˜¯å¦å¤„äºå®‰å…¨æ¨¡å¼çš„æ ‡å¿— * allDeepShortcuts: ç”¨äºå­˜å‚¨æ‰€æœ‰æ·±å±‚å¿«æ·æ–¹å¼çš„ä¿¡æ¯åˆ—è¡¨ */ private void processWorkspaceItem(LoaderCursor c, LoaderMemoryLogger memoryLogger, HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs, boolean isSdCardReady, PackageUserKey tempPackageKey, WidgetManagerHelper widgetHelper, PackageManagerHelper pmHelper, List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos, LongSparseArray&lt;Boolean&gt; unlockedUsers, boolean isSafeMode, List&lt;ShortcutInfo&gt; allDeepShortcuts) { try { if (c.user == null) { // User has been deleted, remove the item. // é¦–å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ ‡è®°ä¸ºåˆ é™¤ c.markDeleted(&quot;User has been deleted&quot;); return; } // ç”¨äºæ ‡è®°æ˜¯å¦å…è®¸ä¸¢å¤±ç›®æ ‡åº”ç”¨çš„æƒ…å†µ boolean allowMissingTarget = false; /** * æ¥ä¸‹æ¥å°±æ˜¯å®é™…çš„å¤„ç†é€»è¾‘äº†ï¼Œå¼€å§‹å¤„ç†ä¸åŒç±»å‹çš„æ¡Œé¢é¡¹ç›®ï¼š * * Favorites.ITEM_TYPE_SHORTCUT : å¤„ç†æ™®é€šå¿«æ·æ–¹å¼ * Favorites.ITEM_TYPE_APPLICATION : å¤„ç†åº”ç”¨å¿«æ·æ–¹å¼ * Favorites.ITEM_TYPE_DEEP_SHORTCUT: å¤„ç†æ·±å±‚å¿«æ·æ–¹å¼ * Favorites.ITEM_TYPE_FOLDER : å¤„ç†æ–‡ä»¶å¤¹ * Favorites.ITEM_TYPE_APPWIDGET : å¤„ç†åº”ç”¨å°éƒ¨ä»¶ */ switch (c.itemType) { case Favorites.ITEM_TYPE_SHORTCUT: // å¦‚æœæ˜¯å¿«æ·æ–¹å¼ case Favorites.ITEM_TYPE_APPLICATION: // å¦‚æœæ˜¯åº”ç”¨ç¨‹åº case Favorites.ITEM_TYPE_DEEP_SHORTCUT: // å¦‚æœæ˜¯æ·±å±‚å¿«æ·æ–¹å¼ case Favorites.ITEM_TYPE_FOLDER // å¦‚æœæ˜¯æ–‡ä»¶å¤¹ case Favorites.ITEM_TYPE_APPWIDGET // å¦‚æœæ˜¯åº”ç”¨å°éƒ¨ä»¶ ... // ä»£ç å¤ªå¤šï¼Œæˆ‘ä»¬åˆ†ç±»åˆ†æ } } catch (Exception e) { Log.e(TAG, &quot;Desktop items loading interrupted&quot;, e); } }} åº”ç”¨/å¿«æ·æ–¹å¼123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/LoaderTask.javapublic class LoaderTask implements Runnable { private void processWorkspaceItem(LoaderCursor c, LoaderMemoryLogger memoryLogger, HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs, boolean isSdCardReady, PackageUserKey tempPackageKey, WidgetManagerHelper widgetHelper, PackageManagerHelper pmHelper, List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos, LongSparseArray&lt;Boolean&gt; unlockedUsers, boolean isSafeMode, List&lt;ShortcutInfo&gt; allDeepShortcuts) { try { ... switch (c.itemType) { case Favorites.ITEM_TYPE_SHORTCUT: // å¦‚æœæ˜¯å¿«æ·æ–¹å¼ case Favorites.ITEM_TYPE_APPLICATION: // å¦‚æœæ˜¯åº”ç”¨ç¨‹åº case Favorites.ITEM_TYPE_DEEP_SHORTCUT: // å¦‚æœæ˜¯æ·±å±‚å¿«æ·æ–¹å¼ // ä» LoaderCursor ä¸­è§£æ Intent å¯¹è±¡ Intent intent = c.parseIntent(); // éªŒè¯ intent æœ‰æ•ˆæ€§ if (intent == null) { // å¦‚æœ Intent ä¸ºç©ºæˆ–æ— æ•ˆï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤ c.markDeleted(&quot;Invalid or null intent&quot;); return; } // æ ¹æ®ç”¨æˆ·ç®¡ç†å™¨çŠ¶æ€åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦ä¸ºé™é»˜ç”¨æˆ· int disabledState = mUserManagerState.isUserQuiet(c.serialNumber) ? WorkspaceItemInfo.FLAG_DISABLED_QUIET_USER : 0; // ä» Intent ä¸­è·å–ç»„ä»¶åç§° ComponentName cn = intent.getComponent(); String targetPkg = cn == null ? intent.getPackage() : cn.getPackageName(); // å¦‚æœç›®æ ‡åŒ…åä¸ºç©ºä¸”é¡¹ç›®ç±»å‹ä¸æ˜¯å¿«æ·æ–¹å¼ï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤ if (TextUtils.isEmpty(targetPkg) &amp;&amp; c.itemType != Favorites.ITEM_TYPE_SHORTCUT) { c.markDeleted(&quot;Only legacy shortcuts can have null package&quot;); return; } // æ£€æŸ¥ç›®æ ‡åŒ…æ˜¯å¦æœ‰æ•ˆï¼ˆå¦‚æœæ²¡æœ‰ç›®æ ‡åŒ…åï¼Œåˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªéšå¼ Intentï¼Œå§‹ç»ˆæœ‰æ•ˆï¼‰ boolean validTarget = TextUtils.isEmpty(targetPkg) || mLauncherApps.isPackageEnabled(targetPkg, c.user); // å¦‚æœç»„ä»¶åä¸ä¸ºç©ºä¸”ç›®æ ‡æœ‰æ•ˆä¸”é¡¹ç›®ä¸æ˜¯æ·±åº¦å¿«æ·æ–¹å¼ if (cn != null &amp;&amp; validTarget &amp;&amp; c.itemType != Favorites.ITEM_TYPE_DEEP_SHORTCUT) { // If the apk is present and the shortcut points to a specific component. // å¦‚æœç›®æ ‡æ´»åŠ¨å­˜åœ¨ï¼Œæ ‡è®°é¡¹ç›®ä¸ºå·²æ¢å¤ if (mLauncherApps.isActivityEnabled(cn, c.user)) { // no special handling necessary for this item c.markRestored(); // æ ‡è®°ä¸ºå·²æ¢å¤ } else { // å¦åˆ™ï¼Œå°è¯•æ‰¾åˆ°ä¸€ä¸ªå¤‡ç”¨çš„å¯åŠ¨æ´»åŠ¨ intent = pmHelper.getAppLaunchIntent(targetPkg, c.user); // å¦‚æœæ‰¾åˆ°äº†å¯åŠ¨æ´»åŠ¨ï¼Œæ›´æ–° Intent å¹¶é‡ç½®æ¢å¤æ ‡å¿— if (intent != null) { c.restoreFlag = 0; c.updater().put( Favorites.INTENT, intent.toUri(0)).commit(); // æ›´æ–°ç»„ä»¶åç§° cn = intent.getComponent(); } else { // å¦‚æœæ‰¾ä¸åˆ°å¯åŠ¨æ´»åŠ¨ï¼Œåˆ™æ ‡è®°é¡¹ç›®ä¸ºå·²åˆ é™¤å¹¶è¿”å› c.markDeleted(&quot;Unable to find a launch target&quot;); return; } } } // å¦‚æœç›®æ ‡åŒ…æ— æ•ˆï¼Œåˆ™å¤„ç†æ¢å¤çŠ¶æ€ if (!TextUtils.isEmpty(targetPkg) &amp;&amp; !validTarget) { if (c.restoreFlag != 0) { // å¦‚æœåº”ç”¨ç¨‹åºè¿˜æœªæ¢å¤ FileLog.d(TAG, &quot;package not yet restored: &quot; + targetPkg); tempPackageKey.update(targetPkg, c.user); if (c.hasRestoreFlag(WorkspaceItemInfo.FLAG_RESTORE_STARTED)) { // æ¢å¤å·²ç»å¼€å§‹ï¼Œä¸åšä»»ä½•æ“ä½œ } else if (installingPkgs.containsKey(tempPackageKey)) { // æ¢å¤æ­£åœ¨è¿›è¡Œï¼Œæ›´æ–°æ¢å¤æ ‡è®° c.restoreFlag |= WorkspaceItemInfo.FLAG_RESTORE_STARTED; c.updater().put(Favorites.RESTORED, c.restoreFlag).commit(); } else { // å¦åˆ™æ ‡è®°é¡¹ç›®ä¸ºå·²åˆ é™¤å¹¶è¿”å› c.markDeleted(&quot;Unrestored app removed: &quot; + targetPkg); return; } } else if (pmHelper.isAppOnSdcard(targetPkg, c.user)) { // å¦‚æœåŒ…åœ¨ SD å¡ä¸Šä½†ä¸å¯ç”¨ï¼Œæ ‡è®°åº”ç”¨ä¸å¯ç”¨ disabledState |= WorkspaceItemInfo.FLAG_DISABLED_NOT_AVAILABLE; // å…è®¸ä¸¢å¤±ç›®æ ‡ï¼Œä»ç„¶å°†å›¾æ ‡æ·»åŠ åˆ°å·¥ä½œåŒº allowMissingTarget = true; } else if (!isSdCardReady) { // å¦‚æœ SD å¡æœªå‡†å¤‡å¥½ï¼Œå°†åŒ…åæ·»åŠ åˆ°å¾…å¤„ç†åˆ—è¡¨ä¸­ Log.d(TAG, &quot;Missing pkg, will check later: &quot; + targetPkg); mPendingPackages.add(new PackageUserKey(targetPkg, c.user)); // å…è®¸ä¸¢å¤±ç›®æ ‡ï¼Œä»ç„¶å°†å›¾æ ‡æ·»åŠ åˆ°å·¥ä½œåŒº allowMissingTarget = true; } else { // å¦‚æœåŒ…æ— æ•ˆä¸” SD å¡å·²å‡†å¤‡å¥½ï¼Œæ ‡è®°é¡¹ç›®ä¸ºå·²åˆ é™¤å¹¶è¿”å› c.markDeleted(&quot;Invalid package removed: &quot; + targetPkg); return; } } // å¦‚æœæ¢å¤æ ‡å¿—åŒ…å« Web UI æ”¯æŒæ ‡å¿—ï¼Œè®¾ç½®ç›®æ ‡æ— æ•ˆ if ((c.restoreFlag &amp; WorkspaceItemInfo.FLAG_SUPPORTS_WEB_UI) != 0) { validTarget = false; } if (validTarget) { // å¦‚æœå¿«æ·æ–¹å¼æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„ç›®æ ‡ï¼Œæ ‡è®°ä¸ºå·²æ¢å¤ c.markRestored(); } // å†³å®šæ˜¯å¦ä½¿ç”¨ä½åˆ†è¾¨ç‡çš„å›¾æ ‡ boolean useLowResIcon = !c.isOnWorkspaceOrHotseat(); WorkspaceItemInfo info; if (c.restoreFlag != 0) { // å¦‚æœæ¢å¤æ ‡è®°ä¸ä¸º 0ï¼Œè·å–æ¢å¤çš„ item ä¿¡æ¯ info = c.getRestoredItemInfo(intent); } else if (c.itemType == Favorites.ITEM_TYPE_APPLICATION) { // åˆ›å»ºåº”ç”¨ç¨‹åºå¿«æ·æ–¹å¼ä¿¡æ¯ info = c.getAppShortcutInfo( intent, allowMissingTarget, useLowResIcon, true); } else if (c.itemType == Favorites.ITEM_TYPE_DEEP_SHORTCUT) { // å¤„ç†æ·±å±‚å¿«æ·æ–¹å¼ ShortcutKey key = ShortcutKey.fromIntent(intent, c.user); if (unlockedUsers.get(c.serialNumber)) { // å¦‚æœç”¨æˆ·å·²è§£é”ï¼Œè·å–æ·±åº¦å¿«æ·æ–¹å¼ä¿¡æ¯ ShortcutInfo pinnedShortcut = mShortcutKeyToPinnedShortcuts.get(key); if (pinnedShortcut == null) { // å¦‚æœæœªæ‰¾åˆ°å›ºå®šå¿«æ·æ–¹å¼ï¼Œæ ‡è®°é¡¹ç›®ä¸ºå·²åˆ é™¤å¹¶è¿”å› c.markDeleted(&quot;Pinned shortcut not found&quot;); return; } // åˆ›å»ºæ·±åº¦å¿«æ·æ–¹å¼çš„ä¿¡æ¯å¯¹è±¡ info = new WorkspaceItemInfo(pinnedShortcut, mApp.getContext()); // If the pinned deep shortcut is no longer published, // use the last saved icon instead of the default. mIconCache.getShortcutIcon(info, pinnedShortcut, c::loadIcon); // æ£€æŸ¥åº”ç”¨æ˜¯å¦è¢«æŒ‚èµ· if (pmHelper.isAppSuspended( pinnedShortcut.getPackage(), info.user)) { info.runtimeStatusFlags |= FLAG_DISABLED_SUSPENDED; } // æ›´æ–° Intent intent = info.getIntent(); allDeepShortcuts.add(pinnedShortcut); } else { // å¦‚æœç”¨æˆ·è¢«é”å®šï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„å·¥ä½œåŒºé¡¹ç›®ä¿¡æ¯ info = c.loadSimpleWorkspaceItem(); info.runtimeStatusFlags |= FLAG_DISABLED_LOCKED_USER; } } else { // å¤„ç†æ™®é€šå¿«æ·æ–¹å¼ info = c.loadSimpleWorkspaceItem(); // Shortcuts are only available on the primary profile if (!TextUtils.isEmpty(targetPkg) &amp;&amp; pmHelper.isAppSuspended(targetPkg, c.user)) { disabledState |= FLAG_DISABLED_SUSPENDED; } info.options = c.getOptions(); // App shortcuts that used to be automatically added to Launcher // did not always have the correct intent flags set, so do that here // ä¿®å¤æŸäº›æ—§å¿«æ·æ–¹å¼çš„ Intent æ ‡å¿— if (intent.getAction() != null &amp;&amp; intent.getCategories() != null &amp;&amp; intent.getAction().equals(Intent.ACTION_MAIN) &amp;&amp; intent.getCategories().contains(Intent.CATEGORY_LAUNCHER)) { intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED); } } // æ£€æŸ¥ info æ˜¯å¦ä¸ºç©º if (info != null) { if (info.itemType != Favorites.ITEM_TYPE_DEEP_SHORTCUT) { // Skip deep shortcuts; their title and icons have already been // loaded above. // å°†å›¾æ ‡è¯·æ±‚ä¿¡æ¯æ·»åŠ åˆ°åˆ—è¡¨ iconRequestInfos.add(c.createIconRequestInfo(info, useLowResIcon)); } // åº”ç”¨é€šç”¨å±æ€§ c.applyCommonProperties(info); // æ›´æ–°ä¿¡æ¯å¯¹è±¡çš„ Intent å’Œå…¶ä»–å±æ€§ info.intent = intent; info.rank = c.getRank(); info.spanX = 1; info.spanY = 1; info.runtimeStatusFlags |= disabledState; // å¦‚æœå¤„äºå®‰å…¨æ¨¡å¼ä¸”ç›®æ ‡åº”ç”¨ä¸æ˜¯ç³»ç»Ÿåº”ç”¨ï¼Œæ ‡è®°å…¶ä¸ºç¦ç”¨ if (isSafeMode &amp;&amp; !isSystemApp(mApp.getContext(), intent)) { info.runtimeStatusFlags |= FLAG_DISABLED_SAFEMODE; } // è·å–å¯åŠ¨æ´»åŠ¨ä¿¡æ¯ LauncherActivityInfo activityInfo = c.getLauncherActivityInfo(); if (activityInfo != null) { // è®¾ç½®ä¸‹è½½è¿›åº¦ info.setProgressLevel( PackageManagerHelper.getLoadingProgress(activityInfo), PackageInstallInfo.STATUS_INSTALLED_DOWNLOADING); } if (c.restoreFlag != 0 &amp;&amp; !TextUtils.isEmpty(targetPkg)) { tempPackageKey.update(targetPkg, c.user); SessionInfo si = installingPkgs.get(tempPackageKey); if (si == null) { info.runtimeStatusFlags &amp;= ~ItemInfoWithIcon.FLAG_INSTALL_SESSION_ACTIVE; } else if (activityInfo == null) { int installProgress = (int) (si.getProgress() * 100); info.setProgressLevel(installProgress, PackageInstallInfo.STATUS_INSTALLING); } } // æ£€æŸ¥å¹¶æ·»åŠ  item ä¿¡æ¯åˆ°æ•°æ®æ¨¡å‹ c.checkAndAddItem(info, mBgDataModel, memoryLogger); } else { throw new RuntimeException(&quot;Unexpected null WorkspaceItemInfo&quot;); } break; // ===&gt;&gt;&gt; åº”ç”¨/å¿«æ·æ–¹å¼å¤„ç†å®Œæ¯• ... } } catch (Exception e) { Log.e(TAG, &quot;Desktop items loading interrupted&quot;, e); } }} æˆ‘ä»¬æ¥çœ‹çœ‹ checkAndAddItem() æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/LoaderCursor.javapublic class LoaderCursor extends CursorWrapper { // æ£€æŸ¥å¹¶æ·»åŠ ä¸€ä¸ª ItemInfo é¡¹ç›®åˆ°æ•°æ®æ¨¡å‹ä¸­ public void checkAndAddItem( ItemInfo info, BgDataModel dataModel, LoaderMemoryLogger logger) { // æ£€æŸ¥é¡¹ç›®ç±»å‹æ˜¯å¦ä¸ºæ·±å±‚å¿«æ·æ–¹å¼ if (info.itemType == Favorites.ITEM_TYPE_DEEP_SHORTCUT) { // ä» ItemInfo ä¸­ç”Ÿæˆ ShortcutKeyã€‚è¿™æ˜¯ç¡®ä¿å¿«æ·æ–¹å¼çš„ Intent æ˜¯æœ‰æ•ˆçš„ï¼Œ // å¦‚æœ ShortcutKey åˆ›å»ºå¤±è´¥ï¼Œå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œè·³è¿‡åŠ è½½è¯¥é¡¹ç›® ShortcutKey.fromItemInfo(info); } // éªŒè¯é¡¹ç›®åœ¨å¸ƒå±€ä¸­çš„ä½ç½®æ˜¯å¦æœ‰æ•ˆï¼ˆä¾‹å¦‚ï¼Œæ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–é¡¹ç›®é‡å ï¼‰ if (checkItemPlacement(info)) { /** * é‡ç‚¹æ–¹æ³•ï¼šå¦‚æœä½ç½®æœ‰æ•ˆï¼Œå°†é¡¹ç›®æ·»åŠ åˆ° dataModel ä¸­ */ dataModel.addItem(mContext, info, false, logger); } else { // å¦‚æœä½ç½®æ— æ•ˆï¼Œè°ƒç”¨ markDeleted æ–¹æ³•æ ‡è®°é¡¹ç›®ä¸ºå·²åˆ é™¤ï¼Œ // åŸå› æ˜¯ â€œItem position overlapâ€ï¼ˆé¡¹ç›®ä½ç½®é‡å ï¼‰ markDeleted(&quot;Item position overlap&quot;); } }} è·Ÿè¸ª BgDataModel çš„ addItem() æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/BgDataModel.javapublic class BgDataModel { public synchronized void addItem( Context context, ItemInfo item, boolean newItem, @Nullable LoaderMemoryLogger logger) { // æ—¥å¿—è®°å½• if (logger != null) { logger.addLog( Log.DEBUG, TAG, String.format(&quot;Adding item to ID map: %s&quot;, item.toString()), /* stackTrace= */ null); } // å°† ItemInfo çš„ ID å’Œé¡¹ç›®æœ¬èº«æ·»åŠ åˆ° itemsIdMap æ˜ å°„ä¸­ã€‚è¿™æ˜¯ä¸€ä¸ª ID åˆ° ItemInfo å¯¹è±¡çš„æ˜ å°„ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾é¡¹ç›® itemsIdMap.put(item.id, item); // æ ¹æ® ItemInfo ç±»å‹è¿›è¡Œåˆ†ç±»å¤„ç† switch (item.itemType) { case LauncherSettings.Favorites.ITEM_TYPE_FOLDER: // æ–‡ä»¶å¤¹ case LauncherSettings.Favorites.ITEM_TYPE_APP_PAIR: // åº”ç”¨å¯¹ // å°†æ–‡ä»¶å¤¹çš„ ID å’Œ FolderInfo å¯¹è±¡å­˜å‚¨åˆ° folders æ˜ å°„ä¸­ folders.put(item.id, (FolderInfo) item); // åŒæ—¶æ·»åŠ åˆ° workspaceItems é›†åˆï¼Œä»¥ä¾¿åœ¨å·¥ä½œåŒºæ˜¾ç¤º workspaceItems.add(item); break; case LauncherSettings.Favorites.ITEM_TYPE_DEEP_SHORTCUT: // æ·±å±‚å¿«æ·æ–¹å¼ case LauncherSettings.Favorites.ITEM_TYPE_APPLICATION: // åº”ç”¨ case LauncherSettings.Favorites.ITEM_TYPE_SHORTCUT: // å¿«æ·æ–¹å¼ // æ£€æŸ¥ container å€¼å†³å®šå­˜å‚¨ä½ç½® if (item.container == LauncherSettings.Favorites.CONTAINER_DESKTOP || item.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT) { // å¦‚æœæ˜¯æ¡Œé¢æˆ–è€… HotSeat åŒºåŸŸï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ° workspaceItems workspaceItems.add(item); } else { // å¦‚æœ item åº”æ·»åŠ åˆ°æ–‡ä»¶å¤¹å†…éƒ¨ï¼Œå…ˆæ£€æŸ¥è¯¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ if (newItem) { // è‹¥æ˜¯æ–° item ä¸”æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œè®°å½•é”™è¯¯æ—¥å¿—ï¼Œè¡¨æ˜å°è¯•æ·»åŠ åˆ°ä¸å­˜åœ¨çš„æ–‡ä»¶å¤¹ if (!folders.containsKey(item.container)) { // Adding an item to a nonexistent collection. String msg = &quot;attempted to add item: &quot; + item + &quot; to a nonexistent app&quot; + &quot; collection&quot;; Log.e(TAG, msg); } } else { // è‹¥æ–‡ä»¶å¤¹å­˜åœ¨ï¼Œè°ƒç”¨ findOrMakeFolder æ–¹æ³•è·å–æ–‡ä»¶å¤¹ï¼Œå¹¶å°†é¡¹ç›®æ·»åŠ åˆ°è¯¥æ–‡ä»¶å¤¹ findOrMakeFolder(item.container).add((WorkspaceItemInfo) item, false); } } break; case LauncherSettings.Favorites.ITEM_TYPE_APPWIDGET: // å°éƒ¨ä»¶ case LauncherSettings.Favorites.ITEM_TYPE_CUSTOM_APPWIDGET: // è‡ªå®šä¹‰å°éƒ¨ä»¶ // å¼ºåˆ¶è½¬æ¢ä¸º LauncherAppWidgetInfo ç±»å‹ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° appWidgets é›†åˆ appWidgets.add((LauncherAppWidgetInfo) item); break; } // å¦‚æœ item æ˜¯æ–°æ·»åŠ çš„æ·±å±‚å¿«æ·æ–¹å¼ï¼Œè°ƒç”¨ updateShortcutPinnedState æ–¹æ³•æ›´æ–°å¿«æ·æ–¹å¼çš„å›ºå®šçŠ¶æ€ if (newItem &amp;&amp; item.itemType == LauncherSettings.Favorites.ITEM_TYPE_DEEP_SHORTCUT) { // è¯¥æ–¹æ³•ä½¿ç”¨ä¸Šä¸‹æ–‡å’Œç”¨æˆ·ä¿¡æ¯æ›´æ–°å¿«æ·æ–¹å¼çš„å›ºå®šçŠ¶æ€ï¼ˆPinned çŠ¶æ€ï¼‰ updateShortcutPinnedState(context, item.user); } }} æ–‡ä»¶å¤¹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/LoaderTask.javapublic class LoaderTask implements Runnable { private void processWorkspaceItem(LoaderCursor c, LoaderMemoryLogger memoryLogger, HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs, boolean isSdCardReady, PackageUserKey tempPackageKey, WidgetManagerHelper widgetHelper, PackageManagerHelper pmHelper, List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos, LongSparseArray&lt;Boolean&gt; unlockedUsers, boolean isSafeMode, List&lt;ShortcutInfo&gt; allDeepShortcuts) { try { ... switch (c.itemType) { case Favorites.ITEM_TYPE_SHORTCUT: // å¦‚æœæ˜¯å¿«æ·æ–¹å¼ case Favorites.ITEM_TYPE_APPLICATION: // å¦‚æœæ˜¯åº”ç”¨ç¨‹åº case Favorites.ITEM_TYPE_DEEP_SHORTCUT: // å¦‚æœæ˜¯æ·±å±‚å¿«æ·æ–¹å¼ ... // åº”ç”¨/å¿«æ·æ–¹å¼å¤„ç†é€»è¾‘ ---------------------------------------------------------------------- case Favorites.ITEM_TYPE_FOLDER: // å¦‚æœæ˜¯æ–‡ä»¶å¤¹ç±»å‹ // ä»åå°æ•°æ®æ¨¡å‹ä¸­æŸ¥æ‰¾æˆ–åˆ›å»ºæ–‡ä»¶å¤¹ä¿¡æ¯å¯¹è±¡ FolderInfo folderInfo = mBgDataModel.findOrMakeFolder(c.id); // åº”ç”¨é€šç”¨å±æ€§åˆ°æ–‡ä»¶å¤¹ä¿¡æ¯å¯¹è±¡ c.applyCommonProperties(folderInfo); // ä¸è¦ä½¿ç”¨ c.getTitle()ï¼Œå› ä¸ºæ­¤æ–¹æ³•å·²å°†å…¶ç¼“å­˜åœ¨ FolderInfo ä¸­ folderInfo.title = c.getString(c.mTitleIndex); // è®¾ç½®æ–‡ä»¶å¤¹åœ¨å·¥ä½œåŒºçš„å ç”¨å®½åº¦å’Œé«˜åº¦ï¼ˆå•ä½æ˜¯æ ¼å­ï¼‰ folderInfo.spanX = 1; folderInfo.spanY = 1; // åº”ç”¨æ–‡ä»¶å¤¹çš„å…¶ä»–é€‰é¡¹ folderInfo.options = c.getOptions(); // æ¢å¤æ ‡è®°ä¸ºå·²æ¢å¤ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†æ¢å¤çš„æ–‡ä»¶å¤¹ c.markRestored(); // æ£€æŸ¥å¹¶æ·»åŠ æ–‡ä»¶å¤¹ä¿¡æ¯åˆ°æ•°æ®æ¨¡å‹ï¼Œå¹¶è®°å½•å†…å­˜ä½¿ç”¨æƒ…å†µ c.checkAndAddItem(folderInfo, mBgDataModel, memoryLogger); break; // ===&gt;&gt;&gt; æ–‡ä»¶å¤¹ç±»å‹å¤„ç†å®Œæ¯• ... } } catch (Exception e) { Log.e(TAG, &quot;Desktop items loading interrupted&quot;, e); } }} è¿™é‡Œæˆ‘ä»¬çœ‹ä¸‹ findOrMakeFolder() æ–¹æ³•ï¼š 123456789101112131415161718ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/BgDataModel.javapublic class BgDataModel { public synchronized FolderInfo findOrMakeFolder(int id) { // é€šè¿‡ id ä» folders æ˜ å°„ä¸­è·å–å¯¹åº”çš„ FolderInfo å¯¹è±¡ FolderInfo folderInfo = folders.get(id); if (folderInfo == null) { // å¦‚æœæ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ FolderInfo å®ä¾‹ folderInfo = new FolderInfo(); // æ–°çš„ FolderInfo å®ä¾‹ä»¥ id ä¸ºé”®å­˜å…¥ folders æ˜ å°„ä¸­ï¼Œ // ç¡®ä¿ä¸‹æ¬¡è®¿é—®åŒä¸€ id æ—¶å¯ä»¥ç›´æ¥è·å–è¯¥å¯¹è±¡ folders.put(id, folderInfo); } return folderInfo; }} Widget123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/LoaderTask.javapublic class LoaderTask implements Runnable { private void processWorkspaceItem(LoaderCursor c, LoaderMemoryLogger memoryLogger, HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs, boolean isSdCardReady, PackageUserKey tempPackageKey, WidgetManagerHelper widgetHelper, PackageManagerHelper pmHelper, List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos, LongSparseArray&lt;Boolean&gt; unlockedUsers, boolean isSafeMode, List&lt;ShortcutInfo&gt; allDeepShortcuts) { try { ... switch (c.itemType) { case Favorites.ITEM_TYPE_SHORTCUT: // å¦‚æœæ˜¯å¿«æ·æ–¹å¼ case Favorites.ITEM_TYPE_APPLICATION: // å¦‚æœæ˜¯åº”ç”¨ç¨‹åº case Favorites.ITEM_TYPE_DEEP_SHORTCUT: // å¦‚æœæ˜¯æ·±å±‚å¿«æ·æ–¹å¼ ... // åº”ç”¨/å¿«æ·æ–¹å¼å¤„ç†é€»è¾‘ ---------------------------------------------------------------------- case Favorites.ITEM_TYPE_FOLDER: // å¦‚æœæ˜¯æ–‡ä»¶å¤¹ç±»å‹ ... // æ–‡ä»¶å¤¹ç±»å‹å¤„ç†é€»è¾‘ ---------------------------------------------------------------------- case Favorites.ITEM_TYPE_APPWIDGET: // å¦‚æœç±»å‹æ˜¯åº”ç”¨å°éƒ¨ä»¶ // æ£€æŸ¥æ˜¯å¦ç¦ç”¨æ‰€æœ‰å°éƒ¨ä»¶ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å› if (WidgetsModel.GO_DISABLE_WIDGETS) { c.markDeleted(&quot;Only legacy shortcuts can have null package&quot;); return; } // Follow throughï¼Œç»§ç»­å¤„ç†å…¶ä»–å°éƒ¨ä»¶ç±»å‹ case Favorites.ITEM_TYPE_CUSTOM_APPWIDGET: // å¦‚æœç±»å‹æ˜¯è‡ªå®šä¹‰çš„åº”ç”¨å°éƒ¨ä»¶ // è¯»å–æ‰€æœ‰ Launcher ç‰¹å®šçš„å°éƒ¨ä»¶è¯¦ç»†ä¿¡æ¯ boolean customWidget = c.itemType == Favorites.ITEM_TYPE_CUSTOM_APPWIDGET; // è·å–å°éƒ¨ä»¶çš„ ID int appWidgetId = c.getAppWidgetId(); // ä¸ºåº”ç”¨å°éƒ¨ä»¶æ¢å¤è·å– Provider çš„å­—ç¬¦ä¸² String savedProvider = c.getAppWidgetProvider(); final ComponentName component; // å¦‚æœé€‰é¡¹ä¸­åŒ…å«æœç´¢å°éƒ¨ä»¶æ ‡å¿— if ((c.getOptions() &amp; LauncherAppWidgetInfo.OPTION_SEARCH_WIDGET) != 0) { // è·å–æœç´¢å°éƒ¨ä»¶çš„ç»„ä»¶åç§° component = QsbContainerView.getSearchComponentName(mApp.getContext()); if (component == null) { // å¦‚æœç»„ä»¶ä¸ºç©ºï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å› c.markDeleted(&quot;Discarding SearchWidget without packagename &quot;); return; } } else { // ä»ä¿å­˜çš„å­—ç¬¦ä¸²ä¸­è§£æç»„ä»¶åç§° component = ComponentName.unflattenFromString(savedProvider); } // æ£€æŸ¥å°éƒ¨ä»¶çš„ ID æ˜¯å¦æœ‰æ•ˆ final boolean isIdValid = !c.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID); // æ£€æŸ¥å°éƒ¨ä»¶çš„ Provider æ˜¯å¦å·²å‡†å¤‡å¥½ final boolean wasProviderReady = !c.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY); // åˆ›å»ºä¸€ä¸ªåŒ…å«ç»„ä»¶åç§°å’Œç”¨æˆ·çš„ ComponentKey ComponentKey providerKey = new ComponentKey(component, c.user); // å¦‚æœ mWidgetProvidersMap ä¸åŒ…å«è¯¥é”®ï¼Œåˆ™æŸ¥æ‰¾å¹¶æ·»åŠ å°éƒ¨ä»¶ Provider if (!mWidgetProvidersMap.containsKey(providerKey)) { mWidgetProvidersMap.put(providerKey, widgetHelper.findProvider(component, c.user)); } // ä» mWidgetProvidersMap ä¸­è·å–å°éƒ¨ä»¶ Provider ä¿¡æ¯ final AppWidgetProviderInfo provider = mWidgetProvidersMap.get(providerKey); // æ£€æŸ¥å°éƒ¨ä»¶ Provider æ˜¯å¦æœ‰æ•ˆ final boolean isProviderReady = isValidProvider(provider); // å¦‚æœä¸æ˜¯å®‰å…¨æ¨¡å¼ã€ä¸æ˜¯è‡ªå®šä¹‰å°éƒ¨ä»¶ã€å°éƒ¨ä»¶ Provider æ›¾ç»å‡†å¤‡å¥½ä½†ç°åœ¨ä¸å†å‡†å¤‡å¥½ if (!isSafeMode &amp;&amp; !customWidget &amp;&amp; wasProviderReady &amp;&amp; !isProviderReady) { // æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å› c.markDeleted(&quot;Deleting widget that isn't installed anymore: &quot; + provider); } else { // å¤„ç†å°éƒ¨ä»¶æ¢å¤çŠ¶æ€ LauncherAppWidgetInfo appWidgetInfo; if (isProviderReady) { // å¦‚æœå°éƒ¨ä»¶ Provider å‡†å¤‡å¥½ï¼Œåˆ™åˆ›å»ºå°éƒ¨ä»¶ä¿¡æ¯ appWidgetInfo = new LauncherAppWidgetInfo(appWidgetId, provider.provider); // Provider å¯ç”¨ï¼Œå°éƒ¨ä»¶è¦ä¹ˆå¯ç”¨ï¼Œè¦ä¹ˆä¸å¯ç”¨ï¼Œä¸éœ€è¦è·Ÿè¸ªæœªæ¥çš„æ¢å¤æ›´æ–° int status = c.restoreFlag &amp; ~LauncherAppWidgetInfo.FLAG_RESTORE_STARTED &amp; ~LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY; if (!wasProviderReady) { // å¦‚æœ Provider ä¹‹å‰æœªå‡†å¤‡å¥½ï¼Œåˆ™æ›´æ–°çŠ¶æ€å’Œ UI æ ‡å¿— if (isIdValid) { status |= LauncherAppWidgetInfo.FLAG_UI_NOT_READY; } } appWidgetInfo.restoreStatus = status; } else { // å¦‚æœ Provider ä¸å¯ç”¨ï¼Œè®°å½•æ¢å¤çŠ¶æ€å¹¶åˆ›å»ºå°éƒ¨ä»¶ä¿¡æ¯ Log.v(TAG, &quot;Widget restore pending id=&quot; + c.id + &quot; appWidgetId=&quot; + appWidgetId + &quot; status =&quot; + c.restoreFlag); appWidgetInfo = new LauncherAppWidgetInfo(appWidgetId, component); appWidgetInfo.restoreStatus = c.restoreFlag; // æ›´æ–°ä¸´æ—¶åŒ…é”®å¹¶è·å–å®‰è£…è¿›åº¦ tempPackageKey.update(component.getPackageName(), c.user); SessionInfo si = installingPkgs.get(tempPackageKey); Integer installProgress = si == null ? null : (int) (si.getProgress() * 100); if (c.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_RESTORE_STARTED)) { // æ¢å¤å·²ç»å¼€å§‹ä¸€æ¬¡ } else if (installProgress != null) { // åº”ç”¨æ¢å¤å·²ç»å¼€å§‹ï¼Œæ›´æ–°æ ‡å¿— appWidgetInfo.restoreStatus |= LauncherAppWidgetInfo.FLAG_RESTORE_STARTED; } else if (!isSafeMode) { // å¦‚æœä¸æ˜¯å®‰å…¨æ¨¡å¼ï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å› c.markDeleted(&quot;Unrestored widget removed: &quot; + component); return; } // è®¾ç½®å®‰è£…è¿›åº¦ appWidgetInfo.installProgress = installProgress == null ? 0 : installProgress; } // å¦‚æœæ¢å¤æ ‡å¿—åŒ…å«ç›´æ¥é…ç½®æ ‡å¿—ï¼Œåˆ™è®¾ç½®ç»‘å®šé€‰é¡¹ if (appWidgetInfo.hasRestoreFlag( LauncherAppWidgetInfo.FLAG_DIRECT_CONFIG)) { appWidgetInfo.bindOptions = c.parseIntent(); } // åº”ç”¨é€šç”¨å±æ€§åˆ°å°éƒ¨ä»¶ä¿¡æ¯ c.applyCommonProperties(appWidgetInfo); // è®¾ç½®å°éƒ¨ä»¶çš„å ç”¨æ ¼å­æ•°é‡ appWidgetInfo.spanX = c.getSpanX(); appWidgetInfo.spanY = c.getSpanY(); // è®¾ç½®å°éƒ¨ä»¶çš„é€‰é¡¹ appWidgetInfo.options = c.getOptions(); // è®¾ç½®ç”¨æˆ·ä¿¡æ¯ appWidgetInfo.user = c.user; // è®¾ç½®å°éƒ¨ä»¶çš„æ¥æºå®¹å™¨ appWidgetInfo.sourceContainer = c.getAppWidgetSource(); // å¦‚æœå°éƒ¨ä»¶çš„å¤§å°æ— æ•ˆï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å› if (appWidgetInfo.spanX &lt;= 0 || appWidgetInfo.spanY &lt;= 0) { c.markDeleted(&quot;Widget has invalid size: &quot; + appWidgetInfo.spanX + &quot;x&quot; + appWidgetInfo.spanY); return; } // è·å–å°éƒ¨ä»¶ Provider çš„ä¿¡æ¯å¹¶æ£€æŸ¥å…¶æœ€å°å°ºå¯¸è¦æ±‚ LauncherAppWidgetProviderInfo widgetProviderInfo = widgetHelper.getLauncherAppWidgetInfo(appWidgetId); if (widgetProviderInfo != null &amp;&amp; (appWidgetInfo.spanX &lt; widgetProviderInfo.minSpanX || appWidgetInfo.spanY &lt; widgetProviderInfo.minSpanY)) { FileLog.d(TAG, &quot;Widget &quot; + widgetProviderInfo.getComponent() + &quot; minSizes not meet: span=&quot; + appWidgetInfo.spanX + &quot;x&quot; + appWidgetInfo.spanY + &quot; minSpan=&quot; + widgetProviderInfo.minSpanX + &quot;x&quot; + widgetProviderInfo.minSpanY); logWidgetInfo(mApp.getInvariantDeviceProfile(), widgetProviderInfo); } // å¦‚æœå°éƒ¨ä»¶ä¸åœ¨å·¥ä½œåŒºæˆ– HotSeat ä¸­ï¼Œåˆ™æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶è¿”å› if (!c.isOnWorkspaceOrHotseat()) { c.markDeleted(&quot;Widget found where container != CONTAINER_DESKTOP&quot; + &quot;nor CONTAINER_HOTSEAT - ignoring!&quot;); return; } // å¦‚æœä¸æ˜¯è‡ªå®šä¹‰å°éƒ¨ä»¶ï¼Œæ£€æŸ¥ Provider åç§°æ˜¯å¦åŒ¹é…ï¼Œæ›´æ–°çŠ¶æ€ if (!customWidget) { String providerName = appWidgetInfo.providerName.flattenToString(); if (!providerName.equals(savedProvider) || (appWidgetInfo.restoreStatus != c.restoreFlag)) { c.updater() .put(Favorites.APPWIDGET_PROVIDER, providerName) .put(Favorites.RESTORED, appWidgetInfo.restoreStatus) .commit(); } } // å¦‚æœæ¢å¤çŠ¶æ€ä¸æ˜¯å®Œæˆï¼Œåˆ™åˆ›å»ºå¾…å¤„ç†çš„å°éƒ¨ä»¶ä¿¡æ¯å¹¶è·å–æ ‡é¢˜å’Œå›¾æ ‡ if (appWidgetInfo.restoreStatus != LauncherAppWidgetInfo.RESTORE_COMPLETED) { appWidgetInfo.pendingItemInfo = WidgetsModel.newPendingItemInfo( mApp.getContext(), appWidgetInfo.providerName, appWidgetInfo.user); mIconCache.getTitleAndIconForApp( appWidgetInfo.pendingItemInfo, false); } // æ£€æŸ¥å¹¶æ·»åŠ å°éƒ¨ä»¶ä¿¡æ¯åˆ°æ•°æ®æ¨¡å‹ä¸­ c.checkAndAddItem(appWidgetInfo, mBgDataModel); } break; } } catch (Exception e) { Log.e(TAG, &quot;Desktop items loading interrupted&quot;, e); } }} è‡³æ­¤ï¼ŒloadWorkspace() çš„å·¥ä½œç®—æ˜¯åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ç»‘å®šçš„æµç¨‹ï¼ ç»‘å®š Workspace æµç¨‹è§£æç»‘å®š Workspace æ˜¯é€šè¿‡ LauncherBinder çš„ bindWorkspace() å‡½æ•°ï¼Œåœ¨å…¶çˆ¶ç±» BaseLauncherBinder ä¸­å®šä¹‰ã€‚ 1234567891011121314151617181920212223242526ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.javapublic abstract class BaseLauncherBinder { /* * Binds all loaded data to actual views on the main thread. */ public void bindWorkspace(boolean incrementBindId, boolean isBindSync) { /** * ENABLE_WORKSPACE_LOADING_OPTIMIZATION æ ‡å¿—ä¸»è¦ç”¨äºï¼š * * æ§åˆ¶ä¸€ç³»åˆ—ä¸å·¥ä½œåŒºåŠ è½½è¿‡ç¨‹ç›¸å…³çš„ä¼˜åŒ–æªæ–½ã€‚è¿™äº›ä¼˜åŒ–å¯èƒ½æ¶µç›–äº†åŠ è½½é€Ÿåº¦ã€ * å†…å­˜ä½¿ç”¨ã€I/O æ“ä½œç­‰æ–¹é¢çš„æ”¹è¿›ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒã€‚ * Log å®æµ‹ä¸º falseï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç•¥è¿‡è¿™ä¸ªæ¡ä»¶åˆ¤æ–­ã€‚ */ if (FeatureFlags.ENABLE_WORKSPACE_LOADING_OPTIMIZATION.get()) { DisjointWorkspaceBinder workspaceBinder = initWorkspaceBinder(incrementBindId, mBgDataModel.collectWorkspaceScreens()); workspaceBinder.bindCurrentWorkspacePages(isBindSync); workspaceBinder.bindOtherWorkspacePages(); } else { bindWorkspaceAllAtOnce(incrementBindId, isBindSync); } } } æ‰€ä»¥ï¼Œç°åœ¨æˆ‘ä»¬ç»§ç»­è·Ÿè¸ª bindWorkspaceAllAtOnce() æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.javapublic abstract class BaseLauncherBinder { // ä¸€æ¬¡æ€§ç»‘å®šå·¥ä½œåŒºä¸­çš„æ‰€æœ‰é¡¹ç›®ï¼ˆåº”ç”¨å›¾æ ‡ã€å°éƒ¨ä»¶ã€å±å¹•ç­‰ï¼‰ private void bindWorkspaceAllAtOnce(boolean incrementBindId, boolean isBindSync) { /** * åˆå§‹åŒ–é›†åˆï¼š * workspaceItems : ç”¨äºå­˜å‚¨å·¥ä½œåŒºä¸­çš„é¡¹ç›®ï¼ˆåº”ç”¨å›¾æ ‡ã€å¿«æ·æ–¹å¼ç­‰ï¼‰ * appWidgets : ç”¨äºå­˜å‚¨å·¥ä½œåŒºä¸­çš„å°éƒ¨ä»¶ * orderedScreenIds: ä¿å­˜å·¥ä½œåŒºçš„å±å¹• IDï¼Œç¡®ä¿æ‰€æœ‰ Item æŒ‰å±å¹•é¡ºåºæ’åˆ— * extraItems : å­˜å‚¨å›ºå®šå®¹å™¨ä¸­çš„é¢å¤–é¡¹ç›®ï¼Œé€šå¸¸æ˜¯ä¸€äº›ç‰¹æ®Šçš„å›ºå®šå…ƒç´  */ ArrayList&lt;ItemInfo&gt; workspaceItems = new ArrayList&lt;&gt;(); ArrayList&lt;LauncherAppWidgetInfo&gt; appWidgets = new ArrayList&lt;&gt;(); final IntArray orderedScreenIds = new IntArray(); ArrayList&lt;FixedContainerItems&gt; extraItems = new ArrayList&lt;&gt;(); final int workspaceItemCount; /** * ä»åå°æ•°æ®æ¨¡å‹ä¸­è·å–æ•°æ® */ synchronized (mBgDataModel) { /** * å°† mBgDataModel ä¸­çš„æ‰€æœ‰å·¥ä½œåŒºé¡¹ç›®å¤åˆ¶åˆ° workspaceItems */ workspaceItems.addAll(mBgDataModel.workspaceItems); /** * å°†æ‰€æœ‰å°éƒ¨ä»¶å¤åˆ¶åˆ° appWidgets */ appWidgets.addAll(mBgDataModel.appWidgets); /** * ä» mBgDataModel ä¸­æ”¶é›†å¹¶æ’åºå±å¹• ID */ orderedScreenIds.addAll(mBgDataModel.collectWorkspaceScreens()); /** * å¤åˆ¶å›ºå®šå®¹å™¨ä¸­çš„é¢å¤–é¡¹ç›® */ mBgDataModel.extraItems.forEach(extraItems::add); if (incrementBindId) { mBgDataModel.lastBindId++; } mMyBindingId = mBgDataModel.lastBindId; workspaceItemCount = mBgDataModel.itemsIdMap.size(); } /** * æ‰¹é‡ç»‘å®šåˆ°å‰å° * * éå†å›è°ƒåˆ—è¡¨ mCallbacksListï¼Œå¯¹æ¯ä¸ªå›è°ƒå®ä¾‹æ‰§è¡Œç»‘å®šæ“ä½œ */ for (Callbacks cb : mCallbacksList) { // åˆ›å»º UnifiedWorkspaceBinder å®ä¾‹å¹¶è°ƒç”¨å…¶ bind æ–¹æ³• new UnifiedWorkspaceBinder(cb, mUiExecutor, mApp, mBgDataModel, mMyBindingId, workspaceItems, appWidgets, extraItems, orderedScreenIds) .bind(isBindSync, workspaceItemCount); } }} è¯¥å‡½æ•°ä¸­ï¼Œåˆ›å»ºäº† workspaceItemsã€appWidgetsã€orderedScreenIdsï¼ˆå±å¹•æ•°ï¼‰ç­‰ä¿¡æ¯çš„æ•°ç»„ã€‚ç„¶ååˆ›å»º UnifiedWorkspaceBinderï¼Œè°ƒç”¨å…¶ bind() å‡½æ•°å¼€å§‹ç»‘å®šã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.javapublic abstract class BaseLauncherBinder { private class UnifiedWorkspaceBinder { /** * æŒ‰é¡ºåºå°†å·¥ä½œåŒºä¸­çš„é¡¹ç›®ç»‘å®šåˆ° UI ä¸Šï¼Œåˆ†æ‰¹åŠ è½½å½“å‰å±å¹•å’Œå…¶ä»–å±å¹•çš„é¡¹ç›® */ private void bind(boolean isBindSync, int workspaceItemCount) { /** * è·å–å½“å‰å±å¹• ID é›†åˆ */ final IntSet currentScreenIds = mCallbacks.getPagesToBindSynchronously(mOrderedScreenIds); /** * ä¿è·å–åˆ°çš„å±å¹• ID é›†åˆéç©ºï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ */ Objects.requireNonNull(currentScreenIds, &quot;Null screen ids provided by &quot; + mCallbacks); /** * ç­›é€‰å½“å‰å±å¹•çš„é¡¹ç›®ï¼š * currentWorkspaceItems: å½“å‰å±å¹•çš„åº”ç”¨é¡¹ç›® * otherWorkspaceItems : å…¶ä»–å±å¹•çš„åº”ç”¨é¡¹ç›® * currentAppWidgets : å½“å‰å±å¹•çš„å°éƒ¨ä»¶ * otherAppWidgets : å…¶ä»–å±å¹•çš„å°éƒ¨ä»¶ */ ArrayList&lt;ItemInfo&gt; currentWorkspaceItems = new ArrayList&lt;&gt;(); ArrayList&lt;ItemInfo&gt; otherWorkspaceItems = new ArrayList&lt;&gt;(); ArrayList&lt;LauncherAppWidgetInfo&gt; currentAppWidgets = new ArrayList&lt;&gt;(); ArrayList&lt;LauncherAppWidgetInfo&gt; otherAppWidgets = new ArrayList&lt;&gt;(); /** * å°† mWorkspaceItems å’Œ mAppWidgets ä¸­çš„é¡¹ç›®åˆ†æˆå½“å‰å±å¹•å’Œå…¶ä»–å±å¹•çš„ä¸¤éƒ¨åˆ† */ filterCurrentWorkspaceItems(currentScreenIds, mWorkspaceItems, currentWorkspaceItems, otherWorkspaceItems); filterCurrentWorkspaceItems(currentScreenIds, mAppWidgets, currentAppWidgets, otherAppWidgets); /** * ç©ºé—´æ’åº * * è·å–è®¾å¤‡é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å±å¹•å¸ƒå±€å’Œç½‘æ ¼ä¿¡æ¯ */ final InvariantDeviceProfile idp = mApp.getInvariantDeviceProfile(); /** * å½“å‰å±å¹•å’Œå…¶ä»–å±å¹•çš„é¡¹ç›®åˆ†åˆ«è¿›è¡Œç©ºé—´æ’åºï¼Œç¡®ä¿é¡¹ç›®åœ¨å±å¹•ä¸ŠæŒ‰ä½ç½®æ˜¾ç¤º */ sortWorkspaceItemsSpatially(idp, currentWorkspaceItems); sortWorkspaceItemsSpatially(idp, otherWorkspaceItems); /** * é€šçŸ¥ UI å¼€å§‹ç»‘å®š */ executeCallbacksTask(c -&gt; { c.clearPendingBinds(); // æ¸…é™¤ UI ä¸­å¾…ç»‘å®šçš„é¡¹ç›®ï¼Œå‡†å¤‡æ–°é¡¹ç›®çš„ç»‘å®š c.startBinding(); // é€šçŸ¥å›è°ƒå¼€å§‹ç»‘å®šæ“ä½œ }, mUiExecutor); /** * ç»‘å®šå±å¹• ID */ executeCallbacksTask(c -&gt; c.bindScreens(mOrderedScreenIds), mUiExecutor); /** * å¾€å½“å‰çš„å±å¹•ä¸Šç»‘å®šæ•°æ®å†…å®¹ * bindWorkspaceItems : å°†å½“å‰å±å¹•çš„åº”ç”¨é¡¹ç›®ç»‘å®šåˆ° UI * bindAppWidgets : å°†å½“å‰å±å¹•çš„å°éƒ¨ä»¶ç»‘å®šåˆ° UI */ bindWorkspaceItems(currentWorkspaceItems, mUiExecutor); bindAppWidgets(currentAppWidgets, mUiExecutor); /** * ç»‘å®šé¢å¤–å®¹å™¨ä¸­çš„é¡¹ç›® */ if (!FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) { mExtraItems.forEach(item -&gt; executeCallbacksTask(c -&gt; c.bindExtraContainerItems(item), mUiExecutor)); } /** * åŠ è½½å…¶ä»–å±å¹•çš„é¡¹ç›® * * åˆ›å»ºä¸€ä¸ª RunnableList ç”¨äºæ”¶é›†å…¶ä»–å±å¹•çš„é¡¹ç›®ç»‘å®šä»»åŠ¡ï¼Œå°†ä»»åŠ¡æ·»åŠ åˆ° pendingTasks åˆ—è¡¨ */ RunnableList pendingTasks = new RunnableList(); Executor pendingExecutor = pendingTasks::add; /** * å°†å…¶ä»–å±å¹•çš„åº”ç”¨é¡¹ç›®å’Œå°éƒ¨ä»¶ç»‘å®šåˆ°å¾…æ‰§è¡Œåˆ—è¡¨ï¼Œå»¶åæ˜¾ç¤º */ bindWorkspaceItems(otherWorkspaceItems, pendingExecutor); bindAppWidgets(otherAppWidgets, pendingExecutor); /** * åœ¨å…¶ä»–å±å¹•çš„é¡¹ç›®åŠ è½½å®Œæˆåï¼Œé€šçŸ¥ UI ç»‘å®šå·²å®Œæˆ */ executeCallbacksTask(c -&gt; c.finishBindingItems(currentScreenIds), pendingExecutor); /** * æ‰§è¡Œå¼‚æ­¥åŠ è½½å®Œæˆæ“ä½œ */ pendingExecutor.execute( () -&gt; { MODEL_EXECUTOR.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT); ItemInstallQueue.INSTANCE.get(mApp.getContext()) .resumeModelPush(FLAG_LOADER_RUNNING); }); /** * å›è°ƒåˆå§‹ç»‘å®šå®Œæˆäº‹ä»¶ */ executeCallbacksTask( c -&gt; { MODEL_EXECUTOR.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND); c.onInitialBindComplete( currentScreenIds, pendingTasks, workspaceItemCount, isBindSync); }, mUiExecutor); /** * ç»‘å®šå­—ç¬¦ä¸²ç¼“å­˜ */ mCallbacks.bindStringCache(mBgDataModel.stringCache.clone()); } }} UnifiedWorkspaceBinder çš„ bind() å‡½æ•°ä¸­ï¼Œé¦–å…ˆæ‹¿åˆ°å½“å‰å±å¹•ï¼ˆå°±æ˜¯å‘ˆç°ç»™ç”¨æˆ·çš„ç¬¬ä¸€ä¸ªå±å¹•ï¼‰IDï¼Œç„¶åä¼˜å…ˆå¾€ç¬¬ä¸€ä¸ªå±å¹•ä¸Šç»‘å®šå†…å®¹ï¼Œä¹‹åå†ç»‘å®šå…¶ä»–å±å¹•çš„å†…å®¹ã€‚ ç»‘å®šå±å¹•1234567891011121314151617181920212223242526272829303132333435363738ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/Launcher.javapublic class Launcher extends StatefulActivity&lt;LauncherState&gt; implements LauncherExterns, Callbacks, InvariantDeviceProfile.OnIDPChangeListener, PluginListener&lt;LauncherOverlayPlugin&gt; { @Override public void bindScreens(IntArray orderedScreenIds) { /** * ä¹‰ç¬¬ä¸€ä¸ªå±å¹•çš„ä½ç½®ç´¢å¼•ï¼Œé€šå¸¸ä¸º 0 */ int firstScreenPosition = 0; /** * è°ƒæ•´é¦–å±ï¼ˆé»˜è®¤å±å¹•ï¼‰çš„ä½ç½® */ if (FeatureFlags.QSB_ON_FIRST_SCREEN &amp;&amp; orderedScreenIds.indexOf(Workspace.FIRST_SCREEN_ID) != firstScreenPosition) { // è¿™ä¸€æ“ä½œç¡®ä¿åœ¨å¯ç”¨äº† QSB_ON_FIRST_SCREEN (Google Search æ¡†)çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤å±å¹•å§‹ç»ˆä½äºç¬¬ä¸€ä¸ªä½ç½® orderedScreenIds.removeValue(Workspace.FIRST_SCREEN_ID); orderedScreenIds.add(firstScreenPosition, Workspace.FIRST_SCREEN_ID); } else if (!FeatureFlags.QSB_ON_FIRST_SCREEN &amp;&amp; orderedScreenIds.isEmpty()) { // å¦‚æœç‰¹æ€§æœªå¯ç”¨ä¸”æ²¡æœ‰ä»»ä½•å±å¹•ï¼Œåˆ™æ·»åŠ ä¸€ä¸ªç©ºå±å¹• mWorkspace.addExtraEmptyScreens(); } /** * å°† orderedScreenIds ç»‘å®šåˆ°å·¥ä½œåŒºï¼Œè¿™ä¸€æ­¥ä¼šå°†å±å¹• ID åˆ—è¡¨æ­£å¼æ·»åŠ åˆ° UI ä¸­ï¼Œä½¿è¿™äº›å±å¹•å‡ºç°åœ¨å·¥ä½œåŒº */ bindAddScreens(orderedScreenIds); /** * è§£é”å£çº¸åç§»é”å®šï¼Œç¡®ä¿å±å¹•å¸ƒå±€åå£çº¸ä½ç½®æ­£ç¡® */ mWorkspace.unlockWallpaperFromDefaultPageOnNextLayout(); } } æˆ‘ä»¬ç»§ç»­è·Ÿè¸ª Launcher.bindAddScreens() æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/Launcher.javapublic class Launcher extends StatefulActivity&lt;LauncherState&gt; implements LauncherExterns, Callbacks, InvariantDeviceProfile.OnIDPChangeListener, PluginListener&lt;LauncherOverlayPlugin&gt; { private void bindAddScreens(IntArray orderedScreenIds) { /** * æ£€æŸ¥è®¾å¤‡é…ç½® mDeviceProfile æ˜¯å¦å¯ç”¨äº†åŒé¢æ¿æ¨¡å¼ï¼ˆä¾‹å¦‚å¹³æ¿æˆ–å¤§å±æ‰‹æœºåœ¨æ¨ªå±æ¨¡å¼ä¸‹æ˜¾ç¤ºå·¦å³åˆ†å±ï¼‰ * * è¿™é‡Œæˆ‘ä»¬å¯ä»¥æš‚æ—¶ä¸ç”¨å…³æ³¨ */ if (mDeviceProfile.isTwoPanels) { // Some empty pages might have been removed while the phone was in a single panel // mode, so we want to add those empty pages back. IntSet screenIds = IntSet.wrap(orderedScreenIds); orderedScreenIds.forEach(screenId -&gt; screenIds.add(mWorkspace.getScreenPair(screenId))); orderedScreenIds = screenIds.getArray(); } /** * è·å–å±å¹• ID åˆ—è¡¨çš„æ€»æ•° */ int count = orderedScreenIds.size(); /** * éå† orderedScreenIds ä¸­çš„æ¯ä¸ªå±å¹• IDï¼Œä¾æ¬¡è¿›è¡Œç»‘å®šå¤„ç† */ for (int i = 0; i &lt; count; i++) { int screenId = orderedScreenIds.get(i); /** * å¦‚æœ QSB_ON_FIRST_SCREEN ç‰¹æ€§å¯ç”¨ï¼Œå¹¶ä¸”å½“å‰å±å¹• ID ä¸ºé»˜è®¤é¦–å± IDï¼Œåˆ™è·³è¿‡ç»‘å®š * * åŸå› ï¼šé»˜è®¤é¦–å±åœ¨åˆå§‹åŒ–æ—¶é€šå¸¸å·²ç»ç»‘å®šï¼Œå› æ­¤æ— éœ€é‡å¤ç»‘å®šï¼ŒèŠ‚çœæ€§èƒ½å¼€é”€ */ if (FeatureFlags.QSB_ON_FIRST_SCREEN &amp;&amp; screenId == Workspace.FIRST_SCREEN_ID) { // No need to bind the first screen, as its always bound. continue; } /** * æ’å…¥æ–°çš„å±å¹• * * å¯¹äºæœªè·³è¿‡çš„å±å¹• IDï¼Œå°†å±å¹•æ’å…¥åˆ°ç©ºå±ä¹‹å‰ã€‚è¿™ç¡®ä¿å±å¹•åˆ—è¡¨çš„æœ‰åºæ˜¾ç¤ºï¼Œä¸”ç©ºå±åœ¨å±å¹•åºåˆ—çš„æœ€åæ˜¾ç¤ºã€‚ */ mWorkspace.insertNewWorkspaceScreenBeforeEmptyScreen(screenId); } } } ç»§ç»­è·Ÿè¸ª Workspace.insertNewWorkspaceScreenBeforeEmptyScreen() æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/Workspace.javapublic class Workspace&lt;T extends View &amp; PageIndicator&gt; extends PagedView&lt;T&gt; implements DropTarget, DragSource, View.OnTouchListener, DragController.DragListener, Insettable, StateHandler&lt;LauncherState&gt;, WorkspaceLayoutManager, LauncherBindableItemsContainer, LauncherOverlayCallbacks { /** * å°†æ–°å±å¹•æ’å…¥åˆ°ç©ºå±ï¼ˆå¦‚æœå­˜åœ¨ç©ºå±ï¼‰ä¹‹å‰ */ public void insertNewWorkspaceScreenBeforeEmptyScreen(int screenId) { /** * é¦–å…ˆæŸ¥æ‰¾ EXTRA_EMPTY_SCREEN_ID åœ¨ mScreenOrder ä¸­çš„ä½ç½® * * mScreenOrder ç»´æŠ¤äº†å½“å‰å±å¹•çš„é¡ºåº */ int insertIndex = mScreenOrder.indexOf(EXTRA_EMPTY_SCREEN_ID); if (insertIndex &lt; 0) { /** * å¦‚æœæœªæ‰¾åˆ°ç©ºå±ï¼Œè¡¨ç¤ºå°†æ–°å±å¹•æ’å…¥åˆ°æœ€å */ insertIndex = mScreenOrder.size(); } insertNewWorkspaceScreen(screenId, insertIndex); }} è·Ÿè¸ª Workspace.insertNewWorkspaceScreen() æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/Workspace.javapublic class Workspace&lt;T extends View &amp; PageIndicator&gt; extends PagedView&lt;T&gt; implements DropTarget, DragSource, View.OnTouchListener, DragController.DragListener, Insettable, StateHandler&lt;LauncherState&gt;, WorkspaceLayoutManager, LauncherBindableItemsContainer, LauncherOverlayCallbacks { /** * è´Ÿè´£å®é™…çš„å±å¹•å¸ƒå±€åˆ›å»ºå’Œæ’å…¥æ“ä½œ */ public CellLayout insertNewWorkspaceScreen(int screenId, int insertIndex) { /** * æ£€æŸ¥å±å¹•æ˜¯å¦å·²å­˜åœ¨ * * å¦‚æœ mWorkspaceScreens ä¸­å·²ç»å­˜åœ¨ç›¸åŒçš„ screenIdï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…é‡å¤æ’å…¥ç›¸åŒ ID çš„å±å¹• */ if (mWorkspaceScreens.containsKey(screenId)) { throw new RuntimeException(&quot;Screen id &quot; + screenId + &quot; already exists!&quot;); } /** * è·å–è®¾å¤‡é…ç½® DeviceProfileï¼Œç”¨äºå†³å®šå¸ƒå±€æ–‡ä»¶çš„é€‰æ‹© */ DeviceProfile dp = mLauncher.getDeviceProfile(); /** * å®šä¹‰æ–°çš„ CellLayout å®ä¾‹ */ CellLayout newScreen; /** * é€‰æ‹©å¸ƒå±€æ–‡ä»¶ï¼Œæ ¹æ®ç‰¹æ€§æ ‡å¿— FOLDABLE_SINGLE_PAGE å’Œè®¾å¤‡æ˜¯å¦ä¸ºåŒé¢æ¿æ¨¡å¼é€‰æ‹©å¸ƒå±€æ–‡ä»¶ * * æŠ˜å è®¾å¤‡ï¼šå¦‚æœä¸ºæŠ˜å å±è®¾å¤‡å¹¶å¤„äºåŒé¢æ¿æ¨¡å¼ï¼Œä½¿ç”¨ R.layout.workspace_screen_foldable å¸ƒå±€æ–‡ä»¶ * æ™®é€šè®¾å¤‡ï¼šå¦åˆ™ä½¿ç”¨æ ‡å‡†å¸ƒå±€æ–‡ä»¶ R.layout.workspace_screen */ if (FOLDABLE_SINGLE_PAGE.get() &amp;&amp; dp.isTwoPanels) { newScreen = (CellLayout) LayoutInflater.from(getContext()).inflate( R.layout.workspace_screen_foldable, this, false /* attachToRoot */); } else { newScreen = (CellLayout) LayoutInflater.from(getContext()).inflate( R.layout.workspace_screen, this, false /* attachToRoot */); } /** * å°†æ–°åˆ›å»ºçš„ CellLayout ä»¥ screenId ä¸ºé”®æ·»åŠ åˆ° mWorkspaceScreens æ˜ å°„ä¸­ */ mWorkspaceScreens.put(screenId, newScreen); /** * å°† screenId æŒ‰é¡ºåºæ’å…¥ mScreenOrder ä¸­ï¼Œä»¥ç»´æŠ¤æ­£ç¡®çš„å±å¹•é¡ºåº */ mScreenOrder.add(insertIndex, screenId); /** * å°†æ–°å±å¹•å¸ƒå±€è§†å›¾æ’å…¥åˆ° Workspace è§†å›¾çš„ insertIndex ä½ç½® */ addView(newScreen, insertIndex); /** * æ ¹æ®å½“å‰çŠ¶æ€ä¸ºæ–°å±å¹•åº”ç”¨è¿‡æ¸¡åŠ¨ç”»ï¼Œç¡®ä¿æ–°å±å¹•ä»¥æ­£ç¡®çš„åŠ¨ç”»æ•ˆæœå‡ºç°åœ¨å·¥ä½œåŒºä¸­ */ mStateTransitionAnimation.applyChildState( mLauncher.getStateManager().getState(), newScreen, insertIndex); /** * æ›´æ–°é¡µé¢æ»šåŠ¨å€¼ï¼Œä½¿å¾—é¡µé¢æ»šåŠ¨æ•ˆæœé€‚åº”æ–°å¸ƒå±€ */ updatePageScrollValues(); /** * æ•´æ–°å¸ƒå±€çš„å¡«å……ï¼ˆpaddingï¼‰ï¼Œç¡®ä¿å¸ƒå±€ä¹‹é—´çš„é—´è·ç»Ÿä¸€ */ updateCellLayoutPadding(); return newScreen; }} ç»‘å®šæ•°æ®å†…å®¹123456789101112131415161718192021222324252627282930313233343536373839404142ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.javapublic abstract class BaseLauncherBinder { private class UnifiedWorkspaceBinder { /** * å°†å·¥ä½œåŒºä¸­çš„é¡¹ç›®åˆ†å—ç»‘å®šåˆ° UI */ private void bindWorkspaceItems( final ArrayList&lt;ItemInfo&gt; workspaceItems, final Executor executor) { /** * è·å– workspaceItems åˆ—è¡¨ä¸­çš„é¡¹ç›®æ€»æ•° */ int count = workspaceItems.size(); /** * åˆ†å—ç»‘å®šé¡¹ç›® * * ITEMS_CHUNK æ˜¯å—å¤§å°çš„å¸¸é‡ï¼Œç”¨äºå®šä¹‰æ¯æ¬¡ç»‘å®šçš„æœ€å¤§é¡¹ç›®æ•°é‡ï¼Œé»˜è®¤ä¸º 6 */ for (int i = 0; i &lt; count; i += ITEMS_CHUNK) { /** * å—çš„èµ·å§‹ä½ç½® */ final int start = i; /** * å½“å‰å—çš„å¤§å° */ final int chunkSize = (i + ITEMS_CHUNK &lt;= count) ? ITEMS_CHUNK : (count - i); /** * æ‰§è¡Œç»‘å®šä»»åŠ¡ */ executeCallbacksTask( c -&gt; c.bindItems(workspaceItems.subList(start, start + chunkSize), false), executor); } } }} è°ƒç”¨ Launcher.bindItems() æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/Launcher.javapublic class Launcher extends StatefulActivity&lt;LauncherState&gt; implements LauncherExterns, Callbacks, InvariantDeviceProfile.OnIDPChangeListener, PluginListener&lt;LauncherOverlayPlugin&gt; { @Override public void bindItems(final List&lt;ItemInfo&gt; items, final boolean forceAnimateIcons) { bindItems(items, forceAnimateIcons, /* focusFirstItemForAccessibility= */ false); } public void bindItems( final List&lt;ItemInfo&gt; items, final boolean forceAnimateIcons, final boolean focusFirstItemForAccessibility) { /** * ç”¨äºå­˜å‚¨æ–° Item çš„åŠ¨ç”»æ•ˆæœ */ final Collection&lt;Animator&gt; bounceAnims = new ArrayList&lt;&gt;(); /** * åˆ¤æ–­æ˜¯å¦å…è®¸é¡µé¢åˆ‡æ¢åŠ¨ç”» */ boolean canAnimatePageChange = canAnimatePageChange(); /** * workspace : è·å–å·¥ä½œåŒºå¼•ç”¨ï¼Œä¾¿äºæ“ä½œå±å¹•å’Œå¸ƒå±€ * newItemsScreenId : ç”¨äºè·Ÿè¸ªæ–°é¡¹ç›®çš„å±å¹• IDï¼Œä»¥ä¾¿åç»­é¡µé¢åˆ‡æ¢ * newView : å°†ä¿å­˜ç¬¬ä¸€ä¸ªç»‘å®šçš„è§†å›¾ï¼Œä»¥ä¾¿åœ¨æ— éšœç¢æ¨¡å¼ä¸‹è·å¾—ç„¦ç‚¹ */ Workspace&lt;?&gt; workspace = mWorkspace; int newItemsScreenId = -1; int end = items.size(); View newView = null; /** * éå† items åˆ—è¡¨ä¸­çš„æ¯ä¸ª ItemInfo é¡¹ç›® */ for (int i = 0; i &lt; end; i++) { final ItemInfo item = items.get(i); /** * å¦‚æœé¡¹ç›®å±äº Hotseat å®¹å™¨ï¼Œä½† mHotseat ä¸º nullï¼Œåˆ™è·³è¿‡è¯¥é¡¹ç›®ï¼Œ * å› ä¸º Hotseat ä¸ºç©ºæ—¶ä¸èƒ½åŠ è½½è¿™äº›é¡¹ç›® */ if (item.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT &amp;&amp; mHotseat == null) { continue; } /** * æ ¹æ® item ç±»å‹åˆ›å»ºè§†å›¾ */ final View view; switch (item.itemType) { // å¿«æ·æ–¹å¼æˆ–åº”ç”¨ case LauncherSettings.Favorites.ITEM_TYPE_APPLICATION: case LauncherSettings.Favorites.ITEM_TYPE_SHORTCUT: case LauncherSettings.Favorites.ITEM_TYPE_DEEP_SHORTCUT: { WorkspaceItemInfo info = (WorkspaceItemInfo) item; // åˆ›å»ºå¿«æ·æ–¹å¼è§†å›¾ view = createShortcut(info); break; } // æ–‡ä»¶å¤¹ case LauncherSettings.Favorites.ITEM_TYPE_FOLDER: { // åˆ›å»ºæ–‡ä»¶å¤¹è§†å›¾ view = FolderIcon.inflateFolderAndIcon(R.layout.folder_icon, this, (ViewGroup) workspace.getChildAt(workspace.getCurrentPage()), (FolderInfo) item); break; } // åº”ç”¨å¯¹ case LauncherSettings.Favorites.ITEM_TYPE_APP_PAIR: { FolderInfo info = (FolderInfo) item; // TODO (jeremysim b/274189428): Create app pair icon // æš‚æœªå®ç°ç»‘å®šé€»è¾‘ view = null; break; } // å°éƒ¨ä»¶ case LauncherSettings.Favorites.ITEM_TYPE_APPWIDGET: case LauncherSettings.Favorites.ITEM_TYPE_CUSTOM_APPWIDGET: { // ç”Ÿæˆå°éƒ¨ä»¶è§†å›¾ view = inflateAppWidget((LauncherAppWidgetInfo) item); if (view == null) { continue; } break; } // å…¶ä»–ç±»å‹å°†æŠ›å‡ºå¼‚å¸¸ default: throw new RuntimeException(&quot;Invalid Item Type&quot;); } /** * ä¸»è¦å¤„ç†ä½ç½®å†²çª * * presenterPos: æ˜ å°„é¡¹ç›®åœ¨å¸ƒå±€ä¸­çš„ä½ç½® */ CellPos presenterPos = getCellPosMapper().mapModelToPresenter(item); if (item.container == CONTAINER_DESKTOP) { /** * æ£€æŸ¥ CellLayout ä¸­çš„ä½ç½®æ˜¯å¦å·²è¢«å ç”¨ */ CellLayout cl = mWorkspace.getScreenWithId(presenterPos.screenId); if (cl != null &amp;&amp; cl.isOccupied(presenterPos.cellX, presenterPos.cellY)) { View v = cl.getChildAt(presenterPos.cellX, presenterPos.cellY); if (v == null) { Log.e(TAG, &quot;bindItems failed when removing colliding item=&quot; + item); } Object tag = v.getTag(); String desc = &quot;Collision while binding workspace item: &quot; + item + &quot;. Collides with &quot; + tag; if (FeatureFlags.IS_STUDIO_BUILD) { throw (new RuntimeException(desc)); } else { /** * ä»æ•°æ®åº“åˆ é™¤å†²çªé¡¹ç›®ï¼Œé¿å…é‡å¤æ˜¾ç¤º */ getModelWriter().deleteItemFromDatabase(item, desc); continue; } } } /** * å°†é¡¹ç›®è§†å›¾æ·»åŠ åˆ°å·¥ä½œåŒºçš„æŒ‡å®šå±å¹•å’Œä½ç½® */ workspace.addInScreenFromBind(view, item); /** * åŠ¨ç”»å¤„ç† * * å¦‚æœ forceAnimateIcons ä¸º trueï¼Œä¸ºæ–°æ·»åŠ çš„é¡¹ç›®æ‰§è¡ŒåŠ¨ç”» */ if (forceAnimateIcons) { // åˆå§‹åŒ–è§†å›¾çš„é€æ˜åº¦å’Œç¼©æ”¾ï¼Œå‡†å¤‡åŠ¨ç”» view.setAlpha(0f); view.setScaleX(0f); view.setScaleY(0f); // åˆ›å»ºå¹¶æ·»åŠ  &quot;å¼¹è·³&quot; åŠ¨ç”» bounceAnims.add(createNewAppBounceAnimation(view, i)); newItemsScreenId = presenterPos.screenId; } if (newView == null) { newView = view; } } View viewToFocus = newView; // Animate to the correct pager if (forceAnimateIcons &amp;&amp; newItemsScreenId &gt; -1) { AnimatorSet anim = new AnimatorSet(); anim.playTogether(bounceAnims); /** * æ— éšœç¢ç„¦ç‚¹ */ if (focusFirstItemForAccessibility &amp;&amp; viewToFocus != null) { anim.addListener(new AnimatorListenerAdapter() { @Override public void onAnimationEnd(Animator animation) { /** * å¦‚æœå¯ç”¨äº†æ— éšœç¢ç„¦ç‚¹å¹¶ä¸”æœ‰å¯èšç„¦è§†å›¾ï¼Œåˆ™åœ¨åŠ¨ç”»ç»“æŸåè§¦å‘æ— éšœç¢äº‹ä»¶ */ viewToFocus.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_FOCUSED); } }); } /** * é¡µé¢åˆ‡æ¢é€»è¾‘ */ int currentScreenId = mWorkspace.getScreenIdForPageIndex(mWorkspace.getNextPage()); final int newScreenIndex = mWorkspace.getPageIndexForScreenId(newItemsScreenId); final Runnable startBounceAnimRunnable = anim::start; if (canAnimatePageChange &amp;&amp; newItemsScreenId != currentScreenId) { // We post the animation slightly delayed to prevent slowdowns // when we are loading right after we return to launcher. mWorkspace.postDelayed(new Runnable() { public void run() { if (mWorkspace != null) { closeOpenViews(false); mWorkspace.snapToPage(newScreenIndex); mWorkspace.postDelayed(startBounceAnimRunnable, NEW_APPS_ANIMATION_DELAY); } } }, NEW_APPS_PAGE_MOVE_DELAY); } else { mWorkspace.postDelayed(startBounceAnimRunnable, NEW_APPS_ANIMATION_DELAY); } } else if (focusFirstItemForAccessibility &amp;&amp; viewToFocus != null) { viewToFocus.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_FOCUSED); } /** * åˆ·æ–°å·¥ä½œåŒºå¸ƒå±€ï¼Œç¡®ä¿é¡¹ç›®æ­£ç¡®æ˜¾ç¤º */ workspace.requestLayout(); }} è·Ÿè¸ª WorkspaceLayoutManager.addInScreenFromBind() æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/WorkspaceLayoutManager.javapublic interface WorkspaceLayoutManager { default void addInScreenFromBind(View child, ItemInfo info) { /** * å°† ItemInfo çš„å¸ƒå±€ä¿¡æ¯æ˜ å°„åˆ°è§†å›¾çš„å‘ˆç°ä½ç½® */ CellPos presenterPos = getCellPosMapper().mapModelToPresenter(info); /** * x å’Œ y æ˜¯é¡¹ç›®åœ¨å·¥ä½œåŒºå¸ƒå±€ä¸­çš„ç½‘æ ¼åæ ‡ï¼Œåˆå§‹å€¼ä¸ºæ˜ å°„å¾—åˆ°çš„ cellX å’Œ cellY */ int x = presenterPos.cellX; int y = presenterPos.cellY; /** * å¦‚æœ ItemInfo è¡¨ç¤ºçš„é¡¹ç›®å±äº Hotseat å®¹å™¨ï¼Œåˆ™éœ€è¦æ ¹æ® Hotseat çš„ä½ç½®è§„åˆ™æ¥è®¡ç®—å‡†ç¡®çš„åæ ‡ */ if (info.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT || info.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT_PREDICTION) { int screenId = presenterPos.screenId; x = getHotseat().getCellXFromOrder(screenId); y = getHotseat().getCellYFromOrder(screenId); } /** * å°† child è§†å›¾æ·»åŠ åˆ°å·¥ä½œåŒºä¸­ */ addInScreen(child, info.container, presenterPos.screenId, x, y, info.spanX, info.spanY); }} è·Ÿè¸ª WorkspaceLayoutManager.addInScreen() æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/WorkspaceLayoutManager.javapublic interface WorkspaceLayoutManager { /** * child ï¼šè¦æ·»åŠ çš„è§†å›¾ç»„ä»¶ * container ï¼šå®¹å™¨ç±»å‹ï¼Œå†³å®šäº†è§†å›¾åº”æ”¾ç½®çš„ä½ç½®ï¼ˆä¾‹å¦‚æ¡Œé¢æˆ– Hotseatï¼‰ * screenId ï¼šå±å¹• IDï¼Œç”¨äºæ ‡è¯†è§†å›¾æ‰€åœ¨çš„å±å¹• * x/y ï¼šè§†å›¾åœ¨ç½‘æ ¼ä¸­çš„åæ ‡ * spanX/spanYï¼šè§†å›¾å ç”¨çš„ç½‘æ ¼è·¨åº¦ï¼Œå†³å®šäº†è§†å›¾çš„å¤§å° */ default void addInScreen(View child, int container, int screenId, int x, int y, int spanX, int spanY) { /** * æ£€æŸ¥ Desktop å±å¹•çš„æœ‰æ•ˆæ€§ * * è‹¥å®¹å™¨ä¸º Desktopï¼ˆæ¡Œé¢ï¼‰ï¼Œé¦–å…ˆæ£€æŸ¥ screenId æ˜¯å¦æœ‰æ•ˆ * å¦‚æœå¯¹åº”çš„å±å¹•ä¸å­˜åœ¨ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯å¹¶æ‰“å°å †æ ˆè·Ÿè¸ªï¼Œä¾¿äºè°ƒè¯•ï¼Œç„¶åç›´æ¥è¿”å›ï¼Œè·³è¿‡æ·»åŠ æ“ä½œ */ if (container == LauncherSettings.Favorites.CONTAINER_DESKTOP) { if (getScreenWithId(screenId) == null) { Log.e(TAG, &quot;Skipping child, screenId &quot; + screenId + &quot; not found&quot;); // DEBUGGING - Print out the stack trace to see where we are adding from new Throwable().printStackTrace(); return; } } /** * æ£€æŸ¥æ˜¯å¦ä¸ºé¢å¤–çš„ç©ºå± */ if (EXTRA_EMPTY_SCREEN_IDS.contains(screenId)) { // This should never happen throw new RuntimeException(&quot;Screen id should not be extra empty screen: &quot; + screenId); } /** * æ ¹æ®å®¹å™¨ç±»å‹ï¼ˆDesktop æˆ– Hotseatï¼‰ç¡®å®šç›®æ ‡å¸ƒå±€ */ final CellLayout layout; /** * å®¹å™¨ç±»å‹ï¼šHotseat */ if (container == LauncherSettings.Favorites.CONTAINER_HOTSEAT || container == LauncherSettings.Favorites.CONTAINER_HOTSEAT_PREDICTION) { /** * è°ƒç”¨ getHotseat() è·å– Hotseat å¸ƒå±€ */ layout = getHotseat(); /** * éšè—æ–‡ä»¶å¤¹å›¾æ ‡çš„æ ‡é¢˜ï¼ˆFolderIconï¼‰ */ if (child instanceof FolderIcon) { ((FolderIcon) child).setTextVisible(false); } } else { /** * å®¹å™¨ç±»å‹ï¼šDesktop * * æ˜¾ç¤ºæ–‡ä»¶å¤¹å›¾æ ‡çš„æ ‡é¢˜ */ if (child instanceof FolderIcon) { ((FolderIcon) child).setTextVisible(true); } /** * é€šè¿‡ screenId è·å–å±å¹•å¯¹åº”çš„ CellLayout */ layout = getScreenWithId(screenId); } /** * è®¾ç½®å¸ƒå±€å‚æ•° */ ViewGroup.LayoutParams genericLp = child.getLayoutParams(); CellLayoutLayoutParams lp; /** * æ–°å»ºæˆ–é‡ç”¨å¸ƒå±€å‚æ•° */ if (genericLp == null || !(genericLp instanceof CellLayoutLayoutParams)) { lp = new CellLayoutLayoutParams(x, y, spanX, spanY); } else { lp = (CellLayoutLayoutParams) genericLp; lp.setCellX(x); lp.setCellY(y); lp.cellHSpan = spanX; lp.cellVSpan = spanY; } /** * æ˜¯å¦é”å®šç½‘æ ¼ */ if (spanX &lt; 0 &amp;&amp; spanY &lt; 0) { lp.isLockedToGrid = false; } /** * è·å–å­è§†å›¾çš„å”¯ä¸€ ID * * è·å–è§†å›¾çš„ ItemInfo æ•°æ®ï¼Œä»ä¸­æå–å”¯ä¸€çš„ childIdï¼Œä¾¿äºåç»­åœ¨å¸ƒå±€ä¸­æ ‡è¯†è¯¥è§†å›¾ */ ItemInfo info = (ItemInfo) child.getTag(); int childId = info.getViewId(); /** * å¦‚æœè§†å›¾æ˜¯æ–‡ä»¶å¤¹ï¼ˆFolderï¼‰ï¼Œä¸æ ‡è®°å•å…ƒæ ¼ä¸ºå·²å ç”¨ï¼Œå¦åˆ™æ ‡è®°ä¸ºå·²å ç”¨ */ boolean markCellsAsOccupied = !(child instanceof Folder); /** * è°ƒç”¨ layout.addViewToCellLayout å°†è§†å›¾æ·»åŠ åˆ°å¸ƒå±€ç½‘æ ¼ä¸­ */ if (!layout.addViewToCellLayout(child, -1, childId, lp, markCellsAsOccupied)) { // è‹¥æ·»åŠ å¤±è´¥ï¼ˆå³è§†å›¾è¶…å‡ºç½‘æ ¼é™åˆ¶ï¼‰ï¼Œè®°å½•é”™è¯¯æ—¥å¿— Log.e(TAG, &quot;Failed to add to item at (&quot; + lp.getCellX() + &quot;,&quot; + lp.getCellY() + &quot;) to CellLayout&quot;); } /** * ç¦ç”¨è§¦è§‰åé¦ˆ */ child.setHapticFeedbackEnabled(false); /** * è®¾ç½®é•¿æŒ‰ç›‘å¬å™¨ï¼Œä»¥æ”¯æŒé•¿æŒ‰æ“ä½œï¼ˆé€šå¸¸ç”¨äºæ‹–æ”¾æˆ–æ˜¾ç¤ºé€‰é¡¹ï¼‰ */ child.setOnLongClickListener(getWorkspaceChildOnLongClickListener()); /** * å¦‚æœè§†å›¾æ˜¯ DropTargetï¼ˆå¯æ‹–æ”¾çš„ç›®æ ‡ï¼‰ï¼Œè°ƒç”¨ onAddDropTarget è¿›è¡Œæ³¨å†Œ */ if (child instanceof DropTarget) { onAddDropTarget((DropTarget) child); } }} ç»§ç»­è·Ÿè¸ªï¼šCellLayout.addViewToCellLayout() 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/CellLayout.javapublic class CellLayout extends ViewGroup { public boolean addViewToCellLayout(View child, int index, int childId, CellLayoutLayoutParams params, boolean markCells) { /** * å°†ä¼ å…¥çš„å¸ƒå±€å‚æ•° params èµ‹å€¼ç»™ lpï¼Œä¾¿äºåç»­ä½¿ç”¨ */ final CellLayoutLayoutParams lp = params; /** * å¤„ç† Hotseat å›¾æ ‡æ–‡æœ¬å¯è§æ€§ */ if (child instanceof BubbleTextView) { BubbleTextView bubbleChild = (BubbleTextView) child; bubbleChild.setTextVisibility(mContainerType != HOTSEAT); } /** * è®¾ç½®è§†å›¾ç¼©æ”¾ */ child.setScaleX(mChildScale); child.setScaleY(mChildScale); /** * éªŒè¯å¹¶è®¾ç½®ä½ç½®å’Œè·¨åº¦ */ if (lp.getCellX() &gt;= 0 &amp;&amp; lp.getCellX() &lt;= mCountX - 1 &amp;&amp; lp.getCellY() &gt;= 0 &amp;&amp; lp.getCellY() &lt;= mCountY - 1) { // If the horizontal or vertical span is set to -1, it is taken to // mean that it spans the extent of the CellLayout if (lp.cellHSpan &lt; 0) lp.cellHSpan = mCountX; if (lp.cellVSpan &lt; 0) lp.cellVSpan = mCountY; /** * ä¸º child è§†å›¾è®¾ç½®å”¯ä¸€çš„ IDï¼ˆchildIdï¼‰ï¼Œä¾¿äºåç»­æ“ä½œä¸­å”¯ä¸€æ ‡è¯†è¯¥è§†å›¾ */ child.setId(childId); if (LOGD) { Log.d(TAG, &quot;Adding view to ShortcutsAndWidgetsContainer: &quot; + child); } /** * å°†è§†å›¾æ·»åŠ åˆ° mShortcutsAndWidgetsï¼ˆåŒ…å«æ‰€æœ‰å›¾æ ‡å’Œå°éƒ¨ä»¶çš„å®¹å™¨ï¼‰ä¸­ï¼Œ * ä½ç½®ç”± index æŒ‡å®šï¼Œå¸ƒå±€å‚æ•°ç”± lp æä¾› */ mShortcutsAndWidgets.addView(child, index, lp); /** * æ ‡è®°å•å…ƒæ ¼ä¸ºå·²å ç”¨ï¼Œé˜²æ­¢å…¶ä»–é¡¹ç›®é‡å åœ¨ç›¸åŒä½ç½® */ if (markCells) markCellsAsOccupiedForView(child); return true; } return false; } } ç»‘å®š Widget12345678910111213141516171819202122232425262728293031ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.javapublic abstract class BaseLauncherBinder { private class UnifiedWorkspaceBinder { private void bindAppWidgets(List&lt;LauncherAppWidgetInfo&gt; appWidgets, Executor executor) { /** * è®¡ç®—å°éƒ¨ä»¶åˆ—è¡¨çš„å¤§å°ï¼Œä»¥ä¾¿åœ¨å¾ªç¯ä¸­é€ä¸ªç»‘å®šæ¯ä¸ªå°éƒ¨ä»¶ */ int count = appWidgets.size(); /** * éå† appWidgets åˆ—è¡¨ä¸­çš„æ¯ä¸ªå°éƒ¨ä»¶ */ for (int i = 0; i &lt; count; i++) { /** * å°†å½“å‰å°éƒ¨ä»¶ä¿¡æ¯ä¿å­˜åˆ° widget å˜é‡ä¸­ */ final ItemInfo widget = appWidgets.get(i); /** * å°†å½“å‰å°éƒ¨ä»¶ç»‘å®šåˆ°å·¥ä½œåŒº */ executeCallbacksTask( c -&gt; c.bindItems(Collections.singletonList(widget), false), executor); } } }} è°ƒç”¨ Launcher.bindItems() æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/Launcher.javapublic class Launcher extends StatefulActivity&lt;LauncherState&gt; implements LauncherExterns, Callbacks, InvariantDeviceProfile.OnIDPChangeListener, PluginListener&lt;LauncherOverlayPlugin&gt; { public void bindItems( final List&lt;ItemInfo&gt; items, final boolean forceAnimateIcons, final boolean focusFirstItemForAccessibility) { ... /** * éå† items åˆ—è¡¨ä¸­çš„æ¯ä¸ª ItemInfo é¡¹ç›® */ for (int i = 0; i &lt; end; i++) { final ItemInfo item = items.get(i); ... /** * æ ¹æ® item ç±»å‹åˆ›å»ºè§†å›¾ */ final View view; switch (item.itemType) { ... // å°éƒ¨ä»¶ case LauncherSettings.Favorites.ITEM_TYPE_APPWIDGET: case LauncherSettings.Favorites.ITEM_TYPE_CUSTOM_APPWIDGET: { // ç”Ÿæˆå°éƒ¨ä»¶è§†å›¾ view = inflateAppWidget((LauncherAppWidgetInfo) item); if (view == null) { continue; } break; } // å…¶ä»–ç±»å‹å°†æŠ›å‡ºå¼‚å¸¸ default: throw new RuntimeException(&quot;Invalid Item Type&quot;); } ... } ... /** * åˆ·æ–°å·¥ä½œåŒºå¸ƒå±€ï¼Œç¡®ä¿é¡¹ç›®æ­£ç¡®æ˜¾ç¤º */ workspace.requestLayout(); }} æ‰€ä»¥æˆ‘ä»¬ç»§ç»­è·Ÿè¸ª inflateAppWidget() æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/Launcher.javapublic class Launcher extends StatefulActivity&lt;LauncherState&gt; implements LauncherExterns, Callbacks, InvariantDeviceProfile.OnIDPChangeListener, PluginListener&lt;LauncherOverlayPlugin&gt; { private View inflateAppWidget(LauncherAppWidgetInfo item) { /** * æœç´¢å°éƒ¨ä»¶å¤„ç† */ if (item.hasOptionFlag(LauncherAppWidgetInfo.OPTION_SEARCH_WIDGET)) { item.providerName = QsbContainerView.getSearchComponentName(this); if (item.providerName == null) { getModelWriter().deleteItemFromDatabase(item, &quot;search widget removed because search component cannot be found&quot;); return null; } } final AppWidgetHostView view; /** * å¦‚æœè®¾å¤‡å¤„äºå®‰å…¨æ¨¡å¼ï¼Œä½¿ç”¨ PendingAppWidgetHostView åˆ›å»ºä¸€ä¸ªæŒ‚èµ·çš„å°éƒ¨ä»¶è§†å›¾ï¼Œå¹¶è¿”å›è¯¥è§†å›¾ */ if (mIsSafeModeEnabled) { view = new PendingAppWidgetHostView(this, item, mIconCache, true); prepareAppWidget(view, item); return view; } /** * æ€§èƒ½è·Ÿè¸ªåˆå§‹åŒ– */ Object traceToken = TraceHelper.INSTANCE.beginSection(&quot;BIND_WIDGET_id=&quot; + item.appWidgetId); /** * ç»‘å®šå°éƒ¨ä»¶çš„çŠ¶æ€æ£€æŸ¥ä¸å¤„ç† */ try { final LauncherAppWidgetProviderInfo appWidgetInfo; String removalReason = &quot;&quot;; /** * è¡¨ç¤ºå°éƒ¨ä»¶æä¾›è€…æœªå‡†å¤‡å¥½ */ if (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY)) { // If the provider is not ready, bind as a pending widget. appWidgetInfo = null; removalReason = &quot;the provider isn't ready.&quot;; } else if (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID)) { /** * å°éƒ¨ä»¶ ID æ— æ•ˆï¼Œï¼Œæ ¹æ® providerName æ‰¾åˆ°å°éƒ¨ä»¶çš„æä¾›è€… */ appWidgetInfo = mAppWidgetManager.findProvider(item.providerName, item.user); if (appWidgetInfo == null) { if (WidgetsModel.GO_DISABLE_WIDGETS) { removalReason = &quot;widgets are disabled on go device.&quot;; } else { removalReason = &quot;WidgetManagerHelper cannot find a provider from provider info.&quot;; } } } else { /** * æ­£å¸¸ç»‘å®š */ appWidgetInfo = mAppWidgetManager.getLauncherAppWidgetInfo(item.appWidgetId); if (appWidgetInfo == null) { if (item.appWidgetId &lt;= LauncherAppWidgetInfo.CUSTOM_WIDGET_ID) { removalReason = &quot;CustomWidgetManager cannot find provider from that widget id.&quot;; } else { removalReason = &quot;AppWidgetManager cannot find provider for that widget id.&quot; + &quot; It could be because AppWidgetService is not available, or the&quot; + &quot; appWidgetId has not been bound to a the provider yet, or you&quot; + &quot; don't have access to that appWidgetId.&quot;; } } } // If the provider is ready, but the width is not yet restored, try to restore it. if (!item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY) &amp;&amp; (item.restoreStatus != LauncherAppWidgetInfo.RESTORE_COMPLETED)) { if (appWidgetInfo == null) { getModelWriter().deleteItemFromDatabase(item, &quot;Removing restored widget: id=&quot; + item.appWidgetId + &quot; belongs to component &quot; + item.providerName + &quot; user &quot; + item.user + &quot;, as the provider is null and &quot; + removalReason); return null; } // If we do not have a valid id, try to bind an id. if (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID)) { if (!item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_ALLOCATED)) { // Id has not been allocated yet. Allocate a new id. item.appWidgetId = mAppWidgetHolder.allocateAppWidgetId(); item.restoreStatus |= LauncherAppWidgetInfo.FLAG_ID_ALLOCATED; // Also try to bind the widget. If the bind fails, the user will be shown // a click to setup UI, which will ask for the bind permission. PendingAddWidgetInfo pendingInfo = new PendingAddWidgetInfo(appWidgetInfo, item.sourceContainer); pendingInfo.spanX = item.spanX; pendingInfo.spanY = item.spanY; pendingInfo.minSpanX = item.minSpanX; pendingInfo.minSpanY = item.minSpanY; Bundle options = pendingInfo.getDefaultSizeOptions(this); boolean isDirectConfig = item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_DIRECT_CONFIG); if (isDirectConfig &amp;&amp; item.bindOptions != null) { Bundle newOptions = item.bindOptions.getExtras(); if (options != null) { newOptions.putAll(options); } options = newOptions; } boolean success = mAppWidgetManager.bindAppWidgetIdIfAllowed( item.appWidgetId, appWidgetInfo, options); // We tried to bind once. If we were not able to bind, we would need to // go through the permission dialog, which means we cannot skip the config // activity. item.bindOptions = null; item.restoreStatus &amp;= ~LauncherAppWidgetInfo.FLAG_DIRECT_CONFIG; // Bind succeeded if (success) { // If the widget has a configure activity, it is still needs to set it // up, otherwise the widget is ready to go. item.restoreStatus = (appWidgetInfo.configure == null) || isDirectConfig ? LauncherAppWidgetInfo.RESTORE_COMPLETED : LauncherAppWidgetInfo.FLAG_UI_NOT_READY; } getModelWriter().updateItemInDatabase(item); } } else if (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_UI_NOT_READY) &amp;&amp; (appWidgetInfo.configure == null)) { // The widget was marked as UI not ready, but there is no configure activity to // update the UI. item.restoreStatus = LauncherAppWidgetInfo.RESTORE_COMPLETED; getModelWriter().updateItemInDatabase(item); } else if (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_UI_NOT_READY) &amp;&amp; appWidgetInfo.configure != null) { if (mAppWidgetManager.isAppWidgetRestored(item.appWidgetId)) { item.restoreStatus = LauncherAppWidgetInfo.RESTORE_COMPLETED; getModelWriter().updateItemInDatabase(item); } } } /** * å°éƒ¨ä»¶è§†å›¾åˆ›å»ºä¸è¿”å› */ if (item.restoreStatus == LauncherAppWidgetInfo.RESTORE_COMPLETED) { // Verify that we own the widget if (appWidgetInfo == null) { FileLog.e(TAG, &quot;Removing invalid widget: id=&quot; + item.appWidgetId); getModelWriter().deleteWidgetInfo(item, getAppWidgetHolder(), removalReason); return null; } item.minSpanX = appWidgetInfo.minSpanX; item.minSpanY = appWidgetInfo.minSpanY; view = mAppWidgetHolder.createView(this, item.appWidgetId, appWidgetInfo); } else if (!item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID) &amp;&amp; appWidgetInfo != null) { mAppWidgetHolder.addPendingView(item.appWidgetId, new PendingAppWidgetHostView(this, item, mIconCache, false)); view = mAppWidgetHolder.createView(this, item.appWidgetId, appWidgetInfo); } else { view = new PendingAppWidgetHostView(this, item, mIconCache, false); } /** * å°éƒ¨ä»¶å‡†å¤‡ */ prepareAppWidget(view, item); } finally { TraceHelper.INSTANCE.endSection(traceToken); } return view; }}","link":"/2024/10/25/Android%20--%20Launcher3%20--%2002.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%20--%20workspace/"},{"title":"è§£æ Modifierã€CombinedModifier","text":"# å‰è¨€ä¼—æ‰€å‘¨çŸ¥ï¼šåŸç†æ€§åˆ†æçš„æ–‡ç« ï¼ŒçœŸçš„å¾ˆéš¾è®²çš„é€šä¿—æ˜“æ‡‚ï¼Œè®²çš„ç®€å•äº†å°±æ²¡å¿…è¦å†™äº†ï¼Œè®²çš„ç¹çæ‚ä¹±å¾€å¾€å¤§å®¶ä¹Ÿä¸ä¹æ„çœ‹ï¼Œæ‰€ä»¥åªèƒ½å°½é‡æ‰¾ä¸ªå¥½çš„è§’åº¦ï¼ˆæ¯”å¦‚ä» Demo ä»£ç ç¤ºä¾‹å‡ºå‘ï¼‰æ…¢æ…¢å¸¦ç€å¤§å®¶å»é’»æºç ï¼Œå¦‚æœç¡®å®èƒ½å¸®åŠ©åˆ°å¤§å®¶ç†è§£æ¸…æ¥šåŸç†ï¼Œé‚£å°±ç‚¹ä¸ªèµå‘—ï½ğŸ˜„ åœ¨æ­£å¼å¼€å§‹åˆ†æ Modifier ç›¸å…³åŸç†ä¹‹å‰ï¼Œå»ºè®®ä½ å…ˆçœ‹çœ‹ ã€Compose æ˜¯å¦‚ä½•å°†æ•°æ®è½¬æ¢æˆ UI çš„ï¼Ÿã€‘è¿™ç¯‡æ–‡ç« ï¼Œå½“ä½ äº†è§£äº† Compose çš„â€œç»„åˆâ€ã€â€œå¸ƒå±€â€ã€â€œç»˜åˆ¶â€çš„æ€ç»´æ¨¡å‹åï¼Œæœ‰åŠ©äºä½ æ›´é€å½»çš„äº†è§£ Modifier çš„æœ¬è´¨ï¼ ä¸€ã€ä»€ä¹ˆæ˜¯ Modifier ï¼Ÿ å½“ä½ æƒ³æ·±å…¥äº†è§£ Modifier çš„æ—¶å€™ï¼Œä½ åº”è¯¥å·²ç»åœ¨å®é™…ä»£ç ä¸­ç”¨èµ·æ¥äº†ï¼Œå› ä¸ºéšå¤„å¯è§å„ç§ Modifierï¼Œæ¯”å¦‚ï¼š 12345678Modifier.size() // å°ºå¯¸Modifier.width() // å®½åº¦Modifier.height() // é«˜åº¦Modifier.padding() // é—´è·Modifier.background() // èƒŒæ™¯Modifier.clip() // è£åˆ‡Modifier.clickable() // ç‚¹å‡»... ... é‚£ä¹ˆä½ æœ‰æ²¡æœ‰æ€è€ƒè¿‡ä¸€ä¸ªé—®é¢˜ï¼šè¿™ä¸ªåƒæ ¹éƒ¨ï¼ˆèµ·ç‚¹ï¼‰ä¸€æ ·çš„ Modifier æ˜¯ä¸ªå•¥ï¼Ÿ æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„å®šä¹‰ï¼š 12345678910111213141516ğŸ“„ androidx.compose.ui.Modifier.ktinterface Modifier { // é‡ç‚¹ï¼šç”³æ˜ä¸€ä¸ª Modifier çš„ä¼´ç”Ÿå¯¹è±¡ï¼ˆå•ä¾‹å¯¹è±¡ï¼‰ companion object : Modifier { // é‡Œé¢å…¨éƒ¨éƒ½æ˜¯æœ€ç®€å•çš„å®ç°ï¼Œè¿™é‡Œé¢çš„æ–¹æ³•æˆ‘ä»¬åé¢ä¼šè¯¦ç»†äº†è§£åˆ°ï¼Œæš‚æ—¶ä¸ç”¨å…³å¿ƒ override fun &lt;R&gt; foldIn(initial: R, operation: (R, Element) -&gt; R): R = initial override fun &lt;R&gt; foldOut(initial: R, operation: (Element, R) -&gt; R): R = initial override fun any(predicate: (Element) -&gt; Boolean): Boolean = false override fun all(predicate: (Element) -&gt; Boolean): Boolean = true override infix fun then(other: Modifier): Modifier = other override fun toString() = &quot;Modifier&quot; }} æ‰€ä»¥å¦‚æœä½ å•å†™ä¸€ä¸ª Modifierï¼Œå°±å¯ä»¥è·å–åˆ°ä¸€ä¸ªæœ€ç®€å•çš„ Modifier æ¥å£çš„å¯¹è±¡ï¼ˆå³ä¼´ç”Ÿå¯¹è±¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯ä½œä¸ºä¸€ä¸ªèµ·ç‚¹ç”¨äºé“¾å¼è°ƒç”¨ã€‚ OKï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€æ®µç®€å•çš„ä»£ç ï¼š 12345678910111213141516class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Custom() } } }}@Composablefun Custom() { Box(Modifier.size(40.dp).background(Color.Blue)) {}} è¿™é‡Œæˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€ä¸ª Composable å‡½æ•° custom()ï¼Œå†…éƒ¨å°±æ˜¯ä¸€ä¸ª Boxï¼ŒåŒæ—¶å¯¹ Box æ·»åŠ äº†å°ºå¯¸å’ŒèƒŒæ™¯ã€‚ æ•ˆæœå¦‚ä¸‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/16dd22b4cc9a4a60ba2254adb18083d2.png =600x) ç°åœ¨æˆ‘ä»¬å®šä¹‰çš„è¿™ä¸ª Custom() å°±æ˜¯ä¸€ä¸ªé€šç”¨çš„å¯ç»„åˆå‡½æ•°ï¼Œå¦‚æœç°åœ¨æˆ‘å¸Œæœ›å¤–éƒ¨è°ƒç”¨è¿™ä¸ª Custom å‡½æ•°çš„æ—¶å€™å¯ä»¥ä»å¤–éƒ¨å»æ”¹å˜ Box çš„é€æ˜åº¦ï¼Œè¯¥æ€ä¹ˆå†™ï¼Ÿ æˆ‘ä»¬å¯èƒ½ä¼šå¾ˆè‡ªç„¶çš„å†™å‡ºä¸‹é¢çš„ä»£ç ï¼š 12345678910111213141516class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Custom(modifier = Modifier.alpha(0.5f)) } } }}@Composablefun Custom(modifier: Modifier) { Box(modifier.size(40.dp).background(Color.Blue)) {}} è¿™æ®µä»£ç ä¸éš¾ç†è§£å§ï¼Ÿæ•ˆæœå¦‚ä¸‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/3f609adcc58d4f30b3b31b42e004d92a.png =600x) æˆ‘ä»¬å¯ä»¥ç»™ Custom() åŠ ä¸€ä¸ª Modifier ç±»å‹çš„å‚æ•°ï¼Œè¿™æ ·å¤–éƒ¨å°±å¯ä»¥é€šè¿‡ä¼ å…¥ä¸€ä¸ª Modifier æ¥ä¿®æ”¹ Box çš„å°ºå¯¸äº†ã€‚ ä½†æ˜¯è¿™å°±ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šç°åœ¨å¤–éƒ¨è°ƒç”¨ custom() ï¼Œå°±å¿…é¡»ä¼ å…¥ä¸€ä¸ª Modifierï¼Œè¿™å°±ä¸åˆç†äº†ï¼Œç›¸å½“äºå¼ºåˆ¶è¦æ±‚å¤–éƒ¨å¿…é¡»åŠ è¿™ä¸ª Modifier å‚æ•°ï¼Œæ‰€ä»¥é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šåƒä¸‹é¢è¿™ä¹ˆå†™ï¼š 1234567891011121314151617class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Custom(modifier = Modifier.alpha(0.5f)) // ä¼ äº†ï¼Œcustom å°±ç”¨ä¼ å…¥çš„ Modifier Custom() // ä¸ä¼ ï¼Œcustom å°±ç”¨é»˜è®¤çš„ Modifier } } }}@Composablefun Custom(modifier: Modifier = Modifier) { // è®¾å®šä¸€ä¸ªé»˜è®¤çš„ Modifierï¼Œä½œä¸ºä¸€ä¸ªå ä½ç¬¦ä½¿ç”¨ Box(modifier.size(40.dp).background(Color.Blue)) {}} ç°åœ¨æ˜¯ä¸æ˜¯å°±èƒ½è§£å†³æˆ‘ä»¬å‰é¢çš„é—®é¢˜äº†ï¼Ÿè¯·è®°ä½ï¼šè¿™æ˜¯ä¸€ä¸ªå¾ˆæ ‡å‡†çš„å†™æ³•ï¼ ä¸ºä»€ä¹ˆè¯´æ˜¯ä¸€ä¸ªæ ‡å‡†å†™æ³•å‘¢ï¼Ÿ æˆ‘ä»¬çœ‹ä¸‹ Box çš„æºç å®šä¹‰ï¼š 1234567@Composableinline fun Box( modifier: Modifier = Modifier, // è¿™é‡Œ contentAlignment: Alignment = Alignment.TopStart, propagateMinConstraints: Boolean = false, content: @Composable BoxScope.() -&gt; Unit) å†æ¢ä¸€ä¸ª Button çœ‹çœ‹ï¼š 1234567@Composablefun Button( onClick: () -&gt; Unit, modifier: Modifier = Modifier, // è¿™é‡Œ enabled: Boolean = true, ... ...) å†æ¢ä¸€ä¸ª Column çœ‹çœ‹ï¼š 1234567@Composableinline fun Column( modifier: Modifier = Modifier, // è¿™é‡Œ verticalArrangement: Arrangement.Vertical = Arrangement.Top, horizontalAlignment: Alignment.Horizontal = Alignment.Start, content: @Composable ColumnScope.() -&gt; Unit) Compose é»˜è®¤æä¾›çš„å‡½æ•°çš„å‚æ•°ä¹Ÿæ˜¯è¿™ç§æ ‡å‡†å†™æ³•ï¼Œæ‰€ä»¥ä»¥åæˆ‘ä»¬å†™è‡ªå®šä¹‰çš„ Compose å‡½æ•°ï¼ŒæŒ‰ç…§è¿™ç§æ ‡å‡†å†™æ³•å°±ä¼šå¾ˆæ–¹ä¾¿ã€‚ äºŒã€Modifier é“¾ æ‰€è°“çš„ã€Œ Modifier é“¾ ã€å…¶å®å°±æ˜¯ç±»ä¼¼ã€Œ Modifier.padding().background() ã€è¿™æ ·çš„é“¾å¼è°ƒç”¨ã€‚åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¿™ç§é“¾å¼è°ƒç”¨å¯¹é¡ºåºçš„æ•æ„Ÿåº¦è¿˜æ˜¯å¾ˆå¼ºçš„ï¼Œä¸åŒçš„è°ƒç”¨é¡ºåºæ˜¾ç¤ºå‡ºæ¥çš„ç»“æœä¼šå®Œå…¨ä¸ä¸€æ ·ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬ç»“åˆå®é™…ä»£ç æ·±å…¥åˆ†æ Modifier é“¾çš„åˆ›å»ºæ­¥éª¤ã€‚ 1234567891011class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Blue)) } } }} å‰é¢ä½ åº”è¯¥çŸ¥é“äº† Modifier æ˜¯ä»€ä¹ˆäº†ï¼Œå®ƒå°±ç›¸å½“äºä¸€ä¸ªç™½æ¿ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ Modifier.background() åšäº†ä»€ä¹ˆï¼š 123456789101112131415161718192021ğŸ“„ androidx.compose.foundation.Background.ktfun Modifier.background( color: Color, shape: Shape = RectangleShape): Modifier { val alpha = 1.0f // for solid colors return this.then( // thisï¼šå°±æ˜¯ Modifierï¼Œè¿™é‡Œåˆè°ƒç”¨äº† then() BackgroundElement( color = color, shape = shape, alpha = alpha, inspectorInfo = debugInspectorInfo { name = &quot;background&quot; value = color properties[&quot;color&quot;] = color properties[&quot;shape&quot;] = shape } ) )} æˆ‘ä»¬å¯ä»¥å‘ç° Modifier.backgroud å®é™…ä¸Šåˆè°ƒç”¨äº† this.then(BackgroundElement())ï¼Œæ­¤æ—¶ this æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä¼´ç”Ÿå¯¹è±¡ Modifierï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ then() åšäº†ä»€ä¹ˆã€‚ 12345678ğŸ“„ androidx.compose.ui.Modifier.ktinterface Modifier { infix fun then(other: Modifier): Modifier = if (other === Modifier) this else CombinedModifier(this, other) } æˆ‘ä»¬å¯ä»¥çœ‹åˆ° then() æ˜¯æœ‰å‚æ•°çš„ï¼Œå®ƒçš„å‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ª Modifier ç±»å‹çš„ï¼Œæ‰€ä»¥ä¼ é€’è¿›æ¥çš„ BackgroundElement() ä¹Ÿæ˜¯ä¸€ä¸ª Modifier å—ï¼Ÿ æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„å®šä¹‰ï¼š 123456789ğŸ“„ androidx.compose.foundation.Background.ktprivate class BackgroundElement( private val color: Color = Color.Unspecified, private val brush: Brush? = null, private val alpha: Float, private val shape: Shape, private val inspectorInfo: InspectorInfo.() -&gt; Unit) : ModifierNodeElement&lt;BackgroundNode&gt;() {} 123ğŸ“„ androidx.compose.ui.node.ModifierNodeElement.ktabstract class ModifierNodeElement&lt;N : Modifier.Node&gt;: Modifier.Element, InspectableValue {} 123ğŸ“„ androidx.compose.ui.Modifier.ktinterface Element : Modifier {} å›å½’ä¸»é¢˜ï¼Œç°åœ¨æˆ‘ä»¬å†æ¥çœ‹çœ‹ then() çš„ä½œç”¨ï¼šå®ƒä¸»è¦è´Ÿè´£æŠŠè°ƒç”¨çš„ Modifierï¼ˆå·¦è¾¹ï¼‰å’Œå‚æ•°ä¼ å…¥çš„ Modifierï¼ˆå³è¾¹ï¼‰è¿›è¡Œåˆå¹¶çš„ã€‚ 1. if (other === Modifier) this å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„ Modifier ä¼´ç”Ÿå¯¹è±¡ï¼š**companion object**ï¼Œåˆ™è¿”å›è‡ªå·±ï¼Œå³è°ƒç”¨è€…ã€‚ æ¯”å¦‚æˆ‘è¿™ä¹ˆå†™ï¼š 123Box(Modifier.background(Color.Blue).then(Modifier))==&gt;å°±ä¼šç›´æ¥è¿”å› Box(Modifier.background(Color.Blue) è‡ªèº« é‚£æˆ‘ä»¬ä¾‹å­é‡Œçš„ Modifier.background() è¿”å›çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ 1234567891011121314151617Box(Modifier.background(Color.Blue))/** * æ­¤æ—¶ then(Background()) å¾ˆæ˜æ˜¾ä¸æ»¡è¶³ other === Modifier çš„æ¡ä»¶ * æ‰€ä»¥æ ¹æ®åˆ¤æ–­æ¡ä»¶ï¼š * if (other === Modifier) this else CombinedModifier(this, other) * æ­¤æ—¶åº”è¯¥èµ°åˆ° else åˆ†æ”¯ï¼Œæ‰§è¡Œ CombinedModifier(this, other) * * æ˜¯å—ï¼Ÿ ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤” * * æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ Modifier è¿™ä¸ªä¼´ç”Ÿå¯¹è±¡ï¼Œå¦‚æœä½ å¤Ÿä»”ç»†çš„è¯ï¼Œåº”è¯¥æ³¨æ„åˆ°äº†ï¼š * å®ƒå†…éƒ¨è¦†å†™äº† then() æ–¹æ³• */companion object : Modifier { ... override infix fun then(other: Modifier): Modifier = other} Modifier å†…éƒ¨å¯¹ then() çš„æ“ä½œæå…¶ç®€å•ï¼šä½ ä¼ è¿›æ¥ä»€ä¹ˆï¼Œæˆ‘å°±ç»™ä½ è¿”å›ä»€ä¹ˆï¼ æ‰€ä»¥ Modifier.background() è¿™ç§è°ƒç”¨æ–¹æœ¬èº«å°±æ˜¯ä¸€ä¸ªä¼´ç”Ÿå¯¹è±¡çš„æƒ…å†µï¼Œä¼šèµ°åˆ°å®ƒè‡ªå·±å†…éƒ¨çš„ then() æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ Background() è‡ªèº«ã€‚ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/b63c990911014b76ae4ed3e475ac7471.png =700x) æ­¤æ—¶ Modifier é“¾çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/f6c97b32c44f4360a02dfc34cbfe9316.png =800x) å¦‚æœâ€œè°ƒç”¨è€…â€å’Œâ€œä¼ è¿›æ¥çš„å‚æ•°â€éƒ½ä¸æ˜¯ Modifier ä¼´ç”Ÿå¯¹è±¡çš„è¯ï¼Œå°±ä¼šèµ°åˆ°ä¸‹é¢ä¸€ä¸ªæ¡ä»¶ã€‚ 2. else CombinedModifier(this, other) è°ƒç”¨ CombinedModifier() è¿›è¡Œä¸¤ä¸ª Modifier çš„èåˆï¼Œå¹¶è¿”å› CombinedModifier è‡ªèº«ã€‚ æ¯”å¦‚æˆ‘ä»¬ç°åœ¨å†æ·»åŠ ä¸€ä¸ªå°ºå¯¸ï¼š 1Box(Modifier.background(Color.Blue).size(40.dp)) æŸ¥çœ‹ size() å‡½æ•°ï¼š 12345678910111213141516ğŸ“„ androidx.compose.foundation.layout.Size.kt@Stablefun Modifier.size(size: Dp) = this.then( SizeElement( minWidth = size, maxWidth = size, minHeight = size, maxHeight = size, enforceIncoming = true, inspectorInfo = debugInspectorInfo { name = &quot;size&quot; value = size } )) è¿™ä¸ªæ—¶å€™çš„ this å°±æ˜¯ Background() äº†ï¼ˆä¹Ÿå°±æ˜¯ **BackgroudElement**ï¼‰ï¼Œè€Œ then() å†…éƒ¨çš„å‚æ•°åˆæ˜¯ä¸€ä¸ª **SizeElement**ï¼Œæ‰€ä»¥å°±è¦ç”¨åˆ° CombinedModifier è¿›è¡Œèåˆäº†ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸‹ CombinedModifierï¼š 123456ğŸ“„ androidx.compose.ui.Modifier.ktclass CombinedModifier( internal val outer: Modifier, internal val inner: Modifier) : Modifier {} CombinedModifier å…·ä½“æ€ä¹ˆèåˆçš„ï¼Œæˆ‘ä»¬å…ˆä¸éœ€è¦å…³æ³¨ï¼Œä¸‹é¢ä¼šè®²ã€‚ æˆ‘ä»¬è¿™é‡Œä¸»è¦å…³æ³¨å®ƒçš„ä¸¤ä¸ªå‚æ•°ï¼šã€Œ outer ã€ å’Œ ã€Œ inner ã€! æ‰€ä»¥ï¼š**BackgroudElement** æ˜¯ outerï¼ŒSizeElement æ˜¯ inner ï¼ æ­¤æ—¶ Modifier é“¾çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/7717a13e88384c028f6ad40fee761422.png =800x) ç°åœ¨æˆ‘ä»¬å†æ·»åŠ ä¸€ä¸ªè¾¹è·ï¼š 1Box(Modifier.background(Color.Blue).size(40.dp).padding(10.dp)) æŸ¥çœ‹ padding() å‡½æ•°ï¼š 1234567891011121314ğŸ“„ androidx.compose.foundation.layout.Padding.kt@Stablefun Modifier.padding(all: Dp) = this then PaddingElement( start = all, top = all, end = all, bottom = all, rtlAware = true, inspectorInfo = { name = &quot;padding&quot; value = all }) è¿™ä¸ªæ—¶å€™çš„ this æŒ‡å‘çš„æ˜¯ CombinedModifier å®ä¾‹ï¼Œè€Œ then() å†…éƒ¨çš„å‚æ•°åˆæ˜¯ä¸€ä¸ª PaddingElementï¼Œæ‰€ä»¥åˆè¦ç”¨åˆ° CombinedModifier è¿›è¡Œèåˆäº†ã€‚ æ­¤æ—¶ Modifier é“¾çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/89bbcf0f9dc34902a494ec79c33e9d31.png =800x) åˆ°è¿™é‡Œï¼Œä½ æœ‰æ²¡æœ‰å‘ç°ï¼ŸModifier é“¾æ¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª then() ä½œä¸ºæœ€å¤–å±‚è°ƒç”¨ï¼Œå®ƒå°±ç›¸å½“äºä¸€ä¸ªå¥—å­ï¼Œæ‰“é€ ä¸€ä¸ªä¸€ç¯å¥—ä¸€ç¯çš„é“¾æ¡ã€‚ ä¸‰ã€CombinedModifier ç°åœ¨æˆ‘ä»¬å¼€å§‹æ­£å¼ç ”ç©¶ CombinedModifier çš„æºç æœ¬è´¨ï¼ 1234class CombinedModifier( internal val outer: Modifier, internal val inner: Modifier) : Modifier å‰é¢æˆ‘ä»¬çŸ¥é“äº†ï¼šCombinedModifier è¿æ¥çš„ä¸¤ä¸ª Modifier åˆ†åˆ«å­˜å‚¨åœ¨ outer ä¸ inner ä¸­ï¼Œè€Œ Compose å¯¹ Modifier çš„éå†ï¼Œå…¶å®å°±æ˜¯ä»å¤–ï¼ˆouterï¼‰åˆ°å†…ï¼ˆinnerï¼‰ä¸€å±‚å±‚è®¿é—®çš„ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ outer ä¸ innner å­—æ®µéƒ½è¢« internal å…³é”®å­—ç”³æ˜ï¼Œæ„å‘³ç€ä¸èƒ½è¢«å¤–éƒ¨æ¨¡å—ç›´æ¥è®¿é—®ï¼Œä½†å®˜æ–¹ä¸ºæˆ‘ä»¬æä¾›äº† foldOut() ä¸ foldIn() ä¸“é—¨ç”¨æ¥éå† Modifier é“¾ã€‚ 123456789101112131415161718192021222324252627ğŸ“„ androidx.compose.ui.Modifier.ktclass CombinedModifier( internal val outer: Modifier, internal val inner: Modifier) : Modifier { override fun &lt;R&gt; foldIn(initial: R, operation: (R, Modifier.Element) -&gt; R): R = inner.foldIn(outer.foldIn(initial, operation), operation) // æ­£å‘éå† override fun &lt;R&gt; foldOut(initial: R, operation: (Modifier.Element, R) -&gt; R): R = outer.foldOut(inner.foldOut(initial, operation), operation) // åå‘éå† override fun any(predicate: (Modifier.Element) -&gt; Boolean): Boolean = outer.any(predicate) || inner.any(predicate) // æˆ–è¿ç®— override fun all(predicate: (Modifier.Element) -&gt; Boolean): Boolean = outer.all(predicate) &amp;&amp; inner.all(predicate) // ä¸è¿ç®— override fun equals(other: Any?): Boolean = other is CombinedModifier &amp;&amp; outer == other.outer &amp;&amp; inner == other.inner override fun hashCode(): Int = outer.hashCode() + 31 * inner.hashCode() override fun toString() = &quot;[&quot; + foldIn(&quot;&quot;) { acc, element -&gt; if (acc.isEmpty()) element.toString() else &quot;$acc, $element&quot; } + &quot;]&quot;} ä¾‹å¦‚æˆ‘ä»¬ä¹‹å‰å†™çš„ Modifier é“¾ï¼š 1Modifier.background(Color.Blue).size(40.dp).padding(10.dp) foldIn()ï¼šæ­£å‘éå† Modifier é“¾&nbsp;BackgroundElement -&gt; SizeElement -&gt; PaddingElement foldOut()ï¼šåå‘éå† Modifier é“¾&nbsp;PaddingElement -&gt; SizeModifier -&gt; BackgroundElement foldIn() è§£æ ä½ åº”è¯¥ä¹Ÿå‘ç°äº†ï¼ŒCombinedModifier æœ¬èº«å°±æ˜¯ Modifier æ¥å£çš„å®ç°ç±»ï¼Œå®ƒå†…éƒ¨çš„ foldInã€foldOut éƒ½æ˜¯è¦†å†™äº†å…¶çˆ¶æ¥å£ Modifier çš„å†…éƒ¨æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆæ¥çœ‹çœ‹ Modifier çš„ foldInï¼ˆå› ä¸ºå®ƒæ›´ç®€å•ï¼‰ï¼š 123interface Modifier { fun &lt;R&gt; foldIn(initial: R, operation: (R, Element) -&gt; R): R} è®©æˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™ä¸ª foldIn å‡½æ•°ï¼š fun &lt;R&gt;ï¼šè¿™æ˜¯ä¸€ä¸ªæ³›å‹å‡½æ•°ï¼Œç±»å‹å‚æ•° R è¡¨ç¤ºç»“æœçš„ç±»å‹ã€‚ initial: Rï¼šä½œä¸ºç´¯ç§¯æ“ä½œçš„åˆå§‹å€¼ï¼ŒfoldIn ä»è¿™ä¸ªå€¼å¼€å§‹ï¼Œå¹¶åœ¨æ¯æ¬¡æ“ä½œä¸­æ›´æ–°å®ƒã€‚ operation: (R, Element) -&gt; Rï¼šè¿™æ˜¯ä¸€ä¸ª lambda è¡¨è¾¾å¼å‚æ•°ï¼Œå®ƒæ¥å—å½“å‰çš„ç´¯ç§¯å€¼å’Œä¿®é¥°ç¬¦é“¾ä¸­çš„å½“å‰å…ƒç´  Elementï¼Œç„¶åè¿”å›æ–°çš„ç´¯ç§¯å€¼ã€‚è¿™ä¸ª lambda è¡¨è¾¾å¼ä¼šè¢«åº”ç”¨äºä¿®é¥°ç¬¦é“¾ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å¸Œæœ›ç»Ÿè®¡ Modifier é“¾ä¸­ Modifier çš„æ•°é‡ï¼š 123456789val modifier = Modifier .background(Color.Blue) .size(40.dp) .padding(10.dp)val result = modifier.foldIn&lt;Int&gt;(0) { currentIndex, element -&gt; println(&quot;@@@ index: $currentIndex , element :$element&quot;) currentIndex + 1}println(&quot;@@@ result = $result&quot;) çœ‹ä¸æ‡‚ï¼Ÿé‚£æˆ‘ä»¬ç›´æ¥çœ‹ Logï¼š 1234@@@ index: 0 , element :androidx.compose.foundation.BackgroundElement@52227b59@@@ index: 1 , element :androidx.compose.foundation.layout.SizeElement@780004cf@@@ index: 2 , element :androidx.compose.foundation.layout.PaddingElement@b80004cf@@@ result = 3 çœ‹å®Œæœ€ç®€å•çš„ foldIn å‡½æ•°ï¼Œæˆ‘ä»¬å†æ¥çœ‹ CombinedModifier çš„ foldIn å‡½æ•°ï¼š 123456// Modifier æ¥å£çš„ foldIn å‡½æ•°fun &lt;R&gt; foldIn(initial: R, operation: (R, Element) -&gt; R): R// Combinedmodifier è¦†å†™çš„ foldIn å‡½æ•°override fun &lt;R&gt; foldIn(initial: R, operation: (R, Modifier.Element) -&gt; R): R = inner.foldIn(outer.foldIn(initial, operation), operation) çœ‹ä¸æ‡‚æ˜¯ä¹ˆï¼Ÿä¸æ€¥ï¼Œä½ å…ˆæ¥æƒ³æƒ³ Modifier é“¾æ¡ç»è¿‡ CombinedModifier è½¬æ¢åï¼Œæ˜¯ä¸æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š 123456789101112131415161718192021222324252627Modifier.background(Color.Blue).size(40.dp).padding(10.dp)// åˆ†æ­¥éª¤æ‹†è§£1. Modifier.background(Color.Blue) ==&gt; ç­‰åŒäº Modifier.then(Modifier.background()) ==&gt; Modifier.background()2. Modifier.background(Color.Blue).size(40.dp) ==&gt; ç­‰åŒäº Modifier.background().then(Modifier.size()) ==&gt; ç­‰åŒäº CombinedModifier [ outer: Modifier.background(), inner: Modifier.size() ]3. Modifier.background(Color.Blue).size(40.dp).padding(10.dp) ==&gt; ç­‰åŒäº Modifier.background().then(Modifier.size()).then(Modifier.padding()) ==&gt; ç­‰åŒäº CombinedModifier [ outer: CombinedModifier [ outer: Modifier.background(), inner: Modifier.size() ], inner: Modifier.padding() ] å†çœ‹ä¸ªç¤ºä¾‹å›¾ï¼Œå¯èƒ½ä¼šæ›´ç›´è§‚ç‚¹ï¼š ç°åœ¨å†çœ‹ CombinedModifier çš„ foldIn å‡½æ•°ï¼š 12override fun &lt;R&gt; foldIn(initial: R, operation: (R, Modifier.Element) -&gt; R): R = inner.foldIn(outer.foldIn(initial, operation), operation) åœ¨è¿™ä¸ª foldIn å®ç°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¤„ç†ä¿®é¥°ç¬¦é“¾çš„è¿‡ç¨‹æ˜¯é€’å½’çš„å’Œåˆ†å±‚çš„ã€‚è®©æˆ‘ä»¬é€æ­¥è§£æè¿™ä¸ªå‡½æ•°ï¼š initial: Rï¼šæ˜¯ç´¯ç§¯æ“ä½œçš„åˆå§‹å€¼ã€‚ operation: (R, Modifier.Element) -&gt; Rï¼šæ˜¯ä¸€ä¸ªåº”ç”¨äºæ¯ä¸€ä¸ª Modifier.Element çš„é«˜é˜¶å‡½æ•°ï¼Œå®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼šå½“å‰çš„ç´¯ç§¯å€¼å’Œ Modifier çš„ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¿”å›æ–°çš„ç´¯ç§¯å€¼ã€‚ inner.foldIn(outer.foldIn(initial, operation), operation)ï¼šå°†ä¸Šä¸€æ­¥çš„ç»“æœä½œä¸ºå®ƒçš„åˆå§‹å€¼ï¼Œå¹¶åœ¨ inner ä¿®æ”¹å™¨é“¾ä¸Šæ‰§è¡Œç›¸åŒçš„ operation å‡½æ•°ã€‚ æ„Ÿè§‰å¥½å¤æ‚å•Šï¼Œæ²¡å…³ç³»ä¸æ…Œï¼Œçœ‹å›¾ï¼š åˆ°è¿™é‡Œæˆ‘ä»¬å†æ¥å›é¡¾ä¸‹åˆšæ‰ç»Ÿè®¡ Modifier æ•°é‡çš„ä¾‹å­ï¼š 123456789val modifier = Modifier .background(Color.Blue) .size(40.dp) .padding(10.dp)val result = modifier.foldIn&lt;Int&gt;(0) { currentIndex, element -&gt; println(&quot;@@@ index: $currentIndex , element :$element&quot;) currentIndex + 1}println(&quot;@@@ result = $result&quot;) Log å¦‚ä¸‹ï¼š 1234@@@ index: 0 , element :androidx.compose.foundation.BackgroundElement@52227b59@@@ index: 1 , element :androidx.compose.foundation.layout.SizeElement@780004cf@@@ index: 2 , element :androidx.compose.foundation.layout.PaddingElement@b80004cf@@@ result = 3 ç°åœ¨æ˜¯ä¸æ˜¯å°±èƒ½æ¯«æ— å‹åŠ›çš„çœ‹æ˜ç™½äº†ï¼Ÿå†æ¥ä¸€å¼ å›¾ï¼š foldOut() è§£æ ä¸ foldIn() ç›¸åï¼Œ æˆ‘ä»¬å°±ä¸å†å•ç‹¬å±•å¼€åˆ†æå®ƒçš„å‚æ•°äº†ï¼Œè¿˜æ˜¯ä»¥å‰é¢ç»Ÿè®¡ Modifier ä¸ªæ•°çš„ä¾‹å­çœ‹ä¸‹ Log è¾“å‡ºï¼š 1234567891011val modifier = Modifier .background(Color.Blue) .size(40.dp) .padding(10.dp)val result = modifier.foldOut&lt;Int&gt;(0) { element, currentIndex -&gt; println(&quot;@@@ index: $currentIndex , element :$element&quot;) currentIndex + 1}println(&quot;@@@ result = $result&quot;) çœ‹ä¸‹ Logï¼š 1234@@@ index: 0 , element :androidx.compose.foundation.layout.PaddingElement@b80004cf@@@ index: 1 , element :element :androidx.compose.foundation.layout.SizeElement@780004cf@@@ index: 2 , element :element :androidx.compose.foundation.BackgroundElement@52227b59@@@ result = 3 æ˜¯ä¸æ˜¯åè¿‡æ¥çš„ï¼Ÿå¦å¤–æ³¨æ„ lambda è¡¨è¾¾å¼å†…éƒ¨çš„å‚æ•°ä½ç½®ä¸ foldIn() æ˜¯åç€æ¥çš„ï¼Œå…¶å®ƒæ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚ ğŸ““ Modifier.Element åœ¨ Modifier æ•´ä¸ªä½“ç³»é‡Œé¢ï¼Œæœ‰å¾ˆå¤š Modifier æ¥å£çš„å­æ¥å£å’Œå®ç°ç±»ï¼Œé™¤äº†æˆ‘ä»¬ä¹‹å‰æè¿‡çš„ companion object ä¼´ç”Ÿå¯¹è±¡å’Œ CombinedModifier ç±»ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰çš„ Modifierï¼Œä¸ç®¡æ˜¯æ¥å£è¿˜æ˜¯å®ç°ç±»ï¼Œå…¨éƒ¨éƒ½ç›´æ¥æˆ–è€…é—´æ¥çš„ç»§æ‰¿äº† Modifier çš„å¦å¤–ä¸€ä¸ªå­æ¥å£ï¼šElementã€‚ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/2d30a20773f432e69488d2a94461fc1f.png#pic_center =700x) æ¯”å¦‚æˆ‘ä»¬å‰é¢é‡åˆ°çš„ Background èƒŒåçš„ BackgroundElementï¼š 123456789private class BackgroundElement( private val color: Color = Color.Unspecified, private val brush: Brush? = null, private val alpha: Float, private val shape: Shape, private val inspectorInfo: InspectorInfo.() -&gt; Unit) : ModifierNodeElement&lt;BackgroundNode&gt;() {abstract class ModifierNodeElement&lt;N : Modifier.Node&gt; : Modifier.Element ... åˆæ¯”å¦‚ SizeModifierï¼š 12345678910private class SizeElement( private val minWidth: Dp = Dp.Unspecified, private val minHeight: Dp = Dp.Unspecified, private val maxWidth: Dp = Dp.Unspecified, private val maxHeight: Dp = Dp.Unspecified, private val enforceIncoming: Boolean, private val inspectorInfo: InspectorInfo.() -&gt; Unit) : ModifierNodeElement&lt;SizeNode&gt;() {abstract class ModifierNodeElement&lt;N : Modifier.Node&gt; : Modifier.Element ... åˆæ¯”å¦‚ PaddingModifierï¼š 12345678910private class PaddingElement( var start: Dp = 0.dp, var top: Dp = 0.dp, var end: Dp = 0.dp, var bottom: Dp = 0.dp, var rtlAware: Boolean, val inspectorInfo: InspectorInfo.() -&gt; Unit) : ModifierNodeElement&lt;PaddingNode&gt;() {abstract class ModifierNodeElement&lt;N : Modifier.Node&gt; : Modifier.Element ... ä½ ä¼šå‘ç°å®ƒä»¬çš„æ ¹ç»Ÿç»Ÿéƒ½æ˜¯ Modifier.Element è¿™ä¸ªæ¥å£ã€‚ åƒè¿™ç±»ç›´æ¥å­æ¥å£æˆ–å­ç±»è¿˜æœ‰å“ªäº›å‘¢ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œè¿™äº›æ¥å£å’Œå­ç±»åŸºæœ¬æ¶µç›–äº† Modifier æ‰€æä¾›çš„æ‰€æœ‰èƒ½åŠ›ã€‚ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/819a9fe1dc5621332ae5d280fa1c3c33.png#pic_center =500x)","link":"/2024/09/06/Compose%20--%20Modifier%20--%2001.%20%E8%A7%A3%E6%9E%90%20Modifier%20&%20CombinedModifier/"},{"title":"è§£æ ComposedModifier","text":"# å‰è¨€ä¼—æ‰€å‘¨çŸ¥ï¼šåŸç†æ€§åˆ†æçš„æ–‡ç« ï¼ŒçœŸçš„å¾ˆéš¾è®²çš„é€šä¿—æ˜“æ‡‚ï¼Œè®²çš„ç®€å•äº†å°±æ²¡å¿…è¦å†™äº†ï¼Œè®²çš„ç¹çæ‚ä¹±å¾€å¾€å¤§å®¶ä¹Ÿä¸ä¹æ„çœ‹ï¼Œæ‰€ä»¥åªèƒ½å°½é‡æ‰¾ä¸ªå¥½çš„è§’åº¦ï¼ˆæ¯”å¦‚ä» Demo ä»£ç ç¤ºä¾‹å‡ºå‘ï¼‰æ…¢æ…¢å¸¦ç€å¤§å®¶å»é’»æºç ï¼Œå¦‚æœç¡®å®èƒ½å¸®åŠ©åˆ°å¤§å®¶ç†è§£æ¸…æ¥šåŸç†ï¼Œé‚£å°±ç‚¹ä¸ªèµå‘—ï½ğŸ˜„ åœ¨æ­£å¼å¼€å§‹åˆ†æè¿™ç¯‡æ–‡ç« çš„ä¸»è§’ä¹‹å‰ï¼Œå»ºè®®ä½ å…ˆçœ‹çœ‹ ã€æ·±åº¦è§£æ Compose çš„ Modifier åŸç† â€“ Modifierã€CombinedModifierã€‘ ä¸€æ–‡ï¼Œä½œä¸º Modifier åŸç†ç³»åˆ—çš„ç¬¬ä¸€ç¯‡å¼€å±±ä¹‹ä½œï¼Œå®ƒæ˜¯ä¸€ä¸ªæ ¹ï¼Œå¿…é¡»æŒæ¡ï¼ æˆ‘ä»¬ç›´æ¥è¿›å…¥ä¸»é¢˜ï¼ŒæŸ¥çœ‹ ComposedModifier æºç ï¼š 123456ğŸ“„ androidx.compose.ui.ComposedModifier.ktprivate open class ComposedModifier( inspectorInfo: InspectorInfo.() -&gt; Unit, val factory: @Composable Modifier.() -&gt; Modifier) : Modifier.Element, InspectorValueInfo(inspectorInfo) ç»†å¿ƒçš„ä½ ä¼šå‘ç° ComposedModifier æ˜¯ä¸ªç§æœ‰å‡½æ•°ï¼Œä½ æ˜¯æ²¡æœ‰åŠæ³•ç›´æ¥åˆ›å»ºçš„ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ª ComposedModifierï¼Œåˆ™éœ€è¦ä½¿ç”¨ Modifier.composed() æ‰©å±•å‡½æ•°ï¼š 1234567891011class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Modifier.composed { } } } }} è¿™æ ·ï¼ŒModifier.composed() æ‰©å±•å‡½æ•°ä¼šå¸®æˆ‘ä»¬åˆ›å»ºå‡ºä¸€ä¸ª ComposedModifierã€‚ 12345678ğŸ“„ androidx.compose.ui.ComposedModifier.ktfun Modifier.composed( inspectorInfo: InspectorInfo.() -&gt; Unit = NoInspectorInfo, factory: @Composable Modifier.() -&gt; Modifier): Modifier = this.then(ComposedModifier(inspectorInfo, factory))==&gt; this.then() ... ç†Ÿæ‚‰å§ï¼Ÿæ˜¯ä¸æ˜¯å¾—åˆ°äº†ä¸€ä¸ª ComposedModifierï¼Ÿ çœ‹åˆ°è¿™é‡Œï¼Œä½ åº”è¯¥ä¼šæœ‰ç–‘é—®ä¸‰è¿äº†ï¼š ğŸ¤”ğŸ¤” ComposedModifier æ˜¯ä¸ªå•¥ï¼Ÿ ğŸ¤”ğŸ¤” ä¸ºä»€ä¹ˆè¦åˆ›å»ºä¸€ä¸ª ComposedModifier ï¼Ÿ ğŸ¤”ğŸ¤” ä»€ä¹ˆæ—¶å€™åˆè¯¥åˆ›å»ºä¸€ä¸ª ComposedModifier ï¼Ÿ å¸¦ç€è¿™ä¸‰ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬å¼€å§‹ç»§ç»­æ¢è®¨ ComposedModifier çš„ç²¾é«“ â€¦ â€¦ é¦–å…ˆæˆ‘ç›´æ¥å‘Šè¯‰ä½  ComposedModifier çš„ä½œç”¨ï¼šComposedModifier çš„ä½œç”¨æ˜¯é€šè¿‡ factory å·¥å‚å‡½æ•°åœ¨ç»„åˆè¿‡ç¨‹ä¸­æ‰§è¡Œ factory åˆ›å»ºå‡º Modifier å¹¶ä½¿ç”¨ã€‚ è¿™æ®µå®šä¹‰çœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼Œè·Ÿç€æˆ‘çš„èŠ‚å¥æ¥ï¼Œæ¯”å¦‚çœ‹ä¸‹é¢è¿™æ®µç®€å•çš„ä»£ç ç¤ºä¾‹ï¼š 1234567891011class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Modifier.padding(10.dp) } } }} æ­£å¸¸æƒ…å†µä¸‹è¿™ä¹ˆå†™ï¼Œå½“æ‰§è¡Œåˆ° Modifier.padding() çš„æ—¶å€™ï¼Œä¼šç«‹å³åˆ›å»ºå‡ºä¸€ä¸ª PaddingElementï¼Œè¿™ä¸ªä½ åº”è¯¥å¾ˆæ¸…æ¥šäº†ï¼Œå¦‚æœä¸äº†è§£ï¼Œå¯ä»¥å…ˆé˜…è¯» ã€ æ·±åº¦è§£æ Compose çš„ Modifier åŸç† â€“ Modifierã€CombinedModifier ã€‘è¿™ç¯‡æ–‡ç« ã€‚ ç°åœ¨æˆ‘è°ƒæ•´ä¸‹ä»£ç ï¼š 1234567891011class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Modifier.composed { Modifier.padding(10.dp) } } } }} è¿™é‡Œæˆ‘æŠŠ Modifier.padding() ç»™åŒ…è¿›äº† ComposedModifier é‡Œé¢ï¼Œé‚£ä¹ˆå½“ç¨‹åºæ‰§è¡Œåˆ°è¿™æ®µä»£ç çš„æ—¶å€™ï¼Œä½ è§‰å¾— Modifier.padding() è¿˜ä¼šç«‹å³æ‰§è¡Œå—ï¼Ÿ å†å›é¡¾ä¸€é ComposedModifier çš„å®šä¹‰ï¼šComposedModifier çš„ä½œç”¨æ˜¯é€šè¿‡ factory å·¥å‚å‡½æ•°åœ¨ç»„åˆè¿‡ç¨‹ä¸­æ‰§è¡Œ factory åˆ›å»ºå‡º Modifier å¹¶ä½¿ç”¨ã€‚ è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥æ‹†åˆ†ä¸‹å®šä¹‰äº†ï¼Œä¸»è¦å°±æ˜¯ä¸¤ä¸ªæ ¸å¿ƒï¼š ç»„åˆè¿‡ç¨‹ä¸­ æ‰§è¡Œ factory åˆ›å»ºå‡º Modifier å…ˆæ¥çœ‹ä¸‹ç¬¬äºŒç‚¹ï¼Œæˆ‘ä»¬å…¶å®ä»åˆšåˆš Modifier.composed å‡½æ•°å®šä¹‰å°±èƒ½çœ‹å‡ºæ¥äº†ï¼š é‚£ä¹ˆç¬¬ä¸€ç‚¹ï¼šç»„åˆè¿‡ç¨‹ä¸­ï¼Œè¯¥å¦‚ä½•ç†è§£ï¼Ÿå…¶å®å¾ˆå¥½ç†è§£ï¼Œä½ æ—¢ç„¶åˆ›å»ºäº† Modifierï¼Œè‚¯å®šè¦ç”¨èµ·æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹çœ‹åœ¨ç»„åˆè¿‡ç¨‹ä¸­ ComposedModifier æ˜¯å¦‚ä½•å‘æŒ¥ä½œç”¨çš„ã€‚ æˆ‘ç°åœ¨å†æ¥æ”¹ä¸‹ä»£ç ï¼š 1234567891011class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.composed { Modifier.padding(10.dp) }) } } }} å†æ¥çœ‹ä¸€é ComposedModifier çš„å®šä¹‰ï¼šComposedModifier çš„ä½œç”¨æ˜¯é€šè¿‡ factory å·¥å‚å‡½æ•°åœ¨ç»„åˆè¿‡ç¨‹æ—¶æ‰§è¡Œ factory åˆ›å»ºå‡º Modifier å¹¶ä½¿ç”¨ã€‚ æ‰€ä»¥ç°åœ¨æˆ‘ä»¬å°±æ¥çœ‹çœ‹ Box() å†…éƒ¨æ˜¯åœ¨å“ªé‡Œæ‰§è¡Œ factory å·¥å‚å‡½æ•°çš„ã€‚ è·³è½¬åˆ° Box()ï¼š 123456ğŸ“„ androidx.compose.foundation.layout.Box.kt@Composablefun Box(modifier: Modifier) { Layout({}, measurePolicy = EmptyBoxMeasurePolicy, modifier = modifier)} è·³è½¬åˆ° Layout()ï¼š 1234567891011121314151617181920212223ğŸ“„ androidx.compose.ui.layout.Layout.kt@Composable inline fun Layout( content: @Composable @UiComposable () -&gt; Unit, modifier: Modifier = Modifier, measurePolicy: MeasurePolicy) { ... ... ReusableComposeNode&lt;ComposeUiNode, Applier&lt;Any&gt;&gt;( ... ... skippableUpdate = materializerOf(modifier), content = content )}@PublishedApiinternal fun materializerOf( modifier: Modifier): @Composable SkippableUpdater&lt;ComposeUiNode&gt;.() -&gt; Unit = { val compositeKeyHash = currentCompositeKeyHash val materialized = currentComposer.materialize(modifier) ... ...} è·³è½¬ materialize() 12345678910111213141516171819202122ğŸ“„ androidx.compose.ui.ComposedModifier.ktfun Composer.materialize(modifier: Modifier): Modifier { if (modifier.all { it !is ComposedModifier }) { return modifier } val result = modifier.foldIn&lt;Modifier&gt;(Modifier) { acc, element -&gt; acc.then( if (element is ComposedModifier) { @Suppress(&quot;UNCHECKED_CAST&quot;) val factory = element.factory as Modifier.(Composer, Int) -&gt; Modifier val composedMod = factory(Modifier, this, 0) materialize(composedMod) } else { element } ) } return result} å¥½ç†Ÿæ‚‰å‘€ï¼Œå‡ºç°äº† foldIn()ï¼æˆ‘ä»¬æ¥è§£è¯»ä¸€ä¸‹è¿™æ®µä»£ç ï¼š è¿™ä¹ˆä¸€åˆ†è§£ï¼Œç°åœ¨ä½ åº”è¯¥å¾ˆæ¸…æ¥š ComposedModifer çš„å·¥å‚å‡½æ•°åœ¨å“ªé‡Œè°ƒç”¨äº†å§ï¼Ÿ ä½†æ˜¯é—®é¢˜åˆæ¥äº†ï¼Œè¿™ä¹ˆè´¹åŠ²æä¸€ä¸ª ComposedModifier æœ‰å•¥æ„ä¹‰ï¼Ÿ 12Box(Modifier.composed { Modifier.padding(10.dp) })Box(Modifier.padding(10.dp) // æˆ‘è¿™ä¹ˆå†™ä¸å°±è¡Œäº†ï¼Ÿ æˆ‘ä»¬æ¥çœ‹ä¸‹ Modifier.composed å‡½æ•°çš„è¯´æ˜ï¼š æ³¨æ„å‡ ä¸ªå…³é”®è¯ï¼š1. stateful modifiersï¼šæœ‰çŠ¶æ€çš„ Modifierï¼›2. reusedï¼šé‡ç”¨ï¼›3. element-specific stateï¼šçŠ¶æ€ç‹¬æœ‰ã€‚ è¯¥å¦‚ä½•ç†è§£è¿™å‡ ä¸ªè¯çš„æ„æ€å‘¢ï¼Ÿ æ¥çœ‹ä»¥ä¸‹ä»£ç ï¼š 12345678910111213141516171819class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { // å†™æ³• 1 val modifier1 = Modifier.composed { Modifier.padding(10.dp) } Box(modifier1) Text(&quot;Compose&quot;, modifier1) // å†™æ³• 2 val modifier2 = Modifier.padding(10.dp) Box(modifier2) Text(&quot;Compose&quot;, modifier2) } } }} è¯·é—®ï¼šå†™æ³• 1 å’Œå†™æ³• 2 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ æˆ‘ç›¸ä¿¡ä½ ç»è¿‡ä¸Šé¢ ComposedModifier çš„è§£ææµç¨‹ï¼Œåº”è¯¥å¯ä»¥å¾ˆæ¸…æ™°çŸ¥é“ï¼šå†™æ³• 1 å’Œå†™æ³• 2 å”¯ä¸€çš„åŒºåˆ«å°±åœ¨äºï¼Œå†™æ³• 1 çš„ Modifier.padding() ä¼šå»¶è¿Ÿåˆ›å»ºï¼ˆç”± ComposedModifier çš„ factory å‡½æ•°åˆ›å»ºï¼‰ï¼Œå®ƒä»¬ä¸¤è€…çš„è¿è¡Œæ˜¾ç¤ºç»“æœæ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚ å®é™…ä¸Š Modifier.composed() ä¸æ˜¯ç”¨åœ¨æ¡ˆä¾‹å†™çš„è¿™ç§åœºæ™¯ä¸‹ï¼Œè€Œæ˜¯ç”¨åœ¨æœ‰çŠ¶æ€çš„ Modifier çš„åœºæ™¯ã€‚ ä»€ä¹ˆå«æœ‰çŠ¶æ€çš„ Modifierï¼ŸæŒ‰ä¸Šé¢çš„ä¾‹å­ 10.dp å°±æ˜¯ä¸€ä¸ªçŠ¶æ€ï¼Œä¸è¿‡å› ä¸ºåœ¨è¿™é‡Œå·²ç»å†™æ­»äº†æ•°å€¼æ‰€ä»¥ Modifier.padding() æ˜¯æ— çŠ¶æ€çš„ï¼Œè¿›è€Œ Modifier.composed() ä¹Ÿæ˜¯æ— çŠ¶æ€çš„ã€‚ ç°åœ¨æˆ‘ä»¬æ¥æ”¹ä¸‹ä»£ç ï¼š 12345678910111213141516class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { val modifier = Modifier.composed { var padding by remember { mutableStateOf(10.dp) } Modifier.padding(padding) } Box(modifier) Text(&quot;Compose&quot;, modifier) } } }} æˆ‘ä»¬æŠŠ 10.dp æå–å‡ºæ¥ï¼Œè¿™æ · Modifier.padding() å°±æ˜¯æœ‰çŠ¶æ€çš„äº†ã€‚å¦‚æœä½ å¯¹ Compose æ‰€è°“çš„æœ‰çŠ¶æ€ã€æ— çŠ¶æ€ä¸äº†è§£çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹ ã€ èŠèŠ Jetpack Compose çš„ â€œçŠ¶æ€è®¢é˜…&amp;è‡ªåŠ¨åˆ·æ–°â€ â€“ æœ‰çŠ¶æ€ã€æ— çŠ¶æ€ã€çŠ¶æ€æå‡ï¼Ÿã€‘ è¿™ç¯‡æ–‡ç« ã€‚ ç°åœ¨ Modifier.padding() å°±æ˜¯æœ‰çŠ¶æ€çš„ï¼Œè¿›è€Œ Modifier.composed() å°±æ˜¯æœ‰çŠ¶æ€çš„ï¼Œç°åœ¨æˆ‘ä»¬å†å›é¡¾ä¸‹ Modifier.composed å‡½æ•°æ³¨è§£ï¼š 1. stateful modifiersï¼šæœ‰çŠ¶æ€çš„ Modifierï¼›2. reusedï¼šé‡ç”¨ï¼›3. element-specific stateï¼šçŠ¶æ€ç‹¬æœ‰ å†ç»“åˆè¿™ä¸ªä¾‹å­ï¼š 12345678910111213141516class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { val modifier = Modifier.composed { var padding by remember { mutableStateOf(10.dp) } Modifier.padding(padding) // 1. stateful modifiersï¼šæœ‰çŠ¶æ€çš„ Modifier } Box(modifier) // 2. reusedï¼šé‡ç”¨ Text(&quot;Compose&quot;, modifier) // 2. reusedï¼šé‡ç”¨ } } }} æ˜¯ä¸æ˜¯æ»¡è¶³äº†ä¸¤æ¡ï¼Ÿé‚£ â€œçŠ¶æ€ç‹¬æœ‰â€ åˆæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿè¯¥æ€ä¹ˆéªŒè¯å‘¢ï¼Ÿ æ¥ï¼Œæˆ‘ä»¬å†æ”¹ä¸‹ä»£ç ï¼š 1234567891011121314151617181920class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { val modifier = Modifier.composed { var padding by remember { mutableStateOf(10.dp) } Modifier .padding(padding) .clickable { padding = 0.dp } } Column { Box(Modifier.background(Color.Red) then modifier) Text(&quot;Compose&quot;, Modifier.background(Color.Blue) then modifier) } } } }} è¿™é‡Œæˆ‘ä»¬å¯¹ Modifier åˆåŠ äº†ä¸€ä¸ªç‚¹å‡»æ“ä½œï¼šä¿®æ”¹ padding å€¼ä¸º 0ï¼Œçœ‹ä¸‹è¿è¡Œæ•ˆæœï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/9699b74351e0d93d270d83ad48112d77.gif =700x) å‘ç°ä»€ä¹ˆæ²¡ï¼ŸText() ç»„ä»¶ç‚¹å‡»åï¼Œpadding ä¿®æ”¹ä¸º 0ï¼Œå´æ²¡æœ‰å½±å“åˆ° Box çš„ paddingï¼Œè¿™å°±æ˜¯ Modifier çŠ¶æ€ç‹¬æœ‰ï¼ é‚£æˆ‘ä»¬å†è¯•è¯•ä¸ç”¨ Modifier.composed() å‡½æ•°åŒ…èµ·æ¥çš„åœºæ™¯ï¼Œæ¯”å¦‚ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { var padding by remember { mutableStateOf(10.dp) } val modifier = Modifier .padding(padding) .clickable { padding = 0.dp } Column { Box(Modifier.background(Color.Red) then modifier) Text(&quot;Compose&quot;, Modifier.background(Color.Blue) then modifier) } } } }} è¿™æ®µä»£ç ä¸éš¾ç†è§£å§ï¼Ÿæ¥çœ‹ä¸‹æ•ˆæœï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/97a9e097adda9a1923c783e1516797f3.gif =700x) å‘ç°æ²¡ï¼Ÿå®ƒä»¬æ­å–œäº† paddingï¼Œç‚¹å‡»ä»»ä½•ä¸€ä¸ªç»„ä»¶ï¼Œéƒ½ä¼šå½±å“åˆ°å¦å¤–ä¸€ä¸ªçš„ paddingã€‚ æ‰€ä»¥åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥æ€»ç»“ä¸‹ Modifier.compose() å‡½æ•°çš„ä½œç”¨äº†ï¼šå®ƒä¼šåˆ›å»ºä¸€ä¸ªå¸¦çŠ¶æ€çš„ Modifierï¼Œè¿™ä¸ª Modifier å¯ä»¥é‡ç”¨ï¼Œå¹¶ä¸”çŠ¶æ€æ˜¯ç‹¬ç«‹çš„ã€‚ ä½†æ˜¯ï¼ä½†æ˜¯ï¼ä½†æ˜¯ï¼ç»†å¿ƒçš„ä½ åº”è¯¥åˆä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼šè¿™æœ‰ç‚¹è´¹å•Šï¼Œæˆ‘å¯ä»¥æœ‰æ›´ç®€å•çš„å†™æ³•å•Šï¼Œæ¯”å¦‚ï¼š 123456789101112131415161718class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { var padding1 by remember { mutableStateOf(10.dp) } val modifier1 = Modifier.padding(padding1).clickable { padding1 = 0.dp } var padding2 by remember { mutableStateOf(10.dp) } val modifier2 = Modifier.padding(padding2).clickable { padding2 = 0.dp } Column { Box(Modifier.background(Color.Red) then modifier1) Text(&quot;Compose&quot;, Modifier.background(Color.Blue) then modifier2) } } } }} æ—¢ç„¶ä¸æƒ³ Box() å’Œ Text() çš„ padding ç›¸äº’å½±å“ï¼Œé‚£ä¹ˆåˆ†åˆ«ç»™å®ƒä»¬è®¾ç½®ä¸€ä¸ª Modifier ä¸å°±è¡Œäº†ï¼Ÿä½•å¿…è¦ç”¨ Modifier.composed() è¿™ç§èŠ±é‡Œèƒ¡å“¨ï¼Œçœ‹ä¸Šå»æ›´é«˜ç«¯çš„æ–¹æ³•å‘¢ï¼Ÿè¿™æ®µä»£ç çš„é€»è¾‘çœ‹ä¸Šå»å²‚ä¸æ˜¯æ›´æ¸…æ™°ï¼Ÿ å®é™…ä¸Š Modifier.composed() çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼šå½“æˆ‘ä»¬éœ€è¦åˆ›å»ºçš„ Modifier éœ€è¦ç»™å®ƒæ·»åŠ ä¸€äº›å†…éƒ¨çŠ¶æ€ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦ä½¿ç”¨ Modifier.composed() æ¥ä¸ºå®ƒæä¾›ä¸€ä¸ª Composable çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä»è€Œè®©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ rememberã€‚ æ€ä¹ˆç†è§£è¿™æ®µè¯ï¼Ÿä½ å¯ä»¥ç†è§£æˆï¼šå½“æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ª Modifier æ—¶ï¼ŒåŒæ—¶å½“ Modifier å†…éƒ¨éœ€è¦ç”¨åˆ° remember æ—¶ï¼Œå°±éœ€è¦ç”¨åˆ° ComposeModifierã€‚ æ¯”å¦‚æˆ‘ä»¬ä¿®æ”¹ä¸‹å‰é¢çš„ Modifier.composed() ä»£ç ï¼š 1234567891011121314151617181920212223class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Column { // 2. ç»™å¤–éƒ¨ç»„ä»¶è°ƒç”¨ Box(Modifier.background(Color.Red) then Modifier.paddingJumpModifier()) Text(&quot;Compose&quot;, Modifier.background(Color.Blue) then Modifier.paddingJumpModifier()) } } } }}// 1. è¿™é‡Œè‡ªå®šä¹‰äº†ä¸€ä¸ª Modifier.paddingJumpModifierfun Modifier.paddingJumpModifier() { var padding by remember { mutableStateOf(10.dp) } Modifier .padding(padding) .clickable { padding = 0.dp }} å¦‚æœä½ è¿™ä¹ˆå†™ä¼šæŠ¥é”™ï¼š æŠ¥é”™åŸå› å¾ˆç®€å•ï¼Œremember æ˜¯ä¸€ä¸ª Composable å‡½æ•°ï¼Œä½ å¿…é¡»è¦åœ¨ Composable çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ‰èƒ½è°ƒç”¨ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Modifier.composed() ä¸ºå®ƒæä¾›ä¸€ä¸ª Composable çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä»è€Œè®©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ rememberã€‚ å†™æ³•å¾ˆç®€å•ï¼š 123456fun Modifier.paddingJumpModifier() = composed { var padding by remember { mutableStateOf(10.dp) } Modifier .padding(padding) .clickable { padding = 0.dp }} è¿™æ ·ä½ çš„ä»£ç å°±ä¸ä¼šæŠ¥é”™äº†ï¼Œå¹¶ä¸”æ‰€æœ‰è°ƒç”¨ Modifier.paddingJumpModifier çš„åœ°æ–¹å†…éƒ¨çš„ padding çŠ¶æ€ä¹Ÿæ˜¯ç‹¬ç«‹çš„ã€‚ ä¸ºä»€ä¹ˆ Modifier.composed() å‡½æ•°å†…éƒ¨å°±å¯ä»¥ä½¿ç”¨ remember ï¼Ÿ 1234fun Modifier.composed( inspectorInfo: InspectorInfo.() -&gt; Unit = NoInspectorInfo, factory: @Composable Modifier.() -&gt; Modifier // çœ‹è¿™é‡Œï¼Œå®ƒçš„å·¥å‚å‡½æ•°æä¾›äº† Composable ä¸Šä¸‹æ–‡ç¯å¢ƒ): Modifier = this.then(ComposedModifier(inspectorInfo, factory)) æ‰€ä»¥ï¼Œfactory å·¥å‚å‡½æ•°æä¾›äº† Composable ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ rememberã€‚ é™¤äº†å¯ä»¥è°ƒç”¨ rememberï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ Modifier.compose() å†…éƒ¨å¼€å¯åç¨‹ï¼š 123456789fun Modifier.paddingJumpModifier() = composed { var padding by remember { mutableStateOf(10.dp) } LaunchedEffect(Unit) { } Modifier .padding(padding) .clickable { padding = 0.dp }} å¦‚æœä½ ä¸åŠ  = composedï¼Œé‚£ä¹ˆä½ è°ƒç”¨ LaunchedEffect å°±ä¼šæŠ¥é”™ï¼Œä¸ä¿¡ä½ è¯•è¯•ã€‚ æœ€åæ€»ç»“ä¸€ä¸‹ ComposedModifier æˆ– Modifier.composed()ï¼š æŒ‰ç…§å®˜æ–¹æ³¨é‡Šçš„è¯´æ³•ï¼ŒModifier.composed() èƒ½åˆ›å»ºå‡ºå¸¦æœ‰çŠ¶æ€çš„ Modifierï¼Œè®©è¿™ä¸ª Modifier åœ¨å¤šå¤„è¢«é‡ç”¨ï¼› æœ‰çŠ¶æ€çš„ Modifier å°±æ˜¯è¢« remember åŒ…ç€çš„å˜é‡å’Œ Modifier æ”¾åœ¨ä¸€èµ·ä½œä¸ºå®ƒçš„å†…éƒ¨çŠ¶æ€ä½¿ç”¨ï¼› é‡ç”¨å°±æ˜¯ Modifier.composed() åœ¨æ¯ä¸€ä¸ªä½¿ç”¨çš„åœ°æ–¹éƒ½åˆ›å»ºä¸€ä¸ªå†…éƒ¨çŠ¶æ€ç‹¬ç«‹çš„ Modifierï¼Œè€Œä¸ä¼šäº’ç›¸å½±å“ Modifier.composed() ä¸ä»…èƒ½æä¾›å†…éƒ¨çŠ¶æ€ï¼Œåœ¨ä¸€äº›éœ€è¦ Composable ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¾‹å¦‚ LaunchedEffect æˆ– CompositionLocal ç­‰åœ°æ–¹ä½¿ç”¨ Modifierï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒã€‚","link":"/2024/09/10/Compose%20--%20Modifier%20--%2002.%20%E8%A7%A3%E6%9E%90%20ComposedModifier/"},{"title":"è§£æ DrawModifier","text":"â€œJetpack Compose - - Modifier åŸç†ç³»åˆ—æ–‡ç«  â€œ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - Modifierã€CombinedModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - Modifier.composed()ã€ComposedModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - Modifier.layout()ã€LayoutModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - DrawModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - PointerInputModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - ParentDataModifier ã€‹ åœ¨æ­£å¼å¼€å§‹åˆ†æ DrawModifier ä¹‹å‰ï¼Œå»ºè®®ä½ å…ˆçœ‹çœ‹ ã€LayoutModifier å’Œ Modifier.layout ç”¨æ³•åŠåŸç†ã€‘è¿™ç¯‡æ–‡ç« ï¼Œæ¯•ç«Ÿå®ƒæ˜¯ä½œä¸º Modifier åŸç†è§£æçš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œå¯¹ä½ äº†è§£æ•´ä¸ª Modifier æ¶æ„è¿˜æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œæˆ–è€…è¯´å®ƒæ˜¯æœ€åŸºç¡€çš„ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœä¸ç†Ÿæ‚‰ï¼Œåé¢çš„ç³»åˆ— Modifier ä½ å¯èƒ½ä¼šçœ‹çš„æ¯”è¾ƒè´¹åŠ²â€¦ ä¸€ã€è¯é¢˜å¼•å…¥ è€æ ·å­ï¼Œæˆ‘ä»¬ä» Demo å¼€å§‹ï¼Œé¦–å…ˆæˆ‘ä»¬çœ‹ä¸¤ä¸ªç®€å•çš„åœºæ™¯ï¼š 1.1 é—®é¢˜åœºæ™¯ 1ä¸€ä¸ªç»¿è‰²èƒŒæ™¯çš„ Text()ï¼š 123456789101112class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;) } } } }} æ•ˆæœå¦‚ä¸‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/2f6fbfcdc180b9670cfce0abb8236bf4.png =500x) å¦‚æœæˆ‘æ”¹åŠ¨ä¸€ä¸‹ä»£ç ï¼š 12345678910111213class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green).size(120.dp)) { Text(&quot;Hi Compose&quot;) } } } }} åªæ˜¯ç»™ Box åŠ äº†ä¸€ä¸ªå°ºå¯¸ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/14eca7bc86b124dccb8a26fb7e731a28.png =500x) å—¯ï¼Œæ•ˆæœä¸é”™ï¼Œé‚£å¦‚æœæˆ‘å†æ”¹ä¸€æ¬¡å‘¢ï¼Ÿ 12345678910111213class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green).size(120.dp).background(Color.Red)) { Text(&quot;Hi Compose&quot;) } } } }} åˆåŠ äº†ä¸€ä¸ª backgroundï¼Œçœ‹ä¸‹æ•ˆæœï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/da9a778662bd7af48e1d253c5f9edb8f.png =500x) æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆæ­¤æ—¶çš„ Box æ˜¯çº¢è‰²ï¼Œè€Œä¸æ˜¯ç»¿è‰²ï¼Ÿ å¦‚æœä½ çœ‹äº† LayoutModifier çš„åŸç†è§£æï¼Œè¿™è¾¹å°±ä¼šäº§ç”Ÿä¸€ä¸ªå›°æƒ‘ï¼šModifier ä¸æ˜¯ä»å³è¾¹å¼€å§‹ï¼Œä¾æ¬¡å¾€å·¦éå†ï¼Œæœ€ç»ˆåº”è¯¥æ˜¯ç»¿è‰²èƒŒæ™¯ï¼Œè€Œä¸åº”è¯¥æ˜¯çº¢è‰²èƒŒæ™¯å•Šï¼Ÿ æ‰€ä»¥ï¼Œé—®é¢˜å‡ºåœ¨å“ªï¼Ÿæˆ‘ä»¬ä¸å¦¨å…ˆç®€å•çœ‹ä¸‹ Modifier.background() æºç ï¼š 1234567891011fun Modifier.background( color: Color, shape: Shape = RectangleShape): Modifier { val alpha = 1.0f // for solid colors return this.then( BackgroundElement( ... ) )} å®ƒåˆè°ƒç”¨äº† BackgroundElementï¼š 123private class BackgroundElement( ...) : ModifierNodeElement&lt;BackgroundNode&gt;() { çœ‹è¿‡ä¹‹å‰ LayoutModifier è§£æçš„æ–‡ç« çš„è¯ï¼Œè¿™è¾¹ä½ åº”è¯¥ä¸ä¼šé™Œç”Ÿäº†å§ï¼ŸBackgroundElement ä¼šè½¬æ¢æˆä¸€ä¸ª BackgroundNode å¯¹è±¡ï¼Œå®ƒæ˜¯å®é™…çš„é“¾è¡¨èŠ‚ç‚¹ã€‚ 123private class BackgroundNode( ...) : DrawModifierNode, Modifier.Node() { å®ƒæ˜¯ä¸€ä¸ª DrawModifierNodeï¼Œæ‰€ä»¥æ˜¯ DrawModifierNode å½±å“äº†èƒŒæ™¯çš„ç»˜åˆ¶ï¼Ÿ 1.2 é—®é¢˜åœºæ™¯ 2åœ¨ä¹‹å‰æˆ‘ä»¬åˆ†æ LayoutModifier æ–‡ç« ä¸­æåˆ°è¿‡ï¼šå¦‚æœæˆ‘ä»¬éœ€è¦è‡ªå·±åˆ›å»ºä¸€ä¸ª LayoutModifierï¼Œå¯ä»¥é€šè¿‡ Modifier.layout()ï¼ŒåŒæ ·çš„å¦‚æœæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ª DrawModifierï¼Œå¯ä»¥é€šè¿‡ Modifier.drawWithContent()ï¼Œæ¯”å¦‚ï¼š 12345678910111213class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green).size(120.dp).drawWithContent { }) { Text(&quot;Hi Compose&quot;) } } } }} çœ‹ä¸‹æ•ˆæœï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/9f3a175fff1af88c1f664b79614393de.png =500x) ï¼Ÿï¼Ÿï¼Ÿä¸å¯¹å•Šï¼ŒText() å“ªå»äº†ï¼Ÿæˆ‘ç°åœ¨å†æ¥ä¿®æ”¹ä¸‹ä»£ç ï¼š 12345678910111213class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green).size(120.dp).drawWithContent { drawContent() }) { Text(&quot;Hi Compose&quot;) } } } }} ä»…ä»…æ˜¯åœ¨ drawWithContent é‡Œé¢åŠ äº†ä¸€ä¸ª drawContent()ï¼Œå†çœ‹ä¸‹æ•ˆæœï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/12aed22080dd8c7f7e7c25cc200a1ad4.png =500x) Text() åˆå‡ºæ¥äº†ï¼Œä¸ºä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦åŠ  drawContent()ï¼Œ drawContent() åˆæ˜¯ä»€ä¹ˆï¼Ÿéš¾é“å®ƒè´Ÿè´£ç»˜åˆ¶ Text()ï¼Ÿ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¸¦ç€è¿™ä¸¤ä¸ªé—®é¢˜æ­£å¼è¿›å…¥è¿™ç¯‡æ–‡ç« çš„ä¸»é¢˜ï¼ äºŒã€DrawModifierNode æŸ¥çœ‹ Modifier.background() å’Œ Modifier.drawWithContent() çš„æºç ï¼Œå‘ç°å®ƒä»¬èƒŒåçš„ BackgroundElement å’Œ DrawWithContentElement éƒ½ç»§æ‰¿è‡ª ModifierNodeElement&lt;N : Modifier.Node&gt;ã€‚ 1234567891011121314151617181920212223242526272829303132&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Modifier.background() &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;fun Modifier.background(...): Modifier { val alpha = 1.0f // for solid colors return this.then( BackgroundElement( ... ) )}private class BackgroundElement( ...) : ModifierNodeElement&lt;BackgroundNode&gt;()private class BackgroundNode( ...) : DrawModifierNode, Modifier.Node()&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Modifier.drawWithContent() &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;fun Modifier.drawWithContent( onDraw: ContentDrawScope.() -&gt; Unit): Modifier = this then DrawWithContentElement(onDraw)private data class DrawWithContentElement( val onDraw: ContentDrawScope.() -&gt; Unit) : ModifierNodeElement&lt;DrawWithContentModifier&gt;()private class DrawWithContentModifier( var onDraw: ContentDrawScope.() -&gt; Unit) : Modifier.Node(), DrawModifierNode { ....} è€Œä¸”æ³›å‹ç±»å‹ BackgroundNode å’Œ DrawWithContentModifier éƒ½å®ç°äº† DrawModifierNode æ¥å£ã€‚ ç”»äº†ä¸ªå›¾ï¼Œçœ‹ç€æ›´ç›´è§‚ï¼š è¿™ä¸ª DrawModifierNode æ¥å£å°±æ˜¯ Draw ä¿®é¥°ç¬¦çš„æ ¸å¿ƒï¼Œå®ƒå®šä¹‰äº† Draw ä¿®é¥°ç¬¦çš„æ ¸å¿ƒé€»è¾‘ã€‚ 123456789101112/** * A [Modifier.Node] that draws into the space of the layout. * * This is the [androidx.compose.ui.Modifier.Node] equivalent of * [androidx.compose.ui.draw.DrawModifier] * * @sample androidx.compose.ui.samples.DrawModifierNodeSample */interface DrawModifierNode : DelegatableNode { fun ContentDrawScope.draw() // draw ç»˜åˆ¶æ–¹æ³• fun onMeasureResultChanged() {}} é‚£ä¹ˆï¼Œæˆ‘ä»¬è¦æ¢ç©¶ Draw ä¿®é¥°ç¬¦å¦‚ä½•å½±å“å…ƒç´ ç»˜åˆ¶è¿‡ç¨‹ï¼Œé‡ç‚¹å°±æ˜¯çœ‹å…ƒç´ çš„ç»˜åˆ¶åœ¨å“ªç”¨åˆ°äº† DrawModifierNodeï¼Œæˆ–è€…æ›´å‡†ç¡®åœ°è¯´ï¼ŒDrawModifierNode çš„ draw() æ–¹æ³•åœ¨ä½•å¤„è¢«è°ƒç”¨äº†ã€‚ ä¸‰ã€ DrawModifierNode å¯¹ç»˜åˆ¶çš„å½±å“ ç°åœ¨æˆ‘ä»¬å·²ç»å¾ˆæ¸…æ¥š LayoutNode æ˜¯å¦‚ä½•å¤„ç† DrawModifierNode çš„äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹ DrawModifierNode æ˜¯å¦‚ä½•å¯¹ç»˜åˆ¶äº§ç”Ÿç²¾ç»†å½±å“çš„ã€‚ åœ¨ LayoutNode ä¸­ï¼Œç»˜åˆ¶æ˜¯ç”± draw() å‡½æ•°å¤„ç†çš„ã€‚ 1234567// LayoutNode.ktinternal class LayoutNode(...) : ... { internal val outerCoordinator: NodeCoordinator get() = nodes.outerCoordinator internal fun draw(canvas: Canvas) = outerCoordinator.draw(canvas)} çœ‹è¿‡ä¹‹å‰ LayoutModifierNode è§£æçš„æ–‡ç« åï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ outerCoordinator æ˜¯ä¸€ä¸ª NodeCoordinatorã€‚ 3.1 NodeCoordinator.draw()ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ NodeCoordinator çš„ draw() æ–¹æ³•ï¼š 1234567891011121314151617181920// NodeCoordinator.ktinternal abstract class NodeCoordinator( override val layoutNode: LayoutNode,) : ... { fun draw(canvas: Canvas) { // layer: æ˜¯ä¸€ä¸ªç‹¬ç«‹ç»˜åˆ¶çš„å›¾å±‚ï¼Œå®ƒåªæ˜¯åœ¨ä¸€å—é¢å¤–çš„åŒºåŸŸç»˜åˆ¶è€Œå·²ï¼Œå¤§å¤šæ•°æ—¶å€™æ˜¯æ²¡æœ‰çš„ val layer = layer if (layer != null) { layer.drawLayer(canvas) } else { val x = position.x.toFloat() val y = position.y.toFloat() canvas.translate(x, y) drawContainedDrawModifiers(canvas) // å…³é”®ä»£ç  canvas.translate(-x, -y) } }} å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦è€ƒè™‘ layer å›¾å±‚ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å½“å®ƒä¸º null å¤„ç†ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å…³å¿ƒ else åˆ†æ”¯å†…éƒ¨çš„é€»è¾‘ï¼Œæ ¸å¿ƒä»£ç å°±ä¸€è¡Œï¼šdrawContainedDrawModifiers(canvas)ã€‚ 3.2 drawContainedDrawModifiers()12345678910111213141516// NodeCoordinator.ktinternal abstract class NodeCoordinator( override val layoutNode: LayoutNode,) : ... { private fun drawContainedDrawModifiers(canvas: Canvas) { val head = head(Nodes.Draw) if (head == null) { performDraw(canvas) } else { val drawScope = layoutNode.mDrawScope drawScope.draw(canvas, size.toSize(), this, head) } } } è¿™æ®µä»£ç çš„é€»è¾‘å¾ˆæ¸…æ™°ï¼Œä¸»è¦å°±æ˜¯ä¸‰æ­¥ï¼š è·å–å½“å‰ NodeCoordinator èŒƒå›´å†…çš„çš„ç¬¬ä¸€ä¸ª Draw ä¿®é¥°ç¬¦ 1val head = head(Nodes.Draw) è¡¨å¤´å¦‚æœä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è®¾ç½®è¿‡ DrawModifier 123if (head == null) { performDraw(canvas)} é‚£ä¹ˆå°±ä¼šæ‰§è¡Œ performDraw()ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒåšäº†ä»€ä¹ˆï¼š 123open fun performDraw(canvas: Canvas) { wrapped?.draw(canvas)} wrapped æ˜¯ä»€ä¹ˆï¼Ÿ 1internal open val wrapped: LayoutNodeWrapper? get() = null å®ƒå°±æ˜¯å½“å‰çš„ LayoutNodeWrapper å¯¹è±¡ï¼Œè€Œ LayoutNodeWrapper æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ã€‚ æ³¨æ„ï¼š æˆ‘ä»¬ç°åœ¨åˆ†æçš„åœºæ™¯æ˜¯æ²¡æœ‰è®¾ç½® DrawModifierï¼Œé‚£ä¹ˆå®é™…ä»£ç å¯èƒ½æ˜¯è¿™æ ·ï¼š 1Box(Modifier.padding(10.dp).size(120.dp)) å¯¹åº”çš„å†…éƒ¨ Modifier çš„ç»“æ„å¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­ï¼š 123456789ModifiedLayoutNode[ LayoutModifier // padding(10.dp) + ModifiedLayoutNode[ LayoutModifier // size(120.dp) + innerLayoutNodeWrapper // Box() ]] ModifiedLayoutNode æœ¬èº«å°±æ˜¯ä¸€ä¸ª LayoutNodeWrapper çš„å­ç±»ï¼Œæ‰€ä»¥ï¼Œä½ ç°åœ¨çŸ¥é“ä¸Šé¢çš„ wrapped æ˜¯ä»€ä¹ˆäº†å—ï¼Ÿ 123456789ModifiedLayoutNode[ // wrapped LayoutModifier + ModifiedLayoutNode[ // wrapped LayoutModifier + innerLayoutNodeWrapper // wrapped ]] å†æ¥çœ‹çœ‹ wrapped.draw() å¹²äº†ä»€ä¹ˆï¼š 123456789101112fun draw(canvas: Canvas) { val layer = layer if (layer != null) { layer.drawLayer(canvas) } else { val x = position.x.toFloat() val y = position.y.toFloat() canvas.translate(x, y) drawContainedDrawModifiers(canvas) canvas.translate(-x, -y) }} åˆè·³å› draw() å‡½æ•°äº†ï¼Œè€Œä½ è¿˜è®°å¾— drawContainedDrawModifiers æ˜¯å¹²å˜›çš„å—ï¼Ÿå®ƒçš„æ ¸å¿ƒå°±æ˜¯ç”¨æ¥æ£€æŸ¥æ˜¯å¦æœ‰ DrawModifier çš„é“¾è¡¨çš„è¡¨å¤´ï¼Œå¦‚æœæ²¡æœ‰å°±ä¸€ç›´å¾€å†…éƒ¨æ‰¾ï¼š 123456789ModifiedLayoutNode[ LayoutModifier // padding(10.dp) --&gt; æ²¡æœ‰è®¾ç½® DrawModifierï¼Œå°±å»æ‰¾å†…éƒ¨æœ‰æ²¡æœ‰è®¾ç½® DrawModifier + ModifiedLayoutNode[ LayoutModifier // size(120.dp) --&gt; æ²¡æœ‰è®¾ç½® DrawModifierï¼Œå°±å»æ‰¾å†…éƒ¨æœ‰æ²¡æœ‰è®¾ç½® DrawModifier + innerLayoutNodeWrapper // Box() --&gt; æ²¡æœ‰è®¾ç½® DrawModifierï¼Œå®ƒæ²¡æœ‰å†…éƒ¨äº†ï¼Œå°±ä¸æ‰¾äº† ]] æ‰€ä»¥æˆ‘ä»¬æ€»ç»“ä¸‹ï¼šä¸ç®¡ä½ è®¾ç½®äº†å¤šå°‘ Modifier.**ï¼Œåœ¨ç»˜åˆ¶çš„æ—¶å€™ï¼Œéƒ½ä¼šéå†ä¸€éï¼Œåªè¦æ²¡æœ‰ DrawModifier å°±ä¸ä¼šè¿›è¡Œä»»ä½•ç»˜åˆ¶åŠ¨ä½œã€‚ è¡¨å¤´ä¸ä¸ºç©ºï¼Œæœ‰è®¾ç½® DrawModifier 123else { head.draw(canvas)} å¦‚æœæˆ‘ä»¬è®¾ç½®äº† DrawModifierï¼šæ¯”å¦‚ Modifier.background()ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œ head.draw()ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å®ƒåˆåšäº†ä»€ä¹ˆï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748// DrawEntity.ktfun draw(canvas: Canvas) { ... ... val drawScope = layoutNode.mDrawScope // 1. æ ¸å¿ƒä»£ç ï¼Œçœ‹çœ‹ drawScope.draw() åšäº†ä»€ä¹ˆå·¥ä½œ drawScope.draw(canvas, size, layoutNodeWrapper, this) { with(drawScope) { with(modifier) { draw() } } }}// LayoutNodeDrawScope.ktinternal inline fun draw( canvas: Canvas, size: Size, layoutNodeWrapper: LayoutNodeWrapper, drawEntity: DrawEntity, block: DrawScope.() -&gt; Unit) { val previousDrawEntity = this.drawEntity this.drawEntity = drawEntity // 2. æ ¸å¿ƒä»£ç  canvasDrawScope.draw( layoutNodeWrapper.measureScope, layoutNodeWrapper.measureScope.layoutDirection, canvas, size, block ) this.drawEntity = previousDrawEntity}// CanvasDrawScope.ktinline fun draw( density: Density, layoutDirection: LayoutDirection, canvas: Canvas, size: Size, block: DrawScope.() -&gt; Unit) { ... ... this.block() // 3. æ ¸å¿ƒä»£ç  ... ...} æœ€ç»ˆè°ƒç”¨äº† block()ï¼Œè¿™ä¸ª block å¤ªç†Ÿäº†ï¼Œå®ƒè‚¯å®šæ˜¯ä¸€ä¸ªä¼ è¿›æ¥çš„ Lambda è¡¨è¾¾å¼ï¼Œä¹Ÿå°±æ˜¯ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/6980d794c11d4de2db9540cf3ce46a45.png =700x) æ‰€ä»¥æˆ‘ä»¬çš„é‡ç‚¹å°±è½¬ç§»åˆ°ç ”ç©¶è¿™æ®µ lambda è¡¨è¾¾å¼çš„å·¥ä½œå†…å®¹äº†ã€‚ å®ƒé‡Œé¢ä¹Ÿæœ‰ä¸€ä¸ª draw()ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒåšäº†å•¥ï¼š 123456// DrawModifier.kt@JvmDefaultWithCompatibilityinterface DrawModifier : Modifier.Element { fun ContentDrawScope.draw()} å’¦ï¼Ÿæ˜¯ DrawModifier æ¥å£çš„ draw() æ–¹æ³•ï¼Œé‚£è‚¯å®šæœ‰æŸä¸ªè¿™ä¸ªæ¥å£çš„å®ç°ç±»å®ç°äº†è¿™ä¸ª draw() æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æœç´¢ä¸‹çœ‹çœ‹ï¼š çœ‹åˆ°æ²¡ï¼ŒBackgroundï¼ æ‰€ä»¥æˆ‘ä»¬ç°åœ¨å¯ä»¥æ¥çœ‹ä¸‹ Background çš„å†…éƒ¨çš„ draw() é€»è¾‘ï¼š 123456789101112131415private class Background constructor( ... ...) : DrawModifier, InspectorValueInfo(inspectorInfo) { override fun ContentDrawScope.draw() { if (shape === RectangleShape) { // shortcut to avoid Outline calculation and allocation drawRect() } else { drawOutline() } drawContent() }} ç»†å¿ƒçš„ä½ æ˜¯ä¸æ˜¯å‘ç°äº† drawContent()ï¼Ÿ è¿˜è®°å¾—æˆ‘ä»¬æ–‡ç« å¼€å¤´ç¬¬äºŒä¸ªç–‘æƒ‘çš„é—®é¢˜å—ï¼Ÿæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä»£ç ï¼š 12345678910111213class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green).size(120.dp).drawWithContent { drawContent() }) { Text(&quot;Hi Compose&quot;) } } } }} ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥æ¥çœ‹çœ‹ drawWithContent çš„å†…éƒ¨ä»£ç ï¼š 1234567891011121314151617181920// DrawModifier.ktfun Modifier.drawWithContent( onDraw: ContentDrawScope.() -&gt; Unit): Modifier = this then DrawWithContentElement(onDraw)private data class DrawWithContentElement( val onDraw: ContentDrawScope.() -&gt; Unit) : ModifierNodeElement&lt;DrawWithContentModifier&gt;() { override fun create() = DrawWithContentModifier(onDraw) // åˆ›å»º DrawWithContentModifier ... ...}private class DrawWithContentModifier( var onDraw: ContentDrawScope.() -&gt; Unit) : Modifier.Node(), DrawModifierNode { override fun ContentDrawScope.draw() { onDraw() // è¿™ä¸å°±ç±»ä¼¼äº blockï¼Ÿ }} æ‰€ä»¥å®é™…ä¸Šè°ƒç”¨çš„æ˜¯å•¥ï¼Ÿ ä¹Ÿå°±æ˜¯è°ƒç”¨äº† drawContent()ã€‚ æ‰€ä»¥ä¸ç®¡æ˜¯ Modifier.background() è¿˜æ˜¯ä½ è‡ªå·± drawWithContent()ï¼Œéƒ½ä¼š/éœ€è¦è°ƒç”¨ drawContent() å‡½æ•°ã€‚ æ‰€ä»¥ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é‡ç‚¹ç ”ç©¶ä¸‹ drawContent() åˆ°åº•æ˜¯åšäº†ä»€ä¹ˆäº†ï¼ 123456interface ContentDrawScope : DrawScope { /** * Causes child drawing operations to run during the `onPaint` lambda. */ fun drawContent()} åˆæ˜¯ä¸€ä¸ªæ¥å£å†…éƒ¨çš„æ–¹æ³•ï¼Œå†æœä¸€ä¸‹å“ªä¸ªåœ°æ–¹å®ç°äº† - - å…¨å±€åªæœ‰ä¸€ä¸ªåœ°æ–¹å®ç°äº†ï¼Œå¦‚ä¸‹ï¼š 12345678910111213141516171819internal class LayoutNodeDrawScope( private val canvasDrawScope: CanvasDrawScope = CanvasDrawScope()) : DrawScope by canvasDrawScope, ContentDrawScope { private var drawEntity: DrawEntity? = null override fun drawContent() { drawIntoCanvas { canvas -&gt; val drawEntity = drawEntity!! val nextDrawEntity = drawEntity.next if (nextDrawEntity != null) { nextDrawEntity.draw(canvas) } else { drawEntity.layoutNodeWrapper.performDraw(canvas) } } } ... ...} drawIntoCanvas æ˜¯ä»€ä¹ˆï¼Ÿ 1inline fun DrawScope.drawIntoCanvas(block: (Canvas) -&gt; Unit) = block(drawContext.canvas) åˆæ˜¯ä¸€ä¸ª blockï¼Œæ‰€ä»¥æˆ‘ä»¬åªå…³å¿ƒ lambda è¡¨è¾¾å¼å†…éƒ¨çš„é€»è¾‘å³å¯ï¼Œåˆ†ä¸¤æ­¥èµ°ï¼š å¦‚æœ DrawModifier é“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸º nullï¼Œè¯´æ˜åªæœ‰ä¸€ä¸ª DrawModifier é“¾è¡¨å¤´æˆ–æ²¡æœ‰æ›´å¤š DrawModifierï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šè®©ä¸‹ä¸€ä¸ª LayoutNodeWrapper æŸ¥æ‰¾å…¶å†…éƒ¨æœ‰æ²¡æœ‰ DrawModifierã€‚ æ¯”å¦‚ï¼š 1Box(Modifier.padding(10.dp).background(Color.Red).size(120.dp)) å¯¹åº”çš„å†…éƒ¨ Modifier çš„ç»“æ„å¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­ï¼š 1234567891011ModifiedLayoutNode1( PaddingModifier, [null, null, null, null, null, null, null] ModifiedLayoutNode2( SizeModifier, [DrawModifier, null, null, null, null, null, null] // ç°åœ¨ DrawModifier æ˜¯è¡¨å¤´ innerLayoutNodeWrapper( [null, null, null, null, null, null, null] ) )) ç°åœ¨é’ˆå¯¹è¿™ä¸ªåœºæ™¯ï¼Œåªæœ‰ä¸€ä¸ª DrawModifierï¼Œå®ƒæ˜¯è¡¨å¤´ï¼Œå¹¶ä¸”å®ƒæ²¡æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹äº†ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œï¼š 1drawEntity.layoutNodeWrapper.performDraw(canvas) å…·ä½“å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š &nbsp;&nbsp;&nbsp;&nbsp;==&gt; ModifiedLayoutNode1 æ²¡æœ‰ DrawModifierï¼Œç»§ç»­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ ModifiedLayoutNode2 æŸ¥æ‰¾æœ‰æ²¡æœ‰ DrawModifierï¼› &nbsp;&nbsp;&nbsp;&nbsp;==&gt; ModifiedLayoutNode2 æœ‰ DrawModifierï¼ŒDrawModifier.draw() è°ƒç”¨ç»˜åˆ¶ï¼ŒDrawModifier é“¾è¡¨æ²¡æœ‰ä¸‹ä¸€ä¸ª DrawModifierï¼Œç»§ç»­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ InnerNodeCoordinator æŸ¥æ‰¾æœ‰æ²¡æœ‰ DrawModifierï¼› &nbsp;&nbsp;&nbsp;&nbsp;==&gt; InnerNodeCoordinator æ²¡æœ‰ DrawModifierï¼Œç»˜åˆ¶ç»“æŸ å¦‚æœ DrawModifier é“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸º nullï¼Œè¯´æ˜è¿˜æœ‰ DrawModifierï¼Œä» DrawModifier é“¾è¡¨å¤´å¼€å§‹éå†è°ƒç”¨ DrawModifier å¤„ç†ç»˜åˆ¶ã€‚ æ¯”å¦‚ï¼š 1Box(Modifier.padding(10.dp).background(Color.Red).background(Color.Blue).size(120.dp)) å¯¹åº”çš„å†…éƒ¨ Modifier çš„ç»“æ„å¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­ï¼š 1234567891011ModifiedLayoutNode1( PaddingModifier, [null, null, null, null, null, null, null] ModifiedLayoutNode2( SizeModifier, [DrawModifier2 -&gt; DrawModifier1, null, null, null, null, null, null] innerLayoutNodeWrapper( [null, null, null, null, null, null, null] ) )) ç°åœ¨é’ˆå¯¹è¿™ä¸ªåœºæ™¯ï¼Œè¡¨å¤´æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹äº†ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œï¼š 1nextDrawEntity.draw(canvas) è·³è½¬ä¸€ä¸‹çœ‹çœ‹ï¼š 123456789101112fun draw(canvas: Canvas) { ... ... val drawScope = layoutNode.mDrawScope drawScope.draw(canvas, size, layoutNodeWrapper, this) { with(drawScope) { with(modifier) { draw() } } }} è¿™æ®µä»£ç ç†Ÿæ‚‰å—ï¼ŸDrawModifier2 ç»˜åˆ¶å®Œï¼Œè°ƒç”¨ drawContent()ï¼Œè®© DrawModifier1 å¼€å§‹ç»˜åˆ¶ã€‚ drawContent() æ˜¯é€šçŸ¥å½“å‰ DrawModifier ä¸‹ä¸€çº§çš„ LayoutNodeWrapper çš„ DrawModifier å¤„ç†ç»˜åˆ¶ã€‚æ‰€ä»¥å¦‚æœæœ‰ä¸€ä¸ª DrawModifier æ²¡æœ‰è°ƒç”¨ drawContent()ï¼Œç›¸å½“äºé“¾æ¡æ–­å¼€ä¸ä¼šé€šçŸ¥å†…éƒ¨çš„ DrawModifier å»ç»˜åˆ¶ã€‚","link":"/2024/09/18/Compose%20--%20Modifier%20--%2004.%20%E8%A7%A3%E6%9E%90%20DrawModifier/"},{"title":"è§£æ Modifier.layout()","text":"# å‰è¨€ä¼—æ‰€å‘¨çŸ¥ï¼šåŸç†æ€§åˆ†æçš„æ–‡ç« ï¼ŒçœŸçš„å¾ˆéš¾è®²çš„é€šä¿—æ˜“æ‡‚ï¼Œè®²çš„ç®€å•äº†å°±æ²¡å¿…è¦å†™äº†ï¼Œè®²çš„ç¹çæ‚ä¹±å¾€å¾€å¤§å®¶ä¹Ÿä¸ä¹æ„çœ‹ï¼Œæ‰€ä»¥åªèƒ½å°½é‡æ‰¾ä¸ªå¥½çš„è§’åº¦ï¼ˆæ¯”å¦‚ä» Demo ä»£ç ç¤ºä¾‹å‡ºå‘ï¼‰æ…¢æ…¢å¸¦ç€å¤§å®¶å»é’»æºç ï¼Œå¦‚æœç¡®å®èƒ½å¸®åŠ©åˆ°å¤§å®¶ç†è§£æ¸…æ¥šåŸç†ï¼Œé‚£å°±ç‚¹ä¸ªèµå‘—ï½ğŸ˜„ åœ¨æ­£å¼å¼€å§‹åˆ†æè¿™ç¯‡æ–‡ç« çš„ä¸»è§’ä¹‹å‰ï¼Œå»ºè®®ä½ å…ˆçœ‹çœ‹ ã€Modifierã€CombinedModifierã€‘ ä¸€æ–‡ï¼Œä½œä¸º Modifier åŸç†ç³»åˆ—çš„ç¬¬ä¸€ç¯‡å¼€å±±ä¹‹ä½œï¼Œå®ƒæ˜¯ä¸€ä¸ªæ ¹ï¼Œå¿…é¡»æŒæ¡ï¼ ä¸€ã€åœºæ™¯å¼•å…¥1.1 ä¸€ä¸ª Text()å…ˆæ¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„ä»£ç ç¤ºä¾‹ï¼š 123456789101112class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;) } } } }} è¿™æ®µä»£ç å¾ˆç®€å•ï¼Œæ•ˆæœå›¾å¦‚ä¸‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/68d94f6c5227491eac32b0ef9d816cab.png#pic_start =600x) æ¥ä¸‹æ¥åŸºäºè¿™ä¸ª Demoï¼Œæˆ‘ä»¬ä¼šæ…¢æ…¢å¼•å…¥æœ¬ç¯‡æ–‡ç« çš„ä¸»è§’ã€‚ 1.2 Modifier.layout()åœ¨ Compose ä¸­ Modifier.layout() æ˜¯ä¸€ç§å¸ƒå±€ä¿®é¥°ç¬¦ï¼Œå®ƒä¼šåŒ…è£¹ä¸€ä¸ªå¸ƒå±€èŠ‚ç‚¹ï¼šLayoutï¼ˆä»€ä¹ˆæ˜¯ LayoutNodeï¼Œä¸‹é¢ä¼šè®²ï¼‰ï¼Œé€šå¸¸ç”¨ä½œå¯¹ç›®æ ‡ç»„ä»¶ã€Œè¿›è¡Œæµ‹é‡ã€å’Œã€Œä½ç½®æ‘†æ”¾ã€çš„ã€‚ è¯´ç™½äº†å°±æ˜¯ä½ å¯ä»¥ç”¨ Modifier.layout() æ¥ã€Œè‡ªå®šä¹‰ç›®æ ‡ç»„ä»¶çš„æµ‹é‡è¿‡ç¨‹ã€ä»¥åŠã€Œå†³å®šç›®æ ‡ç»„ä»¶æ€ä¹ˆæ‘†æ”¾ã€ã€‚ ç°åœ¨æˆ‘ä»¬çœ‹çœ‹ä»£ç ä¸­æ€ä¹ˆç”¨ï¼Œé€šå¸¸ä¼šåƒä¸‹é¢è¿™æ ·å†™ï¼š 1234567891011121314class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;, Modifier.layout { measurable, constraints -&gt; } ) } } } }} å°±è¿™ä¹ˆç®€å•ï¼ŒText å°±æ˜¯ç›®æ ‡ç»„ä»¶ï¼Œæˆ‘ä»¬ç»™å®ƒåŠ äº†ä¸€ä¸ª Modifier.layout()ï¼Œæ²¡æœ‰æ·»åŠ ä»»ä½•å…¶ä»–ä»£ç é€»è¾‘ï¼Œ{ measurable, constraints -&gt; } æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ­¤æ—¶ä½ ä¼šå‘ç°åœ¨ Android Studio IDLE ä¸­ï¼Œè¿™æ ·å†™æ˜¯ä¼šæ ‡çº¢çš„ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/9455c71dd48447569e358a24f136931f.png =700x) æ­£å¸¸æ¥è¯´ï¼Œæˆ‘è¿™é‡Œä»€ä¹ˆä¹Ÿä¸å¡«ä¸å°±ç›¸å½“äºå¯¹ Text() ä¸åšä»»ä½•ä¿®é¥°ã€‚ä½†å¾ˆæ˜æ˜¾è¿™æ ·æ˜¯ä¸è¡Œçš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·å°è¯•è§£å†³è¿™ä¸ªæŠ¥é”™ã€‚ é¦–å…ˆæˆ‘ä»¬å‘ç°å½“ä½¿ç”¨ layout() ä¿®é¥°ç¬¦æ—¶ï¼Œä¼ å…¥çš„å›è°ƒ lambda åŒ…å«äº†ä¸¤ä¸ªå‚æ•°ï¼š measurableï¼šç”¨äºå­å…ƒç´ çš„æµ‹é‡å’Œä½ç½®æ”¾ç½®ï¼› constraintsï¼šç”¨äºçº¦æŸå­å…ƒç´  width å’Œ height çš„æœ€å¤§å€¼å’Œæœ€å°å€¼ã€‚ æˆ‘ä»¬å®šä½åˆ° Modifier.layout() çš„æºç ï¼š 12345ğŸ“„ androidx.compose.ui.layout --&gt; LayoutModifier.ktfun Modifier.layout( measure: MeasureScope.(Measurable, Constraints) -&gt; MeasureResult) = this then LayoutElement(measure) æ‰€ä»¥ï¼Œmeasurable å¯¹åº”çš„æ˜¯ Measurableï¼š 12345678910ğŸ“„ androidx.compose.ui.layout --&gt; Measurable.ktinterface Measurable : IntrinsicMeasurable { /** * Measures the layout with [constraints], returning a [Placeable] layout that has its new * size. A [Measurable] can only be measured once inside a layout pass. */ // è¿”å›ä¸€ä¸ª Placeableï¼Œå®ƒé‡Œé¢åŒ…å«ç›®æ ‡ç»„ä»¶çš„å®½ã€é«˜ç­‰ä¿¡æ¯ fun measure(constraints: Constraints): Placeable} æˆ‘ä»¬å‘ç° Measurable æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå†…éƒ¨ä»…æœ‰ä¸€ä¸ª measure() æ–¹æ³•ã€‚ æ‰€ä»¥ç°åœ¨å¯ä»¥å¼€å§‹ä¿®æ”¹åˆšæ‰çš„æŠ¥é”™äº†ï¼š 1234567891011121314151617class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;, Modifier.layout { measurable, constraints -&gt; // ç”¨ä¸€ä¸ªå˜é‡ä¿å­˜è¿”å›çš„ Placeable å¯¹è±¡ val placeable = measurable.measure(constraints) } ) } } } }} ç°åœ¨ä»£ç ä»ç„¶æ˜¯æ ‡çº¢æŠ¥é”™çš„ï¼ŒåŸå› åœ¨äºï¼šæˆ‘ä»¬åªå¤„ç†äº† measurableï¼Œå®ƒè¿”å›çš„æ˜¯ Placeableï¼Œè€Œ Modifier.layout() éœ€è¦è¿”å›çš„ç±»å‹æ˜¯ MeasureResultï¼š 123fun Modifier.layout( measure: MeasureScope.(Measurable, Constraints) -&gt; MeasureResult // éœ€è¦è¿”å› MeasureResult) = this then LayoutModifierElement(measure) æ‰€ä»¥ MeasureResult åˆæ˜¯ä»€ä¹ˆï¼Ÿ 12345678ğŸ“„ androidx.compose.ui.layout --&gt; MeasureResult.ktinterface MeasureResult { val width: Int val height: Int val alignmentLines: Map&lt;AlignmentLine, Int&gt; fun placeChildren()} MeasureResult ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒé‡Œé¢ä¹Ÿæœ‰ width å’Œ heightï¼Œç»§ç»­ä¿®å¤åˆšæ‰çš„æŠ¥é”™ï¼š 1234567891011121314151617181920212223242526class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Text(&quot;ComposeTest&quot;, Modifier.layout { measurable, constraints -&gt; val placeable = measurable.measure(constraints) object : MeasureResult { override val alignmentLines: Map&lt;AlignmentLine, Int&gt; get() = TODO(&quot;Not yet implemented&quot;) override val height: Int get() = TODO(&quot;Not yet implemented&quot;) override val width: Int get() = TODO(&quot;Not yet implemented&quot;) override fun placeChildren() { TODO(&quot;Not yet implemented&quot;) } } } ) } } }} æ—¢ç„¶ Modifier.layout() éœ€è¦ä¸€ä¸ª MeasureResult è¿”å›å¯¹è±¡ï¼Œé‚£æˆ‘ä»¬å°±åœ¨å†…éƒ¨ç»™å®ƒåˆ›å»ºä¸€ä¸ª MeasureResult å¯¹è±¡ï¼Œæ­¤æ—¶ IDLE å°±ä¸ä¼šå†æŠ¥é”™äº†ã€‚ å½“ç„¶æˆ‘ä»¬è¿˜éœ€è¦åšä¸€ä¸ªå·¥ä½œï¼Œé‚£å°±æ˜¯æŠŠ placeable çš„å®½é«˜ä¼ è¿› MeasureResult å†…éƒ¨ï¼Œæ‰€ä»¥æœ€ç»ˆçš„ä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;, Modifier.layout { measurable, constraints -&gt; val placeable = measurable.measure(constraints) object : MeasureResult { // æµ‹é‡åŸºå‡†çº¿ï¼Œæš‚æ—¶ä¸ç”¨å…³å¿ƒ override val alignmentLines: Map&lt;AlignmentLine, Int&gt; get() = TODO(&quot;Not yet implemented&quot;) // é«˜ï¼šplaceable.height override val height: Int get() = placeable.height // å®½ï¼šplaceable.width override val width: Int get() = placeable.width // æ‘†æ”¾å†…éƒ¨ç»„ä»¶ï¼Œæš‚æ—¶ä¸ç”¨å…³å¿ƒ override fun placeChildren() { TODO(&quot;Not yet implemented&quot;) } } } ) } } } }} è‡³æ­¤æŠ¥é”™å°±ä¿®å¤äº†ï¼Œä¸Šé¢çš„ä»£ç æ¼”ç¤ºäº†å¯¹ Text() æ·»åŠ  Modifier.layout() è¿›è¡Œä¿®é¥°ï¼ˆå½“ç„¶ä¸Šé¢çš„åšæ³•ç­‰åŒäºå•¥ä¹Ÿæ²¡åšï¼‰ã€‚ ä½†è¿™æ®µä»£ç æœ‰ä¸ªç¼ºé™·ï¼šå¦‚æœæ¯æ¬¡é€šè¿‡ Modifier.layout() å¯¹ç»„ä»¶ä¿®é¥°ï¼Œéƒ½å¾—åƒä¸Šé¢è¿™æ ·å†™ä¸€å †ä»£ç ï¼Œé‚£è¿˜ä¸å¾—ç–¯ï¼Ÿ 1.3 layout() å‡½æ•°å…¶å®åœ¨å®é™…å¼€å‘ä¸­æˆ‘ä»¬å¹¶ä¸ä¼šè¿™ä¹ˆå†™ï¼Œè€Œæ˜¯ä½¿ç”¨ Compose æä¾›ç»™æˆ‘ä»¬çš„ layout() å‡½æ•°ï¼š 1234567891011121314151617181920212223242526272829303132class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;, Modifier.layout { measurable, constraints -&gt; val placeable = measurable.measure(constraints) /*object : MeasureResult { override val alignmentLines: Map&lt;AlignmentLine, Int&gt; get() = TODO(&quot;Not yet implemented&quot;) override val height: Int get() = TODO(&quot;Not yet implemented&quot;) override val width: Int get() = TODO(&quot;Not yet implemented&quot;) override fun placeChildren() { TODO(&quot;Not yet implemented&quot;) } }*/ layout() { } } ) } } } }} æˆ‘ä»¬æ¥çœ‹ä¸‹ layout() æºç ï¼š 123456789101112131415161718192021222324ğŸ“„ androidx.compose.ui.layout --&gt; MeasureScope.ktinterface MeasureScope : IntrinsicMeasureScope { fun layout( width: Int, height: Int, alignmentLines: Map&lt;AlignmentLine, Int&gt; = emptyMap(), placementBlock: Placeable.PlacementScope.() -&gt; Unit ) = object : MeasureResult { // çœ‹è¿™é‡Œï¼Œè¿™æ˜¯ä¸ªå•¥ï¼Ÿç†Ÿæ‚‰å—ï¼Ÿ override val width = width override val height = height override val alignmentLines = alignmentLines override fun placeChildren() { Placeable.PlacementScope.executeWithRtlMirroringValues( width, layoutDirection, this@MeasureScope as? LookaheadCapablePlaceable, placementBlock ) } }} å¾ˆæ˜æ˜¾ layout() å‡½æ•°å¸®æˆ‘ä»¬åˆ›å»ºå¥½äº† MeasureResult å¯¹è±¡ï¼ŒåŒæ—¶å®ƒè¿˜å¸®æˆ‘ä»¬å¹²äº†å¦å¤–ä¸¤ä»¶æ²¡åšçš„äº‹ï¼š ç»™ alignmentLines è®¾å®šäº†é»˜è®¤å€¼ï¼› å®ç°äº† placeChildren()ã€‚ æ‰€ä»¥ï¼Œæˆ‘ä»¬ç°åœ¨åªéœ€è¦è¡¥å…¨ layout() å‡½æ•°å‰©ä½™çš„ä¸¤ä¸ªå‚æ•°ï¼šwidth å’Œ heightã€‚ 12345678910111213141516171819class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;, Modifier.layout { measurable, constraints -&gt; val placeable = measurable.measure(constraints) layout(placeable.width, placeable.height) { } } ) } } } }} è¿™æ ·å†™ä»£ç æ˜¯ä¸æ˜¯ç¬é—´æ„Ÿè§‰æ¸…çˆ½äº†å¾ˆå¤šï¼Ÿä½†å·¥ä½œåˆ°è¿™è¾¹è¿˜æ²¡æœ‰ç»“æŸï¼Œlayout() å‡½æ•°è¿˜æœ‰ç¬¬å››ä¸ªå‚æ•°ï¼Œæ˜¯ä¸€ä¸ª Lambda è¡¨è¾¾å¼ï¼Œä¸»è¦å·¥ä½œæ˜¯å¤„ç†è¢«ä¿®é¥°ç»„ä»¶çš„æ‘†æ”¾è§„åˆ™ï¼Œæ¯”å¦‚åç§»é‡ã€‚ 12345678fun layout( width: Int, height: Int, alignmentLines: Map&lt;AlignmentLine, Int&gt; = emptyMap(), placementBlock: Placeable.PlacementScope.() -&gt; Unit // Lambda è¡¨è¾¾å¼) = object : MeasureResult { ... ...} æˆ‘ä»¬ç»§ç»­å®Œå–„ï¼š 1234567891011121314151617181920class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;, Modifier.layout { measurable, constraints -&gt; val placeable = measurable.measure(constraints) layout(placeable.width, placeable.height) { // ä¸åšä»»ä½•åç§» placeable.placeRelative(0, 0) } } ) } } } }} ç°åœ¨æ‰€æœ‰å·¥ä½œï¼ˆæµ‹é‡ + æ‘†æ”¾ï¼‰éƒ½å·²å®Œæˆï¼Œè¿è¡Œçœ‹ä¸‹æ•ˆæœï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/a89d5d8827d64381b418f6ac72ec6f6b.png#pic_start =600x) å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬è™½ç„¶ç”¨ Modifier.layout() å¯¹ Text åšä¿®é¥°ï¼Œä½†å¹¶æ²¡æœ‰å¯¹å®ƒåšä»»ä½•å°ºå¯¸ä¿®æ”¹å’Œä½ç½®åç§»ã€‚ é‚£å¦‚æœæˆ‘ç°åœ¨æƒ³ä¿®æ”¹ Text() çš„å°ºå¯¸ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ 12345678910111213141516171819class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;, Modifier.layout { measurable, constraints -&gt; val placeable = measurable.measure(constraints) val size = min(placeable.width, placeable.height) layout(size, size) { placeable.placeRelative(0, 0) } }) } } } }} æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª size å˜é‡ï¼Œé€šè¿‡ min() å‡½æ•°è·å–å®½é«˜æœ€å°å€¼ï¼Œç„¶åé‡æ–°ä¼ å…¥ layout() é‡Œé¢ï¼Œè¿™æ ·å°±ä¼šè·å¾—ä¸€ä¸ªæ­£æ–¹å½¢çš„æ•ˆæœã€‚ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/044b065522a74d3fa8904fb497920133.png#pic_start =600x)) å°ºå¯¸ä¿®æ”¹ç¡®å®ç”Ÿæ•ˆäº†ï¼Œæ¥ä¸‹æ¥å†å¢åŠ ä¸€ä¸ªåç§»ï¼š 12345678910111213141516171819class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;, Modifier.layout { measurable, constraints -&gt; val placeable = measurable.measure(constraints) val size = min(placeable.width, placeable.height) layout(size, size) { placeable.placeRelative(30, 0) } }) } } } }} çœ‹ä¸‹æ•ˆæœï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/3146c6fbeaf24bd9803b11f749948732.png#pic_start =600x) å¦å¤–æœ‰ä¸ªç»†èŠ‚éœ€è¦è¯´æ˜ä¸‹ï¼Œé™¤äº†ä½¿ç”¨ placeRelative å¯¹ç»„ä»¶åç§»å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ place è¿›è¡Œåç§»æ“ä½œï¼Œä¸¤è€…çš„åŒºåˆ«å°±æ˜¯ placeRelative ä¼šè‡ªé€‚åº” RTL å¸ƒå±€ã€‚ è®²åˆ°è¿™é‡Œï¼ŒModifier.layout() ä¿®é¥°ç¬¦å’Œ layout() å‡½æ•°çš„ç”¨æ³•ä½ åº”è¯¥éƒ½æ¸…æ¥šäº†ï¼Œä½†è¿˜æ²¡ç»“æŸï¼Œå‰é¢æˆ‘ä»¬ä¸€ç›´å¿½ç•¥äº†ä¸€ä¸ªå‚æ•°ï¼šconstraintsï¼Œå®ƒæ˜¯ä»€ä¹ˆï¼Ÿ measurableï¼šç”¨äºå­å…ƒç´ çš„æµ‹é‡å’Œä½ç½®æ”¾ç½®çš„ï¼› constraintsï¼šç”¨äºçº¦æŸå­å…ƒç´  width å’Œ height çš„æœ€å¤§å€¼å’Œæœ€å°å€¼ã€‚ å‰é¢çš„ä¾‹å­å¹¶æ²¡æœ‰å¯¹ constraints åšä»»ä½•ä¿®æ”¹ï¼Œåœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦é€šè¿‡ constraints å¯¹ç»„ä»¶è¿›è¡Œé™åˆ¶ã€‚ æ¯”å¦‚æˆ‘æƒ³å¯¹ Text() ç»„ä»¶è¿›è¡Œä¸€ä¸ªé™åˆ¶ï¼Œç±»ä¼¼ padding çš„æ•ˆæœï¼Œç»™å®ƒåŠ ä¸€ä¸ª 10dp çš„æœ€å¤§å®½é«˜çš„é™åˆ¶ï¼ˆæœ€å¤§å®½é«˜ç¼©å‡ 10dpï¼‰ã€‚ 12345678910111213141516171819202122class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;, Modifier.layout { measurable, constraints -&gt; val paddingPx = 10.dp.roundToPx() val placeable = measurable.measure(constraints.copy( maxWidth = constraints.maxWidth - paddingPx * 2, maxHeight = constraints.maxHeight - paddingPx * 2 )) layout(placeable.width + paddingPx * 2, placeable.height + paddingPx * 2) { placeable.placeRelative(paddingPx, paddingPx) } }) } } } }} çœ‹ä¸‹æ•ˆæœï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/0ab95beca0c2423eb67f8a3ed7a234c5.png#pic_start =600x) å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬å®ç°çš„æ•ˆæœè·Ÿ Modifier.padding(10.dp) çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœä½ å»çœ‹çœ‹ Modifier.padding çš„æºç ï¼Œå°±ä¼šå‘ç°å®ƒçš„å†…éƒ¨åŸç†è·Ÿæˆ‘ä»¬ä¾‹å­æ˜¯ä¸€æ ·çš„ã€‚ 123456789@Stablefun Modifier.padding( horizontal: Dp = 0.dp, vertical: Dp = 0.dp) = this.then( PaddingModifier( ... ... )) 1234567891011121314151617181920212223242526272829303132private class PaddingModifier( val start: Dp = 0.dp, val top: Dp = 0.dp, val end: Dp = 0.dp, val bottom: Dp = 0.dp, val rtlAware: Boolean, inspectorInfo: InspectorInfo.() -&gt; Unit) : LayoutModifier, InspectorValueInfo(inspectorInfo) { ... ... override fun MeasureScope.measure( measurable: Measurable, constraints: Constraints ): MeasureResult { val horizontal = start.roundToPx() + end.roundToPx() val vertical = top.roundToPx() + bottom.roundToPx() val placeable = measurable.measure(constraints.offset(-horizontal, -vertical)) val width = constraints.constrainWidth(placeable.width + horizontal) val height = constraints.constrainHeight(placeable.height + vertical) return layout(width, height) { if (rtlAware) { placeable.placeRelative(start.roundToPx(), top.roundToPx()) } else { placeable.place(start.roundToPx(), top.roundToPx()) } } } ... ...} äºŒã€LayoutNode æµ…æ é€šè¿‡å‰é¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š ä¸è®ºæ˜¯ä½¿ç”¨ Modifier.layout() ä¿®é¥°ç¬¦è¿˜æ˜¯ä½¿ç”¨ Compose æä¾›ç»™æˆ‘ä»¬çš„ç°æˆçš„ä¿®é¥°ç¬¦ï¼Œæ¯”å¦‚ï¼šModifier.padding() / Modifier.size()ï¼Œå®ƒä»¬éƒ½ä¼šå¯¹è¢«ä¿®é¥°ç»„ä»¶äº§ç”Ÿç²¾ç»†å½±å“ï¼ˆç»„ä»¶å¤§å°ã€ä½ç½®åç§»ï¼‰ã€‚ ä½†åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä»…ä»…æ˜¯ä» UI æ•ˆæœä¸Šçœ‹åˆ° Modifier.layout() ä¼šå½±å“è¢«ä¿®é¥°ç»„ä»¶ï¼Œä½†æºç åº•å±‚æ˜¯å¦‚ä½•äº§ç”Ÿå½±å“çš„å‘¢ï¼Ÿ è¿™æ‰æ˜¯æˆ‘ä»¬è¿™ç¯‡æ–‡ç« çš„æ ¸å¿ƒä»·å€¼ï¼æ‰€ä»¥ï¼Œæœ€ç¡¬æ ¸çš„åŸç†éƒ¨åˆ†æ¥äº†ï¼ æˆ‘ä»¬å°±æ‹¿å¸¸ç”¨çš„ Modifier.padding() åˆ†æï¼Œæ¥çœ‹ä¸‹å®ƒçš„æºç  123456789101112131415161718192021222324252627282930313233ğŸ“„ androidx.compose.foundation.layout --&gt; Padding.kt@Stablefun Modifier.padding( start: Dp = 0.dp, top: Dp = 0.dp, end: Dp = 0.dp, bottom: Dp = 0.dp) = this then PaddingElement( start = start, top = top, end = end, bottom = bottom, rtlAware = true, inspectorInfo = { name = &quot;padding&quot; properties[&quot;start&quot;] = start properties[&quot;top&quot;] = top properties[&quot;end&quot;] = end properties[&quot;bottom&quot;] = bottom })private class PaddingElement( var start: Dp = 0.dp, var top: Dp = 0.dp, var end: Dp = 0.dp, var bottom: Dp = 0.dp, var rtlAware: Boolean, val inspectorInfo: InspectorInfo.() -&gt; Unit) : ModifierNodeElement&lt;PaddingNode&gt;() {abstract class ModifierNodeElement&lt;N : Modifier.Node&gt; : Modifier.Element, InspectableValue { è¿™é‡Œæœ‰é—®é¢˜ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼å±‚çº§å…³ç³»éå¸¸æ¸…æ™°ï¼šModifier.padding() è°ƒç”¨ä¸€ä¸ª PaddingElement å¯¹è±¡ï¼Œè€Œ PaddingElement å®ç°äº† ModifierNodeElement ç±»ï¼ˆè¿™æ˜¯ä¸ªèŒƒå‹ç±»ï¼Œå…¶ä¸­åŒ…å«äº† PaddingNodeï¼‰ï¼ŒModifierNodeElement åˆç»§æ‰¿äº† Modifier.Element æ¥å£ã€‚ è¿™ä¸ª LayoutModifier ä¼šè¢« Compose ç”¨äºä¿®æ”¹æµ‹é‡å’Œå¸ƒå±€è¿‡ç¨‹ï¼Œä»è€Œæœ€ç»ˆå½±å“åˆ°ç•Œé¢å…ƒç´ çš„ä½ç½®å’Œå°ºå¯¸ã€‚ æ‰€ä»¥æˆ‘ä»¬çš„é‡ç‚¹å°±æ˜¯è¦ç ”ç©¶ LayoutModifier æ˜¯å¦‚ä½•å½±å“ç»„ä»¶çš„ï¼ ä½†æ˜¯ï¼åœ¨åˆ†æ LayoutModifier åŸç†ä¹‹å‰ï¼Œæœ‰ä¸€ä¸ªæ ¸å¿ƒçŸ¥è¯†ç‚¹æ˜¯å¿…é¡»è¦æå‰äº†è§£çš„ã€‚ è¿™æ®µä»£ç æˆ‘ä»¬å†ç†Ÿæ‚‰ä¸è¿‡äº†å§ï¼š 123456789101112class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;) } } } }} Box ã€Text è¿™äº›å‡½æ•°åœ¨å®é™…è¿è¡Œçš„æ—¶å€™ï¼Œå…¶å®å¹¶ä¸æ˜¯è¿™äº›å‡½æ•°ç›´æ¥å­˜åœ¨äºå†…å­˜é‡Œé¢ï¼Œè€Œæ˜¯ Compose åˆ©ç”¨è¿™äº›å‡½æ•°åˆ›é€ å‡ºçš„ä¸€äº›å¯¹è±¡å­˜åœ¨äºå†…å­˜é‡Œé¢ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯ï¼šLayoutNodeï¼Œå®ƒæ‰æ˜¯æœ€åº•å±‚çš„é‚£ä¸ªèŠ‚ç‚¹ï¼Œè¿›è¡Œå®é™…çš„ã€Œ æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶ã€è§¦æ‘¸åé¦ˆ ã€ç­‰å·¥ä½œï¼Œä½ å¯ä»¥æŸ¥çœ‹ ã€Compose æ˜¯å¦‚ä½•å°†æ•°æ®è½¬æ¢æˆ UI çš„ï¼Ÿã€‘è¿™ç¯‡æ–‡ç« ï¼Œäº†è§£è½¬æ¢çš„æ€ç»´æ¨¡å‹ï¼ æˆ‘ä»¬æ—¢ç„¶æƒ³çŸ¥é“ LayoutModifier æ˜¯å¦‚ä½•ç²¾ç»†å½±å“ Text() ç»„ä»¶ï¼Œé‚£å°±å¾—å…ˆç ”ç©¶æ˜ç™½ Text() è‡ªå·±çš„æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶çš„åŸç†ï¼Œå› ä¸º LayoutModifier æ˜¯åŒ…ç€è¿™ä¸ª Text() çš„ã€‚ åœ¨ LayoutNode ä¸­ï¼Œæµ‹é‡å’Œå¸ƒå±€æ˜¯ç”± remeasure() å‡½æ•°å’Œ replace() ä¸¤ä¸ªå‡½æ•°å¤„ç†ã€‚ 123456ğŸ“„ androidx.compose.ui.node --&gt; LayoutNode.ktinternal class LayoutNode(..) { internal fun replace() // å¸ƒå±€ internal fun remeasure() // æµ‹é‡} 2.1 LayoutNode.remeasure()æˆ‘ä»¬å…ˆæ¥åˆ†æ remeasure() å‡½æ•°ï¼š 12345678910111213141516171819ğŸ“„ androidx.compose.ui.node --&gt; LayoutNode.ktinternal class LayoutNode(..) { internal fun remeasure( constraints: Constraints? = layoutDelegate.lastConstraints ): Boolean { return if (constraints != null) { if (intrinsicsUsageByParent == UsageByParent.NotUsed) { clearSubtreeIntrinsicsUsage() } // æµ‹é‡å·¥ä½œäº¤ç»™ LayoutNodeLayoutDelegate çš„å†…éƒ¨ç±» MeasurePassDelegate å¤„ç† measurePassDelegate.remeasure(constraints) } else { false } }} 2.2 MeasurePassDelegate.measurePassDelegate()LayoutNode å†…éƒ¨è¦å¤„ç†çš„äº‹æƒ…éå¸¸å¤šï¼Œå®ƒæŠŠæµ‹é‡çš„å·¥ä½œäº¤ç»™äº† MeasurePassDelegate æ¥å¤„ç†ã€‚ 123456789101112131415161718192021ğŸ“„ androidx.compose.ui.node --&gt; LayoutNodeLayoutDelegate.ktinternal class LayoutNodeLayoutDelegate( private val layoutNode: LayoutNode) { inner class MeasurePassDelegate : Measurable, Placeable(), AlignmentLinesOwner { fun remeasure(constraints: Constraints): Boolean { ... if (layoutNode.measurePending || measurementConstraints != constraints) { ... performMeasure(constraints) // å…³é”®ä»£ç  ... } return false } }} è¿™æ®µä»£ç å¾ˆé•¿ï¼Œä½†æˆ‘ä»¬åªéœ€è¦å…³æ³¨ä¸€è¡Œå…³é”®ä»£ç ï¼šperformMeasure(constraints)ã€‚ 2.3 LayoutNodeLayoutDelegate.performMeasure()1234567891011121314151617181920212223ğŸ“„ androidx.compose.ui.node --&gt; LayoutNodeLayoutDelegate.ktinternal class LayoutNodeLayoutDelegate( private val layoutNode: LayoutNode) { private fun performMeasure(constraints: Constraints) { ... layoutNode.requireOwner().snapshotObserver.observeMeasureSnapshotReads( layoutNode, affectsLookahead = false, performMeasureBlock // å…³é”®ä»£ç  ) ... } private var performMeasureConstraints = Constraints() private val performMeasureBlock: () -&gt; Unit = { outerCoordinator.measure(performMeasureConstraints) }} æˆ‘ä»¬ä»ç„¶åªéœ€è¦å…³æ³¨ï¼šouterCoordinator.measure(performMeasureConstraints)ï¼Œå®ƒæ˜¯åšå®é™…æµ‹é‡å·¥ä½œçš„ã€‚ 2.4 Measurable.measure()ç»§ç»­è·Ÿè¸ªï¼š 123456789ğŸ“„ androidx.compose.ui.layout --&gt; Measurable.ktinterface Measurable : IntrinsicMeasurable { /** * Measures the layout with [constraints], returning a [Placeable] layout that has its new * size. A [Measurable] can only be measured once inside a layout pass. */ fun measure(constraints: Constraints): Placeable} What ï¼Ÿï¼Ÿï¼Ÿæ€ä¹ˆæ˜¯ä¸ªæ¥å£å•Šï¼Œæ²¡æœ‰ä»»ä½•å¤„ç†é€»è¾‘å•Šï¼ï¼ï¼ è½¬å¿µä¸€æƒ³ï¼Œæ—¢ç„¶æ˜¯ä¸ªæ¥å£ï¼Œé‚£è‚¯å®šæœ‰å…¶ä»–åœ°æ–¹å®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æœä¸€ä¸‹å“ªäº›åœ°æ–¹å®ç°äº†ã€‚ æœ‰ä¸‰ä¸ªåœ°æ–¹å®ç°äº†ï¼Œä½†å“ªä¸€ä¸ªæ‰æ˜¯æˆ‘ä»¬éœ€è¦çš„å‘¢ï¼Ÿåˆ«æ…Œï¼Œæˆ‘å¸¦ä½ æ‰¾ä¸€ä¸‹ã€‚ æˆ‘ä»¬å¾€å›é€€ï¼Œæ‰¾æ‰¾åˆšæ‰å“ªé‡Œè°ƒç”¨ measure() æ–¹æ³•çš„ï¼Ÿ 1234567891011121314151617181920ğŸ“„ androidx.compose.ui.node --&gt; LayoutNodeLayoutDelegate.ktinternal class LayoutNodeLayoutDelegate( private val layoutNode: LayoutNode) { /** * 2. outerCoordinator ç”±ä¼ è¿›æ¥çš„ layoutNode å‚æ•°å†³å®šï¼Œé‚£ä¹ˆæˆ‘ä»¬å¾—æ‰¾æ‰¾ layoutNode æ˜¯å“ªé‡Œä¼ è¿›æ¥çš„ * è¿™é‡Œè®°ä½ï¼š * a. æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆæ‰¾åˆ°å“ªé‡Œä¼ å…¥äº† layoutNode * b. æ‰¾åˆ°åæˆ‘ä»¬å†çœ‹ layoutNode.nodes.outerCoordinator æ˜¯ä»€ä¹ˆï¼Ÿ */ val outerCoordinator: NodeCoordinator get() = layoutNode.nodes.outerCoordinator private val performMeasureBlock: () -&gt; Unit = { // 1. è¿™é‡Œè°ƒç”¨äº† measure()ï¼Œé‚£ä¹ˆ outerCoordinator æ˜¯ä»€ä¹ˆï¼Ÿ outerCoordinator.measure(performMeasureConstraints) }} ç»§ç»­å›é€€åˆ°ä¸Šä¸€å±‚ï¼š 1234567891011121314151617181920212223ğŸ“„ androidx.compose.ui.node --&gt; LayoutNodeLayoutDelegate.ktinternal class LayoutNodeLayoutDelegate( private val layoutNode: LayoutNode) { inner class MeasurePassDelegate : Measurable, Placeable(), AlignmentLinesOwner { // 2. æˆ‘ä»¬ç»§ç»­å›é€€ fun remeasure(constraints: Constraints): Boolean { ... if (layoutNode.measurePending || measurementConstraints != constraints) { ... // 1. æ²¡æœ‰åœ°æ–¹ä¼ å…¥ layoutNode å•Š performMeasure(constraints) ... } return false } }} ç»§ç»­å›é€€åˆ°ä¸Šä¸€å±‚ï¼š 12345678910111213141516171819202122232425262728293031323334353637ğŸ“„ androidx.compose.ui.node --&gt; LayoutNode.ktinternal class LayoutNode(..) { // 2. é€šè¿‡ layoutDelegate è·å– measurePassDelegateï¼Œé‚£ layoutDelegate æ˜¯ä»€ä¹ˆï¼Ÿ internal val measurePassDelegate get() = layoutDelegate.measurePassDelegate ... // 4. æ¥æ¥æ¥ï¼Œnodes åœ¨è¿™é‡Œï¼ŒNodeChain åˆæ˜¯ä»€ä¹ˆï¼Ÿ internal val nodes = NodeChain(this) /** * 3. LayoutNodeLayoutDelegate(this) çœ‹åˆ°è¿™è¡Œä»£ç ä½ æœ‰æ²¡æœ‰æƒ³èµ·æ¥ä»€ä¹ˆï¼Ÿ * è¿™ä¸ª this ä¸å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„é‚£ä¸ª layoutNode å‚æ•°å˜›ï¼ * ç°åœ¨æˆ‘ä»¬å†çœ‹ä¸‹åˆšåˆšç”¨åˆ°è¿™ä¸ªå‚æ•°çš„åœ°æ–¹ï¼š * * val outerCoordinator: NodeCoordinator * get() = layoutNode.nodes.outerCoordinator * * è¿˜è®°å¾—å§ï¼Ÿç°åœ¨ layoutNode æ‰¾åˆ°äº†ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹ nodes æ˜¯ä»€ä¹ˆï¼Ÿ */ internal val layoutDelegate = LayoutNodeLayoutDelegate(this) internal fun remeasure( constraints: Constraints? = layoutDelegate.lastConstraints ): Boolean { return if (constraints != null) { ... // 1. è¿˜æ˜¯æ²¡æœ‰åœ°æ–¹ä¼ å…¥ layoutNode å•Šï¼Œåˆ«æ€¥ï¼Œæˆ‘ä»¬çœ‹çœ‹ measurePassDelegate æ˜¯ä»€ä¹ˆï¼Ÿ measurePassDelegate.remeasure(constraints) } else { false } }} 2.5 NodeChainå…„å¼Ÿï¼é¡¶ä½ï¼æˆ‘ä»¬å†æ¥çœ‹çœ‹ NodeChain æ˜¯ä»€ä¹ˆï¼Ÿ 123456789101112131415161718192021ğŸ“„ androidx.compose.ui.node --&gt; NodeChain.ktinternal class NodeChain(val layoutNode: LayoutNode) { /** * 2. å†çœ‹è¿™é‡Œï¼Œè€Œ innerCoordinator åˆæ˜¯ InnerNodeCoordinatorï¼ */ internal val innerCoordinator = InnerNodeCoordinator(layoutNode) /** * ä¸å¿˜åˆå¿ƒï¼Œå†æ¬¡æ¬å‡ºä»£ç ï¼š * * val outerCoordinator: NodeCoordinator * get() = layoutNode.nodes.outerCoordinator * * 1. å“¦ï¼ŒåŸæ¥å¦‚æ­¤ï¼š * layoutNode.nodes.outerCoordinator æ˜¯ innerCoordinator */ internal var outerCoordinator: NodeCoordinator = innerCoordinator private set ... ...} ä»£ç è·Ÿè¸ªåˆ°è¿™é‡Œå°±çœŸç›¸æ˜¾ç°äº†ï¼Œåˆ°åº•æ˜¯å“ªä¸ªå®ç°ç±»å¤„ç†äº† measure() æ–¹æ³•ï¼Œä½ ç°åœ¨æ¸…æ¥šäº†å§ï¼Ÿå†æ¥çœ‹ä¸‹åˆšåˆšçš„æˆªå›¾ï¼š 2.6 InnerNodeCoordinator.measure()æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹ InnerNodeCoordinator æ˜¯å¦‚ä½•è´Ÿè´£å…·ä½“æµ‹é‡çš„ï¼š 123456789101112131415161718192021ğŸ“„ androidx.compose.ui.node --&gt; InnerNodeCoordinator.ktinternal class InnerNodeCoordinator( layoutNode: LayoutNode) : NodeCoordinator(layoutNode) { override fun measure(constraints: Constraints): Placeable = performingMeasure(constraints) { layoutNode.forEachChild { it.measuredByParent = LayoutNode.UsageByParent.NotUsed } // 2. è¿”å›ä¸€ä¸ª MeasureResult å¯¹è±¡ç»™ replace() å»å¸ƒå±€ measureResult = with(layoutNode.measurePolicy) { // 1. æœ€æ ¸å¿ƒå¤„ï¼šè¿™è¾¹å°±æ˜¯æœ€åº•å±‚å¼€å§‹æµ‹é‡çš„å·¥ä½œäº† measure(layoutNode.childMeasurables, constraints) } onMeasured() return this }} åˆ†æåˆ°è¿™é‡Œï¼Œå…³äºç»„ä»¶è‡ªèº«çš„æµ‹é‡å’Œå¸ƒå±€æµç¨‹å°±è·‘é€šäº†ï¼š æˆ‘ä»¬åœ¨ä»£ç ä¸­æ‰€å†™çš„ Boxã€Text ç­‰ç»„ä»¶å†…éƒ¨ä¼šæœ‰è‡ªå·±è®¾å®šçš„æµ‹é‡æ•°æ®ï¼Œä»–ä»¬åœ¨ä»£ç å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ä¼šè¢« Comopse è½¬æ¢æˆ LayoutNode èŠ‚ç‚¹ï¼ˆåŒ…å«æ‰€æœ‰ç»„ä»¶è‡ªèº«çš„æµ‹é‡æ•°æ®ï¼‰ï¼Œç„¶åä¸€å±‚å±‚å¾€ä¸‹ä¼ ï¼Œæœ€ç»ˆä¼ åˆ° InnerNodeCoordinatorï¼Œç”±å®ƒè¿›è¡Œæœ€åº•å±‚çš„æµ‹é‡å·¥ä½œï¼Œæµ‹é‡å®Œæˆåä¼šè¿”å›ä¸€ä¸ª MeasureResult å¯¹è±¡å†äº¤ç»™ replace() å‡½æ•°å®Œæˆå¸ƒå±€å·¥ä½œã€‚ æ‰€ä»¥ï¼ŒDo you understand? ä¸‰ã€LayoutModifer çš„å·¥ä½œåŸç† å‰é¢æˆ‘ä»¬å·²ç»äº†è§£äº†ç»„ä»¶è‡ªèº«çš„æµ‹é‡å’Œå¸ƒå±€åŸç†ï¼Œç°åœ¨å°±å¯ä»¥å¼€å§‹åˆ†æ LayoutModifer æ˜¯å¦‚ä½•å½±å“ç»„ä»¶çš„æµ‹é‡å’Œå¸ƒå±€äº†ã€‚ å°±åƒæˆ‘ä»¬å‰é¢è¯´çš„é‚£æ ·ï¼Œæ‰€æœ‰ç»„ä»¶æœ€ç»ˆéƒ½ä¼šè¢«è½¬æ¢ä¸ºä¸€ä¸ª LayoutNodeï¼Œè¿™ä¸ª LayoutNode åŒ…å«äº†æ‰€æœ‰çš„æµ‹é‡æ•°æ®ï¼Œé‚£åŒæ ·å®ƒä¹Ÿä¼šåŒ…å«ä½ å¯¹ç»„ä»¶è®¾å®šçš„ Modifierï¼Œæ‰€ä»¥æœ€ç»ˆç»è¿‡ä¸€äº›åˆ—è½¬æ¢ï¼Œä¹Ÿä¼šä¼ åˆ° LayoutNode é‡Œé¢ï¼Œè€Œ LayoutNode é‡Œé¢ä¹Ÿæœ‰ä¸€ä¸ª modifier å˜é‡ï¼Œå­˜å‚¨çš„å°±æ˜¯ä¿®é¥° Composable å‡½æ•°çš„ Modifierã€‚ 3.1 LayoutNode.Modiferç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“çš„ä»£ç é€»è¾‘ï¼š 123456789101112// ğŸ“„ androidx.compose.ui.node --&gt; LayoutNode.ktinternal class LayoutNode(..) { override var modifier: Modifier = Modifier // å¦‚æœæœ‰æ–°å€¼å˜åŒ– set(value) { ... nodes.updateFrom(value) // å…³é”®ä»£ç  ... }} è¿™é‡Œçš„ nodes åº”è¯¥ä¸é™Œç”Ÿäº†å§ï¼Ÿå‰ä¸€èŠ‚æˆ‘ä»¬å·²ç»çŸ¥é“äº†å®ƒæ˜¯ NodeChain å¯¹è±¡ã€‚ 1internal val nodes = NodeChain(this) ä½†æ˜¯ NodeChain æ˜¯ä»€ä¹ˆï¼Ÿå…¶å®å®ƒå°±æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè€Œä¸”æ˜¯ä¸ªåŒå‘é“¾è¡¨ã€‚ 1234567891011ğŸ“„ androidx.compose.ui.node --&gt; NodeChain.ktinternal class NodeChain(val layoutNode: LayoutNode) { internal val innerCoordinator = InnerNodeCoordinator(layoutNode) internal var outerCoordinator: NodeCoordinator = innerCoordinator private set internal val tail: Modifier.Node = innerCoordinator.tail internal var head: Modifier.Node = tail private set ...} å¤´ã€å°¾èŠ‚ç‚¹éƒ½æ˜¯ Modifier.Node ç±»å‹ï¼å…¶ä¸­çš„ NodeCoordinator æ˜¯ç”¨æ¥è¾…åŠ© Node èŠ‚ç‚¹å¤„ç†æµ‹é‡å’Œå¸ƒå±€çš„ï¼Œå…¶ä¸­åŒ…å« measure å’Œ placeAt çš„å‡½æ•°é€»è¾‘ã€‚NodeChain é“¾è¡¨ä¸Šçš„æ¯ä¸€ä¸ª Node éƒ½ä¼šå¯¹åº”çš„ç»‘å®šä¸€ä¸ª NodeCoordinator å¯¹è±¡æ¥è¾…åŠ©å¤„ç†ã€‚ï¼ˆä¸ç†è§£æ²¡å…³ç³»ï¼Œæ¥ç€å¾€ä¸‹çœ‹ï¼ï¼‰ 3.2 updateFrom()æ¥ä¸‹æ¥çœ‹çœ‹ updateFrom çš„å…·ä½“å·¥ä½œï¼Œå®ƒä¸»è¦è´Ÿè´£ NodeChain é“¾è¡¨çš„æ›´æ–°ï¼Œæ¯å½“æœ‰ Modifier å¯¹è±¡è¢«è®¾ç½®åˆ° LayoutNode ä¸Šé¢ï¼Œéƒ½ä¼šè°ƒç”¨ updateFrom å‡½æ•°è¿›è¡Œæ›´æ–°å¯¹åº”çš„ NodeChainã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465ğŸ“„ androidx.compose.ui.node --&gt; NodeChain.ktinternal class NodeChain(val layoutNode: LayoutNode) { // è´Ÿè´£æœ€å†…å±‚æµ‹é‡çš„ NodeCoordinator internal val innerCoordinator = InnerNodeCoordinator(layoutNode) // è´Ÿè´£å¤–å±‚æµ‹é‡çš„ NodeCoordinatorï¼Œåˆå§‹å€¼æ˜¯ InnerNodeCoordinator internal var outerCoordinator: NodeCoordinator = innerCoordinator private set // åŒå‘é“¾è¡¨çš„å°¾èŠ‚ç‚¹ internal val tail: Modifier.Node = innerCoordinator.tail // åŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹ internal var head: Modifier.Node = tail private set ... internal fun updateFrom(m: Modifier) { var coordinatorSyncNeeded = false val paddedHead = padChain() var before = current val beforeSize = before?.size ?: 0 /** * ğŸ“ æ ¸å¿ƒä»£ç  1: * fillVector ä¼šå°† Modifier å±•å¼€é“ºå¹³åˆ°ä¸€ä¸ªæ•°ç»„ï¼Œ * åé¢çš„ä»£ç å°±å¯ä»¥ç”¨è¿™ä¸ªæ•°ç»„éå† */ val after = m.fillVector(buffer ?: mutableVectorOf()) var i = 0 // æ£€æŸ¥æ›´æ–°å·®å¼‚ if (after.size == beforeSize) { ... // è¿™æ®µä»£ç ä¸ç”¨çœ‹ï¼Œåªè¦åŠ äº† Modifier.xx é»˜è®¤ä¸ä¼šèµ°åˆ°è¿™è¾¹ } else if (!layoutNode.isAttached &amp;&amp; beforeSize == 0) { // ç¬¬ä¸€æ¬¡ç»„è£… Modifier.Node åŒå‘é“¾è¡¨ coordinatorSyncNeeded = true var node = paddedHead while (i &lt; after.size) { val next = after[i] val parent = node /** * ğŸ“ æ ¸å¿ƒä»£ç  2: ç»„è£…åŒå‘é“¾è¡¨çš„å…·ä½“é€»è¾‘ */ node = createAndInsertNodeAsChild(next, parent) logger?.nodeInserted(0, i, next, parent, node) i++ } syncAggregateChildKindSet() } else if (after.size == 0) { // åˆ é™¤æ‰€æœ‰ modifier ... } else { ... } current = after buffer = before?.also { it.clear() } /** * ğŸ“ æ ¸å¿ƒä»£ç  3: æ›´æ–°å¤´èŠ‚ç‚¹ */ head = trimChain(paddedHead) if (coordinatorSyncNeeded) { /** * ğŸ“ æ ¸å¿ƒä»£ç  4: å…³è” Modifier.Node å’Œ NodeCoordinator */ syncCoordinators() } }} æ¥ä¸‹æ¥è·Ÿç€æˆ‘æ·±å…¥åˆ†ææ¯ä¸€è¡Œæ ¸å¿ƒä»£ç ï¼å¸Œæœ›ä½ èƒ½æ²‰ä¸‹å¿ƒçœ‹ä¸‹å»ï¼ŒåŒ…æ•™åŒ…ä¼šï¼ ğŸ“ åˆ†è§£ Modifierå…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªæ ¸å¿ƒä»£ç ï¼š 1val after = m.fillVector(buffer ?: mutableVectorOf()) m å°±æ˜¯ä½ çš„ Modifier é“¾ï¼Œè¿™é‡Œçš„ buffer é»˜è®¤ä¸º nullï¼ŒmutableVectorOf() å…¶å®è·Ÿ buffer ä¸€æ ·éƒ½æ˜¯ä¸€ä¸ªå¯å˜åˆ—è¡¨ï¼Œåªæ˜¯å®¹é‡ä¸åŒè€Œå·²ï¼Œä½ åªè¦çŸ¥é“å®ƒå°±æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œç”¨æ¥è£…åˆ†è§£åçš„å•ä¸ª Modifier ç”¨çš„å°±è¡Œäº†ã€‚ æ¥ç€æˆ‘ä»¬å¼€å§‹åˆ†æ fillVector å‡½æ•°ï¼š 1234567891011121314151617181920212223242526272829303132333435ğŸ“„ androidx.compose.ui.node --&gt; NodeChain.ktprivate fun Modifier.fillVector( result: MutableVector&lt;Modifier.Element&gt;): MutableVector&lt;Modifier.Element&gt; { val capacity = result.size.coerceAtLeast(16) /** * 1. åˆ›å»ºä¸€ä¸ªå…ƒç´ ä¸º Modifier çš„å¯å˜åˆ—è¡¨ï¼Œå¹¶åœ¨åˆå§‹åŒ–åæ·»åŠ ä¼ è¿›æ¥çš„ Modifierï¼Œ * ä» stack åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™é‡Œç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªæ ˆï¼Œå¹¶ä¸”å®¹é‡ä¸º 16 */ val stack = MutableVector&lt;Modifier&gt;(capacity).also { it.add(this) } // 2. åªè¦æ ˆä¸ä¸ºç©ºï¼Œä¸€ç›´å¾ªç¯ while (stack.isNotEmpty()) { // 3. ä»æ ˆä¸­ç§»é™¤å¹¶è·å–æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå­˜åˆ° next å˜é‡ä¸­ when (val next = stack.removeAt(stack.size - 1)) { // 4. å¦‚æœ next æ˜¯ CombinedModifier ç±»å‹ is CombinedModifier -&gt; { stack.add(next.inner) // æŠŠ inner éƒ¨åˆ†åŠ å…¥åˆ° stack ä¸­ stack.add(next.outer) // æŠŠ outer éƒ¨åˆ†åŠ å…¥åˆ° stack ä¸­ } // 5. å¦‚æœ next æ˜¯ Modifier.Element ç±»å‹ï¼Œåˆ™ç›´æ¥åŠ åˆ° result ä¸­ is Modifier.Element -&gt; result.add(next) /** * 6. å¦‚æœ next æ˜¯ Modifier çš„å…¶ä»–å®ç°ï¼Œå¯èƒ½æˆ‘ä»¬ä¸çŸ¥é“å…·ä½“å®ç°ç»†èŠ‚ï¼Œ * æŠŠ itï¼ˆå¯èƒ½æ˜¯ Modifier.Element çš„å®ä¾‹ï¼‰åŠ å…¥åˆ° result ä¸­ */ else -&gt; next.all { result.add(it) true } } } // 7. åœ¨å¤„ç†å®Œæ‰€æœ‰çš„å…ƒç´ ä¹‹åï¼Œè¿”å› resultï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰çš„ Modifier.Element return result} è¿™ä¸ªå‡½æ•°å…¶å®å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª Modifier è°ƒç”¨æ ˆï¼Œä»¥ä¾¿å¯ä»¥è¿­ä»£åœ°å¤„ç†ä¸€ä¸ªå¯èƒ½åµŒå¥—çš„ Modifier ç»“æ„ã€‚æ ˆçš„ä½¿ç”¨æ˜¯ä¸ºäº†åœ¨ä¸ä½¿ç”¨é€’å½’çš„æƒ…å†µä¸‹æ‰å¹³åŒ–ä¿®é¥°ç¬¦çš„ç»“æ„ã€‚ æ³¨æ„ï¼ä» 1.3.0-beta01 ç‰ˆæœ¬å¼€å§‹ï¼ŒCompose ä¸­ä¸å†ä½¿ç”¨ foldIn/foldOut å‡½æ•°å¯¹ Modifier è¿›è¡Œéå†äº†ï¼Œåœ¨ 1.3.0-beta01 ä¹‹å‰çš„ç‰ˆæœ¬ LayoutNode æºç ä¸­æ˜¯é€šè¿‡ foldOut éå† + å¤´æ’æ³•å¤„ç†ï¼Œè€Œç°åœ¨æ˜¯é€šè¿‡ fillVector å‡½æ•°å¤„ç†è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœã€‚ çœ‹çš„æ‡‚å—ï¼Ÿæ˜¯ä¸æ˜¯å¾ˆæ‡µï¼Ÿæˆ‘ä»¬æ¥ä¸ªå®é™…ä¾‹å­å§ï¼Œæ¯”å¦‚ä¼ å…¥çš„ Modifier é“¾å¦‚ä¸‹ï¼š 1234567891011// è¿™æ˜¯ä½ å†™çš„ä»£ç Box(Modifier.padding(10.dp).size(20.dp))// æ­¤æ—¶ Modifier é“¾ä¸º:modifierChain = Modifier.padding(10.dp).size(20.dp)// å®é™…çš„ç»“æ„ï¼šCombinedModifier( PaddingElement // outer SizeElement // inner) æˆ‘ä»¬æ¥çœ‹çœ‹ fillVector æ˜¯æ€ä¹ˆå¤„ç†å®ƒçš„ï¼š &nbsp;&nbsp;&nbsp;&nbsp;â¡ï¸ 1. å½“è°ƒç”¨ fillVector å‡½æ•°æ—¶ï¼Œåˆå§‹çŠ¶æ€æ˜¯ modifierChain æ”¾å…¥äº†ä¸€ä¸ªç©ºçš„ stack ä¸­ã€‚ &nbsp;&nbsp;&nbsp;&nbsp;â¡ï¸ 2. æ­¤æ—¶ stack ä¸ä¸ºç©ºï¼Œå¼€å§‹å¾ªç¯ï¼š &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸ removeAt ä» stack çš„æœ«å°¾ï¼ˆæœ€ååŠ å…¥çš„å…ƒç´ ï¼‰ç§»é™¤ CombinedModifierï¼ˆå› ä¸ºå®ƒæ˜¯é“¾ä¸­æœ€åä¸€ä¸ªå…ƒç´ ï¼‰ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ nextã€‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸ next æ˜¯ä¸€ä¸ª CombinedModifier å®ä¾‹ï¼Œæ­¤æ—¶å°±æŠŠ inner å’Œ outer åˆ†åˆ«åŠ è¿› stack ä¸­ï¼Œè¿™ä¸ªæ—¶å€™ stack é‡Œé¢å°±åˆæœ‰äº†ä¸¤ä¸ªå…ƒç´ ï¼š[SizeElement, PaddingElement]ã€‚ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸ å†æ¬¡å¾ªç¯ï¼Œè¿™ä¸ªæ—¶å€™å†æ¬¡å¼€å§‹ removeAt ä»æœ«å°¾å–ï¼Œå…ˆå–åˆ° PaddingElementï¼Œæ¡ä»¶åˆ¤æ–­å‘ç°å®ƒæ˜¯ä¸€ä¸ª Modifier.Elementï¼Œé‚£å°±æŠŠå®ƒåŠ è¿› result é‡Œé¢ï¼ˆresult ä¹Ÿæ˜¯ä¸€ä¸ªå¯å˜åˆ—è¡¨ï¼‰ã€‚ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ğŸ”¸ ç»§ç»­å¾ªç¯ï¼Œåˆå–åˆ°äº† SizeElementï¼Œå‘ç°å®ƒä¹Ÿæ˜¯ä¸€ä¸ª Modifier.Elementï¼Œé‚£å°±ç›´æ¥åŠ è¿› result é‡Œé¢ã€‚ &nbsp;&nbsp;&nbsp;&nbsp;â¡ï¸ 3. ç»§ç»­å¾ªç¯ï¼Œå•ªï½ stack æ²¡ä¸œè¥¿äº†ï¼Œå¾ªç¯ç»“æŸï¼Œç›´æ¥è¿”å› result ç»“æœï¼š[PaddingElement, SizeElement]ã€‚ è¿™æ®µæµç¨‹æˆ‘ç»™ä½ ç”»äº†å¼ å›¾ï¼š ğŸ“ æ„å»ºåŒå‘é“¾è¡¨ç°åœ¨æˆ‘ä»¬æ¥åˆ†æç¬¬äºŒæ®µæ ¸å¿ƒä»£ç ï¼š 123456789101112131415// NodeChain.kt} else if (!layoutNode.isAttached &amp;&amp; beforeSize == 0) { // ç¬¬ä¸€æ¬¡ç»„è£… Modifier.Node åŒå‘é“¾è¡¨ coordinatorSyncNeeded = true var node = paddedHead ğŸŸ¡ 1. node åˆå§‹å€¼æ˜¯ä»€ä¹ˆï¼Ÿ while (i &lt; after.size) { ğŸŸ¡ 2. after æ˜¯ä»€ä¹ˆï¼Ÿ val next = after[i] val parent = node // ğŸ“ æ ¸å¿ƒä»£ç  2: ç»„è£…åŒå‘é“¾è¡¨çš„å…·ä½“é€»è¾‘ node = createAndInsertNodeAsChild(next, parent) logger?.nodeInserted(0, i, next, parent, node) i++ } syncAggregateChildKindSet()} æˆ‘ä»¬å…ˆæ¥çœ‹ nodeï¼Œå®ƒæ˜¯ paddedHeadï¼š 1val paddedHead = padChain() æ¥çœ‹ä¸‹ padChain() åšäº†ä»€ä¹ˆï¼š 123456789101112// NodeChain.ktinternal val tail: Modifier.Node = innerCoordinator.tailinternal var head: Modifier.Node = tail private set private fun padChain(): Modifier.Node { check(head !== SentinelHead) { &quot;padChain called on already padded chain&quot; } val currentHead = head currentHead.parent = SentinelHead SentinelHead.child = currentHead return SentinelHead} è¿™ä¸ªæ—¶å€™ head é»˜è®¤æ˜¯ tailï¼Œå…¶å®å°±æ˜¯ç»„ä»¶æœ¬èº«ï¼šBoxã€‚ SentinelHead æ˜¯ä»€ä¹ˆï¼Ÿå®ƒæœ€ä¸»è¦çš„ä½œç”¨å°±æ˜¯ä½œä¸ºä¸€ä¸ªå“¨å­èŠ‚ç‚¹ï¼Œç®€åŒ–é“¾è¡¨æ“ä½œç”¨çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå®ƒç†è§£ä¸ºåœ¨ Box è¿™ä¸ª Modifier.Node èŠ‚ç‚¹å‰é¢æ’å…¥ä¸€ä¸ªå“¨å­èŠ‚ç‚¹ï¼Œå®ƒä»¬å½¼æ­¤æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ æˆ‘ä»¬å†æ¥çœ‹ after ï¼Œå®ƒå°±æ˜¯å…ˆå‰ result è¿”å›çš„ç»“æœï¼Œå³ï¼š[PaddingElement, SizeElement]ï¼Œæ‰€ä»¥ next ä¼šè½®æµå–åˆ°è¿™ä¸¤ä¸ª Modifier è¿›è¡Œè¿›ä¸€æ­¥çš„æ“ä½œã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æ createAndInsertNodeAsParent å‡½æ•°ï¼š 123456789101112131415161718// NodeChain.ktprivate fun createAndInsertNodeAsChild( element: Modifier.Element, parent: Modifier.Node,): Modifier.Node { // 1. åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ val node = when (element) { // 2. å¦‚æœ element æ˜¯ ModifierNodeElement çš„å®ä¾‹ï¼Œå®ƒä¼šè°ƒç”¨ element ä¸Šçš„ create æ–¹æ³•ï¼Œ // è¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Modifier.Node is ModifierNodeElement&lt;*&gt; -&gt; element.create().also { it.kindSet = calculateNodeKindSetFromIncludingDelegates(it) } else -&gt; BackwardsCompatNode(element) } ... // 3. æ’å…¥åˆ°æ ‘ä¸­ return insertChild(node, parent)} æˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸€ä¸‹ when() å†…éƒ¨çš„æ“ä½œï¼š é¦–å…ˆå–åˆ°çš„æ˜¯ PaddingElementï¼Œå®ƒæ˜¯ ModifierNodeElement çš„å®ç°ç±»ï¼Œæ‰€ä»¥æ»¡è¶³æ¡ä»¶ï¼Œæ¥ç€è°ƒç”¨ create() æ–¹æ³•ï¼Œä¼šæŠŠ PaddingElement åŒ…è£…æˆä¸€ä¸ª Modifier.Nodeã€‚ ç°åœ¨å·²ç»å¾—åˆ°äº†ä¸€ä¸ª Modifier.Nodeï¼Œæ¥ç€æŠŠå®ƒæ’å…¥æ ‘ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹æ“ä½œï¼š 1234567891011121314// NodeChain.ktprivate fun insertChild(node: Modifier.Node, parent: Modifier.Node): Modifier.Node { // 1. parent å°±æ˜¯å“¨å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥ theChild å°±æ˜¯ Box å¯¹åº”çš„ Modifier.Node val theChild = parent.child if (theChild != null) { // 2. node æ˜¯ä¼ è¿›æ¥çš„ PaddingNodeï¼Œå°†ä¸¤ä¸ª Modifier.Node å»ºç«‹åŒå‘é“¾è¡¨å…³ç³» theChild.parent = node node.child = theChild } // 3. å†æŠŠå“¨å­èŠ‚ç‚¹è·Ÿä¼ è¿›æ¥çš„ PaddingNode æ„å»ºåŒå‘é“¾è¡¨å…³ç³» parent.child = node node.parent = parent return node} èƒ½ç†è§£å—ï¼Ÿæˆ‘ä¹Ÿç»™ä½ ç”»äº†å¼ å›¾ï¼š ç°åœ¨å·²ç»å¤„ç†å®Œäº† PaddingElementï¼Œå¾ªç¯å–å€¼ï¼Œæ‹¿å‡ºç¬¬äºŒä¸ª SizeElementï¼Œç»§ç»­å¤„ç†ï¼Œæµç¨‹æˆ‘å°±ä¸å†™äº†ç›´æ¥çœ‹å›¾ï¼š è‡³æ­¤ï¼Œç¬¬äºŒéƒ¨æ„å»ºåŒå‘é“¾è¡¨çš„å·¥ä½œå°±ç»“æŸäº†ï¼Œä½ å‘ç°æ²¡æœ‰ï¼Œè™½ç„¶å…ˆå¤„ç†äº† PaddingElementï¼Œåå¤„ç†äº† SizeElementï¼Œä½†å®é™…ä¸Šæ˜¯æŠŠ SizeElement æ’å…¥åˆ°äº† PaddingElement å†…éƒ¨ï¼Œè¿™å…¶å®å°±è·Ÿè€ç‰ˆæœ¬çš„ foldIn ä»å°¾éƒ¨ä¾¿åˆ©ç„¶åå¤´æ’çš„æ–¹å¼ä¸€æ ·ï¼Œå®ç°äº†åŒæ ·çš„åŠŸèƒ½ã€‚ ğŸ“ æ›´æ–°å¤´èŠ‚ç‚¹ç¬¬äºŒæ®µæ ¸å¿ƒä»£ç å·²ç»æ„å»ºå¥½äº†åŒå‘é“¾è¡¨ï¼Œä½†å¦‚æœä½ çœ‹è¿‡è€ç‰ˆæœ¬çš„ä»£ç ä¼šå‘ç°ï¼Œä»¥å‰æ˜¯æ²¡æœ‰ SentineHead è¿™ä¸ªå“¨å­èŠ‚ç‚¹çš„ï¼Œç›®å‰çš„åŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹æ˜¯ SentineHeadï¼Œå®ƒå¹¶æ²¡æœ‰å®é™…çš„åŠŸèƒ½ä¸Šçš„ç”¨å¤„ï¼Œæ‰€ä»¥è¿™å°±æ˜¯ç¬¬ä¸‰æ­¥æ ¸å¿ƒä»£ç è¦åšçš„äº‹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼š 1234567891011121314// NodeChain.ktprivate fun trimChain(paddedHead: Modifier.Node): Modifier.Node { check(paddedHead === SentinelHead) { &quot;trimChain called on already trimmed chain&quot; } // 1. å– SentineHead çš„å­èŠ‚ç‚¹ï¼Œæœ‰å—ï¼Ÿæœ‰ -- å°±æ˜¯ PaddingNode val result = SentinelHead.child ?: tail // 2. æ–­å¼€ SentineHead ä¸ PaddingNode ä¹‹é—´çš„é“¾ result.parent = null SentinelHead.child = null SentinelHead.aggregateChildKindSet = 0.inv() SentinelHead.updateCoordinator(null) check(result !== SentinelHead) { &quot;trimChain did not update the head&quot; } // 3. è¿”å›é“¾ï¼Œæ­¤æ—¶é“¾å°±å®Œå…¨æ˜¯ä¸€ä¸ªç”±ç»„ä»¶è‡ªèº«çš„ Node å’Œ Modifier çš„ Node ç»„æˆçš„åŒå‘é“¾è¡¨äº† return result} ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠ SentineHead ä»åŒå‘é“¾è¡¨ä¸­æ–­å¼€å»é™¤ï¼Œè¿™æ ·å°±æ˜¯ä¸€ä¸ªæ–°çš„ä»¥ PaddingModifier ä¸ºè¡¨å¤´çš„åŒå‘é“¾è¡¨äº†ã€‚ ğŸ“ åŒæ­¥åè°ƒå™¨æˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼šNodeCoordinator æ˜¯ç”¨æ¥è¾…åŠ© Node èŠ‚ç‚¹å¤„ç†æµ‹é‡å’Œå¸ƒå±€çš„ï¼Œå…¶ä¸­åŒ…å« measure å’Œ placeAt çš„å‡½æ•°é€»è¾‘ã€‚NodeChain é“¾è¡¨ä¸Šçš„æ¯ä¸€ä¸ª Node éƒ½ä¼šå¯¹åº”çš„ç»‘å®šä¸€ä¸ª NodeCoordinator å¯¹è±¡æ¥è¾…åŠ©å¤„ç†ã€‚ ç°åœ¨ NodeChain é“¾è¡¨å·²ç»å…¨éƒ¨æå®šäº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è¦å¼€å§‹å¯¹é“¾è¡¨ä¸Šæ¯ä¸€ä¸ª Modifier.Node ç»‘å®šä¸€ä¸ª NodeCoordinatorï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ syncCoordinator å‡½æ•°æ˜¯æ€ä¹ˆåšçš„ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849// NodeChain.ktprivate fun syncCoordinators() { var coordinator: NodeCoordinator = innerCoordinator // tail å°±æ˜¯é“¾è¡¨çš„å°¾éƒ¨èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ç»„ä»¶è‡ªèº«çš„ Modifier.Node // å¼€å§‹éå†ï¼Œè·å–å®ƒçš„çˆ¶èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ tail -&gt; SizeNode -&gt; PaddingNode var node: Modifier.Node? = tail.parent while (node != null) { // åˆ¤æ–­ Modifier.Node å°±æ˜¯ä¸æ˜¯ LayoutModifierNode val layoutmod = node.asLayoutModifierNode() // å¦‚æœæ˜¯ LayoutModifierNode if (layoutmod != null) { // å¦‚æœèŠ‚ç‚¹å·²æœ‰å…³è”çš„ coordinatorï¼Œåˆ™ä½¿ç”¨ç°æœ‰çš„åè°ƒå™¨ï¼ŒåŒæ—¶åˆ¤æ–­æ­¤åè°ƒå™¨æ‰€å…³è”çš„èŠ‚ç‚¹æ˜¯å¦å˜åŒ–äº†ï¼Œ // å¦‚æœæœ‰å˜åŒ–ï¼Œåˆ™è°ƒç”¨ onLayoutModifierNodeChanged() æ–¹æ³• val next = if (node.coordinator != null) { val c = node.coordinator as LayoutModifierNodeCoordinator val prevNode = c.layoutModifierNode c.layoutModifierNode = layoutmod if (prevNode !== node) c.onLayoutModifierNodeChanged() c } else { // å¦‚æœèŠ‚ç‚¹æ²¡æœ‰å…³è”çš„ coordinatorï¼Œåˆ™åˆ›å»ºä¸€ä¸ª LayoutModifierNodeCoordinatorï¼Œ // å¹¶é€šè¿‡ updateCoordinator æ–¹æ³•å°†è¿™ä¸ªæ–°åè°ƒå™¨å’ŒèŠ‚ç‚¹ç›¸å…³è” val c = LayoutModifierNodeCoordinator(layoutNode, node) node.updateCoordinator(c) c } // ä¸è®ºæ˜¯ä½¿ç”¨æ—§çš„è¿˜æ˜¯æ–°å»ºçš„ coordinatorï¼Œé€šè¿‡è®¾ç½® wrappedBy å’Œ wrapped å±æ€§ï¼Œ // å»ºç«‹å½“å‰ coordinator ä¸ä¸‹ä¸€ä¸ª coordinator çš„åŒ…è£…å…³ç³»ï¼Œ // ç„¶åå°† coordinator å˜é‡æ›´æ–°ä¸ºä¸‹ä¸€ä¸ª coordinator // ä¾‹å¦‚æˆ‘ä»¬è¿™è¾¹çš„ä¾‹å­ï¼štail -&gt; SizeNode coordinator.wrappedBy = next // InnerCoordinator è¢«è°åŒ…è£¹ï¼Ÿ-- LayoutModifierNodeCoordinator next.wrapped = coordinator // LayoutModifierNodeCoordinator åŒ…è£¹äº†è°ï¼Ÿ-- InnerCoordinator coordinator = next // æ›´æ–° coordinatorï¼Œæ¯”å¦‚åé¢å†è·Ÿ PaddingNode å»ºç«‹åŒ…è£¹å…³ç³» } else { // å¦‚æœ node ä¸æ˜¯å¸ƒå±€ä¿®é¥°ç¬¦èŠ‚ç‚¹ï¼Œç›´æ¥è°ƒç”¨ updateCoordinator æ–¹æ³•æ¥æ›´æ–°åè°ƒå™¨ï¼Œ // å°† node å’Œ NodeCoordinator æŒ‚æ¥å…³è” // æ¯”å¦‚ï¼š // Modifier.background().size() // è¿™é‡Œ Modifier.background() è½¬æ¢åçš„ Node å¯¹åº”çš„ NodeCoordinator // ä¸º SizeNode å¯¹åº”çš„ NodeCoordinator node.updateCoordinator(coordinator) } // åœ¨æ¯æ¬¡è¿­ä»£ç»“æŸæ—¶ï¼Œå°† node å˜é‡æ›´æ–°ä¸ºå½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ node.parentï¼Œä¸ºä¸‹ä¸€æ¬¡å¾ªç¯å‡†å¤‡ // ä¹Ÿå°±æ˜¯è·å– SizeNode çš„çˆ¶èŠ‚ç‚¹ -- PaddingNodeï¼Œç»§ç»­å¤„ç† node = node.parent } coordinator.wrappedBy = layoutNode.parent?.innerCoordinator outerCoordinator = coordinator // è°ƒæ•´å¤–å±‚ NodeCoordinator} çœ‹æ‡‚äº†å—ï¼Ÿæˆ‘åˆç”»äº†ä¸€å¼ å›¾ï¼š ç°åœ¨è®©æˆ‘ä»¬ç®€å•æ€»ç»“ä¸‹ updateFrom() çš„å¤„ç†æ­¥éª¤ï¼š åœ¨ Composable ç¼–å†™çš„ Modifier æ˜¯å±‚å±‚åµŒå¥—çš„ï¼Œé¦–å…ˆéœ€è¦å°† Modifier é›†åˆé“ºå¹³åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼› å¦‚æœ NodeChain è¿˜æ²¡æœ‰ç»„è£…è¿‡åŒå‘é“¾è¡¨ï¼Œéå†æ­¥éª¤ä¸€é“ºå¹³çš„ Modifier æ•°ç»„ç»„è£…æˆåŒå‘é“¾è¡¨ï¼Œå¦åˆ™å°±å¯¹åŒå‘é“¾è¡¨å¢é‡æ›´æ–°ï¼› æ›´æ–°åŒå‘é“¾è¡¨å¤´èŠ‚ç‚¹ï¼› å°† Modifier å’Œæ‰€å±çš„ NodeCoordinator æŒ‚æ¥å…³è”ã€‚ ç°åœ¨å»é™¤ä»£ç åˆ†æéƒ¨åˆ†ï¼Œå†æ¥çœ‹ä¸€ä¸ªæ•´ä½“æ€ç»´æ¨¡å‹å›¾ï¼š çœ‹åˆ°è¿™é‡Œï¼Œæ‰€æœ‰çš„ Modifier å¤„ç†å®Œäº†ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹æµ‹é‡äº†ï¼Œä½ è¿˜è®°å¾—ç¬¬äºŒèŠ‚æˆ‘ä»¬è®²çš„ç»„ä»¶è‡ªèº«æµ‹é‡çš„ä»£ç é€»è¾‘å—ï¼Ÿæˆ‘ä¼°è®¡ä½ çœ‹åˆ°è¿™ï¼Œåº”è¯¥å·²ç»å…¨å¿˜äº†ï¼Œæ‰€ä»¥å†çœ‹ä¸€ä¸‹æµç¨‹å›¾å§ï¼š çœ‹åˆ°æ²¡ï¼Ÿæ˜¯è°æµ‹é‡çš„ï¼Ÿâ€“ outerCoordinatorï¼ outerCoordinator å¯¹è±¡å°±æ˜¯åšå®é™…æµ‹é‡å·¥ä½œçš„ï¼Œæ‰€ä»¥å¼€å§‹æµ‹é‡çš„æ—¶å€™ï¼Œä»å“ªå¼€å§‹æµ‹ï¼Ÿä¸ç”¨æˆ‘è¯´äº†å§ï¼Ÿ 3.3 LayoutModifierNodeCoordinator.measure()æˆ‘ä»¬çœ‹ä¸‹ LayoutModifierNodeCoordinator æ˜¯æ€ä¹ˆåšæµ‹é‡çš„ï¼š 123456789101112131415161718192021222324// LayoutModifierNodeCoordinator.ktinternal class LayoutModifierNodeCoordinator( layoutNode: LayoutNode, measureNode: LayoutModifierNode,) : NodeCoordinator(layoutNode) { override fun measure(constraints: Constraints): Placeable { performingMeasure(constraints) { // 1. æ ¸å¿ƒä»£ç ï¼Œwith åŒ…å«äº† LayoutModifierNodeï¼Œæä¾›äº†ä¸€ä¸ª LayoutModifierNode çš„ä¸Šä¸‹æ–‡ with(layoutModifierNode) { measureResult = if (this is IntermediateLayoutModifierNode) { ... } else { // 2. è¿™é‡Œçš„ wrappedNonNull æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬åé¢é©¬ä¸Šå°±è¯´åˆ° measure(wrappedNonNull, constraints) } this@LayoutModifierNodeCoordinator } } onMeasured() return this }} 3.4 LayoutModifierNode.measure()measure() çš„å·¥ä½œä¼šè·³è½¬åˆ°å“ªé‡Œï¼Œæ˜¯ç”± with() å†³å®šçš„ï¼Œå®ƒæä¾›äº† LayoutModifierNode ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥ measure() è·³è½¬åˆ°äº† LayoutModifierNode é‡Œé¢ã€‚ 12345678910// LayoutModifierNode.ktinterface LayoutModifierNode : Remeasurement, DelegatableNode { fun MeasureScope.measure( measurable: Measurable, constraints: Constraints ): MeasureResult ... ...} LayoutModifierNode åªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ‰€ä»¥å…·ä½“çš„æµ‹é‡å®ç°åœ¨å“ªï¼Ÿ è¿™é‡Œæˆ‘ä»¬è¦åˆ†ä¸¤ç§åœºæ™¯æ¥çœ‹ï¼š 1. æˆ‘ä»¬é¦–å…ˆæ¥çœ‹æœ€ç®€å•çš„ä¸€ç§æƒ…å†µï¼šModifier.layout() æ¯”å¦‚æˆ‘ä»¬æ–‡ç« å‰é¢å†™è¿‡çš„ä¸€ä¸ªä¾‹å­ï¼š 1234567891011121314151617181920212223class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.background(Color.Green)) { Text(&quot;Hi Compose&quot;, // hereï¼Œç†Ÿæ‚‰å—ï¼Ÿ Modifier.layout { measurable, constraints -&gt; val paddingPx = 10.dp.roundToPx() val placeable = measurable.measure(constraints.copy( maxWidth = constraints.maxWidth - paddingPx * 2, maxHeight = constraints.maxHeight - paddingPx * 2 )) layout(placeable.width + paddingPx * 2, placeable.height + paddingPx * 2) { placeable.placeRelative(paddingPx, paddingPx) } }) } } } }} ç‚¹è¿› Modifier.layout {} çœ‹æºç ï¼š 1234567891011// LayoutModifier.ktfun Modifier.layout( measure: MeasureScope.(Measurable, Constraints) -&gt; MeasureResult) = this then LayoutElement(measure)private data class LayoutElement( val measure: MeasureScope.(Measurable, Constraints) -&gt; MeasureResult) : ModifierNodeElement&lt;LayoutModifierImpl&gt;() { override fun create() = LayoutModifierImpl(measure) ... ...} å†ç‚¹å‡» LayoutModifierImpl è¿›å»çœ‹çœ‹ï¼š 12345678910111213internal class LayoutModifierImpl( var measureBlock: MeasureScope.(Measurable, Constraints) -&gt; MeasureResult) : LayoutModifierNode, Modifier.Node() { // çœ‹ï¼ï¼ï¼æ˜¯ä¸æ˜¯é‡å†™äº† MeasureScope.measure æ–¹æ³• ? æ‰€ä»¥å…·ä½“æµ‹é‡å·¥ä½œå°±åœ¨è¿™é‡Œäº†ã€‚ override fun MeasureScope.measure( measurable: Measurable, constraints: Constraints ) = measureBlock(measurable, constraints) override fun toString(): String { return &quot;LayoutModifierImpl(measureBlock=$measureBlock)&quot; }} è¿™é‡Œ measure ç›´æ¥è°ƒç”¨äº† measureBlock()ï¼Œå®ƒæ˜¯å‚æ•°ä¼ è¿›æ¥çš„ï¼Œå¾€å›é€€ï¼š 1234567891011// LayoutModifier.ktfun Modifier.layout( measure: MeasureScope.(Measurable, Constraints) -&gt; MeasureResult) = this then LayoutElement(measure)private data class LayoutElement( val measure: MeasureScope.(Measurable, Constraints) -&gt; MeasureResult) : ModifierNodeElement&lt;LayoutModifierImpl&gt;() { override fun create() = LayoutModifierImpl(measure) ... ...} measureBlock åˆæ˜¯ measureï¼Œè€Œ measure æ˜¯å•¥ï¼Ÿå°±æ˜¯ä½ ä¸»ä»£ç é‡Œé¢å†™åœ¨ Modifier.layout {} é‡Œé¢çš„æµ‹é‡å’Œå¸ƒå±€é€»è¾‘ï¼Œè¿™å°±ç›¸å½“äºå®ç°äº†å°†å†…éƒ¨çš„æµ‹é‡ç»“æœæš´éœ²ç»™ä¸Šå±‚ï¼Œè®©æˆ‘ä»¬èƒ½ä¿®é¥°åšäºŒæ¬¡æµ‹é‡å¤„ç†ã€‚ 2. ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒç§åœºæ™¯ï¼šModifier.padding(10.dp).size(20.dp) è¿™ä¸ªä¾‹å­ä¸ç”¨å¤šè¯´äº†å§ï¼Œä¹‹å‰åˆ†ææºç å°±æ˜¯åŸºäºå®ƒï¼Œè¿™ä¸ªåœºæ™¯å°±è¦å…³è”åˆ°æˆ‘ä»¬åˆšåˆšæåˆ°çš„ wrappedNonNull äº†ã€‚ 1234567891011121314151617181920212223242526// LayoutModifierNodeCoordinator.ktinternal class LayoutModifierNodeCoordinator( layoutNode: LayoutNode, measureNode: LayoutModifierNode,) : NodeCoordinator(layoutNode) { // 2. wrapped æ˜¯ LayoutModifierNodeCoordinator çš„å†…éƒ¨ NodeCoordinator val wrappedNonNull: NodeCoordinator get() = wrapped!! override fun measure(constraints: Constraints): Placeable { performingMeasure(constraints) { with(layoutModifierNode) { measureResult = if (this is IntermediateLayoutModifierNode) { ... } else { // 1. è¿™é‡Œçš„ wrappedNonNull æ˜¯ä»€ä¹ˆï¼Ÿ measure(wrappedNonNull, constraints) } this@LayoutModifierNodeCoordinator } } onMeasured() return this }} æ³¨é‡Šå†™çš„å¾ˆæ¸…æ¥šï¼šwrapped æ˜¯æœ€å¤–å±‚ LayoutModifierNodeCoordinator çš„å†…éƒ¨ NodeCoordinatorï¼Œæ˜¯è°ï¼Ÿ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/960dbde487b0d351e1f6bf144eff8b9e.png#pic_center =700x) æ‰€ä»¥ä½ èƒ½çœ‹å‡ºä»€ä¹ˆé—¨é“å—ï¼Ÿæµç¨‹å¾ˆæ¸…æ™°ï¼šæµ‹é‡è¿‡ç¨‹ä¸­ä¼šä»å¤–å¾€é‡Œæ‰§è¡Œæ¯ä¸€ä¸ª NodeCoordinator çš„ measure æ–¹æ³•ï¼Œç›´åˆ°è§¦åº•é‡åˆ°ç»„ä»¶è‡ªèº«çš„ InnerNodeCoordinatorï¼Œå®ƒè´Ÿè´£è‡ªèº«çš„æµ‹é‡ã€‚ æµç¨‹å¦‚ä¸‹ï¼š æˆ‘ä»¬è¦ç»™ Box å¢åŠ  10dp çš„ paddingï¼Œä½†æ­¤æ—¶è¿˜ä¸çŸ¥é“ç»„ä»¶æœ¬èº«å¤§å°ï¼Œæ‰€ä»¥å°±éœ€è¦å…ˆæµ‹é‡å†…éƒ¨ï¼Œä¼šå…ˆå»æ‰¾ 10dp å¥—ç€çš„å†…éƒ¨ï¼› ç°åœ¨å†…éƒ¨è¦è®¾å®š 20dp çš„ sizeï¼Œä½†ä»ç„¶ä¸çŸ¥é“ç»„ä»¶æœ¬èº«å¤§å°ï¼Œéœ€è¦å…ˆæµ‹é‡å†…éƒ¨ï¼Œç»§ç»­å¾€ä¸‹æ‰¾å®ƒçš„å†…éƒ¨ï¼› æ‰¾åˆ°äº†å…·ä½“ç»„ä»¶ Boxï¼Œå®ƒæ˜¯ InnerNodeCoordinatorï¼ŒInnerNodeCoordinator å·²ç»æ²¡æœ‰å†…éƒ¨äº†ï¼Œæ‰€ä»¥ Box æŒ‰ç…§è‡ªå·±çš„æµ‹é‡æ–¹å¼å»æµ‹é‡æ‹¿åˆ°æµ‹é‡ç»“æœï¼› InnerNodeCoordinator æµ‹é‡å‡ºç»“æœåï¼Œå¾€ä¸Šä¼ ç»™è¦è®¾å®š size çš„ LayoutModifierNodeï¼Œåœ¨æµ‹é‡ç»“æœä¸Šè®¾å®š 20dp çš„ size åè¿”å›æµ‹é‡ç»“æœï¼› æ‹¿åˆ°è®¾å®š 20dp size çš„æµ‹é‡ç»“æœåï¼Œå†å¾€ä¸Šä¼ ç»™è¦åŠ  padding çš„ LayoutModifierNodeï¼Œåœ¨æµ‹é‡ç»“æœä¸Šå†æ·»åŠ  10dp çš„ paddingï¼ŒLayoutNode æ‹¿åˆ°æœ€ç»ˆçš„æµ‹é‡ç»“æœã€‚","link":"/2024/09/13/Compose%20--%20Modifier%20--%2003.%20%E8%A7%A3%E6%9E%90%20Modifier.layout()/"},{"title":"è§£æ ParentDataModifier","text":"â€œ Jetpack Compose - - Modifier ç³»åˆ—æ–‡ç«  â€œ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±å…¥è§£æ Compose çš„ Modifier åŸç† - - Modifierã€CombinedModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - Modifier.composed()ã€ComposedModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±å…¥è§£æ Compose çš„ Modifier åŸç† - - Modifier.layout()ã€LayoutModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - DrawModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - PointerInputModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - ParentDataModifier ã€‹ å…¶å®åŸç†æ€§åˆ†æçš„æ–‡ç« ï¼ŒçœŸçš„å¾ˆéš¾è®²çš„é€šä¿—æ˜“æ‡‚ï¼Œè®²çš„ç®€å•äº†å°±æ²¡å¿…è¦å†™äº†ï¼Œè®²çš„ç¹çéš¾æ‡‚å¾€å¾€å¤§å®¶ä¹Ÿä¸ä¹æ„çœ‹ï¼Œæ‰€ä»¥åªèƒ½å°½é‡æƒ³åŠæ³•ï¼Œæ‰¾ä¸ªå¥½çš„è§’åº¦ï¼ˆæ¯”å¦‚ä» Demo ä»£ç ç¤ºä¾‹å‡ºå‘ï¼‰æ…¢æ…¢å¸¦ç€å¤§å®¶å»é’»æºç ï¼Œå¦‚æœç¡®å®èƒ½å¸®åŠ©åˆ°å¤§å®¶å®Œå…¨ç†è§£äº†æ–‡ç« æ‰€è®²è¿°åˆ°çš„æºç ç†è®ºï¼Œé‚£å°±å€¼äº†ã€‚ åœ¨æ­£å¼å¼€å§‹åˆ†æ DrawModifier ä¹‹å‰ï¼Œå»ºè®®ä½ å…ˆçœ‹çœ‹ ã€LayoutModifier å’Œ Modifier.layout ç”¨æ³•åŠåŸç†ã€‘è¿™ç¯‡æ–‡ç« ï¼Œæ¯•ç«Ÿå®ƒæ˜¯ä½œä¸º Modifier åŸç†è§£æçš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œå¯¹ä½ äº†è§£æ•´ä¸ª Modifier æ¶æ„è¿˜æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œæˆ–è€…è¯´å®ƒæ˜¯æœ€åŸºç¡€çš„ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœä¸ç†Ÿæ‚‰ï¼Œåé¢çš„ç³»åˆ— Modifier ä½ å¯èƒ½ä¼šçœ‹çš„æ¯”è¾ƒè´¹åŠ²â€¦ â€¦ ParentDataModifier çš„ä½œç”¨123456789101112131415class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Row() { Box(Modifier.size(40.dp).background(Color.Red)) Box(Modifier.size(40.dp).background(Color.Green)) Box(Modifier.size(40.dp).background(Color.Blue)) } } } }} è¿™æ®µä»£ç å¾ˆç®€å•ï¼Œæ¨ªå‘å¸ƒå±€æ˜¾ç¤ºä¸‰ä¸ª Boxï¼Œæ•ˆæœå¦‚ä¸‹ï¼š å¦‚æœæˆ‘å¸Œæœ›è¿™ä¸‰ä¸ªæ–¹å—å¯ä»¥å¹³åˆ†æ¨ªå‘å¸ƒå±€çš„ç©ºé—´ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ 123456789101112131415class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Row() { Box(Modifier.size(40.dp).background(Color.Red).weight(1f)) Box(Modifier.size(40.dp).background(Color.Green).weight(1f)) Box(Modifier.size(40.dp).background(Color.Blue).weight(1f)) } } } }} åªè¦ç»™æ¯ä¸ª Box æ·»åŠ  Modifier.weight(1f) å³å¯ï¼Œç›¸å½“äºä¼ ç»Ÿå¸ƒå±€é‡Œé¢ LinearLayout çš„ android:layout_weightã€‚ ä»æ•ˆæœæ¥çœ‹ï¼ŒModifier.weight() ä¸æµ‹é‡å¸ƒå±€æœ‰å…³ï¼Œé‚£è¯´æ˜å®ƒå†…éƒ¨æ˜¯ä¸€ä¸ª LayoutModifierï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹ï¼š 1234567891011121314151617181920interface RowScope { @Stable fun Modifier.weight( /*@FloatRange(from = 0.0, fromInclusive = false)*/ weight: Float, fill: Boolean = true ): Modifier}internal object RowScopeInstance : RowScope { @Stable override fun Modifier.weight(weight: Float, fill: Boolean): Modifier { require(weight &gt; 0.0) { &quot;invalid weight $weight; must be greater than zero&quot; } return this.then( LayoutWeightImpl( ... ... ) ) }} then å¥—äº†ä¸€ä¸ª LayoutWeightImplï¼š 1234567internal class LayoutWeightImpl( val weight: Float, val fill: Boolean, inspectorInfo: InspectorInfo.() -&gt; Unit) : ParentDataModifier, InspectorValueInfo(inspectorInfo) { ... ...} åŸæ¥ Modifier.weight æ˜¯åˆ›å»ºäº†ä¸€ä¸ª ParentDataModifierï¼Œè€Œä¸æ˜¯ LayoutModifierï¼Œéš¾é“ ParentDataModifier æ˜¯ LayoutModifier çš„ä¸€ä¸ªå­æ¥å£ï¼Ÿ 123interface ParentDataModifier : Modifier.Element { fun Density.modifyParentData(parentData: Any?): Any?} å¾ˆæ˜æ˜¾ï¼ŒParentDataModifier å°±åªç»§æ‰¿äº† Modifier.Element æ¥å£ï¼Œä¸ LayoutModifier æ— å…³ã€‚ ParentDataModifier å®é™…ä¸Šæ˜¯ä¸€ä¸ªè¾…åŠ©çš„ Modifierï¼Œç”¨äºç»™å¤–å±‚åŒ…è£¹çš„ Composable ä½¿ç”¨çš„ï¼Œæ›´å…·ä½“è®²æ˜¯æä¾›ç»™è¢«è®¾ç½®çš„å­ç»„ä»¶çš„çˆ¶ç»„ä»¶åœ¨æµ‹é‡å­ç»„ä»¶çš„æ—¶å€™ä½¿ç”¨ï¼Œè®©çˆ¶ç»„ä»¶èƒ½æ›´å¥½çš„æµ‹é‡å­ç»„ä»¶ã€‚ 123456Row() { // ParentDataModifier æ˜¯æä¾›ç»™ Row ä½¿ç”¨çš„å¸®åŠ©æµ‹é‡ Box Box(Modifier.size(40.dp).background(Color.Red).weight(1f)) Box(Modifier.size(40.dp).background(Color.Green).weight(1f)) Box(Modifier.size(40.dp).background(Color.Blue).weight(1f))} è€Œ LayoutModifier å®ƒåªèƒ½ä½œç”¨äºå•ä¸€çš„ç»„ä»¶ï¼Œå³å¯¹å•ä¸€çš„ç»„ä»¶å¤„ç†æµ‹é‡å¸ƒå±€ï¼Œæ¯”å¦‚ä¸Šé¢ä¾‹å­çš„ Box()ï¼Œå¯¹ Box() è®¾ç½®çš„ LayoutModifier åªä¼šå®ƒè‡ªå·±ç”Ÿæ•ˆã€‚ 1234567Row() { // ä¸‰ä¸ªç»„ä»¶éƒ½è®¾ç½®äº† Modifier.weight()ï¼Œä¾é å•ä¸€ç»„ä»¶æ— æ³•æµ‹é‡å‡ºéœ€è¦å¤šå°‘å®½åº¦ // éœ€è¦äº’ç›¸çŸ¥é“ç»„ä»¶å®½åº¦æ‰èƒ½ç¡®å®šè‡ªå·±å®½åº¦ Box(Modifier.size(40.dp).background(Color.Red).weight(1f)) Box(Modifier.size(40.dp).background(Color.Green).weight(1f)) Box(Modifier.size(40.dp).background(Color.Blue).weight(1f))} ä¸ºäº†èƒ½æµ‹é‡å‡ºå­ç»„ä»¶æ‰€éœ€è¦çš„å®½åº¦/é«˜åº¦ï¼ŒCompose æä¾›äº† ParentDataModifier æ–¹æ¡ˆï¼Œè®©çˆ¶ç»„ä»¶ååŠ©è®¡ç®—æµ‹é‡ã€‚ æ‰€ä»¥ï¼šParentDataModifier è™½ç„¶è®¾ç½®ç»™å­ç»„ä»¶ï¼Œä½†å´æ˜¯æä¾›ç»™çˆ¶ç»„ä»¶ä½¿ç”¨çš„æ•°æ®ï¼Œè¾…åŠ©å­ç»„ä»¶è¿›è¡Œå°ºå¯¸æµ‹é‡å’Œç»˜åˆ¶è®¡ç®—çš„ã€‚","link":"/2024/09/28/Compose%20--%20Modifier%20--%2006.%20%E8%A7%A3%E6%9E%90%20ParentDataModifier/"},{"title":"è§£æ PointerInputModifier","text":"â€œ Jetpack Compose - - Modifier ç³»åˆ—æ–‡ç«  â€œ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±å…¥è§£æ Compose çš„ Modifier åŸç† - - Modifierã€CombinedModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - Modifier.composed()ã€ComposedModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±å…¥è§£æ Compose çš„ Modifier åŸç† - - Modifier.layout()ã€LayoutModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - DrawModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - PointerInputModifier ã€‹ &nbsp;&nbsp;&nbsp;&nbsp;ğŸ“‘ ã€Š æ·±åº¦è§£æ Compose çš„ Modifier åŸç† - - ParentDataModifier ã€‹ å…¶å®åŸç†æ€§åˆ†æçš„æ–‡ç« ï¼ŒçœŸçš„å¾ˆéš¾è®²çš„é€šä¿—æ˜“æ‡‚ï¼Œè®²çš„ç®€å•äº†å°±æ²¡å¿…è¦å†™äº†ï¼Œè®²çš„ç¹çéš¾æ‡‚å¾€å¾€å¤§å®¶ä¹Ÿä¸ä¹æ„çœ‹ï¼Œæ‰€ä»¥åªèƒ½å°½é‡æƒ³åŠæ³•ï¼Œæ‰¾ä¸ªå¥½çš„è§’åº¦ï¼ˆæ¯”å¦‚ä» Demo ä»£ç ç¤ºä¾‹å‡ºå‘ï¼‰æ…¢æ…¢å¸¦ç€å¤§å®¶å»é’»æºç ï¼Œå¦‚æœç¡®å®èƒ½å¸®åŠ©åˆ°å¤§å®¶å®Œå…¨ç†è§£äº†æ–‡ç« æ‰€è®²è¿°åˆ°çš„æºç ç†è®ºï¼Œé‚£å°±å€¼äº†ã€‚ åœ¨æ­£å¼å¼€å§‹åˆ†æ DrawModifier ä¹‹å‰ï¼Œå»ºè®®ä½ å…ˆçœ‹çœ‹ ã€LayoutModifier å’Œ Modifier.layout ç”¨æ³•åŠåŸç†ã€‘è¿™ç¯‡æ–‡ç« ï¼Œæ¯•ç«Ÿå®ƒæ˜¯ä½œä¸º Modifier åŸç†è§£æçš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œå¯¹ä½ äº†è§£æ•´ä¸ª Modifier æ¶æ„è¿˜æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œæˆ–è€…è¯´å®ƒæ˜¯æœ€åŸºç¡€çš„ä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœä¸ç†Ÿæ‚‰ï¼Œåé¢çš„ç³»åˆ— Modifier ä½ å¯èƒ½ä¼šçœ‹çš„æ¯”è¾ƒè´¹åŠ²â€¦ â€¦ åœ¨ Compose ä¸­å¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ï¼šModifier.clickableã€‚ 123456789101112131415class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.size(40.dp) .background(Color.Green) .clickable { // å•å‡»å¤„ç†ï¼Œæ·»åŠ é€»è¾‘ }) { } } } }} ä½† Modifier.clickable() åªèƒ½å¤„ç†å•å‡»äº‹ä»¶ï¼Œå¦‚æœä½ éœ€è¦å¤„ç†é•¿æŒ‰ã€åŒå‡»ç­‰äº‹ä»¶ï¼Œåˆ™éœ€è¦ç”¨åˆ°å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼šModifier.combinedClickable()ã€‚ 12345678910111213141516class MainActivity : ComponentActivity() { @OptIn(ExperimentalFoundationApi::class) override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.size(40.dp) .background(Color.Green) .combinedClickable { }) { } } } }} combinedClickable() æ˜¯ Modifier çš„ä¸€ä¸ªæ‰©å±•å‡½æ•°ï¼š 12345678910@ExperimentalFoundationApifun Modifier.combinedClickable( enabled: Boolean = true, onClickLabel: String? = null, role: Role? = null, onLongClickLabel: String? = null, onLongClick: (() -&gt; Unit)? = null, // é•¿æŒ‰ onDoubleClick: (() -&gt; Unit)? = null, // åŒå‡» onClick: () -&gt; Unit // å•å‡») ä»å‡½æ•°çš„å­—é¢æ„æ€å°±å¯ä»¥çŸ¥é“å®ƒæ˜¯ä¸€ä¸ªç»„åˆç±»å‹çš„ clickableï¼Œå¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šå•å‡»ç±»å‹ï¼Œå¦‚æœä¸å¡«å†™ä»»ä½•å‚æ•°ï¼Œé‚£å®ƒè·Ÿ clickable æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚ 123Modifier.clickable { }// æ— å‚æ•°æƒ…å†µä¸‹ï¼Œç­‰åŒModifier.combinedClickable { } ç°åœ¨æˆ‘ä»¬æ¥æµ‹è¯•ä¸‹ combinedClickable çš„ç”¨æ³•ï¼š 12345678910111213141516171819202122class MainActivity : ComponentActivity() { @OptIn(ExperimentalFoundationApi::class) override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.size(40.dp) .background(Color.Green) .combinedClickable( onLongClick = { println(&quot;@@@ é•¿æŒ‰äº† Box&quot;) }, onDoubleClick = { println(&quot;@@@ åŒå‡»äº† Box&quot;) } ) { // onClick() println(&quot;@@@ å•å‡»äº† Box&quot;) }) { } } } }} ä¸Šé¢åªæ˜¯æ»¡è¶³ç‚¹å‡»ç›‘å¬çš„éœ€æ±‚ï¼Œå¦‚æœéœ€è¦å¤æ‚çš„è§¦æ‘¸åé¦ˆå®šåˆ¶ï¼ˆç±»ä¼¼äº View çš„ onTouchEventï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ä¸ªæ‰©å±•å‡½æ•°ï¼šModifier.pointerInput()ã€‚ 12345678910111213141516class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.size(40.dp) .background(Color.Green) .pointerInput(Unit) { detectTapGestures() } ) } } }} æˆ‘ä»¬æ¥çœ‹çœ‹ detectTapGestures() å‡½æ•°ï¼š 123456suspend fun PointerInputScope.detectTapGestures( onDoubleTap: ((Offset) -&gt; Unit)? = null, // åŒå‡» onLongPress: ((Offset) -&gt; Unit)? = null, // é•¿æŒ‰ onPress: suspend PressGestureScope.(Offset) -&gt; Unit = NoPressGesture, // è§¦æ‘¸åˆ°å³è§¦å‘ onTap: ((Offset) -&gt; Unit)? = null // å•å‡») å®ƒä¸€æ ·å¯ä»¥ç›‘å¬åŒå‡»ã€é•¿æŒ‰ã€å•å‡»äº‹ä»¶ï¼Œå”¯ç‹¬å¤šäº†ä¸€ä¸ª onPressï¼Œé‚£è·Ÿ combinedClickable æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ Modifier.combinedClickable() å’Œ detectTapGestures() çš„åŒºåˆ«åœ¨äºå®ƒä»¬çš„çº§åˆ«æˆ–è€…è¯´å®šåˆ¶æ·±åº¦ä¸Šæ˜¯ä¸åŒçš„ï¼ŒdetectTapGestures() æ˜¯æ›´åº•å±‚çš„ä¸€ç§å®ç°ï¼Œå®é™…ä¸Š Modifier.combinedClickable() åº•å±‚ä¹Ÿæ˜¯ä½¿ç”¨ detectTapGestures() å®ç°çš„ã€‚ 123456789101112131415161718192021@ExperimentalFoundationApifun Modifier.combinedClickable(...) = composed(...) { Modifier.combinedClickable(...)}@ExperimentalFoundationApifun Modifier.combinedClickable(...) = composed( factory = { ... ... val gesture = Modifier.pointerInput(interactionSource, hasLongClick, hasDoubleClick, enabled) { centreOffset.value = size.center.toOffset() detectTapGestures( onDoubleTap = ..., onLongPress = ..., onPress = ..., // onPress å¹¶æ²¡æœ‰æš´éœ²å‡ºæ¥ onTap = ... ) } ... ...) å¦‚æœè¿˜è¦åšæ›´å¤æ‚çš„è§¦æ‘¸åé¦ˆä¸”å®Œå…¨ç”±æˆ‘ä»¬è‡ªå·±æ§åˆ¶ï¼ŒCompose è¿˜æä¾›äº† awaitPointerEventScope()ï¼Œè®©æˆ‘ä»¬å¯ä»¥ç›‘å¬æ¯ä¸ªè§¦æ‘¸äº‹ä»¶ï¼š 123456789101112131415161718192021class MainActivity : ComponentActivity() { @OptIn(ExperimentalFoundationApi::class) override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.size(40.dp) .background(Color.Green) .combinedClickable { } .pointerInput(Unit) { awaitPointerEventScope { // è¿™é‡Œé¢å°±è¦å®Œå…¨è‡ªå®šä¹‰è§¦æ‘¸äº‹ä»¶å¤„ç†é€»è¾‘äº† val down = awaitFirstDown() // è·å–ä¸€ä¸ªæŒ‰å‹äº‹ä»¶ } } ) } } }} è¿™æ ·å°±å¯ä»¥åœ¨ awaitPointerEventScope å†…éƒ¨è¿›è¡Œè§¦æ‘¸äº‹ä»¶å¤„ç†äº†ï¼Œä½†å¾€å¾€æˆ‘ä»¬è¿˜ä¼šç»™ awaitPointerEventScope å¥—ä¸€å±‚ forEachGestureã€‚ 123456789101112131415161718192021222324class MainActivity : ComponentActivity() { @OptIn(ExperimentalFoundationApi::class) override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { Box(Modifier.size(40.dp) .background(Color.Green) .combinedClickable { } .pointerInput(Unit) { forEachGesture { awaitPointerEventScope { val down = awaitFirstDown() } } } ) { } } } }} forEachGesture() ï¼šå¾ªç¯æ£€æµ‹æ¯ä¸ªäº‹ä»¶ï¼Œå¦åˆ™ awaitPointerEventScope() ç›‘å¬ä¸€æ¬¡ç‚¹å‡»ä¹‹åå°±ä¼šå¤±æ•ˆã€‚ å…¶å® detectTapGestures å†…éƒ¨ä¹Ÿæ˜¯ç”¨ awaitPointerEventScope() å®ç°çš„ï¼š 1234567891011suspend fun PointerInputScope.detectTapGestures(...) = coroutineScope { val pressScope = PressGestureScopeImpl(this@detectTapGestures) forEachGesture { awaitPointerEventScope { val down = awaitFirstDown() down.consume() ... ... } }} Modifier.pointerInput() å†…éƒ¨ä½¿ç”¨çš„ detectXxxGesture() å‡ ä¹æ— ä¸€ä¾‹å¤–éƒ½æ˜¯ä½¿ç”¨çš„è¯¥æ–¹æ¡ˆç›‘å¬è§¦æ‘¸äº‹ä»¶ã€‚ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/149a2f06efeb34d151021e4efe132e58.png =700x) è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»ç®€å•äº†è§£äº† Modifier.pointerIput() æ€ä¹ˆä½¿ç”¨ï¼Œæ¥ä¸‹æ¥å¼€å§‹åˆ†æå®šåˆ¶çš„è§¦æ‘¸åé¦ˆæ˜¯æ€ä¹ˆå½±å“åˆ°ç•Œé¢å±•ç¤ºçš„ã€‚ å¦‚æœä½ å·²ç»çœ‹è¿‡ ã€ DrawModifier åŸç†è§£æã€‘ çš„æ–‡ç« ï¼Œé‚£ä¹ˆå¯¹ PointerInputModifier çš„å¤„ç†ä½ç½®åº”è¯¥ä¼šä¸é™Œç”Ÿäº†ã€‚ æˆ‘ä»¬ç›´æ¥çœ‹æºç ï¼š 12345678910111213141516171819202122232425262728293031override var modifier: Modifier = Modifier set(value) { ... ... val outerWrapper = modifier.foldOut(innerLayoutNodeWrapper) { mod, toWrap -&gt; if (mod is RemeasurementModifier) { mod.onRemeasurementAvailable(this) } toWrap.entities.addBeforeLayoutModifier(toWrap, mod) // here if (mod is OnGloballyPositionedModifier) { getOrCreateOnPositionedCallbacks() += toWrap to mod } val wrapper = if (mod is LayoutModifier) { // Re-use the layoutNodeWrapper if possible. (reuseLayoutNodeWrapper(toWrap, mod) ?: ModifiedLayoutNode(toWrap, mod)).apply { onInitialize() updateLookaheadScope(mLookaheadScope) } } else { toWrap } wrapper.entities.addAfterLayoutModifier(wrapper, mod) wrapper } ... ... } å¯¹ PointerInputModifier çš„å¤„ç†å’Œ DrawModifier ä¸€æ ·ï¼š 1toWrap.entities.addBeforeLayoutModifier(toWrap, mod) // here æˆ‘ä»¬è·Ÿè¸ªè¿›å»ï¼š 123456789fun addBeforeLayoutModifier(layoutNodeWrapper: LayoutNodeWrapper, modifier: Modifier) { if (modifier is DrawModifier) { add(DrawEntity(layoutNodeWrapper, modifier), DrawEntityType.index) } if (modifier is PointerInputModifier) { add(PointerInputEntity(layoutNodeWrapper, modifier), PointerInputEntityType.index) } ... ...} ç°åœ¨çœ‹å°±å¾ˆæ˜æ˜¾äº†ï¼ŒPointerInputModifier è·Ÿ DrawModifier çš„å­˜å‚¨æ–¹å¼ä¸€æ‘¸ä¸€æ ·ã€‚åœ¨å­˜å‚¨æ—¶ä¹Ÿä¼šå°† PointerInputModifier åŒ…è£…åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œåç»­æ–°åŠ çš„ PointerInputModifier ä¼šç”¨å¤´æ’æ³•æ’å…¥é“¾è¡¨å¤´éƒ¨ã€‚ é‚£ä¹ˆåˆ†æåˆ°è¿™é‡Œå°±å¯ä»¥æœ‰ä¸¤ä¸ªçŒœæµ‹ï¼š 1ã€æ—¢ç„¶ DrawModifier ä¹Ÿæ˜¯å¯¹æœ€æ¥è¿‘çš„å³è¾¹çš„ LayoutModifier ç”Ÿæ•ˆï¼ŒPointerInputModifier æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Ÿ 123// PointerInputModifier å¯¹å³è¾¹çš„ LayoutModifier ç”Ÿæ•ˆ// æƒ³è¦å¯¹å“ªä¸ª LayoutModifier ç”Ÿæ•ˆï¼Œå°±æŠŠ PointerInputModifier å†™åœ¨å“ªä¸ªçš„å·¦è¾¹Modifier.pointerInput().padding() 2ã€è¿ç»­çš„ PointerInputModifierï¼Œæœ€å·¦è¾¹çš„ PointerInputModifier ä¼šåŒ…å«å³è¾¹çš„ PointerInputModifierï¼Ÿ 123// ä¸¤ä¸ª PointerInputModifier å½±å“ç€ LayoutModifier// ä¸¤ä¸ª PointerInputModifier æ˜¯çˆ¶å­å…³ç³»ï¼Œæœ€å·¦è¾¹çš„ PointerInputModifier ç®¡ç†å³è¾¹çš„ PointerInputModifier Modifier.pointerInput().pointerInput().size() ç°åœ¨æˆ‘ä»¬ä»æºç è§’åº¦æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªçŒœæµ‹æ˜¯å¦æ­£ç¡®ã€‚ 1234567891011121314151617// LayoutNode.ktinternal fun hitTest( pointerPosition: Offset, hitTestResult: HitTestResult&lt;PointerInputFilter&gt;, isTouchEvent: Boolean = false, isInLayer: Boolean = true) { val positionInWrapped = outerLayoutNodeWrapper.fromParentPosition(pointerPosition) outerLayoutNodeWrapper.hitTest( LayoutNodeWrapper.PointerInputSource, positionInWrapped, hitTestResult, isTouchEvent, isInLayer )} hitTest() å®é™…ä¸Šæ˜¯åšçš„æ£€æµ‹å·¥ä½œï¼Œä¸»è¦çš„ä½œç”¨æ˜¯æ£€æŸ¥è§¦æ‘¸äº‹ä»¶åº”è¯¥ä¸‹å‘ç»™å“ªä¸ªç»„ä»¶ï¼Œæ£€æµ‹åå†æŠŠäº‹ä»¶åˆ†å‘åˆ°å¯¹åº”ç»„ä»¶ã€‚ 12345678910111213141516171819202122232425// LayoutNodeWrapper.ktfun &lt;T : LayoutNodeEntity&lt;T, M&gt;, C, M : Modifier&gt; hitTest( hitTestSource: HitTestSource&lt;T, C, M&gt;, pointerPosition: Offset, hitTestResult: HitTestResult&lt;C&gt;, isTouchEvent: Boolean, isInLayer: Boolean) { val head = entities.head(hitTestSource.entityType()) // è·å– PointerInputModifier é“¾è¡¨çš„å¤´éƒ¨ if (!withinLayerBounds(pointerPosition)) { ... ... } else if (isPointerInBounds(pointerPosition)) { // A real hit head.hit( hitTestSource, pointerPosition, hitTestResult, isTouchEvent, isInLayer ) } else { ... ... }} ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ head.hit()ï¼š 123456789101112131415161718// LayoutNodeWrapper.ktprivate fun &lt;T : LayoutNodeEntity&lt;T, M&gt;, C, M : Modifier&gt; T?.hit( hitTestSource: HitTestSource&lt;T, C, M&gt;, pointerPosition: Offset, hitTestResult: HitTestResult&lt;C&gt;, isTouchEvent: Boolean, isInLayer: Boolean) { if (this == null) { hitTestChild(hitTestSource, pointerPosition, hitTestResult, isTouchEvent, isInLayer) } else { // æ ¸å¿ƒä»£ç  hitTestResult.hit(hitTestSource.contentFrom(this), isInLayer) { next.hit(hitTestSource, pointerPosition, hitTestResult, isTouchEvent, isInLayer) } }} é¦–å…ˆéœ€è¦äº†è§£ä¸€ä¸‹ï¼šhitTestSource.contentFrom(this) åšäº†ä»€ä¹ˆï¼Ÿâ€“ è¿”å›äº† PointerInputModifier é“¾è¡¨çš„å¤´èŠ‚ç‚¹å†…éƒ¨åŒ…å«çš„ PointerInputModifier è‡ªèº«ã€‚ ç°åœ¨æˆ‘ä»¬å†å¾€ä¸‹è·Ÿè¸ªï¼š 12345// HitTestResult.ktfun hit(node: T, isInLayer: Boolean, childHitTest: () -&gt; Unit) { hitInMinimumTouchTarget(node, -1f, isInLayer, childHitTest)} åˆè°ƒç”¨äº† hitInMinimumTouchTarget()ï¼š 123456789101112131415161718// HitTestResult.ktfun hitInMinimumTouchTarget( node: T, // 1. è¿™é‡Œçš„ node å°±æ˜¯ä¼ è¿›æ¥çš„ PointInputModifier distanceFromEdge: Float, isInLayer: Boolean, childHitTest: () -&gt; Unit) { val startDepth = hitDepth hitDepth++ ensureContainerSize() values[hitDepth] = node // 2. å°† PointInputModifier æ”¾è¿›ä¸€ä¸ªæ•°ç»„é‡Œï¼Œè®°å½•æ¯ä¸ªèŠ‚ç‚¹ distanceFromEdgeAndInLayer[hitDepth] = DistanceAndInLayer(distanceFromEdge, isInLayer).packedValue resizeToHitDepth() childHitTest() // 3. åˆè°ƒç”¨äº† childHitTest() hitDepth = startDepth} childHitTest æ˜¯ä¼ è¿›æ¥çš„ï¼Œå¾€å›æ‰¾å°±ä¼šå‘ç°å…¶å® childHitTest å°±æ˜¯ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/4aade82133ca282c85f3885865ad19f6.png =700x) çœ‹åˆ°äº† next ï¼Ÿè¿›è¡Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ hit å‡½æ•°å¤„ç†ï¼Œå…¸å‹çš„é€’å½’è°ƒç”¨äº†ã€‚ æ‰€ä»¥çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†çœ‹å›åˆšæ‰çš„ä¸¤ä¸ªçŒœæƒ³ï¼š 1ã€æ—¢ç„¶ DrawModifier ä¹Ÿæ˜¯å¯¹æœ€æ¥è¿‘çš„å³è¾¹çš„ LayoutModifier ç”Ÿæ•ˆï¼ŒPointerInputModifier æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Ÿ 2ã€è¿ç»­çš„ PointerInputModifierï¼Œæœ€å·¦è¾¹çš„ PointerInputModifier ä¼šåŒ…å«å³è¾¹çš„ PointerInputModifierï¼Ÿ è¿™ä¸¤æ¡çŒœæƒ³éƒ½æ˜¯æ­£ç¡®çš„ï¼","link":"/2024/09/23/Compose%20--%20Modifier%20--%2005.%20%E8%A7%A3%E6%9E%90%20PointerInputModifier/"},{"title":"ä¸€æ–‡å½»åº•åƒé€ Compose ä¸­çš„å‰¯ä½œç”¨ï¼ˆé™„å¸¦æ•ˆåº”ï¼‰","text":"Compose å®˜æ–¹ï¼šå‰¯ä½œç”¨ï¼ˆé™„å¸¦æ•ˆåº”ï¼‰æ˜¯æŒ‡å‘ç”Ÿåœ¨å¯ç»„åˆå‡½æ•°ä½œç”¨åŸŸä¹‹å¤–çš„åº”ç”¨çŠ¶æ€çš„å˜åŒ–ã€‚ ä¸ºä»€ä¹ˆä¸èƒ½æœ‰å‰¯ä½œç”¨ï¼Ÿé¦–å…ˆéœ€è¦æ˜ç™½ Compose ä¸­å…³äºé‡ç»„ï¼ˆRecomposeï¼‰çš„ä¸€ä¸ªå…³é”®ç‰¹ç‚¹ï¼šå¯ç»„åˆå‡½æ•°å¯ä»¥æŒ‰ä»»ä½•é¡ºåºæ‰§è¡Œã€‚ è¿™æ˜¯ä¸€ä¸ªå®˜æ–¹çš„ç¤ºä¾‹ä»£ç ï¼Œç”¨äºåœ¨æ ‡ç­¾é¡µå¸ƒå±€ä¸­ç»˜åˆ¶ä¸‰ä¸ªé¡µé¢ï¼š 12345678@Composablefun ButtonRow() { MyFancyNavigation { StartScreen() MiddleScreen() EndScreen() }} æŒ‰ç…§ä¼ ç»Ÿçš„åº”ç”¨å¼€å‘æ€ç»´ï¼Œè¿™ç§ä»£ç ç»“æ„æ„å‘³ç€ä¸‰ä¸ªé¡µé¢çš„ç»˜åˆ¶æ˜¯æŒ‰å…¶å‡ºç°çš„é¡ºåºä¾æ¬¡è¿è¡Œçš„ã€‚ä½†å…¶å®ä¸æ˜¯ï¼Œå¦‚æœæŸä¸ªå¯ç»„åˆå‡½æ•°åŒ…å«å¯¹å…¶ä»–å¯ç»„åˆå‡½æ•°çš„è°ƒç”¨ï¼Œè¿™äº›å‡½æ•°å¯ä»¥æŒ‰ä»»ä½•é¡ºåºè¿è¡Œã€‚Compose å¯ä»¥é€‰æ‹©è¯†åˆ«å‡ºæŸäº›ç•Œé¢å…ƒç´ çš„ä¼˜å…ˆçº§é«˜äºå…¶ä»–ç•Œé¢å…ƒç´ ï¼Œå› è€Œé¦–å…ˆç»˜åˆ¶è¿™äº›å…ƒç´ ã€‚ è¿™å°±æ„å‘³ç€å¯¹ StartScreenã€MiddleScreen å’Œ EndScreen çš„è°ƒç”¨å¯ä»¥æŒ‰ä»»ä½•é¡ºåºè¿›è¡Œçš„ã€‚ é‚£ä¹ˆçœ‹ä¸‹é¢çš„æ“ä½œåœºæ™¯ï¼š 123456789@Composablefun ButtonRow() { MyFancyNavigation { // 1. è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªå…¨å±€å˜é‡ StartScreen() // 3. å†…éƒ¨ä¿®æ”¹äº†è¿™ä¸ªå…¨å±€å˜é‡ MiddleScreen() // 2. å†…éƒ¨è¦ä½¿ç”¨è¿™ä¸ªå˜é‡ EndScreen() }} å‰é¢æˆ‘ä»¬è¯´äº†ï¼Œä¸‰ä¸ªå¯ç»„åˆå‡½æ•°çš„è°ƒç”¨é¡ºåºæ˜¯ä¸å®šçš„ï¼Œå¦‚æœæŒ‰ç…§ 1 -&gt; 3 -&gt; 2 çš„é¡ºåºè°ƒç”¨ï¼Œé‚£ä¹ˆåŠŸèƒ½å°±ä¼šå‡ºé”™ï¼Œè¿™ç§è¡Œä¸ºå°±æ˜¯æ‰€è°“çš„ï¼šå‘ç”Ÿåœ¨å¯ç»„åˆå‡½æ•°ä½œç”¨åŸŸä¹‹å¤–çš„åº”ç”¨çŠ¶æ€çš„å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯ï¼šå‰¯ä½œç”¨ï¼ˆé™„å¸¦æ•ˆåº”ï¼‰ã€‚ æ‰€ä»¥ Compose å®˜æ–¹å»ºè®®ï¼šå¯ç»„åˆé¡¹åœ¨ç†æƒ³æƒ…å†µä¸‹åº”è¯¥æ˜¯æ— å‰¯ä½œç”¨çš„ï¼ ä¸è¿‡ä½ ä¹Ÿæ³¨æ„åˆ°äº†ï¼šæ˜¯ç†æƒ³æƒ…å†µä¸‹ä¸åº”è¯¥æœ‰å‰¯ä½œç”¨ï¼Œä½†æœ‰æ—¶å‰¯ä½œç”¨åˆæ˜¯å¿…è¦çš„ï¼Œå®ƒå¾ˆæœ‰ç”¨ï¼ ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å‰¯ä½œç”¨ï¼ŸCompose ä¸­å‰¯ä½œç”¨çš„ç›®çš„ï¼šå…è®¸æ‰§è¡Œä¸ UI æ— å…³çš„æ“ä½œï¼Œè¿™äº›æ“ä½œä»¥å¯æ§ä¸”å¯é¢„æµ‹çš„æ–¹å¼æ›´æ”¹å¯ç»„åˆå‡½æ•°ä¹‹å¤–çš„åº”ç”¨çŠ¶æ€ã€‚ å‰¯ä½œç”¨ï¼ˆå¦‚æ›´æ–°æ•°æ®åº“æˆ–è¿›è¡Œç½‘ç»œè°ƒç”¨ï¼‰åº”ä¸ UI å‘ˆç°é€»è¾‘åˆ†å¼€ï¼Œä»¥æé«˜ä»£ç çš„æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚ Compose æä¾›äº†å¤šä¸ªå¯ç»„åˆå‡½æ•°ï¼Œä¾‹å¦‚ SideEffectã€LaunchedEffect å’Œ DisposableEffectï¼Œè¿™äº›å‡½æ•°ä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿæœ‰æ•ˆåœ°ç®¡ç†å‰¯ä½œç”¨ï¼Œæ–¹æ³•æ˜¯å°†å®ƒä»¬ä¸ç•Œé¢æ¸²æŸ“é€»è¾‘åˆ†ç¦»å¹¶åœ¨å•ç‹¬çš„åç¨‹èŒƒå›´å†…æ‰§è¡Œå®ƒä»¬ã€‚ åœ¨ Compose ä¸­ä½¿ç”¨å‰¯ä½œç”¨çš„ä¸»è¦å¥½å¤„æ˜¯ï¼š æ”¹è¿›çš„æ€§èƒ½ï¼š é€šè¿‡åœ¨å¯ç»„åˆå‡½æ•°ä¹‹å¤–æ‰§è¡Œä¸ UI æ— å…³çš„æ“ä½œï¼ŒUI å‘ˆç°é€»è¾‘å¯ä»¥ä¿æŒå“åº”å’Œæ€§èƒ½ã€‚ æ›´å¥½çš„ä»£ç ç»„ç»‡ï¼š é€šè¿‡å°†é UI ç›¸å…³æ“ä½œä¸ UI å‘ˆç°é€»è¾‘åˆ†ç¦»ï¼Œä»£ç åº“å˜å¾—æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚ æ›´å¥½çš„è°ƒè¯•ï¼š å‰¯ä½œç”¨å¯ç”¨äºæ—¥å¿—è®°å½•å’Œåˆ†ææ“ä½œï¼ˆæ¯”å¦‚åŸ‹ç‚¹ï¼‰ï¼Œè¿™å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°äº†è§£åº”ç”¨çš„è¡Œä¸ºå¹¶è¯†åˆ«é—®é¢˜ã€‚ æ€»ä¹‹ï¼ŒCompose ä¸­å‰¯ä½œç”¨çš„ç›®çš„æ˜¯é€šè¿‡å°†é UI ç›¸å…³æ“ä½œä¸ UI æ¸²æŸ“é€»è¾‘åˆ†ç¦»æ¥æé«˜ä»£ç åº“çš„æ€§èƒ½ã€å¯ç»´æŠ¤æ€§å’Œè°ƒè¯•ã€‚ å‰¯ä½œç”¨ğŸ““ SideEffectSideEffect ä¸»è¦ç”¨äºåœ¨ä¸å½±å“ UI æ€§èƒ½çš„æƒ…å†µä¸‹æ‰§è¡Œå‰¯ä½œç”¨ã€‚ SideEffect åº”è¯¥ç®—æ˜¯æœ€ç®€å•çš„å‰¯ä½œç”¨å‡½æ•°äº†ã€‚æˆ‘ä»¬éœ€è¦åœ¨ Composable å‡½æ•°ä¸­è°ƒç”¨å®ƒï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªåŒ…å«æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å‰¯ä½œç”¨çš„ lambdaã€‚ æ¯”å¦‚çœ‹ä¸‹é¢è¿™ä¸ªä»£ç ï¼š 123456789101112131415@Composablefun Counter() { val count = remember { mutableStateOf(0) } // å®šä¹‰ä¸€ä¸ªç”¨äºè®¡æ•°çš„çŠ¶æ€å˜é‡ SideEffect { // ä½¿ç”¨ SideEffect è®°å½• count çš„å½“å‰å€¼ println(&quot;Count is ${count.value}&quot;) // æ¯æ¬¡é‡ç»„æ—¶ä¼šè°ƒç”¨ } Column { Button(onClick = { count.value++ }) { Text(&quot;Increase Count&quot;) } Text(&quot;Counter ${count.value}&quot;) // æ¯æ¬¡çŠ¶æ€æ›´æ–°æ—¶ï¼Œæ–‡æœ¬éƒ½ä¼šæ›´æ”¹å¹¶è§¦å‘é‡ç»„ }} åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæ¯å½“é‡æ„ Counter å‡½æ•°æ—¶ï¼ŒSideEffect å‡½æ•°éƒ½ä¼šè®°å½• count çŠ¶æ€å˜é‡çš„å½“å‰å€¼ã€‚ ä½†æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œä»…å½“å½“å‰å¯ç»„åˆå‡½æ•°è¢«é‡æ„æ—¶ï¼Œæ‰ä¼šè§¦å‘å‰¯ä½œç”¨ï¼Œè€Œå¯¹äºä»»ä½•åµŒå¥—çš„å¯ç»„åˆå‡½æ•°ï¼Œåˆ™ä¸ä¼šè§¦å‘ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæœ‰ä¸€ä¸ª Composable å‡½æ•°è°ƒç”¨å¦ä¸€ä¸ª Composable å‡½æ•°ï¼Œåˆ™åœ¨é‡æ„å†…éƒ¨ Composable å‡½æ•°æ—¶ï¼Œä¸ä¼šè§¦å‘å¤–éƒ¨ Composable å‡½æ•°ä¸­çš„ SideEffectã€‚ ä»€ä¹ˆæ„æ€ï¼Ÿæ¯”å¦‚ï¼Œæˆ‘æŠŠä»£ç æ”¹æˆè¿™æ ·ï¼š 1234567891011121314@Composablefun Counter() { val count = remember { mutableStateOf(0) } // å®šä¹‰ä¸€ä¸ªç”¨äºè®¡æ•°çš„çŠ¶æ€å˜é‡ SideEffect { // ä½¿ç”¨ SideEffect è®°å½• count çš„å½“å‰å€¼ println(&quot;Count is ${count.value}&quot;) // æ¯æ¬¡é‡ç»„æ—¶ä¼šè°ƒç”¨ } Column { Button(onClick = { count.value++ }) { Text(&quot;Increase Count ${count.value}&quot;) // æ¯æ¬¡ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œè¿™ç§é‡ç»„ä¸ä¼šè§¦å‘å¤–éƒ¨å‰¯ä½œç”¨ } }} åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå•å‡» Button æ—¶ï¼ŒText å¯ç»„åˆé¡¹å°†ä½¿ç”¨æ–°å€¼ count é‡æ–°ç»„åˆï¼Œä½†è¿™ä¸ä¼šå†æ¬¡è§¦å‘ SideEffectã€‚ ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ å†…éƒ¨å‰¯ä½œç”¨ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š 1234567891011121314151617@Composablefun Counter() { val count = remember { mutableStateOf(0) } // å®šä¹‰ä¸€ä¸ªç”¨äºè®¡æ•°çš„çŠ¶æ€å˜é‡ SideEffect { // ä½¿ç”¨ SideEffect è®°å½• count çš„å½“å‰å€¼ println(&quot;Count is ${count.value}&quot;) // æ¯æ¬¡é‡ç»„æ—¶ä¼šè°ƒç”¨ } Column { Button(onClick = { count.value++ }) { SideEffect { println(&quot;@@@ Count is ${count.value}&quot;) // æ¯æ¬¡é‡ç»„æ—¶ä¼šè°ƒç”¨ } Text(&quot;Increase Count ${count.value}&quot;) // æ¯æ¬¡ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œè¿™ç§é‡ç»„ä¸ä¼šè§¦å‘å¤–éƒ¨å‰¯ä½œç”¨ } }} å†çœ‹ä¸‹è¿è¡Œæ•ˆæœï¼š è¿™ä¸ªæ—¶å€™ count å˜åŒ–å°±ä¼šå¼•å‘é‡ç»„ï¼Œä»è€Œ SideEffect ä¼šè¢«è°ƒç”¨ã€‚ä¸€èˆ¬åŸ‹ç‚¹çš„éœ€æ±‚åœºæ™¯ï¼Œå°±å¾ˆé€‚åˆç”¨è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ç»Ÿè®¡é¡µé¢æˆ–è€…ç»„ä»¶çš„æ›å…‰ã€‚ ğŸ““ DisposableEffectDisposableEffect å¯ä»¥ç†è§£ä¸º SideEffect çš„å‡çº§æ¬¾ï¼Œå®ƒä¸ä»…å¯ä»¥å®ç° SideEffect çš„æ•ˆæœï¼Œè€Œä¸”å†…éƒ¨è¿˜æä¾›äº†ä¸€ä¸ª onDispose() æ–¹æ³•ï¼Œç”¨äºå½“æŸå¯ç»„åˆé¡¹ä» UI é¡µé¢æ¶ˆå¤±æ—¶åšä¸€äº›é‡Šæ”¾èµ„æºçš„æ“ä½œã€‚ æ¯”å¦‚ï¼šDisposableEffect å‡½æ•°å¯ç”¨äºç®¡ç†ä¸å†ä½¿ç”¨å¯ç»„åˆé¡¹æ—¶éœ€è¦æ¸…ç†çš„èµ„æºï¼Œä¾‹å¦‚äº‹ä»¶ä¾¦å¬å™¨æˆ–åŠ¨ç”»ã€‚ ä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨ DisposableEffect çš„ç¤ºä¾‹: 12345678910111213141516171819202122232425@Composablefun TimerScreen() { val elapsedTime = remember { mutableStateOf(0) } DisposableEffect(Unit) { val scope = CoroutineScope(Dispatchers.Default) val job = scope.launch { while (true) { delay(1000) elapsedTime.value += 1 println(&quot;@@@ Timer is still working ${elapsedTime.value}&quot;) } } onDispose { job.cancel() } } Text( text = &quot;Elapsed Time: ${elapsedTime.value}&quot;, modifier = Modifier.padding(16.dp), fontSize = 24.sp )} åœ¨æ­¤ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ DisposableEffect å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œè¯¥åç¨‹æ¯ç§’é€’å¢ elapsedTime çŠ¶æ€å€¼ã€‚æˆ‘ä»¬è¿˜ä½¿ç”¨ DisposableEffect æ¥ç¡®ä¿åœ¨ä¸å†ä½¿ç”¨å¯ç»„åˆé¡¹æ—¶å–æ¶ˆåç¨‹ï¼Œå¹¶æ¸…ç†åç¨‹ä½¿ç”¨çš„èµ„æºã€‚ åœ¨ DisposableEffect çš„ onDispose å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å­˜å‚¨åœ¨ job ä¸­çš„ Job å®ä¾‹çš„ cancel() æ–¹æ³•å–æ¶ˆåç¨‹ã€‚ å½“ Composable ä» UI å±‚æ¬¡ç»“æ„ä¸­åˆ é™¤æ—¶ï¼Œå°†è°ƒç”¨ onDispose å‡½æ•°ï¼Œå®ƒæä¾›äº†ä¸€ç§æ¸…ç† Composable ä½¿ç”¨çš„ä»»ä½•èµ„æºçš„æ–¹æ³•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ onDispose æ¥å–æ¶ˆåç¨‹ï¼Œå¹¶ç¡®ä¿æ¸…ç†åç¨‹ä½¿ç”¨çš„ä»»ä½•èµ„æºã€‚ ç°åœ¨é‡æ–°ä¿®æ”¹ä»£ç ï¼Œæ·»åŠ  Text() ç»„ä»¶æ˜¾ç¤ºä¸å¦çš„é€»è¾‘ï¼Œè®©æˆ‘ä»¬è¿è¡Œä»¥ä¸‹ä»£ç æ¥æŸ¥çœ‹ç»“æœï¼š 12345678910111213141516171819202122232425262728class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { RunTimerScreen() } }}@Composablefun RunTimerScreen() { val isVisible = remember { mutableStateOf(true) } Column( horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Bottom ) { Spacer(modifier = Modifier.height(10.dp)) if (isVisible.value) TimerScreen() Button(onClick = { isVisible.value = !isVisible.value }) { Text(&quot;Hide the timer&quot;) } }} ä¸Šé¢ä»£ç ä¸­ï¼Œæ·»åŠ äº†ä¸€ä¸ªæ–°çš„ RunTimerScreen å¯ç»„åˆé¡¹ï¼Œå…è®¸ç”¨æˆ·åˆ‡æ¢ TimerScreen çš„å¯è§æ€§ã€‚å½“ç”¨æˆ·å•å‡»â€œHide the timerâ€æŒ‰é’®æ—¶ï¼ŒTimerScreen å¯ç»„åˆé¡¹å°†ä» UI å±‚æ¬¡ç»“æ„ä¸­åˆ é™¤ï¼Œåç¨‹å°†è¢«å–æ¶ˆå¹¶æ¸…ç†ã€‚ ä½†æ˜¯è¦æ³¨æ„ï¼š å¦‚æœä½ åœ¨ onDispose å‡½æ•°ä¸­æ²¡æœ‰æ·»åŠ  job.cancel()ï¼Œå³ä½¿ TimerScreen å¯ç»„åˆé¡¹æ¶ˆå¤±ï¼Œåç¨‹ä¹Ÿä¼šç»§ç»­è¿è¡Œï¼Œè¿™å°±å¯èƒ½ä¼šå¯¼è‡´æ³„æ¼å’Œå…¶ä»–æ€§èƒ½é—®é¢˜ã€‚ ğŸ““ LaunchedEffectLaunchedEffect æ˜¯ä¸€ä¸ª Composable å‡½æ•°ï¼Œç”¨äºåœ¨å•ç‹¬çš„åç¨‹ä½œç”¨åŸŸä¸­æ‰§è¡Œå‰¯ä½œç”¨ã€‚æ­¤å‡½æ•°å¯ç”¨äºæ‰§è¡Œå¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´çš„æ“ä½œï¼ˆä¾‹å¦‚ç½‘ç»œè°ƒç”¨æˆ–åŠ¨ç”»ï¼‰ï¼Œè€Œä¸ä¼šé˜»å¡ UI çº¿ç¨‹ã€‚ å®ƒéœ€è¦ä¸¤ä¸ªå‚æ•° key å’Œ coroutineScope å—ã€‚ 123456789class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { LaunchedEffect(key1 = , block = ) } }} 1234fun LaunchedEffect( key1: Any?, block: suspend CoroutineScope.() -&gt; Unit) åœ¨ key å‚æ•°ä¸­ï¼Œä½ å¯ä»¥ä¼ é€’ä»»ä½•çŠ¶æ€ï¼Œå› ä¸ºå®ƒæ˜¯ Any ç±»å‹ã€‚ åœ¨ coroutineScope å—ä¸­ï¼Œæ‚¨å¯ä»¥ä¼ é€’ä»»ä½•æŒ‚èµ·æˆ–éæŒ‚èµ·çš„å‡½æ•°ã€‚ LaunchEffect å°†å§‹ç»ˆåœ¨å¯ç»„åˆå‡½æ•°ä¸­åªè¿è¡Œä¸€æ¬¡ã€‚å¦‚æœè¦å†æ¬¡è¿è¡Œ LaunchEffectï¼Œåˆ™å¿…é¡»åœ¨ key å‚æ•°ä¸­ä¼ é€’éšæ—¶é—´å˜åŒ–çš„ä»»ä½•çŠ¶æ€ï¼ˆmutableStateOf ï¼ŒStateFlowï¼‰ã€‚ ä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨ LaunchedEffect çš„ç¤ºä¾‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { LaunchedEffectComposable() } }}@Composablefun LaunchedEffectComposable() { val isLoading = remember { mutableStateOf(false) } val data = remember { mutableStateOf(listOf&lt;String&gt;()) } // å®šä¹‰ä¸€ä¸ª LaunchedEffect æ¥å¼‚æ­¥æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼Œ // å¦‚æœ isLoading.value å‘ç”Ÿå˜åŒ–ï¼ŒLaunchedEffect å°†å–æ¶ˆå¹¶é‡æ–°å¯åŠ¨ LaunchedEffect(isLoading.value) { if (isLoading.value) { val newData = fetchData() // æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚ä»ç½‘ç»œè·å–æ•°æ® data.value = newData // ä½¿ç”¨æ–°æ•°æ®æ›´æ–°çŠ¶æ€ isLoading.value = false } } Column { Button(onClick = { isLoading.value = true }) { Text(&quot;Fetch Data&quot;) } if (isLoading.value) { CircularProgressIndicator() // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨ } else { LazyColumn { items(data.value.size) { index -&gt; Text(text = data.value[index]) } } } }}// é€šè¿‡æš‚åœåç¨‹ 3 ç§’æ¥æ¨¡æ‹Ÿç½‘ç»œè°ƒç”¨private suspend fun fetchData(): List&lt;String&gt; { // Simulate a network delay delay(3000) return listOf(&quot;Item 1&quot;, &quot;Item 2&quot;, &quot;Item 3&quot;, &quot;Item 4&quot;, &quot;Item 5&quot;,)} åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå½“ isLoading çŠ¶æ€å˜é‡è®¾ç½®ä¸º true æ—¶ï¼ŒLaunchedEffect å‡½æ•°æ‰§è¡Œç½‘ç»œè°ƒç”¨ä»¥ä» API è·å–æ•°æ®ã€‚è¯¥å‡½æ•°åœ¨å•ç‹¬çš„åç¨‹ä½œç”¨åŸŸä¸­æ‰§è¡Œï¼Œå…è®¸ UI åœ¨æ‰§è¡Œæ“ä½œæ—¶ä¿æŒå“åº”ã€‚ LaunchedEffect å‡½æ•°é‡‡ç”¨ä¸¤ä¸ªå‚æ•°ï¼škeyï¼ˆè®¾ç½®ä¸º isLoading.valueï¼‰å’Œ blockï¼ˆå®šä¹‰è¦æ‰§è¡Œçš„å‰¯ä½œç”¨çš„ lambdaï¼‰ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œblock lambda è°ƒç”¨ fetchData() å‡½æ•°ï¼Œè¯¥å‡½æ•°é€šè¿‡æš‚åœåç¨‹ 3 ç§’é’Ÿæ¥æ¨¡æ‹Ÿç½‘ç»œè°ƒç”¨ã€‚è·å–æ•°æ®åï¼Œå®ƒä¼šæ›´æ–° data çŠ¶æ€å˜é‡å¹¶å°† isLoading è®¾ç½®ä¸º falseï¼Œä»è€Œéšè—åŠ è½½æŒ‡ç¤ºç¬¦å¹¶æ˜¾ç¤ºè·å–çš„æ•°æ®ã€‚ LaunchedEffect å‚æ•°èƒŒåçš„é€»è¾‘ï¼š LaunchedEffect ä¸­çš„ key å‚æ•°ç”¨äºæ ‡è¯† LaunchedEffect å®ä¾‹ï¼Œå¹¶é˜²æ­¢å…¶è¢«ä¸å¿…è¦åœ°é‡æ„ã€‚ é‡æ„å¯ç»„åˆé¡¹æ—¶ï¼ŒJetpack Compose ä¼šç¡®å®šæ˜¯å¦éœ€è¦é‡ç»˜è¯¥é¡¹ã€‚å¦‚æœå¯ç»„åˆé¡¹çš„çŠ¶æ€æˆ–å±æ€§å·²æ›´æ”¹ï¼Œæˆ–è€…å¯ç»„åˆé¡¹è°ƒç”¨invalidateï¼Œåˆ™ Jetpack Compose å°†é‡æ–°ç»˜åˆ¶å¯ç»„åˆé¡¹ã€‚é‡ç»˜å¯ç»„åˆé¡¹å¯èƒ½æ˜¯ä¸€é¡¹æˆæœ¬é«˜æ˜‚çš„æ“ä½œï¼Œç‰¹åˆ«æ˜¯å¦‚æœå¯ç»„åˆé¡¹åŒ…å«é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œæˆ–ä¸éœ€è¦åœ¨æ¯æ¬¡é‡æ„å¯ç»„åˆé¡¹æ—¶é‡æ–°æ‰§è¡Œçš„å‰¯ä½œç”¨ã€‚ é€šè¿‡å‘ LaunchedEffect æä¾› key å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ªå”¯ä¸€æ ‡è¯† LaunchedEffect å®ä¾‹çš„å€¼ã€‚å¦‚æœ key å‚æ•°çš„å€¼å‘ç”Ÿå˜åŒ–ï¼ŒJetpack Compose ä¼šå°† LaunchedEffect å®ä¾‹è§†ä¸ºæ–°å®ä¾‹ï¼Œå¹¶å†æ¬¡æ‰§è¡Œå‰¯ä½œç”¨ã€‚å¦‚æœ key å‚æ•°çš„å€¼ä¿æŒä¸å˜ï¼ŒJetpack Compose å°†è·³è¿‡å‰¯ä½œç”¨çš„æ‰§è¡Œï¼Œå¹¶é‡å¤ä½¿ç”¨ä¹‹å‰çš„ç»“æœï¼Œä»è€Œé˜²æ­¢ä¸å¿…è¦çš„é‡ç»„ã€‚ ğŸ““ rememberCoroutineScoperememberCoroutineScope æ˜¯ Compose ä¸­çš„ä¸€ä¸ªå¯ç»„åˆå‡½æ•°ï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ªä¸å½“å‰ç»„åˆå…³è”çš„åç¨‹èŒƒå›´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­è°ƒç”¨ä»»ä½•æŒ‚èµ·å‡½æ•°ã€‚ æ­¤åç¨‹ä½œç”¨åŸŸå¯ç”¨äºå¯åŠ¨æ–°çš„åç¨‹ï¼Œå½“ç»„åˆï¼ˆå¯ç»„åˆå‡½æ•°ï¼‰ä¸å†å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶ï¼Œè¿™äº›åç¨‹ä¼šè‡ªåŠ¨å–æ¶ˆã€‚ rememberCoroutineScope() åˆ›å»ºçš„ CoroutineScope å¯¹è±¡æ˜¯æ¯ä¸ªç»„åˆçš„å•ä¾‹ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœåœ¨åŒä¸€ç»„åˆä¸­å¤šæ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œå®ƒå°†è¿”å›ç›¸åŒçš„åç¨‹ä½œç”¨åŸŸå¯¹è±¡ã€‚ çœ‹å¦‚ä¸‹ä»£ç ç¤ºä¾‹ï¼š 12345678910111213141516171819202122232425262728class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { MyComponent() } }}@Composablefun MyComponent() { val coroutineScope = rememberCoroutineScope() val data = remember { mutableStateOf(&quot;&quot;) } Column { Button(onClick = { coroutineScope.launch { // Simulate network call delay(2000) data.value = &quot;Data loaded&quot; } }) { Text(&quot;Load data&quot;) } Text(text = data.value) }} æ­¤å¤„ï¼ŒrememberCoroutineScope ç”¨äºåˆ›å»ºä¸ Composable å‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šçš„åç¨‹èŒƒå›´ã€‚è¿™æ ·ä¸€æ¥ï¼Œä½ å°±å¯ä»¥é«˜æ•ˆã€å®‰å…¨åœ°ç®¡ç†åç¨‹ï¼Œç¡®ä¿å¯ç»„åˆå‡½æ•°æ¶ˆå¤±æ—¶å–æ¶ˆåç¨‹ã€‚æ‚¨å¯ä»¥åœ¨èŒƒå›´å†…ä½¿ç”¨ launchåŠŸèƒ½ï¼Œè½»æ¾å®‰å…¨åœ°ç®¡ç†å¼‚æ­¥æ“ä½œã€‚ å‰¯ä½œç”¨çŠ¶æ€ğŸ““ rememberUpdateStateå¦‚æœè¦å¼•ç”¨ä¸€ä¸ªå€¼ï¼Œå¦‚æœè¯¥å€¼å‘ç”Ÿæ›´æ”¹ï¼Œåˆ™ä¸åº”é‡æ–°å¯åŠ¨ï¼Œè¯·ä½¿ç”¨ rememberUpdatedStateã€‚å½“å…³é”®å‚æ•°çš„å€¼ä¹‹ä¸€æ›´æ–°æ—¶ï¼ŒLaunchedEffect ä¼šé‡æ–°å¯åŠ¨ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›åœ¨ä¸é‡æ–°å¯åŠ¨çš„æƒ…å†µä¸‹æ•è·æ•ˆæœä¸­æ›´æ”¹çš„å€¼ã€‚å¦‚æœæˆ‘ä»¬æœ‰é•¿æ—¶é—´è¿è¡Œçš„é€‰é¡¹ï¼Œé‡æ–°å¯åŠ¨æˆæœ¬å¾ˆé«˜ï¼Œåˆ™æ­¤è¿‡ç¨‹ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚ 12345678910111213141516171819202122232425262728class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var dynamicData by remember { mutableStateOf(&quot;&quot;) } LaunchedEffect(Unit) { delay(3000L) dynamicData = &quot;New Compose Text&quot; } MyComponent(title = dynamicData) } }}@Composablefun MyComponent(title: String) { var data by remember { mutableStateOf(&quot;Hi, Compose&quot;) } val updatedData by rememberUpdatedState(title) LaunchedEffect(Unit) { delay(5000L) data = updatedData } Text(text = data)} æœ€åˆï¼Œtitle æ˜¯ä¸€ä¸ª â€œHi, Composeâ€ã€‚3 ç§’åï¼Œtitle å˜ä¸ºâ€œNew Compose Textâ€ã€‚5 ç§’åï¼Œdataä¹Ÿä¼šå˜ä¸ºâ€œNew Compose Textâ€ï¼Œä»è€Œè§¦å‘ UI çš„é‡æ„ã€‚è¿™å°†æ›´æ–° Text å¯ç»„åˆé¡¹ã€‚å› æ­¤ï¼Œæ€»å»¶è¿Ÿä¸º 5 ç§’ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ rememberUpdatedStateï¼Œé‚£ä¹ˆæˆ‘ä»¬å¿…é¡»é‡æ–°å¯åŠ¨ç¬¬äºŒä¸ª LaunchedEffectï¼Œè¿™å°†éœ€è¦ 8 ç§’ã€‚ ğŸ““ produceStateproduceState ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œè¯¥åç¨‹å°†ä½œç”¨åŸŸé™å®šä¸ºå¯å°†å€¼æ¨é€åˆ°è¿”å›çš„ State çš„ç»„åˆã€‚ä½¿ç”¨æ­¤åç¨‹å°†é Compose çŠ¶æ€è½¬æ¢ä¸º Compose çŠ¶æ€ï¼Œä¾‹å¦‚å°†å¤–éƒ¨è®¢é˜…é©±åŠ¨çš„çŠ¶æ€ï¼ˆå¦‚ Flowã€LiveData æˆ– RxJavaï¼‰å¼•å…¥ç»„åˆã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®˜æ–¹ç¤ºä¾‹ï¼šå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ produceState ä»ç½‘ç»œåŠ è½½å›¾åƒã€‚ 1234567891011121314151617181920212223@Composablefun loadNetworkImage( url: String, imageRepository: ImageRepository): State&lt;Result&lt;Image&gt;&gt; { // Creates a State&lt;T&gt; with Result.Loading as initial value // If either `url` or `imageRepository` changes, the running producer // will cancel and will be re-launched with the new inputs. return produceState&lt;Result&lt;Image&gt;&gt;(initialValue = Result.Loading, url, imageRepository) { // In a coroutine, can make suspend calls val image = imageRepository.load(url) // Update State with either an Error or Success result. // This will trigger a recomposition where this State is read value = if (image == null) { Result.Error } else { Result.Success(image) } }} loadNetworkImage å¯ç»„åˆå‡½æ•°ä¼šè¿”å›å¯ä»¥åœ¨å…¶ä»–å¯ç»„åˆé¡¹ä¸­ä½¿ç”¨çš„ Stateã€‚ ğŸ““ snapshotFlowsnapshotFlow ä¸»è¦ç”¨äºè£… Compose çš„ State è½¬æ¢æˆåç¨‹ Flowã€‚ ä½¿ç”¨ snapshotFlow å¯ä»¥å°† Compose çš„ State å¯¹è±¡è½¬æ¢ä¸ºå†· Flowï¼ˆå†·æµï¼‰ã€‚snapshotFlow ä¼šåœ¨æ”¶é›†åˆ°å—æ—¶è¿è¡Œè¯¥å—ï¼Œå¹¶å‘å‡ºä»å—ä¸­è¯»å–çš„ State å¯¹è±¡çš„ç»“æœã€‚å½“åœ¨ snapshotFlow å—ä¸­è¯»å–çš„ State å¯¹è±¡ä¹‹ä¸€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¦‚æœæ–°å€¼ä¸ä¹‹å‰å‘å‡ºçš„å€¼ä¸ç›¸ç­‰ï¼ŒFlow ä¼šå‘å…¶æ”¶é›†å™¨å‘å‡ºæ–°å€¼ã€‚ è¿™æ®µè§£é‡Šæ¥è‡ªå®˜ç½‘ï¼Œå¦‚æœæ¯”è¾ƒéš¾ä»¥ç†è§£ï¼Œæˆ‘ä»¬æ‹†åˆ†ä¸‹æ ¸å¿ƒæ€æƒ³ï¼š snapshotFlow å¯ä»¥æŠŠ Compose çš„ State çŠ¶æ€å¯¹è±¡è½¬æˆåç¨‹çš„ Flow Flow å¯ä»¥åŒæ­¥ State çŠ¶æ€ï¼Œè·å–åˆ°æœ€æ–°çš„å€¼ å½“ State å˜åŒ–ï¼ŒFlow ä¹Ÿä¼šå‘æ”¶é›†å™¨å‘é€æ–°å€¼ snapshotFlow ä¸ä»…ä»…åªèƒ½è¯»å–ä¸€ä¸ª Compose State å¯¹è±¡ï¼Œå¯ä»¥æ˜¯å¤šä¸ªï¼Œåªè¦ä¸€ä¸ªå˜åŒ–å³å¯ã€‚ å¦‚æœè¿˜æ˜¯å¾ˆéš¾æ‡‚ï¼Œçœ‹å®Œä¸‹é¢çš„ä»£ç ï¼Œä½ å°±ä¼šæ˜ç™½ã€‚ 1234567891011121314151617class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { var name by remember { mutableStateOf(&quot;Hi, Compose&quot;) } val flow = snapshotFlow { name } LaunchedEffect(Unit) { flow.collect { println(&quot;@@@: $it&quot;) } } } } }} è®©æˆ‘æ¥è§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç ï¼š é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª Compose çš„çŠ¶æ€å¯¹è±¡ï¼šname ç”¨ snapshotFlow å‡½æ•°æŠŠ name åŒ…èµ·æ¥ï¼Œæ­¤æ—¶å°±ä¼šå¾—åˆ°ä¸€ä¸ª Flow å¯¹è±¡ã€‚ï¼ˆæ»¡è¶³æ ¸å¿ƒæ€æƒ³ 1ï¼‰ åœ¨åç¨‹é‡Œé¢ä½ å°±å¯ä»¥é€šè¿‡ flow.collect è·å–åˆ° â€œHi, Composeâ€ã€‚ï¼ˆæ»¡è¶³æ ¸å¿ƒæ€æƒ³ 2ï¼‰ ç°åœ¨æˆ‘æ¥æ”¹ä¸‹è¿™æ®µä»£ç ï¼š 12345678910111213141516171819202122class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { var name by remember { mutableStateOf(&quot;Hi, Compose&quot;) } Button(onClick = { name = &quot;Hi, Kotlin&quot; }) { Text(&quot;ä¿®æ”¹ nameï¼Œæµ‹è¯•æµå€¼æ˜¯å¦å˜åŒ–&quot;) } val flow = snapshotFlow { name } LaunchedEffect(Unit) { flow.collect { println(&quot;@@@: $it&quot;) } } } } }} ä»£ç ä¸­ä»…ä»…å°±æ·»åŠ ä¸€ä¸ª Buttonï¼Œä¿®æ”¹ Compose çš„ State çŠ¶æ€å€¼ï¼Œä» â€œHi, Composeâ€ æ”¹æˆ â€œHi, Kotlinâ€ã€‚ éšç€ Compose çš„ State å¯¹è±¡ name çš„å€¼æ”¹å˜ï¼ŒFlow ä¹Ÿä¼šåŒæ­¥æ”¶åˆ°æœ€æ–°çš„å€¼ã€‚ï¼ˆç¬¦åˆæ ¸å¿ƒæ€æƒ³ 3ï¼‰ ç°åœ¨ï¼Œæˆ‘ä»¬å†æ”¹ä¸‹ä»£ç ï¼š 1234567891011121314151617181920212223class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { ComposeBlogTheme { var name by remember { mutableStateOf(&quot;Hi, Compose&quot;) } var age by remember { mutableStateOf(20) } Button(onClick = { age = 26 }) { Text(&quot;ä¿®æ”¹ nameï¼Œæµ‹è¯•æµå€¼æ˜¯å¦å˜åŒ–&quot;) } val flow = snapshotFlow { &quot;$name, $age&quot; } LaunchedEffect(Unit) { flow.collect { println(&quot;@@@: $it&quot;) } } } } }} æˆ‘æ–°å¢äº†ä¸€ä¸ª Compose çš„ State å¯¹è±¡ï¼šageï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒsnapshotFlow å°±åŒ…äº†ä¸¤ä¸ª State å¯¹è±¡ï¼Œå†æµ‹è¯•ä¸€ä¸‹æ•ˆæœï¼š ç‚¹å‡» Button åä¿®æ”¹äº† age çŠ¶æ€çš„å€¼ï¼ŒFlow ä¹Ÿä¼šæ”¶åˆ°æ–°å€¼ï¼Œè§¦å‘ Log è¾“å‡ºã€‚ï¼ˆç¬¦åˆæ ¸å¿ƒæ€æƒ³ 4ï¼‰ å¦å¤–ï¼Œè¿™é‡Œçš„ä»£ç ç¤ºä¾‹å¤ªç®€å•äº†ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå¦‚æœä½ çš„éœ€æ±‚æ˜¯éœ€è¦åœ¨åç¨‹ä¸­è·å–åˆ° Compose çš„çŠ¶æ€ï¼Œç„¶åé’ˆå¯¹è¿™äº›æœ€æ–°çš„çŠ¶æ€å€¼åšä¸€äº›åç»­æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥è€ƒè™‘ snapshotFlowã€‚","link":"/2024/10/09/Compose%20--%20%E5%89%AF%E4%BD%9C%E7%94%A8%20&%20%E5%8D%8F%E7%A8%8B%20--%20%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E5%90%83%E9%80%8F%20Compose%20%E4%B8%AD%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%EF%BC%88%E9%99%84%E5%B8%A6%E6%95%88%E5%BA%94%EF%BC%89/"},{"title":"çŠ¶æ€è½¬ç§»å‹åŠ¨ç”» APIï¼šanimate*AsState()","text":"animate*AsState å‡½æ•°åº”è¯¥ç®—æ˜¯ Jetpack Compose ä¸­æœ€ç®€å•çš„ä¸€ç»„åŠ¨ç”» API äº†ï¼Œä¸»è¦ç”¨äºå°†æŸä¸ª UI çŠ¶æ€çš„å˜åŒ–å¹³æ»‘è¿‡æ¸¡æˆåŠ¨ç”»ã€‚å®ƒå¯ä»¥å¸®åŠ©å¼€å‘è€…åœ¨çŠ¶æ€åˆ‡æ¢æ—¶ï¼Œé€šè¿‡åŠ¨ç”»ä½¿ç•Œé¢æ›´è‡ªç„¶åœ°è¿‡æ¸¡ã€‚ è¯´çš„ç›´ç™½ä¸€ç‚¹ï¼Œå®ƒä¸»è¦ç”¨äºä¸ºå•ä¸ªå€¼æ·»åŠ åŠ¨ç”»æ•ˆæœã€‚ä½ åªéœ€æä¾›ç»“æŸå€¼ï¼ˆæˆ–ç›®æ ‡å€¼ï¼‰ï¼Œè¯¥ API å°±ä¼šä»å½“å‰å€¼å¼€å§‹å‘æŒ‡å®šå€¼æ’­æ”¾åŠ¨ç”»ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆæ„å»ºä¸€ä¸ªç®€å•åœºæ™¯ï¼š 12345678910111213141516171819202122232425class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .height(90.dp) .absoluteOffset(x = 0.dp) ) Button(onClick = {}, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} è¿™æ˜¯ä¸€ä¸ªæå…¶ç®€å•çš„åœºæ™¯ï¼šä¸€ä¸ªå›¾ç‰‡ï¼Œä¸€ä¸ª Buttonï¼Œåˆå§‹æ•ˆæœå¦‚ä¸‹ï¼š ç°åœ¨æˆ‘ä»¬è®©å°åˆºçŒ¬åŠ¨èµ·æ¥ï¼ˆä»å·¦åˆ°å³ï¼‰ï¼Œä»£ç å¯ä»¥è¿™æ ·å†™ï¼š 12345678910111213141516171819202122232425262728class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var offset by remember { mutableStateOf(0.dp) } // å®šä¹‰åç§»å˜é‡ Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .height(90.dp) .absoluteOffset(x = offset) // è·å–åç§»å€¼ ) Button( onClick = { offset = 335.dp }, // ä¿®æ”¹åç§»å€¼ modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} å¦‚æ³¨é‡Šè¯´æ˜ï¼Œæˆ‘åªä¿®æ”¹äº†ä¸‰ä¸ªåœ°æ–¹ï¼Œç°åœ¨æ¥çœ‹ä¸‹æ•ˆæœï¼š å°åˆºçŒ¬ç¡®å®åŠ¨èµ·æ¥äº†ï¼Œä½†æ˜¯è¿™ç§æ•ˆæœç»™äººçš„æ„Ÿè§‰å°±å¾ˆç”Ÿç¡¬ï¼Œå®Œå…¨ç§°ä¸ä¸Šæ˜¯åŠ¨ç”»ï¼Œæ›´åƒæ˜¯ â€œç¬é—´ç§»åŠ¨â€ã€‚ ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹å°è¯•ç”¨ animate*AsState æ”¹å–„åŠ¨ç”»æ•ˆæœï¼Œå†™æ³•å¾ˆç®€å•ï¼š 1234567891011121314151617181920212223242526272829class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { // var offset by remember { mutableStateOf(0.dp) } // å®šä¹‰åç§»å˜é‡ var offset by remember { animateDpAsState(0.dp) } // æ›¿æ¢ä¸º animateDpAsState Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .height(90.dp) .absoluteOffset(x = offset) // è·å–åç§»å€¼ ) Button( onClick = { offset = 335.dp }, // ä¿®æ”¹åç§»å€¼ modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»…ä»…ç”¨ animateDpAsState æ›¿æ¢ mutableStateOf åï¼Œå°±å¯ä»¥å¯¹æ•°å€¼çš„å¤§å°å®ç°æ¸å˜çš„è°ƒæ•´ï¼Œä½†å¾ˆé—æ†¾ï¼Œè¿™æ ·ç›´æ¥æ›¿æ¢æ˜¯æœ‰çº¢çº¿æŠ¥é”™çš„ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·ä¿®å¤è¿™ä¸ªæŠ¥é”™ï¼Œæœ€ç»ˆæ¨å¯¼å‡º animateDpAsState çš„æ­£ç¡®å†™æ³•ã€‚ é¦–å…ˆæˆ‘ä»¬å›é¡¾ä¸‹ remember çš„ä½œç”¨ï¼šå®ƒæ˜¯é˜²æ­¢å˜é‡è¢«å¤šæ¬¡é‡å¤åˆå§‹åŒ–çš„ï¼Œè€Œ animateDpAsState å¤©ç”Ÿè‡ªå¸¦è¿™ä¸ªèƒ½åŠ›ï¼ˆå®ƒçš„æºç å†…éƒ¨æ˜¯åŒ…äº† remember çš„ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥å»æ‰ rememberã€‚ å†æ¥å›é¡¾ä¸‹ by çš„ä½œç”¨ï¼šæŠŠå·¦è¾¹ offset å˜é‡å§”æ‰˜ç»™å³è¾¹çš„ mutableStateOfï¼ŒmutableStateOf æä¾›äº†è¯»å’Œå†™çš„åŠŸèƒ½ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„äº†ï¼Œæˆ‘ä»¬å¯¹æ¯”ä¸‹ mutableStateOf å’Œ animateDpAsState å‡½æ•°çš„å®šä¹‰ï¼š 1234fun &lt;T&gt; mutableStateOf( value: T, policy: SnapshotMutationPolicy&lt;T&gt; = structuralEqualityPolicy()): MutableState&lt;T&gt; = createSnapshotMutableState(value, policy) 1234567@Composablefun animateDpAsState( targetValue: Dp, animationSpec: AnimationSpec&lt;Dp&gt; = dpDefaultSpring, label: String = &quot;DpAnimation&quot;, finishedListener: ((Dp) -&gt; Unit)? = null): State&lt;Dp&gt; { } mutableStateOf è¿”å›çš„æ˜¯ä¸€ä¸ª MutableState å¯¹è±¡animateDpAsState è¿”å›çš„æ˜¯ä¸€ä¸ª State å¯¹è±¡ åœ¨ Compose ä¸­ï¼ŒState å¯¹è±¡åªæä¾›è¯»çš„åŠŸèƒ½ï¼Œä½ æ˜¯æ²¡åŠæ³•å†™çš„ï¼ä½†ä¾‹å­ä¸­ var å°±ä»£è¡¨ offset æ˜¯å¯å†™çš„ï¼Œè¿™å°±å†²çªäº†ã€‚ å…¶å® Android Studio çš„æŠ¥é”™ä¹Ÿæç¤ºæˆ‘ä»¬äº†ã€‚ æ‰€ä»¥ç°åœ¨æˆ‘ä»¬æŠŠ var æ”¹æˆ valï¼š è¿™é‡Œç‰¹åˆ«è¯´æ˜ä¸€ä¸‹ï¼š æ³¢æµªçº¿æç¤ºæ˜¯å› ä¸ºéšç€å®˜æ–¹ API çš„æ›´æ–°ï¼Œä¸å¸¦ label å‚æ•°çš„ animateDpAsState å‡½æ•°è¢«å¼ƒç”¨äº†ã€‚ 12345678910@Deprecated( &quot;animate*AsState APIs now have a new label parameter added.&quot;, level = DeprecationLevel.HIDDEN)@Composablefun animateDpAsState( targetValue: Dp, animationSpec: AnimationSpec&lt;Dp&gt; = dpDefaultSpring, finishedListener: ((Dp) -&gt; Unit)? = null) å®˜æ–¹å»ºè®®æˆ‘ä»¬ä½¿ç”¨å¸¦ label å‚æ•°çš„ animateDpAsStateï¼Œæ‰€ä»¥å¦‚æœä½ å°±æ˜¯ä¸æƒ³åŠ ï¼Œä¹Ÿä¸ä¼šå½±å“ç¨‹åºè¿è¡Œï¼ˆè‡³äºä¸ºä»€ä¹ˆå®˜æ–¹è¿™ä¹ˆå¼ºçƒˆå»ºè®®åŠ ä¸Šè¿™ä¸ª label æ ‡ç­¾ï¼Œä¼šåœ¨åˆ«çš„åŠ¨ç”»æ–‡ç« é‡Œé¢è¯´æ˜ï¼‰ã€‚ 1val offset by animateDpAsState(0.dp, label = &quot;&quot;) çº¢è‰²åœ°æ–¹æŠ¥é”™çš„åŸå› æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå› ä¸º offset ä¸å¯ä»¥æ‰‹åŠ¨å†™ï¼Œé‚£æˆ‘ä»¬è¯¥å¦‚ä½•ä¿®æ”¹ offset å€¼ï¼Ÿ ä»¥ä¸‹æ˜¯æ­£ç¡®çš„å†™æ³•ï¼š 123456789101112131415161718192021222324252627282930class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset by animateDpAsState(if (bicycleStart) 335.dp else 0.dp, label = &quot;&quot;) Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .height(90.dp) .absoluteOffset(x = offset) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} æ—¢ç„¶æ²¡æ³•æ‰‹åŠ¨ä¿®æ”¹å€¼ï¼Œè®©å°±é€šè¿‡æ”¹å˜å¦å¤–ä¸€ä¸ª bicycleStart çŠ¶æ€ï¼Œå¼•å‘é‡ç»„ï¼Œä»è€Œæ”¹å˜ animateDpAsState å†…éƒ¨çš„å€¼ã€‚ åˆ°è¿™é‡Œç¨‹åºå°±æ²¡æœ‰ä»»ä½•é”™è¯¯äº†ï¼Œè¿™ä¹Ÿæ˜¯ animateDpAsState çš„æ­£ç¡®å†™æ³•ï¼ ç°åœ¨ï¼Œè¿è¡Œä¸‹çœ‹çœ‹æ•ˆæœï¼šï¼ˆå¯¹æ¯” mutableStateOf å’Œ animateDpAsStateï¼‰ æ•ˆæœæ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œèµ·ç æˆ‘ä»¬èƒ½å¤Ÿçœ‹å‡ºæ¥è½¦æ˜¯å¼€èµ·æ¥äº†ï¼Œè€Œä¸æ˜¯ç¬é—´ç§»åŠ¨ã€‚ é™¤äº† Dpï¼ŒCompose ä¸º Floatã€Colorã€Sizeã€Offsetã€Rectã€Intã€IntOffset å’Œ IntSize éƒ½æä¾›äº†å¼€ç®±å³ç”¨çš„ animate*AsState å‡½æ•°ï¼Œç”¨æ³•å·®ä¸å¤šï¼Œä¸å†è¿‡å¤šä¸¾ä¾‹äº†ã€‚ è‡³æ­¤ï¼Œanimate*AsState() çš„åŸºæœ¬ç”¨æ³•äº†è§£å®Œäº†ï¼Œå°±è¿™ä¹ˆç®€å•ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜å¾—ç»†çœ‹ä¸‹è¿™ä¸ªå‡½æ•°çš„å®šä¹‰ï¼š 1234567@Composablefun animateDpAsState( targetValue: Dp, animationSpec: AnimationSpec&lt;Dp&gt; = dpDefaultSpring, label: String = &quot;DpAnimation&quot;, finishedListener: ((Dp) -&gt; Unit)? = null) å®ƒè¿˜æœ‰ä¸€ä¸ªæ ¸å¿ƒå‚æ•°ï¼šanimationSpecï¼Œå®ƒæ˜¯ AnimationSpec ç±»å‹ï¼Œä½ å¯ä»¥é€šè¿‡å¯é€‰çš„ AnimationSpec å‚æ•°æ¥è‡ªå®šä¹‰ã€ŒåŠ¨ç”»è§„èŒƒã€ï¼ˆä¹Ÿå°±æ˜¯å¯ä»¥å®ç°ä¸åŒç±»å‹çš„åŠ¨ç”»æ•ˆæœï¼‰ã€‚ AnimationSpec çš„å†…å®¹ç€å®ä¸å°‘ï¼Œä½œä¸ºå•ç‹¬çš„çŸ¥è¯†ç‚¹æ”¾åœ¨ã€ AnimationSpec åŠ¨ç”»è§„èŒƒ ã€‘ä¸€æ–‡ç»†è¯´ã€‚","link":"/2024/07/26/Compose%20--%20%E5%8A%A8%E7%94%BB%20--%2001.%20%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BB%E5%9E%8B%E5%8A%A8%E7%94%BB%20API%EF%BC%9Aanimate*AsState()/"},{"title":"æ­å¼€ LoaderTask çš„æ•°æ®åŠ è½½å¥¥ç§˜ -- AllApps","text":"Step 2: AllApps Workspace çš„å·¥ä½œä¸»è¦åˆ†ä¸ºï¼šã€ŒåŠ è½½å…¨éƒ¨åº”ç”¨ã€å’Œã€Œç»‘å®šå…¨éƒ¨åº”ç”¨ã€ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥åˆ†æã€‚ åŠ è½½ AllApps æµç¨‹è§£ææ ¸å¿ƒæ–¹æ³•ï¼šloadAllApps() è´Ÿè´£åŠ è½½å…¨éƒ¨åº”ç”¨ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/LoaderTask.javapublic class LoaderTask implements Runnable { /** * åŠ è½½æ‰€æœ‰ç”¨æˆ·çš„åº”ç”¨ç¨‹åºä¿¡æ¯ï¼ŒåŒ…æ‹¬å›¾æ ‡å’Œå…¶ä»–å…ƒæ•°æ®ï¼Œä¸»è¦ç”¨äº Launcher åŠ è½½æ˜¾ç¤º * * è¿”å›å€¼ï¼šList&lt;LauncherActivityInfo&gt;ï¼ŒåŒ…å«æ‰€æœ‰ç”¨æˆ·çš„åº”ç”¨åˆ—è¡¨ */ private List&lt;LauncherActivityInfo&gt; loadAllApps() { testLogD(WORK_TAB_MISSING, &quot;loadingAllApps&quot;); // ä» mUserCache è·å–æ‰€æœ‰ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼Œæ¯ä¸ªç”¨æˆ·å¯èƒ½æœ‰ä¸åŒçš„åº”ç”¨é›†åˆ final List&lt;UserHandle&gt; profiles = mUserCache.getUserProfiles(); // åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„åº”ç”¨åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨æœ€ç»ˆçš„ç»“æœ List&lt;LauncherActivityInfo&gt; allActivityList = new ArrayList&lt;&gt;(); // æ¸…ç©ºå½“å‰æ‰€æœ‰çš„åº”ç”¨åˆ—è¡¨ mBgAllAppsList.clear(); List&lt;IconRequestInfo&lt;AppInfo&gt;&gt; iconRequestInfos = new ArrayList&lt;&gt;(); // éå†æ¯ä¸ªç”¨æˆ· for (UserHandle user : profiles) { // æŸ¥è¯¢åº”ç”¨åˆ—è¡¨ final List&lt;LauncherActivityInfo&gt; apps = mLauncherApps.getActivityList(null, user); // å¦‚æœæŸä¸ªç”¨æˆ·æ²¡æœ‰åº”ç”¨åˆ™è¿”å›ç©ºåˆ—è¡¨ if (apps == null || apps.isEmpty()) { return allActivityList; } // å¤„ç†é™é»˜æ¨¡å¼ boolean quietMode = mUserManagerState.isUserQuiet(user); // åˆ›å»ºåº”ç”¨ä¿¡æ¯ for (int i = 0; i &lt; apps.size(); i++) { // å¯¹æ¯ä¸ªåº”ç”¨åˆ›å»º AppInfo å®ä¾‹ LauncherActivityInfo app = apps.get(i); AppInfo appInfo = new AppInfo(app, user, quietMode); // åˆ›å»º IconRequestInfo ç”¨äºå›¾æ ‡è¯·æ±‚ iconRequestInfos.add(new IconRequestInfo&lt;&gt;( appInfo, app, /* useLowResIcon= */ false)); mBgAllAppsList.add( appInfo, app, false); } allActivityList.addAll(apps); } if (FeatureFlags.PROMISE_APPS_IN_ALL_APPS.get()) { // get all active sessions and add them to the all apps list for (PackageInstaller.SessionInfo info : mSessionHelper.getAllVerifiedSessions()) { AppInfo promiseAppInfo = mBgAllAppsList.addPromiseApp( mApp.getContext(), PackageInstallInfo.fromInstallingState(info), false); if (promiseAppInfo != null) { iconRequestInfos.add(new IconRequestInfo&lt;&gt;( promiseAppInfo, /* launcherActivityInfo= */ null, promiseAppInfo.usingLowResIcon())); } } } Trace.beginSection(&quot;LoadAllAppsIconsInBulk&quot;); try { mIconCache.getTitlesAndIconsInBulk(iconRequestInfos); iconRequestInfos.forEach(iconRequestInfo -&gt; mBgAllAppsList.updateSectionName(iconRequestInfo.itemInfo)); } finally { Trace.endSection(); } mBgAllAppsList.setFlags(FLAG_QUIET_MODE_ENABLED, mUserManagerState.isAnyProfileQuietModeEnabled()); mBgAllAppsList.setFlags(FLAG_HAS_SHORTCUT_PERMISSION, hasShortcutsPermission(mApp.getContext())); mBgAllAppsList.setFlags(FLAG_QUIET_MODE_CHANGE_PERMISSION, mApp.getContext().checkSelfPermission(&quot;android.permission.MODIFY_QUIET_MODE&quot;) == PackageManager.PERMISSION_GRANTED); mBgAllAppsList.getAndResetChangeFlag(); // è¿”å› allActivityListï¼ŒåŒ…å«æ‰€æœ‰åŠ è½½çš„ LauncherActivityInfo å¯¹è±¡ return allActivityList; }} ç»‘å®š AllApps æµç¨‹è§£æç»‘å®š AllApps æ˜¯é€šè¿‡ LauncherBinder çš„ bindAllApps() å‡½æ•°ï¼Œåœ¨å…¶çˆ¶ç±» BaseLauncherBinder ä¸­å®šä¹‰ã€‚ 123456789101112131415161718192021222324252627282930ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.javapublic abstract class BaseLauncherBinder { /** * Binds the all apps results from LoaderTask to the callbacks UX. * * è´Ÿè´£å°†åº”ç”¨åˆ—è¡¨æ•°æ®ç»‘å®šåˆ° UI ä¸­ * * å®ƒä»åå°çš„åº”ç”¨åˆ—è¡¨ä¸­è·å–æ•°æ®ï¼Œæ„å»ºä¸€ä¸ªæ˜ å°„å…³ç³»ï¼Œç„¶åé€šè¿‡å›è°ƒå°†åº”ç”¨ä¿¡æ¯ä¼ é€’ç»™å‰å°çš„ UI çº¿ç¨‹æ¥æ›´æ–°æ˜¾ç¤º */ public void bindAllApps() { // ä»åå°åº”ç”¨åˆ—è¡¨ï¼šmBgAllAppsList ä¸­æµ…æ‹·è´å‡ºæ‰€æœ‰ AppInfo å®ä¾‹ï¼Œapps æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«äº†æ‰€æœ‰çš„åº”ç”¨ä¿¡æ¯ AppInfo[] apps = mBgAllAppsList.copyData(); // è·å–åº”ç”¨åˆ—è¡¨çš„æ ‡å¿—ä½ int flags = mBgAllAppsList.getFlags(); // ä½¿ç”¨ Java Stream APIï¼Œéå† apps æ•°ç»„ï¼Œåˆ›å»ºä¸€ä¸ª Map æ˜ å°„ Map&lt;PackageUserKey, Integer&gt; packageUserKeytoUidMap = Arrays.stream(apps).collect( Collectors.toMap( appInfo -&gt; new PackageUserKey(appInfo.componentName.getPackageName(), appInfo.user), appInfo -&gt; appInfo.uid, (a, b) -&gt; a)); // æ‰§è¡Œå›è°ƒä»»åŠ¡ executeCallbacksTask(c -&gt; c.bindAllApplications(apps, flags, packageUserKeytoUidMap), mUiExecutor); } } Launcher åŠ è½½å…¨éƒ¨åº”ç”¨1234567891011121314151617181920212223ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/Launcher.javapublic class Launcher extends StatefulActivity&lt;LauncherState&gt; implements LauncherExterns, Callbacks, InvariantDeviceProfile.OnIDPChangeListener, PluginListener&lt;LauncherOverlayPlugin&gt; { public void bindAllApplications(AppInfo[] apps, int flags, Map&lt;PackageUserKey, Integer&gt; packageUserKeytoUidMap) { // æ£€æŸ¥å½“å‰æ–¹æ³•æ˜¯å¦åœ¨ UI çº¿ç¨‹ä¸­æ‰§è¡Œ Preconditions.assertUIThread(); // ä» mAppsViewï¼šé€šå¸¸ä»£è¡¨åº”ç”¨æŠ½å±‰è§†å›¾ä¸­è·å– AllAppsStore å¯¹è±¡ AllAppsStore appsStore = mAppsView.getAppsStore(); // å°†åº”ç”¨æ•°æ®æ›´æ–°åˆ°å­˜å‚¨åº“ä¸­ appsStore.setApps(apps, flags, packageUserKeytoUidMap); // å…³é—­å¯èƒ½å·²å¤±æ•ˆçš„å¼¹å‡ºçª—å£ PopupContainerWithArrow.dismissInvalidPopup(this); if (Utilities.ATLEAST_S) { Trace.endAsyncSection(DISPLAY_ALL_APPS_TRACE_METHOD_NAME, DISPLAY_ALL_APPS_TRACE_COOKIE); } } appsStore.setApps()12345678910111213141516ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/allapps/AllAppsStore.javapublic class AllAppsStore { /** * Sets the current set of apps and sets mapping for {@link PackageUserKey} to Uid for * the current set of apps. */ public void setApps(AppInfo[] apps, int flags, Map&lt;PackageUserKey, Integer&gt; map) { mApps = apps; mModelFlags = flags; notifyUpdate(); mPackageUserKeytoUidMap = map; }} notifyUpdate()123456789101112131415161718ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/allapps/AllAppsStore.javapublic class AllAppsStore { private void notifyUpdate() { if (mDeferUpdatesFlags != 0) { mUpdatePending = true; return; } for (OnUpdateListener listener : mUpdateListeners) { if (TestProtocol.sDebugTracing) { Log.d(WORK_TAB_MISSING, &quot;AllAppsStore#notifyUpdate listener: &quot; + listener); } listener.onAppsUpdated(); } }} onAppsUpdated()1234567891011121314151617181920212223242526272829ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/allapps/ActivityAllAppsContainerView.javapublic class ActivityAllAppsContainerView&lt;T extends Context &amp; ActivityContext&gt; extends SpringRelativeLayout implements DragSource, Insettable, OnDeviceProfileChangeListener, PersonalWorkSlidingTabStrip.OnActivePageChangedListener, ScrimView.ScrimDrawingController { private void onAppsUpdated() { // æ£€æŸ¥æ˜¯å¦æœ‰ Work ç±»å‹çš„åº”ç”¨ mHasWorkApps = Stream.of(mAllAppsStore.getApps()).anyMatch(mWorkManager.getMatcher()); if (TestProtocol.sDebugTracing) { Log.d(WORK_TAB_MISSING, &quot;ActivityAllAppsContainerView#onAppsUpdated hasWorkApps: &quot; + mHasWorkApps + &quot; allApps: &quot; + mAllAppsStore.getApps().length); } // æ£€æŸ¥å½“å‰æ˜¯å¦å¤„äº Search æ¨¡å¼ if (!isSearching()) { rebindAdapters(); // é‡æ–°ç»‘å®šé€‚é…å™¨ï¼Œç”¨äºåˆ·æ–° UIï¼Œä½¿åº”ç”¨åˆ—è¡¨æ›´æ–° if (mHasWorkApps) { mWorkManager.reset(); } } // è®°å½•åº”ç”¨æ•°é‡çš„ç»Ÿè®¡æ•°æ® mActivityContext.getStatsLogManager().logger() .withCardinality(mAllAppsStore.getApps().length) .log(LAUNCHER_ALLAPPS_COUNT); }} rebindAdapters()123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101ğŸ“„ æºç è·¯å¾„ï¼špackage/app/Launcher3/src/com/android/launcher3/allapps/ActivityAllAppsContainerView.javapublic class ActivityAllAppsContainerView&lt;T extends Context &amp; ActivityContext&gt; extends SpringRelativeLayout implements DragSource, Insettable, OnDeviceProfileChangeListener, PersonalWorkSlidingTabStrip.OnActivePageChangedListener, ScrimView.ScrimDrawingController { protected void rebindAdapters() { rebindAdapters(false /* force */); } protected void rebindAdapters(boolean force) { // å¦‚æœæœç´¢åŠ¨ç”»æ­£åœ¨è¿›è¡Œä¸­ï¼Œåˆ™è®¾ç½® mRebindAdaptersAfterSearchAnimation ä¸º trueï¼Œ // åœ¨åŠ¨ç”»ç»“æŸåé‡æ–°ç»‘å®šé€‚é…å™¨ if (mSearchTransitionController.isRunning()) { mRebindAdaptersAfterSearchAnimation = true; return; } // æ›´æ–°æœç´¢ç»“æœçš„å¯è§æ€§ï¼Œç¡®ä¿æœç´¢ç»“æœçš„æ˜¾ç¤ºçŠ¶æ€ä¸å½“å‰å¸ƒå±€ä¸€è‡´ updateSearchResultsVisibility(); // å†³å®šæ˜¯å¦æ˜¾ç¤ºæ ‡ç­¾ï¼šTabsï¼Œç”¨äºåŒºåˆ†ä¸ªäººå’Œå·¥ä½œåº”ç”¨ boolean showTabs = shouldShowTabs(); if (showTabs == mUsingTabs &amp;&amp; !force) { return; } // å¦‚æœæ²¡æœ‰å¯ç”¨æœç´¢ç»“æœèƒŒæ™¯è£…é¥°ï¼Œåˆ™ä» RecyclerView ä¸­ç§»é™¤å¹¶é‡æ–°æ·»åŠ  ItemDecorationï¼Œä»¥ç¡®ä¿è§†è§‰æ•ˆæœçš„ä¸€è‡´æ€§ if (!FeatureFlags.ENABLE_SEARCH_RESULT_BACKGROUND_DRAWABLES.get()) { RecyclerView.ItemDecoration decoration = getMainAdapterProvider().getDecorator(); getSearchRecyclerView().removeItemDecoration(decoration); getSearchRecyclerView().addItemDecoration(decoration); } // replaceAppsRVcontainer() needs to use both mUsingTabs value to remove the old view AND // showTabs value to create new view. Hence the mUsingTabs new value assignment MUST happen // after this call. // æ ¹æ® showTabs çš„å€¼æ›¿æ¢åº”ç”¨åˆ—è¡¨çš„ RecyclerView å®¹å™¨ï¼Œä»¥ä¾¿åˆ‡æ¢åˆ°æ–°çš„å¸ƒå±€ replaceAppsRVContainer(showTabs); mUsingTabs = showTabs; // åœ¨æ›´æ–°è§†å›¾ä¹‹å‰ï¼Œå…ˆæ³¨é”€æ‰€æœ‰æ—§çš„å›¾æ ‡å®¹å™¨ï¼Œä»¥ç¡®ä¿æ–°å¸ƒå±€ä¸­çš„å›¾æ ‡èƒ½å¤Ÿæ­£ç¡®ç»‘å®š mAllAppsStore.unregisterIconContainer(mAH.get(AdapterHolder.MAIN).mRecyclerView); mAllAppsStore.unregisterIconContainer(mAH.get(AdapterHolder.WORK).mRecyclerView); mAllAppsStore.unregisterIconContainer(mAH.get(AdapterHolder.SEARCH).mRecyclerView); // å¦‚æœå¯ç”¨äº†æ ‡ç­¾æ¨¡å¼ if (mUsingTabs) { mAH.get(AdapterHolder.MAIN).setup(mViewPager.getChildAt(0), mPersonalMatcher); mAH.get(AdapterHolder.WORK).setup(mViewPager.getChildAt(1), mWorkManager.getMatcher()); mAH.get(AdapterHolder.WORK).mRecyclerView.setId(R.id.apps_list_view_work); if (FeatureFlags.ENABLE_EXPANDING_PAUSE_WORK_BUTTON.get()) { mAH.get(AdapterHolder.WORK).mRecyclerView.addOnScrollListener( mWorkManager.newScrollListener()); } mViewPager.getPageIndicator().setActiveMarker(AdapterHolder.MAIN); findViewById(R.id.tab_personal) .setOnClickListener((View view) -&gt; { if (mViewPager.snapToPage(AdapterHolder.MAIN)) { mActivityContext.getStatsLogManager().logger() .log(LAUNCHER_ALLAPPS_TAP_ON_PERSONAL_TAB); } mActivityContext.hideKeyboard(); }); findViewById(R.id.tab_work) .setOnClickListener((View view) -&gt; { if (mViewPager.snapToPage(AdapterHolder.WORK)) { mActivityContext.getStatsLogManager().logger() .log(LAUNCHER_ALLAPPS_TAP_ON_WORK_TAB); } mActivityContext.hideKeyboard(); }); setDeviceManagementResources(); onActivePageChanged(mViewPager.getNextPage()); } else { // å¦‚æœæœªå¯ç”¨æ ‡ç­¾æ¨¡å¼ï¼Œåˆ™åªè®¾ç½®ä¸»é¡µé¢ (MAIN)ï¼Œå¹¶å°† WORK çš„ RecyclerView è®¾ä¸º null mAH.get(AdapterHolder.MAIN).setup(findViewById(R.id.apps_list_view), null); mAH.get(AdapterHolder.WORK).mRecyclerView = null; } // é…ç½®åº”ç”¨æŠ½å±‰é¡¶éƒ¨çš„æ ‡é¢˜æ å†…å®¹ï¼Œä¾‹å¦‚æ·»åŠ æœç´¢æ æˆ–å…¶ä»–å·¥å…·æ å…ƒç´  setupHeader(); // é…ç½®æ»šåŠ¨æ¡ä½ç½® if (isSearchBarOnBottom()) { // Keep the scroller above the search bar. RelativeLayout.LayoutParams scrollerLayoutParams = (LayoutParams) mFastScroller.getLayoutParams(); scrollerLayoutParams.addRule(RelativeLayout.ABOVE, R.id.search_container_all_apps); scrollerLayoutParams.removeRule(RelativeLayout.ALIGN_PARENT_BOTTOM); scrollerLayoutParams.bottomMargin = getResources().getDimensionPixelSize( R.dimen.fastscroll_bottom_margin_floating_search); } // é‡æ–°æ³¨å†Œæ–°çš„å›¾æ ‡å®¹å™¨ mAllAppsStore.registerIconContainer(mAH.get(AdapterHolder.MAIN).mRecyclerView); mAllAppsStore.registerIconContainer(mAH.get(AdapterHolder.WORK).mRecyclerView); mAllAppsStore.registerIconContainer(mAH.get(AdapterHolder.SEARCH).mRecyclerView); }}","link":"/2024/11/01/Android%20--%20Launcher3%20--%2003.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%20--%20allapps/"},{"title":"æµç¨‹å®šåˆ¶å‹åŠ¨ç”» APIï¼šAnimatable()","text":"AnimatableAnimatable æ˜¯ä¸€ä¸ªå€¼å®¹å™¨ï¼Œä¼šåœ¨å†…éƒ¨å‚¨å­˜ä¸€ä¸ªå€¼ï¼Œå®ƒå¯ä»¥åœ¨é€šè¿‡ animateTo æ›´æ”¹å€¼æ—¶ä¸ºå€¼æ·»åŠ åŠ¨ç”»æ•ˆæœã€‚è¯¥ API æ”¯æŒ animate*AsState çš„å®ç°ã€‚å®ƒå¯ç¡®ä¿ä¸€è‡´çš„è¿ç»­æ€§å’Œäº’æ–¥æ€§ï¼Œè¿™æ„å‘³ç€å€¼å˜åŒ–å§‹ç»ˆæ˜¯è¿ç»­çš„ï¼Œå¹¶ä¸”ä¼šå–æ¶ˆä»»ä½•æ­£åœ¨æ’­æ”¾çš„åŠ¨ç”»ã€‚ Animatable çš„è®¸å¤šåŠŸèƒ½ï¼ˆåŒ…æ‹¬ animateToï¼‰ä»¥ â€œæŒ‚èµ·å‡½æ•°â€ çš„å½¢å¼æä¾›ã€‚è¿™æ„å‘³ç€ï¼Œå®ƒä»¬éœ€è¦å°è£…åœ¨é€‚å½“çš„ â€œåç¨‹ä½œç”¨åŸŸâ€ å†…ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ LaunchedEffect å¯ç»„åˆé¡¹é’ˆå¯¹æŒ‡å®šé”®å€¼çš„æ—¶é•¿åˆ›å»ºä¸€ä¸ªä½œç”¨åŸŸã€‚ ä¸‹é¢æˆ‘ä»¬ä»ä»£ç è§’åº¦ä¸€æ­¥æ­¥æ•™ä½  Animatable çš„ç”¨æ³•ï¼Œå¦‚ä¸‹ï¼š 123456789class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { val anim = Animatable() } }} æ³¨æ„ï¼šAnimatable å¯¼åŒ…çš„æ—¶å€™ä¸è¦é€‰é”™ï¼ï¼ï¼ æ­¤æ—¶ï¼Œå…‰ç§ƒç§ƒçš„å†™ä¸ª Animatable æ˜¯ä¼šæŠ¥é”™çš„ï¼š æç¤ºæˆ‘ä»¬æƒ³è¦ç”¨ Animatableï¼Œé‚£å°±å¾—ç”¨ remember åŒ…èµ·æ¥ï¼š åˆæç¤ºæˆ‘ä»¬éœ€è¦å¡«å†™ â€œåˆå§‹å€¼â€ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆå§‹å€¼å¡«ä»€ä¹ˆï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹ Animatable çš„å®šä¹‰ï¼š 12345678fun Animatable( initialValue: Float, visibilityThreshold: Float = Spring.DefaultDisplacementThreshold) = Animatable( initialValue, Float.VectorConverter, visibilityThreshold) å®ƒéœ€è¦ä¸€ä¸ª Float ç±»å‹çš„åˆå§‹å€¼ï¼š 123456789class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { val anim = remember { Animatable(0f) } } }} å½“ç„¶é™¤äº† Float ç±»å‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¡«å†™ Dp ç±»å‹ï¼Œä½†éœ€è¦è½¬æ¢ç±»å‹ï¼Œå¦‚ä¸‹è¿™æ ·å†™ä¹Ÿèƒ½æ»¡è¶³ Animatable çš„è¦æ±‚ï¼š 123456789class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { val anim = remember { Animatable(0.dp, Dp.VectorConverter) } } }} animateTo()ç°åœ¨ Animatable åˆ›å»ºå¥½äº†ï¼Œå®ƒå†…éƒ¨å­˜å‚¨äº†ä¸€ä¸ª Dp ç±»å‹çš„å€¼ã€‚æ¥ä¸‹æ¥å°±å¯ä»¥é…ç½®åŠ¨ç”»äº†ï¼Œè°ƒç”¨ animateTo() å‡½æ•°å³å¯ã€‚ æç¤ºæˆ‘ä»¬ï¼šanimateTo() æ˜¯ä¸ª suspend å‡½æ•°ï¼Œå¿…é¡»è¦åœ¨ã€Œåç¨‹ã€æˆ–è€…ã€Œåˆ«çš„æŒ‚èµ·å‡½æ•°ã€é‡Œé¢ä½¿ç”¨ï¼Œå¦‚ä¸‹ï¼š 123456789101112class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { val anim = remember { Animatable(0.dp, Dp.VectorConverter) } LaunchedEffect(Unit) { anim.animateTo() } } }} ç°åœ¨åªéœ€è¦åœ¨ animateTo() é‡Œé¢æ·»åŠ ç›®æ ‡å€¼å³å¯ã€‚ 123456789101112class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { val anim = remember { Animatable(0.dp, Dp.VectorConverter) } LaunchedEffect(Unit) { anim.animateTo(335.dp) } } }} åˆ°è¿™é‡Œ Animatable æ‰€éœ€è¦åšçš„å·¥ä½œå…¨éƒ¨å®Œæˆäº†ï¼ ç°åœ¨æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ã€ çŠ¶æ€è½¬ç§»å‹åŠ¨ç”» APIï¼šanimate*AsState() ã€‘ä¸€æ–‡ä¸­çš„å°åˆºçŒ¬ä½œä¸ºå¯¹è±¡ï¼Œä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset = remember(bicycleStart) { if (bicycleStart) 335.dp else 0.dp } val anim = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim.animateTo(offset) } Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim.value) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} è®©æˆ‘æ¥è§£è¯»ä¸‹è¿™æ®µä»£ç ï¼š å°åˆºçŒ¬éª‘è½¦çš„åç§»è·ç¦»å–å†³äº anim çš„å€¼ï¼Œå®ƒçš„å€¼ä¼šéšç€åŠ¨ç”»é€æ¸å˜åŒ–ã€‚ ç‚¹å‡» Button ä¼šæ”¹å˜ bicycleStart å€¼ï¼ŒbicycleStart å€¼å˜åŒ–ä¼šé‡æ–°æ‰§è¡Œ LaunchedEffect åç¨‹ï¼ŒanimateTo ä¼šæ‰§è¡Œï¼ŒåŠ¨ç”»å†æ¬¡å¯åŠ¨ã€‚ bicycleStart ä» false -&gt; trueï¼Œå°åˆºçŒ¬å¾€å‰éª‘ï¼Œtrue -&gt; falseï¼Œå°åˆºçŒ¬å¾€åéª‘ã€‚ è¿è¡Œï¼š æˆ‘ä»¬æŠŠ mutableStateOfã€animate*AsState å’Œ Animatable() ä¸‰è€…æ”¾åœ¨ä¸€èµ·ï¼Œåšä¸ªå¯¹æ¯”ï¼š Animatable çš„ animateTo() å¯ä»¥å®ç°å’Œ animateDpAsState ä¸€æ ·çš„æ•ˆæœï¼Œå…¶å® animateDpAsState å†…éƒ¨å®é™…ä¸Šä¹Ÿæ˜¯é€šè¿‡ Animatable å®ç°åŠ¨ç”»çš„ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ animateTo() å‡½æ•°çš„å‚æ•°ï¼š 123456suspend fun animateTo( targetValue: T, animationSpec: AnimationSpec&lt;T&gt; = defaultSpringSpec, initialVelocity: T = velocity, block: (Animatable&lt;T, V&gt;.() -&gt; Unit)? = null) å®ƒå’Œ animateDpAsState ä¸€æ ·ä¹Ÿæœ‰ä¸€ä¸ªæ ¸å¿ƒå‚æ•°ï¼šanimationSpecï¼Œä¹‹å‰æˆ‘ä»¬å°±è¯´è¿‡ï¼Œå®ƒæ˜¯ä¸€ä¸ª AnimationSpec ç±»å‹ï¼Œä½ å¯ä»¥é€šè¿‡å¯é€‰çš„ AnimationSpec å‚æ•°æ¥è‡ªå®šä¹‰åŠ¨ç”»è§„èŒƒï¼ˆä¹Ÿå°±æ˜¯å¯ä»¥å®ç°ä¸åŒç±»å‹çš„åŠ¨ç”»æ•ˆæœï¼‰ã€‚ è¿™ç¯‡æ–‡ç« ä»ç„¶ä¸ä¼šå¯¹åŠ¨ç”»è§„èŒƒåšè®²è§£ï¼Œè€Œæ˜¯ä¼šæŠŠå®ƒä½œä¸ºå•ç‹¬çš„çŸ¥è¯†ç‚¹æ”¾åœ¨ã€ AnimationSpec åŠ¨ç”»è§„èŒƒ ã€‘ä¸€æ–‡ç»†è¯´ã€‚ snapTo() é™¤äº† animateTo ä»¥å¤–ï¼ŒAnimatable è¿˜å¯ä»¥é€šè¿‡ snapTo() åœ¨åŠ¨ç”»å¼€å§‹å‰è®¾å®šã€Œåˆå§‹å€¼ã€ã€‚ ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset = remember(bicycleStart) { if (bicycleStart) 360.dp else 0.dp } val anim = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim.snapTo(if (bicycleStart) 300.dp else 100.dp) // æŒ‡å®šåŠ¨ç”»åˆå§‹å€¼ anim.animateTo(offset) } Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim.value) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} è¿™ä¸ªå‡½æ•°çš„ä½œç”¨ä¸éš¾ç†è§£ï¼šåœ¨åŠ¨ç”»å¼€å§‹å‰æŒ‡å®šåˆå§‹å€¼ï¼Œä¹Ÿå°±æ˜¯è®©åŠ¨ç”»å¯ä»¥ä»ä¸€ä¸ªæŒ‡å®šçš„å€¼å¼€å§‹è¿åŠ¨ï¼Œçœ‹ä¸‹é¢çš„å¯¹æ¯”å›¾ï¼š è™½ç„¶åŠ¨ç”»å¾ˆå¿«ï¼ˆé»˜è®¤åªæœ‰ 300msï¼‰ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯èƒ½çœ‹å‡ºæ¥ snapTo() åï¼Œå°åˆºçŒ¬ä¼šè·³åˆ°æŒ‡å®šçš„å€¼å¼€å§‹è¿åŠ¨ã€‚","link":"/2024/08/01/Compose%20--%20%E5%8A%A8%E7%94%BB%20--%2002.%20%E6%B5%81%E7%A8%8B%E5%AE%9A%E5%88%B6%E5%9E%8B%E5%8A%A8%E7%94%BB%20API%EF%BC%9AAnimatable()/"},{"title":"è¿‡æ¸¡åŠ¨ç”» APIï¼šTransition","text":"Jetpack Compose æä¾›äº†ä¸€ç³»åˆ—åŠŸèƒ½å¼ºå¤§ä¸”å¯æ‰©å±•çš„ APIï¼Œå¯ç”¨äºåœ¨åº”ç”¨ç•Œé¢ä¸­è½»æ¾å®ç°å„ç§åŠ¨ç”»æ•ˆæœã€‚è¿™ä¸€ç³»åˆ—æ–‡ç« ä¼šé€ä¸ªä»‹ç»æ‰€æœ‰çš„åŠ¨ç”» APIï¼Œé€šè¿‡æœ€ç›´è§‚çš„ Demo ç¤ºä¾‹ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ æ€ä¹ˆå†™åŠ¨ç”»ä»¥åŠå¸¦ä½ äº†è§£åŠ¨ç”»èƒŒåçš„åŸç†ã€‚ ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - çŠ¶æ€è½¬ç§»å‹åŠ¨ç”» APIï¼šanimate*AsState() ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æµç¨‹å®šåˆ¶å‹åŠ¨ç”» APIï¼šAnimatable() ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - è®²çš„ä¸èƒ½å†ç»†çš„ AnimationSpec åŠ¨ç”»è§„èŒƒ ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - è¿‡æ¸¡åŠ¨ç”» APIï¼šTransition ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æ˜¾ç¤ºä¸æ¶ˆå¤± APIï¼šAnimatedVisibility ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - ç®€å•é¡µé¢åˆ‡æ¢åŠ¨ç”» APIï¼šCrossfade ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æ›´å¼ºå¤§çš„å¤šç»„ä»¶åˆ‡æ¢åŠ¨ç”» APIï¼šAnimatedContent ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - ç»„ä»¶å¤§å°å˜åŒ– APIï¼šanimateContentSize ğŸ““ åŠ¨ç”»å›¾è¡¨ åœ¨æ¯ä¸€ç¯‡æ–‡ç« å¼€å¤´ï¼Œæˆ‘éƒ½ä¼šæ”¾ä¸€å¼  Compose åŠ¨ç”» API çš„å›¾è¡¨ï¼Œä»¥ä¾¿ä½ æœ‰æœ€ç›´è§‚çš„æ„Ÿå—ã€‚ ğŸ““ Transition Transition æ˜¯ Compose ä¸­å®ç°è¿‡æ¸¡åŠ¨ç”»çš„å…³é”® API ã€‚æ‰€è°“è¿‡æ¸¡åŠ¨ç”»ï¼Œå³å½“ä¾èµ–çš„æŸä¸ªçŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶è¿é”å‘ç”Ÿçš„ä¸€ç³»åˆ—åŠ¨ç”»æ•ˆæœã€‚ å‰é¢æˆ‘ä»¬æ‰€æåˆ°çš„ animate*AsState ä¸ Animatable éƒ½æ˜¯é’ˆå¯¹ä¸€ä¸ªå±æ€§ï¼ˆæ¯”å¦‚ offset åç§»ï¼‰è¿›è¡Œå˜æ¢çš„ï¼Œè€Œ Transition å…è®¸å¼€å‘è€…å°†å¤šä¸ªå±æ€§æ•°å€¼ç»‘å®šåˆ°ä¸€ä¸ªçŠ¶æ€ï¼Œå½“è¿™ä¸ªçŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå¤šä¸ªå±æ€§åŒæ—¶è¿›è¡Œå˜æ¢ã€‚ è¿˜æ˜¯é‚£å¥è¯ï¼šæ¢ç´¢æ–°æŠ€æœ¯çš„æœ€ä½³æ–¹å¼æ˜¯å°è¯•å®ƒä»¬ï¼Œæˆ‘ä»¬å…ˆæ„å»ºä¸€ä¸ªç®€å•åœºæ™¯ï¼š 12345678910111213141516171819202122232425262728class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier .size(90.dp) .clip(shape = CircleShape) .border(color = Color.Red, shape = CircleShape, width = 3.dp) ) Button( onClick = {} ) { Text(text = &quot;åˆ‡æ¢&quot;) } } } }} è¿™æ®µä»£ç æå…¶ç®€å•ï¼šä¸€ä¸ª Imageï¼Œä¸€ä¸ª Buttonï¼Œæ•ˆæœå¦‚ä¸‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/5712010e162d69503d04c38958c7485a.png#pic_center =700x) ç°åœ¨æˆ‘ä»¬å‡è®¾ä¸€ä¸ªéœ€æ±‚åœºæ™¯ï¼š å›¾ç‰‡å¤§å° size éœ€è¦å˜åŒ–ï¼šå°å›¾ç‰‡ï¼ˆ90dpï¼‰ã€å¤§å›¾ç‰‡ï¼ˆ130dpï¼‰ å›¾ç‰‡è¾¹æ¡†é¢œè‰² color éœ€è¦å˜åŒ–ï¼šç»¿è‰²ã€çº¢è‰² å¯¹åº”å…³ç³»ï¼šå°å›¾ç‰‡ç»¿è‰²è¾¹æ¡†ï¼Œå¤§å›¾ç‰‡çº¢è‰²è¾¹æ¡† å¦‚æœè¦å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿç›®å‰æˆ‘ä»¬æŒæ¡çš„åŠ¨ç”»ä»…æœ‰ animate*AsState() å’Œ Animatable.animateTo()ï¼Œä¸å¦‚æˆ‘ä»¬å…ˆç”¨è¿™ä¸¤ä¸ªåŠ¨ç”» API è¯•è¯•æ•ˆæœï¼Ÿ ğŸ“š animate*AsState() å¦‚æœæˆ‘ä»¬ç”¨ animate*AsState() æ¥å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œä»£ç å¯ä»¥è¿™ä¹ˆå†™ï¼š 12345678910111213141516171819202122232425262728293031class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var bigPic by remember { mutableStateOf(false) } val size by animateDpAsState(if (bigPic) 130.dp else 90.dp, label = &quot;&quot;) val borderColor by animateColorAsState(if (bigPic) Color.Red else Color.Green, label = &quot;&quot;) Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier .size(size) .clip(shape = CircleShape) .border(color = borderColor, shape = CircleShape, width = 3.dp) ) Button( onClick = { bigPic = !bigPic} ) { Text(text = &quot;åˆ‡æ¢&quot;) } } } }} ä½ åªè¦è®¤çœŸçœ‹è¿‡ã€ animate*AsState ç”¨æ³• ã€‘è¿™ç¯‡æ–‡ç« ï¼Œçœ‹è¿™æ®µä»£ç è‚¯å®š so easyã€‚ æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ª animateDpAsStateï¼Œåˆ†åˆ«æ§åˆ¶å›¾ç‰‡å¤§å°å’Œæ–‡å­—é¢œè‰²ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š ğŸ“š Animatable.animateTo ç°åœ¨æˆ‘ä»¬å†æ¥ç”¨ Animatable.animateTo å®ç°è¿™ä¸ªéœ€æ±‚ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var bigPic by remember { mutableStateOf(false) } // Size Animatable val size = remember(bigPic) { if (bigPic) 130.dp else 90.dp } val sizeAnim = remember { Animatable(size, Dp.VectorConverter) } LaunchedEffect(bigPic) { sizeAnim.animateTo(size) } // Color Animatable val borderColor = remember(bigPic) { if (bigPic) Color.Red else Color.Green} val borderColorAnim = remember { Animatable(borderColor) } LaunchedEffect(bigPic) { borderColorAnim.animateTo(borderColor) } Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Spacer(modifier = Modifier.height(100.dp)) Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier .size(sizeAnim.value) .clip(shape = CircleShape) .border(color = borderColorAnim.value, shape = CircleShape, width = 3.dp) ) Button( onClick = { bigPic = !bigPic} ) { Text(text = &quot;åˆ‡æ¢&quot;) } } } }} ä½ åªè¦è®¤çœŸçœ‹è¿‡ã€ Animatable ç”¨æ³• ã€‘è¿™ç¯‡æ–‡ç« ï¼Œçœ‹è¿™æ®µä»£ç è‚¯å®šä¹Ÿæ˜¯ so easyã€‚ æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ª Animatableï¼Œå¹¶ä¸”éœ€è¦å¯åŠ¨ä¸¤ä¸ªåç¨‹ï¼Œåˆ†åˆ«æ§åˆ¶å›¾ç‰‡å¤§å°å’Œæ–‡å­—é¢œè‰²ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š ğŸ“š updateTransition é‡ç‚¹æ¥äº†ï¼Œç°åœ¨æˆ‘ä»¬å¼€å§‹è®²è§£å¦‚ä½•ç”¨ Transition å®ç°è¿™ä¸ªåŠ¨ç”»æ•ˆæœã€‚ é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªçŠ¶æ€ï¼ŒçŠ¶æ€å¯ä»¥æ˜¯ä»»ä½•æ•°æ®ç±»å‹ã€‚æˆ‘ä»¬é€šå¸¸ä¼šè‡ªå®šä¹‰ä¸€ä¸ªæšä¸¾ç±»å‹ï¼š 123private enum class ImageState { Small, Large} ç°åœ¨æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ªå¤„ç†çŠ¶æ€çš„å˜é‡ï¼š 1var imageState by remember { mutableStateOf(ImageState.Small) } åˆ›å»º Transition å¯¹è±¡ Compose ä¸­æ˜¯é€šè¿‡ updateTransition() å‡½æ•°æ¥åˆ›å»º Transition å¯¹è±¡ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ updateTransition() å‡½æ•°ï¼š 12345@Composablefun &lt;T&gt; updateTransition( targetState: T, label: String? = null): Transition&lt;T&gt; å®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼š targetStateï¼šçŠ¶æ€å˜é‡ï¼Œå½“å®ƒè¢«æ›´æ”¹æ—¶ï¼ŒåŠ¨ç”»ä¼šè¿›è¡Œã€‚ labelï¼šåŠ¨ç”»çš„æ ‡ç­¾ã€‚ è¿™é‡Œçš„çŠ¶æ€å°±æ˜¯æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ï¼šimageStateï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·å†™ï¼š 1val transition = updateTransition(targetState = imageState, label = &quot;ImageState Transition&quot;) updateTransition() ä¼šè¿”å›ä¸€ä¸ª Transition å¯¹è±¡ã€‚ ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŸä¸ª animate* æ‰©å±•å‡½æ•° æ¥å®šä¹‰æ­¤è¿‡æ¸¡æ•ˆæœä¸­çš„å­åŠ¨ç”»ã€‚ä¸ºæ¯ä¸ªçŠ¶æ€æŒ‡å®šç›®æ ‡å€¼ã€‚è¿™äº› animate* å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªåŠ¨ç”»å€¼ï¼Œåœ¨åŠ¨ç”»æ’­æ”¾è¿‡ç¨‹ä¸­ï¼Œå½“ä½¿ç”¨ updateTransition æ›´æ–°è¿‡æ¸¡çŠ¶æ€æ—¶ï¼Œè¯¥å€¼å°†é€å¸§æ›´æ–°ã€‚ å®šåˆ¶è¾¹æ¡†é¢œè‰²è¿‡æ¸¡ 123456val borderColor by transition.animateColor(label = &quot;ImageState Color Transition&quot;) { when (it) { ImageState.Small -&gt; Color.Green ImageState.Large -&gt; Color.Magenta }} å®šåˆ¶å›¾ç‰‡å°ºå¯¸è¿‡æ¸¡ 123456val size by transition.animateDp(label = &quot;ImageState Size Transition&quot;) { when (it) { ImageState.Small -&gt; 90.dp ImageState.Large -&gt; 130.dp }} æˆ‘ä»¬ä¸ºæ¯ä¸ªå±æ€§çŠ¶æ€ï¼ˆborderColorã€sizeï¼‰å£°æ˜äº†å…¶åœ¨ä¸åŒçŠ¶æ€ï¼ˆImageState.Smallã€ImageState.Largeï¼‰æ—¶æ‰€å¯¹åº”çš„å€¼ï¼Œå½“è¿‡åº¦åŠ¨ç”»æ‰€ä¾èµ–çŠ¶æ€ï¼ˆimageStateï¼‰å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå…¶ä¸­æ¯ä¸ªå±æ€§çŠ¶æ€éƒ½ä¼šå¾—åˆ°ç›¸åº”çš„æ›´æ–°ã€‚ åº”ç”¨åˆ°ç»„ä»¶ä¸Šï¼ˆå®Œæ•´ä»£ç ï¼‰ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªéœ€å°†åˆ›å»ºçš„å±æ€§çŠ¶æ€åº”ç”¨åˆ°æˆ‘ä»¬çš„ç»„ä»¶ä¸­å³å¯ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354private enum class ImageState { Small, Large}class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var imageState by remember { mutableStateOf(ImageState.Small) } val transition = updateTransition(targetState = imageState, label = &quot;ImageState Transition&quot;) val borderColor by transition.animateColor(label = &quot;ImageState Color Transition&quot;) { when (it) { ImageState.Small -&gt; Color.Green ImageState.Large -&gt; Color.Magenta } } val size by transition.animateDp(label = &quot;ImageState Size Transition&quot;) { when (it) { ImageState.Small -&gt; 90.dp ImageState.Large -&gt; 130.dp } } Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier .size(size) .clip(shape = CircleShape) .border(color = borderColor, shape = CircleShape, width = 3.dp) ) Button( onClick = { imageState = if (imageState == ImageState.Small) { ImageState.Large } else { ImageState.Small } } ) { Text(text = &quot;åˆ‡æ¢&quot;) } } } }} æ•ˆæœå¦‚ä¸‹ï¼š ğŸ““ çµé­‚æ€è€ƒ å¯¹äºè¿™ä¹ˆä¸€ä¸ªç®€å•çš„éœ€æ±‚ï¼Œæˆ‘ä»¬åŒæ—¶ç”¨ animate*AsState()ã€Animatable å’Œ Transition éƒ½å¯ä»¥å®ç°ã€‚ é‚£ä¹ˆæˆ‘ä»¬å°±è¯¥æ€è€ƒä¸€ä¸ªé—®é¢˜äº†ï¼š æˆ‘ä»¬å¯ä»¥æŠŠ animate*AsState() å¯ä»¥ç†è§£ä¸º Animatable çš„ä¸€ç§æ›´ç®€ä¾¿ç›´æ¥çš„ç”¨æ³•ï¼ŒCompose åˆ›é€ å‡ºè¿™ä¸ª API çš„ç›®çš„å¯ä»¥ç†è§£ï¼› ä½†æ˜¯ Animatable ä¸æ˜¯å·²ç»å¯ä»¥å®Œç¾çš„å®ç°äº†æˆ‘ä»¬çš„éœ€æ±‚äº†å—ï¼Ÿä¸ºä»€ä¹ˆè¿˜è¦é€ ä¸€ä¸ª Transition å‡ºæ¥ï¼Ÿ ç°åœ¨æˆ‘ä»¬æ¥è§£ç­”è¿™ä¸ªç–‘æƒ‘ï¼š é¦–å…ˆæˆ‘ä»¬å›é¡¾ä¸€ä¸‹ Animatable å’Œ Transition ä¸¤ç§åŠ¨ç”»åŸç†çš„æ ¸å¿ƒæ€æƒ³ã€‚ Animatable Animatable æ˜¯é¢å‘å€¼çš„ï¼Œåœ¨å¤šä¸ªåŠ¨ç”»ã€å¤šä¸ªçŠ¶æ€çš„æƒ…å†µä¸‹å­˜åœ¨ä¸ä¾¿äºç®¡ç†çš„é—®é¢˜ã€‚ 123456789101112131415var bigPic by remember { mutableStateOf(false) }// Size Animatableval size = remember(bigPic) { if (bigPic) 130.dp else 90.dp }val sizeAnim = remember { Animatable(size, Dp.VectorConverter) }LaunchedEffect(bigPic) { sizeAnim.animateTo(size)}// Color Animatableval borderColor = remember(bigPic) { if (bigPic) Color.Red else Color.Green}val borderColorAnim = remember { Animatable(borderColor) }LaunchedEffect(bigPic) { borderColorAnim.animateTo(borderColor)} é’ˆå¯¹ size å’Œ borderColorï¼Œæˆ‘ä»¬è¦åˆ›å»ºä¸¤ä¸ª Animatableï¼Œè€Œä¸”è¿˜è¦å¯åŠ¨ä¸¤ä¸ªåç¨‹ï¼Œå¦‚æœæˆ‘ä»¬è¿˜æœ‰å¤šä¸ªå…¶ä»–åŠ¨ç”»ï¼Œå°±è¦åƒä¸‹é¢è¿™ä¹ˆå†™ï¼š 12345678910111213141516171819202122232425262728293031var bigPic by remember { mutableStateOf(false) }// Size Animatableval size = remember(bigPic) { if (bigPic) 130.dp else 90.dp }val sizeAnim = remember { Animatable(size, Dp.VectorConverter) }LaunchedEffect(bigPic) { sizeAnim.animateTo(size)}// Color Animatableval borderColor = remember(bigPic) { if (bigPic) Color.Red else Color.Green}val borderColorAnim = remember { Animatable(borderColor) }LaunchedEffect(bigPic) { borderColorAnim.animateTo(borderColor)}// Background Animatableval background = remember(bigPic) { ... }val backgroundAnim = remember { Animatable(background) }LaunchedEffect(bigPic) { backgroundAnim.animateTo(background)}// Alpha Animatableval alpha = remember(bigPic) { ... }val alphaAnim = remember { Animatable(alpha) }LaunchedEffect(bigPic) { alphaAnim.animateTo(alpha)}// ..... ä½ å°±è¦ä¸åœçš„å¯åŠ¨åç¨‹ï¼Œç„¶åå†™ä¸€å †ç»“æ„å·®ä¸å¤šçš„ä»£ç ï¼Œè¿™è¿˜æ²¡æœ‰ç®—ä¸Š bigPic çŠ¶æ€ï¼Œå¦‚æœä½ æ–°å¢äº†å…¶ä»–ç±»ä¼¼ bigPic çš„çŠ¶æ€ï¼Œè¿˜éœ€è¦æ·»åŠ æ›´å¤šçš„çŠ¶æ€ç‰‡æ®µé€»è¾‘â€¦ Transition Transition æ˜¯é¢å‘çŠ¶æ€çš„ï¼Œå¤šä¸ªåŠ¨ç”»å¯ä»¥å…±ç”¨ä¸€ä¸ªçŠ¶æ€ï¼Œèƒ½å¤Ÿåšåˆ°ç»Ÿä¸€çš„ç®¡ç†ã€‚ 12345678910111213141516var imageState by remember { mutableStateOf(ImageState.Small) }val transition = updateTransition(targetState = imageState, label = &quot;ImageState Transition&quot;)val borderColor by transition.animateColor(label = &quot;ImageState Color Transition&quot;) { when (it) { ImageState.Small -&gt; Color.Green ImageState.Large -&gt; Color.Magenta }}val size by transition.animateDp(label = &quot;ImageState Size Transition&quot;) { when (it) { ImageState.Small -&gt; 90.dp ImageState.Large -&gt; 130.dp }} updateTransition åªä¼šåˆ›å»ºä¸€æ¬¡åç¨‹ï¼Œè€Œä¸”åªéœ€è¦æ ¹æ®ä¸€ç§çŠ¶æ€çš„å˜åŒ–ï¼Œå°±å¯ä»¥æ§åˆ¶ä¸åŒçš„åŠ¨ç”»æ•ˆæœã€‚ å¦‚æœæˆ‘ä»¬è¿˜æœ‰å¤šä¸ªå…¶ä»–åŠ¨ç”»ï¼Œå°±å¯ä»¥è¿™ä¹ˆå†™ï¼š 123456789101112131415161718192021222324252627282930var imageState by remember { mutableStateOf(ImageState.Small) }val transition = updateTransition(targetState = imageState, label = &quot;ImageState Transition&quot;)val borderColor by transition.animateColor(label = &quot;ImageState Color Transition&quot;) { when (it) { ImageState.Small -&gt; Color.Green ImageState.Large -&gt; Color.Magenta }}val size by transition.animateDp(label = &quot;ImageState Size Transition&quot;) { when (it) { ImageState.Small -&gt; 90.dp ImageState.Large -&gt; 130.dp }}val background by transition.animateColor(label = &quot;ImageState Color Transition&quot;) { when (it) { ImageState.Small -&gt; Color.Yellow ImageState.Large -&gt; Color.Magenta }}val alpha by transition.animateFloat(label = &quot;ImageState Alpha Transition&quot;) { when (it) { ImageState.Small -&gt; 0.3f ImageState.Large -&gt; 0.5f }} ç»“æ„æ¸…æ™°æ˜äº†ï¼Œéå¸¸æ–¹ä¾¿ã€‚ Transition é™¤äº†ä»£ç ç»“æ„å’Œé€»è¾‘æ¸…æ™°çš„ä¼˜åŠ¿ä»¥å¤–ï¼Œå®ƒè¿˜æœ‰ä¸ªæ›´ç‰›é€¼çš„åŠŸèƒ½ï¼šæ”¯æŒ Compose åŠ¨ç”»é¢„è§ˆï¼ ä»€ä¹ˆæ˜¯åŠ¨ç”»é¢„è§ˆå‘¢ï¼Ÿæˆ‘ä»¬ä»£ç å†™åˆ°ç°åœ¨äº†ï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°æ‰€æœ‰çš„åŠ¨ç”» API éƒ½åŠ ä¸Šäº†ä¸€ä¸ª label æ ‡ç­¾å‚æ•°ï¼š 12345678val transition = updateTransition(targetState = imageState, label = &quot;ImageState Transition&quot;)val borderColor by transition.animateColor(label = &quot;ImageState Color Transition&quot;) { when (it) { ImageState.Small -&gt; Color.Green ImageState.Large -&gt; Color.Magenta }} è¿™ä¸ª label æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿä¸€ä¼šä½ å°±çŸ¥é“äº†ã€‚ ç°åœ¨æˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆæ‰“å¼€è¿™ä¸ª Compose åŠ¨ç”»é¢„è§ˆåŠŸèƒ½ï¼š é¦–å…ˆæˆ‘ä»¬æŠŠä»£ç è°ƒæ•´æ‹†åˆ°ä¸€ä¸ªè‡ªå®šä¹‰ Composable å‡½æ•°ä¸­ï¼Œå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061private enum class ImageState { Small, Large}class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { TransitionPreview() } }}@Composablefun TransitionPreview() { var imageState by remember { mutableStateOf(ImageState.Small) } val transition = updateTransition(targetState = imageState, label = &quot;ImageState Transition&quot;) val borderColor by transition.animateColor(label = &quot;ImageState Color Transition&quot;) { when (it) { ImageState.Small -&gt; Color.Green ImageState.Large -&gt; Color.Magenta } } val size by transition.animateDp(label = &quot;ImageState Size Transition&quot;) { when (it) { ImageState.Small -&gt; 90.dp ImageState.Large -&gt; 130.dp } } Column( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Spacer(modifier = Modifier.height(100.dp)) Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier .size(size) .clip(shape = CircleShape) .border(color = borderColor, shape = CircleShape, width = 3.dp) ) Button( onClick = { imageState = if (imageState == ImageState.Small) { ImageState.Large } else { ImageState.Small } } ) { Text(text = &quot;åˆ‡æ¢&quot;) } }} ç°åœ¨æˆ‘ä»¬ç»™ TransitionPreview() å‡½æ•°æ·»åŠ  @Preview æ³¨è§£ï¼š 1234@Preview@Composablefun TransitionPreview() {} åŠ ä¸Šè¿™ä¸ªæ³¨è§£ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨ Android Studio ç•Œé¢å³ä¾§é¢„è§ˆè¿™ä¸ª @Composable å¯ç»„åˆé¡¹çš„æ•ˆæœï¼Œè€Œä¸éœ€è¦è¿è¡Œåˆ°æ¨¡æ‹Ÿæœºæˆ–è€…çœŸæœºã€‚ ç°åœ¨è¿˜åªæ˜¯ç»„ä»¶çš„é¢„è§ˆç•Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥ç‚¹å‡» Start Animation Preview æŒ‰é’®è¿›å…¥åŠ¨ç”»é¢„è§ˆç•Œé¢ï¼š è¿›å…¥ä¹‹åä¼šæ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š æˆ‘ä»¬ç°åœ¨æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªåŠ¨ç”»é¢„è§ˆç•Œé¢ï¼Œæ³¨æ„çœ‹å›¾ï¼š çº¢è‰²æ¡†æ¡†æ˜¾ç¤ºçš„æ˜¯ä»€ä¹ˆï¼Ÿä¸å°±æ˜¯å¯¹åº”ç€æˆ‘ä»¬åˆ›å»º Transition æ—¶å€™å¡«çš„ label ä¹ˆï¼Ÿ 1val transition = updateTransition(targetState = imageState, label = &quot;ImageState Transition&quot;) æˆ‘ä»¬ç°åœ¨ç‚¹å‡»ç®­å¤´å±•å¼€å®ƒï¼š ç°åœ¨ä½ çŸ¥é“ä¸ºä»€ä¹ˆè¦åŠ  label äº†å§ï¼ŸåŠ¨ç”»é¢„è§ˆç•Œé¢å¯æ“ä½œæ€§å¾ˆå¼ºï¼Œä½ å¯ä»¥æ‹–åŠ¨è¿›åº¦æ¡åˆ°åŠ¨ç”»çš„ä»»æ„ä½ç½®ï¼Œè¿˜èƒ½äº’æ¢åŠ¨ç”»çš„åˆå§‹çŠ¶æ€å’Œç›®æ ‡çŠ¶æ€ï¼Œè®¾ç½®åŠ¨ç”»çš„å€é€Ÿç­‰ï¼Œè¿™ä¸ªè‡ªè¡Œæ¢ç´¢å§ã€‚ æˆ‘ä¼°è®¡è¿™ä¸ªæ—¶å€™ï¼Œä½ å¯èƒ½å°±ä¼šæƒ³ä¸€ä¸ªé—®é¢˜äº†ï¼Œéš¾é“ animate*AsState ä¸æ”¯æŒï¼Œå®ƒä¸æ˜¯ä¹ŸåŠ äº† label äº†å—ï¼Ÿæˆ‘ä»¬è¯•ä¸€ä¸‹ï¼š animate*AsState è™½ç„¶æ”¯æŒæ·»åŠ  labelï¼Œä½†å®é™…ä¸Šæ²¡æœ‰ä»»ä½•åŠ¨ç”»å¯ä»¥è°ƒèŠ‚ã€‚","link":"/2024/08/10/Compose%20--%20%E5%8A%A8%E7%94%BB%20--%2004.%20%E8%BF%87%E6%B8%A1%E5%8A%A8%E7%94%BB%20API%EF%BC%9ATransition/"},{"title":"æ˜¾ç¤ºä¸æ¶ˆå¤± APIï¼šAnimatedVisibility","text":"Jetpack Compose æä¾›äº†ä¸€ç³»åˆ—åŠŸèƒ½å¼ºå¤§ä¸”å¯æ‰©å±•çš„ APIï¼Œå¯ç”¨äºåœ¨åº”ç”¨ç•Œé¢ä¸­è½»æ¾å®ç°å„ç§åŠ¨ç”»æ•ˆæœã€‚è¿™ä¸€ç³»åˆ—æ–‡ç« ä¼šé€ä¸ªä»‹ç»æ‰€æœ‰çš„åŠ¨ç”» APIï¼Œé€šè¿‡æœ€ç›´è§‚çš„ Demo ç¤ºä¾‹ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ æ€ä¹ˆå†™åŠ¨ç”»ä»¥åŠå¸¦ä½ äº†è§£åŠ¨ç”»èƒŒåçš„åŸç†ã€‚ ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - çŠ¶æ€è½¬ç§»å‹åŠ¨ç”» APIï¼šanimate*AsState() ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æµç¨‹å®šåˆ¶å‹åŠ¨ç”» APIï¼šAnimatable() ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - è®²çš„ä¸èƒ½å†ç»†çš„ AnimationSpec åŠ¨ç”»è§„èŒƒ ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - è¿‡æ¸¡åŠ¨ç”» APIï¼šTransition ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æ˜¾ç¤ºä¸æ¶ˆå¤± APIï¼šAnimatedVisibility ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - ç®€å•é¡µé¢åˆ‡æ¢åŠ¨ç”» APIï¼šCrossfade ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æ›´å¼ºå¤§çš„å¤šç»„ä»¶åˆ‡æ¢åŠ¨ç”» APIï¼šAnimatedContent ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - ç»„ä»¶å¤§å°å˜åŒ– APIï¼šanimateContentSize ğŸ““ åŠ¨ç”»å›¾è¡¨ åœ¨æ¯ä¸€ç¯‡æ–‡ç« å¼€å¤´ï¼Œæˆ‘éƒ½ä¼šæ”¾ä¸€å¼  Compose åŠ¨ç”» API çš„å›¾è¡¨ï¼Œä»¥ä¾¿ä½ æœ‰æœ€ç›´è§‚çš„æ„Ÿå—ã€‚ ğŸ““ AnimatedVisibility AnimatedVisibility å¯ç»„åˆé¡¹å¯ä¸ºå†…å®¹çš„å‡ºç°å’Œæ¶ˆå¤±æ·»åŠ åŠ¨ç”»æ•ˆæœã€‚ è¿˜æ˜¯é‚£å¥è¯ï¼šæ¢ç´¢æ–°æŠ€æœ¯çš„æœ€ä½³æ–¹å¼æ˜¯å°è¯•å®ƒä»¬ï¼Œæˆ‘ä»¬å…ˆæ„å»ºä¸€ä¸ªç®€å•åœºæ™¯ï¼Œç„¶åå†æ…¢æ…¢å¼•å…¥ AnimatedVisibility çš„ç”¨æ³•ã€‚ 123456789101112131415161718192021222324252627282930class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var shown by remember { mutableStateOf(true) } Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Spacer(modifier = Modifier.height(20.dp)) if (shown) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) ) } Button( onClick = { shown = !shown} ) { Text(text = &quot;æ§åˆ¶å›¾ç‰‡æ˜¾ç¤º/æ¶ˆå¤±&quot;) } } } }} è¿™æ®µä»£ç æå…¶ç®€å•ï¼Œä¸€ä¸ªå›¾ç‰‡ï¼Œä¸€ä¸ªæŒ‰é’®ï¼Œä¸€ä¸ª shown çŠ¶æ€å˜é‡æ§åˆ¶å›¾ç‰‡æ˜¾ç¤ºä¸å¦ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š ä»åŠ¨ç”»æ•ˆæœçœ‹ç¡®å®ä¸è¡Œï¼Œæ˜¾ç¤ºä¸æ¶ˆå¤±éƒ½å¾ˆç²—ç³™ã€‚ç°åœ¨æˆ‘ä»¬æ¥ç”¨ AnimatedVisibility æ”¹å–„æ•ˆæœï¼Œå†™æ³•å¾ˆç®€å•ï¼š 123456789101112131415161718192021222324252627282930class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var shown by remember { mutableStateOf(true) } Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Spacer(modifier = Modifier.height(20.dp)) AnimatedVisibility (shown) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) ) } Button( onClick = { shown = !shown} ) { Text(text = &quot;æ§åˆ¶å›¾ç‰‡æ˜¾ç¤º/æ¶ˆå¤±&quot;) } } } }} ä½ ä¼šå‘ç°ï¼Œæˆ‘å…¶å®å¯¹ä»£ç åªåšäº†ä¸€ç‚¹å°ä¿®æ”¹ï¼š 123if (shown) {// åªæ˜¯æŠŠ if æ”¹æˆäº† AnimatedVisibilityAnimatedVisibility (shown) çœ‹ä¸‹æ•ˆæœï¼š æ˜¯ä¸æ˜¯å·²ç»çœ‹å‡ºæ¥åŠ¨ç”»æ•ˆæœäº†ï¼Ÿä½¿ç”¨æ–¹æ³•å°±è¿™ä¹ˆç®€å•ã€‚ å¦å¤–ï¼Œè¿™é‡Œè¿˜æœ‰ä¸ªå¾ˆæœ‰æ„æ€çš„äº‹æƒ…ï¼Œå¦‚æœæˆ‘æŠŠå¸ƒå±€ä» Column æ”¹æˆ Rowï¼ˆä»£ç æˆ‘å°±ä¸è´´äº†ï¼‰ï¼Œå†çœ‹ä¸‹æ•ˆæœï¼š ä¸åŒå¸ƒå±€æ–¹å¼ï¼ŒåŠ¨ç”»æ•ˆæœè¿˜ä¸ä¸€æ ·äº†ï¼Ÿ Column å¸ƒå±€ï¼ŒåŠ¨ç”»çš„æ˜¾ç¤ºå’Œæ¶ˆå¤±æ–¹å¼æ˜¯ï¼šä¸Š -&gt; ä¸‹ Row å¸ƒå±€ï¼ŒåŠ¨ç”»çš„æ˜¾ç¤ºå’Œæ¶ˆå¤±æ–¹å¼æ˜¯ï¼šå·¦ -&gt; å³ ä¸ºä»€ä¹ˆï¼Ÿæˆ‘ä»¬çœ‹ä¸‹ AnimatedVisibility å‡½æ•°ï¼š Column -&gt; AnimatedVisibility 123456789@Composablefun ColumnScope.AnimatedVisibility( visible: Boolean, modifier: Modifier = Modifier, enter: EnterTransition = fadeIn() + expandVertically(), exit: ExitTransition = fadeOut() + shrinkVertically(), label: String = &quot;AnimatedVisibility&quot;, content: @Composable AnimatedVisibilityScope.() -&gt; Unit) Row -&gt; AnimatedVisibility 123456789@Composablefun RowScope.AnimatedVisibility( visible: Boolean, modifier: Modifier = Modifier, enter: EnterTransition = fadeIn() + expandHorizontally(), exit: ExitTransition = fadeOut() + shrinkHorizontally(), label: String = &quot;AnimatedVisibility&quot;, content: @Composable() AnimatedVisibilityScope.() -&gt; Unit) åŸæ¥å¦‚æ­¤ - - æ‰©å±•å‡½æ•°ï¼Œå†…éƒ¨å„è‡ªæŒ‡å®šäº†é»˜è®¤çš„ enter å’Œ exit åŠ¨ç”»æ•ˆæœã€‚ é™¤äº†ä¸åŒå®¹å™¨æäº†å„è‡ªçš„ AnimatedVisibility() æ‰©å±•å‡½æ•°å¤–ï¼Œå¯¹äºä»»ä½•ä¸€ä¸ªç»„ä»¶ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å•ç‹¬ç”¨ AnimatedVisibility()ã€‚ 123456789101112@Composablefun AnimatedVisibility( visible: Boolean, modifier: Modifier = Modifier, enter: EnterTransition = fadeIn() + expandIn(), exit: ExitTransition = shrinkOut() + fadeOut(), label: String = &quot;AnimatedVisibility&quot;, content: @Composable() AnimatedVisibilityScope.() -&gt; Unit) { val transition = updateTransition(visible, label) // å®ƒä¹Ÿæ˜¯åŸºäº updateTransition åšçš„ AnimatedEnterExitImpl(transition, { it }, modifier, enter, exit, content)} AnimatedVisibility() å‡½æ•°æœ‰ä¸¤ä¸ªæœ€æ ¸å¿ƒçš„å‚æ•°ï¼š enterï¼š æŒ‡å®šå…¥åœºåŠ¨ç”»ï¼Œä¹Ÿå°±æ˜¯æ˜¾ç¤ºåŠ¨ç”»ï¼Œç±»å‹æ˜¯ EnterTransition exitï¼š æŒ‡å®šå‡ºåœºåŠ¨ç”»ï¼Œä¹Ÿå°±æ˜¯æ¶ˆå¤±åŠ¨ç”»ï¼Œç±»å‹æ˜¯ ExitTransition æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¼€å§‹æ¢è®¨ EnterTransition å’Œ ExitTransition è¿™ä¸¤ä¸ªæ ¸å¿ƒäº†ã€‚ ğŸ““ EnterTransition EnterTransition æ˜¯ä¸€ä¸ªå¯†å°ç±»ï¼š 12@Immutablesealed class EnterTransition å®ƒçš„å­å®ç°ç±»æ˜¯ EnterTransitionImplï¼š 12@Immutableprivate class EnterTransitionImpl(override val data: TransitionData) : EnterTransition() ç„¶è€Œ EnterTransitionImpl æ˜¯ç§æœ‰çš„ï¼ŒCompose æä¾›äº†å‡ ä¸ªç°æˆçš„å‡½æ•°æ¥åˆ›å»º EnterTransitionImplã€‚ fadeIn() fadeIn() å‡½æ•°ä¸»è¦ç”¨äºå†…å®¹è¿›åœºçš„â€œæ·¡å…¥æ•ˆæœâ€ï¼Œç”¨æ³•æå…¶ç®€å•ï¼š 1234567AnimatedVisibility (shown, enter = fadeIn()) { Image( painter = painterResource(R.drawable.pingtouge), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} æˆ‘ä»¬è‡ªå·±å®šä¹‰äº† AnimatedVisibility çš„ enter å‚æ•°ï¼Œå°±ä¸€ä¸ª fadeIn()ï¼Œçœ‹ä¸‹æ•ˆæœï¼š ç°åœ¨æ¥çœ‹ä¸‹ fadeIn() å‡½æ•°çš„å®šä¹‰ï¼š 1234567@Stablefun fadeIn( animationSpec: FiniteAnimationSpec&lt;Float&gt; = spring(stiffness = Spring.StiffnessMediumLow), initialAlpha: Float = 0f): EnterTransition { return EnterTransitionImpl(TransitionData(fade = Fade(initialAlpha, animationSpec)))} å®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼š animationSpecï¼šæˆ‘ä»¬å¯ä»¥ç»™å®ƒè®¾å®š FiniteAnimationSpec ç±»å‹åŠ¨ç”»ï¼Œæ¯”å¦‚ï¼šTween()ã€SpringSpec() ç­‰ï¼Œé»˜è®¤æ˜¯å¼¹ç°§æ•ˆæœ initialAlphaï¼šæˆ‘ä»¬å¯ä»¥ç»™å®ƒå®šåˆ¶åˆå§‹é€æ˜åº¦ ä¸‹é¢æ¥æµ‹è¯•ä¸€ä¸‹ï¼š 1234567AnimatedVisibility (shown, enter = fadeIn(tween(3000), initialAlpha = 0.3f)) { Image( painter = painterResource(R.drawable.pingtouge), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} æˆ‘ä»¬åˆ†åˆ«åŠ äº†ä¸€ä¸ª tween åŠ¨ç”»ï¼ˆåŠ¨ç”»æ—¶é•¿ 3sï¼‰ï¼Œç„¶ååˆåŠ äº†ä¸€ä¸ªåˆå§‹ 0.3f çš„é€æ˜åº¦ï¼Œçœ‹ä¸‹æ•ˆæœï¼š slideIn() slideIn() å‡½æ•°ä¸»è¦ç”¨äºå†…å®¹è¿›åœºçš„â€œæ»‘å…¥æ•ˆæœâ€ï¼Œç”¨æ³•ä¹Ÿæ˜¯æå…¶ç®€å•ï¼š 1234567AnimatedVisibility (shown, enter = slideIn { }) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} å¯ä»¥å‘ç°ï¼ŒslideIn åé¢æ¥äº†ä¸€ä¸ª lambda è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ƒçš„å‡½æ•°å®šä¹‰ï¼š 1234567891011@Stablefun slideIn( animationSpec: FiniteAnimationSpec&lt;IntOffset&gt; = spring( stiffness = Spring.StiffnessMediumLow, visibilityThreshold = IntOffset.VisibilityThreshold ), initialOffset: (fullSize: IntSize) -&gt; IntOffset,): EnterTransition { return EnterTransitionImpl(TransitionData(slide = Slide(initialOffset, animationSpec)))} å®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼š animationSpecï¼šæˆ‘ä»¬å¯ä»¥ç»™å®ƒè®¾å®š FiniteAnimationSpec ç±»å‹åŠ¨ç”»ï¼Œæ¯”å¦‚ï¼šTween()ã€SpringSpec() ç­‰ï¼Œé»˜è®¤æ˜¯å¼¹ç°§æ•ˆæœ initialOffsetï¼šéœ€è¦ç»™å®ƒæŒ‡å®šä¸€ä¸ªåˆå§‹åç§»ï¼Œæ˜¯ä¸€ä¸ª IntOffset ç±»å‹ ç°åœ¨æˆ‘ä»¬ä¿®æ”¹ä»£ç ï¼š 1234567AnimatedVisibility (shown, enter = slideIn { IntOffset(-200, -200) }) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} æˆ‘ä»¬éšä¾¿è®¾å®šäº†ä¸€ä¸ª IntOffset(-200, -200) ï¼Œç›¸å½“äºè®©å›¾ç‰‡ä»å·¦ä¸Šè§’æ»‘å…¥ï¼ˆx è½´å·¦åç§» 200 åƒç´ ï¼Œyè½´ä¸Šåç§» 200 åƒç´ ï¼‰ã€‚ çœ‹ä¸‹æ•ˆæœï¼š å¦‚æœä½ å¤Ÿç»†å¿ƒçš„è¯ï¼Œä¼šå‘ç° initialOffset çš„å‚æ•°ç±»å‹é‡Œé¢æœ‰ä¸€ä¸ª fullSizeï¼š 1initialOffset: (fullSize: IntSize) -&gt; IntOffset é»˜è®¤å·²ç»æä¾›äº†ä¸€ä¸ª fullSize å€¼ï¼Œè¿™ä¸ª fullSize å€¼åŒ…å«äº†å›¾ç‰‡çš„å®½ã€é«˜å°ºå¯¸ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å›¾ç‰‡çš„å®½ã€é«˜è¿›è¡Œæ»‘å…¥ï¼š 1234567AnimatedVisibility (shown, enter = slideIn { IntOffset(-it.width, -it.height) }) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} å¦å¤–ï¼ŒCompose è¿˜æä¾›äº† slideInHorizontally å’Œ slideInVertically ä¸¤ä¸ªæ¨ªè¡Œå’Œçºµå‘æ»‘å…¥çš„å‡½æ•°ï¼Œä½¿ç”¨ä¹Ÿå¾ˆç®€å•ã€‚ slideInHorizontallyï¼šæ¨ªè¡Œæ»‘å…¥ 1234567AnimatedVisibility (shown, enter = slideInHorizontally { -it }) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} slideInVerticallyï¼šçºµå‘æ»‘å…¥ 1234567AnimatedVisibility (shown, enter = slideInVertically { -it }) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} expandIn() expandIn() å‡½æ•°ä¸»è¦ç”¨äºå†…å®¹è¿›åœºçš„â€œè£åˆ‡æ•ˆæœâ€ã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å®ƒçš„å‡½æ•°å®šä¹‰ï¼š 1234567891011121314151617@Stablefun expandIn( animationSpec: FiniteAnimationSpec&lt;IntSize&gt; = spring( stiffness = Spring.StiffnessMediumLow, visibilityThreshold = IntSize.VisibilityThreshold ), expandFrom: Alignment = Alignment.BottomEnd, clip: Boolean = true, initialSize: (fullSize: IntSize) -&gt; IntSize = { IntSize(0, 0) },): EnterTransition { return EnterTransitionImpl( TransitionData( changeSize = ChangeSize(expandFrom, initialSize, animationSpec, clip) ) )} è·Ÿ slidIn å·®ä¸å¤šï¼Œå®ƒæœ‰ä¸€ä¸ª initialSize å‚æ•°ï¼Œä¸è¿‡æœ‰ä¸ªé»˜è®¤å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸å¿…éè¦ä¼ è¿™ä¸ª lambda è¡¨è¾¾å¼ï¼š 1234567AnimatedVisibility (shown, enter = expandIn()) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} ç›´æ¥å†™ expandIn() å³å¯ï¼Œä¸ºäº†çœ‹åˆ°æ›´ç»†çš„æ•ˆæœï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª tween çš„åŠ¨ç”»æ›²çº¿ï¼ˆ5sï¼‰ï¼Œçœ‹ä¸‹æ•ˆæœï¼š expandIn() å‡½æ•°å†…éƒ¨è¿˜æœ‰ä¸€ä¸ª expandFrom å‚æ•°ï¼Œå®ƒç”¨æ¥æ§åˆ¶è£åˆ‡åŠ¨ç”»æ˜¯ä»å“ªä¸ªæ–¹ä½å¼€å§‹ï¼Œæ¯”å¦‚é»˜è®¤æ˜¯ Alignment.BottomEnd ï¼ˆå³ä¸‹è§’ï¼‰ã€‚ æˆ‘ä»¬è¯•è¯•å·¦ä¸Šè§’ï¼ˆAlignment.TopStartï¼‰çš„æ•ˆæœï¼š 12345678AnimatedVisibility (shown, enter = expandIn(tween(5000), expandFrom = Alignment.TopStart)) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} å¦å¤–ï¼Œæˆ‘ä»¬å†è¯´å› initialSizeï¼Œå‰é¢è¯´äº†å®ƒæœ‰é»˜è®¤å®ç°ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿›è¡Œå®šåˆ¶ï¼š 123456789101112AnimatedVisibility (shown, enter = expandIn( tween(5000), expandFrom = Alignment.TopStart) { IntSize (it.width / 2, it.height / 2) }) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} æˆ‘ä»¬è®¾å®šäº†ä¸€ä¸ªè£å‰ªåˆå§‹å¤§å°å€¼ï¼šå›¾ç‰‡çš„ä¸€åŠã€‚ ç°åœ¨å°±å‰©ä¸‹ä¸€ä¸ª clip å‚æ•°ï¼šå®ƒè´Ÿè´£æ˜¯å¦è£åˆ‡ï¼Œé»˜è®¤ä¸º trueï¼Œå¦‚æœè®¾ç½®ä¸º falseï¼Œåˆ™åŠ¨ç”»åªä½ç§»ï¼Œä¸è£åˆ‡ã€‚ 12345678910111213AnimatedVisibility (shown, enter = expandIn( tween(5000), expandFrom = Alignment.TopStart, clip = false) { IntSize (it.width / 2, it.height / 2) }) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} å¦å¤–ï¼Œè·Ÿ slideIn ä¸€æ ·ï¼ŒCompose ä¹Ÿæä¾›äº† expandHorizontally å’Œ expandVertically ä¸¤ä¸ªæ¨ªè¡Œå’Œçºµå‘è£åˆ‡çš„å‡½æ•°ã€‚ expandHorizontallyï¼šæ¨ªå‘è£åˆ‡ 1234567AnimatedVisibility (shown, enter = expandHorizontally()) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} expandVerticallyï¼šçºµå‘è£åˆ‡ 1234567AnimatedVisibility (shown, enter = expandVertically()) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} scaleIn() scaleIn() å‡½æ•°ä¸»è¦ç”¨äºå†…å®¹è¿›åœºçš„â€œç¼©æ”¾æ•ˆæœâ€ï¼Œä»£ç å†™èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼š 1234567AnimatedVisibility (shown, enter = scaleIn(tween(3000))) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„å‡½æ•°å®šä¹‰ï¼š 1234567891011@Stable@ExperimentalAnimationApifun scaleIn( animationSpec: FiniteAnimationSpec&lt;Float&gt; = spring(stiffness = Spring.StiffnessMediumLow), initialScale: Float = 0f, transformOrigin: TransformOrigin = TransformOrigin.Center,): EnterTransition { return EnterTransitionImpl( TransitionData(scale = Scale(initialScale, transformOrigin, animationSpec)) )} animationSpec å’Œ initialScale å°±ä¸çœ‹äº†ï¼Œä½ ä¹Ÿåº”è¯¥çŸ¥é“æ˜¯å¹²å˜›çš„äº†ï¼Œä¸åšæ¼”ç¤ºäº†ï¼Œæˆ‘ä»¬åªçœ‹ä¸‹ transformOrigin å‚æ•°ã€‚ transformOrigin ä¸»è¦æ˜¯æ§åˆ¶ç¼©æ”¾çš„æ•ˆæœçš„ï¼Œé»˜è®¤æ˜¯ä»ä¸­å¿ƒç‚¹å¼€å§‹ç¼©æ”¾ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªè¡Œå®šåˆ¶ï¼Œæ¯”å¦‚ï¼š å·¦ä¸Šè§’ 12345678910AnimatedVisibility (shown, enter = scaleIn( tween(3000), transformOrigin = TransformOrigin(0f, 0f))) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} å³ä¸‹è§’ 12345678910AnimatedVisibility (shown, enter = scaleIn( tween(3000), transformOrigin = TransformOrigin(1.0f, 1.0f))) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} ğŸ““ + å·åŸç† EnterTransition æ‰€æœ‰çš„å†…å®¹å…¨éƒ¨è®²å®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ â€œ+â€ çš„åŸç†ï¼Œæ˜¯å¦‚ä½•æŠŠä¸¤ä¸ªåŠ¨ç”»ç»“åˆåœ¨ä¸€èµ·çš„ã€‚ è¿™æ˜¯æˆ‘ä»¬æ–‡ç« æœ€å¼€å§‹çš„ä»£ç ç¤ºä¾‹ï¼š 123456789101112@Composablefun AnimatedVisibility( visible: Boolean, modifier: Modifier = Modifier, enter: EnterTransition = fadeIn() + expandIn(), exit: ExitTransition = shrinkOut() + fadeOut(), label: String = &quot;AnimatedVisibility&quot;, content: @Composable() AnimatedVisibilityScope.() -&gt; Unit) { val transition = updateTransition(visible, label) // å®ƒä¹Ÿæ˜¯åŸºäº updateTransition åšçš„ AnimatedEnterExitImpl(transition, { it }, modifier, enter, exit, content)} æˆ‘ä»¬æ¥çœ‹çœ‹ â€œ+â€ å·åšäº†ä»€ä¹ˆï¼š 12345678910111213141516sealed class EnterTransition { internal abstract val data: TransitionData @Stable operator fun plus(enter: EnterTransition): EnterTransition { return EnterTransitionImpl( TransitionData( fade = data.fade ?: enter.data.fade, slide = data.slide ?: enter.data.slide, changeSize = data.changeSize ?: enter.data.changeSize, scale = data.scale ?: enter.data.scale ) ) }} ç†Ÿæ‚‰ Kotlin çš„è¯ï¼Œå¯¹ plus æ“ä½œç¬¦è‚¯å®šä¸é»˜è®¤ï¼Œè¿™é‡Œå†…éƒ¨å¯¹å·¦å³ä¸¤ä¸ª TransitionDate ä¼šåšåˆå¹¶ï¼Œä¸è¿‡åˆå¹¶çš„è§„åˆ™æ¯”è¾ƒç‰¹æ®Šã€‚ æ¯”å¦‚ fade æ·¡å…¥çš„æ•ˆæœï¼š 12345enter: EnterTransition = fadeIn() + expandIn(),// åˆå¹¶å·¥ä½œfade = data.fade ?: enter.data.fade, ä¼šåˆ¤æ–­å·¦è¾¹çš„ TransitionData æ˜¯å¦æœ‰ fadeï¼Ÿâ€“ å¦‚æœæœ‰äº†å°±åªç”¨å·¦è¾¹çš„ fadeï¼Œè€Œå³è¾¹çš„ TransitionData å³ä½¿æœ‰ fadeï¼Œä¹Ÿä¸ä¼šåˆå¹¶ï¼Œç›´æ¥å»é™¤ã€‚ å¦‚æœä½ çš„ä»£ç è¿™ä¹ˆå†™ï¼š 123456789AnimatedVisibility (shown, enter = fadeIn(initialAlpha = 0.3f) + fadeIn(initialAlpha = 0.5f)) { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier.size(90.dp).clip(shape = CircleShape) )} é‚£ä¹ˆåªä¼šåº”ç”¨å·¦è¾¹çš„ 0.3 é€æ˜åº¦ï¼Œå³è¾¹çš„ 0.5 é€æ˜åº¦ç›´æ¥æŠ›å¼ƒã€‚ ğŸ““ ExitTransition è®²å®Œ EnterTransitionï¼Œå¯¹äº ExitTransition çš„åŸç†å°±ä¸ç”¨ç»†è¯´äº†ï¼Œå’Œ EnterTransition ä¸€æ ·ï¼Œåªéœ€è¦æŠŠå¯¹åº”çš„ fadeIn()ã€slideIn()ã€expandIn()ã€scaleIn() çš„å‡½æ•°åä¸­çš„ In æ”¹æˆ out å³å¯ã€‚ ä¸è¿‡æœ‰ä¸ªå¦ç±»ï¼Œå¯¹äº fadeIn()ã€slideIn()ã€scaleIn()ï¼Œä»–ä»¬å¯¹åº”çš„ ExitTransition æ˜¯ï¼šfadeOut()ã€slideOutã€scaleInOutï¼Œè€Œ expandIn() å¯¹åº”çš„æ˜¯ï¼šshrinkOutï¼Œåªæ˜¯æ”¹äº†ä¸ªåå­—è€Œå·²ï¼Œå±•å¼€ -&gt; æ”¶ç¼©ã€‚","link":"/2024/08/15/Compose%20--%20%E5%8A%A8%E7%94%BB%20--%2005.%20%E6%98%BE%E7%A4%BA%E4%B8%8E%E6%B6%88%E5%A4%B1%20API%EF%BC%9AAnimatedVisibility/"},{"title":"ç®€å•é¡µé¢åˆ‡æ¢åŠ¨ç”» APIï¼šCrossfade","text":"Jetpack Compose æä¾›äº†ä¸€ç³»åˆ—åŠŸèƒ½å¼ºå¤§ä¸”å¯æ‰©å±•çš„ APIï¼Œå¯ç”¨äºåœ¨åº”ç”¨ç•Œé¢ä¸­è½»æ¾å®ç°å„ç§åŠ¨ç”»æ•ˆæœã€‚è¿™ä¸€ç³»åˆ—æ–‡ç« ä¼šé€ä¸ªä»‹ç»æ‰€æœ‰çš„åŠ¨ç”» APIï¼Œé€šè¿‡æœ€ç›´è§‚çš„ Demo ç¤ºä¾‹ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ æ€ä¹ˆå†™åŠ¨ç”»ä»¥åŠå¸¦ä½ äº†è§£åŠ¨ç”»èƒŒåçš„åŸç†ã€‚ ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - çŠ¶æ€è½¬ç§»å‹åŠ¨ç”» APIï¼šanimate*AsState() ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æµç¨‹å®šåˆ¶å‹åŠ¨ç”» APIï¼šAnimatable() ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - è®²çš„ä¸èƒ½å†ç»†çš„ AnimationSpec åŠ¨ç”»è§„èŒƒ ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - è¿‡æ¸¡åŠ¨ç”» APIï¼šTransition ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æ˜¾ç¤ºä¸æ¶ˆå¤± APIï¼šAnimatedVisibility ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - ç®€å•é¡µé¢åˆ‡æ¢åŠ¨ç”» APIï¼šCrossfade ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æ›´å¼ºå¤§çš„å¤šç»„ä»¶åˆ‡æ¢åŠ¨ç”» APIï¼šAnimatedContent ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - ç»„ä»¶å¤§å°å˜åŒ– APIï¼šanimateContentSize ğŸ““ åŠ¨ç”»å›¾è¡¨ åœ¨æ¯ä¸€ç¯‡æ–‡ç« å¼€å¤´ï¼Œæˆ‘éƒ½ä¼šæ”¾ä¸€å¼  Compose åŠ¨ç”» API çš„å›¾è¡¨ï¼Œä»¥ä¾¿ä½ æœ‰æœ€ç›´è§‚çš„æ„Ÿå—ã€‚ Crossfade ç”¨äºåœ¨ä¸¤ä¸ªå¸ƒå±€ä¹‹é—´ç”¨äº¤å‰æ·¡å…¥æ·¡å‡ºçš„åŠ¨ç”»ã€‚é€šè¿‡åˆ‡æ¢ä¼ é€’ç»™å½“å‰å‚æ•°çš„å€¼ï¼Œå†…å®¹ä»¥äº¤å‰æ¸å˜åŠ¨ç”»çš„æ–¹å¼åˆ‡æ¢ã€‚ è¿˜æ˜¯é‚£å¥è¯ï¼šæ¢ç´¢æ–°æŠ€æœ¯çš„æœ€ä½³æ–¹å¼æ˜¯å°è¯•å®ƒä»¬ï¼Œæˆ‘ä»¬å…ˆæ„å»ºä¸€ä¸ªç®€å•åœºæ™¯ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { cf() } }}@Composablefun cf() { var shown by remember { mutableStateOf(true) } Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { if (shown) { showCR7_1() } else { showCR7_2() } Button( onClick = { shown = !shown} ) { Text(text = &quot;åˆ‡æ¢&quot;) } }}@Composablefun showCR7_1() { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier .size(90.dp) .clip(shape = CircleShape) )}@Composablefun showCR7_2() { Image( painter = painterResource(R.drawable.cr7_2), contentDescription = null, modifier = Modifier .size(60.dp) .clip(shape = CircleShape) )} è¿™æ®µä»£ç éå¸¸ç®€å•ï¼Œbutton æ§åˆ¶ shown å˜é‡å€¼ï¼Œä»è€Œæ˜¾ç¤ºä¸åŒçš„ Imageã€‚ æ³¨æ„ï¼Œä¸¤ä¸ªå›¾ç‰‡å¯ç»„åˆé¡¹é™¤äº†å›¾ç‰‡ä¸ä¸€æ ·ï¼Œå›¾ç‰‡å¤§å°ä¹Ÿä¸ä¸€æ ·ã€‚ å¯¹äºä¸¤ä¸ª Image å¯ç»„åˆé¡¹æˆ‘ä»¬å¯ä»¥çœ‹æˆæ˜¯ä¸¤ä¸ªéå¸¸ç®€å•çš„å¸ƒå±€ç•Œé¢ï¼Œç°åœ¨åˆ‡æ¢æ˜¯æ²¡æœ‰ä»»ä½•åŠ¨ç”»æ•ˆæœçš„ã€‚ ğŸ““ Crossfade å¦‚æœç”¨ Crossfadeï¼Œå°±å¯ä»¥å®ç°ä¸¤ä¸ª Image ç»„ä»¶ä¹‹é—´çš„åˆ‡æ¢åŠ¨ç”»ï¼Œå†™æ³•å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425@Composablefun cf() { var shown by remember { mutableStateOf(true) } Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Spacer(modifier = Modifier.height(100.dp)) Crossfade(targetState = shown, label = &quot;Crossfade&quot;) { if (it) { showCR7_1() } else { showCR7_2() } } Button( onClick = { shown = !shown} ) { Text(text = &quot;åˆ‡æ¢&quot;) } }} ä¸å¯¹å•Šï¼Œæ€ä¹ˆæ•ˆæœè¿™ä¹ˆå·®ï¼Œå›¾ç‰‡å°ºå¯¸å˜åŒ–çš„æ—¶å€™è¿˜é—ªäº†ä¸€ä¸‹ï¼Ÿ å…ˆåˆ«æ€¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ƒçš„å‡½æ•°å®šä¹‰ï¼š 123456789101112@OptIn(ExperimentalAnimationApi::class)@Composablefun &lt;T&gt; Crossfade( targetState: T, modifier: Modifier = Modifier, animationSpec: FiniteAnimationSpec&lt;Float&gt; = tween(), label: String = &quot;Crossfade&quot;, content: @Composable (T) -&gt; Unit) { val transition = updateTransition(targetState, label) transition.Crossfade(modifier, animationSpec, content = content)} å®ƒåŒæ ·å¯ä»¥è®¾ç½®åŠ¨ç”»æ›²çº¿ï¼š 1Crossfade(targetState = shown, animationSpec = tween(3000), label = &quot;Crossfade&quot;) æˆ‘ä»¬æŠŠåŠ¨ç”»æ—¶é—´è®¾çš„é•¿ä¸€ç‚¹ï¼Œæ¥çœ‹ä¸‹åŠ¨ç”»ç»†èŠ‚ï¼š ä½ å‘ç°ä»€ä¹ˆæ²¡ï¼Ÿ å›¾ç‰‡æ›¿æ¢æ·¡å…¥æ·¡å‡ºæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼› å›¾ç‰‡å°ºå¯¸çš„åŠ¨ç”»å¤„ç†å°±å¾ˆçªå…€ï¼šç›´æ¥ä»å¤§å˜æˆå°ï¼Œè€Œæ²¡æœ‰æ¸å˜çš„æ•ˆæœã€‚ ç”±äº Crossfade ä¹Ÿå¯ä»¥åŠ  label å‚æ•°ï¼Œæˆ‘ä»¬å†ä»åŠ¨ç”»é¢„è§ˆè§’åº¦çœ‹ä¸‹æ•ˆæœï¼š æ‰€ä»¥ï¼Œä¸ç®¡ä»å“ªä¸ªè§’åº¦æ¥çœ‹ï¼ŒCrossfade ä»…æ”¯æŒå¯¹ç•Œé¢æ˜¾ç¤ºçš„æ·¡å…¥æ·¡å‡ºæ•ˆæœçš„æ”¯æŒï¼Œè€Œä¸æ”¯æŒç•Œé¢å°ºå¯¸çš„æ¸å˜å˜åŒ–ã€‚å…¶å®ä½ ä»è¿™ä¸ª API çš„åç§°ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼šCrossfadeï¼Œä¹Ÿå°±æ˜¯ Cross + fadeã€‚ Crossï¼šäº¤å‰ï¼Œå¯ä»¥ç†è§£ä¸ºä¸¤ä¸ªå¯ç»„åˆé¡¹ç›´æ¥çš„äº¤å‰å˜æ¢è¿‡ç¨‹ fadeï¼šæ·¡å…¥æ·¡å‡ºï¼Œæˆ‘å°±æ˜¯ä¸€ä¸ªå®ç°æ·¡å…¥æ·¡å‡ºçš„ APIï¼Œå…¶ä»–äº‹ä½ åˆ«æ‰¾æˆ‘ã€‚ é‚£ä¸ç¦ä¼šæœ‰ç–‘é—®äº†ï¼Œè¿™ä¸ª API å¤ªé¸¡è‚‹äº†å§ï¼Ÿå…¶å®å¹¶ä¸æ˜¯ï¼ŒCompose å¾€å¾€ä¼šè®¾è®¡ä¸€äº›ç®€å•çš„åŠ¨ç”» APIï¼Œæä¾›ç»™å¼€å‘è€…æœ€å¿«é€Ÿã€ä¾¿æ·çš„ä½¿ç”¨ï¼Œå¾€å¾€æˆ‘ä»¬å¹¶ä¸éœ€è¦ç”¨æ›´ä¸ºå¤æ‚ã€åŠŸèƒ½æ›´ä¸ºå¼ºå¤§çš„ APIã€‚è¯´åˆ°è¿™é‡Œï¼Œä½ æ˜¯ä¸æ˜¯æƒ³èµ·æ¥ animateAsState å’Œ Animatable çš„å…³ç³»äº†ï¼ŸanimateAsState å°±æ˜¯ Animatable çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨æ›´ä¸ºç®€å•ã€‚ é‚£ä¹ˆ Crossfade éš¾é“ä¹Ÿæ˜¯æŸä¸ª API çš„ç®€åŒ–ç‰ˆæœ¬ï¼Ÿå¯¹çš„ï¼Œå®ƒå°±æ˜¯ AnimatedContent çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œåè€…æ›´ä¸ºå¼ºå¤§ï¼Œæ—¢èƒ½å¤„ç†ä¸åŒå¯ç»„åˆé¡¹ç›´æ¥çš„åˆ‡æ¢æ¸å˜ï¼Œä¹Ÿèƒ½å®ç°å¯¹å°ºå¯¸ç­‰å…¶ä»–å±æ€§çš„åˆ‡æ¢æ¸å˜æ•ˆæœã€‚","link":"/2024/08/20/Compose%20--%20%E5%8A%A8%E7%94%BB%20--%2006.%20%E7%AE%80%E5%8D%95%E9%A1%B5%E9%9D%A2%E5%88%87%E6%8D%A2%E5%8A%A8%E7%94%BB%20API%EF%BC%9ACrossfade/"},{"title":"æ›´å¼ºå¤§çš„å¤šç»„ä»¶åˆ‡æ¢åŠ¨ç”» APIï¼šAnimatedContent","text":"Jetpack Compose æä¾›äº†ä¸€ç³»åˆ—åŠŸèƒ½å¼ºå¤§ä¸”å¯æ‰©å±•çš„ APIï¼Œå¯ç”¨äºåœ¨åº”ç”¨ç•Œé¢ä¸­è½»æ¾å®ç°å„ç§åŠ¨ç”»æ•ˆæœã€‚è¿™ä¸€ç³»åˆ—æ–‡ç« ä¼šé€ä¸ªä»‹ç»æ‰€æœ‰çš„åŠ¨ç”» APIï¼Œé€šè¿‡æœ€ç›´è§‚çš„ Demo ç¤ºä¾‹ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ æ€ä¹ˆå†™åŠ¨ç”»ä»¥åŠå¸¦ä½ äº†è§£åŠ¨ç”»èƒŒåçš„åŸç†ã€‚ ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - çŠ¶æ€è½¬ç§»å‹åŠ¨ç”» APIï¼šanimate*AsState() ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æµç¨‹å®šåˆ¶å‹åŠ¨ç”» APIï¼šAnimatable() ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - è®²çš„ä¸èƒ½å†ç»†çš„ AnimationSpec åŠ¨ç”»è§„èŒƒ ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - è¿‡æ¸¡åŠ¨ç”» APIï¼šTransition ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æ˜¾ç¤ºä¸æ¶ˆå¤± APIï¼šAnimatedVisibility ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - ç®€å•é¡µé¢åˆ‡æ¢åŠ¨ç”» APIï¼šCrossfade ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æ›´å¼ºå¤§çš„å¤šç»„ä»¶åˆ‡æ¢åŠ¨ç”» APIï¼šAnimatedContent ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - ç»„ä»¶å¤§å°å˜åŒ– APIï¼šanimateContentSize ğŸ““ åŠ¨ç”»å›¾è¡¨ åœ¨æ¯ä¸€ç¯‡æ–‡ç« å¼€å¤´ï¼Œæˆ‘éƒ½ä¼šæ”¾ä¸€å¼  Compose åŠ¨ç”» API çš„å›¾è¡¨ï¼Œä»¥ä¾¿ä½ æœ‰æœ€ç›´è§‚çš„æ„Ÿå—ã€‚ ğŸ““ AnimatedContent() AnimatedContent ç”¨æ¥æ§åˆ¶å¤šä¸ªç»„ä»¶çš„å…¥åœºå’Œå‡ºåœºï¼ŒåŒæ—¶è¿˜èƒ½å¯¹å…¥åœºå’Œå‡ºåœºæ•ˆæœåšå®šåˆ¶ï¼Œç›¸å½“äºæ˜¯ AnimatedVisibility å’ŒCrossfade çš„ç»“åˆï¼ŒAnimatedContent å‡ºå…¥åœºåŠ¨ç”»æ•ˆæœçš„å°ºå¯¸æ˜¯æ¸å˜çš„ï¼Œè¿™ä¸ªæ˜¯åŒºåˆ«äº Crossfade çš„ä¸€ä¸ªç‚¹ã€‚ è¿˜æ˜¯é‚£å¥è¯ï¼šæ¢ç´¢æ–°æŠ€æœ¯çš„æœ€ä½³æ–¹å¼æ˜¯å°è¯•å®ƒä»¬ï¼Œæˆ‘ä»¬æŠŠ Crossfade é‚£ä¸ªä»£ç ç¤ºä¾‹æ¬è¿‡æ¥ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { cf() } }}@Composablefun cf() { var shown by remember { mutableStateOf(true) } Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Crossfade(targetState = shown, animationSpec = tween(3000), label = &quot;Crossfade&quot;) { if (it) { showCR7_1() } else { showCR7_2() } } Button( onClick = { shown = !shown} ) { Text(text = &quot;åˆ‡æ¢&quot;) } }}@Composablefun showCR7_1() { Image( painter = painterResource(R.drawable.cr7), contentDescription = null, modifier = Modifier .size(90.dp) .clip(shape = CircleShape) )}@Composablefun showCR7_2() { Image( painter = painterResource(R.drawable.cr7_2), contentDescription = null, modifier = Modifier .size(60.dp) .clip(shape = CircleShape) )} çœ‹ä¸‹æ•ˆæœï¼š Crossfade æ˜¯æ²¡æ³•å¯¹å°ºå¯¸å˜æ¢è¿›è¡Œæ¸å˜çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨æ¥çœ‹çœ‹ AnimatedContent çš„æ•ˆæœã€‚ 123456789101112131415161718192021222324252627@Preview@OptIn(ExperimentalAnimationApi::class)@Composablefun cf() { var shown by remember { mutableStateOf(true) } Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Spacer(modifier = Modifier.height(100.dp)) AnimatedContent(targetState = shown, label = &quot;AnimatedContent&quot;) { if (it) { showCR7_1() } else { showCR7_2() } } Button( onClick = { shown = !shown} ) { Text(text = &quot;åˆ‡æ¢&quot;) } }} çœ‹ä¸‹æ•ˆæœï¼š Perfectï¼æ•ˆæœè¦æ¯” Crossfade å¥½å¤šäº†ï¼Œä¸ä»…å›¾ç‰‡æ·¡å…¥æ·¡å‡ºï¼Œè€Œä¸”å°ºå¯¸å˜åŒ–ä¹Ÿæ˜¯æ¸å˜çš„ã€‚ ç°åœ¨æˆ‘ä»¬å†é€šè¿‡åŠ¨ç”»é¢„è§ˆçœ‹ä¸‹æ•ˆæœï¼š å¯ä»¥å¾ˆæ¸…æ™°çš„å‘ç°ï¼Œè¿™é‡Œæœ‰å¥½å‡ ç§å…¥åœºå’Œå‡ºåœºçš„åŠ¨ç”»æ•ˆæœï¼Œæˆ‘ä»¬ä¹‹å‰ç ”ç©¶è¿‡ AnimatedVisibilityï¼Œå®ƒæ˜¯å¯¹å•ä¸ªå†…å®¹çš„å‡ºç°å’Œæ¶ˆå¤±æ·»åŠ åŠ¨ç”»æ•ˆæœçš„ï¼Œä½†æˆ‘ä»¬è¿™é‡Œçš„åœºæ™¯æ˜¯å¯¹å¤šä¸ªå†…å®¹ï¼ˆå¤šä¸ªç»„ä»¶ï¼‰çš„å‡ºç°å’Œæ¶ˆå¤±æ·»åŠ åŠ¨ç”»æ•ˆæœï¼Œè€Œä¸”å®ƒçš„åŠ¨ç”»æ•ˆæœå¾ˆæ˜æ˜¾ç”¨åˆ°äº† AnimatedVisibilityï¼Œæ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ è¿™å°±æ¶‰åŠåˆ° AnimatedContent å‡½æ•°å®šä¹‰é‡Œé¢çš„ä¸€ä¸ªæ ¸å¿ƒå‚æ•°äº†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š 1234567891011121314@ExperimentalAnimationApi@Composablefun &lt;S&gt; AnimatedContent( targetState: S, modifier: Modifier = Modifier, transitionSpec: AnimatedContentScope&lt;S&gt;.() -&gt; ContentTransform = { fadeIn(animationSpec = tween(220, delayMillis = 90)) + scaleIn(initialScale = 0.92f, animationSpec = tween(220, delayMillis = 90)) with fadeOut(animationSpec = tween(90)) }, contentAlignment: Alignment = Alignment.TopStart, label: String = &quot;AnimatedContent&quot;, content: @Composable() AnimatedVisibilityScope.(targetState: S) -&gt; Unit) æˆ‘ä»¬å‘ç°å®ƒæœ‰ä¸€ä¸ªæ ¸å¿ƒå‚æ•°ï¼štransitionSpecï¼Œè€Œä¸”éœ€è¦ä¸€ä¸ª ContentTransform å¯¹è±¡ã€‚ ğŸ““ ContentTransform æˆ‘ä»¬çœ‹ä¸‹ ContentTransform çš„æ„é€ å‡½æ•°ï¼š 1234567891011@ExperimentalAnimationApiclass ContentTransform( val targetContentEnter: EnterTransition, val initialContentExit: ExitTransition, targetContentZIndex: Float = 0f, sizeTransform: SizeTransform? = SizeTransform()) { var targetContentZIndex by mutableStateOf(targetContentZIndex) var sizeTransform: SizeTransform? = sizeTransform internal set} å®ƒæœ‰å››ä¸ªæ ¸å¿ƒå‚æ•°ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªåˆ†æä¸‹ã€‚ targetContentEnterï¼šç›®æ ‡ç»„ä»¶å…¥åœºåŠ¨ç”» ä»€ä¹ˆæ˜¯ç›®æ ‡ç»„ä»¶çš„å…¥åœºåŠ¨ç”»ï¼Ÿå¯¹äºæˆ‘ä»¬è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œå°±æ˜¯ showCR7_2() è¿™ä¸ªå¯ç»„åˆé¡¹ã€‚ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/01cc2c120cc2ba1b1563ef233bdccc0a.png =200x) è¿™ä¸ªå…¥åœºåŠ¨ç”»åœ¨å“ªé‡Œè®¾å®šçš„ï¼Ÿæˆ‘ä»¬ä¹‹å‰çœ‹åˆ°è¿‡ï¼š 12345transitionSpec: AnimatedContentScope&lt;S&gt;.() -&gt; ContentTransform = { fadeIn(animationSpec = tween(220, delayMillis = 90)) + scaleIn(initialScale = 0.92f, animationSpec = tween(220, delayMillis = 90)) with fadeOut(animationSpec = tween(90))}, æˆ‘ä»¬æ¥åˆ†æä¸‹è¿™æ®µä»£ç ï¼š â‡’ fadeIn() + scaleIn() ä¸éš¾ç†è§£ï¼Œæˆ‘ä»¬åœ¨ AnimatedVisibility ä¸€æ–‡ä¸­è®²è¿‡ï¼Œè¿™æ˜¯æ·¡å…¥å’Œç¼©æ”¾ä¸¤ä¸ªå…¥åœºåŠ¨ç”»çš„åˆå¹¶ã€‚â‡’ fadeOut() ä¹Ÿä¸éš¾ç†è§£ï¼Œå®ƒæ˜¯å‡ºåœºæ·¡å‡ºçš„åŠ¨ç”»ã€‚ ä½†æ˜¯ with æ˜¯ä»€ä¹ˆï¼Ÿ 12@ExperimentalAnimationApiinfix fun EnterTransition.with(exit: ExitTransition) = ContentTransform(this, exit) åŸæ¥è¿™ä¹ˆç®€å•ï¼šç›´æ¥åˆ›å»ºäº† ContentTransformï¼Œå¹¶ä¸”ä½ çœ‹åˆ°å®ƒçš„å‚æ•°ä¹ˆï¼Ÿ 1234this -- fadeIn(animationSpec = tween(220, delayMillis = 90)) + scaleIn(initialScale = 0.92f, animationSpec = tween(220, delayMillis = 90))exit -- fadeOut(animationSpec = tween(90)) æ‰€ä»¥æ›´è¿›ä¸€æ­¥ï¼š 123456789class ContentTransform( val targetContentEnter: EnterTransition, val initialContentExit: ExitTransition,---targetContentEnter -- this -- fadeIn(animationSpec = tween(220, delayMillis = 90)) + scaleIn(initialScale = 0.92f, animationSpec = tween(220, delayMillis = 90))initialContentExit -- exit -- fadeOut(animationSpec = tween(90)) initialContentExitï¼šåˆå§‹ç»„ä»¶çš„å‡ºåœºåŠ¨ç”» ä»€ä¹ˆæ˜¯ç›®æ ‡ç»„ä»¶çš„å‡ºåœºåŠ¨ç”»ï¼Ÿå¯¹äºæˆ‘ä»¬è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œå°±æ˜¯ showCR7_1() è¿™ä¸ªå¯ç»„åˆé¡¹ã€‚ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/11223bc66ab469d620266b35ab2ebf71.png =200x) targetContentZIndexï¼šæ§åˆ¶ Z è½´é«˜åº¦ï¼Œæ§åˆ¶ç»˜åˆ¶é¡ºåºï¼Œé ä¸Šå°±é®ç›–åˆ«çš„ç»„ä»¶ ä¸€èˆ¬ä¸ç”¨é…ç½®è¿™ä¸ªå‚æ•°ï¼Œå› ä¸ºé»˜è®¤å…¥åœºçš„ç»„ä»¶éƒ½ä¼šåç»˜åˆ¶ï¼Œå‡ºåœºçš„å…ˆç»˜åˆ¶ã€‚ sizeTransformï¼šå¯¹å°ºå¯¸æ¸å˜åŠ¨ç”»çš„é…ç½® æˆ‘ä¸çŸ¥é“ä½ çœ‹ä¹‹å‰çš„åŠ¨ç”»çš„æ—¶å€™æœ‰æ²¡æœ‰å‘ç°ä¸€ä¸ªç–‘é—®ç‚¹ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹åŠ¨ç”»ï¼š å°ºå¯¸æ¸å˜çš„è¿‡ç¨‹ä¸­ï¼Œæ˜æ˜¾æœ‰è£åˆ‡çš„æ•ˆæœï¼Œè¿™ä¸ªå°±æ˜¯ sizeTransform å‚æ•°çš„åŸå› ã€‚ 1234567@ExperimentalAnimationApiclass ContentTransform( val targetContentEnter: EnterTransition, val initialContentExit: ExitTransition, targetContentZIndex: Float = 0f, sizeTransform: SizeTransform? = SizeTransform() // å¯¹å°ºå¯¸æ¸å˜åŠ¨ç”»çš„é…ç½®) æˆ‘ä»¬æ¥çœ‹ä¸‹ SizeTransform çš„æ„é€ å‡½æ•°ï¼š 123456@ExperimentalAnimationApifun SizeTransform( clip: Boolean = true, sizeAnimationSpec: (initialSize: IntSize, targetSize: IntSize) -&gt; FiniteAnimationSpec&lt;IntSize&gt; = { _, _ -&gt; spring(visibilityThreshold = IntSize.VisibilityThreshold) }): SizeTransform = SizeTransformImpl(clip, sizeAnimationSpec) å‘ç°äº†æ²¡ï¼ŸSizeTransform æœ‰ä¸¤ä¸ªå‚æ•°ï¼š clipï¼šæ˜¯å¦è£åˆ‡ sizeAnimationSpecï¼šåŠ¨ç”»æ›²çº¿è®¾ç½® åŠ¨ç”»æ›²çº¿è®¾ç½®å¤ªç†Ÿäº†ï¼Œæˆ‘ä»¬ä¸èŠäº†ï¼Œç°åœ¨æ¥çœ‹ä¸‹ä¸è£åˆ‡ä¼šæ˜¯ä»€ä¹ˆæ ·ã€‚ æ¯”å¦‚æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ª transitionSpecï¼š 12345678910111213141516171819202122232425262728@Composablefun cf() { var shown by remember { mutableStateOf(true) } Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Spacer(modifier = Modifier.height(100.dp)) AnimatedContent(targetState = shown, transitionSpec = { fadeIn(tween(1500)) with fadeOut(tween(1500, delayMillis = 1500)) }, label = &quot;AnimatedContent&quot;) { if (it) { showCR7_1() } else { showCR7_2() } } Button( onClick = { shown = !shown} ) { Text(text = &quot;åˆ‡æ¢&quot;) } }} çœ‹ä¸‹åŠ¨ç”»æ•ˆæœï¼š ç°åœ¨æˆ‘ä»¬æŠŠè£åˆ‡å…³æ‰ï¼Œåƒä¸‹é¢è¿™ä¹ˆå†™ï¼š 12transitionSpec = { fadeIn(tween(1500, delayMillis = 1500)) with fadeOut(tween(1500)) using SizeTransform(clip = false) }, using æ˜¯ä»€ä¹ˆï¼Ÿ 1234@ExperimentalAnimationApiinfix fun ContentTransform.using(sizeTransform: SizeTransform?) = this.apply { this.sizeTransform = sizeTransform} æ‡‚äº†å§ï¼Œç›´æ¥çœ‹æ•ˆæœï¼š","link":"/2024/08/25/Compose%20--%20%E5%8A%A8%E7%94%BB%20--%2007.%20%E6%9B%B4%E5%BC%BA%E5%A4%A7%E7%9A%84%E5%A4%9A%E7%BB%84%E4%BB%B6%E5%88%87%E6%8D%A2%E5%8A%A8%E7%94%BB%20API%EF%BC%9AAnimatedContent/"},{"title":"ç»„ä»¶å¤§å°å˜åŒ– APIï¼šanimateContentSize","text":"Jetpack Compose æä¾›äº†ä¸€ç³»åˆ—åŠŸèƒ½å¼ºå¤§ä¸”å¯æ‰©å±•çš„ APIï¼Œå¯ç”¨äºåœ¨åº”ç”¨ç•Œé¢ä¸­è½»æ¾å®ç°å„ç§åŠ¨ç”»æ•ˆæœã€‚è¿™ä¸€ç³»åˆ—æ–‡ç« ä¼šé€ä¸ªä»‹ç»æ‰€æœ‰çš„åŠ¨ç”» APIï¼Œé€šè¿‡æœ€ç›´è§‚çš„ Demo ç¤ºä¾‹ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ æ€ä¹ˆå†™åŠ¨ç”»ä»¥åŠå¸¦ä½ äº†è§£åŠ¨ç”»èƒŒåçš„åŸç†ã€‚ ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - çŠ¶æ€è½¬ç§»å‹åŠ¨ç”» APIï¼šanimate*AsState() ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æµç¨‹å®šåˆ¶å‹åŠ¨ç”» APIï¼šAnimatable() ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - è®²çš„ä¸èƒ½å†ç»†çš„ AnimationSpec åŠ¨ç”»è§„èŒƒ ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - è¿‡æ¸¡åŠ¨ç”» APIï¼šTransition ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æ˜¾ç¤ºä¸æ¶ˆå¤± APIï¼šAnimatedVisibility ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - ç®€å•é¡µé¢åˆ‡æ¢åŠ¨ç”» APIï¼šCrossfade ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - æ›´å¼ºå¤§çš„å¤šç»„ä»¶åˆ‡æ¢åŠ¨ç”» APIï¼šAnimatedContent ğŸ“‘ æ‰‹æŠŠæ‰‹æ•™ä½ å†™ Compose åŠ¨ç”» - - ç»„ä»¶å¤§å°å˜åŒ– APIï¼šanimateContentSize ğŸ““ åŠ¨ç”»å›¾è¡¨ åœ¨æ¯ä¸€ç¯‡æ–‡ç« å¼€å¤´ï¼Œæˆ‘éƒ½ä¼šæ”¾ä¸€å¼  Compose åŠ¨ç”» API çš„å›¾è¡¨ï¼Œä»¥ä¾¿ä½ æœ‰æœ€ç›´è§‚çš„æ„Ÿå—ã€‚ ğŸ““ animateContentSize() animateContentSize ä¿®é¥°ç¬¦å¯ä¸º Compose ç»„ä»¶å¤§å°å˜åŒ–æ—¶æ·»åŠ åŠ¨ç”»æ•ˆæœã€‚ è¿˜æ˜¯é‚£å¥è¯ï¼šæ¢ç´¢æ–°æŠ€æœ¯çš„æœ€ä½³æ–¹å¼æ˜¯å°è¯•å®ƒä»¬ï¼Œæˆ‘ä»¬å…ˆæ„å»ºä¸€ä¸ªç®€å•åœºæ™¯ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { animateContentSizeTest() } }}@Composablefun animateContentSizeTest() { var longString by remember { mutableStateOf(false) } val text by remember(longString) { mutableStateOf( if (longString) &quot;Hi, Compose, this is long description!&quot; else &quot;Hi, Compose!&quot; ) } Column ( modifier = Modifier.fillMaxWidth(), verticalArrangement = Arrangement.Center, horizontalAlignment = Alignment.CenterHorizontally ) { Spacer(modifier = Modifier.height(100.dp)) Button( onClick = { longString = !longString } ) { Text(text = &quot;æ”¹å˜ Text é•¿åº¦&quot;) } Box( Modifier .background(Color.Green)) { Text(text = text) } }} ç°åœ¨ä½ çœ‹è¿™æ®µä»£ç åº”è¯¥æ¯«æ— å‹åŠ›äº†ï¼Œæˆ‘ä»¬çœ‹ä¸‹æ•ˆæœï¼š å¯ä»¥çœ‹å‡ºæ¥ï¼ŒBox çš„é•¿åº¦ä¼šéšç€ Text ç»„ä»¶çš„æ–‡å­—é•¿åº¦è€Œå˜åŒ–ï¼Œä½†æ˜¯è¿™ç§é•¿åº¦å˜åŒ–å¾ˆæ˜æ˜¾æ²¡æœ‰åŠ¨ç”»æ•ˆæœã€‚ å¦‚æœæˆ‘ä»¬æƒ³è®© Box ç»„ä»¶é•¿åº¦å˜åŒ–ä¹Ÿæœ‰åŠ¨ç”»æ•ˆæœçš„è¯ï¼Œå°±å¯ä»¥ä½¿ç”¨ animateContentSize ä¿®é¥°ç¬¦ã€‚ æ—¢ç„¶æ˜¯ä¿®é¥°ç¬¦ï¼Œé‚£è‚¯å®šå°±æ˜¯ç”¨åœ¨ Modifier ä¸­çš„ï¼Œæ‰€ä»¥ä»£ç å†™èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼š 123456Box( Modifier .background(Color.Green) .animateContentSize()) { // åªéœ€è¦å¯¹ Box æ·»åŠ  Modifier.animateContentSize() Text(text = text)} å°±è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬çœ‹ä¸‹æ•ˆæœï¼š animateContentSize() çš„ç”¨æ³•å°±è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹å®ƒçš„å®šä¹‰ï¼š 1234fun Modifier.animateContentSize( animationSpec: FiniteAnimationSpec&lt;IntSize&gt; = spring(), finishedListener: ((initialValue: IntSize, targetValue: IntSize) -&gt; Unit)? = null) å®ƒåŒæ ·å¯ä»¥è‡ªè¡Œè®¾å®šåŠ¨ç”»æ›²çº¿ï¼ˆé»˜è®¤æ˜¯å¼¹ç°§æ•ˆæœ - - ä¸å¼¹ï¼‰ï¼Œç°åœ¨æˆ‘ä»¬è¯•ä¸‹å®ƒèƒ½å¤Ÿå¼¹çš„æ•ˆæœï¼š 123456Box( Modifier .background(Color.Green) .animateContentSize(animationSpec = spring(Spring.DampingRatioHighBouncy))) { Text(text = text)}","link":"/2024/08/31/Compose%20--%20%E5%8A%A8%E7%94%BB%20--%2008.%20%E7%BB%84%E4%BB%B6%E5%A4%A7%E5%B0%8F%E5%8F%98%E5%8C%96%20API%EF%BC%9AanimateContentSize/"},{"title":"Compose æ˜¯å¦‚ä½•å°†æ•°æ®è½¬æ¢æˆ UI çš„ï¼Ÿ","text":"Compose æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ UI æ¡†æ¶ï¼Œæä¾›äº†å¾ˆå¤šå¼€ç®±å³ç”¨çš„ç»„ä»¶ï¼Œæ¯”å¦‚ Text()ã€Buttonã€Image() ç­‰ç­‰ï¼ŒCompose ä¼šç»è¿‡å‡ ä¸ªä¸åŒçš„é˜¶æ®µï¼Œæœ€ç»ˆæ¸²æŸ“å‡º UI ç•Œé¢ã€‚ æ­¤è½¬æ¢è¿‡ç¨‹åˆ†ä¸ºã€ä¸‰ä¸ªé˜¶æ®µã€‘ï¼š ç»„åˆï¼š æ˜¾ç¤ºä»€ä¹ˆ å¸ƒå±€ï¼š æ”¾åœ¨å“ªé‡Œ ç»˜åˆ¶ï¼š å¦‚ä½•æ¸²æŸ“ è¿™ä¸‰ä¸ªé˜¶æ®µæ˜¯é€ä¸€æ‰§è¡Œçš„ï¼Œæµç¨‹å¦‚ä¸‹ï¼š # ç»„åˆé˜¶æ®µåœ¨ç»„åˆé˜¶æ®µï¼ŒCompose è¿è¡Œæ—¶ä¼šæ‰§è¡Œä»£ç ä¸­å®šä¹‰çš„å¯ç»„åˆå‡½æ•°ï¼Œæœ€ç»ˆä¼šç”Ÿæˆä¸€æ£µè§†å›¾æ ‘ã€‚è¿™ä¸ªè§†å›¾æ ‘ç”±ä¸€ä¸ªä¸ªå¸ƒå±€èŠ‚ç‚¹ï¼šLayoutNode ç»„æˆã€‚æ¯”å¦‚ Text()ã€Button() éƒ½å¯¹åº”ä¸€ä¸ª LayoutNodeï¼Œè¿™äº› LayoutNode æŒæœ‰ç»„ä»¶çš„æ‰€æœ‰ä¿¡æ¯ã€‚ æ›´å½¢è±¡ä¸€ç‚¹çš„ç»“æ„å¦‚ä¸‹ï¼š è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ç¤ºä¾‹ï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬å®šä¹‰çš„å¯ç»„åˆé¡¹åŒ…å«é€»è¾‘å’Œæ§åˆ¶æµï¼Œè€Œ Compose ä¼šåœ¨ä¸åŒçŠ¶æ€çš„æƒ…å†µä¸‹ç”Ÿæˆä¸åŒçš„æ ‘ã€‚ # å¸ƒå±€é˜¶æ®µå¸ƒå±€é˜¶æ®µï¼Œå¯¹äºè§†å›¾æ ‘ä¸­çš„æ¯ä¸ª LayoutNode èŠ‚ç‚¹è¿›è¡Œå®½é«˜å°ºå¯¸æµ‹é‡å¹¶å®Œæˆä½ç½®æ‘†æ”¾ï¼Œå¸ƒå±€å…ƒç´ éƒ½ä¼šæ ¹æ® 2D åæ ‡æ¥æµ‹é‡å¹¶æ”¾ç½®è‡ªå·±åŠå…¶æ‰€æœ‰å­å…ƒç´ ã€‚ å…¶å® Compose çš„å¸ƒå±€é˜¶æ®µå’Œä¼ ç»Ÿçš„ View ç³»ç»Ÿå¾ˆåƒï¼ˆæµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶ï¼‰ï¼Œå”¯ç‹¬å¤šäº†ä¸€ä¸ªã€Œ ç»„åˆé˜¶æ®µ ã€ï¼Œè€Œ Compose æŠŠ æµ‹é‡å’Œå¸ƒå±€ ç»Ÿä¸€æ”¾å…¥äº†ã€Œ å¸ƒå±€é˜¶æ®µ ã€ã€‚ åœ¨å¸ƒå±€é˜¶æ®µï¼Œä½¿ç”¨ä»¥ä¸‹ 3 æ­¥ç®—æ³•éå† LayoutNode æ ‘ï¼š æµ‹é‡å­èŠ‚ç‚¹ï¼š æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¼šæµ‹é‡å®ƒçš„å­èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰çš„è¯ã€‚ å†³å®šè‡ªå·±çš„å¤§å°ï¼š åŸºäºè¿™äº›æµ‹é‡ï¼ŒèŠ‚ç‚¹å†³å®šè‡ªå·±çš„å¤§å°ã€‚ æ”¾ç½®å­èŠ‚ç‚¹ï¼š æ¯ä¸ªå­èŠ‚ç‚¹éƒ½ç›¸å¯¹äºèŠ‚ç‚¹è‡ªèº«çš„ä½ç½®è¿›è¡Œæ”¾ç½®ã€‚ å¸ƒå±€é˜¶æ®µç»“æŸåï¼Œæ¯ä¸ª LayoutNode éƒ½å°†åˆ†é…ä¸€ä¸ª å®½åº¦ å’Œ é«˜åº¦ï¼Œä»¥åŠä¸€ä¸ªåº”è¯¥ç»˜åˆ¶çš„ xã€y åæ ‡ã€‚ æ¯”å¦‚ï¼šæˆ‘ä»¬ç°åœ¨åˆ†æä¸‹é¢è¿™ä¸ªç®€å•ç¤ºä¾‹çš„å¸ƒå±€æµç¨‹ã€‚ å¸ƒå±€æµç¨‹ï¼š çœ‹åˆ°è¿™ï¼Œæ˜¯ä¸æ˜¯å‘ç°ä¸ªå¾ˆç‰›é€¼çš„äº‹ï¼Ÿ **æˆ‘ä»¬åªè®¿é—®äº†æ¯ä¸ªèŠ‚ç‚¹ä¸€æ¬¡ã€‚é€šè¿‡è§†å›¾æ ‘çš„ä¸€æ¬¡éå†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æµ‹é‡å’Œæ”¾ç½®æ‰€æœ‰èŠ‚ç‚¹**ã€‚ è¿™å¯¹æ€§èƒ½æ¥è¯´å°±å¾ˆé‡è¦äº†ï¼å½“æ ‘ä¸­èŠ‚ç‚¹çš„æ•°é‡å¢åŠ æ—¶ï¼Œéå†å®ƒæ‰€èŠ±è´¹çš„æ—¶é—´åªä¼šä»¥çº¿æ€§æ–¹å¼å¢åŠ ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬å¤šæ¬¡è®¿é—®æ¯ä¸ªèŠ‚ç‚¹ï¼Œéå†æ—¶é—´åˆ™ä¼šä»¥å‘ˆæŒ‡æ•°çº§å¢åŠ ã€‚ # ç»˜åˆ¶é˜¶æ®µç»˜åˆ¶é˜¶æ®µï¼Œæ ‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åœ¨å±å¹•ä¸Šç»˜åˆ¶å…¶åƒç´ ã€‚ ä¸Šé¢æˆ‘ä»¬è¯´è¿‡ï¼Œåœ¨å¸ƒå±€é˜¶æ®µç»“æŸåï¼Œæ‰€æœ‰å¸ƒå±€èŠ‚ç‚¹ä¼šå¾—åˆ°å®ƒä»¬çš„ å®½åº¦ å’Œ é«˜åº¦ï¼Œä»¥åŠ xã€y åæ ‡ã€‚æ‰€ä»¥ç°åœ¨å°±å¯ä»¥è¿›å…¥ç»˜åˆ¶é˜¶æ®µäº†ã€‚ ç»˜åˆ¶é˜¶æ®µä¼šä»ä¸Šåˆ°ä¸‹å†æ¬¡éå†æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¾æ¬¡åœ¨å±å¹•ä¸Šç»˜åˆ¶è‡ªå·±ã€‚ é¦–å…ˆ Row å°†ç»˜åˆ¶å®ƒå¯èƒ½å…·æœ‰çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚èƒŒæ™¯è‰²ã€‚ç„¶å Image å°†ç»˜åˆ¶è‡ªå·±ï¼Œç„¶åæ˜¯ Columnï¼Œç„¶åæ˜¯ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ª Textã€‚ # Modifier ä¿®é¥°ç¬¦ä¸Šé¢æˆ‘ä»¬ç»™çš„ç®€å•ä»£ç ç¤ºä¾‹éƒ½åªæ˜¯ç”¨äº†ä¸€äº› Compose æä¾›ç»™æˆ‘ä»¬çš„ç°åœºçš„ç»„ä»¶ï¼Œå®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªå¤§ç¥çº§åˆ«ä¸€æ ·çš„ä¿®é¥°ç¬¦éšå¤„å¯è§ï¼Œå®ƒå°±æ˜¯ï¼šModifier ä¿®é¥°ç¬¦ã€‚ æ¯”å¦‚ï¼šModifier.padding æ˜¯ç”¨æ¥ç»™ç»„ä»¶è®¾ç½®è¾¹è·çš„ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª LayoutModifierï¼Œè€Œ LayoutModifier ä¼šå½±å“ç»„ä»¶çš„æµ‹é‡å’Œå¸ƒå±€æ•ˆæœï¼Œä¼šå½±å“åˆ°ç»„åˆé¡¹çš„æ•´ä½“ UI æ•ˆæœã€‚å…·ä½“å¦‚ä½•å½±å“ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¸è®²å®ƒçš„æ·±å±‚æ¬¡åŸç†ï¼Œè€Œåªæ˜¯æ¢è®¨æ€ç»´æ¨¡å‹ã€‚ æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³äº†è§£ LayoutModifier çš„åŸç†ï¼Œå¯ä»¥é˜…è¯» ã€ èŠèŠ Jetpack Compose åŸç† â€“ LayoutModifier å’Œ Modifier.layout ã€‘ è¿™ç¯‡æ–‡ç« ã€‚ å›åˆ°æ­£é¢˜ï¼Œå¦‚æœæˆ‘ä»¬åŠ äº† Modifier ä¿®é¥°ç¬¦ï¼Œé‚£ä¹ˆåœ¨æœ€ç»ˆç”Ÿæˆçš„è§†å›¾æ ‘ä¸­ï¼Œå¯ä»¥å°† Modifier ä¿®é¥°ç¬¦å¯è§†åŒ–ä¸ºå¸ƒå±€èŠ‚ç‚¹çš„åŒ…è£…èŠ‚ç‚¹ï¼š å½“æˆ‘ä»¬é“¾æ¥å¤šä¸ªä¿®é¥°ç¬¦æ—¶ï¼Œæ¯ä¸ªä¿®é¥°ç¬¦èŠ‚ç‚¹åŒ…è£¹é“¾çš„å…¶ä½™éƒ¨åˆ†å’Œå…¶ä¸­çš„å¸ƒå±€èŠ‚ç‚¹ã€‚ ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬é“¾æ¥ä¸€ä¸ª clip å’Œä¸€ä¸ª size ä¿®é¥°ç¬¦æ—¶ï¼Œclip ä¿®é¥°ç¬¦èŠ‚ç‚¹åŒ…è£¹ size ä¿®é¥°ç¬¦èŠ‚ç‚¹ï¼Œç„¶ååŒ…è£¹ Image å¸ƒå±€èŠ‚ç‚¹ã€‚ è¿™é‡Œä½ å¯èƒ½æœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯å…ˆ clip ç„¶å sizeï¼Œè€Œæ˜¯å…ˆ size ç„¶ååœ¨ clipï¼Ÿçœ‹å®Œ ã€ èŠèŠ Jetpack Compose åŸç† â€“ LayoutModifier å’Œ Modifier.layout ã€‘ è¿™ç¯‡æ–‡ç« ä½ å°±æ‡‚äº†ã€‚ æ¥ç€è¯´ï¼Œåœ¨å¸ƒå±€é˜¶æ®µï¼Œæˆ‘ä»¬ç”¨æ¥éå†æ ‘çš„ç®—æ³•ä¿æŒä¸å˜ï¼Œä½† æ¯ä¸ªä¿®é¥°ç¬¦èŠ‚ç‚¹ä¹Ÿä¼šè¢«è®¿é—®ã€‚è¿™æ ·ï¼Œä¿®é¥°ç¬¦å¯ä»¥æ›´æ”¹å…¶åŒ…è£¹çš„ ä¿®é¥°ç¬¦ æˆ– å¸ƒå±€èŠ‚ç‚¹ çš„ å¤§å°è¦æ±‚ å’Œ ä½ç½®ã€‚ å¦‚æœæˆ‘ä»¬çœ‹ä¸€ä¸‹ Image å¯ç»„åˆé¡¹çš„å®ç°ï¼ˆåº•å±‚æ›´ç»†çš„å®ç°ï¼‰ï¼Œå®é™…ä¸Šå¯ä»¥çœ‹åˆ°å®ƒæœ¬èº«ç”±åŒ…è£¹å•ä¸ªå¸ƒå±€èŠ‚ç‚¹çš„ä¿®é¥°ç¬¦é“¾ç»„æˆã€‚ç±»ä¼¼åœ°ï¼ŒText å¯ç»„åˆé¡¹ä¹Ÿæ˜¯é€šè¿‡åŒ…å«å¸ƒå±€èŠ‚ç‚¹çš„ä¿®é¥°ç¬¦é“¾å®ç°çš„ã€‚æœ€åï¼ŒRow å’Œ Column çš„å®ç°åªæ˜¯æè¿°å¦‚ä½•å¸ƒç½®å…¶å­èŠ‚ç‚¹çš„å¸ƒå±€èŠ‚ç‚¹ï¼š çœ‹ä¸æ‡‚è¿™å¼ å›¾ï¼Ÿæ²¡äº‹ï¼Œè¿™äº›ç»†èŠ‚åŸç†éƒ½ä¼šæœ‰æ–‡ç« è¾“å‡ºï¼Œæ¯”å¦‚æˆ‘åˆšåˆšæåˆ°äº†ä¸¤æ¬¡çš„åŸç†æ–‡ç« ã€‚","link":"/2024/07/01/Compose%20--%20%E5%8E%9F%E7%90%86%20--%20Compose%20%E6%98%AF%E5%A6%82%E4%BD%95%E5%B0%86%E6%95%B0%E6%8D%AE%E8%BD%AC%E6%8D%A2%E6%88%90%20UI%20%E7%9A%84%EF%BC%9F/"},{"title":"Android 14.0 Launcher -- Folder å®šåˆ¶","text":"å…ˆä¸»è§‚æ„Ÿå—ä¸‹åŸç”Ÿ AOSP é»˜è®¤çš„ Folder æ•ˆæœï¼š è¦æƒ³å¯¹ Folder å®šåˆ¶ï¼Œç½‘ä¸Šèƒ½æ‰¾å‡ºä¸€å †ç°æˆçš„ä»£ç ï¼Œä¿®ä¿®è¡¥è¡¥åŸºæœ¬ä¸Šèƒ½æ»¡è¶³ä½  80% éœ€æ±‚ï¼Œä½†æ­£æ‰€è°“ï¼šçŸ¥å…¶ç„¶è€Œä¸çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œå°±ä¼šå¯¼è‡´å‡ºç° Bug åï¼Œä½ å°±ä¼šæ— ä»ä¸‹æ‰‹ï¼Œç„¶åé€æ¸é™·å…¥ï¼Œæ— æ³•è‡ªæ‹”ï¼Œä»£ç è¶Šå†™è¶Šä¹±ï¼Œè€Œè¿™ç¯‡æ–‡ç« å°±æ˜¯å¸®ä½ æ·±åˆ»äº†è§£åŸç†ï¼Œé€å½»æºç é€»è¾‘ï¼Œä»»ä½•éœ€æ±‚åœ¨ä½ é¢å‰éƒ½å¯ä»¥å¾ˆå¿«å®ç°ï¼ˆä½ å°±è¯´æˆ‘è¿™ä¸ªé€¼è£…çš„å¥½ä¸å¥½å§ï¼‰ï¼ Folder çš„ä¸»è¦ä»£ç å…¨éƒ¨åœ¨ï¼š/packages/apps/Launcher3/src/com/android/launcher3/folder ç›®å½•ä¸‹ï¼Œä¸»è¦ 14 ä¸ªç±»ã€‚ ç±» ä½œç”¨ ClippedFolderIconLayoutRule æ–‡ä»¶å¤¹å›¾æ ‡å†…éƒ¨æ˜¾ç¤ºå°å›¾æ ‡ç¼©ç•¥å›¾çš„è®¡ç®—ç±» Folder FolderAnimationManager FolderGridOrganizer å±•å¼€æ–‡ä»¶å¤¹æ˜¾ç¤ºçš„è®¡ç®—é€»è¾‘ç±»ï¼Œæ–‡ä»¶å¤¹å›¾æ ‡å‘ˆç°ç½‘æ ¼çŠ¶ï¼Œæ­¤ç±»ä¸»è¦ç»™æ–‡ä»¶å¤¹å„åº”ç”¨å›¾æ ‡åˆ¶å®šæ˜¾ç¤ºè§„åˆ™ï¼Œæ¯”å¦‚ï¼š33, 44 FolderIcon æ¡Œé¢ç»˜åˆ¶æ–‡ä»¶å¤¹å›¾æ ‡ FolderNameEditText FolderNameInfos FolderNameProvider FolderPagedView FolderPreviewItemAnim LauncherDelegate PreviewBackground PreviewItemDrawingParams PreviewItemManager æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¼€å§‹æ·±å…¥è§£æè¿™äº›æ ¸å¿ƒç±»ï¼Œäº†è§£æ¸…æ¥š Folder åˆ°åº•æ˜¯å¦‚ä½•æ˜¾ç¤ºã€åŠ¨ç”»æ˜¯å¦‚ä½•åˆ‡æ¢ã€ä»¥åŠå¦‚ä½•å¯¹ AOSP åŸç”Ÿçš„ Folder åšå®šåˆ¶ï¼ FolderIconFolderIcon.java æ˜¯ Launcher3 æ¡Œé¢ç»˜åˆ¶æ–‡ä»¶å¤¹å›¾æ ‡çš„ä¸€ä¸ªå…³é”®çš„ç±»ã€‚ init()1234567891011121314151617181920212223242526272829ğŸ“„ æºç è·¯å¾„ï¼špackages/app/Launcher3/src/com/android/launcher3/folder/FolderIcon.javapublic class FolderIcon extends FrameLayout implements FolderListener, IconLabelDotView, DraggableView, Reorderable { ClippedFolderIconLayoutRule mPreviewLayoutRule; private PreviewItemManager mPreviewItemManager; public FolderIcon(Context context, AttributeSet attrs) { super(context, attrs); // è°ƒç”¨ init() æ–¹æ³•åˆå§‹åŒ– init(); } public FolderIcon(Context context) { super(context); init(); } private void init() { mLongPressHelper = new CheckLongPressHelper(this); // åˆ›å»º ClippedFolderIconLayoutRule å¯¹è±¡ï¼Œè®°ä½è¿™ä¸ª mPreviewLayoutRule ï¼ mPreviewLayoutRule = new ClippedFolderIconLayoutRule(); // åˆ›å»º PreviewItemManager å¯¹è±¡ mPreviewItemManager = new PreviewItemManager(this); mDotParams = new DotRenderer.DrawParams(); }} dispatchDraw()123456789101112131415161718192021222324252627282930313233ğŸ“„ æºç è·¯å¾„ï¼špackages/app/Launcher3/src/com/android/launcher3/folder/FolderIcon.javapublic class FolderIcon extends FrameLayout implements FolderListener, IconLabelDotView, DraggableView, Reorderable { private PreviewItemManager mPreviewItemManager; @Override protected void dispatchDraw(Canvas canvas) { super.dispatchDraw(canvas); if (!mBackgroundIsVisible) return; // æ ¸å¿ƒ 1: é‡æ–°è®¡ç®—å›¾æ ‡çš„å„é¡¹å‚æ•° mPreviewItemManager.recomputePreviewDrawingParams(); if (!mBackground.drawingDelegated()) { mBackground.drawBackground(canvas); } if (mCurrentPreviewItems.isEmpty() &amp;&amp; !mAnimating) return; // æ ¸å¿ƒ 2: ç»˜åˆ¶æ–‡ä»¶å¤¹é¢„è§ˆå›¾ mPreviewItemManager.draw(canvas); if (!mBackground.drawingDelegated()) { mBackground.drawBackgroundStroke(canvas); } drawDot(canvas); }} PreviewItemManagerPreviewItemManager.java ç±»æ˜¯ç”¨æ¥ç®¡ç† FolderIconã€Œæ–‡ä»¶å¤¹é¢„è§ˆå›¾ã€ä¸­ PreviewItemDrawingParamsã€Œæ–‡ä»¶å¤¹ä¸­åº”ç”¨é¢„è§ˆé¡¹ã€â€“ ã€Œç»˜å›¾ã€å’Œã€ŒåŠ¨ç”»å‚æ•°ã€çš„ã€‚ é‡æ–°è®¡ç®—å›¾æ ‡å‚æ•°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100ğŸ“„ æºç è·¯å¾„ï¼špackages/app/Launcher3/src/com/android/launcher3/folder/PreviewItemManager.javapublic class PreviewItemManager { public void recomputePreviewDrawingParams() { if (mReferenceDrawable != null) { // è°ƒç”¨ computePreviewDrawingParams() æ–¹æ³• computePreviewDrawingParams(mReferenceDrawable.getIntrinsicWidth(), mIcon.getMeasuredWidth()); } } private void computePreviewDrawingParams(int drawableSize, int totalSize) { if (mIntrinsicIconSize != drawableSize || mTotalWidth != totalSize || mPrevTopPadding != mIcon.getPaddingTop()) { mIntrinsicIconSize = drawableSize; mTotalWidth = totalSize; mPrevTopPadding = mIcon.getPaddingTop(); mIcon.mBackground.setup(mIcon.getContext(), mIcon.mActivity, mIcon, mTotalWidth, mIcon.getPaddingTop()); // è°ƒç”¨äº† FolderIcon.mPreviewLayoutRule.init() æ–¹æ³•åšä¸€äº›åˆå§‹åŒ–å·¥ä½œ mIcon.mPreviewLayoutRule.init(mIcon.mBackground.previewSize, mIntrinsicIconSize, Utilities.isRtl(mIcon.getResources())); // è°ƒç”¨ updatePreviewItems() æ–¹æ³•ï¼Œæ³¨æ„å‚æ•°ä¼ çš„æ˜¯ false updatePreviewItems(false); } } void updatePreviewItems(boolean animate) { int numOfPrevItemsAux = mFirstPageParams.size(); // è°ƒç”¨ buildParamsForPage() æ–¹æ³•ï¼Œæ³¨æ„ï¼šç¬¬ 3 ä¸ªå‚æ•°æ˜¯ false buildParamsForPage(0, mFirstPageParams, animate); mNumOfPrevItems = numOfPrevItemsAux; } void buildParamsForPage(int page, ArrayList&lt;PreviewItemDrawingParams&gt; params, boolean animate) { // è¿™ä¸ª items æ˜¯ç”¨æ¥å­˜å‚¨å½“å‰åº”ç”¨å›¾æ ‡é¢„è§ˆé¡¹åˆ—è¡¨çš„ List&lt;WorkspaceItemInfo&gt; items = mIcon.getPreviewItemsOnPage(page); // We adjust the size of the list to match the number of items in the preview. while (items.size() &lt; params.size()) { // å…ˆç§»é™¤ params ä¸­çš„ items params.remove(params.size() - 1); } while (items.size() &gt; params.size()) { // å†ä¸€ä¸ªä¸ªæ·»åŠ è¿›å» params.add(new PreviewItemDrawingParams(0, 0, 0)); } int numItemsInFirstPagePreview = page == 0 ? items.size() : MAX_NUM_ITEMS_IN_PREVIEW; for (int i = 0; i &lt; params.size(); i++) { // æ‹¿åˆ°å•ä¸ª PreviewItemDrawingParams å¯¹è±¡ï¼Œè¿™é‡Œçš„ PreviewItemDrawingParams å°±æ˜¯å•ä¸ªåº”ç”¨å›¾æ ‡é¢„è§ˆé¡¹ PreviewItemDrawingParams p = params.get(i); setDrawable(p, items.get(i)); // ä¸Šé¢ä¼ é€’ç¬¬ä¸‰ä¸ªå‚æ•° animate ä¸º falseï¼Œæ‰€ä»¥ä¼šè¿›å…¥è¿™ä¸ª if åˆ¤æ–­ if (!animate) { if (p.anim != null) { p.anim.cancel(); } // è°ƒç”¨ computePreviewItemDrawingParams() æ–¹æ³• computePreviewItemDrawingParams(i, numItemsInFirstPagePreview, p); if (mReferenceDrawable == null) { mReferenceDrawable = p.drawable; } } else { FolderPreviewItemAnim anim = new FolderPreviewItemAnim(this, p, i, mNumOfPrevItems, i, numItemsInFirstPagePreview, DROP_IN_ANIMATION_DURATION, null); if (p.anim != null) { if (p.anim.hasEqualFinalState(anim)) { // do nothing, let the current animation finish continue; } p.anim.cancel(); } p.anim = anim; p.anim.start(); } } } PreviewItemDrawingParams computePreviewItemDrawingParams(int index, int curNumItems, PreviewItemDrawingParams params) { // We use an index of -1 to represent an icon on the workspace for the destroy and // create animations // index ä¸ºæ–‡ä»¶å¤¹ä¸­åº”ç”¨é¢„è§ˆé¡¹çš„ä¸‹æ ‡ï¼Œä¸€èˆ¬æ¥è¯´ &gt;=0 if (index == -1) { return getFinalIconParams(params); } // è°ƒç”¨äº† FolderIcon.mPreviewLayoutRule.computePreviewItemDrawingParams() æ–¹æ³• return mIcon.mPreviewLayoutRule.computePreviewItemDrawingParams(index, curNumItems, params); } private final FolderIcon mIcon;} è¿˜è®°å¾— FolderIcon.mPreviewLayoutRule æ˜¯ä»€ä¹ˆå—ï¼Ÿâ€“ ClippedFolderIconLayoutRule å¯¹è±¡ï¼ ç»˜åˆ¶æ–‡ä»¶å¤¹é¢„è§ˆå›¾12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364```javağŸ“„ æºç è·¯å¾„ï¼špackages/app/Launcher3/src/com/android/launcher3/folder/PreviewItemManager.javapublic class PreviewItemManager { public void draw(Canvas canvas) { int saveCount = canvas.getSaveCount(); // The items are drawn in coordinates relative to the preview offset PreviewBackground bg = mIcon.getFolderBackground(); Path clipPath = bg.getClipPath(); float firstPageItemsTransX = 0; if (mShouldSlideInFirstPage) { PointF firstPageOffset = new PointF(bg.basePreviewOffsetX + mCurrentPageItemsTransX, bg.basePreviewOffsetY); boolean shouldClip = mCurrentPageItemsTransX &gt; mClipThreshold; drawParams(canvas, mCurrentPageParams, firstPageOffset, shouldClip, clipPath); firstPageItemsTransX = -ITEM_SLIDE_IN_OUT_DISTANCE_PX + mCurrentPageItemsTransX; } PointF firstPageOffset = new PointF(bg.basePreviewOffsetX + firstPageItemsTransX, bg.basePreviewOffsetY); boolean shouldClipFirstPage = firstPageItemsTransX &lt; -mClipThreshold; // è°ƒç”¨ drawParams() æ–¹æ³• drawParams(canvas, mFirstPageParams, firstPageOffset, shouldClipFirstPage, clipPath); canvas.restoreToCount(saveCount); } public void drawParams(Canvas canvas, ArrayList&lt;PreviewItemDrawingParams&gt; params, PointF offset, boolean shouldClipPath, Path clipPath) { // è¿™é‡Œä¼ è¿›æ¥çš„ ArrayList&lt;PreviewItemDrawingParams&gt; params å°±æ˜¯æ¯ä¸ªæ–‡ä»¶å¤¹ä¸­åº”ç”¨å›¾æ ‡çš„ List // The first item should be drawn last (ie. on top of later items) for (int i = params.size() - 1; i &gt;= 0; i--) { PreviewItemDrawingParams p = params.get(i); if (!p.hidden) { // Exiting param should always be clipped. boolean isExiting = p.index == EXIT_INDEX; // éå†æ–‡ä»¶å¤¹ä¸­æ¯ä¸ªå›¾æ ‡ï¼Œè¿›è¡Œç»˜åˆ¶ drawPreviewItem(canvas, p, offset, isExiting | shouldClipPath, clipPath); } } } private void drawPreviewItem(Canvas canvas, PreviewItemDrawingParams params, PointF offset, boolean shouldClipPath, Path clipPath) { canvas.save(); if (shouldClipPath) { canvas.clipPath(clipPath); } canvas.translate(offset.x + params.transX, offset.y + params.transY); canvas.scale(params.scale, params.scale); Drawable d = params.drawable; if (d != null) { Rect bounds = d.getBounds(); canvas.save(); canvas.translate(-bounds.left, -bounds.top); canvas.scale(mIntrinsicIconSize / bounds.width(), mIntrinsicIconSize / bounds.height()); d.draw(canvas); canvas.restore(); } canvas.restore(); } } ClippedFolderIconLayoutRule æ–‡ä»¶å¤¹å›¾æ ‡å†…éƒ¨æ˜¾ç¤ºå°å›¾æ ‡ç¼©ç•¥å›¾çš„è®¡ç®—ç±»ï¼Œå¦‚æœä½ è¦å®šåˆ¶ Folderï¼Œè®©å…¶ç¼©ç•¥å›¾æ˜¾ç¤ºä¸º 9 å®«æ ¼çš„æ ·å¼ï¼Œé‚£ä¹ˆæ­¤ç±»æ˜¯å…³é”®ï¼ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166ğŸ“„ æºç è·¯å¾„ï¼špackages/app/Launcher3/src/com/android/launcher3/folder/ClippedFolderIconLayoutRule.javapublic class ClippedFolderIconLayoutRule { // æ–‡ä»¶å¤¹é¢„è§ˆä¸­çš„æœ€å¤§/æœ€å°æ˜¾ç¤ºå›¾æ ‡æ•° public static final int MAX_NUM_ITEMS_IN_PREVIEW = 4; private static final int MIN_NUM_ITEMS_IN_PREVIEW = 2; // ç¼©æ”¾å› å­ï¼šå½“é¢„è§ˆä¸­çš„å›¾æ ‡æ•°é‡è¾ƒå¤šæ—¶ä½¿ç”¨ MIN_SCALEï¼Œè¾ƒå°‘æ—¶ä½¿ç”¨ MAX_SCALE private static final float MIN_SCALE = 0.44f; private static final float MAX_SCALE = 0.51f; // æœ€å¤§åŠå¾„è†¨èƒ€æ¯”ä¾‹ private static final float MAX_RADIUS_DILATION = 0.25f; // é‡å ç³»æ•°ï¼šå…è®¸å›¾æ ‡éƒ¨åˆ†é‡å ä»¥ä¼˜åŒ–è§†è§‰æ•ˆæœ public static final float ICON_OVERLAP_FACTOR = 1 + (MAX_RADIUS_DILATION / 2f); private static final float ITEM_RADIUS_SCALE_FACTOR = 1.15f; // è¡¨ç¤ºè¿›å…¥æˆ–é€€å‡ºæ–‡ä»¶å¤¹æ—¶çš„å›¾æ ‡ç´¢å¼•ï¼Œç”¨äºåŠ¨ç”»é€»è¾‘ public static final int EXIT_INDEX = -2; public static final int ENTER_INDEX = -3; // ä¸´æ—¶æ•°ç»„ï¼Œç”¨äºå­˜å‚¨è®¡ç®—åçš„ x å’Œ y åæ ‡ private float[] mTmpPoint = new float[2]; private float mAvailableSpace; // é¢„è§ˆåŒºåŸŸçš„å¯ç”¨ç©ºé—´ private float mRadius; // å¸ƒå±€ä¸­ç”¨äºæ’åˆ—å›¾æ ‡çš„åœ†å½¢åŠå¾„ private float mIconSize; // å›¾æ ‡å¤§å° private boolean mIsRtl; // æ ‡è¯†å¸ƒå±€æ˜¯å¦ä¸º RTL private float mBaselineIconScale; // åŸºå‡†ç¼©æ”¾å› å­ /** * åˆå§‹åŒ–æ–‡ä»¶å¤¹å›¾æ ‡å¸ƒå±€çš„å…³é”®å‚æ•°ï¼šç©ºé—´å¤§å°ã€å›¾æ ‡å¤§å°å’Œå¸ƒå±€æ–¹å‘ï¼ˆRTLï¼‰ */ public void init(int availableSpace, float intrinsicIconSize, boolean rtl) { mAvailableSpace = availableSpace; mRadius = ITEM_RADIUS_SCALE_FACTOR * availableSpace / 2f; mIconSize = intrinsicIconSize; mIsRtl = rtl; mBaselineIconScale = availableSpace / (intrinsicIconSize * 1f); } /** * è®¡ç®—é¢„è§ˆä¸­çš„å›¾æ ‡ç»˜åˆ¶å‚æ•° */ public PreviewItemDrawingParams computePreviewItemDrawingParams(int index, int curNumItems, PreviewItemDrawingParams params) { float totalScale = scaleForItem(curNumItems); float transX; float transY; if (index == EXIT_INDEX) { // 0 1 * &lt;-- Exit position (row 0, col 2) // 2 3 getGridPosition(0, 2, mTmpPoint); } else if (index == ENTER_INDEX) { // 0 1 // 2 3 * &lt;-- Enter position (row 1, col 2) getGridPosition(1, 2, mTmpPoint); } else if (index &gt;= MAX_NUM_ITEMS_IN_PREVIEW) { // Items beyond those displayed in the preview are animated to the center mTmpPoint[0] = mTmpPoint[1] = mAvailableSpace / 2 - (mIconSize * totalScale) / 2; } else { getPosition(index, curNumItems, mTmpPoint); } transX = mTmpPoint[0]; transY = mTmpPoint[1]; if (params == null) { params = new PreviewItemDrawingParams(transX, transY, totalScale); } else { params.update(transX, transY, totalScale); } return params; } /** * Builds a grid based on the positioning of the items when there are * {@link #MAX_NUM_ITEMS_IN_PREVIEW} in the preview. * * Positions in the grid: 0 1 // 0 is row 0, col 1 * 2 3 // 3 is row 1, col 1 */ /** * ç½‘æ ¼ä½ç½®è®¡ç®—é€»è¾‘ */ private void getGridPosition(int row, int col, float[] result) { // è·å–ç½‘æ ¼ä¸­å·¦ä¸Šè§’ï¼ˆ0å·ä½ç½®ï¼‰çš„åæ ‡ getPosition(0, 4, result); float left = result[0]; float top = result[1]; // è·å–ç½‘æ ¼ä¸­å³ä¸‹è§’ï¼ˆ3å·ä½ç½®ï¼‰çš„åæ ‡ getPosition(3, 4, result); float dx = result[0] - left; float dy = result[1] - top; result[0] = left + (col * dx); result[1] = top + (row * dy); } /** * è®¡ç®—å…·ä½“ä½ç½® */ private void getPosition(int index, int curNumItems, float[] result) { // ç¡®ä¿å½“å‰æ˜¾ç¤ºçš„å›¾æ ‡æ•°é‡è‡³å°‘ä¸º 2 curNumItems = Math.max(curNumItems, 2); // We model the preview as a circle of items starting in the appropriate piece of the // upper left quadrant (to achieve horizontal and vertical symmetry). double theta0 = mIsRtl ? 0 : Math.PI; // In RTL we go counterclockwise int direction = mIsRtl ? 1 : -1; // æ ¹æ®å›¾æ ‡æ•°é‡è°ƒæ•´åˆå§‹è§’åº¦ double thetaShift = 0; if (curNumItems == 3) { thetaShift = Math.PI / 2; } else if (curNumItems == 4) { thetaShift = Math.PI / 4; } theta0 += direction * thetaShift; // We want the items to appear in reading order. For the case of 1, 2 and 3 items, this // is natural for the circular model. With 4 items, however, we need to swap the 3rd and // 4th indices to achieve reading order. if (curNumItems == 4 &amp;&amp; index == 3) { index = 2; } else if (curNumItems == 4 &amp;&amp; index == 2) { index = 3; } // We bump the radius up between 0 and MAX_RADIUS_DILATION % as the number of items increase float radius = mRadius * (1 + MAX_RADIUS_DILATION * (curNumItems - MIN_NUM_ITEMS_IN_PREVIEW) / (MAX_NUM_ITEMS_IN_PREVIEW - MIN_NUM_ITEMS_IN_PREVIEW)); double theta = theta0 + index * (2 * Math.PI / curNumItems) * direction; float halfIconSize = (mIconSize * scaleForItem(curNumItems)) / 2; // Map the location along the circle, and offset the coordinates to represent the center // of the icon, and to be based from the top / left of the preview area. The y component // is inverted to match the coordinate system. result[0] = mAvailableSpace / 2 + (float) (radius * Math.cos(theta) / 2) - halfIconSize; result[1] = mAvailableSpace / 2 + (float) (- radius * Math.sin(theta) / 2) - halfIconSize; } /** * ç¼©æ”¾å› å­è®¡ç®— */ public float scaleForItem(int numItems) { // Scale is determined by the number of items in the preview. final float scale; if (numItems &lt;= 3) { scale = MAX_SCALE; } else { scale = MIN_SCALE; } return scale * mBaselineIconScale; } public float getIconSize() { return mIconSize; }} è®¡ç®—å›¾æ ‡ä½ç½®ï¼šgetPosition()12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667private void getPosition(int index, int curNumItems, float[] result) { // ç¡®ä¿å½“å‰æ˜¾ç¤ºçš„å›¾æ ‡æ•°é‡è‡³å°‘ä¸º 2 curNumItems = Math.max(curNumItems, 2); /** * ç¡®å®šåˆå§‹è§’åº¦ï¼ŒRTL å¸ƒå±€ä» 0 åº¦å¼€å§‹ï¼Œé RTL ä» Ï€ï¼ˆ180 åº¦ï¼‰å¼€å§‹ * * è¿™é‡Œæˆ‘ä»¬ä¸è€ƒè™‘ RTL çš„æƒ…å†µï¼Œæ‰€ä»¥åç»­åˆ†æé»˜è®¤ä»¥ 0 åº¦ä¸ºåˆå§‹è§’åº¦ */ double theta0 = mIsRtl ? 0 : Math.PI; /** * ç¡®å®šæ–¹å‘ï¼šRTL é¡ºæ—¶é’ˆï¼Œé RTL é€†æ—¶é’ˆ * * è¿™é‡Œæˆ‘ä»¬ä¸è€ƒè™‘ RTL çš„æƒ…å†µï¼Œæ‰€ä»¥åç»­é»˜è®¤ä¸ºï¼šé€†æ—¶é’ˆæ–¹å‘ */ int direction = mIsRtl ? 1 : -1; /** * æ ¹æ®å­é¡¹æ•°é‡è°ƒæ•´è§’åº¦åç§» * * æˆ‘ä»¬å…ˆä»¥ curNumItems = 4 ä¸ªå›¾æ ‡ä¸ºä¾‹ */ double thetaShift = 0; if (curNumItems == 3) { thetaShift = Math.PI / 2; // 90 åº¦åç§» } else if (curNumItems == 4) { thetaShift = Math.PI / 4; // 45 åº¦åç§» } /** * åˆå§‹è§’åº¦ï¼šdirection -&gt; -1 * index: 0 -&gt; theta0 = 135 åº¦ï¼ˆ2.356194490192345ï¼‰ * index: 1 -&gt; theta0 = 135 åº¦ï¼ˆ2.356194490192345ï¼‰ * index: 2 -&gt; theta0 = 135 åº¦ï¼ˆ2.356194490192345ï¼‰ * index: 3 -&gt; theta0 = 135 åº¦ï¼ˆ2.356194490192345ï¼‰ */ theta0 += direction * thetaShift; // ç¡®ä¿ 4 ä¸ªå­é¡¹æ—¶ï¼Œç¬¬ 3 å’Œç¬¬ 4 é¡¹äº’æ¢ï¼Œä¿è¯é˜…è¯»é¡ºåº if (curNumItems == 4 &amp;&amp; index == 3) { index = 2; } else if (curNumItems == 4 &amp;&amp; index == 2) { index = 3; } // æ ¹æ®å­é¡¹æ•°é‡å¢åŠ åŠå¾„ï¼Œè¶Šå¤šå›¾æ ‡ï¼ŒåŠå¾„è¶Šå¤§ï¼Œç¡®ä¿å›¾æ ‡åˆç†åœ°åˆ†æ•£å¼€ // MAX_RADIUS_DILATION æ§åˆ¶äº†å›¾æ ‡æœ€å¤§èƒ½è†¨èƒ€çš„æ¯”ä¾‹ float radius = mRadius * (1 + MAX_RADIUS_DILATION * (curNumItems - MIN_NUM_ITEMS_IN_PREVIEW) / (MAX_NUM_ITEMS_IN_PREVIEW - MIN_NUM_ITEMS_IN_PREVIEW)); /** * è®¡ç®—å½“å‰å­é¡¹çš„è§’åº¦ï¼š * index: 0 -&gt; theta = PI*3/4 - 0 = PI*3/4 (2.356194490192345) * index: 1 -&gt; theta = PI*3/4 - PI*1/2 = PI/4 (0.7853981633974483) * index: 2 -&gt; theta = PI*3/4 - PI = -PI/4 (-0.7853981633974483) * index: 3 -&gt; theta = PI*3/4 - PI*3/2 = -PI*3/4 (-2.356194490192345) */ double theta = theta0 + index * (2 * Math.PI / curNumItems) * direction; // è®¡ç®—å›¾æ ‡å¤§å°çš„ä¸€åŠï¼Œç”¨äºè°ƒæ•´ä½ç½®åˆ°å›¾æ ‡ä¸­å¿ƒ float halfIconSize = (mIconSize * scaleForItem(curNumItems)) / 2; // ä½¿ç”¨æåæ ‡è®¡ç®— x å’Œ y åæ ‡ï¼Œå¹¶è°ƒæ•´ä¸ºä»é¢„è§ˆåŒºåŸŸçš„ä¸­å¿ƒå¼€å§‹ result[0] = mAvailableSpace / 2 + (float) (radius * Math.cos(theta) / 2) - halfIconSize; result[1] = mAvailableSpace / 2 + (float) (- radius * Math.sin(theta) / 2) - halfIconSize;} æ€»ç»“ä¸‹ getPosition() æ–¹æ³•çš„è®¡ç®—æ€è·¯ï¼š 1. åœ¨æ–‡ä»¶å¤¹é¢„è§ˆå›¾æ ‡å¸ƒå±€ä¸­ï¼Œå›¾æ ‡ä¸æ˜¯éšæœºåˆ†å¸ƒçš„ï¼Œè€Œæ˜¯ã€Œå›´ç»•æ–‡ä»¶å¤¹å›¾æ ‡ä¸­å¿ƒã€å‡åŒ€æ’åˆ—çš„ã€‚ å®ç°æ–¹æ³•å°±æ˜¯ï¼šä»¥ä¸­å¿ƒç‚¹ä¸ºåœ†å¿ƒç»˜åˆ¶ä¸€ä¸ªåœ†ï¼Œå„ä¸ªåº”ç”¨çš„å›¾æ ‡ä¸­å¿ƒéƒ½åœ¨åœ†ä¸Šï¼Œä¸”å„ä¸ªå›¾æ ‡ä¹‹é—´çš„è·ç¦»(è§’åº¦)ç›¸ç­‰å³å¯ï¼› 2. è®¡ç®—åº”ç”¨å›¾æ ‡ä¸­å¿ƒè·ç¦»æ–‡ä»¶å¤¹å›¾æ ‡ä¸­å¿ƒçš„åŠå¾„ å›¾æ ‡æ•°é‡ä¸åŒæ—¶ï¼Œç»˜åˆ¶çš„å¤§å°å’ŒåŒºåŸŸä¹Ÿä¸ä¸€æ ·ï¼Œè¿™é‡Œä½¿ç”¨ä¸€ä¸ªçº¿æ€§æ’å€¼å…¬å¼ï¼Œæ ¹æ®å½“å‰é¢„è§ˆå›¾æ ‡æ•°é‡(curNumItems)ç›¸å¯¹äºé¢„è§ˆå›¾æ ‡çš„æœ€å°å’Œæœ€å¤§æ•°é‡(2 å’Œ 4)çš„æ¯”ä¾‹ï¼Œæ¥è°ƒæ•´åŠå¾„ radius çš„å¤§å°ï¼š 1234567891011121314private static final float ITEM_RADIUS_SCALE_FACTOR = 1.15f;mRadius = ITEM_RADIUS_SCALE_FACTOR * availableSpace / 2f;// åˆå§‹ mRadius:mRadius = 1.15 * availableSpace / 2f;// æ ¹æ®é¢„è§ˆå›¾æ•°é‡é‡æ–°è®¾å®šåŠå¾„ radius:private static final float MAX_RADIUS_DILATION = 0.25f;float radius = mRadius * (1 + MAX_RADIUS_DILATION * (curNumItems - MIN_NUM_ITEMS_IN_PREVIEW) / (MAX_NUM_ITEMS_IN_PREVIEW - MIN_NUM_ITEMS_IN_PREVIEW));curNumItems = 2ï¼Œradius = mRadiuscurNumItems = 3ï¼Œradius = 1.125 * mRadiuscurNumItems = 4ï¼Œradius = 1.25 * mRadius 3. æ ¹æ®å½“å‰é¢„è§ˆå›¾æ ‡æ•°é‡(curNumItems)å°†è¿™ä¸ªåœ†å¹³å‡ï¼Œå¹¶æ ¹æ®ã€Œæåæ ‡ç³»ã€è®¡ç®—æ¯ä¸ªåº”ç”¨å›¾æ ‡ä¸­å¿ƒç‚¹çš„ã€Œæåæ ‡ã€ 123456789101112131415161718192021222324252627// è®¡ç®—æ¯ä¸ªåº”ç”¨çš„åˆå§‹åŒ–è§’åº¦double theta = theta0 + index * (2 * Math.PI / curNumItems) * direction;curNumItems = 2ï¼šä¸¤ä¸ªåº”ç”¨åœ¨ä¸­å¿ƒç‚¹çš„ä¸¤ä¾§ï¼Œä¸¤ä¸ªå›¾æ ‡åœ¨åŒä¸€æ°´å¹³çº¿ä¸Š | | index: 0 -&gt; theta = PI -(0)-+-(1)- index: 1 -&gt; theta = 0 | |curNumItems = 3ï¼šä¸‰ä¸ªå›¾æ ‡æŒ‰å“å­—æ’åˆ—ï¼Œç¬¬ä¸€ä¸ªåœ¨é¡¶éƒ¨ï¼Œé¡ºæ—¶é’ˆæ’åˆ— | (0) index: 0 -&gt; theta = PI/2 -----+----- index: 1 -&gt; theta = -PI/6 (2) | (1) index: 2 -&gt; theta = -PI*5/6ï¼› |curNumItems = 4ï¼šå››ä¸ªå›¾æ ‡æŒ‰ 2x2 æ’åˆ— | (0) | (1) index: 0 -&gt; theta = PI*3/4 -----+----- index: 1 -&gt; theta = PI/4 (2) | (3) index: 2 -&gt; index = 3 -&gt; theta = -PI/4 | index: 3 -&gt; index = 2 -&gt; theta = -PI*3/4 4. è®¡ç®—åº”ç”¨å›¾æ ‡å·¦ä¸Šè§’çš„ xã€y åæ ‡ 12result[0] = mAvailableSpace / 2 + (float) (radius * Math.cos(theta) / 2) - halfIconSize;result[1] = mAvailableSpace / 2 + (float) (-radius * Math.sin(theta) / 2) - halfIconSize; æˆ‘ä»¬æ¥çœ‹ä¸‹ 4 ä¸ªå›¾æ ‡çš„ä½ç½®ç¡®å®šè¿‡ç¨‹ï¼š ç¬¬ 1 ä¸ªå›¾æ ‡ï¼šindex = 0 theta = PI*3/4 ç¬¬ 2 ä¸ªå›¾æ ‡ï¼šindex = 1 theta = PI/4 è¿™ä¸¤å¼ å›¾å·²ç»å®Œç¾è¯ é‡Šäº†ä½ç½®è·å–çš„ç®—æ³•é€»è¾‘ï¼Œindex = 2 / index = 3 æˆ‘å°±ä¸å†ç”»å›¾äº†ï¼Œç•™ç»™å¤§å®¶è‡ªå·±ç ”ç©¶å§ã€‚ ç”±ä¸Šé¢çš„åˆ†ææˆ‘ä»¬å‘ç°ï¼Œå½±å“ä½ç½®è®¡ç®—ç»“æœçš„ä¸»è¦å‚æ•°ä¸ºï¼š mAvailableSpace: æ–‡ä»¶å¤¹å›¾æ ‡å¤§å°ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šå¯¹ä»–åšæ”¹åŠ¨ mIconSize: ç¼©æ”¾ç³»æ•° radius: åŠå¾„ï¼Œå½±å“åº”ç”¨å›¾æ ‡ç¦»ä¸­å¿ƒç‚¹çš„è·ç¦» theta: è§’åæ ‡ ä¹å®«æ ¼å®šåˆ¶ç¡¬æ ¸æ”¹æ³•å¦‚æœä½ ç†è§£é€å½»äº† getPosition() æ–¹æ³•çš„å›¾æ ‡è®¡ç®—é€»è¾‘ï¼Œé‚£æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è‡ªå·±åˆ†æå¤„ç† 9 å®«æ ¼çš„å¸ƒå±€ç®—æ³•ï¼š é€šç”¨æ”¹æ³• æ—¢ç„¶éœ€è¦æ”¯æŒ 9 å®«æ ¼å¸ƒå±€ï¼Œé‚£é¦–å…ˆæœ€å¤§æ”¯æŒå›¾æ ‡æ•°å¾—ä¿®æ”¹ä¸º 9: 1public static final int MAX_NUM_ITEMS_IN_PREVIEW = 9; æ„æ–™ä¹‹ä¸­çš„æƒ…å†µï¼Œæˆ‘ä»¬å¿…é¡»é‡æ–°å®šä¹‰ getPositon() çš„ç®—æ³•ï¼š 123456789101112131415161718192021222324252627282930public PreviewItemDrawingParams computePreviewItemDrawingParams(int index, int curNumItems, PreviewItemDrawingParams params) { float totalScale = scaleForItem(curNumItems); float transX; float transY; if (index == EXIT_INDEX) { ... } else { // getPosition(index, curNumItems, mTmpPoint); // å›ºå®šä¹å®«æ ¼çš„æ ·å¼ï¼Œæˆ‘ä»¬æ— éœ€ curNumItems å‚æ•° get9Position(index, mTmpPoint); } ...}// é‡æ–°å®šä¹‰ getPosition() ç®—æ³•private void get9Position(int index, float[] result) { int x = index % 3; // ç¬¬å‡ åˆ— int y = index / 3; // ç¬¬å‡ è¡Œ float iconSize = mAvailableSpace / 3; if (mIsRtl) { result[0] = iconSize * (2 - x); } else { result[0] = iconSize * x; } result[1] = iconSize * y;} å›¾æ ‡å¤ªå¤§äº†ï¼Œæˆ‘ä»¬è°ƒæ•´ä¸‹ç¼©æ”¾å› å­ï¼š 12// private static final float MIN_SCALE = 0.44f;private static final float MIN_SCALE = 0.28f; ç°åœ¨çš„å›¾æ ‡ä½ç½®æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¹‹å‰çš„ä»£ç æ˜¯å¼ºåˆ¶å›¾æ ‡å æ®ç©ºé—´ä¸ºï¼šmAvailableSpace/3ï¼Œæ˜¯éœ€è¦è¿›è¡Œè°ƒæ•´çš„ï¼š 1234567891011121314private void get9Position(int index, float[] result) { int x = index % 3; int y = index / 3; // float iconSize = mAvailableSpace / 3; float iconSize = mAvailableSpace * MIN_SCALE; if (mIsRtl) { result[0] = iconSize * (2 - x); } else { result[0] = iconSize * x; } result[1] = iconSize * y;} ç°åœ¨æˆ‘ä»¬å‰©ä¸‹æœ€åä¸€æ­¥ï¼Œå°±æ˜¯è°ƒæ•´ 9 å®«æ ¼å›¾ï¼Œè®©å›¾æ ‡å½¼æ­¤ä¹‹é—´çš„é—´è·å¹³å‡ï¼š 1234567891011121314151617181920212223// æ–°å®šä¹‰é¢„è§ˆå›¾é—´è· private float mPreviewGap; public void init(int availableSpace, float intrinsicIconSize, boolean rtl) { ... // æ€»å¯ç”¨ç©ºé—´ - 3 ä¸ªå›¾æ ‡å ç”¨ç©ºé—´ = å‰©ä½™ç©ºé—´ // å°†å‰©ä½™ç©ºé—´å¹³å‡åˆ†é…æˆ 4 æ®µï¼Œå› ä¸ºæœ‰ 3 ä¸ªå›¾æ ‡å°±æœ‰ 4 ä¸ªé—´éš” mPreviewGap = (mAvailableSpace - mAvailableSpace * MIN_SCALE * 3) / 4f; } private void get9Position(int index, float[] result) { int x = index % 3; int y = index / 3; float iconSize = mAvailableSpace * MIN_SCALE; if (mIsRtl) { result[0] = mPreviewGap + (iconSize + mPreviewGap) * (2 - x); } else { result[0] = mPreviewGap + (iconSize + mPreviewGap) * x; } result[1] = mPreviewGap + (iconSize + mPreviewGap) * y; } å‚è€ƒhttps://blog.csdn.net/baidu_41666295/article/details/134936794","link":"/2024/12/05/Android%20--%20Launcher3%20--%2011.%20Folder%20%E4%B9%9D%E5%AE%AB%E6%A0%BC%E5%AE%9A%E5%88%B6/"},{"title":"èŠèŠ mutableStateListOf","text":"Source Code based on: androidx.compose.**:**:1.5.0 è®²ä»»ä½•ä¸€ä¸ªæ–°çš„ä¸»é¢˜æˆ–è€…çŸ¥è¯†ç‚¹ï¼Œä¹ æƒ¯æ€§çš„ä» Demo å¼€å§‹ï¼Œæ¯”å¦‚ï¼š 1234567891011class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var name by mutableStateOf(&quot;Hi, Compose&quot;) setContent { Text(name) } }} è¿™æ®µä»£ç å·²ç»ç†Ÿçš„ä¸èƒ½å†ç†Ÿäº†å§ï¼Ÿå¦‚æœæˆ‘ä»¬ç”¨ by mutableStateOf åˆå§‹åŒ–ä¸€ä¸ªå˜é‡ï¼Œé‚£ name å°±ä¼šå˜æˆä¸€ä¸ªè¢« Composeã€Œè‡ªåŠ¨è®¢é˜…ã€çš„å˜é‡ã€‚ æˆ‘ä»¬ä¹‹å‰æ–‡ç« çš„ä¾‹å­ï¼Œéƒ½æ˜¯ç”¨ by mutableStateOf åŒ…äº†ä¸€ä¸ª Stringï¼Œå¦‚æœæ¢æˆåˆ«çš„ç±»å‹ï¼Œè¡Œä¸è¡Œï¼Ÿ 1234fun &lt;T&gt; mutableStateOf( value: T, // æ³›å‹å‚æ•° policy: SnapshotMutationPolicy&lt;T&gt; = structuralEqualityPolicy()): MutableState&lt;T&gt; = createSnapshotMutableState(value, policy) ä¾‹å¦‚ï¼šInt ç±»å‹ 12345678910111213141516class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var num by mutableStateOf(1) setContent { Text( text = &quot;å½“å‰æ•°å€¼ï¼š$num&quot;, Modifier.clickable { num++ } ) } }} ä»£ç ä¸åšè§£é‡Šäº†ï¼Œç›´æ¥çœ‹æ•ˆæœï¼š ä¾‹å¦‚ï¼šList ç±»å‹ 123// num ç±»å‹ï¼šMutableList&lt;Int&gt;// mutableStateOf ç±»å‹ï¼šMutableState&lt;MutableList&lt;Int&gt;&gt;var nums by mutableStateOf(mutableListOf(1, 2, 3)) æˆ‘ä»¬åœ¨ä»£ç é‡Œé¢ç”¨èµ·æ¥ï¼š 123456789101112131415class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var nums by mutableStateOf(mutableListOf(1, 2, 3)) setContent { Column { for (num in nums) { Text(&quot;ç¬¬ $num å—æ–‡å­—&quot;) } } } }} è¿è¡Œï¼š ç°åœ¨æˆ‘ä»¬ç¨å¾®æ”¹ä¸‹ä»£ç ï¼š 1234567891011121314151617181920class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var nums by mutableStateOf(mutableListOf(1, 2, 3)) setContent { Column { Button(onClick = { nums.add(nums.last() + 1) }) { Text(&quot;List åŠ  1&quot;) } for (num in nums) { Text(&quot;ç¬¬ $num å—æ–‡å­—&quot;) } } } }} ä»£ç å¾ˆç®€å•ï¼šæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ª Buttonï¼Œæ¯æ¬¡ç‚¹å‡»åï¼Œnums ä¼šæ·»åŠ ä¸€ä¸ªå€¼ï¼Œæ¯”æœ€æœ‰ä¸€ä¸ªå€¼å¤§ 1ã€‚ è¿è¡Œï¼š Button ç–¯ç‹‚ç‚¹å‡»ï¼Œä½†æ˜¯æ²¡ç”Ÿæ•ˆï¼ä¸ºä»€ä¹ˆï¼Ÿ æˆ‘ä»¬å…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼ŒmutableStateOf åŸç†æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬å›å¿†ä¸€ä¸‹ï¼š mutableStateOf ä¹‹æ‰€ä»¥å¯ä»¥å¯¹å˜é‡è¿›è¡Œè®¢é˜…å’Œåˆ·æ–°ï¼Œä¸»è¦æ˜¯å› ä¸ºå†…éƒ¨çš„ get() å’Œ set() æ–¹æ³•åŠ äº†é’©å­ï¼Œæˆ–è€…è¯´å®ƒçš„ set() æ–¹æ³•æ˜¯èµ‹å€¼ï¼æ˜¯æ”¹å˜äº†å˜é‡çš„æŒ‡å‘ï¼Œå®ƒæ˜¯ç›´æ¥æŠŠå¯¹è±¡ç»™æ›¿æ¢äº†ï¼Œä½†åœ¨æˆ‘ä»¬è¿™ä¸ªä»£ç é‡Œé¢ nums ä»…ä»…æ˜¯æ”¹å˜äº†å®ƒå†…éƒ¨çš„çŠ¶æ€ï¼ æ‰€ä»¥ï¼Œå®ƒä¸ä¼šå‡ºå‘ setValue() çš„è°ƒç”¨ï¼Œä»è€Œä¸ä¼šè§¦å‘è‡ªåŠ¨åˆ·æ–°çš„æ“ä½œã€‚ ä¸ºäº†éªŒè¯æ˜¯ä¸æ˜¯å› ä¸ºæ²¡æœ‰é‡ç»„ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹ä¸‹ä»£ç ï¼š 12345678910111213141516171819202122class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var nums by mutableStateOf(mutableListOf(1, 2, 3)) var refresh by mutableStateOf(&quot;å¼ºåˆ¶åˆ·æ–°&quot;) setContent { Column { Text(refresh, Modifier.clickable { refresh = &quot;åˆ·æ–°å®Œæˆ&quot;}) Button(onClick = { nums.add(nums.last() + 1) }) { Text(&quot;List åŠ  1&quot;) } for (num in nums) { Text(&quot;ç¬¬ $num å—æ–‡å­—&quot;) } } } }} æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ª Text() ç»„ä»¶ï¼Œæ”¹å˜ refresh çš„å€¼ï¼Œé‚£ä¹ˆç†è®ºä¸Šå®ƒå°±ä¼šå¸¦ç€ã€Œæ•´ä¸ªé‡ç»„ä½œç”¨åŸŸå†…ã€çš„ç»„ä»¶å…¨éƒ¨ã€Œåˆ·æ–°ã€ï¼ŒåŒ…æ‹¬ Listã€‚ è¿è¡Œï¼š æˆåŠŸåˆ·æ–°äº† List ï¼ ç°åœ¨æˆ‘ä»¬å°±å¾ˆæ¸…æ¥šäº†ï¼ŒmutableStateOf æ²¡æ³•å¯¹ List ç±»å‹çš„å¯¹è±¡å®ç°ç±»ä¼¼ Stringã€Int çš„è‡ªåŠ¨è®¢é˜…åŠåˆ·æ–°ï¼Œé‚£æœ‰æ²¡æœ‰è§£å†³åŠæ³•ï¼Ÿ ä¸Šé¢æˆ‘ä»¬è¯´è¿‡äº†ï¼Œé—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ List åªæ˜¯å†…éƒ¨çš„å˜åŒ–ï¼Œè€Œä¸æ˜¯å®ƒè‡ªå·±æœ¬èº«å¯¹è±¡çš„å˜åŒ–ï¼Œé‚£æˆ‘ä»¬åœ¨å†…éƒ¨æ“ä½œå®Œåç›´æ¥æŠŠ List é‡æ–°ç»™æ¢äº†ä¸å°±è¡Œäº†ï¼Ÿè¯•è¯•ï¼š 1234567891011121314151617181920212223class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var nums by mutableStateOf(mutableListOf(1, 2, 3)) setContent { Column { Button(onClick = { // nums é‡æ–°èµ‹å€¼ nums = nums.toMutableList().apply { add(nums.last() + 1) } }) { Text(&quot;List åŠ  1&quot;) } for (num in nums) { Text(&quot;ç¬¬ $num å—æ–‡å­—&quot;) } } } }} è¿è¡Œï¼š æˆåŠŸåˆ·æ–°äº† List ï¼ ä½†è¿™æ ·å†™å°±ä¼šæ˜¾å¾—å¾ˆå¥‡æ€ªï¼šæ—¢ç„¶å¯¹äº Stringã€Int è¿™äº›ç±»å‹ï¼ŒCompose æä¾›äº† mutableStateOfï¼Œéš¾é“å¯¹äº List è¿™ç§è¿™ä¹ˆå¸¸ç”¨çš„ç±»å‹ï¼Œå°±æ²¡æœ‰ä¸€ä¸ª mutable*** çš„å‡½æ•°ç»™æˆ‘ä»¬ç”¨ï¼Ÿ é‚£å¿…é¡»æœ‰ï¼å®ƒå°±æ˜¯ mutableStateListOfï¼å®ƒå¯ä»¥è§‚æµ‹åˆ°å†…éƒ¨ List çš„æ•°æ®å˜åŒ–ï¼ æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·ç”³æ˜ï¼š 12345678910var nums by mutableStateListOf(mutableListOf(1, 2, 3)) // æœ‰çº¢çº¿æ ‡æ³¨ï¼Œå†™æ³•é”™è¯¯// mutableStateListOf æ˜¯å†…éƒ¨å…ƒç´ è¢«è§‚æµ‹ï¼Œè€Œä¸æ˜¯å®ƒæœ¬èº«è¢«è§‚æµ‹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠ `by` æ¢æˆ `=`var nums = mutableStateListOf(mutableListOf(1, 2, 3))// `var` ä¹Ÿå¯ä»¥æ¢æˆ `val`val nums = mutableStateListOf(mutableListOf(1, 2, 3))// mutableStateListOf æœ¬èº«å°±ä»£è¡¨ä¸€ä¸ªå¯è§‚æµ‹çš„ Listï¼Œæ‰€ä»¥ mutableListOf ä¹Ÿå¯ä»¥å»é™¤val nums = mutableStateListOf(1, 2, 3) // è¿™å°±æ˜¯æœ€ç»ˆçš„å†™æ³• è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä¼˜åŒ–ä¸‹ä»£ç äº†ï¼š 1234567891011121314151617181920class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) val nums = mutableStateListOf(1, 2, 3) setContent { Column { Button(onClick = { nums.add(nums.last() + 1) }) { Text(&quot;List åŠ  1&quot;) } for (num in nums) { Text(&quot;ç¬¬ $num å—æ–‡å­—&quot;) } } } }} è¿è¡Œï¼š æåˆ° Listï¼Œæˆ‘ä»¬å°±ä¼šæƒ³åˆ° Mapï¼ŒåŒæ · Map ä¹Ÿæä¾›äº†ä¸€ä¸ª mutableStateMapOfï¼å®ƒä¹Ÿå¯ä»¥è§‚æµ‹åˆ°å†…éƒ¨ Map çš„æ•°æ®å˜åŒ–ï¼ 12345678910111213141516171819class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) val maps = mutableStateMapOf(1 to &quot;One&quot;, 2 to &quot;Two&quot;) setContent { Column { Button(onClick = { maps[3] = &quot;Three&quot; }) { Text(&quot;Maps åŠ  1&quot;) } for ((key, value) in maps) { Text(&quot;$key å¯¹åº” value: $value&quot;) } } } }} è¿è¡Œï¼š","link":"/2024/07/18/Compose%20--%20%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85%20&%20%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0%20--%2004.%20mutableStateListOf/"},{"title":"ä½ çœŸçš„äº†è§£ Compose çš„é‡ç»„å—ï¼Ÿ","text":"Source Code based on: androidx.compose.**:**:1.5.0 é‡ç»„å…ˆè€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œä»€ä¹ˆæ—¶å€™ä¼šã€Œé‡ç»„ã€ï¼Ÿ 123val name by remember { mutableStateOf(&quot;Hi Compose&quot;)}val nums = mutableStateListOf(1, 2, 3)val maps = mutableStateMapOf(1 to &quot;One&quot;, 2 to &quot;Two&quot;) é€šè¿‡ä¹‹å‰çš„å‡ ç¯‡æ–‡ç« ï¼Œä½ åº”è¯¥å¯¹è¿™ä¸‰è¡Œä»£ç ä¸é™Œç”Ÿï¼Œå½“ç”¨ mutableState*Of ç”³æ˜ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œåœ¨å¯ç»„åˆé¡¹ä¸­ï¼Œã€Œå¦‚æœå˜é‡å˜åŒ–äº†ï¼Œå°±ä¼šè§¦å‘é‡ç»„ã€ã€‚ æ¯”å¦‚ä¸‹é¢ä»£ç ï¼š 12345678910111213class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var name by mutableStateOf(&quot;Hi, Compose&quot;) setContent { Column { Text(name, Modifier.clickable { name = &quot;Hi, Kotlin&quot; }) } } }} æˆ‘ä»¬çŸ¥é“ï¼šText(name) è¢«é‡ç»„äº†ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯ä»…ä»…æ˜¯ Text(name) è¢«é‡ç»„ï¼Œè€Œæ˜¯æ•´ä¸ª Lambda è¡¨è¾¾å¼ è¢«é‡ç»„ï¼Œæˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œè¿™å°±æ˜¯ã€Œé‡ç»„ä½œç”¨åŸŸï¼ˆRecompose scopeï¼‰ã€ï¼ã€‚ é‚£ä¹ˆæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªå¥½ç©çš„ä¸œè¥¿ï¼ŒæŸ¥çœ‹ Column å‡½æ•°ï¼š 1234567891011121314@Composableinline fun Column( modifier: Modifier = Modifier, verticalArrangement: Arrangement.Vertical = Arrangement.Top, horizontalAlignment: Alignment.Horizontal = Alignment.Start, content: @Composable ColumnScope.() -&gt; Unit) { val measurePolicy = columnMeasurePolicy(verticalArrangement, horizontalAlignment) Layout( content = { ColumnScopeInstance.content() }, measurePolicy = measurePolicy, modifier = modifier )} Column æ˜¯ä¸ª inline å‡½æ•°ï¼ˆå†…è”å‡½æ•°ï¼‰ï¼Œè¿™å°±æ„å‘³ç€åœ¨å®é™…ç¼–è¯‘ä¹‹å‰ï¼Œè¿™ä¸ªå‡½æ•°çš„è°ƒç”¨ä¼šè¢«æ›¿æ¢æˆå†…éƒ¨å®é™…çš„ä»£ç ã€‚ æ¯”å¦‚ä¼šæ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š 12345678910111213141516class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var name by mutableStateOf(&quot;Hi, Compose&quot;) setContent { // Column { // æ›¿æ¢ä¸º Layout( Text(name, Modifier.clickable { name = &quot;Hi, Kotlin&quot; }) ) // } } }} å†æ¥çœ‹ä¸‹ Layout()ï¼š 1234567891011@Composable inline fun Layout( content: @Composable @UiComposable () -&gt; Unit, modifier: Modifier = Modifier, measurePolicy: MeasurePolicy) { ... ReusableComposeNode&lt;ComposeUiNode, Applier&lt;Any&gt;&gt;( ... content = content )} Layout()ä¹Ÿæ˜¯ä¸ª inline å‡½æ•°ï¼Œé‚£ä¹ˆä»£ç åˆä¼šå˜æˆè¿™æ ·ï¼š 123456789101112131415161718class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var name by mutableStateOf(&quot;Hi, Compose&quot;) setContent { // Column { // Layout( // æ›¿æ¢ä¸º ReusableComposeNode( Text(name, Modifier.clickable { name = &quot;Hi, Kotlin&quot; }) ) // ) // } } }} å†æ¥çœ‹ä¸‹ ReusableComposeNodeï¼š 1234567891011@Composable @ExplicitGroupsComposableinline fun &lt;T, reified E : Applier&lt;*&gt;&gt; ReusableComposeNode( noinline factory: () -&gt; T, update: @DisallowComposableCalls Updater&lt;T&gt;.() -&gt; Unit, noinline skippableUpdate: @Composable SkippableUpdater&lt;T&gt;.() -&gt; Unit, content: @Composable () -&gt; Unit) { ... content() ...} åˆæ˜¯ inline å‡½æ•°ï¼Œè€Œä¸”ä½ çœ‹å®ƒå†…éƒ¨å¹²äº†ä»€ä¹ˆï¼Ÿ- - ç›´æ¥è°ƒç”¨äº† content()ï¼ æ‰€ä»¥æœ€ç»ˆä»£ç åœ¨ç¼–è¯‘å‰å…¶å®ä¼šæŠŠ Column {} ç»™æ‹¿æ‰ï¼Œå°±è·Ÿä¸‹é¢ä¸€æ ·ï¼š 123456789101112131415161718class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var name by mutableStateOf(&quot;Hi, Compose&quot;) setContent { // Column { // Layout( // æ›¿æ¢ä¸º // ReusableComposeNode( Text(name, Modifier.clickable { name = &quot;Hi, Kotlin&quot; }) // ) // ) // } } }} é‚£ä¹ˆè¿™å°±æ„å‘³ç€ï¼š 1234567891011121314151617class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var name by mutableStateOf(&quot;Hi, Compose&quot;) setContent { // ç»„ä»¶ 1ï¼Œè¿™ä¸ªåœ°æ–¹ä¼šå› ä¸º name çš„æ”¹å˜è€Œä¸€èµ·é‡æ–°è°ƒç”¨ Column { // ç»„ä»¶ 2ï¼Œè¿™ä¸ªåœ°æ–¹ä¼šå› ä¸º name çš„æ”¹å˜è€Œä¸€èµ·é‡æ–°è°ƒç”¨ Text(name, Modifier.clickable { name = &quot;Hi, Kotlin&quot; }) // ç»„ä»¶ 3ï¼Œè¿™ä¸ªåœ°æ–¹ä¼šå› ä¸º name çš„æ”¹å˜è€Œä¸€èµ·é‡æ–°è°ƒç”¨ } // ç»„ä»¶4ï¼Œè¿™ä¸ªåœ°æ–¹ä¼šå› ä¸º name çš„æ”¹å˜è€Œä¸€èµ·é‡æ–°è°ƒç”¨ } }} ä¸ºäº†éªŒè¯ï¼Œæˆ‘ä»¬æµ‹è¯•ä¸‹ï¼š 1234567891011121314151617class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var name by mutableStateOf(&quot;Hi, Compose&quot;) setContent { println(&quot;Recompose èŒƒå›´æµ‹è¯• 1&quot;) Column { println(&quot;Recompose èŒƒå›´æµ‹è¯• 2&quot;) Text(name, Modifier.clickable { name = &quot;Hi, Kotlin&quot; }) println(&quot;Recompose èŒƒå›´æµ‹è¯• 3&quot;) } println(&quot;Recompose èŒƒå›´æµ‹è¯• 4&quot;) } }} è¿è¡Œï¼š è¿™ä¸ª Log æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œç°åœ¨æˆ‘ä»¬ç‚¹å‡»ï¼š Log å·²ç»éªŒè¯äº†æˆ‘ä»¬åˆšæ‰çš„ç»“è®ºï¼Œé‚£è¿™å°±æ¶‰åŠåˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼šæ€§èƒ½é£é™©ï¼ æ¯”å¦‚ä¸‹é¢çš„ä»£ç æœ‰å¯èƒ½å‡ºç°åœ¨ä½ çš„ä»£ç ä¸­ï¼š 123456789101112131415161718192021222324class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var name by mutableStateOf(&quot;Hi, Compose&quot;) setContent { println(&quot;Recompose èŒƒå›´æµ‹è¯• 1&quot;) Column { println(&quot;Recompose èŒƒå›´æµ‹è¯• 2&quot;) Text(name, Modifier.clickable { name = &quot;Hi, Kotlin&quot; }) println(&quot;Recompose èŒƒå›´æµ‹è¯• 3&quot;) } NBFunction() println(&quot;Recompose èŒƒå›´æµ‹è¯• 4&quot;) } }}@Composablefun NBFunction() { println(&quot;Recompose èŒƒå›´æµ‹è¯•ï¼šæˆ‘å¹²äº†å¾ˆå¤šæ¶ˆè€—æ€§èƒ½çš„äº‹ï½ï½ï½&quot;) // è¿™é‡Œé¢å¹²äº†å¾ˆå¤š NB çš„äº‹ï¼Œé€»è¾‘é‡ç‰¹åˆ«å¤§} ä½ å†™äº†ä¸€ä¸ªå¾ˆç‰›é€¼çš„ Composable å‡½æ•°ï¼Œé‡Œé¢å¹²äº†å¾ˆå¤šå¤æ‚çš„äº‹ï¼Œç‰¹åˆ«æ¶ˆè€—æ€§èƒ½ï¼Œé‚£ä¹ˆæ¯æ¬¡éšç€ name çš„æ›´æ”¹ï¼ŒNBFunction() éƒ½ä¼šè¢«æ‰§è¡Œä¸€éï¼Œå°±å°±ä¼šå­˜åœ¨å·¨å¤§çš„æ€§èƒ½æ¶ˆè€—ï¼ ä½ è¦ä¸ä¿¡ï¼Œæˆ‘ä»¬è¿è¡Œä¸€ä¸‹ï¼Œçœ‹ä¸‹ Logï¼š â€¦ é¢ï¼Œå¥½å°´å°¬â€¦ï¼Œç‚¹å‡» name åï¼ŒNBFunction() ç«Ÿç„¶æ²¡æœ‰å†æ¬¡æ‰§è¡Œï¼Ÿä½†å…¶ä»– Log ä»ç„¶æ‰§è¡Œäº†å•Šï¼ éš¾é“ NBFunction() æ²¡æœ‰è¢«è°ƒç”¨ï¼Ÿ å…¶å® NBFunction() è¢«è°ƒç”¨äº†ï¼Œåªä¸è¿‡è¿›å…¥ NBFunction() å†…éƒ¨åï¼Œå†…éƒ¨çš„ä»£ç æ²¡æœ‰è¢«æ‰§è¡Œï¼ éƒ½è¿›æ¥äº†ï¼Œä½ è·Ÿæˆ‘è¯´å†…éƒ¨ä»£ç ä¸æ‰§è¡Œï¼Ÿâ€“ å…¶å®å´æ˜¯æ˜¯è¿™æ ·ï¼Œå¬èµ·æ¥å¾ˆæ‡µæ˜¯å§ï¼Ÿä¸”å¬æˆ‘ç»™ä½ è§£é‡Šï½ å…¶å®è¿™æ˜¯å› ä¸ºï¼šåœ¨ Compose çš„ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨æ’ä»¶ä¼šåšå¹²é¢„ï¼Œè¿™ä¸ªå¹²é¢„è¿‡ç¨‹ä¼šä¿®æ”¹æˆ‘ä»¬çš„ Compose å‡½æ•°ï¼Œæ¯”å¦‚è¯´å®ƒä¼šç»™å‡½æ•°å†…éƒ¨çš„ä»£ç åŠ ä¸Šä¸€äº›æ¡ä»¶åˆ¤æ–­ï¼Œåˆ¤æ–­è¿™ä¸ªå‡½æ•°çš„å‚æ•°è·Ÿä¸Šä¸€æ¬¡å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ä¼ å…¥çš„å‚æ•°æœ‰æ²¡æœ‰æ”¹å˜ï¼Œå¦‚æœæ²¡æœ‰æ”¹å˜ï¼Œå°±ç›´æ¥è·³è¿‡è¿™ä¸ªå‡½æ•°çš„å†…éƒ¨ä»£ç çš„æ‰§è¡Œï¼Œè¿™æ˜¯ Compose çš„ä¼˜åŒ–ã€‚ è€Œä½ çœ‹ NBFunction() è¿™ä¸ªå‡½æ•°æœ‰å‚æ•°å—ï¼Ÿ- - æ²¡æœ‰ï¼Œæ‰€ä»¥å®ƒå†…éƒ¨ä»£ç æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥ Log è‚¯å®šä¸ä¼šæ‰“å°å‡ºæ¥ã€‚ é‚£æˆ‘ä»¬åŠ ä¸ªå‚æ•°æµ‹è¯•ä¸€ä¸‹ï¼š 12345678910111213141516171819202122232425class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var name by mutableStateOf(&quot;Hi, Compose&quot;) setContent { println(&quot;Recompose èŒƒå›´æµ‹è¯• 1&quot;) Column { println(&quot;Recompose èŒƒå›´æµ‹è¯• 2&quot;) Text(name, Modifier.clickable { name = &quot;Hi, Kotlin&quot; }) println(&quot;Recompose èŒƒå›´æµ‹è¯• 3&quot;) NBFunction(name) } println(&quot;Recompose èŒƒå›´æµ‹è¯• 4&quot;) } }}@Composablefun NBFunction(name: String) { println(&quot;Recompose èŒƒå›´æµ‹è¯•ï¼šæˆ‘å¹²äº†å¾ˆå¤šæ¶ˆè€—æ€§èƒ½çš„äº‹ï½ï½ï½&quot;) // è¿™é‡Œé¢å¹²äº†å¾ˆå¤š NB çš„äº‹ï¼Œé€»è¾‘é‡ç‰¹åˆ«å¤§ Text(&quot;$name&quot;)} æˆ‘ä»¬ç»™ NBFunction åŠ ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆéšç€ name çš„æ”¹å˜ï¼Œçœ‹çœ‹å®ƒä¼šä¸ä¼šè¢«æ‰§è¡Œï¼š ç»“æœæ˜¾è€Œæ˜“è§äº†ï¼Compose é‡ç»„è¿‡ç¨‹ä¸­ä¼šåˆ¤æ–­ NBFunction() çš„å‚æ•° String æ˜¯å¦å˜åŒ–ã€‚ é‚£ä¹ˆå¦‚æœæˆ‘çš„å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡å‘¢ï¼Ÿ æ¯”å¦‚æˆ‘ä¼ å…¥çš„æ˜¯ï¼š 1data class User(val name: String) Compose åœ¨é‡ç»„è¿‡ç¨‹ä¸­ï¼Œä¾ç„¶ä¼šå¯¹å¯¹è±¡ç±»å‹çš„å‚æ•°åšåˆ¤æ–­ï¼Œä¸è¿‡å®ƒçš„åˆ¤æ–­è§„åˆ™æ˜¯ Kotlin ä¸­çš„ ==ï¼Œç­‰åŒäº Java çš„ equalsï¼Œæ˜¯ç»“æ„æ€§ç›¸ç­‰åˆ¤æ–­ã€‚ ç°åœ¨æˆ‘ä»¬ä¿®æ”¹ä¸‹ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var name by mutableStateOf(&quot;Hi, Compose&quot;) var user = User(&quot;marco&quot;) // User å¯¹è±¡ setContent { println(&quot;Recompose èŒƒå›´æµ‹è¯• 1&quot;) Column { println(&quot;Recompose èŒƒå›´æµ‹è¯• 2&quot;) Text(name, Modifier.clickable { name = &quot;Hi, Kotlin&quot; user = User(&quot;marco&quot;) // ç‚¹å‡»åï¼Œæ–°çš„ User å¯¹è±¡ }) println(&quot;Recompose èŒƒå›´æµ‹è¯• 3&quot;) NBFunction(user) } println(&quot;Recompose èŒƒå›´æµ‹è¯• 4&quot;) } }}@Composablefun NBFunction(user: User) { println(&quot;Recompose èŒƒå›´æµ‹è¯•ï¼šæˆ‘å¹²äº†å¾ˆå¤šæ¶ˆè€—æ€§èƒ½çš„äº‹ï½ï½ï½&quot;) // è¿™é‡Œé¢å¹²äº†å¾ˆå¤š NB çš„äº‹ï¼Œé€»è¾‘é‡ç‰¹åˆ«å¤§ Text(&quot;${user.name}&quot;)}data class User(val name: String) ä»£ç å¾ˆç®€å•ï¼Œæˆ‘ä»¬é€šè¿‡ Log éªŒè¯ä¸‹ï¼š æˆ‘ä»¬å†æ”¹ä¸‹ä»£ç ï¼ŒæŠŠ User æ¢æˆä¸€ä¸ªæ–°çš„å†…å®¹ï¼š 123456var user = User(&quot;marco&quot;)Text(name, Modifier.clickable { name = &quot;Hi, Kotlin&quot; user = User(&quot;marco_2&quot;)}) å†çœ‹ä¸‹ Logï¼š ç¡®å®å¦‚æˆ‘ä»¬å‰é¢é¢„æƒ³ä¸€æ ·ï¼ŒCompose é‡ç»„è¿‡ç¨‹ä¸­åŒæ ·ä¼šå¯¹ NBFunction() çš„ã€Œå¯¹è±¡å‚æ•°ã€ä¹Ÿåšåˆ¤æ–­ï¼Œæ˜¯ç»“æ„æ€§ç›¸ç­‰åˆ¤æ–­ã€‚ @Stableæ¥ä¸‹æ¥çœ‹ä¸ªæœ‰è¶£çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å†æ¥æ”¹ä¸€ä¸‹ä»£ç ï¼š 123456789101112131415var user = User(&quot;marco&quot;)Text(name, Modifier.clickable { name = &quot;Hi, Kotlin&quot; user = User(&quot;marco&quot;). // user æ”¹å›æ¥ï¼Œéƒ½æ˜¯ marco å†…å®¹})==&gt; æ­¤æ—¶è‚¯å®šæ˜¯ä¼šåˆ¤æ–­ç›¸ç­‰ï¼Œä¸ä¼šæ‰§è¡Œ NBFunction() å†…éƒ¨çš„ä»£ç // æ³¨æ„äº†ï¼š==&gt; æ¥ä¸‹æ¥æˆ‘ä»¬åªæ”¹ä¸€ä¸‹å…³é”®å­—ï¼šdata class User(val name: String)// val --&gt; vardata class User(var name: String) ä»…ä»…æŠŠ val æ”¹æˆ varï¼Œè¿è¡Œçœ‹ Logï¼š Why ???? val å°±ä¼šè·³è¿‡ NBFunction() å†…éƒ¨ä»£ç ï¼Œè€Œ var å°±ä¸ä¼šè·³è¿‡ NBFunction() å†…éƒ¨ä»£ç ï¼ å…¶å®ï¼Œè¿™æ˜¯å› ä¸º Compose çš„æœ¬èº«æœºåˆ¶è®¾å®šï¼š 12data class User(val name: String) // Compose ä¼šè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¯é çš„ç±»data class User(var name: String) // Compose ä¼šè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªä¸å¯é çš„ç±» å¯¹äºä¸å¯é çš„ç±»ï¼Œæˆ‘å°±ä¸ç®¡ä½ äº†ï¼Œç›´æ¥è¿›ï¼è¿™ä¹Ÿæ˜¯å‡ºäºå¯¹ç•Œé¢æ­£ç¡®æ€§çš„è€ƒè™‘ã€‚ æ¯”å¦‚æˆ‘ä»¬ä¿®æ”¹ä¸‹ä»£ç ï¼š ä¸æ€§èƒ½ç›¸æ¯”ï¼Œå‡†ç¡®æ€§æ‰æ˜¯æœ€ç»ˆè¦çš„ï¼Œæ‰€ä»¥å°±ä¼šæ— æ¡ä»¶çš„è¿›å…¥ NBFunction() å‡½æ•°å†æ‰§è¡Œä¸€éã€‚ é‚£å¦‚æœå‡è®¾æˆ‘ä»¬å¯ä»¥ä¿è¯ä¸ä¼šå‡ºç°ä»¥ä¸Šæƒ…å†µï¼Œä¿è¯ User å¯¹è±¡æ°¸è¿œç›¸ç­‰ï¼Œå¸Œæœ› Composable æ’ä»¶ä¹Ÿå¯ä»¥è·³è¿‡å†…éƒ¨æ‰§è¡Œï¼Œæå‡æ€§èƒ½ï¼Œå¦‚ä½•åšå‘¢ï¼Ÿ ç”¨ @Stable æ³¨è§£ï¼Œå®ƒæ˜¯ä¸€ä¸ªç¨³å®šæ€§æ³¨è§£ï¼Œå‘Šè¯‰ Compose ç¼–è¯‘å™¨æ’ä»¶ï¼Œè¿™ä¸ªç±»æ˜¯å¯é çš„ã€‚è¿™æ · Compose é‡ç»„è¿‡ç¨‹ä¸­å°±ä¼šè·³è¿‡ NBFunction() å†…éƒ¨ä»£ç ã€‚ 12@Stabledata class User(var name: String) è¿è¡Œçœ‹ä¸‹ Logï¼š é™¤äº† @Stable å¯ä»¥è®¤å®šå¯é ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ç§æ–¹å¼å¯ä»¥å‘Šè¯‰ Compose æ˜¯å¯é çš„ï¼š 123class User(name: String) { var name by mutableStateOf(name) // è¿™æ˜¯ä¸€ç§æ›´é€šç”¨çš„å†™æ³•}","link":"/2024/07/22/Compose%20--%20%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85%20&%20%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0%20--%2005.%20%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%87%8D%E7%BB%84%E5%90%97%EF%BC%9F/"},{"title":"ç»†è¯´ remember å’Œé‡ç»„ä½œç”¨åŸŸ","text":"Source Code based on: androidx.compose.**:**:1.5.0 é˜…è¯»æœ¬ç¯‡æ–‡ç« ä¸»é¢˜ä¹‹å‰ï¼Œå»ºè®®å…ˆçœ‹çœ‹ã€ è§£æ mutableStateOf æºç  ã€‘ ä¸€æ–‡ï¼Œå› ä¸ºä¸¤ç¯‡æ–‡ç« æ˜¯ä¸Šä¸‹ç¯‡çš„å…³ç³»ï¼Œçœ‹å®Œä¸Šç¯‡ï¼Œå¯ä»¥æ›´å¥½çš„ä¸²è”çŸ¥è¯†ç‚¹ã€‚ è¯ä¸å¤šè¯´ï¼Œè¿˜æ˜¯è€æ ·å­ï¼Œä» Demo ä¸€æ­¥æ­¥å¼•å‡ºæˆ‘ä»¬çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚ 1234567891011121314151617class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var name by mutableStateOf(&quot;Compose&quot;) setContent { Text(name) // å»¶æ—¶æ›´æ–° Text å†…å®¹ LaunchedEffect(true) { delay(3000) name = &quot;Kotlin&quot; } } }} ä¸€æ®µå¾ˆç®€å•çš„ä»£ç ç¤ºä¾‹ï¼Œ3s åæ–‡å­—ä» Compose å˜ä¸º kotlinï¼Œæ‰§è¡Œçœ‹ä¸‹æ•ˆæœï¼š ç°åœ¨æˆ‘ä»¬æ”¹ä¸‹ä»£ç ï¼š 1234567891011121314151617class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { // ä»å¤–é¢æŒªåˆ°é‡Œé¢æ¥... var name by mutableStateOf(&quot;Compose&quot;) Text(name) // å»¶æ—¶æ›´æ–° Text å†…å®¹ LaunchedEffect(true) { delay(3000) name = &quot;Kotlin&quot; } } }} æ‰§è¡Œçœ‹ä¸‹æ•ˆæœï¼š å¥‡æ€ªçš„äº‹æƒ…å‘ç”Ÿäº†ï¼Œ3s åæ–‡å­—æ²¡æœ‰åˆ·æ–°ï¼ é‡ç»„ä½œç”¨åŸŸé—®é¢˜å‡ºåœ¨å“ªï¼Ÿ é¦–å…ˆæˆ‘ä»¬å›é¡¾ä¸‹ Compose æ˜¯æ€ä¹ˆã€Œåˆ·æ–°ç•Œé¢ã€çš„ï¼Ÿæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œå½“ name é‡æ–°èµ‹å€¼åï¼Œè¯»å–å®ƒçš„åœ°æ–¹ä¼šè¢«æ ‡è®°ä¸ºã€Œå¤±æ•ˆã€ï¼Œç„¶åã€Œé‡ç»„åˆ·æ–°ã€ã€‚ å…³é”®çŸ¥è¯†ç‚¹ åœ¨ Compose ä¸­ã€Œé‡ç»„åˆ·æ–°ã€å¹¶ä¸æ˜¯å•çº¯çš„åˆ·æ–° Text(name) è¿™ä¸€è¡Œï¼Œè€Œæ˜¯ä¼šæŠŠåŒ…å« Text(name) çš„ä»£ç å—ç»™åŒ…èµ·æ¥ï¼Œåˆ·æ–°çš„æ˜¯ã€Œæ•´ä¸ªä»£ç å—ã€ï¼Œæˆ–è€…è¯´é‡ç»„ã€Œæ•´ä¸ªä»£ç å—ã€ï¼ å°±åƒä¸‹é¢è¿™ä¸ªæ ·å­ï¼š è¿™æ®µè“è‰²èƒŒæ™¯çš„ä»£ç å—ä¼šè¢«é‡æ–°æ‰§è¡Œä¸€éï¼Œè¿™ä¸ªè“è‰²åŒºåŸŸå°±æ˜¯æ‰€è°“çš„ï¼šé‡ç»„ä½œç”¨åŸŸï¼ˆRecompose scopeï¼‰ï¼ æ‰€ä»¥å¯¼è‡´æ²¡æœ‰åˆ·æ–°çš„æ ¹æœ¬åŸå› å°±æ˜¯ï¼š ä¸ä»…ä»… Text(name) ä¼šè¢«é‡æ–°æ‰§è¡Œï¼Œvar name by mutableStateOf(&quot;Compose&quot;) ä¹Ÿä¼šæ‰§è¡Œï¼å¯¼è‡´ name åˆè¢«é‡æ–°åˆå§‹åŒ–äº†ã€‚ rememberé‚£æ€ä¹ˆè§£å†³ï¼Ÿä¸çŸ¥é“ä½ å‘ç°æ²¡æœ‰ï¼Œå…¶å®å¼€å‘å·¥å…·å·²ç»æç¤ºæˆ‘ä»¬äº†ï¼š mutableStateOf æ˜¯æ ‡çº¢çš„ï¼Œå¹¶ä¸”é”™è¯¯æç¤ºï¼šCreating a state object during composition without using remember. æ„æ€å°±æ˜¯ï¼šä½ åœ¨ç»„åˆè¿‡ç¨‹é‡Œé¢åˆ›å»ºäº† StateObject å¯¹è±¡ï¼Œä½†æ˜¯æ²¡æœ‰ç”¨ rememberã€‚ é‚£æ€ä¹ˆä½¿ç”¨ï¼Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦å¥—ä¸€å±‚ rememberï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var name by remember { mutableStateOf(&quot;Compose&quot;) } Text(name) LaunchedEffect(true) { delay(3000) name = &quot;Kotlin&quot; } } }} åŠ äº† remember åï¼Œåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œ Lambda è¡¨è¾¾å¼ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ mutableStateOf(&quot;Compose&quot;)ï¼Œå¹¶ä¸” remember ä¼šä¿å­˜ç»“æœï¼ˆStateObjectï¼‰ï¼Œå†æ¬¡è°ƒç”¨çš„æ—¶å€™ä¼šç›´æ¥è¿”å›ä¿å­˜çš„è€å¯¹è±¡ï¼ˆStateObjectï¼‰ï¼Œè€Œä¸æ˜¯å†æ¬¡æ‰§è¡Œ Lambda è¡¨è¾¾å¼é‡Œé¢çš„ä»£ç ï¼Œç›¸å½“äºå……å½“äº†ã€Œç¼“å­˜ã€çš„åŠŸèƒ½ã€‚ æˆ‘ä»¬æ‰§è¡Œä¸‹ä¿®æ”¹åçš„ä»£ç ï¼š æ–‡å­—æ›´æ–°äº†ï¼remember èµ·åˆ°äº†ç¼“å­˜çš„ä½œç”¨ï¼Œå°±æ˜¯ä¸ºäº†é˜²æ­¢å¤šæ¬¡åˆå§‹åŒ–å˜é‡è€Œå¯¼è‡´ç¨‹åºä¸å¯æ§ï¼ æ‰€ä»¥æœ‰ä¸ªåŸåˆ™ åœ¨ Compose é‡Œé¢ä½ åªè¦ç”¨äº† mutableStateOfï¼Œé‚£ä¹ˆèƒ½åŠ  remember æˆ‘ä»¬å°±åŠ  rememberã€‚ å¦å¤–æˆ‘ä»¬éœ€è¦æ³¨æ„ remember æ˜¯å¯ä»¥å¸¦å‚æ•°çš„ï¼šå¯ä»¥ã€Œä¸€ä¸ªã€æˆ–è€…ã€Œå¤šä¸ªã€å‚æ•°ã€‚ 1234567891011121314151617181920212223242526272829ğŸ“„ androidx.compose.runtime -&gt; Composables.kt/** * Remember the value returned by [calculation] if [key1] is equal to the previous composition, * otherwise produce and remember a new value by calling [calculation]. */@Composableinline fun &lt;T&gt; remember( key1: Any?, calculation: @DisallowComposableCalls () -&gt; T): T { return currentComposer.cache(currentComposer.changed(key1), calculation)}/** * Remember the value returned by [calculation] if [key1] and [key2] are equal to the previous * composition, otherwise produce and remember a new value by calling [calculation]. */@Composableinline fun &lt;T&gt; remember( key1: Any?, key2: Any?, calculation: @DisallowComposableCalls () -&gt; T): T { return currentComposer.cache( currentComposer.changed(key1) or currentComposer.changed(key2), calculation )} æœ‰ä»€ä¹ˆç”¨ï¼Œä¸¾ä¸ªä¾‹å­è¯´æ˜ï¼Œæ¯”å¦‚æˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€ä¸ª Composable å‡½æ•°ï¼š 12345@Composablefun showCharCount(value: String) { val length = value.length Text(&quot;å­—ç¬¦ä¸²é•¿åº¦ï¼š$length&quot;)} å¾ˆç®€å•ï¼Œä¸€ä¸ªæ˜¾ç¤ºå­—ç¬¦ä¸²é•¿åº¦çš„å‡½æ•°ã€‚ ç°åœ¨æˆ‘ä»¬æ¥å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼š ä¼ å…¥è¿›æ¥çš„å­—ç¬¦ä¸²ç‰¹åˆ«é•¿ï¼› å¹¶ä¸” showCharCount åå¤è¢«è°ƒç”¨äº†å¾ˆå¤šæ¬¡ï¼› é‚£ä¹ˆ value.length æ¯æ¬¡éƒ½è¢«è°ƒç”¨ï¼Œå°±æ˜¾å¾—æœ‰ç‚¹ç¬¨é‡äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»™å®ƒåŠ ä¸Šä¸€ä¸ª rememberï¼š 1234567@Composablefun showCharCount(value: String) { val length = remember { value.length } Text(&quot;å­—ç¬¦ä¸²é•¿åº¦ï¼š$length&quot;)} ä½†æ­¤æ—¶å°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼š 12345678910@Composablefun showCharCount(value: String) { // ç¬¬ä¸€æ¬¡ä¼ è¿›æ¥ï¼šabcd // ç¬¬äºŒæ¬¡ä¼ è¿›æ¥ï¼šabcdefg // ç¬¬ä¸‰æ¬¡ä¼ è¿›æ¥ï¼šabcdefghijklmn val length = remember { value.length } Text(&quot;å­—ç¬¦ä¸²é•¿åº¦ï¼š$length&quot;)} å­—ç¬¦ä¸²é•¿åº¦æ°¸è¿œéƒ½æ˜¯ï¼š4ï¼Œå› ä¸º value.length ä¸ä¼šè¢«æ‰§è¡Œï¼Œé‚£æ€ä¹ˆåŠï¼š 12345678910@Composablefun showCharCount(value: String) { // ç¬¬ä¸€æ¬¡ä¼ è¿›æ¥ï¼šabcd // ç¬¬äºŒæ¬¡ä¼ è¿›æ¥ï¼šabcdefg // ç¬¬ä¸‰æ¬¡ä¼ è¿›æ¥ï¼šabcdefghijklmn val length = remember(value) { value.length } Text(&quot;å­—ç¬¦ä¸²é•¿åº¦ï¼š$length&quot;)} æˆ‘ä»¬ç»™ remember åŠ äº†ä¸€ä¸ªå‚æ•°ï¼švalueï¼Œåªè¦è¿™ä¸ª key å˜åŒ–äº†ï¼Œé‚£ä¹ˆå°±ä¼šé‡æ–°æ‰§è¡Œ Lambda è¡¨è¾¾å¼ï¼Œè¿™å°±æ˜¯å¸¦å‚æ•°çš„ remember çš„ç”¨æ³•ã€‚","link":"/2024/07/10/Compose%20--%20%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85%20&%20%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%20--%2002.%20remember%20%E5%92%8C%E9%87%8D%E7%BB%84%E4%BD%9C%E7%94%A8%E5%9F%9F/"},{"title":"æœ‰çŠ¶æ€ã€æ— çŠ¶æ€ã€çŠ¶æ€æå‡","text":"Source Code based on: androidx.compose.**:**:1.5.0 å…ˆæ¥çœ‹ä¸¤æ®µ Compose çš„å®˜æ–¹æè¿°ï¼š åˆ©ç”¨ Composeï¼Œæ‚¨å¯ä»¥æ„å»ºä¸ä¸ç‰¹å®š activity æˆ– fragment ç›¸å…³è”çš„å°å‹ã€Œæ— çŠ¶æ€ã€ç»„ä»¶ï¼Œè¿™è®©æ‚¨å¯ä»¥è½»æ¾é‡ç”¨å’Œæµ‹è¯•è¿™äº›ç»„ä»¶ã€‚ ä½¿ç”¨ remember å­˜å‚¨å¯¹è±¡çš„å¯ç»„åˆé¡¹åŒ…å«ã€Œå†…éƒ¨çŠ¶æ€ã€ï¼Œè¿™ä¼šä½¿è¯¥å¯ç»„åˆé¡¹ã€Œæœ‰çŠ¶æ€ã€ã€‚åœ¨è°ƒç”¨æ–¹ä¸éœ€è¦æ§åˆ¶çŠ¶æ€ï¼Œå¹¶ä¸”ä¸å¿…è‡ªè¡Œç®¡ç†çŠ¶æ€ä¾¿å¯ä½¿ç”¨çŠ¶æ€çš„æƒ…å†µä¸‹ï¼Œã€Œæœ‰çŠ¶æ€ã€ä¼šéå¸¸æœ‰ç”¨ã€‚ä½†æ˜¯ï¼Œå…·æœ‰ã€Œå†…éƒ¨çŠ¶æ€ã€çš„å¯ç»„åˆé¡¹å¾€å¾€ä¸æ˜“é‡å¤ä½¿ç”¨ï¼Œä¹Ÿæ›´éš¾æµ‹è¯•ã€‚ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠ›å‡ºä¸‰ä¸ªé—®é¢˜ï¼š ä»€ä¹ˆæ˜¯ã€Œæ— çŠ¶æ€ã€ï¼Ÿ ä»€ä¹ˆæ˜¯ã€Œæœ‰çŠ¶æ€ã€ï¼Ÿ ä»€ä¹ˆæ˜¯ã€Œå†…éƒ¨çŠ¶æ€ã€ï¼Ÿ å¸¦ç€è¿™ä¸‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼€å§‹æ¢è®¨ Compose ä¸­çš„çŠ¶æ€ã€‚ æ— çŠ¶æ€çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Ÿ åœ¨ä¼ ç»Ÿ Android ä¸­ï¼Œæ¯”å¦‚ TextViewï¼Œå®ƒçš„çŠ¶æ€å°±æ˜¯ã€Œå†…éƒ¨çš„å±æ€§ã€ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ getText() è·å– TextView çš„æ–‡å­—ï¼ŒsetText() è®¾ç½® TextView çš„æ–‡å­—ã€‚ æˆ‘ä»¬çœ‹ä¸‹é¢çš„ä»£ç ï¼š 12345678910class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { val name = &quot;Hi, Compose&quot; Text(name) } }} ç°åœ¨æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šText() ç»„ä»¶åœ¨è¿™é‡Œèƒ½åƒ TextView() ä¸€æ ·æ—¢èƒ½ getText()ã€ä¹Ÿèƒ½ setText() å—ï¼Ÿ å¾ˆæ˜æ˜¾ä¸èƒ½ï¼Text(name) åªæ˜¯ç”¨äº† nameï¼Œå¹¶æ²¡æœ‰ä¿å­˜ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªã€Œæ— çŠ¶æ€ç»„ä»¶ã€ã€‚ æœ‰çŠ¶æ€ç°åœ¨æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ª Compose å‡½æ•°ï¼š 12345@Composablefun HiCompose() { val name = &quot;Hi, Compose&quot; Text(name)} è¯·é—®ï¼šText() æœ‰çŠ¶æ€å—ï¼Ÿ- - æ²¡æœ‰ï¼ˆæˆ‘ä»¬åˆšåˆšæ‰è¯´è¿‡ï¼‰ é‚£ä¹ˆï¼šHiCompose() å‘¢ï¼Ÿ- - æœ‰ï¼å®ƒçš„å†…éƒ¨æœ‰ä¸€ä¸ªå±äºå®ƒè‡ªå·±çš„å˜é‡ï¼šHi, Composeï¼Œå‡†ç¡®çš„æ¥è¯´ï¼Œå®ƒæ˜¯æœ‰ã€Œå†…éƒ¨çŠ¶æ€ã€çš„ã€‚ æ‰€ä»¥ï¼ŒCompose ç»„ä»¶æ˜¯å¯ä»¥ã€Œæœ‰çŠ¶æ€ã€ï¼Œä¹Ÿå¯ä»¥ã€Œæ— çŠ¶æ€ã€ï¼Œè€Œæ‰€è°“çš„æœ‰æ²¡æœ‰çŠ¶æ€ - - å…¶å®éƒ½æ˜¯æŒ‡ï¼šã€Œå†…éƒ¨çŠ¶æ€ã€ï¼ çŠ¶æ€æå‡æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œæ—¢ç„¶ HiCompose() å‡½æ•°æ˜¯æœ‰ã€Œå†…éƒ¨çŠ¶æ€ã€çš„ï¼Œé‚£æˆ‘å¦‚æœæƒ³ä»ã€Œå¤–éƒ¨ã€è·å–å®ƒçš„ã€Œå†…éƒ¨çŠ¶æ€ã€ï¼Œè¯¥å¦‚ä½•åšï¼Ÿ æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š 123456789101112131415class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { HiCompose().name ??? // è¿™é‡Œå¦‚ä½•è·å–åˆ° HiCompose å†…éƒ¨çš„ name? } }}@Composablefun HiCompose() { val name = &quot;Hi, Compose&quot; Text(name)} è¿™å°±ç›¸å½“äºä½ è¦ä»å¤–éƒ¨è·å–ä¸€ä¸ªå‡½æ•°å†…éƒ¨çš„å˜é‡ï¼Œæ˜¯è·å–ä¸åˆ°çš„ï¼Œé‚£å¦‚ä½•åšå‘¢ï¼Ÿ 123456789101112131415class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { val name = &quot;Hi, Compose&quot; HiCompose(name) } }}@Composablefun HiCompose(name: String) { Text(name)} æˆ‘ä»¬æŠŠ HiCompose() ã€Œå†…éƒ¨çŠ¶æ€ã€ç»™æåˆ°äº†ã€Œå‚æ•°ã€é‡Œé¢ï¼Œç„¶åå¤–éƒ¨å°±å¯ä»¥ä¼ å…¥ã€ŒçŠ¶æ€ã€ï¼Œä¸¤è€…å°±è”ç³»èµ·æ¥äº†ã€‚ åœ¨ Compose ä¸­è¿™ç§åšæ³•å°±å«åšï¼šã€ŒçŠ¶æ€æç¤ºã€ï¼ˆState Hoistingï¼‰ é‚£ä¹ˆï¼Œæ­¤æ—¶ HiCompose è¿˜æœ‰çŠ¶æ€å—ï¼Ÿ- - ç°åœ¨å®ƒå°±æ˜¯ã€Œæ— çŠ¶æ€ã€çš„ï¼å› ä¸ºå®ƒå·²ç»æ²¡æœ‰ã€Œå†…éƒ¨çŠ¶æ€ã€äº†ï¼ŒçŠ¶æ€ä¸Šæåˆ°å¤–é¢å»äº†ã€‚ è¾“å…¥æ¡†ï¼šTextFieldCompose æœ‰ä¸€ä¸ªå…¸å‹çš„çŠ¶æ€æå‡çš„ç»„ä»¶ç¤ºä¾‹ï¼šTextFieldï¼Œå®ƒæ˜¯ä¸€ä¸ªæ–‡æœ¬è¾“å…¥æ¡†ï¼Œç±»ä¼¼äº EditTextã€‚ 123456789class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { TextField(value = , onValueChange = ) } }} å…¶ä¸­ value å°±æ˜¯ä» TextField å†…éƒ¨æå‡ä¸Šæ¥çš„ï¼Œæˆ‘ä»¬æ¥ç»™å®ƒä¼ ä¸ªå€¼ï¼š 12345678910class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var name = &quot;&quot; TextField(name, onValueChange = ) } }} onValueChange æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å‚æ•°ï¼Œå¯ä»¥å†™æˆ Lambda è¡¨è¾¾å¼ï¼š 12345678910111213class MainActivity : ComponentActivity() { @OptIn(ExperimentalMaterial3Api::class) override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var name = &quot;&quot; TextField(name, { }) } }} æ­¤æ—¶ä»€ä¹ˆä¹Ÿæ²¡å¡«ï¼Œè¿è¡Œçœ‹ä¸‹æ•ˆæœï¼š é”®ç›˜éƒ½æ•²å†’çƒŸäº†ï¼Œä½†æ˜¯è¾“å…¥æ¡†å´æ²¡æœ‰ä»»ä½•å†…å®¹ï¼Œé—®é¢˜è‚¯å®šå‡ºåœ¨ onValueChangeï¼Œå› ä¸ºæˆ‘ä»¬ä»€ä¹ˆä¹Ÿæ²¡å¡«ï¼Œé‚£å¡«ä»€ä¹ˆï¼Ÿ 12345678910111213class MainActivity : ComponentActivity() { @OptIn(ExperimentalMaterial3Api::class) override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var name = &quot;&quot; TextField(name, { newValue -&gt; name = newValue }) } }} è¿™å°±è¿™ä¹ˆç®€å•ï¼ŒnewValue å°±æ˜¯è¾“å…¥çš„å†…å®¹ï¼ŒæŠŠ newValue èµ‹å€¼ç»™ nameï¼Œname æ‰æ˜¯è¾“å…¥æ¡†æ˜¾ç¤ºçš„å†…å®¹å®é™…å€¼ã€‚ è¿è¡Œçœ‹ä¸‹æ•ˆæœï¼š æ€ä¹ˆè¿˜ä¸è¡Œï¼Ÿå¦‚æœä½ çœ‹äº†ä¹‹å‰çš„æ–‡ç« ï¼Œåº”è¯¥èƒ½æ‰¾åˆ°é—®é¢˜ç‚¹åœ¨å“ªï¼ ä¿®æ”¹ä¸‹ä»£ç ï¼š 12345678910111213class MainActivity : ComponentActivity() { @OptIn(ExperimentalMaterial3Api::class) override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContent { var name by remember { mutableStateOf(&quot;&quot;) } TextField(name, { newValue -&gt; name = newValue }) } }} å†æ¬¡è¿è¡Œï¼š","link":"/2024/07/13/Compose%20--%20%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85%20&%20%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%20--%2003.%20%E6%9C%89%E7%8A%B6%E6%80%81%E3%80%81%E6%97%A0%E7%8A%B6%E6%80%81%E3%80%81%E7%8A%B6%E6%80%81%E6%8F%90%E5%8D%87/"},{"title":"è§£æ mutableStateOf æºç ","text":"å…¶å®åŸç†æ€§åˆ†æçš„æ–‡ç« ï¼ŒçœŸçš„å¾ˆéš¾è®²çš„é€šä¿—æ˜“æ‡‚ï¼Œè®²çš„ç®€å•æµ…æ˜¾æ²¡å¿…è¦å†™ï¼Œè®²çš„ç¹çéš¾æ‡‚å¾€å¾€å¤§å®¶ä¹Ÿä¸ä¹æ„çœ‹ï¼Œæ‰€ä»¥æ€ä¹ˆæ‰¾ä¸ªå¥½çš„è§’åº¦æ…¢æ…¢é’»è¿›å»å°¤ä¸ºé‡è¦ï¼Œæ¯”å¦‚ï¼šBegin simple codeï¼Œå¦‚æœç¡®å®èƒ½å¸®åŠ©åˆ°å¤§å®¶å®Œå…¨ç†è§£äº†æ–‡ç« æ‰€è®²è¿°åˆ°çš„æºç ç†è®ºï¼Œé‚£å°±ç‚¹ä¸ªèµå§ï¼ å¼•å…¥è¯é¢˜ æ­£å¦‚æˆ‘ä¸Šé¢è¯´çš„ï¼Œç›´æ¥è®²åŸç†å¤ªæ¯ç‡¥ï¼ˆä½ ä¹Ÿä¼šå¾ˆæ‡µï¼‰ï¼Œæˆ‘å–œæ¬¢ä»ç®€å•ä»£ç å…¥æ‰‹ï¼Œå¸¦ä½ ä¸€ç‚¹ç‚¹è¿›å…¥ï¼Œç°åœ¨å¼€å§‹ã€‚å…ˆçœ‹ä¸€ä¸ªæœ€ç®€å•çš„ä»£ç ç¤ºä¾‹ï¼š 1234567891011121314class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) // è¿™ç§å®šä¹‰å˜é‡çš„æ–¹å¼éšå¤„å¯è§äº† val name = mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { Text(name.value) } } }} æˆ‘å…ˆæ¥ç®€å•è§£è¯»ä¸€ä¸‹è¿™æ®µä»£ç çš„åŸç†ï¼š å½“æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç”¨ mutableStateOf åŒ…èµ·æ¥åï¼Œå®ƒå°±å˜æˆäº†ä¸€ä¸ª MutableState ç±»å‹çš„å¯¹è±¡ã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬å–å€¼çš„è¯å°±å¿…é¡»è¦å†™ name.valueï¼Œè¿™æ ·èƒ½æ‰èƒ½å–åˆ° â€œComposeâ€ï¼Œå› ä¸ºname ä¸å†æ˜¯ä¸€ä¸ª Stringï¼Œè€Œæ˜¯ MutableState å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å«â€œçŠ¶æ€â€ ã€‚ æ­¤æ—¶ï¼Œname æ˜¯ä¸€ä¸ªè¢«è®¢é˜…çš„çŠ¶æ€ï¼Œname.value å°±æ˜¯ä¸€ä¸ªè¢«è®¢é˜…çš„å€¼ï¼Œå¦‚æœå®ƒå‘ç”Ÿå˜åŒ–ï¼ŒText() å‡½æ•°å°±ä¼šé‡æ–°æ‰§è¡Œä¸€éï¼Œæ›´æ–°åˆ°æœ€æ–°çš„å€¼ã€‚ ç°åœ¨æˆ‘ä»¬ä¿®æ”¹ä¸‹ä»£ç ï¼Œ3s åæ”¹å˜ name.value çš„å€¼ï¼š 123456789101112131415161718class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) val name = mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { Text(name.value) } LaunchedEffect(true) { delay(3000) // 3s å»¶è¿Ÿ name.value = &quot;Kotlin&quot; // ä¿®æ”¹ name.value } } }} è¿è¡Œä¸‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/141782121dd4b200a5d4e86a30eb3edf.gif =400x) ç°åœ¨å…³äº mutableStateOf çš„ç”¨æ³•ä½ å·²ç»æŒæ¡äº†ï¼Œä½†åŒæ—¶å°±ä¼šäº§ç”Ÿäº†ä¸€ä¸ªç–‘é—®ï¼Œname è¢«è‡ªåŠ¨è®¢é˜…äº†ï¼Œå®ƒçš„å€¼æ”¹å˜äº†å°±ä¼šè®©ç•Œé¢é‡æ–°åˆ·æ–°ï¼Œè¿™èƒŒåçš„â€œçŠ¶æ€è®¢é˜…&amp;åˆ·æ–°æœºåˆ¶â€çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ å¦‚æœä½ æƒ³æ·±å…¥äº†è§£ï¼Œé‚£ä¹ˆæ¥ç€å¾€ä¸‹çœ‹ã€‚ çŠ¶æ€è®¢é˜…&amp;è‡ªåŠ¨åˆ·æ–° åŸºäº androidx.compose.runtime:runtime:1.4.0 ç‰ˆæœ¬ ç¡¬æ ¸éƒ¨åˆ†èµ°èµ·ï¼ŒæŸ¥çœ‹ mutableStateOf() æºç ï¼š 1234fun &lt;T&gt; mutableStateOf( value: T, policy: SnapshotMutationPolicy&lt;T&gt; = structuralEqualityPolicy()): MutableState&lt;T&gt; = createSnapshotMutableState(value, policy) mutableStateOf() è¿”å›çš„æ˜¯ä¸€ä¸ª MutableState å¯¹è±¡ï¼Œè¿™ä¸ªæˆ‘ä»¬å‰é¢è¯´è¿‡ã€‚ mutableStateOf() åˆè°ƒç”¨äº†å¦ä¸€ä¸ªå‡½æ•°ï¼š**createSnapshotMutableState()**ã€‚ è¿›å…¥ **createSnapshotMutableState()**ï¼š 1234internal actual fun &lt;T&gt; createSnapshotMutableState( value: T, policy: SnapshotMutationPolicy&lt;T&gt;): SnapshotMutableState&lt;T&gt; = ParcelableSnapshotMutableState(value, policy) åˆè°ƒç”¨äº† ParcelableSnapshotMutableState() å‡½æ•°ï¼š 1234567internal class ParcelableSnapshotMutableState&lt;T&gt;( value: T, policy: SnapshotMutationPolicy&lt;T&gt;) : SnapshotMutableStateImpl&lt;T&gt;(value, policy), Parcelable { // è¿™é‡Œå†…éƒ¨çš„ä»£ç å…¨éƒ¨éƒ½æ˜¯å¯¹ Parcelable æ¥å£çš„å®ç°ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒï¼Œä¸æ˜¯æ ¸å¿ƒå†…å®¹ ... ...} å…³é”®åœ¨ SnapshotMutableStateImplï¼Œå®ƒé‡Œé¢æ‰æ˜¯æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788internal open class SnapshotMutableStateImpl&lt;T&gt;( value: T, override val policy: SnapshotMutationPolicy&lt;T&gt;) : StateObject, SnapshotMutableState&lt;T&gt; { @Suppress(&quot;UNCHECKED_CAST&quot;) override var value: T get() = next.readable(this).value set(value) = next.withCurrent { if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } } } private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) override val firstStateRecord: StateRecord get() = next override fun prependStateRecord(value: StateRecord) { @Suppress(&quot;UNCHECKED_CAST&quot;) next = value as StateStateRecord&lt;T&gt; } @Suppress(&quot;UNCHECKED_CAST&quot;) override fun mergeRecords( previous: StateRecord, current: StateRecord, applied: StateRecord ): StateRecord? { val previousRecord = previous as StateStateRecord&lt;T&gt; val currentRecord = current as StateStateRecord&lt;T&gt; val appliedRecord = applied as StateStateRecord&lt;T&gt; return if (policy.equivalent(currentRecord.value, appliedRecord.value)) current else { val merged = policy.merge( previousRecord.value, currentRecord.value, appliedRecord.value ) if (merged != null) { appliedRecord.create().also { (it as StateStateRecord&lt;T&gt;).value = merged } } else { null } } } override fun toString(): String = next.withCurrent { &quot;MutableState(value=${it.value})@${hashCode()}&quot; } private class StateStateRecord&lt;T&gt;(myValue: T) : StateRecord() { override fun assign(value: StateRecord) { @Suppress(&quot;UNCHECKED_CAST&quot;) this.value = (value as StateStateRecord&lt;T&gt;).value } override fun create(): StateRecord = StateStateRecord(value) var value: T = myValue } /** * The componentN() operators allow state objects to be used with the property destructuring * syntax * * ``` * var (foo, setFoo) = remember { mutableStateOf(0) } * setFoo(123) // set * foo == 123 // get * ``` */ override operator fun component1(): T = value override operator fun component2(): (T) -&gt; Unit = { value = it } /** * A function used by the debugger to display the value of the current value of the mutable * state object without triggering read observers. */ @Suppress(&quot;unused&quot;) val debuggerDisplayValue: T @JvmName(&quot;getDebuggerDisplayValue&quot;) get() = next.withCurrent { it }.value} å¥½é•¿å•Šï½ç®—äº†ï¼Œä¸çœ‹äº†ğŸ™ˆâ€¦ æ¥ä¸‹æ¥æˆ‘å¸¦ä½ ä¸€æ­¥æ­¥æ¢ç´¢å…¶ä¸­çš„å¥¥ç§˜ï¼ å…ˆçœ‹å¼€å¤´éƒ¨åˆ†ï¼š 12345678910111213141516171819internal open class SnapshotMutableStateImpl&lt;T&gt;( value: T, override val policy: SnapshotMutationPolicy&lt;T&gt;) : StateObject, SnapshotMutableState&lt;T&gt; { @Suppress(&quot;UNCHECKED_CAST&quot;) override var value: T get() = next.readable(this).value set(value) = next.withCurrent { if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } } } private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) override val firstStateRecord: StateRecord get() = next ... ...} ä¸€ä¸ª value å±æ€§å°å…¥çœ¼å¸˜ï¼Œè¿™å°±æ˜¯æ–‡ç« å¼€å¤´ä»£ç é‡Œé¢ç”¨åˆ°çš„ name.valueã€‚ value æœ‰ get() å’Œ set() å‡½æ•°ï¼Œå¹¶ä¸”éƒ½æœ‰å…·ä½“çš„å®ç°ã€‚ ğŸ““ next æ˜¯ä¸ªå•¥ï¼Ÿ æ— è®ºæ˜¯ get() è¿˜æ˜¯ set() éƒ½æœ‰ä¸€ä¸ª nextã€‚ 12get() = next.readable(this).valueset(value) = next.withCurrent {...} å®ƒæ˜¯ä¸ªå•¥ï¼Ÿæˆ‘ä»¬å¾—å…ˆææ˜ç™½è¿™ä¸ªã€‚ 1private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) å®ƒçš„ç±»å‹æ˜¯ StateStateRecordï¼Œé‚£ StateStateRecord æœ‰æ˜¯ä¸ªå•¥ï¼Ÿ 12345678910private class StateStateRecord&lt;T&gt;(myValue: T) : StateRecord() { override fun assign(value: StateRecord) { @Suppress(&quot;UNCHECKED_CAST&quot;) this.value = (value as StateStateRecord&lt;T&gt;).value } override fun create(): StateRecord = StateStateRecord(value) var value: T = myValue} StateStateRecord ç»§æ‰¿äº† StateRecordï¼Œé‚£ StateRecord åˆæ˜¯ä¸ªå•¥å‘¢ï¼Ÿ 123456abstract class StateRecord { internal var snapshotId: Int = currentSnapshot().id // è®°å½•å¿«ç…§ id internal var next: StateRecord? = null // ä¸‹ä¸€ä¸ªçŠ¶æ€è®°å½•çš„å¼•ç”¨ï¼ŒçŠ¶æ€è®°å½•å­˜å‚¨åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ abstract fun assign(value: StateRecord) // å¤åˆ¶ StateRecord abstract fun create(): StateRecord // åˆ›å»ºä¸€ä¸ªæ–°çš„è®°å½•ç›¸åŒçš„ StateRecord} ä½ åªè¦çŸ¥é“ StateRecord æ˜¯ä¸€ä¸ªé“¾è¡¨çš„æ•°æ®ç»“æ„å³å¯ï¼Œè€Œ StateStateRecord å®ç°äº†å®ƒï¼Œå¹¶ä¸”å°† value è¿›è¡Œäº†å°è£…ã€‚ ä¸‹é¢æˆ‘ä»¬è¦è®²åˆ«çš„äº†ï¼Œå…ˆè®°ä½ï¼šStateRecord æ˜¯ä¸€ä¸ªé“¾è¡¨çš„æ•°æ®ç»“æ„ï¼ æ¥ç€è¯´ï¼Œå¦‚æœä½ ä»”ç»†çœ‹ä»£ç çš„è¯ï¼Œä¼šå‘ç° SnapshotMutableStateImpl å…¶å®ç»§æ‰¿äº†ä¸¤ä¸ªæ¥å£ï¼š 123456internal open class SnapshotMutableStateImpl&lt;T&gt;( value: T, override val policy: SnapshotMutationPolicy&lt;T&gt;) : StateObject, SnapshotMutableState&lt;T&gt; { ... ...} ä¸€ä¸ª StateObjetã€ä¸€ä¸ª SnapshotMutableStateã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ SnapshotMutableStateï¼š 123456interface SnapshotMutableState&lt;T&gt; : MutableState&lt;T&gt; { /** * A policy to control how changes are handled in a mutable snapshot. */ val policy: SnapshotMutationPolicy&lt;T&gt;} SnapshotMutableState ç»§æ‰¿äº† MutableStateï¼Œæ­£å¥½å¯¹åº”ç€æˆ‘ä»¬æ–‡ç« å¼€å¤´è¯´çš„ï¼ŒmutableStateOf() è¿”å›çš„å°±æ˜¯ä¸€ä¸ª MutableStateï¼Œæˆ‘ä»¬è¯´æ˜¯å› ä¸ºå®ƒå®ç°äº†è®¢é˜…ä»è€Œå¯ä»¥åˆ·æ–°ï¼Œä½†ï¼ï¼ï¼çœŸæ­£çš„åŸå› å¹¶ä¸æ˜¯å› ä¸ºå®ƒï¼ çœŸæ­£å®ç°çŠ¶æ€è®¢é˜…æœºåˆ¶çš„æ˜¯å¦å¤–ä¸€ä¸ªæ¥å£ï¼šStateObjetï¼ æˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸‹ StateObject è¿™ä¸ªå¤§ä½¬å¹²äº†ä»€ä¹ˆäº‹ï¼š 1234567891011121314interface StateObject { /** * The first state record in a linked list of state records. */ val firstStateRecord: StateRecord fun prependStateRecord(value: StateRecord) fun mergeRecords( previous: StateRecord, current: StateRecord, applied: StateRecord ): StateRecord? = null} ä»£ç éå¸¸ç®€å•ï¼Œä½†é‡Œé¢æœ‰ä¸€ä¸ªæ ¸å¿ƒï¼š 1val firstStateRecord: StateRecord å®ƒæ˜¯å¹²å˜›ç”¨çš„ï¼Ÿæˆ‘ä»¬å»ç…ç…å“ªé‡Œç”¨äº†å®ƒï¼š 1234private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) override val firstStateRecord: StateRecord get() = next å“¦ï¼ŒåŸæ¥ firstStateRecord æ˜¯ç”¨æ¥è®°å½• StateRecord è¿™ä¸ªé“¾è¡¨çš„ å¤´èŠ‚ç‚¹ ç”¨çš„ã€‚ ğŸ““ get() ä¸Šé¢åº”è¯¥ç®—æ˜¯æŠŠ next æ˜¯ä»€ä¹ˆè®²æ¸…æ¥šäº†å§ï¼Ÿâ€“ å®ƒå°±æ˜¯ StateRecordï¼Œæ›´å‡†ç¡®çš„è¯´å°±æ˜¯ StateRecord é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚ ä¸‹é¢æˆ‘ä»¬å¼€å§‹æ‰’æ‰’ get() å…·ä½“çš„é€»è¾‘äº†ã€‚ 1get() = next.readable(this).value è¿›å…¥ readable() ï¼š 1234567891011fun &lt;T : StateRecord&gt; T.readable(state: StateObject): T { val snapshot = Snapshot.current // ç¬¬ä¸€ä»¶äº‹ snapshot.readObserver?.invoke(state) // ç¬¬äºŒä»¶äº‹ return readable(this, snapshot.id, snapshot.invalid) ?: sync { val syncSnapshot = Snapshot.current @Suppress(&quot;UNCHECKED_CAST&quot;) readable(state.firstStateRecord as T, syncSnapshot.id, syncSnapshot.invalid) ?: readError() }} å¹²äº†ä¸¤ä»¶äº‹ï¼Œç¬¬ä¸€ä»¶äº‹ï¼š 1snapshot.readObserver?.invoke(state) // ç¬¬ä¸€ä»¶äº‹ readObserver æ˜¯ä¸€ä¸ªè¯»æ“ä½œçš„è§‚å¯Ÿè€…ï¼Œè¿™ä¸ªæ“ä½œæ˜¯è®°å½• StateObject ä¸­çš„å€¼è¢«å“ªé‡Œè°ƒç”¨äº†ï¼Œæ¯”å¦‚å¼€å¤´çš„ä»£ç ç¤ºä¾‹ï¼š 1234567891011121314151617181920class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) val name = mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { // è¿™é‡Œè°ƒç”¨äº† name.valueï¼Œå°±ä¼šæ‰§è¡Œåˆ°ï¼š // get() --&gt; readServer() --&gt; è®°å½•è¿™é‡Œè°ƒç”¨äº† value å€¼ Text(name.value) } LaunchedEffect(true) { delay(3000) name.value = &quot;Kotlin&quot; } } }} æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªæ“ä½œç†è§£ä¸ºå®ƒæ˜¯ä¸€ä¸ªè®¢é˜…æ“ä½œï¼šè®¢é˜…çŠ¶æ€ï¼Œè®°å½• name.value åœ¨å“ªé‡Œè°ƒç”¨äº†ã€‚ ç¬¬äºŒä»¶äº‹ï¼š 12345return readable(this, snapshot.id, snapshot.invalid) ?: sync { val syncSnapshot = Snapshot.current @Suppress(&quot;UNCHECKED_CAST&quot;) readable(state.firstStateRecord as T, syncSnapshot.id, syncSnapshot.invalid) ?: readError()} è°ƒç”¨äº†ä¸‰å‚æ•°çš„ readable()ï¼š 1234567891011121314151617private fun &lt;T : StateRecord&gt; readable(r: T, id: Int, invalid: SnapshotIdSet): T? { // The readable record is the valid record with the highest snapshotId var current: StateRecord? = r var candidate: StateRecord? = null while (current != null) { if (valid(current, id, invalid)) { candidate = if (candidate == null) current else if (candidate.snapshotId &lt; current.snapshotId) current else candidate } current = current.next } if (candidate != null) { @Suppress(&quot;UNCHECKED_CAST&quot;) return candidate as T } return null} å‰è¾¹æˆ‘ä»¬è¯´é”™ï¼šStateRecord æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œä¸‰å‚æ•°é‡Œé¢çš„å·¥ä½œå°±æ˜¯é€šè¿‡è¡¨å¤´å¯¹è±¡éå†åˆ—è¡¨æ¥è·å– æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecordã€‚ æœ€ç»ˆè¿”å›ä¸€ä¸ª æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecordã€‚ï¼ˆä»€ä¹ˆæ˜¯æœ€æ–°çš„ã€æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªå¯ä»¥ä¸ç”¨å…³å¿ƒï¼Œè¿™è·Ÿè¦ç»“åˆ Snapshot å¿«ç…§ç³»ç»Ÿè¯´ï¼Œä½ ç›´æ¥è¿‡æ»¤å³å¯ï¼Œä¸å½±å“æˆ‘ä»¬åŸç†çš„ç†è§£ï¼‰ æ‰€ä»¥ï¼Œæ•´ä¸ª readable() æ–¹æ³•å°±å¹²äº†ä¸¤ä»¶äº‹ï¼š è¿”å›æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecord è®°å½•åœ¨å“ªé‡Œè°ƒç”¨äº† value 1get() = next.readable(this).value æœ€åè¿˜å‰©ä¸€ä¸ª valueï¼Œè¿™å°±å¾ˆç®€å•äº†ï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡ StateStateRecord (StateRecord çš„å®ç°ç±») ä¼šå¯¹ value è¿›è¡Œå°è£…ï¼Œè€Œ StateRecord å®ƒä»¬åªæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæˆ‘ä»¬è¦è·å–åˆ°å€¼ï¼Œå°±è¦å†è°ƒç”¨ value è·å–å†…éƒ¨è¢«åŒ…ç€çš„å€¼ã€‚ åˆ°è¿™é‡Œ get() å°±è®²å®Œäº†ï¼ ğŸ““ set() ç°åœ¨æ¥çœ‹ set() çš„å…·ä½“ä»£ç ï¼šï¼ˆç»†èŠ‚ç‚¹æ³¨æ„ï¼šè¿™è¾¹æˆ‘æŠŠä»£ç æˆªå›¾äº†ï¼Œè€Œä¸æ˜¯çº¯ä»£ç æ®µï¼Œä½ ç•™æ„ä¸€ä¸‹ï¼Œä¸‹é¢ä¼šå›å½’åˆ°è¿™é‡Œï¼‰ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/548aff88360d4dffda83386ed2ee80e3.png =500x) next æ˜¯å•¥ä¸ç”¨è¯´äº†å§ï¼Œé‚£ withCurrent æ˜¯ä»€ä¹ˆï¼Ÿ 12inline fun &lt;T : StateRecord, R&gt; T.withCurrent(block: (r: T) -&gt; R): R = block(current(this, Snapshot.current)) å®ƒåªæœ‰ä¸€ä¸ªå‚æ•° blockï¼Œè€Œ block æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å‚æ•°ï¼Œå®ƒçš„å·¥ä½œå¾ˆç›´æ¥ï¼Œç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ç±»å‹çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ withCurrent åé¢è·Ÿç€çš„ Lambda è¡¨è¾¾å¼ã€‚ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/63c3c244bd0959768487d28c00ed08ca.png =500x) block é‡Œé¢ä¼ å…¥äº†ä¸€ä¸ª current å‡½æ•°ï¼Œå®ƒåšäº†ä»€ä¹ˆï¼š 12internal fun &lt;T : StateRecord&gt; current(r: T, snapshot: Snapshot) = readable(r, snapshot.id, snapshot.invalid) ?: readError() å‘ç°äº†ä»€ä¹ˆï¼Ÿå®ƒè°ƒç”¨äº†ä¸€ä¸ªä¸‰å‚æ•°çš„ readable()ï¼Œä½ è¿˜è®°å¾—ä¸‰å‚æ•°çš„ readable() æ˜¯åšä»€ä¹ˆçš„å—ï¼Ÿ â‡’ è·å– æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecordã€‚ è¿™ä¸ªæ—¶å€™ä½ åœ¨çœ‹ä¸‹æˆ‘å¼€å¤´ä¸ºå•¥å¯¹ä»£ç åšäº†æˆªå›¾ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/df81d16a784a74cbb297037fdce6eda0.png =500x) æ‡‚å•¥æ„æ€æ²¡ï¼ŸwithCurrent ä¼ å…¥çš„ current å‡½æ•°çš„è¿”å›å€¼å°±å¯¹åº”ç€ä»£ç æç¤ºå™¨æç¤ºçš„ it å¯¹è±¡ï¼ˆä¸€ä¸ª StateStateRecordï¼‰ã€‚ æ¥ç€çœ‹ä»£ç ï¼š 123456set(value) = next.withCurrent { // åˆ¤æ–­æ–°æ—§å€¼ if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } }} if åˆ¤æ–­é‡Œé¢ä¼šåˆ¤æ–­å–åˆ°çš„ StateRecord çš„å€¼å’Œæ–°è®¾ç½®çš„å€¼æ˜¯å¦ç›¸åŒï¼Œæ²¡å˜ç›´æ¥ç»“æŸï¼Œå˜äº†å°±è¿›å…¥ä¸‹ä¸€æ­¥ overwritable()ã€‚ æˆ‘ä»¬çœ‹çœ‹å®ƒåšäº†ä»€ä¹ˆï¼š 123456789101112131415internal inline fun &lt;T : StateRecord, R&gt; T.overwritable( state: StateObject, candidate: T, block: T.() -&gt; R): R { var snapshot: Snapshot = snapshotInitializer return sync { // ç¬¬ä¸€ä»¶äº‹ snapshot = Snapshot.current // ç¬¬äºŒä»¶äº‹ this.overwritableRecord(state, snapshot, candidate).block() }.also { notifyWrite(snapshot, state) }} ä¹Ÿå¹²äº†ä¸¤ä»¶äº‹ï¼š è·å–å¿«ç…§ï¼›2. è°ƒç”¨äº†overwritableRecord() å‡½æ•°ï¼› Snapshot å¿«ç…§çš„çŸ¥è¯†æˆ‘ä»¬å¯ä»¥å…ˆå¿½ç•¥ï¼Œæ¥çœ‹ overwritableRecord() åšäº†ä»€ä¹ˆï¼š 12345678910111213141516171819internal fun &lt;T : StateRecord&gt; T.overwritableRecord( state: StateObject, snapshot: Snapshot, candidate: T): T { if (snapshot.readOnly) { snapshot.recordModified(state) } val id = snapshot.id if (candidate.snapshotId == id) return candidate val newData = newOverwritableRecord(state) newData.snapshotId = id snapshot.recordModified(state) return newData} è¿™æ®µä»£ç åˆæ¶‰åŠåˆ°äº†å¦å¤–ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šSnapshotï¼ˆå¿«ç…§ï¼‰ã€‚ æˆ‘ä»¬å°†ä»£ç åˆ†ä¸ºä¸¤ç«¯æ¥çœ‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/9b9068d1ad9357f3b556a0a502884f0c.png =700x) æ ¸å¿ƒä»£ç å— 1ï¼šå¦‚æœä¼ è¿›æ¥çš„ StateRecord çš„å¿«ç…§ id æ­£å¥½å¯¹åº”å½“å‰ snapshot çš„ idï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ã€‚ æ ¸å¿ƒä»£ç å— 2ï¼šå¦åˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æˆ–è€…è¿”å›ä¸€ä¸ªå¼ƒç”¨çš„ StateRecordï¼Œç„¶åå°†å¿«ç…§ id èµ‹äºˆæ–°çš„ StateRecordã€‚ è¯´ç™½äº†æœ€ç»ˆå°±æ˜¯è¦å–åˆ°ä¸€ä¸ªå¯¹åº”å½“å‰ snapshot çš„ StateRecordï¼ ğŸ¤” æ­¤æ—¶å°±å­˜åœ¨ä¸€ä¸ªå¾ˆå¤§çš„ç–‘é—®äº†ï¼Ÿä»€ä¹ˆæ˜¯ Snapshotï¼ˆå¿«ç…§ï¼‰ï¼ŸSnapshot æ€ä¹ˆå’Œ StateRecord ç»‘åœ¨ä¸€èµ·äº†ï¼Ÿ å…³äº Compose çš„ Snapshot æœºåˆ¶ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç«  æ­ç§˜ Jetpack Composeå¿«ç…§ç³»ç»Ÿ ï¼Œè®²çš„å¾ˆå¥½ã€‚ ä½†ç”±äº Snapshot çœŸçš„ä¸æ˜¯ä¸€ä¸¤å¥å°±èƒ½è¯´æ¸…æ¥šçš„ï¼Œä½†æˆ‘ä»ç„¶å‘Šè¯‰ä½ å®ƒä¸å½±å“ä½ å¯¹è¿™ç¯‡æ–‡ç« åŸç†çš„ç†è§£ã€‚ ç»§ç»­å›åˆ°ä»£ç ï¼š 1234567891011121314internal inline fun &lt;T : StateRecord, R&gt; T.overwritable( state: StateObject, candidate: T, block: T.() -&gt; R): R { var snapshot: Snapshot = snapshotInitializer return sync { snapshot = Snapshot.current // å–åˆ°ä¸€ä¸ªå¯¹åº”å½“å‰ snapshot çš„ StateRecord this.overwritableRecord(state, snapshot, candidate).block() }.also { notifyWrite(snapshot, state) }} å–åˆ°å¯¹åº”å½“å‰ snapshot çš„ StateRecord åï¼Œç´§æ¥ç€è°ƒç”¨äº† block()ï¼Œå®ƒæ˜¯ä¼ è¿›æ¥çš„å‚æ•°ï¼Œæ˜¯å¤–é¢ä¼ è¿›æ¥çš„ï¼Œä¹Ÿå°±æ˜¯ {this.value = value}ã€‚ 123456set(value) = next.withCurrent { // åˆ¤æ–­æ–°æ—§å€¼ if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } }} åˆæ‹å›æ¥äº†ï¼ŒæŠŠä¼ å…¥çš„æ–°å€¼èµ‹å€¼ç»™æ‹¿åˆ°çš„ StateRecord å†…éƒ¨çš„ valueï¼Œè¿™ä¸å°±æ˜¯å†™æ–°å€¼çš„æ“ä½œä¹ˆï¼Ÿ åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯ set() æµç¨‹æ˜¯ä¸æ˜¯æˆ‘ä»¬å°±è®²å®Œäº†ï¼Ÿ Noï½ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ overwritable() æ–¹æ³•å†…éƒ¨ï¼š 1234567891011121314internal inline fun &lt;T : StateRecord, R&gt; T.overwritable( state: StateObject, candidate: T, block: T.() -&gt; R): R { var snapshot: Snapshot = snapshotInitializer return sync { snapshot = Snapshot.current // è¿™é‡Œè®²å®Œäº† this.overwritableRecord(state, snapshot, candidate).block() }.also { notifyWrite(snapshot, state) // ä½†è¿™é‡Œè¿˜æœ‰ä¸ª notifyWrite }} è¿˜æœ‰ä¸€è¡Œæˆ‘ä»¬é—æ¼äº†ï¼ŒnotifyWrite() åˆåšäº†ä»€ä¹ˆï¼Ÿ 123internal fun notifyWrite(snapshot: Snapshot, state: StateObject) { snapshot.writeObserver?.invoke(state)} æœ‰ç§ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿè§‰ï¼Œåœ¨å‰é¢åˆ†æ get() å‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿‡å•å‚æ•°çš„ readable() é‡Œé¢æœ‰ä¸€è¡Œï¼š 1snapshot.readObserver?.invoke(state) é‚£è¿™é‡Œçš„ä½œç”¨å‘¢ï¼Ÿ â‡’ å¯»æ‰¾å˜é‡åœ¨å“ªé‡Œè¢«è¯»äº†ï¼Œç„¶åå°†è¿™éƒ¨åˆ†å†…å®¹çš„ç»„åˆæ ‡è®°ä¸ºå¤±æ•ˆï¼Œç­‰åˆ°ä¸‹ä¸€å¸§çš„æ—¶å€™ä¼šé‡ç»„åˆ·æ–°ã€‚ æ‰€ä»¥ï¼Œæ•´ä¸ª set() æ–¹æ³•å°±å¹²äº†ä¸¤ä»¶äº‹ï¼š å°†ä¼ å…¥çš„å€¼èµ‹å€¼ç»™ StateRecord å†…éƒ¨çš„ value å†™å…¥é€šçŸ¥åˆ·æ–° åˆ°è¿™é‡Œæˆ‘ä»¬å°±åŸºæœ¬ä¸Šèƒ½å¤Ÿå¾ˆæ¸…æ™°çš„æ˜ç™½äº†çŠ¶æ€è®¢é˜…&amp;è‡ªåŠ¨åˆ·æ–°æœºåˆ¶çš„åŸç†äº†ï¼š å½“ get() è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¸ä»…è¿”å›å€¼ï¼Œè¿˜ä¼šè®°å½•è¯»å€¼çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯å“ªé‡Œè°ƒç”¨äº†ï¼ˆç›¸å½“äºè®¢é˜…ï¼‰ã€‚ å½“ set() è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¸ä»…ä¿®æ”¹å€¼ï¼Œè¿˜ä¼šæŸ¥æ‰¾è¯»å€¼çš„åœ°æ–¹ï¼Œç„¶åè¿›è¡Œåˆ·æ–°æ“ä½œï¼ˆç›¸å½“äºé€šçŸ¥ï¼‰ã€‚ ğŸ““ by åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¦‚æœæ¯æ¬¡è·å–å€¼éƒ½è¦åŠ ä¸Š value ä¼šæ˜¾å¾—å¾ˆå†—ä½™ï¼Œæ‰€ä»¥ Compose ç»™æˆ‘ä»¬æä¾›äº†ä¸€ç§æ›´æ–¹ä¾¿çš„å†™æ³•ï¼šbyã€‚å®ƒæ˜¯ Kotlin çš„ä¸€ä¸ªå…³é”®å­—ï¼Œè¡¨ç¤ºå·¦è¾¹çš„å˜é‡ç”¨å³è¾¹çš„å¯¹è±¡ä½œä¸ºä»£ç†ï¼ˆå§”æ‰˜ï¼‰ã€‚ 12345678910111213class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) val name by mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { Text(name) // å¯ä»¥ç›´æ¥ nameï¼Œè€Œä¸éœ€è¦ name.value } } }} å¦‚æœä½ è¿™ä¹ˆå†™ï¼ŒIDLE ä¼šæç¤ºæŠ¥é”™ï¼Œå› ä¸º name å§”æ‰˜ç»™äº† mutableStateOfï¼Œå¦‚æœæˆ‘ä»¬è¦è·å– name çš„å€¼ï¼Œé‚£å§”æ‰˜å¯¹è±¡éœ€è¦è°ƒç”¨ getValue() å’Œ setValue() ä¸¤ä¸ªå‡½æ•°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°éœ€è¦è‡ªå·±å®ç°ã€‚ ä½†å®é™…ä¸Šå¹¶ä¸éœ€è¦æˆ‘ä»¬å®ç°ï¼Œä½ é€šè¿‡æç¤ºä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¼å…¥ï¼Œå› ä¸º Compose å†…éƒ¨å·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº†è¿™ä¸ªæ–¹æ³•ã€‚ 12import androidx.compose.runtime.getValueimport androidx.compose.runtime.setValue è‡ªæ­¤ï¼Œå…³äº Compose çš„çŠ¶æ€è®¢é˜…&amp;è‡ªåŠ¨åˆ·æ–°æœºåˆ¶çš„åŸç†ç®—æ˜¯è®²æ˜ç™½äº†å§â€¦","link":"/2024/07/05/Compose%20--%20%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85%20&%20%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%20--%2001.%20%E8%A7%A3%E6%9E%90%20mutableStateOf%20%E6%BA%90%E7%A0%81/"},{"title":"SQLite -- ä»å…¥é—¨åˆ°ç²¾é€š","text":"@TOC SQLite æ˜¯éµå¾ªä¸€å¥—ç‹¬ç‰¹çš„ç§°ä¸ºè¯­æ³•çš„è§„åˆ™å’Œå‡†åˆ™ã€‚æœ‰ä¸ªé‡è¦çš„ç‚¹å€¼å¾—æ³¨æ„ï¼ŒSQLite æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å‘½ä»¤æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œæ¯”å¦‚ GLOB å’Œ glob åœ¨ SQLite çš„è¯­å¥ä¸­æœ‰ä¸åŒçš„å«ä¹‰ã€‚ ä¸€ã€æ•°æ®åº“æ“ä½œ1.1 æ–°å»ºæ•°æ®åº“å¯ä»¥ç›´æ¥æ‰§è¡Œ sqlite3 filename æ‰“å¼€æˆ–åˆ›å»ºä¸€ä¸ª SQLite æ•°æ®åº“ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼ŒSQLite ä¼šè‡ªåŠ¨åˆ›å»ºå®ƒã€‚ 1234maxin@maxindeMacBook-Pro db % sqlite3 test.dbSQLite version 3.46.1 2024-08-13 09:16:08Enter &quot;.help&quot; for usage hints.sqlite&gt; 1.2 æŸ¥çœ‹æ•°æ®åº“12sqlite&gt; .databasesmain: /Users/maxin/Desktop/db/test.db r/w ä½¿ç”¨ .quit æˆ–è€… .exit é€€å‡º sqlite3 å·¥å…·ã€‚ å†æŸ¥çœ‹å½“å‰ç›®å½•ï¼Œä¼šå‘ç°æ–°å¢äº†ä¸€ä¸ª test.db æ–‡ä»¶ã€‚ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/3e4b894601524de49e534f2e78c6844b.png =430x) 1.3 æŸ¥çœ‹å¸®åŠ©æŒ‡ä»¤ä½¿ç”¨ .help æŸ¥çœ‹ å¸®åŠ©ä¿¡æ¯ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364sqlite&gt; .help.archive ... Manage SQL archives.auth ON|OFF Show authorizer callbacks.backup ?DB? FILE Backup DB (default &quot;main&quot;) to FILE.bail on|off Stop after hitting an error. Default OFF.cd DIRECTORY Change the working directory to DIRECTORY.changes on|off Show number of rows changed by SQL.check GLOB Fail if output since .testcase does not match.clone NEWDB Clone data into NEWDB from the existing database.connection [close] [#] Open or close an auxiliary database connection.databases List names and files of attached databases.dbconfig ?op? ?val? List or change sqlite3_db_config() options.dbinfo ?DB? Show status information about the database.dump ?OBJECTS? Render database content as SQL.echo on|off Turn command echo on or off.eqp on|off|full|... Enable or disable automatic EXPLAIN QUERY PLAN.excel Display the output of next command in spreadsheet.exit ?CODE? Exit this program with return-code CODE.expert EXPERIMENTAL. Suggest indexes for queries.explain ?on|off|auto? Change the EXPLAIN formatting mode. Default: auto.filectrl CMD ... Run various sqlite3_file_control() operations.fullschema ?--indent? Show schema and the content of sqlite_stat tables.headers on|off Turn display of headers on or off.help ?-all? ?PATTERN? Show help text for PATTERN.import FILE TABLE Import data from FILE into TABLE.indexes ?TABLE? Show names of indexes.intck ?STEPS_PER_UNLOCK? Run an incremental integrity check on the db.limit ?LIMIT? ?VAL? Display or change the value of an SQLITE_LIMIT.lint OPTIONS Report potential schema issues..load FILE ?ENTRY? Load an extension library.log FILE|on|off Turn logging on or off. FILE can be stderr/stdout.mode MODE ?OPTIONS? Set output mode.nonce STRING Suspend safe mode for one command if nonce matches.nullvalue STRING Use STRING in place of NULL values.once ?OPTIONS? ?FILE? Output for the next SQL command only to FILE.open ?OPTIONS? ?FILE? Close existing database and reopen FILE.output ?FILE? Send output to FILE or stdout if FILE is omitted.parameter CMD ... Manage SQL parameter bindings.print STRING... Print literal STRING.progress N Invoke progress handler after every N opcodes.prompt MAIN CONTINUE Replace the standard prompts.quit Stop interpreting input stream, exit if primary..read FILE Read input from FILE or command output.recover Recover as much data as possible from corrupt db..restore ?DB? FILE Restore content of DB (default &quot;main&quot;) from FILE.save ?OPTIONS? FILE Write database to FILE (an alias for .backup ...).scanstats on|off|est Turn sqlite3_stmt_scanstatus() metrics on or off.schema ?PATTERN? Show the CREATE statements matching PATTERN.separator COL ?ROW? Change the column and row separators.session ?NAME? CMD ... Create or control sessions.sha3sum ... Compute a SHA3 hash of database content.shell CMD ARGS... Run CMD ARGS... in a system shell.show Show the current values for various settings.stats ?ARG? Show stats or turn stats on or off.system CMD ARGS... Run CMD ARGS... in a system shell.tables ?TABLE? List names of tables matching LIKE pattern TABLE.timeout MS Try opening locked tables for MS milliseconds.timer on|off Turn SQL timer on or off.trace ?OPTIONS? Output each SQL statement as it is run.version Show source, library and compiler versions.vfsinfo ?AUX? Information about the top-level VFS.vfslist List all available VFSes.vfsname ?AUX? Print the name of the VFS stack.width NUM1 NUM2 ... Set minimum column widths for columnar output äºŒã€è¡¨æ“ä½œ2.1 åˆ›å»ºè¡¨SQLite çš„ CREATE TABLE è¯­å¥ç”¨äºåœ¨ä»»ä½•ç»™å®šçš„æ•°æ®åº“åˆ›å»ºä¸€ä¸ªæ–°è¡¨ã€‚åˆ›å»ºåŸºæœ¬è¡¨ï¼Œæ¶‰åŠåˆ°å‘½åè¡¨ã€å®šä¹‰åˆ—åŠæ¯ä¸€åˆ—çš„æ•°æ®ç±»å‹ã€‚ CREATE TABLE è¯­å¥çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š 1234567CREATE TABLE database_name.table_name( column1 datatype PRIMARY KEY(one or more columns), column2 datatype, column3 datatype, ..... columnN datatype,); CREATE TABLE æ˜¯å‘Šè¯‰æ•°æ®åº“ç³»ç»Ÿåˆ›å»ºä¸€ä¸ªæ–°è¡¨çš„å…³é”®å­—ã€‚CREATE TABLE è¯­å¥åè·Ÿç€è¡¨çš„å”¯ä¸€çš„åç§°æˆ–æ ‡è¯†ã€‚ä½ ä¹Ÿå¯ä»¥é€‰æ‹©æŒ‡å®šå¸¦æœ‰ table_name çš„ database_nameã€‚ ä¾‹å¦‚ï¼šåˆ›å»ºä¸€ä¸ª COMPANY è¡¨ï¼ŒID ä½œä¸ºä¸»é”®ï¼ŒNOT NULL çš„çº¦æŸè¡¨ç¤ºåœ¨è¡¨ä¸­åˆ›å»ºçºªå½•æ—¶è¿™äº›å­—æ®µä¸èƒ½ä¸º NULLï¼š 1234567sqlite&gt; CREATE TABLE COMPANY( ID INT PRIMARY KEY NOT NULL, NAME TEXT NOT NULL, AGE INT NOT NULL, ADDRESS CHAR(50), SALARY REAL); æˆ‘ä»¬æ¥è§£è¯»ä¸€ä¸‹è¿™ç§è¯­æ³•ç»“æ„ï¼š CREATE TABLE è¯­å¥ CREATE TABLE æ˜¯ç”¨æ¥ åˆ›å»ºæ•°æ®åº“è¡¨ çš„ SQL è¯­å¥ã€‚ æ‹†è§£ å«ä¹‰ è¯´æ˜ COMPANY æ–°è¡¨çš„ è¡¨å ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªåå­—æ¥å¼•ç”¨è¯¥è¡¨ åœ†æ‹¬å· () æ‹¬å·ä¸­çš„å†…å®¹å®šä¹‰äº† è¡¨çš„ç»“æ„ å³æ¯ä¸€åˆ—ï¼ˆå­—æ®µï¼‰çš„åç§°ã€æ•°æ®ç±»å‹åŠçº¦æŸæ¡ä»¶ è¡¨çš„åˆ—å®šä¹‰ åœ¨è¿™æ®µè¯­æ³•ä¸­ï¼Œæ¯ä¸€è¡Œå®šä¹‰äº†ä¸€åˆ—ï¼ˆå­—æ®µï¼‰ï¼ŒåŒ…æ‹¬å­—æ®µåã€æ•°æ®ç±»å‹ï¼Œä»¥åŠä¸€äº›å¯é€‰çš„çº¦æŸæ¡ä»¶ã€‚ åˆ—ï¼ˆå­—æ®µåï¼‰ æ•°æ®ç±»å‹ æ˜¯å¦å…è®¸ä¸ºç©º æ˜¯å¦ä¸ºä¸»é”® è¯´æ˜ ID INT ä¸å…è®¸ æ˜¯ å‘˜å·¥çš„å”¯ä¸€æ ‡è¯†ï¼ˆä¸»é”®ï¼‰ NAME TEXT ä¸å…è®¸ å¦ å‘˜å·¥çš„å§“å AGE INT ä¸å…è®¸ å¦ å‘˜å·¥çš„å¹´é¾„ ADDRESS CHAR(50) å…è®¸ å¦ å‘˜å·¥çš„åœ°å€ï¼Œæœ€å¤š 50 ä¸ªå­—ç¬¦ SALARY REAL å…è®¸ å¦ å‘˜å·¥çš„è–ªèµ„ï¼ˆæµ®ç‚¹æ•°ï¼‰ æˆ‘ä»¬è¯´è¿‡ï¼šSQLite æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ï¼Œæ‰€ä»¥å¦‚æœä½ åƒä¸‹é¢è¿™æ ·å®šä¹‰ä¹Ÿæ˜¯å¯ä»¥çš„ï¼š 1234567create table company ( id int primary key not null, name text not null, age int not null, address char(50), salary real); å¸¸è§çš„ç¼–ç ä¹ æƒ¯ å¤§å†™å…³é”®å­—é£æ ¼ï¼ˆä¾‹å¦‚ï¼šCREATE TABLEã€SELECTã€INSERT ç­‰å…³é”®å­—å¤§å†™ï¼‰è¿™ç§é£æ ¼æ¯”è¾ƒå¸¸è§äºå®˜æ–¹æ–‡æ¡£å’Œä¼ä¸šçº§å¼€å‘ï¼Œç›®çš„æ˜¯è®© SQL å…³é”®å­—åœ¨ä»£ç ä¸­æ›´é†’ç›®ï¼Œæ˜“äºè¯†åˆ«ã€‚ä¾‹å¦‚ï¼šCREATE TABLE COMPANY (ID INT PRIMARY KEY)ã€‚ å°å†™å…³é”®å­—é£æ ¼ï¼ˆä¾‹å¦‚ï¼šcreate tableã€selectï¼‰æœ‰äº›å¼€å‘è€…æˆ–ç¤¾åŒºæ›´å€¾å‘äºå…¨å°å†™ï¼Œè®¤ä¸ºè¿™æ ·é£æ ¼ä¸€è‡´ï¼Œçœ‹èµ·æ¥æ›´åŠ ç®€æ´ã€‚åœ¨æŸäº›è¯­è¨€ä¸­ï¼Œå¦‚ Python ç­‰ï¼Œæƒ¯ç”¨å…¨å°å†™é£æ ¼ï¼Œå¼€å‘è€…ä¼šæŠŠè¿™ä¸ªä¹ æƒ¯å¸¦åˆ° SQL ä¸­ã€‚ è¿™ç§å·®å¼‚ä¸»è¦æ˜¯ä¸ªäººåå¥½æˆ–å›¢é˜Ÿé£æ ¼çš„é€‰æ‹©ï¼ŒåŠŸèƒ½ä¸Šæ²¡æœ‰ä»»ä½•å½±å“ã€‚ ç¼–å†™é£æ ¼å»ºè®® æ— è®ºä½ ä½¿ç”¨å¤§å†™è¿˜æ˜¯å°å†™ï¼Œä¿æŒä¸€è‡´æ€§ éƒ½æ˜¯è‰¯å¥½çš„ç¼–ç ä¹ æƒ¯ï¼Œå°¤å…¶æ˜¯åœ¨å¤šäººåä½œå¼€å‘ä¸­ã€‚é€šå¸¸ï¼Œå›¢é˜Ÿä¼šç»Ÿä¸€ç¼–ç è§„èŒƒï¼Œæ¯”å¦‚ï¼š æ‰€æœ‰ ã€ŒSQL å…³é”®å­—ã€ ç”¨å¤§å†™ï¼Œä¾‹å¦‚ï¼šSELECTã€FROMã€‚ ã€Œè¡¨åã€ å’Œ ã€Œåˆ—åã€ ç”¨å°å†™ï¼ˆæˆ–è›‡å½¢å‘½åï¼‰ï¼Œä¾‹å¦‚ï¼šuser_nameã€order_dateã€‚ æ¯”å¦‚åƒä¸‹é¢è¿™æ ·ï¼š 12345CREATE TABLE company ( id INT PRIMARY KEY, name TEXT NOT NULL, age INT NOT NULL); å†æ¯”å¦‚ï¼Œæˆ‘ä»¬åˆ›å»ºåä¸º userã€student çš„è¡¨ï¼š 12345maxin@maxindeMacBook-Pro db % sqlite3 test.dbSQLite version 3.46.1 2024-08-13 09:16:08Enter &quot;.help&quot; for usage hints.sqlite&gt; CREATE TABLE user(name text, age int);sqlite&gt; CREATE TABLE student(id int, name text, age int, primary key(id)); 2.2 è¡¨ä¿¡æ¯è¡¨åˆ›å»ºå®Œæˆåï¼Œä½ å¯ä»¥ä½¿ç”¨ .tables æˆ–è€… .table tableName å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ç°æœ‰è¡¨æ ¼æˆ–è€…å•ä¸ªè¡¨æ ¼çš„ä¿¡æ¯ï¼š 12345678sqlite&gt; .tablesCOMPANY student usersqlite&gt; .table COMPANYCOMPANYsqlite&gt; .table studentstudentsqlite&gt; .table useruser 2.3 è¡¨ç´¢å¼•ä¿¡æ¯åœ¨ SQLite ä¸­ï¼Œ.indices æ˜¯ SQLite å‘½ä»¤è¡Œå·¥å…·ä¸­ç”¨äº åˆ—å‡ºä¸€ä¸ªè¡¨æ‰€æœ‰ç´¢å¼• çš„å‘½ä»¤ã€‚è¿™ä¸ªå‘½ä»¤çš„ä½œç”¨æ˜¯ã€Œå±•ç¤ºæŸä¸ªè¡¨å·²ç»å®šä¹‰çš„æ‰€æœ‰ç´¢å¼•ã€ã€‚ åŸºæœ¬è¯­æ³•ï¼š 1.indices è¡¨å ä¾‹å¦‚ï¼š 1234567sqlite&gt; .indices COMPANYsqlite_autoindex_COMPANY_1------------------------------------------sqlite&gt; .indices studentsqlite_autoindex_student_1------------------------------------------sqlite&gt; .indices user # user è¡¨æ²¡æœ‰å»ºç´¢å¼• sqlite_autoindex_company_1 / sqlite_autoindex_student_1 è¿™æ˜¯ SQLite è‡ªåŠ¨åˆ›å»ºçš„ç´¢å¼•ï¼Œå› ä¸º COMPANY / student è¡¨ä¸­çš„ ID åˆ—å®šä¹‰ä¸º ä¸»é”®ï¼ˆPRIMARY KEYï¼‰ã€‚SQLite ä¼šè‡ªåŠ¨ä¸ºä¸»é”®åˆ—åˆ›å»ºç´¢å¼•ï¼Œå¸®åŠ©å¿«é€ŸæŸ¥è¯¢ã€‚ 2.4 è¡¨ç»“æ„ä¿¡æ¯åœ¨ SQLite ä¸­ï¼Œ.schema æ˜¯ SQLite å‘½ä»¤è¡Œå·¥å…·ä¸­çš„ä¸€ä¸ªå¸¸ç”¨å‘½ä»¤ï¼Œç”¨æ¥ã€ŒæŸ¥çœ‹æ•°æ®åº“ä¸­è¡¨ã€è§†å›¾ã€ç´¢å¼•ç­‰å¯¹è±¡çš„ åˆ›å»ºè¯­å¥ï¼ˆDDLï¼‰ã€ã€‚ æŸ¥çœ‹æ‰€æœ‰å¯¹è±¡çš„åˆ›å»ºè¯­å¥ï¼š 12345678910sqlite&gt; .schemaCREATE TABLE user(name text,age int);CREATE TABLE student(id int,name text,age int,primary key(id));CREATE TABLE COMPANY( ID INT PRIMARY KEY NOT NULL, NAME TEXT NOT NULL, AGE INT NOT NULL, ADDRESS CHAR(50), SALARY REAL); æŸ¥çœ‹æŒ‡å®šè¡¨çš„åˆ›å»ºè¯­å¥ï¼š 1234567891011121314sqlite&gt; .schema userCREATE TABLE user(name text,age int);------------------------------------------sqlite&gt; .schema studentCREATE TABLE student(id int,name text,age int,primary key(id));------------------------------------------sqlite&gt; .schema COMPANYCREATE TABLE COMPANY( ID INT PRIMARY KEY NOT NULL, NAME TEXT NOT NULL, AGE INT NOT NULL, ADDRESS CHAR(50), SALARY REAL); 2.5 åˆ é™¤è¡¨SQLite çš„ DROP TABLE è¯­å¥ç”¨æ¥åˆ é™¤è¡¨å®šä¹‰åŠå…¶æ‰€æœ‰ç›¸å…³æ•°æ®ã€ç´¢å¼•ã€è§¦å‘å™¨ã€çº¦æŸå’Œè¯¥è¡¨çš„æƒé™è§„èŒƒã€‚ ä½¿ç”¨æ­¤å‘½ä»¤æ—¶è¦ç‰¹åˆ«æ³¨æ„ï¼Œå› ä¸ºä¸€æ—¦ä¸€ä¸ªè¡¨è¢«åˆ é™¤ï¼Œè¡¨ä¸­æ‰€æœ‰ä¿¡æ¯ä¹Ÿå°†æ°¸è¿œä¸¢å¤±ï¼ï¼ï¼ åŸºæœ¬è¯­æ³•ï¼š 1DROP TABLE database_name.table_name; ä¾‹å¦‚ï¼šæˆ‘ä»¬åˆ é™¤ user è¡¨ è®©æˆ‘ä»¬å…ˆç¡®è®¤ user è¡¨å·²ç»å­˜åœ¨ï¼Œç„¶åæˆ‘ä»¬å°†å…¶ä»æ•°æ®åº“ä¸­åˆ é™¤ã€‚ 12sqlite&gt; .tablesCOMPANY student user è¿™æ„å‘³ç€ user è¡¨å·²å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æŠŠå®ƒä»æ•°æ®åº“ä¸­åˆ é™¤ï¼Œå¦‚ä¸‹ï¼š 12sqlite&gt; drop table user;sqlite&gt; ç°åœ¨ï¼Œå¦‚æœå°è¯• .tables å‘½ä»¤ï¼Œé‚£ä¹ˆå°†æ— æ³•æ‰¾åˆ° user è¡¨äº†ï¼š 123sqlite&gt; .tablesCOMPANY studentsqlite&gt; ä¸‰ã€æ•°æ®è®°å½•æ“ä½œ3.1 æ–°å¢è®°å½•SQLite çš„ INSERT INTO è¯­å¥ç”¨äºå‘æ•°æ®åº“çš„æŸä¸ªè¡¨ä¸­æ·»åŠ æ–°çš„æ•°æ®è¡Œã€‚ INSERT INTO è¯­å¥æœ‰ä¸¤ç§åŸºæœ¬è¯­æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 12INSERT INTO TABLE_NAME [(column1, column2, column3, ...columnN)] VALUES (value1, value2, value3, ...valueN); åœ¨è¿™é‡Œï¼Œcolumn1, column2,â€¦columnN æ˜¯è¦æ’å…¥æ•°æ®çš„è¡¨ä¸­çš„åˆ—çš„åç§°ã€‚å¦‚æœè¦ä¸ºè¡¨ä¸­çš„æ‰€æœ‰åˆ—æ·»åŠ å€¼ï¼Œä½ ä¹Ÿå¯ä»¥ä¸éœ€è¦åœ¨ SQLite æŸ¥è¯¢ä¸­æŒ‡å®šåˆ—åç§°ã€‚ä½†è¦ç¡®ä¿å€¼çš„é¡ºåºä¸åˆ—åœ¨è¡¨ä¸­çš„é¡ºåºä¸€è‡´ã€‚ SQLite çš„ INSERT INTO è¯­æ³•å¦‚ä¸‹ï¼š 1INSERT INTO TABLE_NAME VALUES (value1,value2,value3,...valueN); ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¾€ COMPANY é‡Œé¢æ·»åŠ æ•°æ®ï¼š 1234567891011121314151617INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)VALUES (1, 'Paul', 32, 'California', 20000.00 );INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)VALUES (2, 'Allen', 25, 'Texas', 15000.00 );INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)VALUES (3, 'Teddy', 23, 'Norway', 20000.00 );INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)VALUES (4, 'Mark', 25, 'Rich-Mond ', 65000.00 );INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)VALUES (5, 'David', 27, 'Texas', 85000.00 );INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)VALUES (6, 'Kim', 22, 'South-Hall', 45000.00 ); ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ç¬¬äºŒç§è¯­æ³•åœ¨ COMPANY è¡¨ä¸­åˆ›å»ºä¸€ä¸ªè®°å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123456INSERT INTO COMPANY VALUES (1, 'Paul', 32, 'California', 20000.00 );INSERT INTO COMPANY VALUES (2, 'Allen', 25, 'Texas', 15000.00 );INSERT INTO COMPANY VALUES (3, 'Teddy', 23, 'Norway', 20000.00 );INSERT INTO COMPANY VALUES (4, 'Mark', 25, 'Rich-Mond ', 65000.00 );INSERT INTO COMPANY VALUES (5, 'David', 27, 'Texas', 85000.00 );INSERT INTO COMPANY VALUES (6, 'Kim', 22, 'South-Hall', 45000.00 ); 3.2 æŸ¥çœ‹è®°å½•SQLite çš„ SELECT è¯­å¥ç”¨äºä» SQLite æ•°æ®åº“è¡¨ä¸­è·å–æ•°æ®ï¼Œä»¥ç»“æœè¡¨çš„å½¢å¼è¿”å›æ•°æ®ã€‚è¿™äº›ç»“æœè¡¨ä¹Ÿè¢«ç§°ä¸ºç»“æœé›†ã€‚ åŸºæœ¬è¯­æ³•ï¼š 1SELECT column1, column2, columnN FROM table_name; åœ¨è¿™é‡Œï¼Œcolumn1, column2â€¦ æ˜¯è¡¨çš„å­—æ®µï¼Œå®ƒä»¬çš„å€¼å³æ˜¯ä½ è¦è·å–çš„ã€‚å¦‚æœä½ æƒ³è·å–æ‰€æœ‰å¯ç”¨çš„å­—æ®µï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•ï¼š 1SELECT * FROM table_name; ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆšåˆšç»™ COMPANY è¡¨æ·»åŠ äº†æ•°æ®ï¼Œç°åœ¨æŸ¥çœ‹ä¸‹ï¼š 1234567sqlite&gt; select * from company;1|Paul|32|California|20000.02|Allen|25|Texas|15000.03|Teddy|23|Norway|20000.04|Mark|25|Rich-Mond |65000.05|David|27|Texas|85000.06|Kim|22|South-Hall|45000.0 å¦‚æœåªæƒ³è·å– COMPANY è¡¨ä¸­æŒ‡å®šçš„å­—æ®µï¼Œåˆ™ä½¿ç”¨ä¸‹é¢çš„æŸ¥è¯¢ï¼š 12345678910sqlite&gt; .mode columnsqlite&gt; SELECT ID, NAME, SALARY FROM COMPANY;ID NAME SALARY-- ----- -------1 Paul 20000.02 Allen 15000.03 Teddy 20000.04 Mark 65000.05 David 85000.06 Kim 45000.0 3.3 ä¸åŒæ ¼å¼è¾“å‡ºåœ¨ SQLite å‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œ.mode ç”¨äºæ§åˆ¶ã€ŒæŸ¥è¯¢ç»“æœçš„è¾“å‡ºæ ¼å¼ã€ã€‚æ ¹æ®éœ€æ±‚ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸åŒçš„æ¨¡å¼ï¼Œæ¯”å¦‚å°†æ•°æ®æ ¼å¼åŒ–ä¸ºè¡¨æ ¼ã€CSVã€HTML æˆ–å…¶ä»–æ ·å¼ã€‚è¿™å¯ä»¥å¸®åŠ©ä½ æ›´æ–¹ä¾¿åœ°æŸ¥çœ‹ã€è°ƒè¯•å’Œå¯¼å‡ºæ•°æ®ã€‚ å¸¸è§çš„ .mode é€‰é¡¹åŠå…¶ä½œç”¨ï¼š 1. columnï¼ˆåˆ—æ¨¡å¼ï¼‰ æ•°æ®ä»¥ è¡¨æ ¼å½¢å¼ æ˜¾ç¤ºï¼Œåˆ—åå’Œæ•°æ®å¯¹é½ï¼Œé€‚åˆäººç±»é˜…è¯»ã€‚ å‘½ä»¤ï¼š12sqlite&gt; .mode columnsqlite&gt; select * from company; è¾“å‡ºç¤ºä¾‹ï¼š12345678ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------1 Paul 32 California 20000.02 Allen 25 Texas 15000.03 Teddy 23 Norway 20000.04 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.06 Kim 22 South-Hall 45000.0 2. listï¼ˆåˆ—è¡¨æ¨¡å¼ï¼‰ æ•°æ®ä»¥ ç«–çº¿ï¼ˆ|ï¼‰åˆ†éš”ï¼Œé€‚åˆå¿«é€ŸæŸ¥çœ‹æˆ–å¤åˆ¶ã€‚ å‘½ä»¤ï¼š12sqlite&gt; .mode listsqlite&gt; select * from company; è¾“å‡ºç¤ºä¾‹ï¼š1234567ID|NAME|AGE|ADDRESS|SALARY1|Paul|32|California|20000.02|Allen|25|Texas|15000.03|Teddy|23|Norway|20000.04|Mark|25|Rich-Mond |65000.05|David|27|Texas|85000.06|Kim|22|South-Hall|45000.0 3. csvï¼ˆCSV æ¨¡å¼ï¼‰ æ•°æ®ä»¥ é€—å·åˆ†éš”å€¼ æ ¼å¼è¾“å‡ºï¼Œé€‚åˆå¯¼å‡ºåˆ°æ–‡ä»¶æˆ–ç”µå­è¡¨æ ¼ã€‚ å‘½ä»¤ï¼š12sqlite&gt; .mode csvsqlite&gt; select * from company; è¾“å‡ºç¤ºä¾‹ï¼š1234567ID,NAME,AGE,ADDRESS,SALARY1,Paul,32,California,20000.02,Allen,25,Texas,15000.03,Teddy,23,Norway,20000.04,Mark,25,&quot;Rich-Mond &quot;,65000.05,David,27,Texas,85000.06,Kim,22,South-Hall,45000.0 4. htmlï¼ˆHTML æ¨¡å¼ï¼‰ æ•°æ®ä»¥ HTML è¡¨æ ¼ æ ¼å¼è¾“å‡ºï¼Œé€‚åˆå¯¼å‡ºåˆ°ç½‘é¡µæˆ–æŠ¥å‘Šä¸­ã€‚ å‘½ä»¤ï¼š12sqlite&gt; .mode htmlsqlite&gt; select * from company; è¾“å‡ºç¤ºä¾‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142&lt;TR&gt;&lt;TH&gt;ID&lt;/TH&gt;&lt;TH&gt;NAME&lt;/TH&gt;&lt;TH&gt;AGE&lt;/TH&gt;&lt;TH&gt;ADDRESS&lt;/TH&gt;&lt;TH&gt;SALARY&lt;/TH&gt;&lt;/TR&gt;&lt;TR&gt;&lt;TD&gt;1&lt;/TD&gt;&lt;TD&gt;Paul&lt;/TD&gt;&lt;TD&gt;32&lt;/TD&gt;&lt;TD&gt;California&lt;/TD&gt;&lt;TD&gt;20000.0&lt;/TD&gt;&lt;/TR&gt;&lt;TR&gt;&lt;TD&gt;2&lt;/TD&gt;&lt;TD&gt;Allen&lt;/TD&gt;&lt;TD&gt;25&lt;/TD&gt;&lt;TD&gt;Texas&lt;/TD&gt;&lt;TD&gt;15000.0&lt;/TD&gt;&lt;/TR&gt;&lt;TR&gt;&lt;TD&gt;3&lt;/TD&gt;&lt;TD&gt;Teddy&lt;/TD&gt;&lt;TD&gt;23&lt;/TD&gt;&lt;TD&gt;Norway&lt;/TD&gt;&lt;TD&gt;20000.0&lt;/TD&gt;&lt;/TR&gt;&lt;TR&gt;&lt;TD&gt;4&lt;/TD&gt;&lt;TD&gt;Mark&lt;/TD&gt;&lt;TD&gt;25&lt;/TD&gt;&lt;TD&gt;Rich-Mond &lt;/TD&gt;&lt;TD&gt;65000.0&lt;/TD&gt;&lt;/TR&gt;&lt;TR&gt;&lt;TD&gt;5&lt;/TD&gt;&lt;TD&gt;David&lt;/TD&gt;&lt;TD&gt;27&lt;/TD&gt;&lt;TD&gt;Texas&lt;/TD&gt;&lt;TD&gt;85000.0&lt;/TD&gt;&lt;/TR&gt;&lt;TR&gt;&lt;TD&gt;6&lt;/TD&gt;&lt;TD&gt;Kim&lt;/TD&gt;&lt;TD&gt;22&lt;/TD&gt;&lt;TD&gt;South-Hall&lt;/TD&gt;&lt;TD&gt;45000.0&lt;/TD&gt;&lt;/TR&gt; 5. tabsï¼ˆåˆ¶è¡¨ç¬¦åˆ†éš”æ¨¡å¼ï¼‰ æ•°æ®ä»¥ åˆ¶è¡¨ç¬¦ åˆ†éš”ï¼Œé€‚åˆå¯¼å‡ºåˆ°æ–‡ä»¶å¹¶åœ¨ä»£ç æˆ–ç¼–è¾‘å™¨ä¸­å¤„ç†ã€‚ å‘½ä»¤ï¼š12sqlite&gt; .mode tabssqlite&gt; select * from company; è¾“å‡ºç¤ºä¾‹ï¼š1234567ID NAME AGE ADDRESS SALARY1 Paul 32 California 20000.02 Allen 25 Texas 15000.03 Teddy 23 Norway 20000.04 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.06 Kim 22 South-Hall 45000.0 6. insertï¼ˆINSERT æ¨¡å¼ï¼‰ æ•°æ®ä»¥ INSERT INTO è¯­å¥ çš„å½¢å¼è¾“å‡ºï¼Œæ–¹ä¾¿å°†æ•°æ®é‡æ–°å¯¼å…¥æ•°æ®åº“ã€‚ å‘½ä»¤ï¼š12sqlite&gt; .mode insertsqlite&gt; select * from company; è¾“å‡ºç¤ºä¾‹ï¼š123456INSERT INTO &quot;table&quot;(ID,NAME,AGE,ADDRESS,SALARY) VALUES(1,'Paul',32,'California',20000.0);INSERT INTO &quot;table&quot;(ID,NAME,AGE,ADDRESS,SALARY) VALUES(2,'Allen',25,'Texas',15000.0);INSERT INTO &quot;table&quot;(ID,NAME,AGE,ADDRESS,SALARY) VALUES(3,'Teddy',23,'Norway',20000.0);INSERT INTO &quot;table&quot;(ID,NAME,AGE,ADDRESS,SALARY) VALUES(4,'Mark',25,'Rich-Mond ',65000.0);INSERT INTO &quot;table&quot;(ID,NAME,AGE,ADDRESS,SALARY) VALUES(5,'David',27,'Texas',85000.0);INSERT INTO &quot;table&quot;(ID,NAME,AGE,ADDRESS,SALARY) VALUES(6,'Kim',22,'South-Hall',45000.0); 7. jsonï¼ˆJSON æ¨¡å¼ï¼‰ æ•°æ®ä»¥ JSON æ ¼å¼ è¾“å‡ºï¼Œé€‚åˆåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼Œä¹Ÿéå¸¸é€‚åˆä¸å‰ç«¯ã€API äº¤äº’ï¼Œæˆ–è€…å¯¼å‡º JSON æ•°æ®ã€‚ å‘½ä»¤ï¼š12sqlite&gt; .mode jsonsqlite&gt; select * from company; è¾“å‡ºç¤ºä¾‹ï¼š123456[{&quot;ID&quot;:1,&quot;NAME&quot;:&quot;Paul&quot;,&quot;AGE&quot;:32,&quot;ADDRESS&quot;:&quot;California&quot;,&quot;SALARY&quot;:20000.0},{&quot;ID&quot;:2,&quot;NAME&quot;:&quot;Allen&quot;,&quot;AGE&quot;:25,&quot;ADDRESS&quot;:&quot;Texas&quot;,&quot;SALARY&quot;:15000.0},{&quot;ID&quot;:3,&quot;NAME&quot;:&quot;Teddy&quot;,&quot;AGE&quot;:23,&quot;ADDRESS&quot;:&quot;Norway&quot;,&quot;SALARY&quot;:20000.0},{&quot;ID&quot;:4,&quot;NAME&quot;:&quot;Mark&quot;,&quot;AGE&quot;:25,&quot;ADDRESS&quot;:&quot;Rich-Mond &quot;,&quot;SALARY&quot;:65000.0},{&quot;ID&quot;:5,&quot;NAME&quot;:&quot;David&quot;,&quot;AGE&quot;:27,&quot;ADDRESS&quot;:&quot;Texas&quot;,&quot;SALARY&quot;:85000.0},{&quot;ID&quot;:6,&quot;NAME&quot;:&quot;Kim&quot;,&quot;AGE&quot;:22,&quot;ADDRESS&quot;:&quot;South-Hall&quot;,&quot;SALARY&quot;:45000.0}] å››ã€è¿ç®—ç¬¦SQLite æä¾›äº†å¤šç§è¿ç®—ç¬¦ï¼Œç”¨äºæ•°æ®æ“ä½œã€ç­›é€‰å’Œè®¡ç®—ã€‚ä¸»è¦è¿ç®—ç¬¦åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š ç®—æœ¯è¿ç®—ç¬¦ æ¯”è¾ƒè¿ç®—ç¬¦ é€»è¾‘è¿ç®—ç¬¦ ä½è¿ç®—ç¬¦ 4.1 ç®—æœ¯è¿ç®—ç¬¦SQLite æ”¯æŒå¸¸è§çš„ã€Œç®—æœ¯è¿ç®—ç¬¦ã€ï¼Œç”¨äºåœ¨æŸ¥è¯¢è¯­å¥ä¸­è¿›è¡Œæ•°å­¦è¿ç®—ã€‚è¿™äº›è¿ç®—ç¬¦å¯ä»¥åœ¨ SELECT è¯­å¥ä¸­è®¡ç®—åˆ—å€¼ï¼Œä¹Ÿå¯ä»¥ç”¨äºæ›´æ–°æ“ä½œã€‚å¸¸è§çš„ç®—æœ¯è¿ç®—ç¬¦åŒ…æ‹¬ åŠ ã€å‡ã€ä¹˜ã€é™¤ å’Œ å–æ¨¡ã€‚ ç®—æ•°è¿ç®—ç¬¦ æè¿° ç¤ºä¾‹ å®ä¾‹ + åŠ æ³• 10 + 5 15 - å‡æ³• 10 - 5 5 * ä¹˜æ³• 10 * 5 50 / é™¤æ³• 10 / 5 2.0 % å–æ¨¡ï¼ˆæ±‚ä½™æ•°ï¼‰ 10 % 3 1 ä¾‹å¦‚ï¼šæˆ‘ä»¬å¯¹å‰é¢çš„ COMPANY è¡¨è¿›è¡Œã€Œç®—æ•°è¿ç®—ç¬¦ã€çš„æ“ä½œï¼š 12345678910sqlite&gt; .mode columnsqlite&gt; select * from company;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------1 Paul 32 California 20000.02 Allen 25 Texas 15000.03 Teddy 23 Norway 20000.04 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.06 Kim 22 South-Hall 45000.0 åŠ æ³•ï¼ˆ+ï¼‰ 12345678910# ç»™æ¯ä¸ªå‘˜å·¥çš„è–ªèµ„å¢åŠ  5000sqlite&gt; SELECT name, salary, salary + 5000 AS new_salary FROM company;NAME SALARY new_salary----- ------- ----------Paul 20000.0 25000.0Allen 15000.0 20000.0Teddy 20000.0 25000.0Mark 65000.0 70000.0David 85000.0 90000.0Kim 45000.0 50000.0 å‡æ³•ï¼ˆ-ï¼‰ 12345678910# ç»™æ¯ä¸ªå‘˜å·¥çš„è–ªèµ„å‡å°‘ 2000sqlite&gt; SELECT name, salary, salary - 2000 AS reduced_salary FROM company;NAME SALARY reduced_salary----- ------- --------------Paul 20000.0 18000.0Allen 15000.0 13000.0Teddy 20000.0 18000.0Mark 65000.0 63000.0David 85000.0 83000.0Kim 45000.0 43000.0 ä¹˜æ³•ï¼ˆ*ï¼‰ 12345678910# ç»™æ¯ä¸ªå‘˜å·¥çš„è–ªèµ„ç¿»å€sqlite&gt; SELECT name, salary, salary * 2 AS doubled_salary FROM company;NAME SALARY doubled_salary----- ------- --------------Paul 20000.0 40000.0Allen 15000.0 30000.0Teddy 20000.0 40000.0Mark 65000.0 130000.0David 85000.0 170000.0Kim 45000.0 90000.0 é™¤æ³•ï¼ˆ/ï¼‰ 12345678910# å°†å‘˜å·¥çš„å¹´è–ªé™¤ä»¥ 12ï¼Œè®¡ç®—æœˆè–ªsqlite&gt; SELECT name, salary / 12 AS monthly_salary FROM company;NAME monthly_salary----- ----------------Paul 1666.66666666667Allen 1250.0Teddy 1666.66666666667Mark 5416.66666666667David 7083.33333333333Kim 3750.0 å–æ¨¡ï¼ˆ%ï¼‰ 12345678910# è®¡ç®—æ¯ä¸ªå‘˜å·¥å¹´é¾„é™¤ä»¥ 2 çš„ä½™æ•°ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå¶æ•°å¹´é¾„ï¼ˆä½™æ•°ä¸º 0ï¼‰sqlite&gt; SELECT id, name, age % 2 AS age_mod FROM company;ID NAME age_mod-- ----- -------1 Paul 02 Allen 13 Teddy 14 Mark 15 David 16 Kim 0 ç»“åˆ WHERE æ¡ä»¶ä½¿ç”¨ 123456# æŸ¥è¯¢æœˆè–ªå¤§äº 5000 çš„å‘˜å·¥sqlite&gt; SELECT * FROM company WHERE salary / 12 &gt; 5000;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------4 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.0 4.2 æ¯”è¾ƒè¿ç®—ç¬¦ç”¨äºæ¯”è¾ƒä¸¤ä¸ªå€¼ï¼Œè¿”å› TRUE æˆ– FALSEã€‚ æ¯”è¾ƒè¿ç®—ç¬¦ æè¿° ç¤ºä¾‹ å®ä¾‹ = ç­‰äº age = 25 TRUE/FALSE != ä¸ç­‰äºï¼ˆSQLite ä¹Ÿæ”¯æŒ &lt;&gt;ï¼‰ age != 30 TRUE/FALSE &lt; å°äº age &lt; 25 TRUE/FALSE &gt; å¤§äº age &gt; 20 TRUE/FALSE &lt;= å°äºç­‰äº age &lt;= 25 TRUE/FALSE &gt;= å¤§äºç­‰äº age &gt;= 20 TRUE/FALSE ä¾‹å¦‚ï¼šæˆ‘ä»¬å¯¹å‰é¢çš„ COMPANY è¡¨è¿›è¡Œã€Œæ¯”è¾ƒè¿ç®—ç¬¦ã€çš„æ“ä½œï¼š 12345678910sqlite&gt; .mode columnsqlite&gt; select * from company;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------1 Paul 32 California 20000.02 Allen 25 Texas 15000.03 Teddy 23 Norway 20000.04 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.06 Kim 22 South-Hall 45000.0 åˆ—å‡º SALARY å¤§äº 50,000.00 çš„æ‰€æœ‰è®°å½• 12345sqlite&gt; SELECT * FROM COMPANY WHERE SALARY &gt; 50000;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------4 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.0 åˆ—å‡º SALARY ç­‰äº 20,000.00 çš„æ‰€æœ‰è®°å½• 12345sqlite&gt; SELECT * FROM COMPANY WHERE SALARY = 20000;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------1 Paul 32 California 20000.03 Teddy 23 Norway 20000.0 åˆ—å‡º SALARY ä¸ç­‰äº 20,000.00 çš„æ‰€æœ‰è®°å½• 123456789101112131415sqlite&gt; SELECT * FROM COMPANY WHERE SALARY != 20000;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------2 Allen 25 Texas 15000.04 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.06 Kim 22 South-Hall 45000.0sqlite&gt; SELECT * FROM COMPANY WHERE SALARY &lt;&gt; 20000;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------2 Allen 25 Texas 15000.04 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.06 Kim 22 South-Hall 45000.0 åˆ—å‡º SALARY å¤§äºç­‰äº 65,000.00 çš„æ‰€æœ‰è®°å½• 12345sqlite&gt; SELECT * FROM COMPANY WHERE SALARY &gt;= 65000;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------4 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.0 4.3 é€»è¾‘è¿ç®—ç¬¦ç”¨äºè¿æ¥å¤šä¸ªæ¡ä»¶è¡¨è¾¾å¼ï¼Œè¿”å›å¸ƒå°”å€¼ã€‚ é€»è¾‘è¿ç®—ç¬¦ æè¿° ç¤ºä¾‹ å®ä¾‹ AND é€»è¾‘ä¸ age &gt; 20 AND salary &lt; 50000 TRUE/FALSE OR é€»è¾‘æˆ– age &lt; 25 OR salary &gt; 60000 TRUE/FALSE NOT é€»è¾‘é NOT age = 25 TRUE/FALSE IS NULL åˆ¤æ–­æ˜¯å¦ä¸º NULL address IS NULL TRUE/FALSE IS NOT NULL åˆ¤æ–­æ˜¯å¦ä¸ä¸º NULL address IS NOT NULL TRUE/FALSE LIKE æ¨¡ç³ŠåŒ¹é… name LIKE â€˜J%â€™ TRUE/FALSE GLOB å…¨å±€åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰ name GLOB â€˜J*â€™ TRUE/FALSE IN åˆ¤æ–­æ˜¯å¦åœ¨åˆ—è¡¨å†… age IN (22, 30) TRUE/FALSE BETWEEN åˆ¤æ–­æ˜¯å¦åœ¨èŒƒå›´å†… age BETWEEN 20 AND 30 TRUE/FALSE ä¾‹å¦‚ï¼šæˆ‘ä»¬å¯¹å‰é¢çš„ COMPANY è¡¨è¿›è¡Œã€Œé€»è¾‘è¿ç®—ç¬¦ã€çš„æ“ä½œï¼š 12345678910sqlite&gt; .mode columnsqlite&gt; select * from company;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------1 Paul 32 California 20000.02 Allen 25 Texas 15000.03 Teddy 23 Norway 20000.04 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.06 Kim 22 South-Hall 45000.0 åˆ—å‡º AGE å¤§äºç­‰äº 25 ä¸”å·¥èµ„å¤§äºç­‰äº 65000.00 çš„æ‰€æœ‰è®°å½• 12345sqlite&gt; SELECT * FROM COMPANY WHERE AGE &gt;= 25 AND SALARY &gt;= 65000;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------4 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.0 åˆ—å‡º AGE å¤§äºç­‰äº 25 æˆ–å·¥èµ„å¤§äºç­‰äº 65000.00 çš„æ‰€æœ‰è®°å½• 1234567sqlite&gt; SELECT * FROM COMPANY WHERE AGE &gt;= 25 OR SALARY &gt;= 65000;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------1 Paul 32 California 20000.02 Allen 25 Texas 15000.04 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.0 åˆ—å‡º AGE ä¸ä¸º NULL çš„æ‰€æœ‰è®°å½•ï¼Œç»“æœæ˜¾ç¤ºæ‰€æœ‰çš„è®°å½•ï¼Œæ„å‘³ç€æ²¡æœ‰ä¸€ä¸ªè®°å½•çš„ AGE ç­‰äº NULL 123456789sqlite&gt; SELECT * FROM COMPANY WHERE AGE IS NOT NULL;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------1 Paul 32 California 20000.02 Allen 25 Texas 15000.03 Teddy 23 Norway 20000.04 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.06 Kim 22 South-Hall 45000.0 åˆ—å‡º NAME ä»¥ â€˜Kiâ€™ å¼€å§‹çš„æ‰€æœ‰è®°å½•ï¼Œâ€™Kiâ€™ ä¹‹åçš„å­—ç¬¦ä¸åšé™åˆ¶ 123456789sqlite&gt; SELECT * FROM COMPANY WHERE NAME LIKE 'Ki%';ID NAME AGE ADDRESS SALARY-- ---- --- ---------- -------6 Kim 22 South-Hall 45000.0sqlite&gt; SELECT * FROM COMPANY WHERE NAME GLOB 'Ki*';ID NAME AGE ADDRESS SALARY-- ---- --- ---------- -------6 Kim 22 South-Hall 45000.0 åˆ—å‡º AGE çš„å€¼ä¸º 23 æˆ– 27 çš„æ‰€æœ‰è®°å½• 12345sqlite&gt; SELECT * FROM COMPANY WHERE AGE IN ( 23, 27 );ID NAME AGE ADDRESS SALARY-- ----- --- ------- -------3 Teddy 23 Norway 20000.05 David 27 Texas 85000.0 åˆ—å‡º AGE çš„å€¼åœ¨ 23 ä¸ 27 ä¹‹é—´çš„æ‰€æœ‰è®°å½• 1234567sqlite&gt; SELECT * FROM COMPANY WHERE AGE BETWEEN 23 AND 27;ID NAME AGE ADDRESS SALARY-- ----- --- ---------- -------2 Allen 25 Texas 15000.03 Teddy 23 Norway 20000.04 Mark 25 Rich-Mond 65000.05 David 27 Texas 85000.0 4.4 ä½è¿ç®—ç¬¦ç”¨äºå¯¹æ•´æ•°æ‰§è¡Œä½æ“ä½œã€‚ ä½è¿ç®—ç¬¦ æè¿° ç¤ºä¾‹ å®ä¾‹ &amp; æŒ‰ä½ä¸å¦‚æœåŒæ—¶å­˜åœ¨äºä¸¤ä¸ªæ“ä½œæ•°ä¸­ï¼ŒäºŒè¿›åˆ¶ AND è¿ç®—ç¬¦å¤åˆ¶ä¸€ä½åˆ°ç»“æœä¸­ 60 &amp; 13 12 | æŒ‰ä½æˆ–å¦‚æœå­˜åœ¨äºä»»ä¸€æ“ä½œæ•°ä¸­ï¼ŒäºŒè¿›åˆ¶ OR è¿ç®—ç¬¦å¤åˆ¶ä¸€ä½åˆ°ç»“æœä¸­ 60 | 13 61 ~ æŒ‰ä½å–åäºŒè¿›åˆ¶è¡¥ç è¿ç®—ç¬¦æ˜¯ä¸€å…ƒè¿ç®—ç¬¦ï¼Œå…·æœ‰â€ç¿»è½¬â€ä½æ•ˆåº”ï¼Œå³ 0 å˜æˆ 1ï¼Œ1 å˜æˆ 0 ~60 -61 &lt;&lt; äºŒè¿›åˆ¶å·¦ç§»è¿ç®—ç¬¦å·¦æ“ä½œæ•°çš„å€¼å‘å·¦ç§»åŠ¨å³æ“ä½œæ•°æŒ‡å®šçš„ä½æ•° 60 &lt;&lt; 2 240 &lt;&lt; äºŒè¿›åˆ¶å³ç§»è¿ç®—ç¬¦å·¦æ“ä½œæ•°çš„å€¼å‘å³ç§»åŠ¨å³æ“ä½œæ•°æŒ‡å®šçš„ä½æ•° 60 &gt;&gt; 2 15 å‡è®¾å¦‚æœ A = 60ï¼Œä¸” B = 13ï¼Œç°åœ¨ä»¥äºŒè¿›åˆ¶æ ¼å¼ï¼Œå®ƒä»¬å¦‚ä¸‹æ‰€ç¤ºï¼š 123456789101112A = 0011 1100B = 0000 1101-----------------A &amp; B = 0000 1100A | B = 0011 1101~ A = 1100 0011-----------------A &lt;&lt; 20011 1100 --&gt; å·¦ç§»ä¸¤ä½ --&gt; 1111 0000 -&gt; 240-----------------A &gt;&gt; 20011 1100 --&gt; å³ç§»ä¸¤ä½ --&gt; 0000 1111 -&gt; 15","link":"/2024/04/01/%E6%95%B0%E6%8D%AE%E5%BA%93%20--%20SQLite%20--%20%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/"},{"title":"è®²çš„ä¸èƒ½å†ç»†çš„ AnimationSpec åŠ¨ç”»è§„èŒƒ","text":"Source Code based on: androidx.compose.**:**:1.5.0 åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥ï¼å‰é¢æˆ‘ä»¬è®²è§£ã€ animate*AsState ã€‘å’Œã€ Animatable ã€‘ä¸¤ç§åŠ¨ç”» API çš„ç”¨æ³•æ—¶ï¼Œéƒ½æåˆ°äº†å®ƒä»¬çš„å‡½æ•°å†…éƒ¨æœ‰ä¸€ä¸ªå…±åŒçš„æ ¸å¿ƒå‚æ•°ï¼šAnimationSpecã€‚ 1234567@Composablefun animateDpAsState( targetValue: Dp, animationSpec: AnimationSpec&lt;Dp&gt; = dpDefaultSpring, // AnimationSpec label: String = &quot;DpAnimation&quot;, finishedListener: ((Dp) -&gt; Unit)? = null) 12345678910111213class Animatable&lt;T, V : AnimationVector&gt;( initialValue: T, val typeConverter: TwoWayConverter&lt;T, V&gt;, private val visibilityThreshold: T? = null, val label: String = &quot;Animatable&quot;) { suspend fun animateTo( targetValue: T, animationSpec: AnimationSpec&lt;T&gt; = defaultSpringSpec, // AnimationSpec initialVelocity: T = velocity, block: (Animatable&lt;T, V&gt;.() -&gt; Unit)? = null )} è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°±å¼€å§‹è¯¦ç»†ä»‹ç»æ¯ä¸€ä¸ª AnimationSpec çš„ç”¨æ³•åŠå…¶åŸç†ã€‚ åŠ¨ç”»è§„èŒƒå›¾æ ‡é¦–å…ˆçœ‹ä¸‹ AnimationSpec åŠ¨ç”»è§„èŒƒçš„å›¾è¡¨ï¼Œè¿™é‡Œä½ å…ˆæœ‰ä¸ªç›´è§‚æ„Ÿå—ï¼Œç­‰çœ‹å®Œè¿™ç¯‡æ–‡ç« å†å›æ¥çœ‹è¿™ä¸ªå›¾è¡¨å°±ä¼šä¸€ç›®äº†ç„¶ã€‚ ä¹‹å‰æˆ‘ä»¬çœ‹åˆ°è¿‡å¾ˆå¤šæ¬¡ AnimationSpec çš„å®šä¹‰äº†ï¼šå®ƒå¯ä»¥è®©ä½ é€šè¿‡å¯é€‰çš„ AnimationSpec å‚æ•°æ¥è‡ªå®šä¹‰åŠ¨ç”»è§„èŒƒï¼Œä»è€Œå®ç°ä¸åŒç±»å‹çš„åŠ¨ç”»æ•ˆæœã€‚ AnimationSpec æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæœ‰å¾ˆå¤šå­æ¥å£å’Œå®ç°ç±»ï¼š è¿™äº› **Spec å°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°å„ç§åŠ¨ç”»æ•ˆæœã€‚ è™½ç„¶ AnimationSpec æœ‰å¥½å‡ ä¸ªå­æ¥å£ï¼Œä½†æˆ‘ä»¬ä¸»è¦å…³æ³¨ FiniteAnimationSpec è¿™ä¸ªæ¥å£çš„å®ç°ç±»å³å¯ã€‚ AnimationSpec å®ç°ç±» è¯´æ˜ DurationBasedAnimationSpec(åŸºäºæ—¶é•¿çš„åŠ¨ç”») KeyframesSpec å…³é”®å¸§åŠ¨ç”» DurationBasedAnimationSpec(åŸºäºæ—¶é•¿çš„åŠ¨ç”») SnapSpec å³ä½¿ç”Ÿæ•ˆåŠ¨ç”» DurationBasedAnimationSpec(åŸºäºæ—¶é•¿çš„åŠ¨ç”») TweenSpec è¡¥é—´åŠ¨ç”» - RepeatableSpec é‡å¤åŠ¨ç”» - SpringSpec å¼¹ç°§åŠ¨ç”» - InfiniteRepeatableSpec æ— é™é‡å¤åŠ¨ç”» ç°åœ¨æˆ‘ä»¬å†å›é¡¾ä¸€ä¸‹ animateDpAsState å’Œ Animatable.animateTo çš„ animationSpec å‚æ•°ï¼š 12345animateDpAsStateï¼š -&gt; animationSpec: AnimationSpec&lt;Dp&gt; = dpDefaultSpringAnimatable.animateToï¼š -&gt; animationSpec: AnimationSpec&lt;T&gt; = defaultSpringSpec å®ƒä»¬é»˜è®¤éƒ½æ˜¯ä¸€ä¸ª SpringSpec çš„å¼¹ç°§æ•ˆæœï¼Œè€Œä¸”é»˜è®¤æ˜¯ä¸å›å¼¹ã€‚ 12345678@Immutableclass SpringSpec&lt;T&gt;( val dampingRatio: Float = Spring.DampingRatioNoBouncy, val stiffness: Float = Spring.StiffnessMedium, val visibilityThreshold: T? = null)const val DampingRatioNoBouncy = 1f // æ— å›å¼¹æ•ˆæœ ç°åœ¨ä½ åº”è¯¥å¤§è‡´äº†è§£ AnimationSpec çš„ç”¨é€”äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¼€å§‹æŒ¨ä¸ªç ”ç©¶ AnimationSpec å®ç°ç±»çš„å…·ä½“åŠ¨ç”»æ•ˆæœã€‚ TweenSpec TweenSpec åº”è¯¥ç®—æ˜¯æœ€ç®€å•çš„ Spec äº†ï¼Œå®ƒåœ¨æŒ‡å®šçš„ durationMillis å†…ä½¿ç”¨ã€Œç¼“å’Œæ›²çº¿ã€åœ¨ã€Œèµ·å§‹å€¼ã€å’Œã€Œç»“æŸå€¼ã€ä¹‹é—´æ·»åŠ åŠ¨ç”»æ•ˆæœã€‚ æˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„æ„é€ å‡½æ•°ï¼š 123456@Immutableclass TweenSpec&lt;T&gt;( val durationMillis: Int = DefaultDurationMillis, val delay: Int = 0, val easing: Easing = FastOutSlowInEasing) : DurationBasedAnimationSpec&lt;T&gt; { } å®ƒæœ‰ä¸‰ä¸ªå‚æ•°ï¼š durationMillisï¼š åŠ¨ç”»æ—¶é•¿ï¼Œä¸å¡«çš„è¯é»˜è®¤ 300ms delayï¼šåŠ¨ç”»å¯åŠ¨å»¶æ—¶ï¼Œé»˜è®¤ä¸å»¶æ—¶ easingï¼šEasing ç±»å‹ï¼Œè®¾ç½®åŠ¨ç”»æ›²çº¿ï¼Œé»˜è®¤æ˜¯ FastOutSlowInEasing æ•ˆæœ é™¤äº† FastOutSlowInEasingï¼ŒCompose è¿˜æä¾›äº†ä¸‰ä¸ªé»˜è®¤çš„åŠ¨ç”»æ›²çº¿ï¼š 12345678// é»˜è®¤æ›²çº¿ï¼šå…ˆåŠ é€Ÿå†å‡é€Ÿval FastOutSlowInEasing: Easing = CubicBezierEasing(0.4f, 0.0f, 0.2f, 1.0f)// å…¨ç¨‹å‡é€Ÿval LinearOutSlowInEasing: Easing = CubicBezierEasing(0.0f, 0.0f, 0.2f, 1.0f)// å…¨ç¨‹åŠ é€Ÿval FastOutLinearInEasing: Easing = CubicBezierEasing(0.4f, 0.0f, 1.0f, 1.0f)// çº¿æ€§æ›²çº¿ï¼šåŒ€é€Ÿè¿åŠ¨val LinearEasing: Easing = Easing { fraction -&gt; fraction } æˆ‘ä»¬åŸºäºå°åˆºçŒ¬éª‘è½¦çš„æ¡ˆä¾‹æµ‹è¯•ä¸‹è¿™å‡ ä¸ªåŠ¨ç”»æ›²çº¿çš„æ•ˆæœï¼ˆä¸ºäº†æ•ˆæœæ˜¾ç¤ºæ›´å¥½ï¼Œæˆ‘ä»¬æ”¹å˜ä¸‹åŠ¨ç”»æ—¶é•¿ï¼‰ï¼š LinearEasingï¼šåŒ€é€Ÿè¿åŠ¨ 123456789101112131415161718192021222324252627282930313233343536class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset = remember(bicycleStart) { if (bicycleStart) 335.dp else 0.dp } val anim = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim.animateTo( offset, TweenSpec(durationMillis = 2000, easing = LinearEasing) // 2s, åŒ€é€Ÿè¿åŠ¨ ) } Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim.value) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} FastOutSlowInEasingï¼šå…ˆåŠ é€Ÿå†å‡é€Ÿï¼ˆè¿™æ˜¯é»˜è®¤æ›²çº¿ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å¡«ï¼‰ 123456789101112131415161718192021222324252627282930313233343536class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset = remember(bicycleStart) { if (bicycleStart) 335.dp else 0.dp } val anim = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim.animateTo( offset, TweenSpec(durationMillis = 2000) // 2sï¼Œé»˜è®¤æ›²çº¿ï¼Œå…ˆåŠ é€Ÿåå‡é€Ÿ ) } Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim.value) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} LinearOutSlowInEasingï¼šå…¨ç¨‹å‡é€Ÿ 123456789101112131415161718192021222324252627282930313233343536class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset = remember(bicycleStart) { if (bicycleStart) 335.dp else 0.dp } val anim = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim.animateTo( offset, TweenSpec(durationMillis = 2000, easing = LinearOutSlowInEasing) // 2s, å…¨ç¨‹å‡é€Ÿ ) } Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim.value) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} FastOutLinearInEasingï¼šå…¨ç¨‹åŠ é€Ÿ 123456789101112131415161718192021222324252627282930313233343536class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset = remember(bicycleStart) { if (bicycleStart) 335.dp else 0.dp } val anim = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim.animateTo( offset, TweenSpec(durationMillis = 2000, easing = FastOutLinearInEasing) // 2s, å…¨ç¨‹åŠ é€Ÿ ) } Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim.value) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} ç°åœ¨æˆ‘ä»¬æŠŠå››ç§åŠ¨ç”»æ›²çº¿åˆå¹¶åœ¨ä¸€èµ·çœ‹ä¸‹æ•ˆæœï¼š ä½†æ˜¯ï¼ä½†æœ‰ç‚¹ low å•Šï¼åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦çš„åŠ¨ç”»æ›²çº¿æ•ˆæœæœªå¿…å°±æ˜¯è¿™å››ç§ï¼Œé€šå¸¸ UX è®¾è®¡å¸ˆä¼šæä¾›ç»™æˆ‘ä»¬ä¸€äº›è®¾è®¡å¥½çš„åŠ¨ç”»æ›²çº¿ã€‚æ¯”å¦‚ï¼šï¼ˆ0.0ï¼Œ0.0ï¼Œ0.1ï¼Œ1.0ï¼‰ï¼Œï¼ˆ0.2ï¼Œ0.1ï¼Œ0.0ï¼Œ1.0ï¼‰ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå®ç°è¿™äº›åŠ¨ç”»æ›²çº¿ï¼Ÿè¿™äº›åæ ‡ç‚¹åˆæ˜¯ä»€ä¹ˆï¼Ÿ ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ä¹‹å‰çš„åŠ¨ç”»æ›²çº¿ï¼š 123val FastOutSlowInEasing: Easing = CubicBezierEasing(0.4f, 0.0f, 0.2f, 1.0f)val LinearOutSlowInEasing: Easing = CubicBezierEasing(0.0f, 0.0f, 0.2f, 1.0f)val FastOutLinearInEasing: Easing = CubicBezierEasing(0.4f, 0.0f, 1.0f, 1.0f) ä»–ä»¬éƒ½ç”¨ä¸€ä¸ª CubicBezierEasing åŒ…èµ·æ¥äº†ï¼Œå®ƒæœ‰å››ä¸ªå‚æ•°ï¼Œè¿™å››ä¸ªå‚æ•°æ˜¯ç”¨æ¥å®šä¹‰ä¸€ä¸ªã€Œä¸‰é˜¶è´å¡å°”æ›²çº¿ã€çš„ã€‚ ä¸‰é˜¶è´å¡å°”æ›²çº¿ æœ‰å››ä¸ªç‚¹ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªç‚¹æ˜¯å›ºå®šçš„ï¼Œåˆ†åˆ«æ˜¯ï¼š(0, 0) å’Œ (1, 1)ï¼Œæˆ‘ä»¬åªéœ€è¦ç»™å‡ºå¦å¤–ä¸¤ä¸ªç‚¹å³å¯å®šä¹‰å‡ºä¸‰é˜¶è´å¡å°”æ›²çº¿ã€‚ æ‰€ä»¥æ— è®ºæ˜¯ Compose æä¾›çš„åŠ¨ç”»æ›²çº¿ï¼Œè¿˜æ˜¯ UX è®¾è®¡å¸ˆæä¾›çš„åŠ¨ç”»æ›²çº¿ï¼Œå®ƒä»¬çš„å››ä¸ªæ•°å€¼å°±å¯¹åº”ç€æˆ‘ä»¬éœ€è¦çš„å¦å¤–ä¸¤ä¸ªç‚¹ï¼ ä¸æ‡‚çš„è¯ï¼Œç»™ä½ ä¸€ä¸ªç½‘ç«™ï¼š è¿™æ˜¯ä¸€ä¸ªå¯ä»¥çœ‹åˆ°ã€Œä¸‰é˜¶è´å¡å°”æ›²çº¿ã€å®šåˆ¶æ•ˆæœçš„å·¥å…·ç½‘ç«™ï¼Œå…¶ä¸­ä¸¤ä¸ªç™½ç‚¹å°±æ˜¯å›ºå®šçš„ (0, 0) å’Œ (1, 1)ï¼Œè€Œã€Œçº¢è‰²ã€å’Œã€Œç»¿è‰²ã€ä¸¤ä¸ªç‚¹å°±å¯¹åº”æˆ‘ä»¬åŠ¨ç”»æ›²çº¿çš„å››ä¸ªå‚æ•°ï¼Œå³ 2 ä¸ªåæ ‡ã€‚ ä½ å¯ä»¥éšæ„æ‹–åŠ¨çº¢ç‚¹å’Œè“ç‚¹ï¼Œä¸Šæ–¹çš„åæ ‡å‚æ•°ä¼šåŒæ­¥æ›´æ–°ï¼Œæ‰€ä»¥ UX è®¾è®¡å¸ˆæä¾›ç»™æˆ‘ä»¬çš„åæ ‡ç‚¹ï¼Œå°±å¯ä»¥åœ¨è¿™ä¸ªç½‘ç«™æµ‹è¯•åŠ¨ç”»æ•ˆæœã€‚ ç°åœ¨æˆ‘ä»¬åˆ†åˆ«æµ‹è¯•ä¸‹ Compose æä¾›çš„å‡ ä¸ªåŠ¨ç”»æ›²çº¿çš„æ•ˆæœï¼š 12// å…ˆåŠ é€Ÿåå‡é€Ÿval FastOutSlowInEasing: Easing = CubicBezierEasing(0.4f, 0.0f, 0.2f, 1.0f) 12// å…¨ç¨‹å‡é€Ÿval LinearOutSlowInEasing: Easing = CubicBezierEasing(0.0f, 0.0f, 0.2f, 1.0f) 12// å…¨ç¨‹åŠ é€Ÿval FastOutLinearInEasing: Easing = CubicBezierEasing(0.4f, 0.0f, 1.0f, 1.0f) TweenSpec çš„ç”¨æ³•å’Œæ ¸å¿ƒçŸ¥è¯†ç‚¹ä¹Ÿå°±è¿™ä¹ˆå¤šäº†ï¼Œå®ƒçš„æ ¸å¿ƒä¹Ÿå°±æ˜¯ åŠ¨ç”»æ›²çº¿ Easingï¼Œè¦ä¹ˆå°±ç”¨ Compose æä¾›ç»™æˆ‘ä»¬çš„åŠ¨ç”»æ›²çº¿ï¼Œè¦ä¹ˆä½ è‡ªå·±è‡ªå®šä¹‰ï¼šCubicBezierEasing(*, *, *, *)ã€‚ æœ€åè®²ä¸ªå°æŠ€å·§ï¼ŒCompose æä¾›äº†ä¸€ä¸ª tween å‡½æ•°ç®€åŒ–å†™æ³•ï¼Œç­‰åŒäº TweenSpecï¼Œå®ƒå†…éƒ¨å°±æ˜¯åˆ›å»ºäº† TweenSpecã€‚ 123456@Stablefun &lt;T&gt; tween( durationMillis: Int = DefaultDurationMillis, delayMillis: Int = 0, easing: Easing = FastOutSlowInEasing): TweenSpec&lt;T&gt; = TweenSpec(durationMillis, delayMillis, easing) æ‰€ä»¥ä»¥ä¸‹å†™æ³•éšä¾¿ä½ å†™å“ªä¸ªï¼š 12anim.animateTo(size, TweenSpec(easing = FastOutLinearInEasing))anim.animateTo(size, tween(easing = FastOutLinearInEasing)) SnapSpecsnap æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ AnimationSpecï¼Œå®ƒä¼šç«‹å³å°†å€¼åˆ‡æ¢åˆ°ç»“æŸå€¼ã€‚ æˆ‘ä¸çŸ¥é“ä½ è¿˜æœ‰æ²¡æœ‰å°è±¡ï¼Œåœ¨å‰é¢è®²è§£ Animatable çš„æ—¶å€™ï¼Œæˆ‘ä»¬æåˆ°è¿‡å®ƒæœ‰ä¸€ä¸ª snapTo çš„å‡½æ•°ï¼Œå®ƒå¯ä»¥æŒ‡å®šç›®æ ‡å€¼çªå˜åˆ°æŸä¸€ä¸ªå€¼ï¼Œè€Œ SnapSpec å…¶å®è·Ÿå®ƒæ˜¯å·®ä¸å¤šçš„æ„æ€ï¼Œå°±æ˜¯è®©åŠ¨ç”»æ•ˆæœçªå˜ï¼Œç¬é—´å®Œæˆã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset = remember(bicycleStart) { if (bicycleStart) 335.dp else 0.dp } val anim = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim.animateTo(offset, SnapSpec()) } val anim2 = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim2.animateTo(offset, TweenSpec(durationMillis = 2000)) } Column{ Text(text = &quot;TweenSpec é»˜è®¤ï¼šå…ˆåŠ é€Ÿå†å‡é€Ÿ&quot;, fontSize = 16.sp) Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim2.value) ) Text(&quot;SnapSpec&quot;, fontSize = 16.sp, modifier = Modifier.padding(top = 25.dp)) Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim.value) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} ä¸Šé¢ä»£ç ä¸­æˆ‘ä»¬åŒæ—¶å†™äº† TweenSpec å’Œ SnapSpec ä¸¤ä¸ªåŠ¨ç”»ï¼Œçœ‹ä¸‹å¯¹æ¯”æ•ˆæœï¼š æ•ˆæœå¾ˆæ˜æ˜¾å§ï¼ŸSnapSpec å°±è·Ÿ â€œç¬é—´ç§»åŠ¨â€ å·®ä¸å¤šï¼Œå®ƒæ˜¯ä¸€ç§ å³æ—¶ç”Ÿæ•ˆã€å³æ—¶å®Œæˆ çš„åŠ¨ç”»æ•ˆæœã€‚ å¦å¤–ï¼ŒSnapSpec() æœ‰ä¸ª delay å‚æ•°ï¼Œç”¨æ¥å»¶è¿ŸåŠ¨ç”»æ’­æ”¾çš„å¼€å§‹æ—¶é—´ã€‚ 1class SnapSpec&lt;T&gt;(val delay: Int = 0) : DurationBasedAnimationSpec&lt;T&gt; æ¯”å¦‚æˆ‘ä»¬æ·»åŠ ä¸€ä¸ª 2s çš„å»¶æ—¶ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset = remember(bicycleStart) { if (bicycleStart) 335.dp else 0.dp } val anim = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim.animateTo(offset, SnapSpec(delay = 2000)) } val anim2 = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim2.animateTo(offset, TweenSpec(durationMillis = 2300)) } Column{ Text(text = &quot;TweenSpec é»˜è®¤ï¼šå…ˆåŠ é€Ÿå†å‡é€Ÿ&quot;, fontSize = 16.sp) Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim2.value) ) Text(&quot;SnapSpec&quot;, fontSize = 16.sp, modifier = Modifier.padding(top = 25.dp)) Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim.value) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} è·Ÿ tween ä¸€æ ·ï¼ŒCompose ä¹Ÿæä¾›äº† SnapSpec çš„ç®€åŒ–å†™æ³•ï¼šsnapã€‚ 12anim.animateTo(size, SnapSpec())anim.animateTo(size, snap()) KeyframesSpecKeyframesSpce å°±æ˜¯ã€Œå…³é”®å¸§ã€çš„æ„æ€ï¼Œå¯ä»¥è®©æˆ‘ä»¬åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­é€‰å–å‡ ä¸ªå…³é”®çš„æ—¶é—´ç‚¹ï¼Œå¹¶ç»™å‡ºè¿™äº›æ—¶é—´ç‚¹å¯¹åº”çš„åŠ¨ç”»å®Œæˆåº¦ï¼Œç›¸å½“äºåˆ†æ®µå¼çš„ TweenSpecã€‚ åœ¨è®²è§£ KeyframesSpce çš„ä½¿ç”¨æ–¹æ³•ä¹‹å‰ï¼Œæœ‰ä¸ªç»†èŠ‚ç‚¹éœ€è¦è¯´ä¸€ä¸‹ï¼šå¦‚æœæˆ‘ä»¬ç”¨å®ƒçš„æ„é€ å‡½æ•°æ¥åˆ›å»ºçš„è¯ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦åƒä¸‹é¢è¿™æ ·å†™ï¼š 123anim.animateTo(size, KeyframesSpec&lt;Dp&gt;(KeyframesSpec.KeyframesSpecConfig()).apply { }) å¾ˆé•¿å¾ˆå•°å—¦ï¼ŒCompose åŒæ ·æä¾›äº†ç®€ä¾¿çš„ keyframes æ¥åˆ›å»º KeyframesSpecï¼š 123456@Stablefun &lt;T&gt; keyframes( init: KeyframesSpec.KeyframesSpecConfig&lt;T&gt;.() -&gt; Unit): KeyframesSpec&lt;T&gt; { return KeyframesSpec(KeyframesSpec.KeyframesSpecConfig&lt;T&gt;().apply(init))} æ‰€ä»¥ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šè¿™ä¹ˆå†™ï¼š 1anim.animateTo(size, keyframes { }) ç°åœ¨å¯ä»¥å†™å†…éƒ¨ä»£ç äº†ï¼š 123456789101112131415161718192021222324252627282930313233343536class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset = remember(bicycleStart) { if (bicycleStart) 335.dp else 0.dp } val anim = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim.animateTo(offset, keyframes { durationMillis = 2000 100.dp at 1000 }) } Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim.value) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} ä¸ºäº†ä½“ç°æ›´å¥½çš„ keyframes åŠ¨ç”»æ•ˆæœï¼Œæˆ‘ä»¬å¯¹åŠ¨ç”»æŒ‡å®šäº† 2000ms æ—¶é•¿ï¼Œç„¶ååŠ äº†ä¸€è¡Œ 100.dp at 1000ï¼Œå«ä¹‰å°±æ˜¯ï¼š1000ms å†…ç§»åŠ¨åˆ° 100dpï¼Œå‰©ä¸‹çš„ 1000ms èµ°å®Œæœ€åçš„è·¯ç¨‹ã€‚ çœ‹ä¸‹åŠ¨ç”»ï¼Œæ˜¯ä¸æ˜¯è¿™ä¹ˆå›äº‹ï¼Ÿ æ‰€ä»¥ä½ å…¶å®å¯ä»¥å¾ˆæ˜æ˜¾çš„å‘ç°ï¼šKeyframesSpec é€šè¿‡æ·»åŠ å…³é”®å¸§ï¼Œå°±æ˜¯æŠŠåŠ¨ç”»è¿›è¡Œäº†æ‹†åˆ†ï¼Œå°±åƒå®ƒçš„å®šä¹‰ï¼Œå®ƒç›¸å½“äºåˆ†æ®µå¼çš„ TweenSpecã€‚ ç°åœ¨æˆ‘ä»¬å†æ¥åŠ ä¸€ä¸ªå…³é”®å¸§æµ‹è¯•ä¸€ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset = remember(bicycleStart) { if (bicycleStart) 335.dp else 0.dp } val anim = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim.animateTo(offset, keyframes { durationMillis = 2000 100.dp at 1000 50.dp at 1500 }) } Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim.value) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} æƒ³æƒ³ä¸‹æ˜¯ä¸æ˜¯ä¸‹é¢çš„æ•ˆæœï¼šï¼ˆæ¯”å¦‚å‰è¿›è¿‡ç¨‹ï¼‰ 0 - 1000msï¼š0.dp -&gt; 100.dp 1000ms - 1500msï¼š100.dp -&gt; 50.dp 1500ms -2000msï¼š50.dp -&gt; èµ°å®Œè·¯ç¨‹ å¦å¤– KeyframesSpec ä¹ŸåŒæ ·å¯ä»¥è®¾ç½®å»¶è¿Ÿï¼š 12345678LaunchedEffect(bicycleStart) { anim.animateTo(offset, keyframes { durationMillis = 2000 delayMillis = 1000 100.dp at 1000 50.dp at 1500 })} è®²åˆ°è¿™é‡Œï¼Œä½ åº”è¯¥å·²ç»æŒæ¡äº† KeyframesSpec çš„ç”¨æ³•äº†ã€‚å®ƒè·Ÿ TweenSpec åŸºæœ¬ä¸Šä¸€æ ·ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨è®² TweenSpec çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªé‡ç‚¹çŸ¥è¯†ï¼šåŠ¨ç”»æ›²çº¿ - - ä¸åŒåŠ¨ç”»æ›²çº¿é€Ÿåº¦æ˜¯ä¸ä¸€æ ·çš„ã€‚ é‚£ KeyframesSpec èƒ½è®¾ç½®åŠ¨ç”»æ›²çº¿å—ï¼Ÿï¼Ÿï¼Ÿ ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ¯”å¦‚ï¼š 12345678LaunchedEffect(bicycleStart) { anim.animateTo(offset, keyframes { durationMillis = 2000 delayMillis = 1000 100.dp at 1000 with FastOutSlowInEasing 50.dp at 1500 })} ä¸è¿‡ï¼ŒKeyframesSpace æ˜¯åˆ†æ®µåŠ¨ç”»ï¼Œå¯ä»¥ç»™æ¯æ®µåŠ¨ç”»å•ç‹¬æŒ‡å®šä¸€ä¸ªåŠ¨ç”»æ›²çº¿ï¼Œä½†æ˜¯é—®é¢˜å°±æ¥äº†ï¼š FastOutSlowInEasing è¿™ä¸ªå…ˆåŠ é€Ÿåå‡é€Ÿçš„åŠ¨ç”»æ›²çº¿åˆ°åº•æ˜¯ 1000ms ä¹‹å‰çš„åŠ¨ç”»è¿˜æ˜¯ 1000ms ä¹‹åçš„åŠ¨ç”»ï¼Ÿ ç­”æ¡ˆæ˜¯ï¼šä¹‹åçš„åŠ¨ç”»ï¼Œä¹Ÿå°±æ˜¯ 1000ms - 2000ms ä¹‹é—´çš„åŠ¨ç”»ã€‚ ä½†æ˜¯ 1000ms ä¹‹å‰æƒ³è®¾ç½®åŠ¨ç”»æ›²çº¿æ€ä¹ˆåŠï¼Ÿ 123456789LaunchedEffect(bicycleStart) { anim.animateTo(offset, keyframes { durationMillis = 2000 delayMillis = 1000 0.dp at 0 with FastOutLinearInEasing 100.dp at 1000 with FastOutSlowInEasing 50.dp at 1500 })} å°±è¿™ä¹ˆç®€å•ï¼Œå†åŠ ä¸€ä¸ªåŠ¨ç”»ä» 0ms å¼€å§‹çš„åŠ¨ç”»æ›²çº¿å³å¯ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè¿™ä¸ª 0.dp åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå› ä¸ºå¦‚æœæ˜¯ä»å³å¾€å·¦éª‘è½¦çš„è¯ï¼Œå°±åº”è¯¥å†™æˆ 360.dpï¼Œæ‰€ä»¥æ ¹æ®å®é™…æƒ…å†µï¼Œä½ è¦å†™å¯¹åŠ¨ç”»çš„åˆå§‹å€¼ã€‚ SpringSpecè¿˜è®°å¾—æˆ‘ä»¬åˆšå¼€å§‹è®²åŠ¨ç”»çš„æ—¶å€™æåˆ°è¿‡ animateTo æœ‰ä¸€ä¸ªé»˜è®¤çš„åŠ¨ç”»æ•ˆæœå—ï¼Ÿ 123456789suspend fun animateTo( targetValue: T, animationSpec: AnimationSpec&lt;T&gt; = defaultSpringSpec, initialVelocity: T = velocity, block: (Animatable&lt;T, V&gt;.() -&gt; Unit)? = null)internal val defaultSpringSpec: SpringSpec&lt;T&gt; = SpringSpec(visibilityThreshold = visibilityThreshold) SpringSpec å°±æ˜¯é»˜è®¤çš„åŠ¨ç”»ï¼šç”¨æ¥å®ç°å¼¹ç°§æ•ˆæœçš„ï¼ å¦‚æœä½ è¦ä¸ºç»„ä»¶æŒ‡å®šä¸€ä¸ªå¼¹ç°§æ•ˆæœï¼Œä»£ç å†™èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼š 123456789101112131415161718192021222324252627282930313233class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) var bicycleStart by mutableStateOf(false) setContent { val offset = remember(bicycleStart) { if (bicycleStart) 335.dp else 0.dp } val anim = remember { Animatable(offset, Dp.VectorConverter) } LaunchedEffect(bicycleStart) { anim.animateTo(offset, spring()) // å¼¹ç°§æ•ˆæœ } Column{ Image( painter = painterResource(R.drawable.bicycle), contentDescription = null, modifier = Modifier .absoluteOffset(x = anim.value) ) Button( onClick = { bicycleStart = !bicycleStart }, modifier = Modifier .fillMaxWidth() .wrapContentSize(align = Alignment.Center) ) { Text(text = &quot;Ride&quot;) } } } }} å¦‚ä»£ç é‡Œé¢å†™çš„ï¼šCompose ä¹Ÿæä¾›äº†ä¸€ä¸ª spring() å¿«æ·æ–¹æ³•ç”¨äºåˆ›å»º SpringSpecã€‚å°±è¿™æ ·ï¼Œå•¥ä¹Ÿä¸ç”¨å¡«å°±å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªå¼¹ç°§åŠ¨ç”»äº†ã€‚ å¦‚æœè¦å®šåˆ¶æ›´å¤æ‚ä¸€ç‚¹çš„å¼¹ç°§åŠ¨ç”»å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹çœ‹ SpringSpec æ„é€ å‡½æ•°æœ‰å“ªäº›å‚æ•°ï¼š 123456@Immutableclass SpringSpec&lt;T&gt;( val dampingRatio: Float = Spring.DampingRatioNoBouncy, val stiffness: Float = Spring.StiffnessMedium, val visibilityThreshold: T? = null) : FiniteAnimationSpec&lt;T&gt; { } dampingRatioï¼šé˜»å°¼æ¯” å°±æ˜¯å¼¹ç°§å¼¹çš„è¿‡ç¨‹ä¸­ä¼šå—åˆ°å¤šå¤§çš„é˜»åŠ›ï¼Œé»˜è®¤å€¼æ˜¯ï¼šDampingRatioNoBouncy = 1fï¼Œæ²¡æœ‰ä»»ä½•å¼¹ç°§æ•ˆæœã€‚ dampingRatio = DampingRatioNoBouncy 1anim.animateTo(offset, spring()) dampingRatio = 0.2f 1anim.animateTo(offset, spring(dampingRatio = 0.2f)) dampingRatio = 10f 1anim.animateTo(offset, spring(dampingRatio = 10f)) æˆ‘ä»¬æŠŠä¸‰ä¸ªã€Œé˜»å°¼æ¯”ã€æ”¾ä¸€èµ·çœ‹ä¸‹æ•ˆæœï¼š stiffnessï¼š åˆšåº¦ å¼¹ç°§æœ‰å¤šç¡¬ï¼Œè¶Šç¡¬å›å¼¹è¶ŠçŒ›ï¼Œé»˜è®¤å€¼æ˜¯ï¼šStiffnessMedium = 1500fã€‚ DampingRatioNoBouncy = 0.1fï¼Œ StiffnessMedium = 1500f 1anim.animateTo(offset, spring(dampingRatio = 0.1f, stiffness = 1500f)) DampingRatioNoBouncy = 0.1fï¼Œ StiffnessHigh = 10_000f 1anim.animateTo(offset, spring(dampingRatio = 0.1f, stiffness = 10_000f)) DampingRatioNoBouncy = 0.1fï¼Œ StiffnessMediumLow = 400f 1anim.animateTo(offset, spring(dampingRatio = 0.1f, stiffness = 400f)) æˆ‘ä»¬æŠŠä¸‰ä¸ªã€Œåˆšåº¦ã€æ”¾ä¸€èµ·çœ‹ä¸‹æ•ˆæœï¼š visibilityThresholdï¼š å¯è§†é˜ˆå€¼ å¦‚æœä½ æŠŠ DampingRatioNoBouncy è®¾ç½®çš„ç‰¹åˆ«ç‰¹åˆ«å°ï¼Œå®ƒä¼šä¸€ç›´å¼¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¾ç½® visibilityThreshold é˜ˆå€¼ï¼Œè®©å¼¹çª—åˆ°è¾¾è¿™ä¸ªé˜ˆå€¼åç›´æ¥åœæ­¢ã€‚ 1anim.animateTo(offset, spring(dampingRatio = 0.05f, stiffness = 1500f, 50.dp)) è‡³æ­¤ï¼ŒSpringSpec å¼¹çª—åŠ¨ç”»æ•ˆæœä¹Ÿè®²å®Œäº†ã€‚ RepeatableSpecRepeatableSpec ä¸»è¦ç”¨äºåå¤è¿è¡ŒåŸºäºæ—¶é•¿çš„åŠ¨ç”»ï¼ˆä¾‹å¦‚ tween æˆ– keyframesï¼‰ï¼Œç›´è‡³è¾¾åˆ°æŒ‡å®šçš„è¿­ä»£è®¡æ•°ã€‚ çœ‹ä¸‹å®ƒçš„æ„é€ å‡½æ•°ä½ å°±æ‡‚äº†ï¼š 12345678@Stablefun &lt;T&gt; repeatable( iterations: Int, animation: DurationBasedAnimationSpec&lt;T&gt;, repeatMode: RepeatMode = RepeatMode.Restart, initialStartOffset: StartOffset = StartOffset(0)): RepeatableSpec&lt;T&gt; = RepeatableSpec(iterations, animation, repeatMode, initialStartOffset) iterationsï¼šè¿­ä»£æ¬¡æ•° å°±æ˜¯è¦é‡å¤çš„æ¬¡æ•°ï¼Œå¡« 1 å°±æ˜¯ä¸é‡å¤ 1anim.animateTo(size, repeatable(3)) animationï¼šåŠ¨ç”» éœ€è¦ä¼ å…¥ä¸€ä¸ª DurationBasedAnimationSpec ç±»å‹çš„åŠ¨ç”»ï¼Œå“ªäº›åŠ¨ç”»æ˜¯ DurationBasedAnimationSpec ç±»å‹ï¼Ÿ 1anim.animateTo(offset, repeatable(3, tween())) è¿™æ ·å°±å¯ä»¥è¿è¡Œäº†ï¼š repeatModeï¼šé‡å¤æ¨¡å¼ æŒ‡å®šæ˜¯ â€œé‡å¯â€ è¿˜æ˜¯ â€œå€’æ”¾â€ 1anim.animateTo(offset, repeatable(3, tween(), RepeatMode.Reverse)) // å€’æ”¾ æ³¨æ„ï¼š å¦‚æœä½ è®¾ç½®äº† repeatMode æ¨¡å¼ä¸º â€œå€’æ”¾â€ï¼Œé‚£ä¹ˆ iterations è¿­ä»£æ¬¡æ•°ä¸èƒ½è®¾ç½®æˆåŒæ•°ï¼Œåªèƒ½å•æ•°ï¼Œæ¯”å¦‚ï¼š 1anim.animateTo(offset, repeatable(2, tween(durationMillis = 1500), RepeatMode.Reverse)) å¾ˆæ˜æ˜¾åŠ¨ç”»ä¸å¯¹äº†ï¼Œä¸€æ¬¡å¾€è¿”ä¹‹ååº”è¯¥åœä¸‹ï¼Œä½†æ˜¯å”°çš„ä¸€ä¸‹åˆè¿‡å»äº†ï¼ŒåŸå› å…¶å®å¾ˆç®€å•ï¼šå› ä¸ºæˆ‘ä»¬è®¾äº†ç›®æ ‡å€¼ 360dpã€‚ initialStartOffsetï¼šåˆå§‹å¯åŠ¨åç§»ï¼ˆæ—¶é—´åç§»ï¼‰ é»˜è®¤å€¼ä¸º0ï¼Œå³ä¸åç§» 1anim.animateTo(offset, repeatable(3, tween(), RepeatMode.Reverse, StartOffset(1000))) ä¸è¿‡ StartOffset è¿˜æœ‰ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¯ä»¥è®¾ç½®æ˜¯ â€œå»¶æ—¶å‹åç§»â€ è¿˜æ˜¯ â€œå¿«è¿›å‹åç§»â€ã€‚ å»¶è¿Ÿå‹åç§»ï¼šStartOffsetType.Delay 12anim.animateTo(offset, repeatable(3, tween(durationMillis = 2000), RepeatMode.Reverse, StartOffset(1000, StartOffsetType.Delay))) å¿«è¿›å‹åç§»ï¼šStartOffsetType.FastForward 12anim.animateTo(offset, repeatable(3, tween(durationMillis = 2000), RepeatMode.Reverse, StartOffset(1000, StartOffsetType.FastForward))) æˆ‘ä»¬çœ‹ä¸‹å¿«è¿›å‹æ•ˆæœï¼š åŠ¨ç”»æ—¶é•¿ 2sï¼Œå¿«è¿›äº† 1s å¯åŠ¨ï¼Œæ‰€ä»¥ä¼šä»ä¸­é—´å¼€å§‹ã€‚è‡³æ­¤ï¼ŒRepeatableSpec ä¹Ÿè®²å®Œäº†ã€‚ InfiniteRepeatableSpec InfiniteRepeatableSpec ä¸ RepeatableSpec ç±»ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ï¼šå®ƒä¼šé‡å¤æ— é™æ¬¡çš„è¿­ä»£ã€‚ æˆ‘ä»¬çœ‹ä¸‹å®ƒçš„æ„é€ å‡½æ•°ï¼š 12345class InfiniteRepeatableSpec&lt;T&gt;( val animation: DurationBasedAnimationSpec&lt;T&gt;, val repeatMode: RepeatMode = RepeatMode.Restart, val initialStartOffset: StartOffset = StartOffset(0)) ä¸ RepeatableSpec å”¯ä¸€åŒºåˆ«å°±æ˜¯å»é™¤äº† iterations è¿­ä»£æ¬¡æ•°ï¼Œç”¨æ³•æ²¡æœ‰ä»»ä½•ç‰¹æ®Šçš„åœ°æ–¹ã€‚ 123LaunchedEffect(bicycleStart) { anim.animateTo(offset, infiniteRepeatable(tween(durationMillis = 2000), RepeatMode.Reverse))} å¯¹äºInfiniteRepeatableSpec è¿™ç§æ— é™é‡å¤çš„åŠ¨ç”»ï¼Œåªè¦å®ƒæ‰€ä¾èµ–çš„åç¨‹å–æ¶ˆï¼ŒåŠ¨ç”»å³å¯åœæ­¢ã€‚","link":"/2024/08/05/Compose%20--%20%E5%8A%A8%E7%94%BB%20--%2003.%20%E8%AE%B2%E7%9A%84%E4%B8%8D%E8%83%BD%E5%86%8D%E7%BB%86%E7%9A%84%20AnimationSpec%20%E5%8A%A8%E7%94%BB%E8%A7%84%E8%8C%83/"}],"tags":[{"name":"Launcher3","slug":"Launcher3","link":"/tags/Launcher3/"},{"name":"Android 14.0","slug":"Android-14-0","link":"/tags/Android-14-0/"},{"name":"Compose","slug":"Compose","link":"/tags/Compose/"},{"name":"Modifier","slug":"Modifier","link":"/tags/Modifier/"},{"name":"CombinedModifier","slug":"CombinedModifier","link":"/tags/CombinedModifier/"},{"name":"ComposedModifier","slug":"ComposedModifier","link":"/tags/ComposedModifier/"},{"name":"DrawModifier","slug":"DrawModifier","link":"/tags/DrawModifier/"},{"name":"LayoutModifier","slug":"LayoutModifier","link":"/tags/LayoutModifier/"},{"name":"PointerInputModifier","slug":"PointerInputModifier","link":"/tags/PointerInputModifier/"},{"name":"å‰¯ä½œç”¨","slug":"å‰¯ä½œç”¨","link":"/tags/%E5%89%AF%E4%BD%9C%E7%94%A8/"},{"name":"é™„å¸¦æ•ˆåº”","slug":"é™„å¸¦æ•ˆåº”","link":"/tags/%E9%99%84%E5%B8%A6%E6%95%88%E5%BA%94/"},{"name":"Compose åç¨‹","slug":"Compose-åç¨‹","link":"/tags/Compose-%E5%8D%8F%E7%A8%8B/"},{"name":"Compose åŠ¨ç”»","slug":"Compose-åŠ¨ç”»","link":"/tags/Compose-%E5%8A%A8%E7%94%BB/"},{"name":"animate*AsState()","slug":"animate-AsState","link":"/tags/animate-AsState/"},{"name":"Animatable()","slug":"Animatable","link":"/tags/Animatable/"},{"name":"Transition","slug":"Transition","link":"/tags/Transition/"},{"name":"AnimatedVisibility","slug":"AnimatedVisibility","link":"/tags/AnimatedVisibility/"},{"name":"Crossfade","slug":"Crossfade","link":"/tags/Crossfade/"},{"name":"AnimatedContent","slug":"AnimatedContent","link":"/tags/AnimatedContent/"},{"name":"animateContentSize","slug":"animateContentSize","link":"/tags/animateContentSize/"},{"name":"çŠ¶æ€è®¢é˜… &amp; è‡ªåŠ¨æ›´æ–°","slug":"çŠ¶æ€è®¢é˜…-è‡ªåŠ¨æ›´æ–°","link":"/tags/%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/"},{"name":"mutableStateOf","slug":"mutableStateOf","link":"/tags/mutableStateOf/"},{"name":"mutableStateListOf","slug":"mutableStateListOf","link":"/tags/mutableStateListOf/"},{"name":"é‡ç»„","slug":"é‡ç»„","link":"/tags/%E9%87%8D%E7%BB%84/"},{"name":"remember","slug":"remember","link":"/tags/remember/"},{"name":"é‡ç»„ä½œç”¨åŸŸ","slug":"é‡ç»„ä½œç”¨åŸŸ","link":"/tags/%E9%87%8D%E7%BB%84%E4%BD%9C%E7%94%A8%E5%9F%9F/"},{"name":"Compose çŠ¶æ€","slug":"Compose-çŠ¶æ€","link":"/tags/Compose-%E7%8A%B6%E6%80%81/"},{"name":"æ•°æ®åº“","slug":"æ•°æ®åº“","link":"/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"name":"SQLite","slug":"SQLite","link":"/tags/SQLite/"},{"name":"AnimationSpec","slug":"AnimationSpec","link":"/tags/AnimationSpec/"}],"categories":[{"name":"Launcher3","slug":"Launcher3","link":"/categories/Launcher3/"},{"name":"Android 14.0","slug":"Launcher3/Android-14-0","link":"/categories/Launcher3/Android-14-0/"},{"name":"Compose","slug":"Compose","link":"/categories/Compose/"},{"name":"åŠ¨ç”»","slug":"Compose/åŠ¨ç”»","link":"/categories/Compose/%E5%8A%A8%E7%94%BB/"},{"name":"Modifier","slug":"Compose/Modifier","link":"/categories/Compose/Modifier/"},{"name":"çŠ¶æ€è®¢é˜… &amp; è‡ªåŠ¨æ›´æ–°","slug":"Compose/çŠ¶æ€è®¢é˜…-è‡ªåŠ¨æ›´æ–°","link":"/categories/Compose/%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/"},{"name":"é™„å¸¦æ•ˆåº”","slug":"Compose/é™„å¸¦æ•ˆåº”","link":"/categories/Compose/%E9%99%84%E5%B8%A6%E6%95%88%E5%BA%94/"},{"name":"æ•°æ®åº“","slug":"æ•°æ®åº“","link":"/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"name":"SQLite","slug":"æ•°æ®åº“/SQLite","link":"/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/SQLite/"}],"pages":[]}