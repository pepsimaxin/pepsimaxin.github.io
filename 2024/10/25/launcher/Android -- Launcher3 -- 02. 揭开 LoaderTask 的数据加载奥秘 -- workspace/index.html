<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>揭开 LoaderTask 的数据加载奥秘 -- Workspace - wikiHow</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="wikiHow"><meta name="msapplication-TileImage" content="/img/wiki.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="wikiHow"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="这是一篇关于..."><meta property="og:type" content="blog"><meta property="og:title" content="揭开 LoaderTask 的数据加载奥秘 -- Workspace"><meta property="og:url" content="http://example.com/2024/10/25/launcher/Android%20--%20Launcher3%20--%2002.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%20--%20workspace/"><meta property="og:site_name" content="wikiHow"><meta property="og:description" content="这是一篇关于..."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/gallery/covers/android/launcher_1.jpg"><meta property="article:published_time" content="2024-10-24T16:00:00.000Z"><meta property="article:modified_time" content="2025-07-20T08:04:23.525Z"><meta property="article:author" content="Marco"><meta property="article:tag" content="Launcher3"><meta property="article:tag" content="Android 14.0"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/gallery/covers/android/launcher_1.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2024/10/25/launcher/Android%20--%20Launcher3%20--%2002.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%20--%20workspace/"},"headline":"揭开 LoaderTask 的数据加载奥秘 -- Workspace","image":["http://example.com/gallery/covers/android/launcher_1.jpg"],"datePublished":"2024-10-24T16:00:00.000Z","dateModified":"2025-07-20T08:04:23.525Z","author":{"@type":"Person","name":"Marco"},"publisher":{"@type":"Organization","name":"wikiHow","logo":{"@type":"ImageObject","url":"http://example.com/img/wikihow.svg"}},"description":"这是一篇关于..."}</script><link rel="canonical" href="http://example.com/2024/10/25/launcher/Android%20--%20Launcher3%20--%2002.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%20--%20workspace/"><link rel="icon" href="/img/wiki.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/wikihow.svg" alt="wikiHow" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/pepsimaxin"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/gallery/covers/android/launcher_1.jpg" alt="揭开 LoaderTask 的数据加载奥秘 -- Workspace"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-10-24T16:00:00.000Z" title="2024/10/25 00:00:00">2024-10-25</time>发表</span><span class="level-item"><time dateTime="2025-07-20T08:04:23.525Z" title="2025/7/20 16:04:23">2025-07-20</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Launcher3/">Launcher3</a><span> / </span><a class="link-muted" href="/categories/Launcher3/Android-14-0/">Android 14.0</a></span></div></div><h1 class="title is-3 is-size-4-mobile">揭开 LoaderTask 的数据加载奥秘 -- Workspace</h1><div class="content"><hr>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们先大概了解本篇文章涉及到的几个重要的类：</p>
<table>
<thead>
<tr>
<th align="left">核心类</th>
<th align="left">路径</th>
</tr>
</thead>
<tbody><tr>
<td align="left">LauncherModel</td>
<td align="left">Launcher 数据处理核心类</td>
</tr>
<tr>
<td align="left">LoaderTask</td>
<td align="left">主要任务负责加载数据（workspace、all apps）和绑定数据（workspace、all apps）</td>
</tr>
<tr>
<td align="left">AutoInstallsLayout</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">InvariantDeviceProfile</td>
<td align="left">桌面的一些配置，比如默认布局文件</td>
</tr>
<tr>
<td align="left">BgDataModel</td>
<td align="left">用来放布局相关的集合</td>
</tr>
<tr>
<td align="left">WorkspaceItemInfo<br>FolderInfo<br>LauncherAppWidgetInfo</td>
<td align="left">都是继承自 ItemInfo，保存桌面图标的一些信息：图标位置，宽高，类型等信息</td>
</tr>
</tbody></table>
<hr>
<article class="message is-info"><div class="message-header">
<p>Step1: Workspace</p>
</div><div class="message-body">
<p>Workspace 的工作主要分为：<font color="#085DFF">「加载」</font>和<font color="#FF8C00">「绑定」</font>，我们一个个来分析。</p>
</div></article>

<h1 id="加载-Workspace-流程解析"><a href="#加载-Workspace-流程解析" class="headerlink" title="加载 Workspace 流程解析"></a>加载 Workspace 流程解析</h1><p>核心方法：<font color="#085DFF">loadWorkspace()</font> 负责加载 Workspace，它主要做 2 件事情：</p>
<ul>
<li>获取数据库</li>
<li>从数据库读取信息存放到 sBgDataModel 中</li>
</ul>
<p>你先有个概念，然后我们开始分析源码，代码走起～</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * run() -&gt; loadWorkspace(allShortcuts, &quot;&quot;, memoryLogger);</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *     1. allDeepShortcuts: 存储应用快捷方式的列表，默认是空的</span></span><br><span class="line"><span class="comment">     *     2. selection: 可以指定选择条件，用于过滤，默认是没有传入任何条件的</span></span><br><span class="line"><span class="comment">     *     3. memoryLogger: 是一个 LoaderMemoryLogger，是一个辅助记录器，用于捕获记录</span></span><br><span class="line"><span class="comment">     *        LoaderTask 的 run() 方法执行过程中可能产生的异常及内存使用情况</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">loadWorkspace</span><span class="params">(</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts,</span></span><br><span class="line"><span class="params">            String selection,</span></span><br><span class="line"><span class="params">            LoaderMemoryLogger memoryLogger)</span> &#123;</span><br><span class="line">        <span class="comment">// 开始性能追踪，用于性能调试和监控</span></span><br><span class="line">        Trace.beginSection(<span class="string">&quot;LoadWorkspace&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/***********************************</span></span><br><span class="line"><span class="comment">             * 核心方法：负责加载工作区内容的主要逻辑</span></span><br><span class="line"><span class="comment">             ***********************************/</span></span><br><span class="line">            loadWorkspaceImpl(allDeepShortcuts, selection, memoryLogger);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 结束性能跟踪</span></span><br><span class="line">            Trace.endSection();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录工作区加载过程的日志，用于性能分析或调试</span></span><br><span class="line">        logASplit(<span class="string">&quot;loadWorkspace&quot;</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) &#123;</span><br><span class="line">            <span class="comment">// 确保 Loader 加载过程没有被中止</span></span><br><span class="line">            verifyNotStopped();</span><br><span class="line">            <span class="comment">// 使用 ModelDelegate 加载并绑定工作区项（Workspace Items）</span></span><br><span class="line">            mModelDelegate.loadAndBindWorkspaceItems(mUserManagerState,</span><br><span class="line">                    mLauncherBinder.mCallbacksList, mShortcutKeyToPinnedShortcuts);</span><br><span class="line">            <span class="comment">// 标记 ModelDelegate 为活动状态，表示它已成功加载并绑定工作区项。</span></span><br><span class="line">            mModelDelegate.markActive();</span><br><span class="line">            logASplit(<span class="string">&quot;workspaceDelegateItems&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们继续跟踪 <font color="#085DFF">loadWorkspaceImpl()</font> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> LauncherAppState mApp;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * run() -&gt; loadWorkspace(allShortcuts, &quot;&quot;, memoryLogger);</span></span><br><span class="line"><span class="comment">     *       -&gt; loadWorkspaceImpl(allDeepShortcuts, selection, memoryLogger);</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *     1. allDeepShortcuts: 存储应用快捷方式的列表，默认是空的</span></span><br><span class="line"><span class="comment">     *     2. selection: 可以指定选择条件，用于过滤，默认是没有传入任何条件的</span></span><br><span class="line"><span class="comment">     *     3. memoryLogger: 是一个 LoaderMemoryLogger，是一个辅助记录器，用于捕获记录</span></span><br><span class="line"><span class="comment">     *        LoaderTask 的 run() 方法执行过程中可能产生的异常及内存使用情况</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadWorkspaceImpl</span><span class="params">(</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts,</span></span><br><span class="line"><span class="params">            String selection,</span></span><br><span class="line"><span class="params">            <span class="meta">@Nullable</span> LoaderMemoryLogger memoryLogger)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mApp 就是：LauncherAppState，它会持有应用的 Context 对象，使得应用的各个部分</span></span><br><span class="line">        <span class="comment">// 能够访问全局的 Context，从而进行资源访问、启动服务、广播等操作</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> mApp.getContext();</span><br><span class="line">        <span class="comment">// 后续用于查询、插入、删除或更新数据</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ContentResolver</span> <span class="variable">contentResolver</span> <span class="operator">=</span> context.getContentResolver();</span><br><span class="line">        <span class="comment">// 自定义的包管理的辅助类</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">PackageManagerHelper</span> <span class="variable">pmHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageManagerHelper</span>(context);</span><br><span class="line">        <span class="comment">// 检查设备是否处于安全模式</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isSafeMode</span> <span class="operator">=</span> pmHelper.isSafeMode();</span><br><span class="line">        <span class="comment">// 检查设备的启动是否已完成，通常这意味着 SD 卡已经挂载并可以访问</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isSdCardReady</span> <span class="operator">=</span> Utilities.isBootCompleted();</span><br><span class="line">        <span class="comment">// 用于管理桌面小部件的帮助类</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">WidgetManagerHelper</span> <span class="variable">widgetHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WidgetManagerHelper</span>(context);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 设定了一个清除数据库的标志位</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">clearDb</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 检查是否需要进行数据库迁移。如果迁移失败，则清理整个数据库，这通常发生在数据模型发生较大变更时</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  mApp.getModel()                        -&gt; LauncherModel</span></span><br><span class="line"><span class="comment">         *  mApp.getModel().getModelDbController() -&gt; ModelDbController</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 一般是无需迁移的，这边默认为 true，所以不会走此分支，clearDb 仍为 false</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!mApp.getModel().getModelDbController().migrateGridIfNeeded()) &#123;</span><br><span class="line">            <span class="comment">// Migration failed. Clear workspace.</span></span><br><span class="line">            <span class="comment">// 迁移失败</span></span><br><span class="line">            clearDb = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 重置数据库</span></span><br><span class="line">        <span class="keyword">if</span> (clearDb) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;loadWorkspace: resetting launcher database&quot;</span>);</span><br><span class="line">            Settings.call(contentResolver, Settings.METHOD_CREATE_EMPTY_DB);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        Log.d(TAG, <span class="string">&quot;loadWorkspace: loading default favorites&quot;</span>);</span><br><span class="line">        <span class="comment">/*********************************************************************</span></span><br><span class="line"><span class="comment">         *  核心关注点 1：加载默认桌面布局</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  会调用到 LauncherProvider 的 loadDefaultFavoritesIfNecessary() 方法，</span></span><br><span class="line"><span class="comment">         *  这个方法来判断是否需要加载默认的布局，如果清除了桌面数据</span></span><br><span class="line"><span class="comment">         *  或者手机恢复了出厂设置，就会加载默认的布局</span></span><br><span class="line"><span class="comment">         ********************************************************************/</span></span><br><span class="line">        Settings.call(contentResolver, Settings.METHOD_LOAD_DEFAULT_FAVORITES);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 加载数据库（我们放在后面分析）</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="加载默认桌面布局"><a href="#加载默认桌面布局" class="headerlink" title="加载默认桌面布局"></a>加载默认桌面布局</h2><p><code>Settings.call()</code> 是 <code>LauncherSettings</code> 内部的静态方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/LauncherSettings.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LauncherSettings</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Launcher settings</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Settings</span> &#123;</span><br><span class="line">        <span class="comment">// CONTENT_URI 是一个 Uri 对象，表示内容提供者的 URI 地址，这是与 LauncherProvider 交互的入口点</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Uri</span> <span class="variable">CONTENT_URI</span> <span class="operator">=</span> Uri.parse(<span class="string">&quot;content://&quot;</span> +</span><br><span class="line">                LauncherProvider.AUTHORITY + <span class="string">&quot;/settings&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">METHOD_LOAD_DEFAULT_FAVORITES</span> <span class="operator">=</span> <span class="string">&quot;load_default_favorites&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Bundle <span class="title function_">call</span><span class="params">(ContentResolver cr, String method)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> call(cr, method, <span class="literal">null</span> <span class="comment">/* arg */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Bundle <span class="title function_">call</span><span class="params">(ContentResolver cr, String method, String arg)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> cr.call(CONTENT_URI, method, arg, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>紧接着进入 <code>LauncherProvider.call()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/LauncherProvider.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LauncherProvider</span> <span class="keyword">extends</span> <span class="title class_">ContentProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * method: &quot;load_default_favorites&quot;</span></span><br><span class="line"><span class="comment">     * arg.  : null</span></span><br><span class="line"><span class="comment">     * extras: null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Bundle <span class="title function_">call</span><span class="params">(String method, <span class="keyword">final</span> String arg, <span class="keyword">final</span> Bundle extras)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Settings.METHOD_LOAD_DEFAULT_FAVORITES: &#123;</span><br><span class="line">                getModelDbController().loadDefaultFavoritesIfNecessary();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟踪 <code>loadDefaultFavoritesIfNecessary()</code> 代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/ModelDbController.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModelDbController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Loads the default workspace based on the following priority scheme:</span></span><br><span class="line"><span class="comment">     *   1) From the app restrictions</span></span><br><span class="line"><span class="comment">     *   2) From a package provided by play store</span></span><br><span class="line"><span class="comment">     *   3) From a partner configuration APK, already in the system image</span></span><br><span class="line"><span class="comment">     *   4) The default configuration for the particular device</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   1) 来自应用限制</span></span><br><span class="line"><span class="comment">     *   2) 来自 Play 商店提供的软件包</span></span><br><span class="line"><span class="comment">     *   3) 来自已集成在 image 中的合作伙伴配置的 APK</span></span><br><span class="line"><span class="comment">     *   4) 特定设备的默认配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@WorkerThread</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">loadDefaultFavoritesIfNecessary</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 确保数据库已创建。如果数据库不存在，则会创建一个新的数据库文件</span></span><br><span class="line">        createDbIfNotExists();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查是否创建了空数据库，如果清除了 Launcher 数据，则会为 true</span></span><br><span class="line">        <span class="keyword">if</span> (LauncherPrefs.get(mContext).get(getEmptyDbCreatedKey(mOpenHelper.getDatabaseName()))) &#123;</span><br><span class="line">            <span class="comment">// LauncherWidgetHolder 是一个用于管理小部件的容器，在加载布局时用来保存和处理小部件信息</span></span><br><span class="line">            <span class="type">LauncherWidgetHolder</span> <span class="variable">widgetHolder</span> <span class="operator">=</span> mOpenHelper.newLauncherWidgetHolder();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1. 尝试从系统配置的 launcher3.layout.provider 提供的 provider 里面获取布局资源</span></span><br><span class="line">                <span class="type">AutoInstallsLayout</span> <span class="variable">loader</span> <span class="operator">=</span> createWorkspaceLoaderFromAppRestriction(widgetHolder);</span><br><span class="line">                <span class="keyword">if</span> (loader == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 2. 尝试从带有</span></span><br><span class="line"><span class="comment">                     *    android.autoinstalls.config.action.PLAY_AUTO_INSTALL 的 apk 里面</span></span><br><span class="line"><span class="comment">                     *    获取布局资源</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    loader = AutoInstallsLayout.get(mContext, widgetHolder, mOpenHelper);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (loader == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 3. 尝试从系统内置的 Partner 应用里获取 workspace 默认配置</span></span><br><span class="line"><span class="comment">                     *    这个功能是提供给提供布局的第三方应用</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">Partner</span> <span class="variable">partner</span> <span class="operator">=</span> Partner.get(mContext.getPackageManager());</span><br><span class="line">                    <span class="keyword">if</span> (partner != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">workspaceResId</span> <span class="operator">=</span> partner.getXmlResId(RES_PARTNER_DEFAULT_LAYOUT);</span><br><span class="line">                        <span class="keyword">if</span> (workspaceResId != <span class="number">0</span>) &#123;</span><br><span class="line">                            loader = <span class="keyword">new</span> <span class="title class_">DefaultLayoutParser</span>(mContext, widgetHolder,</span><br><span class="line">                                    mOpenHelper, partner.getResources(), workspaceResId);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 确定是否使用了外部提供的布局</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">usingExternallyProvidedLayout</span> <span class="operator">=</span> loader != <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (loader == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 4. 尝试获取 Launcher 里的默认资源，比如 @xml/default_workspace_5x5</span></span><br><span class="line">                    loader = getDefaultLayoutParser(widgetHolder);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// There might be some partially restored DB items, due to buggy restore logic in</span></span><br><span class="line">                <span class="comment">// previous versions of launcher.</span></span><br><span class="line">                <span class="comment">// 清空数据库</span></span><br><span class="line">                mOpenHelper.createEmptyDB(mOpenHelper.getWritableDatabase());</span><br><span class="line">                <span class="comment">// Populate favorites table with initial favorites</span></span><br><span class="line">                <span class="comment">// 解析布局文件并写入数据库</span></span><br><span class="line">                <span class="comment">// 首先使用上面得到的 loader 获取，如果该 loader 提供的方式里面为空的布局，</span></span><br><span class="line">                <span class="comment">// 那么还是使用上面第 4 步的 loader</span></span><br><span class="line">                <span class="keyword">if</span> ((mOpenHelper.loadFavorites(mOpenHelper.getWritableDatabase(), loader) &lt;= <span class="number">0</span>)</span><br><span class="line">                        &amp;&amp; usingExternallyProvidedLayout) &#123;</span><br><span class="line">                    <span class="comment">// Unable to load external layout. Cleanup and load the internal layout.</span></span><br><span class="line">                    mOpenHelper.createEmptyDB(mOpenHelper.getWritableDatabase());</span><br><span class="line">                    mOpenHelper.loadFavorites(mOpenHelper.getWritableDatabase(),</span><br><span class="line">                            getDefaultLayoutParser(widgetHolder));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 清理空数据库创建的标志，表示数据库已经准备好了。</span></span><br><span class="line">                clearFlagEmptyDbCreated();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 无论方法是否成功执行，都销毁 widgetHolder 实例，释放相关资源</span></span><br><span class="line">                widgetHolder.destroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看下第 4 步加载 Launcher 默认的布局资源相关逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/ModelDbController.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModelDbController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultLayoutParser <span class="title function_">getDefaultLayoutParser</span><span class="params">(LauncherWidgetHolder widgetHolder)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取 InvariantDeviceProfile 实例，它代表了设备的配置文件，包含布局相关的设置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">InvariantDeviceProfile</span> <span class="variable">idp</span> <span class="operator">=</span> LauncherAppState.getIDP(mContext);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取默认布局资源id，比如：<span class="doctag">@xml</span>/default_workspace_5x5</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * demoModeLayoutId：是否为演示模式</span></span><br><span class="line"><span class="comment">         *     1. 如果是则调用演示模式的布局 id -&gt; idp.demoModeLayoutId</span></span><br><span class="line"><span class="comment">         *     2. 如不是则调用内部默认的布局 id -&gt; idp.defaultLayoutId -&gt; 我们只需要关心这个</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">defaultLayout</span> <span class="operator">=</span> idp.demoModeLayoutId != <span class="number">0</span></span><br><span class="line">                &amp;&amp; mContext.getSystemService(UserManager.class).isDemoUser()</span><br><span class="line">                ? idp.demoModeLayoutId : idp.defaultLayoutId;</span><br><span class="line">                </span><br><span class="line">        <span class="comment">// 创建 DefaultLayoutParser 实例</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultLayoutParser</span>(mContext, widgetHolder,</span><br><span class="line">                mOpenHelper, mContext.getResources(), defaultLayout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要想弄清楚 <font color="#FF8C00">idp.defaultLayoutId</font> 是哪个布局，我们得先来看 <font color="#085DFF">LauncherAppState.getIDP()</font> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/LauncherAppState.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LauncherAppState</span> <span class="keyword">implements</span> <span class="title class_">SafeCloseable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> InvariantDeviceProfile <span class="title function_">getIDP</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取 InvariantDeviceProfile 单例</span></span><br><span class="line">        <span class="keyword">return</span> InvariantDeviceProfile.INSTANCE.get(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟踪源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvariantDeviceProfile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">InvariantDeviceProfile</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取当前的网格名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">gridName</span> <span class="operator">=</span> getCurrentGridName(context);</span><br><span class="line">        <span class="comment">// 初始化网格，可能会返回新的网格名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">newGridName</span> <span class="operator">=</span> initGrid(context, gridName);</span><br><span class="line">        <span class="keyword">if</span> (!newGridName.equals(gridName)) &#123;</span><br><span class="line">            <span class="comment">// 如果新的网格名称与当前网格名称不同，则更新 LauncherPrefs 中的网格名称</span></span><br><span class="line">            LauncherPrefs.get(context).put(GRID_NAME, newGridName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 当用户解锁时执行指定的操作</span></span><br><span class="line">        LockedUserState.get(context).runOnUserUnlocked(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 创建一个 DeviceGridState 实例并调用 writeToPrefs(context)，</span></span><br><span class="line">            <span class="comment">// 将设备网格状态写入偏好设置</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DeviceGridState</span>(<span class="built_in">this</span>).writeToPrefs(context);</span><br><span class="line">        &#125;);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 设置一个监听器来处理设备显示配置的更改</span></span><br><span class="line">        DisplayController.INSTANCE.get(context).setPriorityListener(</span><br><span class="line">                (displayContext, info, flags) -&gt; &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 监听器的回调方法检查标志 flags 是否包含配置更改的</span></span><br><span class="line"><span class="comment">                     * 相关标志（如密度、支持的边界、导航模式等）</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span> ((flags &amp; (CHANGE_DENSITY | CHANGE_SUPPORTED_BOUNDS</span><br><span class="line">                            | CHANGE_NAVIGATION_MODE)) != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 如果有变化，调用 onConfigChanged() 方法处理这些变化</span></span><br><span class="line">                        onConfigChanged(displayContext);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们关注 <font color="#085DFF">initGrid()</font> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvariantDeviceProfile</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">initGrid</span><span class="params">(Context context, String gridName)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取当前设备的显示信息</span></span><br><span class="line">        <span class="type">Info</span> <span class="variable">displayInfo</span> <span class="operator">=</span> DisplayController.INSTANCE.get(context).getInfo();</span><br><span class="line">        <span class="comment">// 根据显示信息确定设备类型（如手机、平板等）</span></span><br><span class="line">        <span class="meta">@DeviceType</span> <span class="type">int</span> <span class="variable">deviceType</span> <span class="operator">=</span> getDeviceType(displayInfo);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 根据上下文、网格名称、设备类型和数据库恢复任务的状态，获取所有预定义的显示选项</span></span><br><span class="line">        ArrayList&lt;DisplayOption&gt; allOptions =</span><br><span class="line">                getPredefinedDeviceProfiles(context, gridName, deviceType,</span><br><span class="line">                        RestoreDbTask.isPending(context));</span><br><span class="line">        <span class="comment">// 使用加权插值方法从所有预定义的显示选项中选择一个合适的选项，</span></span><br><span class="line">        <span class="comment">// 此方法考虑设备的显示信息和设备类型来做出选择。</span></span><br><span class="line">        <span class="type">DisplayOption</span> <span class="variable">displayOption</span> <span class="operator">=</span></span><br><span class="line">                invDistWeightedInterpolate(displayInfo, allOptions, deviceType);</span><br><span class="line">        <span class="comment">// 使用选定的显示选项初始化网格，这个方法可能会设置设备的显示网格以适应所选的显示选项</span></span><br><span class="line">        initGrid(context, displayInfo, displayOption, deviceType);</span><br><span class="line">        <span class="comment">// 返回所选显示选项的网格名称</span></span><br><span class="line">        <span class="keyword">return</span> displayOption.grid.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在重点就来到了 <font color="#085DFF">getPredefinedDeviceProfiles()</font> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvariantDeviceProfile</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;DisplayOption&gt; <span class="title function_">getPredefinedDeviceProfiles</span><span class="params">(Context context,</span></span><br><span class="line"><span class="params">            String gridName, <span class="meta">@DeviceType</span> <span class="type">int</span> deviceType, <span class="type">boolean</span> allowDisabledGrid)</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化一个空的 DisplayOption 列表，profiles 用于存储从 XML 解析出的所有显示配置文件</span></span><br><span class="line">        ArrayList&lt;DisplayOption&gt; profiles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 开始解析 XML       -&gt; 解析哪个 XML ？</span></span><br><span class="line"><span class="comment">         * 熟悉的 XML 文件来了 -&gt; device_profiles.xml</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 使用 XmlResourceParser 解析 R.xml.device_profiles 资源文件，</span></span><br><span class="line"><span class="comment">         * 该文件包含所有预定义的设备配置文件</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">XmlResourceParser</span> <span class="variable">parser</span> <span class="operator">=</span> context.getResources().getXml(R.xml.device_profiles)) &#123;</span><br><span class="line">            <span class="comment">// 获取当前 XML 标签的深度，用于确定解析结束的条件</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">depth</span> <span class="operator">=</span> parser.getDepth();</span><br><span class="line">            <span class="type">int</span> type;</span><br><span class="line">            <span class="comment">// 循环解析 XML 文件，直到遇到 END_TAG（标签结束）或文档结束</span></span><br><span class="line">            <span class="keyword">while</span> (((type = parser.next()) != XmlPullParser.END_TAG ||</span><br><span class="line">                    parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 看 if 判断里面的 GridOption.TAG_NAME -&gt; &quot;grid-option&quot; -&gt; 是不是很熟悉 ？</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * 插播一点 device_profiles.xml 的内容</span></span><br><span class="line"><span class="comment">                 * &lt;grid-option</span></span><br><span class="line"><span class="comment">                 *     launcher:name=&quot;4_by_6&quot;</span></span><br><span class="line"><span class="comment">                 *     launcher:numRows=&quot;6&quot;</span></span><br><span class="line"><span class="comment">                 *     launcher:defaultLayoutId=&quot;<span class="doctag">@xml</span>/default_workspace_4x6&quot;</span></span><br><span class="line"><span class="comment">                 *     launcher:deviceCategory=&quot;phone|multi_display&quot;</span></span><br><span class="line"><span class="comment">                 *     ... /&gt;</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 *     &lt;display-option</span></span><br><span class="line"><span class="comment">                 *         launcher:name=&quot;Large Phone&quot;</span></span><br><span class="line"><span class="comment">                 *         ... /&gt;</span></span><br><span class="line"><span class="comment">                 * &lt;/grid-option&gt;</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> ((type == XmlPullParser.START_TAG)</span><br><span class="line">                        &amp;&amp; GridOption.TAG_NAME.equals(parser.getName())) &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * 当遇到 &quot;grid-option&quot; 对应标签，创建一个 GridOption 实例</span></span><br><span class="line"><span class="comment">                     *</span></span><br><span class="line"><span class="comment">                     * GridOption 的源码我们一会就要跟，这里先注意一下！！！</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="type">GridOption</span> <span class="variable">gridOption</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GridOption</span>(context, Xml.asAttributeSet(parser));</span><br><span class="line">                    <span class="comment">// 检查 GridOption 是否启用，或根据 allowDisabledGrid 参数决定是否处理禁用的网格选项</span></span><br><span class="line">                    <span class="keyword">if</span> (gridOption.isEnabled(deviceType) || allowDisabledGrid) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">displayDepth</span> <span class="operator">=</span> parser.getDepth();</span><br><span class="line">                        <span class="keyword">while</span> (((type = parser.next()) != XmlPullParser.END_TAG</span><br><span class="line">                                || parser.getDepth() &gt; displayDepth)</span><br><span class="line">                                &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                            <span class="comment">// 如果满足条件，继续解析这个网格选项下的 display-option 标签</span></span><br><span class="line">                            <span class="keyword">if</span> ((type == XmlPullParser.START_TAG) &amp;&amp; <span class="string">&quot;display-option&quot;</span>.equals(</span><br><span class="line">                                    parser.getName())) &#123;</span><br><span class="line">                                <span class="comment">// 将其添加到 profiles 列表中</span></span><br><span class="line">                                profiles.add(<span class="keyword">new</span> <span class="title class_">DisplayOption</span>(gridOption, context,</span><br><span class="line">                                        Xml.asAttributeSet(parser)));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | XmlPullParserException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">// 创建一个空的 filteredProfiles 列表，用于存储符合条件的 DisplayOption</span></span><br><span class="line">        ArrayList&lt;DisplayOption&gt; filteredProfiles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 如果提供了 gridName，则遍历 profiles 列表，找到与 gridName 匹配且启用的选项，</span></span><br><span class="line"><span class="comment">         * 将其添加到 filteredProfiles 列表中</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 我的设备测试 Log：</span></span><br><span class="line"><span class="comment">         * [ @@@ Pepsimarco ] 日志输出：===&gt; gridName = 5_by_5</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(gridName)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (DisplayOption option : profiles) &#123;</span><br><span class="line">                <span class="keyword">if</span> (gridName.equals(option.grid.name)</span><br><span class="line">                        &amp;&amp; (option.grid.isEnabled(deviceType) || allowDisabledGrid)) &#123;</span><br><span class="line">                    filteredProfiles.add(option);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果 filteredProfiles 为空（即没有匹配到合适的显示选项）</span></span><br><span class="line">        <span class="keyword">if</span> (filteredProfiles.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// No grid found, use the default options</span></span><br><span class="line">            <span class="comment">// 则从 profiles 列表中选择可以作为默认选项 (canBeDefault) 的显示选项</span></span><br><span class="line">            <span class="keyword">for</span> (DisplayOption option : profiles) &#123;</span><br><span class="line">                <span class="keyword">if</span> (option.canBeDefault) &#123;</span><br><span class="line">                    filteredProfiles.add(option);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (filteredProfiles.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;No display option with canBeDefault=true&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回 filteredProfiles，即符合条件的显示选项列表</span></span><br><span class="line">        <span class="keyword">return</span> filteredProfiles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，对于 <font color="#008B45">device_profiles.xml</font> 的解析，我们已经完全掌握了，还记得我们前面还遗漏的 <font color="#FF8C00">GridOption</font> 吗？</p>
<p>我们来跟源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvariantDeviceProfile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">GridOption</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * GridOption 主要功能：</span></span><br><span class="line"><span class="comment">         *   1. 从传入的 AttributeSet 中获取并解析与网格布局相关的属性；</span></span><br><span class="line"><span class="comment">         *   2. 初始化 GridOption 类的成员变量，以便后续使用这些配置参数来设置或调整应用程序的显示布局。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">GridOption</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">            <span class="type">TypedArray</span> <span class="variable">a</span> <span class="operator">=</span> context.obtainStyledAttributes(</span><br><span class="line">                    attrs, R.styleable.GridDisplayOption);</span><br><span class="line">            <span class="comment">// 网格布局的名称</span></span><br><span class="line">            name = a.getString(R.styleable.GridDisplayOption_name);</span><br><span class="line">            <span class="comment">// 网格的行数</span></span><br><span class="line">            numRows = a.getInt(R.styleable.GridDisplayOption_numRows, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 网格的列数</span></span><br><span class="line">            numColumns = a.getInt(R.styleable.GridDisplayOption_numColumns, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 搜索容器的列数，如果未指定，则默认与 numColumns 一致</span></span><br><span class="line">            numSearchContainerColumns = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numSearchContainerColumns, numColumns);</span><br><span class="line">            <span class="comment">// 数据库文件的名称</span></span><br><span class="line">            dbFile = a.getString(R.styleable.GridDisplayOption_dbFile);</span><br><span class="line">            <span class="comment">// 默认布局资源 ID</span></span><br><span class="line">            defaultLayoutId = a.getResourceId(</span><br><span class="line">                    R.styleable.GridDisplayOption_defaultLayoutId, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 演示模式下的布局资源 ID，如果未指定，则使用 defaultLayoutId</span></span><br><span class="line">            demoModeLayoutId = a.getResourceId(</span><br><span class="line">                    R.styleable.GridDisplayOption_demoModeLayoutId, defaultLayoutId);</span><br><span class="line">            <span class="comment">// 抽屉的样式资源 ID</span></span><br><span class="line">            allAppsStyle = a.getResourceId(R.styleable.GridDisplayOption_allAppsStyle,</span><br><span class="line">                    R.style.AllAppsStyleDefault);</span><br><span class="line">            <span class="comment">// 抽屉中的列数</span></span><br><span class="line">            numAllAppsColumns = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numAllAppsColumns, numColumns);</span><br><span class="line">            <span class="comment">// 数据库中应用程序抽屉的扩展列数，默认为 numAllAppsColumns 的两倍</span></span><br><span class="line">            numDatabaseAllAppsColumns = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numExtendedAllAppsColumns, <span class="number">2</span> * numAllAppsColumns);</span><br><span class="line">            <span class="comment">// HotSeat 图标数量</span></span><br><span class="line">            numHotseatIcons = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numHotseatIcons, numColumns);</span><br><span class="line">            <span class="comment">// 数据库中 Hotseat 的扩展图标数量，默认为 numHotseatIcons 的两倍</span></span><br><span class="line">            numDatabaseHotseatIcons = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numExtendedHotseatIcons, <span class="number">2</span> * numHotseatIcons);</span><br><span class="line">            <span class="comment">// Hotseat 在不同屏幕方向和模式下的列跨度</span></span><br><span class="line">            hotseatColumnSpan[INDEX_DEFAULT] = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_hotseatColumnSpan, numColumns);</span><br><span class="line">            hotseatColumnSpan[INDEX_LANDSCAPE] = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_hotseatColumnSpanLandscape, numColumns);</span><br><span class="line">            hotseatColumnSpan[INDEX_TWO_PANEL_LANDSCAPE] = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_hotseatColumnSpanTwoPanelLandscape,</span><br><span class="line">                    numColumns);</span><br><span class="line">            hotseatColumnSpan[INDEX_TWO_PANEL_PORTRAIT] = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_hotseatColumnSpanTwoPanelPortrait,</span><br><span class="line">                    numColumns);</span><br><span class="line">            <span class="comment">// 导航按钮 End 间距资源 ID</span></span><br><span class="line">            inlineNavButtonsEndSpacing =</span><br><span class="line">                    a.getResourceId(R.styleable.GridDisplayOption_inlineNavButtonsEndSpacing,</span><br><span class="line">                            R.dimen.taskbar_button_margin_default);</span><br><span class="line">            <span class="comment">// 文件夹内的行数</span></span><br><span class="line">            numFolderRows = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numFolderRows, numRows);</span><br><span class="line">            <span class="comment">// 文件夹内的列数</span></span><br><span class="line">            numFolderColumns = a.getInt(</span><br><span class="line">                    R.styleable.GridDisplayOption_numFolderColumns, numColumns);</span><br><span class="line">            <span class="comment">// 文件夹的样式资源 ID</span></span><br><span class="line">            folderStyle = a.getResourceId(R.styleable.GridDisplayOption_folderStyle,</span><br><span class="line">                    INVALID_RESOURCE_HANDLE);</span><br><span class="line">            <span class="comment">// 单元格的样式资源 ID</span></span><br><span class="line">            cellStyle = a.getResourceId(R.styleable.GridDisplayOption_cellStyle,</span><br><span class="line">                    R.style.CellStyleDefault);</span><br><span class="line">            <span class="comment">// 网格是否可以缩放</span></span><br><span class="line">            isScalable = a.getBoolean(</span><br><span class="line">                    R.styleable.GridDisplayOption_isScalable, <span class="literal">false</span>);</span><br><span class="line">            <span class="comment">// 设备填充的资源 ID</span></span><br><span class="line">            devicePaddingId = a.getResourceId(</span><br><span class="line">                    R.styleable.GridDisplayOption_devicePaddingId, INVALID_RESOURCE_HANDLE);</span><br><span class="line">            <span class="comment">// 设备类别</span></span><br><span class="line">            deviceCategory = a.getInt(R.styleable.GridDisplayOption_deviceCategory,</span><br><span class="line">                    DEVICE_CATEGORY_ALL);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 工作区规格的资源 ID</span></span><br><span class="line">            <span class="keyword">if</span> (FeatureFlags.ENABLE_RESPONSIVE_WORKSPACE.get()) &#123;</span><br><span class="line">                mWorkspaceSpecsId = a.getResourceId(</span><br><span class="line">                        R.styleable.GridDisplayOption_workspaceSpecsId, INVALID_RESOURCE_HANDLE);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mWorkspaceSpecsId = INVALID_RESOURCE_HANDLE;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 搜索栏在不同屏幕方向和模式下是否内联</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">inlineForRotation</span> <span class="operator">=</span> a.getInt(R.styleable.GridDisplayOption_inlineQsb,</span><br><span class="line">                    DONT_INLINE_QSB);</span><br><span class="line">            inlineQsb[INDEX_DEFAULT] =</span><br><span class="line">                    (inlineForRotation &amp; INLINE_QSB_FOR_PORTRAIT) == INLINE_QSB_FOR_PORTRAIT;</span><br><span class="line">            inlineQsb[INDEX_LANDSCAPE] =</span><br><span class="line">                    (inlineForRotation &amp; INLINE_QSB_FOR_LANDSCAPE) == INLINE_QSB_FOR_LANDSCAPE;</span><br><span class="line">            inlineQsb[INDEX_TWO_PANEL_PORTRAIT] =</span><br><span class="line">                    (inlineForRotation &amp; INLINE_QSB_FOR_TWO_PANEL_PORTRAIT)</span><br><span class="line">                            == INLINE_QSB_FOR_TWO_PANEL_PORTRAIT;</span><br><span class="line">            inlineQsb[INDEX_TWO_PANEL_LANDSCAPE] =</span><br><span class="line">                    (inlineForRotation &amp; INLINE_QSB_FOR_TWO_PANEL_LANDSCAPE)</span><br><span class="line">                            == INLINE_QSB_FOR_TWO_PANEL_LANDSCAPE;</span><br><span class="line">            <span class="comment">// 释放 TypedArray，以避免内存泄漏</span></span><br><span class="line">            a.recycle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，我们再来看 <font color="#085DFF">idp.defaultLayoutId</font>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvariantDeviceProfile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> defaultLayoutId;    <span class="comment">// 这个默认布局是哪个，你清楚了吗？</span></span><br><span class="line">    </span><br><span class="line">    ==&gt; defaultLayoutId = a.getResourceId(</span><br><span class="line">                R.styleable.GridDisplayOption_defaultLayoutId, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ==&gt; 就看你的 gridName 是哪个，比如我的设备是：5_by_5</span><br><span class="line">    </span><br><span class="line">    ==&gt; </span><br><span class="line">	    &lt;grid-option</span><br><span class="line">	        launcher:name=<span class="string">&quot;5_by_5&quot;</span></span><br><span class="line">	        launcher:numRows=<span class="string">&quot;5&quot;</span></span><br><span class="line">	        launcher:numColumns=<span class="string">&quot;5&quot;</span></span><br><span class="line">	        launcher:numFolderRows=<span class="string">&quot;4&quot;</span></span><br><span class="line">	        launcher:numFolderColumns=<span class="string">&quot;4&quot;</span></span><br><span class="line">	        launcher:numHotseatIcons=<span class="string">&quot;5&quot;</span></span><br><span class="line">	        launcher:numExtendedHotseatIcons=<span class="string">&quot;6&quot;</span></span><br><span class="line">	        launcher:dbFile=<span class="string">&quot;launcher.db&quot;</span></span><br><span class="line">	        launcher:inlineNavButtonsEndSpacing=<span class="string">&quot;@dimen/taskbar_button_margin_split&quot;</span></span><br><span class="line">	        launcher:defaultLayoutId=<span class="string">&quot;@xml/default_workspace_5x5&quot;</span></span><br><span class="line">	        launcher:deviceCategory=<span class="string">&quot;phone|multi_display&quot;</span> &gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>讲到这，我们就完全讲通了 Launcher 何时会解析 <font color="#008B45">device_profiles.xml</font> 文件，并且去找对应的某一个 <font color="#008B45">default_workspace_xxx</font> 了。</p>
<hr>
<h2 id="加载数据库"><a href="#加载数据库" class="headerlink" title="加载数据库"></a>加载数据库</h2><p>分析完默认布局的流程外，我们继续 <code>loadWorkspaceImpl()</code> 中遗留的数据库的加载逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> LauncherAppState mApp;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadWorkspaceImpl</span><span class="params">(</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts,</span></span><br><span class="line"><span class="params">            String selection,</span></span><br><span class="line"><span class="params">            <span class="meta">@Nullable</span> LoaderMemoryLogger memoryLogger)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*********************************************************************</span></span><br><span class="line"><span class="comment">         *  核心 1: 加载默认桌面布局</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  会调用到 LauncherProvider 的 loadDefaultFavoritesIfNecessary() 方法，</span></span><br><span class="line"><span class="comment">         *  这个方法来判断是否需要加载默认的布局，如果清除了桌面数据</span></span><br><span class="line"><span class="comment">         *  或者手机恢复了出厂设置，就会加载默认的布局</span></span><br><span class="line"><span class="comment">         ********************************************************************/</span></span><br><span class="line">        Settings.call(contentResolver, Settings.METHOD_LOAD_DEFAULT_FAVORITES);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/*********************************************************************</span></span><br><span class="line"><span class="comment">         *  核心 2:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  加载数据库</span></span><br><span class="line"><span class="comment">         ********************************************************************/</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mBgDataModel) &#123;</span><br><span class="line">            mBgDataModel.clear();       <span class="comment">// 清除数据模型（内存中的工作区数据）</span></span><br><span class="line">            mPendingPackages.clear();   <span class="comment">// 清除待处理的应用包信息</span></span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 获取当前正在进行的安装会话的列表</span></span><br><span class="line">            <span class="keyword">final</span> HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs =</span><br><span class="line">                    mSessionHelper.getActiveSessions();</span><br><span class="line">            <span class="comment">// 将每个安装会话的信息更新到图标缓存中 (IconCache)，确保 Launcher 能够正确显示应用安装状态</span></span><br><span class="line">            installingPkgs.forEach(mApp.getIconCache()::updateSessionCache);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 用于暂存包名和用户键值的临时对象</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">PackageUserKey</span> <span class="variable">tempPackageKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageUserKey</span>(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 初始化一个广播对象，用于在 Launcher 加载时广播状态信息</span></span><br><span class="line">            mFirstScreenBroadcast = <span class="keyword">new</span> <span class="title class_">FirstScreenBroadcast</span>(installingPkgs);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 存储固定在 Launcher 上的快捷方式信息的映射</span></span><br><span class="line">            mShortcutKeyToPinnedShortcuts = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="type">ModelDbController</span> <span class="variable">dbController</span> <span class="operator">=</span> mApp.getModel().getModelDbController();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/***********************************************</span></span><br><span class="line"><span class="comment">             * 通过 LoaderCursor 查询数据库，获取工作空间的数据项</span></span><br><span class="line"><span class="comment">             ***********************************************/</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">LoaderCursor</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoaderCursor</span>(</span><br><span class="line">                    dbController.query(TABLE_NAME, <span class="literal">null</span>, selection, <span class="literal">null</span>, <span class="literal">null</span>),</span><br><span class="line">                    mApp, mUserManagerState);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">extras</span> <span class="operator">=</span> c.getExtras();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从数据库查询结果的额外信息 (extras) 中获取数据库名称 -&gt; launcher.db</span></span><br><span class="line">            mDbName = extras == <span class="literal">null</span> ? <span class="literal">null</span> : extras.getString(Settings.EXTRA_DB_NAME);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 一个稀疏数组 (LongSparseArray)，用于存储用户的解锁状态</span></span><br><span class="line">                <span class="keyword">final</span> LongSparseArray&lt;Boolean&gt; unlockedUsers = <span class="keyword">new</span> <span class="title class_">LongSparseArray</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">                mUserManagerState.init(mUserCache, mUserManager);</span><br><span class="line">                <span class="comment">// 遍历用户配置文件，对每个用户：</span></span><br><span class="line">                <span class="keyword">for</span> (UserHandle user : mUserCache.getUserProfiles()) &#123;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">serialNo</span> <span class="operator">=</span> mUserCache.getSerialNumberForUser(user);</span><br><span class="line">                    <span class="comment">// 检查用户是否解锁</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">userUnlocked</span> <span class="operator">=</span> mUserManager.isUserUnlocked(user);</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 向 LauncherAppsService 获取 Pinned Shortcuts</span></span><br><span class="line">                    <span class="keyword">if</span> (userUnlocked) &#123;</span><br><span class="line">                        <span class="type">QueryResult</span> <span class="variable">pinnedShortcuts</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShortcutRequest</span>(context, user)</span><br><span class="line">                                .query(ShortcutRequest.PINNED);</span><br><span class="line">                        <span class="keyword">if</span> (pinnedShortcuts.wasSuccess()) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (ShortcutInfo shortcut : pinnedShortcuts) &#123;</span><br><span class="line">                                <span class="comment">// 如果用户解锁，查询固定的快捷方式，</span></span><br><span class="line">                                <span class="comment">// 并将其存储在 mShortcutKeyToPinnedShortcuts 中</span></span><br><span class="line">                                mShortcutKeyToPinnedShortcuts.put(ShortcutKey.fromInfo(shortcut),</span><br><span class="line">                                        shortcut);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// Shortcut manager can fail due to some race condition when the</span></span><br><span class="line">                            <span class="comment">// lock state changes too frequently. For the purpose of the loading</span></span><br><span class="line">                            <span class="comment">// shortcuts, consider the user is still locked.</span></span><br><span class="line">                            userUnlocked = <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 将用户的解锁状态存储在 unlockedUsers 中</span></span><br><span class="line">                    unlockedUsers.put(serialNo, userUnlocked);</span><br><span class="line">                &#125;</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// 一个列表，存储了需要批量加载的图标请求信息</span></span><br><span class="line">                List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 开始遍历数据库，一次读取数据库内容，遍历 LoaderCursor 中的每一行，</span></span><br><span class="line"><span class="comment">                 * 使用 processWorkspaceItem() 方法</span></span><br><span class="line"><span class="comment">                 * 处理每个工作空间项目，包括应用图标、小部件和快捷方式</span></span><br><span class="line"><span class="comment">                 * </span></span><br><span class="line"><span class="comment">                 * 核心方法，下面我们要跟踪！！！</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">while</span> (!mStopped &amp;&amp; c.moveToNext()) &#123;</span><br><span class="line">                    processWorkspaceItem(c, memoryLogger, installingPkgs, isSdCardReady,</span><br><span class="line">                            tempPackageKey, widgetHelper, pmHelper,</span><br><span class="line">                            iconRequestInfos, unlockedUsers, isSafeMode, allDeepShortcuts);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 批量加载工作空间图标，以提高加载性能</span></span><br><span class="line">                tryLoadWorkspaceIconsInBulk(iconRequestInfos);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                IOUtils.closeSilently(c);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (!FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) &#123;</span><br><span class="line">                <span class="comment">// mModelDelegate: 负责将数据绑定到 UI 上的委托对象</span></span><br><span class="line">                <span class="comment">// 加载并绑定 WorkspaceItems</span></span><br><span class="line">                mModelDelegate.loadAndBindWorkspaceItems(mUserManagerState,</span><br><span class="line">                        mLauncherBinder.mCallbacksList, mShortcutKeyToPinnedShortcuts);</span><br><span class="line">                <span class="comment">// 加载并绑定 AllAppsItems</span></span><br><span class="line">                mModelDelegate.loadAndBindAllAppsItems(mUserManagerState,</span><br><span class="line">                        mLauncherBinder.mCallbacksList, mShortcutKeyToPinnedShortcuts);</span><br><span class="line">                <span class="comment">// 加载并绑定 OtherItems</span></span><br><span class="line">                mModelDelegate.loadAndBindOtherItems(mLauncherBinder.mCallbacksList);</span><br><span class="line">                <span class="comment">// 标记加载过程完成，Launcher 可以开始响应用户操作</span></span><br><span class="line">                mModelDelegate.markActive();</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// Break early if we have stopped loading</span></span><br><span class="line">            <span class="keyword">if</span> (mStopped) &#123;</span><br><span class="line">                mBgDataModel.clear();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// Remove dead items，删除 processWorkspaceItem 中标记 delete 的数据</span></span><br><span class="line">            mItemsDeleted = c.commitDeleted();</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// Sort the folder items, update ranks, and make sure all preview items are high res.</span></span><br><span class="line">            <span class="comment">// 文件夹内容的排序和更新</span></span><br><span class="line">            <span class="comment">// FolderGridOrganizer: 用于组织和验证文件夹网格布局</span></span><br><span class="line">            <span class="type">FolderGridOrganizer</span> <span class="variable">verifier</span> <span class="operator">=</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">FolderGridOrganizer</span>(mApp.getInvariantDeviceProfile());</span><br><span class="line">            <span class="comment">// 遍历每一个文件夹</span></span><br><span class="line">            <span class="keyword">for</span> (FolderInfo folder : mBgDataModel.folders) &#123;</span><br><span class="line">                <span class="comment">// 对文件夹内容进行排序</span></span><br><span class="line">                Collections.sort(folder.contents, Folder.ITEM_POS_COMPARATOR);</span><br><span class="line">                verifier.setFolderInfo(folder);</span><br><span class="line">                <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> folder.contents.size();</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// Update ranks here to ensure there are no gaps caused by removed folder items.</span></span><br><span class="line">                <span class="comment">// Ranks are the source of truth for folder items, so cellX and cellY can be ignored</span></span><br><span class="line">                <span class="comment">// for now. Database will be updated once user manually modifies folder.</span></span><br><span class="line">                <span class="comment">// 更新项目的 rank，确保显示顺序正确</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">rank</span> <span class="operator">=</span> <span class="number">0</span>; rank &lt; size; ++rank) &#123;</span><br><span class="line">                    <span class="type">WorkspaceItemInfo</span> <span class="variable">info</span> <span class="operator">=</span> folder.contents.get(rank);</span><br><span class="line">                    info.rank = rank;</span><br><span class="line">                    <span class="comment">// 对于使用低分辨率图标且显示在文件夹预览中的项目，加载高分辨率图标</span></span><br><span class="line">                    <span class="keyword">if</span> (info.usingLowResIcon()</span><br><span class="line">                            &amp;&amp; info.itemType == Favorites.ITEM_TYPE_APPLICATION</span><br><span class="line">                            &amp;&amp; verifier.isItemInPreview(info.rank)) &#123;</span><br><span class="line">                        mIconCache.getTitleAndIcon(info, <span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 最后，将所有处理后的工作区项提交到数据库中</span></span><br><span class="line">            c.commitRestoredItems();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来我们就要开始重点分析 <font color="#085DFF">processWorkspaceItem()</font> 的源码了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理从数据库加载的桌面项目（如快捷方式、文件夹、应用小部件等）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *   c               : 用于读取数据库中存储的桌面项目数据的游标</span></span><br><span class="line"><span class="comment">     *   memoryLogger    : 用于记录内存消耗的日志工具</span></span><br><span class="line"><span class="comment">     *   installingPkgs  : 一个哈希表，用于跟踪正在安装的应用包</span></span><br><span class="line"><span class="comment">     *   isSdCardReady   : 标识 SD 卡是否已准备就绪的标志</span></span><br><span class="line"><span class="comment">     *   tempPackageKey  : 一个临时的 PackageUserKey 对象，用于处理包名和用户信息</span></span><br><span class="line"><span class="comment">     *   widgetHelper    : 用于管理小部件的辅助类</span></span><br><span class="line"><span class="comment">     *   pmHelper        : 用于处理包管理的辅助类</span></span><br><span class="line"><span class="comment">     *   iconRequestInfos: 用于存储要加载图标的请求信息的列表</span></span><br><span class="line"><span class="comment">     *   unlockedUsers   : 用于存储已解锁用户的标识符的稀疏数组</span></span><br><span class="line"><span class="comment">     *   isSafeMode      : 是否处于安全模式的标志</span></span><br><span class="line"><span class="comment">     *   allDeepShortcuts: 用于存储所有深层快捷方式的信息列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processWorkspaceItem</span><span class="params">(LoaderCursor c,</span></span><br><span class="line"><span class="params">            LoaderMemoryLogger memoryLogger,</span></span><br><span class="line"><span class="params">            HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSdCardReady,</span></span><br><span class="line"><span class="params">            PackageUserKey tempPackageKey,</span></span><br><span class="line"><span class="params">            WidgetManagerHelper widgetHelper,</span></span><br><span class="line"><span class="params">            PackageManagerHelper pmHelper,</span></span><br><span class="line"><span class="params">            List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos,</span></span><br><span class="line"><span class="params">            LongSparseArray&lt;Boolean&gt; unlockedUsers,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSafeMode,</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (c.user == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// User has been deleted, remove the item.</span></span><br><span class="line">                <span class="comment">// 首先检查用户是否存在。如果不存在，则标记为删除</span></span><br><span class="line">                c.markDeleted(<span class="string">&quot;User has been deleted&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 用于标记是否允许丢失目标应用的情况</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">allowMissingTarget</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 接下来就是实际的处理逻辑了，开始处理不同类型的桌面项目：</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             *   Favorites.ITEM_TYPE_SHORTCUT     : 处理普通快捷方式</span></span><br><span class="line"><span class="comment">             *   Favorites.ITEM_TYPE_APPLICATION  : 处理应用快捷方式</span></span><br><span class="line"><span class="comment">             *   Favorites.ITEM_TYPE_DEEP_SHORTCUT: 处理深层快捷方式</span></span><br><span class="line"><span class="comment">             *   Favorites.ITEM_TYPE_FOLDER       : 处理文件夹</span></span><br><span class="line"><span class="comment">             *   Favorites.ITEM_TYPE_APPWIDGET    : 处理应用小部件</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">switch</span> (c.itemType) &#123;</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_SHORTCUT:        <span class="comment">// 如果是快捷方式</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPLICATION:     <span class="comment">// 如果是应用程序</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_DEEP_SHORTCUT:   <span class="comment">// 如果是深层快捷方式</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_FOLDER           <span class="comment">// 如果是文件夹</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPWIDGET        <span class="comment">// 如果是应用小部件</span></span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">// 代码太多，我们分类分析</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Desktop items loading interrupted&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="应用-快捷方式"><a href="#应用-快捷方式" class="headerlink" title="应用&#x2F;快捷方式"></a>应用&#x2F;快捷方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processWorkspaceItem</span><span class="params">(LoaderCursor c,</span></span><br><span class="line"><span class="params">            LoaderMemoryLogger memoryLogger,</span></span><br><span class="line"><span class="params">            HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSdCardReady,</span></span><br><span class="line"><span class="params">            PackageUserKey tempPackageKey,</span></span><br><span class="line"><span class="params">            WidgetManagerHelper widgetHelper,</span></span><br><span class="line"><span class="params">            PackageManagerHelper pmHelper,</span></span><br><span class="line"><span class="params">            List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos,</span></span><br><span class="line"><span class="params">            LongSparseArray&lt;Boolean&gt; unlockedUsers,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSafeMode,</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (c.itemType) &#123;</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_SHORTCUT:        <span class="comment">// 如果是快捷方式</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPLICATION:     <span class="comment">// 如果是应用程序</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_DEEP_SHORTCUT:   <span class="comment">// 如果是深层快捷方式</span></span><br><span class="line">                    <span class="comment">// 从 LoaderCursor 中解析 Intent 对象</span></span><br><span class="line">                    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> c.parseIntent();</span><br><span class="line">                    <span class="comment">// 验证 intent 有效性</span></span><br><span class="line">                    <span class="keyword">if</span> (intent == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 如果 Intent 为空或无效，则标记为已删除</span></span><br><span class="line">                        c.markDeleted(<span class="string">&quot;Invalid or null intent&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 根据用户管理器状态判断该用户是否为静默用户</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">disabledState</span> <span class="operator">=</span> mUserManagerState.isUserQuiet(c.serialNumber)</span><br><span class="line">                            ? WorkspaceItemInfo.FLAG_DISABLED_QUIET_USER : <span class="number">0</span>;</span><br><span class="line">                    <span class="comment">// 从 Intent 中获取组件名称</span></span><br><span class="line">                    <span class="type">ComponentName</span> <span class="variable">cn</span> <span class="operator">=</span> intent.getComponent();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">targetPkg</span> <span class="operator">=</span> cn == <span class="literal">null</span> ? intent.getPackage() : cn.getPackageName();</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 如果目标包名为空且项目类型不是快捷方式，则标记为已删除</span></span><br><span class="line">                    <span class="keyword">if</span> (TextUtils.isEmpty(targetPkg)</span><br><span class="line">                            &amp;&amp; c.itemType != Favorites.ITEM_TYPE_SHORTCUT) &#123;</span><br><span class="line">                        c.markDeleted(<span class="string">&quot;Only legacy shortcuts can have null package&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 检查目标包是否有效（如果没有目标包名，则表示这是一个隐式 Intent，始终有效）</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">validTarget</span> <span class="operator">=</span> TextUtils.isEmpty(targetPkg)</span><br><span class="line">                            || mLauncherApps.isPackageEnabled(targetPkg, c.user);</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 如果组件名不为空且目标有效且项目不是深度快捷方式</span></span><br><span class="line">                    <span class="keyword">if</span> (cn != <span class="literal">null</span> &amp;&amp; validTarget &amp;&amp; c.itemType</span><br><span class="line">                            != Favorites.ITEM_TYPE_DEEP_SHORTCUT) &#123;</span><br><span class="line">                        <span class="comment">// If the apk is present and the shortcut points to a specific component.</span></span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// 如果目标活动存在，标记项目为已恢复</span></span><br><span class="line">                        <span class="keyword">if</span> (mLauncherApps.isActivityEnabled(cn, c.user)) &#123;</span><br><span class="line">                            <span class="comment">// no special handling necessary for this item</span></span><br><span class="line">                            c.markRestored();  <span class="comment">// 标记为已恢复</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 否则，尝试找到一个备用的启动活动</span></span><br><span class="line">                            intent = pmHelper.getAppLaunchIntent(targetPkg, c.user);</span><br><span class="line">                            <span class="comment">// 如果找到了启动活动，更新 Intent 并重置恢复标志</span></span><br><span class="line">                            <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</span><br><span class="line">                                c.restoreFlag = <span class="number">0</span>;</span><br><span class="line">                                c.updater().put(</span><br><span class="line">                                        Favorites.INTENT,</span><br><span class="line">                                        intent.toUri(<span class="number">0</span>)).commit();</span><br><span class="line">                                <span class="comment">// 更新组件名称</span></span><br><span class="line">                                cn = intent.getComponent();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// 如果找不到启动活动，则标记项目为已删除并返回</span></span><br><span class="line">                                c.markDeleted(<span class="string">&quot;Unable to find a launch target&quot;</span>);</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 如果目标包无效，则处理恢复状态</span></span><br><span class="line">                    <span class="keyword">if</span> (!TextUtils.isEmpty(targetPkg) &amp;&amp; !validTarget) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (c.restoreFlag != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 如果应用程序还未恢复</span></span><br><span class="line">                            FileLog.d(TAG, <span class="string">&quot;package not yet restored: &quot;</span> + targetPkg);</span><br><span class="line">    </span><br><span class="line">                            tempPackageKey.update(targetPkg, c.user);</span><br><span class="line">                            <span class="keyword">if</span> (c.hasRestoreFlag(WorkspaceItemInfo.FLAG_RESTORE_STARTED)) &#123;</span><br><span class="line">                                <span class="comment">// 恢复已经开始，不做任何操作</span></span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installingPkgs.containsKey(tempPackageKey)) &#123;</span><br><span class="line">                                <span class="comment">// 恢复正在进行，更新恢复标记</span></span><br><span class="line">                                c.restoreFlag |= WorkspaceItemInfo.FLAG_RESTORE_STARTED;</span><br><span class="line">                                c.updater().put(Favorites.RESTORED,</span><br><span class="line">                                        c.restoreFlag).commit();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// 否则标记项目为已删除并返回</span></span><br><span class="line">                                c.markDeleted(<span class="string">&quot;Unrestored app removed: &quot;</span> + targetPkg);</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pmHelper.isAppOnSdcard(targetPkg, c.user)) &#123;</span><br><span class="line">                            <span class="comment">// 如果包在 SD 卡上但不可用，标记应用不可用</span></span><br><span class="line">                            disabledState |= WorkspaceItemInfo.FLAG_DISABLED_NOT_AVAILABLE;</span><br><span class="line">                            <span class="comment">// 允许丢失目标，仍然将图标添加到工作区</span></span><br><span class="line">                            allowMissingTarget = <span class="literal">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isSdCardReady) &#123;</span><br><span class="line">                            <span class="comment">// 如果 SD 卡未准备好，将包名添加到待处理列表中</span></span><br><span class="line">                            Log.d(TAG, <span class="string">&quot;Missing pkg, will check later: &quot;</span> + targetPkg);</span><br><span class="line">                            mPendingPackages.add(<span class="keyword">new</span> <span class="title class_">PackageUserKey</span>(targetPkg, c.user));</span><br><span class="line">                            <span class="comment">// 允许丢失目标，仍然将图标添加到工作区</span></span><br><span class="line">                            allowMissingTarget = <span class="literal">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 如果包无效且 SD 卡已准备好，标记项目为已删除并返回</span></span><br><span class="line">                            c.markDeleted(<span class="string">&quot;Invalid package removed: &quot;</span> + targetPkg);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 如果恢复标志包含 Web UI 支持标志，设置目标无效</span></span><br><span class="line">                    <span class="keyword">if</span> ((c.restoreFlag &amp; WorkspaceItemInfo.FLAG_SUPPORTS_WEB_UI) != <span class="number">0</span>) &#123;</span><br><span class="line">                        validTarget = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="keyword">if</span> (validTarget) &#123;</span><br><span class="line">                        <span class="comment">// 如果快捷方式指向一个有效的目标，标记为已恢复</span></span><br><span class="line">                        c.markRestored();</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 决定是否使用低分辨率的图标</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">useLowResIcon</span> <span class="operator">=</span> !c.isOnWorkspaceOrHotseat();</span><br><span class="line">    </span><br><span class="line">                    WorkspaceItemInfo info;</span><br><span class="line">                    <span class="keyword">if</span> (c.restoreFlag != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 如果恢复标记不为 0，获取恢复的 item 信息</span></span><br><span class="line">                        info = c.getRestoredItemInfo(intent);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c.itemType == Favorites.ITEM_TYPE_APPLICATION) &#123;</span><br><span class="line">                        <span class="comment">// 创建应用程序快捷方式信息</span></span><br><span class="line">                        info = c.getAppShortcutInfo(</span><br><span class="line">                                intent, allowMissingTarget, useLowResIcon, <span class="literal">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c.itemType == Favorites.ITEM_TYPE_DEEP_SHORTCUT) &#123;</span><br><span class="line">                        <span class="comment">// 处理深层快捷方式</span></span><br><span class="line">                        <span class="type">ShortcutKey</span> <span class="variable">key</span> <span class="operator">=</span> ShortcutKey.fromIntent(intent, c.user);</span><br><span class="line">                        <span class="keyword">if</span> (unlockedUsers.get(c.serialNumber)) &#123;</span><br><span class="line">                            <span class="comment">// 如果用户已解锁，获取深度快捷方式信息</span></span><br><span class="line">                            <span class="type">ShortcutInfo</span> <span class="variable">pinnedShortcut</span> <span class="operator">=</span> mShortcutKeyToPinnedShortcuts.get(key);</span><br><span class="line">                            <span class="keyword">if</span> (pinnedShortcut == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// 如果未找到固定快捷方式，标记项目为已删除并返回</span></span><br><span class="line">                                c.markDeleted(<span class="string">&quot;Pinned shortcut not found&quot;</span>);</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 创建深度快捷方式的信息对象</span></span><br><span class="line">                            info = <span class="keyword">new</span> <span class="title class_">WorkspaceItemInfo</span>(pinnedShortcut, mApp.getContext());</span><br><span class="line">                            <span class="comment">// If the pinned deep shortcut is no longer published,</span></span><br><span class="line">                            <span class="comment">// use the last saved icon instead of the default.</span></span><br><span class="line">                            mIconCache.getShortcutIcon(info, pinnedShortcut, c::loadIcon);</span><br><span class="line">    </span><br><span class="line">                            <span class="comment">// 检查应用是否被挂起</span></span><br><span class="line">                            <span class="keyword">if</span> (pmHelper.isAppSuspended(</span><br><span class="line">                                    pinnedShortcut.getPackage(), info.user)) &#123;</span><br><span class="line">                                info.runtimeStatusFlags |= FLAG_DISABLED_SUSPENDED;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 更新 Intent</span></span><br><span class="line">                            intent = info.getIntent();</span><br><span class="line">                            allDeepShortcuts.add(pinnedShortcut);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 如果用户被锁定，创建一个简单的工作区项目信息</span></span><br><span class="line">                            info = c.loadSimpleWorkspaceItem();</span><br><span class="line">                            info.runtimeStatusFlags |= FLAG_DISABLED_LOCKED_USER;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 处理普通快捷方式</span></span><br><span class="line">                        info = c.loadSimpleWorkspaceItem();</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// Shortcuts are only available on the primary profile</span></span><br><span class="line">                        <span class="keyword">if</span> (!TextUtils.isEmpty(targetPkg)</span><br><span class="line">                                &amp;&amp; pmHelper.isAppSuspended(targetPkg, c.user)) &#123;</span><br><span class="line">                            disabledState |= FLAG_DISABLED_SUSPENDED;</span><br><span class="line">                        &#125;</span><br><span class="line">                        info.options = c.getOptions();</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// App shortcuts that used to be automatically added to Launcher</span></span><br><span class="line">                        <span class="comment">// did not always have the correct intent flags set, so do that here</span></span><br><span class="line">                        <span class="comment">// 修复某些旧快捷方式的 Intent 标志</span></span><br><span class="line">                        <span class="keyword">if</span> (intent.getAction() != <span class="literal">null</span></span><br><span class="line">                                &amp;&amp; intent.getCategories() != <span class="literal">null</span></span><br><span class="line">                                &amp;&amp; intent.getAction().equals(Intent.ACTION_MAIN)</span><br><span class="line">                                &amp;&amp; intent.getCategories().contains(Intent.CATEGORY_LAUNCHER)) &#123;</span><br><span class="line">                            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">                                    | Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 检查 info 是否为空</span></span><br><span class="line">                    <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (info.itemType != Favorites.ITEM_TYPE_DEEP_SHORTCUT) &#123;</span><br><span class="line">                            <span class="comment">// Skip deep shortcuts; their title and icons have already been</span></span><br><span class="line">                            <span class="comment">// loaded above.</span></span><br><span class="line">                            <span class="comment">// 将图标请求信息添加到列表</span></span><br><span class="line">                            iconRequestInfos.add(c.createIconRequestInfo(info, useLowResIcon));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 应用通用属性</span></span><br><span class="line">                        c.applyCommonProperties(info);</span><br><span class="line">                        <span class="comment">// 更新信息对象的 Intent 和其他属性</span></span><br><span class="line">                        info.intent = intent;</span><br><span class="line">                        info.rank = c.getRank();</span><br><span class="line">                        info.spanX = <span class="number">1</span>;</span><br><span class="line">                        info.spanY = <span class="number">1</span>;</span><br><span class="line">                        info.runtimeStatusFlags |= disabledState;</span><br><span class="line">                        <span class="comment">// 如果处于安全模式且目标应用不是系统应用，标记其为禁用</span></span><br><span class="line">                        <span class="keyword">if</span> (isSafeMode &amp;&amp; !isSystemApp(mApp.getContext(), intent)) &#123;</span><br><span class="line">                            info.runtimeStatusFlags |= FLAG_DISABLED_SAFEMODE;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 获取启动活动信息</span></span><br><span class="line">                        <span class="type">LauncherActivityInfo</span> <span class="variable">activityInfo</span> <span class="operator">=</span> c.getLauncherActivityInfo();</span><br><span class="line">                        <span class="keyword">if</span> (activityInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 设置下载进度</span></span><br><span class="line">                            info.setProgressLevel(</span><br><span class="line">                                    PackageManagerHelper.getLoadingProgress(activityInfo),</span><br><span class="line">                                    PackageInstallInfo.STATUS_INSTALLED_DOWNLOADING);</span><br><span class="line">                        &#125;</span><br><span class="line">    </span><br><span class="line">                        <span class="keyword">if</span> (c.restoreFlag != <span class="number">0</span> &amp;&amp; !TextUtils.isEmpty(targetPkg)) &#123;</span><br><span class="line">                            tempPackageKey.update(targetPkg, c.user);</span><br><span class="line">                            <span class="type">SessionInfo</span> <span class="variable">si</span> <span class="operator">=</span> installingPkgs.get(tempPackageKey);</span><br><span class="line">                            <span class="keyword">if</span> (si == <span class="literal">null</span>) &#123;</span><br><span class="line">                                info.runtimeStatusFlags</span><br><span class="line">                                        &amp;= ~ItemInfoWithIcon.FLAG_INSTALL_SESSION_ACTIVE;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activityInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="type">int</span> <span class="variable">installProgress</span> <span class="operator">=</span> (<span class="type">int</span>) (si.getProgress() * <span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">                                info.setProgressLevel(installProgress,</span><br><span class="line">                                        PackageInstallInfo.STATUS_INSTALLING);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 检查并添加 item 信息到数据模型</span></span><br><span class="line">                        c.checkAndAddItem(info, mBgDataModel, memoryLogger);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unexpected null WorkspaceItemInfo&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// ===&gt;&gt;&gt; 应用/快捷方式处理完毕</span></span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Desktop items loading interrupted&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看看 <code>checkAndAddItem()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderCursor.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderCursor</span> <span class="keyword">extends</span> <span class="title class_">CursorWrapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查并添加一个 ItemInfo 项目到数据模型中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkAndAddItem</span><span class="params">(</span></span><br><span class="line"><span class="params">            ItemInfo info, BgDataModel dataModel, LoaderMemoryLogger logger)</span> &#123;</span><br><span class="line">        <span class="comment">// 检查项目类型是否为深层快捷方式</span></span><br><span class="line">        <span class="keyword">if</span> (info.itemType == Favorites.ITEM_TYPE_DEEP_SHORTCUT) &#123;</span><br><span class="line">            <span class="comment">// 从 ItemInfo 中生成 ShortcutKey。这是确保快捷方式的 Intent 是有效的，</span></span><br><span class="line">            <span class="comment">// 如果 ShortcutKey 创建失败，可能会抛出异常，从而跳过加载该项目</span></span><br><span class="line">            ShortcutKey.fromItemInfo(info);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证项目在布局中的位置是否有效（例如，检查是否与其他项目重叠）</span></span><br><span class="line">        <span class="keyword">if</span> (checkItemPlacement(info)) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 重点方法：如果位置有效，将项目添加到 dataModel 中</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            dataModel.addItem(mContext, info, <span class="literal">false</span>, logger);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果位置无效，调用 markDeleted 方法标记项目为已删除，</span></span><br><span class="line">            <span class="comment">// 原因是 “Item position overlap”（项目位置重叠）</span></span><br><span class="line">            markDeleted(<span class="string">&quot;Item position overlap&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟踪 <code>BgDataModel</code> 的 <code>addItem()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BgDataModel.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BgDataModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">addItem</span><span class="params">(</span></span><br><span class="line"><span class="params">            Context context, ItemInfo item, <span class="type">boolean</span> newItem, <span class="meta">@Nullable</span> LoaderMemoryLogger logger)</span> &#123;</span><br><span class="line">        <span class="comment">// 日志记录</span></span><br><span class="line">        <span class="keyword">if</span> (logger != <span class="literal">null</span>) &#123;</span><br><span class="line">            logger.addLog(</span><br><span class="line">                    Log.DEBUG,</span><br><span class="line">                    TAG,</span><br><span class="line">                    String.format(<span class="string">&quot;Adding item to ID map: %s&quot;</span>, item.toString()),</span><br><span class="line">                    <span class="comment">/* stackTrace= */</span> <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将 ItemInfo 的 ID 和项目本身添加到 itemsIdMap 映射中。这是一个 ID 到 ItemInfo 对象的映射，用于快速查找项目</span></span><br><span class="line">        itemsIdMap.put(item.id, item);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据 ItemInfo 类型进行分类处理</span></span><br><span class="line">        <span class="keyword">switch</span> (item.itemType) &#123;</span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_FOLDER:         <span class="comment">// 文件夹</span></span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APP_PAIR:       <span class="comment">// 应用对</span></span><br><span class="line">                <span class="comment">// 将文件夹的 ID 和 FolderInfo 对象存储到 folders 映射中</span></span><br><span class="line">                folders.put(item.id, (FolderInfo) item);</span><br><span class="line">                <span class="comment">// 同时添加到 workspaceItems 集合，以便在工作区显示</span></span><br><span class="line">                workspaceItems.add(item);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_DEEP_SHORTCUT:  <span class="comment">// 深层快捷方式</span></span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPLICATION:    <span class="comment">// 应用</span></span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_SHORTCUT:       <span class="comment">// 快捷方式</span></span><br><span class="line">                <span class="comment">// 检查 container 值决定存储位置</span></span><br><span class="line">                <span class="keyword">if</span> (item.container == LauncherSettings.Favorites.CONTAINER_DESKTOP ||</span><br><span class="line">                        item.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT) &#123;</span><br><span class="line">                    <span class="comment">// 如果是桌面或者 HotSeat 区域，则直接添加到 workspaceItems</span></span><br><span class="line">                    workspaceItems.add(item);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果 item 应添加到文件夹内部，先检查该文件夹是否存在</span></span><br><span class="line">                    <span class="keyword">if</span> (newItem) &#123;</span><br><span class="line">                        <span class="comment">// 若是新 item 且文件夹不存在，记录错误日志，表明尝试添加到不存在的文件夹</span></span><br><span class="line">                        <span class="keyword">if</span> (!folders.containsKey(item.container)) &#123;</span><br><span class="line">                            <span class="comment">// Adding an item to a nonexistent collection.</span></span><br><span class="line">                            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;attempted to add item: &quot;</span> + item + <span class="string">&quot; to a nonexistent app&quot;</span></span><br><span class="line">                                    + <span class="string">&quot; collection&quot;</span>;</span><br><span class="line">                            Log.e(TAG, msg);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 若文件夹存在，调用 findOrMakeFolder 方法获取文件夹，并将项目添加到该文件夹</span></span><br><span class="line">                        findOrMakeFolder(item.container).add((WorkspaceItemInfo) item, <span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPWIDGET:          <span class="comment">// 小部件</span></span><br><span class="line">            <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_CUSTOM_APPWIDGET:   <span class="comment">// 自定义小部件</span></span><br><span class="line">                <span class="comment">// 强制转换为 LauncherAppWidgetInfo 类型，并将其添加到 appWidgets 集合</span></span><br><span class="line">                appWidgets.add((LauncherAppWidgetInfo) item);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 item 是新添加的深层快捷方式，调用 updateShortcutPinnedState 方法更新快捷方式的固定状态</span></span><br><span class="line">        <span class="keyword">if</span> (newItem &amp;&amp; item.itemType == LauncherSettings.Favorites.ITEM_TYPE_DEEP_SHORTCUT) &#123;</span><br><span class="line">            <span class="comment">// 该方法使用上下文和用户信息更新快捷方式的固定状态（Pinned 状态）</span></span><br><span class="line">            updateShortcutPinnedState(context, item.user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="文件夹"><a href="#文件夹" class="headerlink" title="文件夹"></a>文件夹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processWorkspaceItem</span><span class="params">(LoaderCursor c,</span></span><br><span class="line"><span class="params">            LoaderMemoryLogger memoryLogger,</span></span><br><span class="line"><span class="params">            HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSdCardReady,</span></span><br><span class="line"><span class="params">            PackageUserKey tempPackageKey,</span></span><br><span class="line"><span class="params">            WidgetManagerHelper widgetHelper,</span></span><br><span class="line"><span class="params">            PackageManagerHelper pmHelper,</span></span><br><span class="line"><span class="params">            List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos,</span></span><br><span class="line"><span class="params">            LongSparseArray&lt;Boolean&gt; unlockedUsers,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSafeMode,</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (c.itemType) &#123;</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_SHORTCUT:        <span class="comment">// 如果是快捷方式</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPLICATION:     <span class="comment">// 如果是应用程序</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_DEEP_SHORTCUT:   <span class="comment">// 如果是深层快捷方式</span></span><br><span class="line">                     ... <span class="comment">// 应用/快捷方式处理逻辑</span></span><br><span class="line">                ----------------------------------------------------------------------</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_FOLDER:          <span class="comment">// 如果是文件夹类型</span></span><br><span class="line">                    <span class="comment">// 从后台数据模型中查找或创建文件夹信息对象</span></span><br><span class="line">                    <span class="type">FolderInfo</span> <span class="variable">folderInfo</span> <span class="operator">=</span> mBgDataModel.findOrMakeFolder(c.id);</span><br><span class="line">                    <span class="comment">// 应用通用属性到文件夹信息对象</span></span><br><span class="line">                    c.applyCommonProperties(folderInfo);</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 不要使用 c.getTitle()，因为此方法已将其缓存在 FolderInfo 中</span></span><br><span class="line">                    folderInfo.title = c.getString(c.mTitleIndex);</span><br><span class="line">                    <span class="comment">// 设置文件夹在工作区的占用宽度和高度（单位是格子）</span></span><br><span class="line">                    folderInfo.spanX = <span class="number">1</span>;</span><br><span class="line">                    folderInfo.spanY = <span class="number">1</span>;</span><br><span class="line">                    <span class="comment">// 应用文件夹的其他选项</span></span><br><span class="line">                    folderInfo.options = c.getOptions();</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 恢复标记为已恢复，无需特殊处理恢复的文件夹</span></span><br><span class="line">                    c.markRestored();</span><br><span class="line">                    <span class="comment">// 检查并添加文件夹信息到数据模型，并记录内存使用情况</span></span><br><span class="line">                    c.checkAndAddItem(folderInfo, mBgDataModel, memoryLogger);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// ===&gt;&gt;&gt; 文件夹类型处理完毕</span></span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Desktop items loading interrupted&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们看下 <code>findOrMakeFolder()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BgDataModel.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BgDataModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> FolderInfo <span class="title function_">findOrMakeFolder</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="comment">// 通过 id 从 folders 映射中获取对应的 FolderInfo 对象</span></span><br><span class="line">        <span class="type">FolderInfo</span> <span class="variable">folderInfo</span> <span class="operator">=</span> folders.get(id);</span><br><span class="line">        <span class="keyword">if</span> (folderInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果文件夹不存在，创建一个新的 FolderInfo 实例</span></span><br><span class="line">            folderInfo = <span class="keyword">new</span> <span class="title class_">FolderInfo</span>();</span><br><span class="line">            <span class="comment">// 新的 FolderInfo 实例以 id 为键存入 folders 映射中，</span></span><br><span class="line">            <span class="comment">// 确保下次访问同一 id 时可以直接获取该对象</span></span><br><span class="line">            folders.put(id, folderInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> folderInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Widget"><a href="#Widget" class="headerlink" title="Widget"></a>Widget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/LoaderTask.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processWorkspaceItem</span><span class="params">(LoaderCursor c,</span></span><br><span class="line"><span class="params">            LoaderMemoryLogger memoryLogger,</span></span><br><span class="line"><span class="params">            HashMap&lt;PackageUserKey, SessionInfo&gt; installingPkgs,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSdCardReady,</span></span><br><span class="line"><span class="params">            PackageUserKey tempPackageKey,</span></span><br><span class="line"><span class="params">            WidgetManagerHelper widgetHelper,</span></span><br><span class="line"><span class="params">            PackageManagerHelper pmHelper,</span></span><br><span class="line"><span class="params">            List&lt;IconRequestInfo&lt;WorkspaceItemInfo&gt;&gt; iconRequestInfos,</span></span><br><span class="line"><span class="params">            LongSparseArray&lt;Boolean&gt; unlockedUsers,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isSafeMode,</span></span><br><span class="line"><span class="params">            List&lt;ShortcutInfo&gt; allDeepShortcuts)</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (c.itemType) &#123;</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_SHORTCUT:        <span class="comment">// 如果是快捷方式</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPLICATION:     <span class="comment">// 如果是应用程序</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_DEEP_SHORTCUT:   <span class="comment">// 如果是深层快捷方式</span></span><br><span class="line">                    ... <span class="comment">// 应用/快捷方式处理逻辑</span></span><br><span class="line">                ----------------------------------------------------------------------</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_FOLDER:          <span class="comment">// 如果是文件夹类型</span></span><br><span class="line">                    ... <span class="comment">// 文件夹类型处理逻辑</span></span><br><span class="line">                ----------------------------------------------------------------------</span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_APPWIDGET:       <span class="comment">// 如果类型是应用小部件</span></span><br><span class="line">                    <span class="comment">// 检查是否禁用所有小部件，如果是，则标记为已删除并返回</span></span><br><span class="line">                    <span class="keyword">if</span> (WidgetsModel.GO_DISABLE_WIDGETS) &#123;</span><br><span class="line">                        c.markDeleted(<span class="string">&quot;Only legacy shortcuts can have null package&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Follow through，继续处理其他小部件类型</span></span><br><span class="line">                <span class="keyword">case</span> Favorites.ITEM_TYPE_CUSTOM_APPWIDGET:  <span class="comment">// 如果类型是自定义的应用小部件</span></span><br><span class="line">                    <span class="comment">// 读取所有 Launcher 特定的小部件详细信息</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">customWidget</span> <span class="operator">=</span> c.itemType</span><br><span class="line">                            == Favorites.ITEM_TYPE_CUSTOM_APPWIDGET;</span><br><span class="line">                    <span class="comment">// 获取小部件的 ID</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">appWidgetId</span> <span class="operator">=</span> c.getAppWidgetId();</span><br><span class="line">                    <span class="comment">// 为应用小部件恢复获取 Provider 的字符串</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">savedProvider</span> <span class="operator">=</span> c.getAppWidgetProvider();</span><br><span class="line">                    <span class="keyword">final</span> ComponentName component;</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 如果选项中包含搜索小部件标志</span></span><br><span class="line">                    <span class="keyword">if</span> ((c.getOptions() &amp; LauncherAppWidgetInfo.OPTION_SEARCH_WIDGET) != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 获取搜索小部件的组件名称</span></span><br><span class="line">                        component  = QsbContainerView.getSearchComponentName(mApp.getContext());</span><br><span class="line">                        <span class="keyword">if</span> (component == <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 如果组件为空，则标记为已删除并返回</span></span><br><span class="line">                            c.markDeleted(<span class="string">&quot;Discarding SearchWidget without packagename &quot;</span>);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 从保存的字符串中解析组件名称</span></span><br><span class="line">                        component = ComponentName.unflattenFromString(savedProvider);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 检查小部件的 ID 是否有效</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isIdValid</span> <span class="operator">=</span></span><br><span class="line">                            !c.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID);</span><br><span class="line">                    <span class="comment">// 检查小部件的 Provider 是否已准备好</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">wasProviderReady</span> <span class="operator">=</span></span><br><span class="line">                            !c.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY);</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 创建一个包含组件名称和用户的 ComponentKey</span></span><br><span class="line">                    <span class="type">ComponentKey</span> <span class="variable">providerKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentKey</span>(component, c.user);</span><br><span class="line">                    <span class="comment">// 如果 mWidgetProvidersMap 不包含该键，则查找并添加小部件 Provider</span></span><br><span class="line">                    <span class="keyword">if</span> (!mWidgetProvidersMap.containsKey(providerKey)) &#123;</span><br><span class="line">                        mWidgetProvidersMap.put(providerKey,</span><br><span class="line">                                widgetHelper.findProvider(component, c.user));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 从 mWidgetProvidersMap 中获取小部件 Provider 信息</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">AppWidgetProviderInfo</span> <span class="variable">provider</span> <span class="operator">=</span> mWidgetProvidersMap.get(providerKey);</span><br><span class="line">    </span><br><span class="line">                    <span class="comment">// 检查小部件 Provider 是否有效</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isProviderReady</span> <span class="operator">=</span> isValidProvider(provider);</span><br><span class="line">                    <span class="comment">// 如果不是安全模式、不是自定义小部件、小部件 Provider 曾经准备好但现在不再准备好</span></span><br><span class="line">                    <span class="keyword">if</span> (!isSafeMode &amp;&amp; !customWidget &amp;&amp; wasProviderReady &amp;&amp; !isProviderReady) &#123;</span><br><span class="line">                        <span class="comment">// 标记为已删除并返回</span></span><br><span class="line">                        c.markDeleted(<span class="string">&quot;Deleting widget that isn&#x27;t installed anymore: &quot;</span> + provider);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 处理小部件恢复状态</span></span><br><span class="line">                        LauncherAppWidgetInfo appWidgetInfo;</span><br><span class="line">                        <span class="keyword">if</span> (isProviderReady) &#123;</span><br><span class="line">                            <span class="comment">// 如果小部件 Provider 准备好，则创建小部件信息</span></span><br><span class="line">                            appWidgetInfo =</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">LauncherAppWidgetInfo</span>(appWidgetId, provider.provider);</span><br><span class="line">    </span><br><span class="line">                            <span class="comment">// Provider 可用，小部件要么可用，要么不可用，不需要跟踪未来的恢复更新</span></span><br><span class="line">                            <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> c.restoreFlag</span><br><span class="line">                                    &amp; ~LauncherAppWidgetInfo.FLAG_RESTORE_STARTED</span><br><span class="line">                                    &amp; ~LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY;</span><br><span class="line">                            <span class="keyword">if</span> (!wasProviderReady) &#123;</span><br><span class="line">                                <span class="comment">// 如果 Provider 之前未准备好，则更新状态和 UI 标志</span></span><br><span class="line">                                <span class="keyword">if</span> (isIdValid) &#123;</span><br><span class="line">                                    status |= LauncherAppWidgetInfo.FLAG_UI_NOT_READY;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            appWidgetInfo.restoreStatus = status;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 如果 Provider 不可用，记录恢复状态并创建小部件信息</span></span><br><span class="line">                            Log.v(TAG, <span class="string">&quot;Widget restore pending id=&quot;</span> + c.id</span><br><span class="line">                                    + <span class="string">&quot; appWidgetId=&quot;</span> + appWidgetId</span><br><span class="line">                                    + <span class="string">&quot; status =&quot;</span> + c.restoreFlag);</span><br><span class="line">                            appWidgetInfo = <span class="keyword">new</span> <span class="title class_">LauncherAppWidgetInfo</span>(appWidgetId, component);</span><br><span class="line">                            appWidgetInfo.restoreStatus = c.restoreFlag;</span><br><span class="line">    </span><br><span class="line">                            <span class="comment">// 更新临时包键并获取安装进度</span></span><br><span class="line">                            tempPackageKey.update(component.getPackageName(), c.user);</span><br><span class="line">                            <span class="type">SessionInfo</span> <span class="variable">si</span> <span class="operator">=</span> installingPkgs.get(tempPackageKey);</span><br><span class="line">                            <span class="type">Integer</span> <span class="variable">installProgress</span> <span class="operator">=</span> si == <span class="literal">null</span></span><br><span class="line">                                    ? <span class="literal">null</span></span><br><span class="line">                                    : (<span class="type">int</span>) (si.getProgress() * <span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">                            <span class="keyword">if</span> (c.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_RESTORE_STARTED)) &#123;</span><br><span class="line">                                <span class="comment">// 恢复已经开始一次</span></span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installProgress != <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// 应用恢复已经开始，更新标志</span></span><br><span class="line">                                appWidgetInfo.restoreStatus</span><br><span class="line">                                        |= LauncherAppWidgetInfo.FLAG_RESTORE_STARTED;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isSafeMode) &#123;</span><br><span class="line">                                <span class="comment">// 如果不是安全模式，则标记为已删除并返回</span></span><br><span class="line">                                c.markDeleted(<span class="string">&quot;Unrestored widget removed: &quot;</span> + component);</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">    </span><br><span class="line">                            <span class="comment">// 设置安装进度</span></span><br><span class="line">                            appWidgetInfo.installProgress =</span><br><span class="line">                                    installProgress == <span class="literal">null</span> ? <span class="number">0</span> : installProgress;</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 如果恢复标志包含直接配置标志，则设置绑定选项</span></span><br><span class="line">                        <span class="keyword">if</span> (appWidgetInfo.hasRestoreFlag(</span><br><span class="line">                                LauncherAppWidgetInfo.FLAG_DIRECT_CONFIG)) &#123;</span><br><span class="line">                            appWidgetInfo.bindOptions = c.parseIntent();</span><br><span class="line">                        &#125;</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// 应用通用属性到小部件信息</span></span><br><span class="line">                        c.applyCommonProperties(appWidgetInfo);</span><br><span class="line">                        <span class="comment">// 设置小部件的占用格子数量</span></span><br><span class="line">                        appWidgetInfo.spanX = c.getSpanX();</span><br><span class="line">                        appWidgetInfo.spanY = c.getSpanY();</span><br><span class="line">                        <span class="comment">// 设置小部件的选项</span></span><br><span class="line">                        appWidgetInfo.options = c.getOptions();</span><br><span class="line">                        <span class="comment">// 设置用户信息</span></span><br><span class="line">                        appWidgetInfo.user = c.user;</span><br><span class="line">                        <span class="comment">// 设置小部件的来源容器</span></span><br><span class="line">                        appWidgetInfo.sourceContainer = c.getAppWidgetSource();</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// 如果小部件的大小无效，则标记为已删除并返回</span></span><br><span class="line">                        <span class="keyword">if</span> (appWidgetInfo.spanX &lt;= <span class="number">0</span> || appWidgetInfo.spanY &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            c.markDeleted(<span class="string">&quot;Widget has invalid size: &quot;</span></span><br><span class="line">                                    + appWidgetInfo.spanX + <span class="string">&quot;x&quot;</span> + appWidgetInfo.spanY);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 获取小部件 Provider 的信息并检查其最小尺寸要求</span></span><br><span class="line">                        <span class="type">LauncherAppWidgetProviderInfo</span> <span class="variable">widgetProviderInfo</span> <span class="operator">=</span></span><br><span class="line">                                widgetHelper.getLauncherAppWidgetInfo(appWidgetId);</span><br><span class="line">                        <span class="keyword">if</span> (widgetProviderInfo != <span class="literal">null</span></span><br><span class="line">                                &amp;&amp; (appWidgetInfo.spanX &lt; widgetProviderInfo.minSpanX</span><br><span class="line">                                || appWidgetInfo.spanY &lt; widgetProviderInfo.minSpanY)) &#123;</span><br><span class="line">                            FileLog.d(TAG, <span class="string">&quot;Widget &quot;</span> + widgetProviderInfo.getComponent()</span><br><span class="line">                                    + <span class="string">&quot; minSizes not meet: span=&quot;</span> + appWidgetInfo.spanX</span><br><span class="line">                                    + <span class="string">&quot;x&quot;</span> + appWidgetInfo.spanY + <span class="string">&quot; minSpan=&quot;</span></span><br><span class="line">                                    + widgetProviderInfo.minSpanX + <span class="string">&quot;x&quot;</span></span><br><span class="line">                                    + widgetProviderInfo.minSpanY);</span><br><span class="line">                            logWidgetInfo(mApp.getInvariantDeviceProfile(),</span><br><span class="line">                                    widgetProviderInfo);</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 如果小部件不在工作区或 HotSeat 中，则标记为已删除并返回</span></span><br><span class="line">                        <span class="keyword">if</span> (!c.isOnWorkspaceOrHotseat()) &#123;</span><br><span class="line">                            c.markDeleted(<span class="string">&quot;Widget found where container != CONTAINER_DESKTOP&quot;</span></span><br><span class="line">                                    + <span class="string">&quot;nor CONTAINER_HOTSEAT - ignoring!&quot;</span>);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// 如果不是自定义小部件，检查 Provider 名称是否匹配，更新状态</span></span><br><span class="line">                        <span class="keyword">if</span> (!customWidget) &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">providerName</span> <span class="operator">=</span> appWidgetInfo.providerName.flattenToString();</span><br><span class="line">                            <span class="keyword">if</span> (!providerName.equals(savedProvider)</span><br><span class="line">                                    || (appWidgetInfo.restoreStatus != c.restoreFlag)) &#123;</span><br><span class="line">                                c.updater()</span><br><span class="line">                                        .put(Favorites.APPWIDGET_PROVIDER,</span><br><span class="line">                                                providerName)</span><br><span class="line">                                        .put(Favorites.RESTORED,</span><br><span class="line">                                                appWidgetInfo.restoreStatus)</span><br><span class="line">                                        .commit();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// 如果恢复状态不是完成，则创建待处理的小部件信息并获取标题和图标</span></span><br><span class="line">                        <span class="keyword">if</span> (appWidgetInfo.restoreStatus</span><br><span class="line">                                != LauncherAppWidgetInfo.RESTORE_COMPLETED) &#123;</span><br><span class="line">                            appWidgetInfo.pendingItemInfo = WidgetsModel.newPendingItemInfo(</span><br><span class="line">                                    mApp.getContext(),</span><br><span class="line">                                    appWidgetInfo.providerName,</span><br><span class="line">                                    appWidgetInfo.user);</span><br><span class="line">                            mIconCache.getTitleAndIconForApp(</span><br><span class="line">                                    appWidgetInfo.pendingItemInfo, <span class="literal">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">    </span><br><span class="line">                        <span class="comment">// 检查并添加小部件信息到数据模型中</span></span><br><span class="line">                        c.checkAndAddItem(appWidgetInfo, mBgDataModel);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Desktop items loading interrupted&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，<font color="#085DFF">loadWorkspace()</font> 的工作算是分析完了，接下来我们看看绑定的流程！</p>
<hr>
<h1 id="绑定-Workspace-流程解析"><a href="#绑定-Workspace-流程解析" class="headerlink" title="绑定 Workspace 流程解析"></a>绑定 Workspace 流程解析</h1><p>绑定 Workspace 是通过 <code>LauncherBinder</code> 的 <font color="#FF8C00">bindWorkspace()</font> 函数，在其父类 <code>BaseLauncherBinder</code> 中定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLauncherBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Binds all loaded data to actual views on the main thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bindWorkspace</span><span class="params">(<span class="type">boolean</span> incrementBindId, <span class="type">boolean</span> isBindSync)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ENABLE_WORKSPACE_LOADING_OPTIMIZATION 标志主要用于：</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         *     控制一系列与工作区加载过程相关的优化措施。这些优化可能涵盖了加载速度、</span></span><br><span class="line"><span class="comment">         *     内存使用、I/O 操作等方面的改进，以提升用户体验。</span></span><br><span class="line"><span class="comment">         *     Log 实测为 false，所以我们可以略过这个条件判断。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (FeatureFlags.ENABLE_WORKSPACE_LOADING_OPTIMIZATION.get()) &#123;</span><br><span class="line">            <span class="type">DisjointWorkspaceBinder</span> <span class="variable">workspaceBinder</span> <span class="operator">=</span></span><br><span class="line">                    initWorkspaceBinder(incrementBindId, mBgDataModel.collectWorkspaceScreens());</span><br><span class="line">            workspaceBinder.bindCurrentWorkspacePages(isBindSync);</span><br><span class="line">            workspaceBinder.bindOtherWorkspacePages();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            bindWorkspaceAllAtOnce(incrementBindId, isBindSync);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，现在我们继续跟踪 <code>bindWorkspaceAllAtOnce()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLauncherBinder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一次性绑定工作区中的所有项目（应用图标、小部件、屏幕等）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindWorkspaceAllAtOnce</span><span class="params">(<span class="type">boolean</span> incrementBindId, <span class="type">boolean</span> isBindSync)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 初始化集合：</span></span><br><span class="line"><span class="comment">         *     workspaceItems  : 用于存储工作区中的项目（应用图标、快捷方式等）</span></span><br><span class="line"><span class="comment">         *     appWidgets      : 用于存储工作区中的小部件</span></span><br><span class="line"><span class="comment">         *     orderedScreenIds: 保存工作区的屏幕 ID，确保所有 Item 按屏幕顺序排列</span></span><br><span class="line"><span class="comment">         *     extraItems      : 存储固定容器中的额外项目，通常是一些特殊的固定元素</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ArrayList&lt;ItemInfo&gt; workspaceItems = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        ArrayList&lt;LauncherAppWidgetInfo&gt; appWidgets = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">IntArray</span> <span class="variable">orderedScreenIds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntArray</span>();</span><br><span class="line">        ArrayList&lt;FixedContainerItems&gt; extraItems = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> workspaceItemCount;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 从后台数据模型中获取数据</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mBgDataModel) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 将 mBgDataModel 中的所有工作区项目复制到 workspaceItems</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            workspaceItems.addAll(mBgDataModel.workspaceItems);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 将所有小部件复制到 appWidgets</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            appWidgets.addAll(mBgDataModel.appWidgets);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 从 mBgDataModel 中收集并排序屏幕 ID</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            orderedScreenIds.addAll(mBgDataModel.collectWorkspaceScreens());</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 复制固定容器中的额外项目</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            mBgDataModel.extraItems.forEach(extraItems::add);</span><br><span class="line">            <span class="keyword">if</span> (incrementBindId) &#123;</span><br><span class="line">                mBgDataModel.lastBindId++;</span><br><span class="line">            &#125;</span><br><span class="line">            mMyBindingId = mBgDataModel.lastBindId;</span><br><span class="line">            workspaceItemCount = mBgDataModel.itemsIdMap.size();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 批量绑定到前台</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 遍历回调列表 mCallbacksList，对每个回调实例执行绑定操作</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (Callbacks cb : mCallbacksList) &#123;</span><br><span class="line">            <span class="comment">// 创建 UnifiedWorkspaceBinder 实例并调用其 bind 方法</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">UnifiedWorkspaceBinder</span>(cb, mUiExecutor, mApp, mBgDataModel, mMyBindingId,</span><br><span class="line">                    workspaceItems, appWidgets, extraItems, orderedScreenIds)</span><br><span class="line">                    .bind(isBindSync, workspaceItemCount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数中，创建了 <code>workspaceItems</code>、<code>appWidgets</code>、<code>orderedScreenIds</code>（屏幕数）等信息的数组。然后创建 <code>UnifiedWorkspaceBinder</code>，调用其 bind() 函数开始绑定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLauncherBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">UnifiedWorkspaceBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 按顺序将工作区中的项目绑定到 UI 上，分批加载当前屏幕和其他屏幕的项目</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(<span class="type">boolean</span> isBindSync, <span class="type">int</span> workspaceItemCount)</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 获取当前屏幕 ID 集合</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">IntSet</span> <span class="variable">currentScreenIds</span> <span class="operator">=</span></span><br><span class="line">                    mCallbacks.getPagesToBindSynchronously(mOrderedScreenIds);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 保获取到的屏幕 ID 集合非空，否则抛出异常</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            Objects.requireNonNull(currentScreenIds, <span class="string">&quot;Null screen ids provided by &quot;</span> + mCallbacks);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 筛选当前屏幕的项目：</span></span><br><span class="line"><span class="comment">             *     currentWorkspaceItems: 当前屏幕的应用项目</span></span><br><span class="line"><span class="comment">             *     otherWorkspaceItems  : 其他屏幕的应用项目</span></span><br><span class="line"><span class="comment">             *     currentAppWidgets    : 当前屏幕的小部件</span></span><br><span class="line"><span class="comment">             *     otherAppWidgets      : 其他屏幕的小部件</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ArrayList&lt;ItemInfo&gt; currentWorkspaceItems = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            ArrayList&lt;ItemInfo&gt; otherWorkspaceItems = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            ArrayList&lt;LauncherAppWidgetInfo&gt; currentAppWidgets = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            ArrayList&lt;LauncherAppWidgetInfo&gt; otherAppWidgets = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 将 mWorkspaceItems 和 mAppWidgets 中的项目分成当前屏幕和其他屏幕的两部分</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            filterCurrentWorkspaceItems(currentScreenIds, mWorkspaceItems, currentWorkspaceItems,</span><br><span class="line">                    otherWorkspaceItems);</span><br><span class="line">            filterCurrentWorkspaceItems(currentScreenIds, mAppWidgets, currentAppWidgets,</span><br><span class="line">                    otherAppWidgets);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 空间排序</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * 获取设备配置文件，包含屏幕布局和网格信息</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">InvariantDeviceProfile</span> <span class="variable">idp</span> <span class="operator">=</span> mApp.getInvariantDeviceProfile();</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 当前屏幕和其他屏幕的项目分别进行空间排序，确保项目在屏幕上按位置显示</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            sortWorkspaceItemsSpatially(idp, currentWorkspaceItems);</span><br><span class="line">            sortWorkspaceItemsSpatially(idp, otherWorkspaceItems);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 通知 UI 开始绑定</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            executeCallbacksTask(c -&gt; &#123;</span><br><span class="line">                c.clearPendingBinds();    <span class="comment">// 清除 UI 中待绑定的项目，准备新项目的绑定</span></span><br><span class="line">                c.startBinding();         <span class="comment">// 通知回调开始绑定操作</span></span><br><span class="line">            &#125;, mUiExecutor);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 绑定屏幕 ID</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            executeCallbacksTask(c -&gt; c.bindScreens(mOrderedScreenIds), mUiExecutor);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 往当前的屏幕上绑定数据内容</span></span><br><span class="line"><span class="comment">             *     bindWorkspaceItems : 将当前屏幕的应用项目绑定到 UI</span></span><br><span class="line"><span class="comment">             *     bindAppWidgets     : 将当前屏幕的小部件绑定到 UI</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            bindWorkspaceItems(currentWorkspaceItems, mUiExecutor);</span><br><span class="line">            bindAppWidgets(currentAppWidgets, mUiExecutor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 绑定额外容器中的项目</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (!FeatureFlags.CHANGE_MODEL_DELEGATE_LOADING_ORDER.get()) &#123;</span><br><span class="line">                mExtraItems.forEach(item -&gt;</span><br><span class="line">                        executeCallbacksTask(c -&gt; c.bindExtraContainerItems(item), mUiExecutor));</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 加载其他屏幕的项目</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * 创建一个 RunnableList 用于收集其他屏幕的项目绑定任务，将任务添加到 pendingTasks 列表</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">RunnableList</span> <span class="variable">pendingTasks</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RunnableList</span>();</span><br><span class="line">            <span class="type">Executor</span> <span class="variable">pendingExecutor</span> <span class="operator">=</span> pendingTasks::add;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 将其他屏幕的应用项目和小部件绑定到待执行列表，延后显示</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            bindWorkspaceItems(otherWorkspaceItems, pendingExecutor);</span><br><span class="line">            bindAppWidgets(otherAppWidgets, pendingExecutor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 在其他屏幕的项目加载完成后，通知 UI 绑定已完成</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            executeCallbacksTask(c -&gt; c.finishBindingItems(currentScreenIds), pendingExecutor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 执行异步加载完成操作</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            pendingExecutor.execute(</span><br><span class="line">                    () -&gt; &#123;</span><br><span class="line">                        MODEL_EXECUTOR.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT);</span><br><span class="line">                        ItemInstallQueue.INSTANCE.get(mApp.getContext())</span><br><span class="line">                                .resumeModelPush(FLAG_LOADER_RUNNING);</span><br><span class="line">                    &#125;);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 回调初始绑定完成事件</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            executeCallbacksTask(</span><br><span class="line">                    c -&gt; &#123;</span><br><span class="line">                        MODEL_EXECUTOR.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">                        c.onInitialBindComplete(</span><br><span class="line">                                currentScreenIds, pendingTasks, workspaceItemCount, isBindSync);</span><br><span class="line">                    &#125;, mUiExecutor);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 绑定字符串缓存</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            mCallbacks.bindStringCache(mBgDataModel.stringCache.clone());</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UnifiedWorkspaceBinder</code> 的 <code>bind()</code> 函数中，首先拿到当前屏幕（就是呈现给用户的第一个屏幕）ID，然后优先往第一个屏幕上绑定内容，之后再绑定其他屏幕的内容。</p>
<h2 id="绑定屏幕"><a href="#绑定屏幕" class="headerlink" title="绑定屏幕"></a>绑定屏幕</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Launcher.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Launcher</span> <span class="keyword">extends</span> <span class="title class_">StatefulActivity</span>&lt;LauncherState&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LauncherExterns</span>, Callbacks, InvariantDeviceProfile.OnIDPChangeListener,</span><br><span class="line">        PluginListener&lt;LauncherOverlayPlugin&gt; &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bindScreens</span><span class="params">(IntArray orderedScreenIds)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 义第一个屏幕的位置索引，通常为 0</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">firstScreenPosition</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 调整首屏（默认屏幕）的位置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (FeatureFlags.QSB_ON_FIRST_SCREEN &amp;&amp;</span><br><span class="line">                orderedScreenIds.indexOf(Workspace.FIRST_SCREEN_ID) != firstScreenPosition) &#123;</span><br><span class="line">            <span class="comment">// 这一操作确保在启用了 QSB_ON_FIRST_SCREEN (Google Search 框)的情况下，默认屏幕始终位于第一个位置</span></span><br><span class="line">            orderedScreenIds.removeValue(Workspace.FIRST_SCREEN_ID);</span><br><span class="line">            orderedScreenIds.add(firstScreenPosition, Workspace.FIRST_SCREEN_ID);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!FeatureFlags.QSB_ON_FIRST_SCREEN &amp;&amp; orderedScreenIds.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 如果特性未启用且没有任何屏幕，则添加一个空屏幕</span></span><br><span class="line">            mWorkspace.addExtraEmptyScreens();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将 orderedScreenIds 绑定到工作区，这一步会将屏幕 ID 列表正式添加到 UI 中，使这些屏幕出现在工作区</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        bindAddScreens(orderedScreenIds);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 解锁壁纸偏移锁定，确保屏幕布局后壁纸位置正确</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mWorkspace.unlockWallpaperFromDefaultPageOnNextLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们继续跟踪 Launcher.bindAddScreens() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Launcher.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Launcher</span> <span class="keyword">extends</span> <span class="title class_">StatefulActivity</span>&lt;LauncherState&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LauncherExterns</span>, Callbacks, InvariantDeviceProfile.OnIDPChangeListener,</span><br><span class="line">        PluginListener&lt;LauncherOverlayPlugin&gt; &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindAddScreens</span><span class="params">(IntArray orderedScreenIds)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 检查设备配置 mDeviceProfile 是否启用了双面板模式（例如平板或大屏手机在横屏模式下显示左右分屏）</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 这里我们可以暂时不用关注</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mDeviceProfile.isTwoPanels) &#123;</span><br><span class="line">            <span class="comment">// Some empty pages might have been removed while the phone was in a single panel</span></span><br><span class="line">            <span class="comment">// mode, so we want to add those empty pages back.</span></span><br><span class="line">            <span class="type">IntSet</span> <span class="variable">screenIds</span> <span class="operator">=</span> IntSet.wrap(orderedScreenIds);</span><br><span class="line">            orderedScreenIds.forEach(screenId -&gt; screenIds.add(mWorkspace.getScreenPair(screenId)));</span><br><span class="line">            orderedScreenIds = screenIds.getArray();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取屏幕 ID 列表的总数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> orderedScreenIds.size();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 遍历 orderedScreenIds 中的每个屏幕 ID，依次进行绑定处理</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">screenId</span> <span class="operator">=</span> orderedScreenIds.get(i);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 如果 QSB_ON_FIRST_SCREEN 特性启用，并且当前屏幕 ID 为默认首屏 ID，则跳过绑定</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * 原因：默认首屏在初始化时通常已经绑定，因此无需重复绑定，节省性能开销</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (FeatureFlags.QSB_ON_FIRST_SCREEN &amp;&amp; screenId == Workspace.FIRST_SCREEN_ID) &#123;</span><br><span class="line">                <span class="comment">// No need to bind the first screen, as its always bound.</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 插入新的屏幕</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * 对于未跳过的屏幕 ID，将屏幕插入到空屏之前。这确保屏幕列表的有序显示，且空屏在屏幕序列的最后显示。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            mWorkspace.insertNewWorkspaceScreenBeforeEmptyScreen(screenId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟踪 Workspace.insertNewWorkspaceScreenBeforeEmptyScreen() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Workspace.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Workspace</span>&lt;T <span class="keyword">extends</span> <span class="title class_">View</span> &amp; PageIndicator&gt; <span class="keyword">extends</span> <span class="title class_">PagedView</span>&lt;T&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">DropTarget</span>, DragSource, View.OnTouchListener,</span><br><span class="line">        DragController.DragListener, Insettable, StateHandler&lt;LauncherState&gt;,</span><br><span class="line">        WorkspaceLayoutManager, LauncherBindableItemsContainer, LauncherOverlayCallbacks &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将新屏幕插入到空屏（如果存在空屏）之前</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertNewWorkspaceScreenBeforeEmptyScreen</span><span class="params">(<span class="type">int</span> screenId)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 首先查找 EXTRA_EMPTY_SCREEN_ID 在 mScreenOrder 中的位置</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * mScreenOrder 维护了当前屏幕的顺序</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insertIndex</span> <span class="operator">=</span> mScreenOrder.indexOf(EXTRA_EMPTY_SCREEN_ID);</span><br><span class="line">        <span class="keyword">if</span> (insertIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 如果未找到空屏，表示将新屏幕插入到最后</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            insertIndex = mScreenOrder.size();</span><br><span class="line">        &#125;</span><br><span class="line">        insertNewWorkspaceScreen(screenId, insertIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟踪 Workspace.insertNewWorkspaceScreen() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Workspace.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Workspace</span>&lt;T <span class="keyword">extends</span> <span class="title class_">View</span> &amp; PageIndicator&gt; <span class="keyword">extends</span> <span class="title class_">PagedView</span>&lt;T&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">DropTarget</span>, DragSource, View.OnTouchListener,</span><br><span class="line">        DragController.DragListener, Insettable, StateHandler&lt;LauncherState&gt;,</span><br><span class="line">        WorkspaceLayoutManager, LauncherBindableItemsContainer, LauncherOverlayCallbacks &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 负责实际的屏幕布局创建和插入操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> CellLayout <span class="title function_">insertNewWorkspaceScreen</span><span class="params">(<span class="type">int</span> screenId, <span class="type">int</span> insertIndex)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 检查屏幕是否已存在</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 如果 mWorkspaceScreens 中已经存在相同的 screenId，则抛出异常，避免重复插入相同 ID 的屏幕</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mWorkspaceScreens.containsKey(screenId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Screen id &quot;</span> + screenId + <span class="string">&quot; already exists!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取设备配置 DeviceProfile，用于决定布局文件的选择</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">DeviceProfile</span> <span class="variable">dp</span> <span class="operator">=</span> mLauncher.getDeviceProfile();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 定义新的 CellLayout 实例</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        CellLayout newScreen;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 选择布局文件，根据特性标志 FOLDABLE_SINGLE_PAGE 和设备是否为双面板模式选择布局文件</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         *     折叠设备：如果为折叠屏设备并处于双面板模式，使用 R.layout.workspace_screen_foldable 布局文件</span></span><br><span class="line"><span class="comment">         *     普通设备：否则使用标准布局文件 R.layout.workspace_screen</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (FOLDABLE_SINGLE_PAGE.get() &amp;&amp; dp.isTwoPanels) &#123;</span><br><span class="line">            newScreen = (CellLayout) LayoutInflater.from(getContext()).inflate(</span><br><span class="line">                    R.layout.workspace_screen_foldable, <span class="built_in">this</span>, <span class="literal">false</span> <span class="comment">/* attachToRoot */</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            newScreen = (CellLayout) LayoutInflater.from(getContext()).inflate(</span><br><span class="line">                    R.layout.workspace_screen, <span class="built_in">this</span>, <span class="literal">false</span> <span class="comment">/* attachToRoot */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将新创建的 CellLayout 以 screenId 为键添加到 mWorkspaceScreens 映射中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mWorkspaceScreens.put(screenId, newScreen);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将 screenId 按顺序插入 mScreenOrder 中，以维护正确的屏幕顺序</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mScreenOrder.add(insertIndex, screenId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将新屏幕布局视图插入到 Workspace 视图的 insertIndex 位置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        addView(newScreen, insertIndex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 根据当前状态为新屏幕应用过渡动画，确保新屏幕以正确的动画效果出现在工作区中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mStateTransitionAnimation.applyChildState(</span><br><span class="line">                mLauncher.getStateManager().getState(), newScreen, insertIndex);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 更新页面滚动值，使得页面滚动效果适应新布局</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        updatePageScrollValues();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 整新布局的填充（padding），确保布局之间的间距统一</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        updateCellLayoutPadding();</span><br><span class="line">        <span class="keyword">return</span> newScreen;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="绑定数据内容"><a href="#绑定数据内容" class="headerlink" title="绑定数据内容"></a>绑定数据内容</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLauncherBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">UnifiedWorkspaceBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将工作区中的项目分块绑定到 UI</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindWorkspaceItems</span><span class="params">(</span></span><br><span class="line"><span class="params">                <span class="keyword">final</span> ArrayList&lt;ItemInfo&gt; workspaceItems, <span class="keyword">final</span> Executor executor)</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 获取 workspaceItems 列表中的项目总数</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> workspaceItems.size();</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 分块绑定项目</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * ITEMS_CHUNK 是块大小的常量，用于定义每次绑定的最大项目数量，默认为 6</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i += ITEMS_CHUNK) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 块的起始位置</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> i;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 当前块的大小</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">chunkSize</span> <span class="operator">=</span> (i + ITEMS_CHUNK &lt;= count) ? ITEMS_CHUNK : (count - i);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 执行绑定任务</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                executeCallbacksTask(</span><br><span class="line">                        c -&gt; c.bindItems(workspaceItems.subList(start, start + chunkSize), <span class="literal">false</span>),</span><br><span class="line">                        executor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 Launcher.bindItems() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Launcher.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Launcher</span> <span class="keyword">extends</span> <span class="title class_">StatefulActivity</span>&lt;LauncherState&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LauncherExterns</span>, Callbacks, InvariantDeviceProfile.OnIDPChangeListener,</span><br><span class="line">        PluginListener&lt;LauncherOverlayPlugin&gt; &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bindItems</span><span class="params">(<span class="keyword">final</span> List&lt;ItemInfo&gt; items, <span class="keyword">final</span> <span class="type">boolean</span> forceAnimateIcons)</span> &#123;</span><br><span class="line">        bindItems(items, forceAnimateIcons, <span class="comment">/* focusFirstItemForAccessibility= */</span> <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bindItems</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> List&lt;ItemInfo&gt; items,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="type">boolean</span> forceAnimateIcons,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="type">boolean</span> focusFirstItemForAccessibility)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 用于存储新 Item 的动画效果</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">final</span> Collection&lt;Animator&gt; bounceAnims = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 判断是否允许页面切换动画</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">canAnimatePageChange</span> <span class="operator">=</span> canAnimatePageChange();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * workspace        : 获取工作区引用，便于操作屏幕和布局</span></span><br><span class="line"><span class="comment">         * newItemsScreenId : 用于跟踪新项目的屏幕 ID，以便后续页面切换</span></span><br><span class="line"><span class="comment">         * newView          : 将保存第一个绑定的视图，以便在无障碍模式下获得焦点</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Workspace&lt;?&gt; workspace = mWorkspace;</span><br><span class="line">        <span class="type">int</span> <span class="variable">newItemsScreenId</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> items.size();</span><br><span class="line">        <span class="type">View</span> <span class="variable">newView</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 遍历 items 列表中的每个 ItemInfo 项目</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; end; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ItemInfo</span> <span class="variable">item</span> <span class="operator">=</span> items.get(i);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 如果项目属于 Hotseat 容器，但 mHotseat 为 null，则跳过该项目，</span></span><br><span class="line"><span class="comment">             * 因为 Hotseat 为空时不能加载这些项目</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (item.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT &amp;&amp;</span><br><span class="line">                    mHotseat == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 根据 item 类型创建视图</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">final</span> View view;</span><br><span class="line">            <span class="keyword">switch</span> (item.itemType) &#123;</span><br><span class="line">                <span class="comment">// 快捷方式或应用</span></span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPLICATION:</span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_SHORTCUT:</span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_DEEP_SHORTCUT: &#123;</span><br><span class="line">                    <span class="type">WorkspaceItemInfo</span> <span class="variable">info</span> <span class="operator">=</span> (WorkspaceItemInfo) item;</span><br><span class="line">                    <span class="comment">// 创建快捷方式视图</span></span><br><span class="line">                    view = createShortcut(info);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 文件夹</span></span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_FOLDER: &#123;</span><br><span class="line">                    <span class="comment">// 创建文件夹视图</span></span><br><span class="line">                    view = FolderIcon.inflateFolderAndIcon(R.layout.folder_icon, <span class="built_in">this</span>,</span><br><span class="line">                            (ViewGroup) workspace.getChildAt(workspace.getCurrentPage()),</span><br><span class="line">                            (FolderInfo) item);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 应用对</span></span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APP_PAIR: &#123;</span><br><span class="line">                    <span class="type">FolderInfo</span> <span class="variable">info</span> <span class="operator">=</span> (FolderInfo) item;</span><br><span class="line">                    <span class="comment">// TODO (jeremysim b/274189428): Create app pair icon</span></span><br><span class="line">                    <span class="comment">// 暂未实现绑定逻辑</span></span><br><span class="line">                    view = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 小部件</span></span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPWIDGET:</span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_CUSTOM_APPWIDGET: &#123;</span><br><span class="line">                    <span class="comment">// 生成小部件视图</span></span><br><span class="line">                    view = inflateAppWidget((LauncherAppWidgetInfo) item);</span><br><span class="line">                    <span class="keyword">if</span> (view == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 其他类型将抛出异常</span></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Invalid Item Type&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 主要处理位置冲突</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * presenterPos: 映射项目在布局中的位置</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">CellPos</span> <span class="variable">presenterPos</span> <span class="operator">=</span> getCellPosMapper().mapModelToPresenter(item);</span><br><span class="line">            <span class="keyword">if</span> (item.container == CONTAINER_DESKTOP) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 检查 CellLayout 中的位置是否已被占用</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="type">CellLayout</span> <span class="variable">cl</span> <span class="operator">=</span> mWorkspace.getScreenWithId(presenterPos.screenId);</span><br><span class="line">                <span class="keyword">if</span> (cl != <span class="literal">null</span> &amp;&amp; cl.isOccupied(presenterPos.cellX, presenterPos.cellY)) &#123;</span><br><span class="line">                    <span class="type">View</span> <span class="variable">v</span> <span class="operator">=</span> cl.getChildAt(presenterPos.cellX, presenterPos.cellY);</span><br><span class="line">                    <span class="keyword">if</span> (v == <span class="literal">null</span>) &#123;</span><br><span class="line">                        Log.e(TAG, <span class="string">&quot;bindItems failed when removing colliding item=&quot;</span> + item);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">tag</span> <span class="operator">=</span> v.getTag();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">desc</span> <span class="operator">=</span> <span class="string">&quot;Collision while binding workspace item: &quot;</span> + item</span><br><span class="line">                            + <span class="string">&quot;. Collides with &quot;</span> + tag;</span><br><span class="line">                    <span class="keyword">if</span> (FeatureFlags.IS_STUDIO_BUILD) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> (<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(desc));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                         * 从数据库删除冲突项目，避免重复显示</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        getModelWriter().deleteItemFromDatabase(item, desc);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 将项目视图添加到工作区的指定屏幕和位置</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            workspace.addInScreenFromBind(view, item);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 动画处理</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * 如果 forceAnimateIcons 为 true，为新添加的项目执行动画</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (forceAnimateIcons) &#123;</span><br><span class="line">                <span class="comment">// 初始化视图的透明度和缩放，准备动画</span></span><br><span class="line">                view.setAlpha(<span class="number">0f</span>);</span><br><span class="line">                view.setScaleX(<span class="number">0f</span>);</span><br><span class="line">                view.setScaleY(<span class="number">0f</span>);</span><br><span class="line">                <span class="comment">// 创建并添加 &quot;弹跳&quot; 动画</span></span><br><span class="line">                bounceAnims.add(createNewAppBounceAnimation(view, i));</span><br><span class="line">                newItemsScreenId = presenterPos.screenId;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (newView == <span class="literal">null</span>) &#123;</span><br><span class="line">                newView = view;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="type">View</span> <span class="variable">viewToFocus</span> <span class="operator">=</span> newView;</span><br><span class="line">        <span class="comment">// Animate to the correct pager</span></span><br><span class="line">        <span class="keyword">if</span> (forceAnimateIcons &amp;&amp; newItemsScreenId &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">AnimatorSet</span> <span class="variable">anim</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnimatorSet</span>();</span><br><span class="line">            anim.playTogether(bounceAnims);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 无障碍焦点</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (focusFirstItemForAccessibility &amp;&amp; viewToFocus != <span class="literal">null</span>) &#123;</span><br><span class="line">                anim.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                        <span class="comment">/**</span></span><br><span class="line"><span class="comment">                         * 如果启用了无障碍焦点并且有可聚焦视图，则在动画结束后触发无障碍事件</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        viewToFocus.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_FOCUSED);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 页面切换逻辑</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">currentScreenId</span> <span class="operator">=</span> mWorkspace.getScreenIdForPageIndex(mWorkspace.getNextPage());</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">newScreenIndex</span> <span class="operator">=</span> mWorkspace.getPageIndexForScreenId(newItemsScreenId);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">startBounceAnimRunnable</span> <span class="operator">=</span> anim::start;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (canAnimatePageChange &amp;&amp; newItemsScreenId != currentScreenId) &#123;</span><br><span class="line">                <span class="comment">// We post the animation slightly delayed to prevent slowdowns</span></span><br><span class="line">                <span class="comment">// when we are loading right after we return to launcher.</span></span><br><span class="line">                mWorkspace.postDelayed(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mWorkspace != <span class="literal">null</span>) &#123;</span><br><span class="line">                            closeOpenViews(<span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line">                            mWorkspace.snapToPage(newScreenIndex);</span><br><span class="line">                            mWorkspace.postDelayed(startBounceAnimRunnable,</span><br><span class="line">                                    NEW_APPS_ANIMATION_DELAY);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, NEW_APPS_PAGE_MOVE_DELAY);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mWorkspace.postDelayed(startBounceAnimRunnable, NEW_APPS_ANIMATION_DELAY);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (focusFirstItemForAccessibility &amp;&amp; viewToFocus != <span class="literal">null</span>) &#123;</span><br><span class="line">            viewToFocus.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_FOCUSED);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 刷新工作区布局，确保项目正确显示</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        workspace.requestLayout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟踪 WorkspaceLayoutManager.addInScreenFromBind() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/WorkspaceLayoutManager.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WorkspaceLayoutManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">addInScreenFromBind</span><span class="params">(View child, ItemInfo info)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将 ItemInfo 的布局信息映射到视图的呈现位置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">CellPos</span> <span class="variable">presenterPos</span> <span class="operator">=</span> getCellPosMapper().mapModelToPresenter(info);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * x 和 y 是项目在工作区布局中的网格坐标，初始值为映射得到的 cellX 和 cellY</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> presenterPos.cellX;</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> presenterPos.cellY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 如果 ItemInfo 表示的项目属于 Hotseat 容器，则需要根据 Hotseat 的位置规则来计算准确的坐标</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (info.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT</span><br><span class="line">                || info.container == LauncherSettings.Favorites.CONTAINER_HOTSEAT_PREDICTION) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">screenId</span> <span class="operator">=</span> presenterPos.screenId;</span><br><span class="line">            x = getHotseat().getCellXFromOrder(screenId);</span><br><span class="line">            y = getHotseat().getCellYFromOrder(screenId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将 child 视图添加到工作区中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        addInScreen(child, info.container, presenterPos.screenId, x, y, info.spanX, info.spanY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟踪 WorkspaceLayoutManager.addInScreen() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/WorkspaceLayoutManager.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WorkspaceLayoutManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * child      ：要添加的视图组件</span></span><br><span class="line"><span class="comment">     * container  ：容器类型，决定了视图应放置的位置（例如桌面或 Hotseat）</span></span><br><span class="line"><span class="comment">     * screenId   ：屏幕 ID，用于标识视图所在的屏幕</span></span><br><span class="line"><span class="comment">     * x/y        ：视图在网格中的坐标</span></span><br><span class="line"><span class="comment">     * spanX/spanY：视图占用的网格跨度，决定了视图的大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">addInScreen</span><span class="params">(View child, <span class="type">int</span> container, <span class="type">int</span> screenId, <span class="type">int</span> x, <span class="type">int</span> y,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> spanX, <span class="type">int</span> spanY)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 检查 Desktop 屏幕的有效性</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 若容器为 Desktop（桌面），首先检查 screenId 是否有效</span></span><br><span class="line"><span class="comment">         * 如果对应的屏幕不存在，记录错误信息并打印堆栈跟踪，便于调试，然后直接返回，跳过添加操作</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (container == LauncherSettings.Favorites.CONTAINER_DESKTOP) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getScreenWithId(screenId) == <span class="literal">null</span>) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Skipping child, screenId &quot;</span> + screenId + <span class="string">&quot; not found&quot;</span>);</span><br><span class="line">                <span class="comment">// DEBUGGING - Print out the stack trace to see where we are adding from</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Throwable</span>().printStackTrace();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 检查是否为额外的空屏</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (EXTRA_EMPTY_SCREEN_IDS.contains(screenId)) &#123;</span><br><span class="line">            <span class="comment">// This should never happen</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Screen id should not be extra empty screen: &quot;</span> + screenId);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 根据容器类型（Desktop 或 Hotseat）确定目标布局</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">final</span> CellLayout layout;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 容器类型：Hotseat</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (container == LauncherSettings.Favorites.CONTAINER_HOTSEAT</span><br><span class="line">                || container == LauncherSettings.Favorites.CONTAINER_HOTSEAT_PREDICTION) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 调用 getHotseat() 获取 Hotseat 布局</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            layout = getHotseat();</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 隐藏文件夹图标的标题（FolderIcon）</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (child <span class="keyword">instanceof</span> FolderIcon) &#123;</span><br><span class="line">                ((FolderIcon) child).setTextVisible(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 容器类型：Desktop</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * 显示文件夹图标的标题</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (child <span class="keyword">instanceof</span> FolderIcon) &#123;</span><br><span class="line">                ((FolderIcon) child).setTextVisible(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 通过 screenId 获取屏幕对应的 CellLayout</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            layout = getScreenWithId(screenId);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置布局参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ViewGroup.<span class="type">LayoutParams</span> <span class="variable">genericLp</span> <span class="operator">=</span> child.getLayoutParams();</span><br><span class="line">        CellLayoutLayoutParams lp;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 新建或重用布局参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (genericLp == <span class="literal">null</span> || !(genericLp <span class="keyword">instanceof</span> CellLayoutLayoutParams)) &#123;</span><br><span class="line">            lp = <span class="keyword">new</span> <span class="title class_">CellLayoutLayoutParams</span>(x, y, spanX, spanY);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lp = (CellLayoutLayoutParams) genericLp;</span><br><span class="line">            lp.setCellX(x);</span><br><span class="line">            lp.setCellY(y);</span><br><span class="line">            lp.cellHSpan = spanX;</span><br><span class="line">            lp.cellVSpan = spanY;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 是否锁定网格</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (spanX &lt; <span class="number">0</span> &amp;&amp; spanY &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            lp.isLockedToGrid = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取子视图的唯一 ID</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 获取视图的 ItemInfo 数据，从中提取唯一的 childId，便于后续在布局中标识该视图</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">ItemInfo</span> <span class="variable">info</span> <span class="operator">=</span> (ItemInfo) child.getTag();</span><br><span class="line">        <span class="type">int</span> <span class="variable">childId</span> <span class="operator">=</span> info.getViewId();</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 如果视图是文件夹（Folder），不标记单元格为已占用，否则标记为已占用</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">markCellsAsOccupied</span> <span class="operator">=</span> !(child <span class="keyword">instanceof</span> Folder);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 调用 layout.addViewToCellLayout 将视图添加到布局网格中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!layout.addViewToCellLayout(child, -<span class="number">1</span>, childId, lp, markCellsAsOccupied)) &#123;</span><br><span class="line">            <span class="comment">// 若添加失败（即视图超出网格限制），记录错误日志</span></span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Failed to add to item at (&quot;</span> + lp.getCellX() + <span class="string">&quot;,&quot;</span> + lp.getCellY()</span><br><span class="line">                    + <span class="string">&quot;) to CellLayout&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 禁用触觉反馈</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        child.setHapticFeedbackEnabled(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置长按监听器，以支持长按操作（通常用于拖放或显示选项）</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        child.setOnLongClickListener(getWorkspaceChildOnLongClickListener());</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 如果视图是 DropTarget（可拖放的目标），调用 onAddDropTarget 进行注册</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (child <span class="keyword">instanceof</span> DropTarget) &#123;</span><br><span class="line">            onAddDropTarget((DropTarget) child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟踪：CellLayout.addViewToCellLayout()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/CellLayout.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CellLayout</span> <span class="keyword">extends</span> <span class="title class_">ViewGroup</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addViewToCellLayout</span><span class="params">(View child, <span class="type">int</span> index, <span class="type">int</span> childId,</span></span><br><span class="line"><span class="params">            CellLayoutLayoutParams params, <span class="type">boolean</span> markCells)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将传入的布局参数 params 赋值给 lp，便于后续使用</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">CellLayoutLayoutParams</span> <span class="variable">lp</span> <span class="operator">=</span> params;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 处理 Hotseat 图标文本可见性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (child <span class="keyword">instanceof</span> BubbleTextView) &#123;</span><br><span class="line">            <span class="type">BubbleTextView</span> <span class="variable">bubbleChild</span> <span class="operator">=</span> (BubbleTextView) child;</span><br><span class="line">            bubbleChild.setTextVisibility(mContainerType != HOTSEAT);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置视图缩放</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        child.setScaleX(mChildScale);</span><br><span class="line">        child.setScaleY(mChildScale);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 验证并设置位置和跨度</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (lp.getCellX() &gt;= <span class="number">0</span> &amp;&amp; lp.getCellX() &lt;= mCountX - <span class="number">1</span></span><br><span class="line">                &amp;&amp; lp.getCellY() &gt;= <span class="number">0</span> &amp;&amp; lp.getCellY() &lt;= mCountY - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// If the horizontal or vertical span is set to -1, it is taken to</span></span><br><span class="line">            <span class="comment">// mean that it spans the extent of the CellLayout</span></span><br><span class="line">            <span class="keyword">if</span> (lp.cellHSpan &lt; <span class="number">0</span>) lp.cellHSpan = mCountX;</span><br><span class="line">            <span class="keyword">if</span> (lp.cellVSpan &lt; <span class="number">0</span>) lp.cellVSpan = mCountY;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 为 child 视图设置唯一的 ID（childId），便于后续操作中唯一标识该视图</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            child.setId(childId);</span><br><span class="line">            <span class="keyword">if</span> (LOGD) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;Adding view to ShortcutsAndWidgetsContainer: &quot;</span> + child);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 将视图添加到 mShortcutsAndWidgets（包含所有图标和小部件的容器）中，</span></span><br><span class="line"><span class="comment">             * 位置由 index 指定，布局参数由 lp 提供</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            mShortcutsAndWidgets.addView(child, index, lp);</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 标记单元格为已占用，防止其他项目重叠在相同位置</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (markCells) markCellsAsOccupiedForView(child);</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="绑定-Widget"><a href="#绑定-Widget" class="headerlink" title="绑定 Widget"></a>绑定 Widget</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/model/BaseLauncherBinder.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLauncherBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">UnifiedWorkspaceBinder</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindAppWidgets</span><span class="params">(List&lt;LauncherAppWidgetInfo&gt; appWidgets, Executor executor)</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 计算小部件列表的大小，以便在循环中逐个绑定每个小部件</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> appWidgets.size();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 遍历 appWidgets 列表中的每个小部件</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 将当前小部件信息保存到 widget 变量中</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">ItemInfo</span> <span class="variable">widget</span> <span class="operator">=</span> appWidgets.get(i);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 将当前小部件绑定到工作区</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                executeCallbacksTask(</span><br><span class="line">                        c -&gt; c.bindItems(Collections.singletonList(widget), <span class="literal">false</span>), executor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 Launcher.bindItems() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Launcher.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Launcher</span> <span class="keyword">extends</span> <span class="title class_">StatefulActivity</span>&lt;LauncherState&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LauncherExterns</span>, Callbacks, InvariantDeviceProfile.OnIDPChangeListener,</span><br><span class="line">        PluginListener&lt;LauncherOverlayPlugin&gt; &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bindItems</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> List&lt;ItemInfo&gt; items,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="type">boolean</span> forceAnimateIcons,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> <span class="type">boolean</span> focusFirstItemForAccessibility)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 遍历 items 列表中的每个 ItemInfo 项目</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; end; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ItemInfo</span> <span class="variable">item</span> <span class="operator">=</span> items.get(i);</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 根据 item 类型创建视图</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">final</span> View view;</span><br><span class="line">            <span class="keyword">switch</span> (item.itemType) &#123;</span><br><span class="line">                ...</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 小部件</span></span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPWIDGET:</span><br><span class="line">                <span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_CUSTOM_APPWIDGET: &#123;</span><br><span class="line">                    <span class="comment">// 生成小部件视图</span></span><br><span class="line">                    view = inflateAppWidget((LauncherAppWidgetInfo) item);</span><br><span class="line">                    <span class="keyword">if</span> (view == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 其他类型将抛出异常</span></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Invalid Item Type&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 刷新工作区布局，确保项目正确显示</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        workspace.requestLayout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以我们继续跟踪 <code>inflateAppWidget()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">📄 源码路径：<span class="keyword">package</span>/app/Launcher3/src/com/android/launcher3/Launcher.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Launcher</span> <span class="keyword">extends</span> <span class="title class_">StatefulActivity</span>&lt;LauncherState&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">LauncherExterns</span>, Callbacks, InvariantDeviceProfile.OnIDPChangeListener,</span><br><span class="line">        PluginListener&lt;LauncherOverlayPlugin&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> View <span class="title function_">inflateAppWidget</span><span class="params">(LauncherAppWidgetInfo item)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 搜索小部件处理</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (item.hasOptionFlag(LauncherAppWidgetInfo.OPTION_SEARCH_WIDGET)) &#123;</span><br><span class="line">            item.providerName = QsbContainerView.getSearchComponentName(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (item.providerName == <span class="literal">null</span>) &#123;</span><br><span class="line">                getModelWriter().deleteItemFromDatabase(item,</span><br><span class="line">                        <span class="string">&quot;search widget removed because search component cannot be found&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> AppWidgetHostView view;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 如果设备处于安全模式，使用 PendingAppWidgetHostView 创建一个挂起的小部件视图，并返回该视图</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mIsSafeModeEnabled) &#123;</span><br><span class="line">            view = <span class="keyword">new</span> <span class="title class_">PendingAppWidgetHostView</span>(<span class="built_in">this</span>, item, mIconCache, <span class="literal">true</span>);</span><br><span class="line">            prepareAppWidget(view, item);</span><br><span class="line">            <span class="keyword">return</span> view;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 性能跟踪初始化</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">traceToken</span> <span class="operator">=</span> TraceHelper.INSTANCE.beginSection(<span class="string">&quot;BIND_WIDGET_id=&quot;</span> + item.appWidgetId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 绑定小部件的状态检查与处理</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> LauncherAppWidgetProviderInfo appWidgetInfo;</span><br><span class="line">            <span class="type">String</span> <span class="variable">removalReason</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 表示小部件提供者未准备好</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY)) &#123;</span><br><span class="line">                <span class="comment">// If the provider is not ready, bind as a pending widget.</span></span><br><span class="line">                appWidgetInfo = <span class="literal">null</span>;</span><br><span class="line">                removalReason = <span class="string">&quot;the provider isn&#x27;t ready.&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID)) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 小部件 ID 无效，，根据 providerName 找到小部件的提供者</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                appWidgetInfo = mAppWidgetManager.findProvider(item.providerName, item.user);</span><br><span class="line">                <span class="keyword">if</span> (appWidgetInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (WidgetsModel.GO_DISABLE_WIDGETS) &#123;</span><br><span class="line">                        removalReason = <span class="string">&quot;widgets are disabled on go device.&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        removalReason =</span><br><span class="line">                                <span class="string">&quot;WidgetManagerHelper cannot find a provider from provider info.&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 正常绑定</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                appWidgetInfo = mAppWidgetManager.getLauncherAppWidgetInfo(item.appWidgetId);</span><br><span class="line">                <span class="keyword">if</span> (appWidgetInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (item.appWidgetId &lt;= LauncherAppWidgetInfo.CUSTOM_WIDGET_ID) &#123;</span><br><span class="line">                        removalReason =</span><br><span class="line">                                <span class="string">&quot;CustomWidgetManager cannot find provider from that widget id.&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        removalReason = <span class="string">&quot;AppWidgetManager cannot find provider for that widget id.&quot;</span></span><br><span class="line">                                + <span class="string">&quot; It could be because AppWidgetService is not available, or the&quot;</span></span><br><span class="line">                                + <span class="string">&quot; appWidgetId has not been bound to a the provider yet, or you&quot;</span></span><br><span class="line">                                + <span class="string">&quot; don&#x27;t have access to that appWidgetId.&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the provider is ready, but the width is not yet restored, try to restore it.</span></span><br><span class="line">            <span class="keyword">if</span> (!item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_PROVIDER_NOT_READY)</span><br><span class="line">                    &amp;&amp; (item.restoreStatus != LauncherAppWidgetInfo.RESTORE_COMPLETED)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (appWidgetInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                    getModelWriter().deleteItemFromDatabase(item,</span><br><span class="line">                            <span class="string">&quot;Removing restored widget: id=&quot;</span> + item.appWidgetId</span><br><span class="line">                                    + <span class="string">&quot; belongs to component &quot;</span> + item.providerName + <span class="string">&quot; user &quot;</span> + item.user</span><br><span class="line">                                    + <span class="string">&quot;, as the provider is null and &quot;</span> + removalReason);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If we do not have a valid id, try to bind an id.</span></span><br><span class="line">                <span class="keyword">if</span> (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_ALLOCATED)) &#123;</span><br><span class="line">                        <span class="comment">// Id has not been allocated yet. Allocate a new id.</span></span><br><span class="line">                        item.appWidgetId = mAppWidgetHolder.allocateAppWidgetId();</span><br><span class="line">                        item.restoreStatus |= LauncherAppWidgetInfo.FLAG_ID_ALLOCATED;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Also try to bind the widget. If the bind fails, the user will be shown</span></span><br><span class="line">                        <span class="comment">// a click to setup UI, which will ask for the bind permission.</span></span><br><span class="line">                        <span class="type">PendingAddWidgetInfo</span> <span class="variable">pendingInfo</span> <span class="operator">=</span></span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">PendingAddWidgetInfo</span>(appWidgetInfo, item.sourceContainer);</span><br><span class="line">                        pendingInfo.spanX = item.spanX;</span><br><span class="line">                        pendingInfo.spanY = item.spanY;</span><br><span class="line">                        pendingInfo.minSpanX = item.minSpanX;</span><br><span class="line">                        pendingInfo.minSpanY = item.minSpanY;</span><br><span class="line">                        <span class="type">Bundle</span> <span class="variable">options</span> <span class="operator">=</span> pendingInfo.getDefaultSizeOptions(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">isDirectConfig</span> <span class="operator">=</span></span><br><span class="line">                                item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_DIRECT_CONFIG);</span><br><span class="line">                        <span class="keyword">if</span> (isDirectConfig &amp;&amp; item.bindOptions != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="type">Bundle</span> <span class="variable">newOptions</span> <span class="operator">=</span> item.bindOptions.getExtras();</span><br><span class="line">                            <span class="keyword">if</span> (options != <span class="literal">null</span>) &#123;</span><br><span class="line">                                newOptions.putAll(options);</span><br><span class="line">                            &#125;</span><br><span class="line">                            options = newOptions;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> mAppWidgetManager.bindAppWidgetIdIfAllowed(</span><br><span class="line">                                item.appWidgetId, appWidgetInfo, options);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// We tried to bind once. If we were not able to bind, we would need to</span></span><br><span class="line">                        <span class="comment">// go through the permission dialog, which means we cannot skip the config</span></span><br><span class="line">                        <span class="comment">// activity.</span></span><br><span class="line">                        item.bindOptions = <span class="literal">null</span>;</span><br><span class="line">                        item.restoreStatus &amp;= ~LauncherAppWidgetInfo.FLAG_DIRECT_CONFIG;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Bind succeeded</span></span><br><span class="line">                        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                            <span class="comment">// If the widget has a configure activity, it is still needs to set it</span></span><br><span class="line">                            <span class="comment">// up, otherwise the widget is ready to go.</span></span><br><span class="line">                            item.restoreStatus = (appWidgetInfo.configure == <span class="literal">null</span>) || isDirectConfig</span><br><span class="line">                                    ? LauncherAppWidgetInfo.RESTORE_COMPLETED</span><br><span class="line">                                    : LauncherAppWidgetInfo.FLAG_UI_NOT_READY;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        getModelWriter().updateItemInDatabase(item);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_UI_NOT_READY)</span><br><span class="line">                        &amp;&amp; (appWidgetInfo.configure == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    <span class="comment">// The widget was marked as UI not ready, but there is no configure activity to</span></span><br><span class="line">                    <span class="comment">// update the UI.</span></span><br><span class="line">                    item.restoreStatus = LauncherAppWidgetInfo.RESTORE_COMPLETED;</span><br><span class="line">                    getModelWriter().updateItemInDatabase(item);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_UI_NOT_READY)</span><br><span class="line">                        &amp;&amp; appWidgetInfo.configure != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mAppWidgetManager.isAppWidgetRestored(item.appWidgetId)) &#123;</span><br><span class="line">                        item.restoreStatus = LauncherAppWidgetInfo.RESTORE_COMPLETED;</span><br><span class="line">                        getModelWriter().updateItemInDatabase(item);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 小部件视图创建与返回</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (item.restoreStatus == LauncherAppWidgetInfo.RESTORE_COMPLETED) &#123;</span><br><span class="line">                <span class="comment">// Verify that we own the widget</span></span><br><span class="line">                <span class="keyword">if</span> (appWidgetInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                    FileLog.e(TAG, <span class="string">&quot;Removing invalid widget: id=&quot;</span> + item.appWidgetId);</span><br><span class="line">                    getModelWriter().deleteWidgetInfo(item, getAppWidgetHolder(), removalReason);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                item.minSpanX = appWidgetInfo.minSpanX;</span><br><span class="line">                item.minSpanY = appWidgetInfo.minSpanY;</span><br><span class="line">                view = mAppWidgetHolder.createView(<span class="built_in">this</span>, item.appWidgetId, appWidgetInfo);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!item.hasRestoreFlag(LauncherAppWidgetInfo.FLAG_ID_NOT_VALID)</span><br><span class="line">                    &amp;&amp; appWidgetInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                mAppWidgetHolder.addPendingView(item.appWidgetId,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">PendingAppWidgetHostView</span>(<span class="built_in">this</span>, item, mIconCache, <span class="literal">false</span>));</span><br><span class="line">                view = mAppWidgetHolder.createView(<span class="built_in">this</span>, item.appWidgetId, appWidgetInfo);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                view = <span class="keyword">new</span> <span class="title class_">PendingAppWidgetHostView</span>(<span class="built_in">this</span>, item, mIconCache, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 小部件准备</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            prepareAppWidget(view, item);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            TraceHelper.INSTANCE.endSection(traceToken);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>揭开 LoaderTask 的数据加载奥秘 -- Workspace</p><p><a href="http://example.com/2024/10/25/launcher/Android -- Launcher3 -- 02. 揭开 LoaderTask 的数据加载奥秘 -- workspace/">http://example.com/2024/10/25/launcher/Android -- Launcher3 -- 02. 揭开 LoaderTask 的数据加载奥秘 -- workspace/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Marco</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-10-25</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-07-20</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Launcher3/">Launcher3</a><a class="link-muted mr-2" rel="tag" href="/tags/Android-14-0/">Android 14.0</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/11/01/launcher/Android%20--%20Launcher3%20--%2003.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%20--%20allapps/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">揭开 LoaderTask 的数据加载奥秘 -- AllApps</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/10/23/launcher/Android%20--%20Launcher3%20--%2001.%20%E6%8F%AD%E5%BC%80%20LoaderTask%20%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%A5%A5%E7%A7%98%EF%BC%88%E5%88%9D%E6%8E%A2%EF%BC%89/"><span class="level-item">LoaderTask 的数据加载奥秘 -- 初探</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/2025/08/01/compose/Compose%20--%20%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85%20&amp;%20%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%20--%2001.%20%E8%A7%A3%E6%9E%90%20mutableStateOf%20%E6%BA%90%E7%A0%81/"><img src="/gallery/covers/compose/cover_compose_1.png" alt="解析 mutableStateOf 源码"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-07-31T16:00:00.000Z">2025-08-01</time></p><p class="title"><a href="/2025/08/01/compose/Compose%20--%20%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85%20&amp;%20%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%20--%2001.%20%E8%A7%A3%E6%9E%90%20mutableStateOf%20%E6%BA%90%E7%A0%81/">解析 mutableStateOf 源码</a></p><p class="categories"><a href="/categories/Compose/">Compose</a> / <a href="/categories/Compose/%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/">状态订阅 &amp; 自动更新</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/07/25/kotlin/Kotlin%20--%20%E5%8D%8F%E7%A8%8B%20--%2002.%20Channel_Flow/"><img src="/gallery/covers/kotlin/channel_flow.png" alt="Channel &amp; Flow"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-07-24T16:00:00.000Z">2025-07-25</time></p><p class="title"><a href="/2025/07/25/kotlin/Kotlin%20--%20%E5%8D%8F%E7%A8%8B%20--%2002.%20Channel_Flow/">Channel &amp; Flow</a></p><p class="categories"><a href="/categories/Kotlin/">Kotlin</a> / <a href="/categories/Kotlin/Channel/">Channel</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/07/20/kotlin/Kotlin%20--%20%E5%8D%8F%E7%A8%8B%20--%2001.%20%E5%8D%8F%E7%A8%8B%E5%85%A5%E9%97%A8%20copy/"><img src="/gallery/covers/kotlin/coroutines.jpg" alt="这是一篇通俗易懂的「协程」入门指南"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-07-19T16:00:00.000Z">2025-07-20</time></p><p class="title"><a href="/2025/07/20/kotlin/Kotlin%20--%20%E5%8D%8F%E7%A8%8B%20--%2001.%20%E5%8D%8F%E7%A8%8B%E5%85%A5%E9%97%A8%20copy/">这是一篇通俗易懂的「协程」入门指南</a></p><p class="categories"><a href="/categories/Kotlin/">Kotlin</a> / <a href="/categories/Kotlin/%E5%8D%8F%E7%A8%8B/">协程</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/06/26/settings/Settings%20--%20%E5%8F%8C%E6%A0%8F%E8%A7%A3%E6%9E%90/"><img src="/gallery/covers/android/settings.jpg" alt="Settings「源码解析系列」-- 单/双栏原理"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-06-25T16:00:00.000Z">2025-06-26</time></p><p class="title"><a href="/2025/06/26/settings/Settings%20--%20%E5%8F%8C%E6%A0%8F%E8%A7%A3%E6%9E%90/">Settings「源码解析系列」-- 单/双栏原理</a></p><p class="categories"><a href="/categories/Android/">Android</a> / <a href="/categories/Android/Settings/">Settings</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2025/05/20/jetpack/Jetpack%20%E4%BF%9D%E5%A7%86%E6%95%99%E7%A8%8B%20--%20ROOM/"><img src="/gallery/covers/jetpack/room.jpg" alt="Jetpack「保姆教程」-- ROOM"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-05-19T16:00:00.000Z">2025-05-20</time></p><p class="title"><a href="/2025/05/20/jetpack/Jetpack%20%E4%BF%9D%E5%A7%86%E6%95%99%E7%A8%8B%20--%20ROOM/">Jetpack「保姆教程」-- ROOM</a></p><p class="categories"><a href="/categories/Kotlin/">Kotlin</a> / <a href="/categories/Kotlin/%E5%8D%8F%E7%A8%8B/">协程</a></p></div></article></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#加载-Workspace-流程解析"><span class="level-left"><span class="level-item">2</span><span class="level-item">加载 Workspace 流程解析</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#加载默认桌面布局"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">加载默认桌面布局</span></span></a></li><li><a class="level is-mobile" href="#加载数据库"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">加载数据库</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#应用-快捷方式"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">应用/快捷方式</span></span></a></li><li><a class="level is-mobile" href="#文件夹"><span class="level-left"><span class="level-item">2.2.2</span><span class="level-item">文件夹</span></span></a></li><li><a class="level is-mobile" href="#Widget"><span class="level-left"><span class="level-item">2.2.3</span><span class="level-item">Widget</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#绑定-Workspace-流程解析"><span class="level-left"><span class="level-item">3</span><span class="level-item">绑定 Workspace 流程解析</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#绑定屏幕"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">绑定屏幕</span></span></a></li><li><a class="level is-mobile" href="#绑定数据内容"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">绑定数据内容</span></span></a></li><li><a class="level is-mobile" href="#绑定-Widget"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">绑定 Widget</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/wikihow.svg" alt="wikiHow" height="28"></a><p class="is-size-7"><span>&copy; 2025 Marco</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© Honey Badger Team</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/pepsimaxin"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>