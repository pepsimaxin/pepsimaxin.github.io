{"posts":[{"title":"è¿™æ˜¯ä¸€ç¯‡é€šä¿—æ˜“æ‡‚çš„ã€Œåç¨‹ã€å…¥é—¨æŒ‡å—","text":"","link":"/2025/06/20/Kotlin%20--%20%E5%8D%8F%E7%A8%8B%20--%2001.%20%E5%8D%8F%E7%A8%8B%E5%85%A5%E9%97%A8/"},{"title":"è§£æ mutableStateOf æºç ","text":"å…¶å®åŸç†æ€§åˆ†æçš„æ–‡ç« ï¼ŒçœŸçš„å¾ˆéš¾è®²çš„é€šä¿—æ˜“æ‡‚ï¼Œè®²çš„ç®€å•æµ…æ˜¾æ²¡å¿…è¦å†™ï¼Œè®²çš„ç¹çéš¾æ‡‚å¾€å¾€å¤§å®¶ä¹Ÿä¸ä¹æ„çœ‹ï¼Œæ‰€ä»¥æ€ä¹ˆæ‰¾ä¸ªå¥½çš„è§’åº¦æ…¢æ…¢é’»è¿›å»å°¤ä¸ºé‡è¦ï¼Œæ¯”å¦‚ï¼šBegin simple codeï¼Œå¦‚æœç¡®å®èƒ½å¸®åŠ©åˆ°å¤§å®¶å®Œå…¨ç†è§£äº†æ–‡ç« æ‰€è®²è¿°åˆ°çš„æºç ç†è®ºï¼Œé‚£å°±ç‚¹ä¸ªèµå§ï¼ å¼•å…¥è¯é¢˜ æ­£å¦‚æˆ‘ä¸Šé¢è¯´çš„ï¼Œç›´æ¥è®²åŸç†å¤ªæ¯ç‡¥ï¼ˆä½ ä¹Ÿä¼šå¾ˆæ‡µï¼‰ï¼Œæˆ‘å–œæ¬¢ä»ç®€å•ä»£ç å…¥æ‰‹ï¼Œå¸¦ä½ ä¸€ç‚¹ç‚¹è¿›å…¥ï¼Œç°åœ¨å¼€å§‹ã€‚å…ˆçœ‹ä¸€ä¸ªæœ€ç®€å•çš„ä»£ç ç¤ºä¾‹ï¼š 1234567891011121314class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) // è¿™ç§å®šä¹‰å˜é‡çš„æ–¹å¼éšå¤„å¯è§äº† val name = mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { Text(name.value) } } }} æˆ‘å…ˆæ¥ç®€å•è§£è¯»ä¸€ä¸‹è¿™æ®µä»£ç çš„åŸç†ï¼š å½“æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç”¨ mutableStateOf åŒ…èµ·æ¥åï¼Œå®ƒå°±å˜æˆäº†ä¸€ä¸ª MutableState ç±»å‹çš„å¯¹è±¡ã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬å–å€¼çš„è¯å°±å¿…é¡»è¦å†™ name.valueï¼Œè¿™æ ·èƒ½æ‰èƒ½å–åˆ° â€œComposeâ€ï¼Œå› ä¸ºname ä¸å†æ˜¯ä¸€ä¸ª Stringï¼Œè€Œæ˜¯ MutableState å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å«â€œçŠ¶æ€â€ ã€‚ æ­¤æ—¶ï¼Œname æ˜¯ä¸€ä¸ªè¢«è®¢é˜…çš„çŠ¶æ€ï¼Œname.value å°±æ˜¯ä¸€ä¸ªè¢«è®¢é˜…çš„å€¼ï¼Œå¦‚æœå®ƒå‘ç”Ÿå˜åŒ–ï¼ŒText() å‡½æ•°å°±ä¼šé‡æ–°æ‰§è¡Œä¸€éï¼Œæ›´æ–°åˆ°æœ€æ–°çš„å€¼ã€‚ ç°åœ¨æˆ‘ä»¬ä¿®æ”¹ä¸‹ä»£ç ï¼Œ3s åæ”¹å˜ name.value çš„å€¼ï¼š 123456789101112131415161718class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) val name = mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { Text(name.value) } LaunchedEffect(true) { delay(3000) // 3s å»¶è¿Ÿ name.value = &quot;Kotlin&quot; // ä¿®æ”¹ name.value } } }} è¿è¡Œä¸‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/141782121dd4b200a5d4e86a30eb3edf.gif =400x) ç°åœ¨å…³äº mutableStateOf çš„ç”¨æ³•ä½ å·²ç»æŒæ¡äº†ï¼Œä½†åŒæ—¶å°±ä¼šäº§ç”Ÿäº†ä¸€ä¸ªç–‘é—®ï¼Œname è¢«è‡ªåŠ¨è®¢é˜…äº†ï¼Œå®ƒçš„å€¼æ”¹å˜äº†å°±ä¼šè®©ç•Œé¢é‡æ–°åˆ·æ–°ï¼Œè¿™èƒŒåçš„â€œçŠ¶æ€è®¢é˜…&amp;åˆ·æ–°æœºåˆ¶â€çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ å¦‚æœä½ æƒ³æ·±å…¥äº†è§£ï¼Œé‚£ä¹ˆæ¥ç€å¾€ä¸‹çœ‹ã€‚ çŠ¶æ€è®¢é˜…&amp;è‡ªåŠ¨åˆ·æ–° åŸºäº androidx.compose.runtime:runtime:1.4.0 ç‰ˆæœ¬ ç¡¬æ ¸éƒ¨åˆ†èµ°èµ·ï¼ŒæŸ¥çœ‹ mutableStateOf() æºç ï¼š 1234fun &lt;T&gt; mutableStateOf( value: T, policy: SnapshotMutationPolicy&lt;T&gt; = structuralEqualityPolicy()): MutableState&lt;T&gt; = createSnapshotMutableState(value, policy) mutableStateOf() è¿”å›çš„æ˜¯ä¸€ä¸ª MutableState å¯¹è±¡ï¼Œè¿™ä¸ªæˆ‘ä»¬å‰é¢è¯´è¿‡ã€‚ mutableStateOf() åˆè°ƒç”¨äº†å¦ä¸€ä¸ªå‡½æ•°ï¼š**createSnapshotMutableState()**ã€‚ è¿›å…¥ **createSnapshotMutableState()**ï¼š 1234internal actual fun &lt;T&gt; createSnapshotMutableState( value: T, policy: SnapshotMutationPolicy&lt;T&gt;): SnapshotMutableState&lt;T&gt; = ParcelableSnapshotMutableState(value, policy) åˆè°ƒç”¨äº† ParcelableSnapshotMutableState() å‡½æ•°ï¼š 1234567internal class ParcelableSnapshotMutableState&lt;T&gt;( value: T, policy: SnapshotMutationPolicy&lt;T&gt;) : SnapshotMutableStateImpl&lt;T&gt;(value, policy), Parcelable { // è¿™é‡Œå†…éƒ¨çš„ä»£ç å…¨éƒ¨éƒ½æ˜¯å¯¹ Parcelable æ¥å£çš„å®ç°ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒï¼Œä¸æ˜¯æ ¸å¿ƒå†…å®¹ ... ...} å…³é”®åœ¨ SnapshotMutableStateImplï¼Œå®ƒé‡Œé¢æ‰æ˜¯æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788internal open class SnapshotMutableStateImpl&lt;T&gt;( value: T, override val policy: SnapshotMutationPolicy&lt;T&gt;) : StateObject, SnapshotMutableState&lt;T&gt; { @Suppress(&quot;UNCHECKED_CAST&quot;) override var value: T get() = next.readable(this).value set(value) = next.withCurrent { if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } } } private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) override val firstStateRecord: StateRecord get() = next override fun prependStateRecord(value: StateRecord) { @Suppress(&quot;UNCHECKED_CAST&quot;) next = value as StateStateRecord&lt;T&gt; } @Suppress(&quot;UNCHECKED_CAST&quot;) override fun mergeRecords( previous: StateRecord, current: StateRecord, applied: StateRecord ): StateRecord? { val previousRecord = previous as StateStateRecord&lt;T&gt; val currentRecord = current as StateStateRecord&lt;T&gt; val appliedRecord = applied as StateStateRecord&lt;T&gt; return if (policy.equivalent(currentRecord.value, appliedRecord.value)) current else { val merged = policy.merge( previousRecord.value, currentRecord.value, appliedRecord.value ) if (merged != null) { appliedRecord.create().also { (it as StateStateRecord&lt;T&gt;).value = merged } } else { null } } } override fun toString(): String = next.withCurrent { &quot;MutableState(value=${it.value})@${hashCode()}&quot; } private class StateStateRecord&lt;T&gt;(myValue: T) : StateRecord() { override fun assign(value: StateRecord) { @Suppress(&quot;UNCHECKED_CAST&quot;) this.value = (value as StateStateRecord&lt;T&gt;).value } override fun create(): StateRecord = StateStateRecord(value) var value: T = myValue } /** * The componentN() operators allow state objects to be used with the property destructuring * syntax * * ``` * var (foo, setFoo) = remember { mutableStateOf(0) } * setFoo(123) // set * foo == 123 // get * ``` */ override operator fun component1(): T = value override operator fun component2(): (T) -&gt; Unit = { value = it } /** * A function used by the debugger to display the value of the current value of the mutable * state object without triggering read observers. */ @Suppress(&quot;unused&quot;) val debuggerDisplayValue: T @JvmName(&quot;getDebuggerDisplayValue&quot;) get() = next.withCurrent { it }.value} å¥½é•¿å•Šï½ç®—äº†ï¼Œä¸çœ‹äº†ğŸ™ˆâ€¦ æ¥ä¸‹æ¥æˆ‘å¸¦ä½ ä¸€æ­¥æ­¥æ¢ç´¢å…¶ä¸­çš„å¥¥ç§˜ï¼ å…ˆçœ‹å¼€å¤´éƒ¨åˆ†ï¼š 12345678910111213141516171819internal open class SnapshotMutableStateImpl&lt;T&gt;( value: T, override val policy: SnapshotMutationPolicy&lt;T&gt;) : StateObject, SnapshotMutableState&lt;T&gt; { @Suppress(&quot;UNCHECKED_CAST&quot;) override var value: T get() = next.readable(this).value set(value) = next.withCurrent { if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } } } private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) override val firstStateRecord: StateRecord get() = next ... ...} ä¸€ä¸ª value å±æ€§å°å…¥çœ¼å¸˜ï¼Œè¿™å°±æ˜¯æ–‡ç« å¼€å¤´ä»£ç é‡Œé¢ç”¨åˆ°çš„ name.valueã€‚ value æœ‰ get() å’Œ set() å‡½æ•°ï¼Œå¹¶ä¸”éƒ½æœ‰å…·ä½“çš„å®ç°ã€‚ ğŸ““ next æ˜¯ä¸ªå•¥ï¼Ÿ æ— è®ºæ˜¯ get() è¿˜æ˜¯ set() éƒ½æœ‰ä¸€ä¸ª nextã€‚ 12get() = next.readable(this).valueset(value) = next.withCurrent {...} å®ƒæ˜¯ä¸ªå•¥ï¼Ÿæˆ‘ä»¬å¾—å…ˆææ˜ç™½è¿™ä¸ªã€‚ 1private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) å®ƒçš„ç±»å‹æ˜¯ StateStateRecordï¼Œé‚£ StateStateRecord æœ‰æ˜¯ä¸ªå•¥ï¼Ÿ 12345678910private class StateStateRecord&lt;T&gt;(myValue: T) : StateRecord() { override fun assign(value: StateRecord) { @Suppress(&quot;UNCHECKED_CAST&quot;) this.value = (value as StateStateRecord&lt;T&gt;).value } override fun create(): StateRecord = StateStateRecord(value) var value: T = myValue} StateStateRecord ç»§æ‰¿äº† StateRecordï¼Œé‚£ StateRecord åˆæ˜¯ä¸ªå•¥å‘¢ï¼Ÿ 123456abstract class StateRecord { internal var snapshotId: Int = currentSnapshot().id // è®°å½•å¿«ç…§ id internal var next: StateRecord? = null // ä¸‹ä¸€ä¸ªçŠ¶æ€è®°å½•çš„å¼•ç”¨ï¼ŒçŠ¶æ€è®°å½•å­˜å‚¨åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ abstract fun assign(value: StateRecord) // å¤åˆ¶ StateRecord abstract fun create(): StateRecord // åˆ›å»ºä¸€ä¸ªæ–°çš„è®°å½•ç›¸åŒçš„ StateRecord} ä½ åªè¦çŸ¥é“ StateRecord æ˜¯ä¸€ä¸ªé“¾è¡¨çš„æ•°æ®ç»“æ„å³å¯ï¼Œè€Œ StateStateRecord å®ç°äº†å®ƒï¼Œå¹¶ä¸”å°† value è¿›è¡Œäº†å°è£…ã€‚ ä¸‹é¢æˆ‘ä»¬è¦è®²åˆ«çš„äº†ï¼Œå…ˆè®°ä½ï¼šStateRecord æ˜¯ä¸€ä¸ªé“¾è¡¨çš„æ•°æ®ç»“æ„ï¼ æ¥ç€è¯´ï¼Œå¦‚æœä½ ä»”ç»†çœ‹ä»£ç çš„è¯ï¼Œä¼šå‘ç° SnapshotMutableStateImpl å…¶å®ç»§æ‰¿äº†ä¸¤ä¸ªæ¥å£ï¼š 123456internal open class SnapshotMutableStateImpl&lt;T&gt;( value: T, override val policy: SnapshotMutationPolicy&lt;T&gt;) : StateObject, SnapshotMutableState&lt;T&gt; { ... ...} ä¸€ä¸ª StateObjetã€ä¸€ä¸ª SnapshotMutableStateã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ SnapshotMutableStateï¼š 123456interface SnapshotMutableState&lt;T&gt; : MutableState&lt;T&gt; { /** * A policy to control how changes are handled in a mutable snapshot. */ val policy: SnapshotMutationPolicy&lt;T&gt;} SnapshotMutableState ç»§æ‰¿äº† MutableStateï¼Œæ­£å¥½å¯¹åº”ç€æˆ‘ä»¬æ–‡ç« å¼€å¤´è¯´çš„ï¼ŒmutableStateOf() è¿”å›çš„å°±æ˜¯ä¸€ä¸ª MutableStateï¼Œæˆ‘ä»¬è¯´æ˜¯å› ä¸ºå®ƒå®ç°äº†è®¢é˜…ä»è€Œå¯ä»¥åˆ·æ–°ï¼Œä½†ï¼ï¼ï¼çœŸæ­£çš„åŸå› å¹¶ä¸æ˜¯å› ä¸ºå®ƒï¼ çœŸæ­£å®ç°çŠ¶æ€è®¢é˜…æœºåˆ¶çš„æ˜¯å¦å¤–ä¸€ä¸ªæ¥å£ï¼šStateObjetï¼ æˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸‹ StateObject è¿™ä¸ªå¤§ä½¬å¹²äº†ä»€ä¹ˆäº‹ï¼š 1234567891011121314interface StateObject { /** * The first state record in a linked list of state records. */ val firstStateRecord: StateRecord fun prependStateRecord(value: StateRecord) fun mergeRecords( previous: StateRecord, current: StateRecord, applied: StateRecord ): StateRecord? = null} ä»£ç éå¸¸ç®€å•ï¼Œä½†é‡Œé¢æœ‰ä¸€ä¸ªæ ¸å¿ƒï¼š 1val firstStateRecord: StateRecord å®ƒæ˜¯å¹²å˜›ç”¨çš„ï¼Ÿæˆ‘ä»¬å»ç…ç…å“ªé‡Œç”¨äº†å®ƒï¼š 1234private var next: StateStateRecord&lt;T&gt; = StateStateRecord(value) override val firstStateRecord: StateRecord get() = next å“¦ï¼ŒåŸæ¥ firstStateRecord æ˜¯ç”¨æ¥è®°å½• StateRecord è¿™ä¸ªé“¾è¡¨çš„ å¤´èŠ‚ç‚¹ ç”¨çš„ã€‚ ğŸ““ get() ä¸Šé¢åº”è¯¥ç®—æ˜¯æŠŠ next æ˜¯ä»€ä¹ˆè®²æ¸…æ¥šäº†å§ï¼Ÿâ€“ å®ƒå°±æ˜¯ StateRecordï¼Œæ›´å‡†ç¡®çš„è¯´å°±æ˜¯ StateRecord é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚ ä¸‹é¢æˆ‘ä»¬å¼€å§‹æ‰’æ‰’ get() å…·ä½“çš„é€»è¾‘äº†ã€‚ 1get() = next.readable(this).value è¿›å…¥ readable() ï¼š 1234567891011fun &lt;T : StateRecord&gt; T.readable(state: StateObject): T { val snapshot = Snapshot.current // ç¬¬ä¸€ä»¶äº‹ snapshot.readObserver?.invoke(state) // ç¬¬äºŒä»¶äº‹ return readable(this, snapshot.id, snapshot.invalid) ?: sync { val syncSnapshot = Snapshot.current @Suppress(&quot;UNCHECKED_CAST&quot;) readable(state.firstStateRecord as T, syncSnapshot.id, syncSnapshot.invalid) ?: readError() }} å¹²äº†ä¸¤ä»¶äº‹ï¼Œç¬¬ä¸€ä»¶äº‹ï¼š 1snapshot.readObserver?.invoke(state) // ç¬¬ä¸€ä»¶äº‹ readObserver æ˜¯ä¸€ä¸ªè¯»æ“ä½œçš„è§‚å¯Ÿè€…ï¼Œè¿™ä¸ªæ“ä½œæ˜¯è®°å½• StateObject ä¸­çš„å€¼è¢«å“ªé‡Œè°ƒç”¨äº†ï¼Œæ¯”å¦‚å¼€å¤´çš„ä»£ç ç¤ºä¾‹ï¼š 1234567891011121314151617181920class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) val name = mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { // è¿™é‡Œè°ƒç”¨äº† name.valueï¼Œå°±ä¼šæ‰§è¡Œåˆ°ï¼š // get() --&gt; readServer() --&gt; è®°å½•è¿™é‡Œè°ƒç”¨äº† value å€¼ Text(name.value) } LaunchedEffect(true) { delay(3000) name.value = &quot;Kotlin&quot; } } }} æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªæ“ä½œç†è§£ä¸ºå®ƒæ˜¯ä¸€ä¸ªè®¢é˜…æ“ä½œï¼šè®¢é˜…çŠ¶æ€ï¼Œè®°å½• name.value åœ¨å“ªé‡Œè°ƒç”¨äº†ã€‚ ç¬¬äºŒä»¶äº‹ï¼š 12345return readable(this, snapshot.id, snapshot.invalid) ?: sync { val syncSnapshot = Snapshot.current @Suppress(&quot;UNCHECKED_CAST&quot;) readable(state.firstStateRecord as T, syncSnapshot.id, syncSnapshot.invalid) ?: readError()} è°ƒç”¨äº†ä¸‰å‚æ•°çš„ readable()ï¼š 1234567891011121314151617private fun &lt;T : StateRecord&gt; readable(r: T, id: Int, invalid: SnapshotIdSet): T? { // The readable record is the valid record with the highest snapshotId var current: StateRecord? = r var candidate: StateRecord? = null while (current != null) { if (valid(current, id, invalid)) { candidate = if (candidate == null) current else if (candidate.snapshotId &lt; current.snapshotId) current else candidate } current = current.next } if (candidate != null) { @Suppress(&quot;UNCHECKED_CAST&quot;) return candidate as T } return null} å‰è¾¹æˆ‘ä»¬è¯´é”™ï¼šStateRecord æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œä¸‰å‚æ•°é‡Œé¢çš„å·¥ä½œå°±æ˜¯é€šè¿‡è¡¨å¤´å¯¹è±¡éå†åˆ—è¡¨æ¥è·å– æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecordã€‚ æœ€ç»ˆè¿”å›ä¸€ä¸ª æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecordã€‚ï¼ˆä»€ä¹ˆæ˜¯æœ€æ–°çš„ã€æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªå¯ä»¥ä¸ç”¨å…³å¿ƒï¼Œè¿™è·Ÿè¦ç»“åˆ Snapshot å¿«ç…§ç³»ç»Ÿè¯´ï¼Œä½ ç›´æ¥è¿‡æ»¤å³å¯ï¼Œä¸å½±å“æˆ‘ä»¬åŸç†çš„ç†è§£ï¼‰ æ‰€ä»¥ï¼Œæ•´ä¸ª readable() æ–¹æ³•å°±å¹²äº†ä¸¤ä»¶äº‹ï¼š è¿”å›æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecord è®°å½•åœ¨å“ªé‡Œè°ƒç”¨äº† value 1get() = next.readable(this).value æœ€åè¿˜å‰©ä¸€ä¸ª valueï¼Œè¿™å°±å¾ˆç®€å•äº†ï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡ StateStateRecord (StateRecord çš„å®ç°ç±») ä¼šå¯¹ value è¿›è¡Œå°è£…ï¼Œè€Œ StateRecord å®ƒä»¬åªæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæˆ‘ä»¬è¦è·å–åˆ°å€¼ï¼Œå°±è¦å†è°ƒç”¨ value è·å–å†…éƒ¨è¢«åŒ…ç€çš„å€¼ã€‚ åˆ°è¿™é‡Œ get() å°±è®²å®Œäº†ï¼ ğŸ““ set() ç°åœ¨æ¥çœ‹ set() çš„å…·ä½“ä»£ç ï¼šï¼ˆç»†èŠ‚ç‚¹æ³¨æ„ï¼šè¿™è¾¹æˆ‘æŠŠä»£ç æˆªå›¾äº†ï¼Œè€Œä¸æ˜¯çº¯ä»£ç æ®µï¼Œä½ ç•™æ„ä¸€ä¸‹ï¼Œä¸‹é¢ä¼šå›å½’åˆ°è¿™é‡Œï¼‰ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/548aff88360d4dffda83386ed2ee80e3.png =500x) next æ˜¯å•¥ä¸ç”¨è¯´äº†å§ï¼Œé‚£ withCurrent æ˜¯ä»€ä¹ˆï¼Ÿ 12inline fun &lt;T : StateRecord, R&gt; T.withCurrent(block: (r: T) -&gt; R): R = block(current(this, Snapshot.current)) å®ƒåªæœ‰ä¸€ä¸ªå‚æ•° blockï¼Œè€Œ block æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å‚æ•°ï¼Œå®ƒçš„å·¥ä½œå¾ˆç›´æ¥ï¼Œç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ç±»å‹çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ withCurrent åé¢è·Ÿç€çš„ Lambda è¡¨è¾¾å¼ã€‚ ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/63c3c244bd0959768487d28c00ed08ca.png =500x) block é‡Œé¢ä¼ å…¥äº†ä¸€ä¸ª current å‡½æ•°ï¼Œå®ƒåšäº†ä»€ä¹ˆï¼š 12internal fun &lt;T : StateRecord&gt; current(r: T, snapshot: Snapshot) = readable(r, snapshot.id, snapshot.invalid) ?: readError() å‘ç°äº†ä»€ä¹ˆï¼Ÿå®ƒè°ƒç”¨äº†ä¸€ä¸ªä¸‰å‚æ•°çš„ readable()ï¼Œä½ è¿˜è®°å¾—ä¸‰å‚æ•°çš„ readable() æ˜¯åšä»€ä¹ˆçš„å—ï¼Ÿ â‡’ è·å– æœ€æ–°çš„ã€æœ‰æ•ˆçš„ StateRecordã€‚ è¿™ä¸ªæ—¶å€™ä½ åœ¨çœ‹ä¸‹æˆ‘å¼€å¤´ä¸ºå•¥å¯¹ä»£ç åšäº†æˆªå›¾ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/df81d16a784a74cbb297037fdce6eda0.png =500x) æ‡‚å•¥æ„æ€æ²¡ï¼ŸwithCurrent ä¼ å…¥çš„ current å‡½æ•°çš„è¿”å›å€¼å°±å¯¹åº”ç€ä»£ç æç¤ºå™¨æç¤ºçš„ it å¯¹è±¡ï¼ˆä¸€ä¸ª StateStateRecordï¼‰ã€‚ æ¥ç€çœ‹ä»£ç ï¼š 123456set(value) = next.withCurrent { // åˆ¤æ–­æ–°æ—§å€¼ if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } }} if åˆ¤æ–­é‡Œé¢ä¼šåˆ¤æ–­å–åˆ°çš„ StateRecord çš„å€¼å’Œæ–°è®¾ç½®çš„å€¼æ˜¯å¦ç›¸åŒï¼Œæ²¡å˜ç›´æ¥ç»“æŸï¼Œå˜äº†å°±è¿›å…¥ä¸‹ä¸€æ­¥ overwritable()ã€‚ æˆ‘ä»¬çœ‹çœ‹å®ƒåšäº†ä»€ä¹ˆï¼š 123456789101112131415internal inline fun &lt;T : StateRecord, R&gt; T.overwritable( state: StateObject, candidate: T, block: T.() -&gt; R): R { var snapshot: Snapshot = snapshotInitializer return sync { // ç¬¬ä¸€ä»¶äº‹ snapshot = Snapshot.current // ç¬¬äºŒä»¶äº‹ this.overwritableRecord(state, snapshot, candidate).block() }.also { notifyWrite(snapshot, state) }} ä¹Ÿå¹²äº†ä¸¤ä»¶äº‹ï¼š è·å–å¿«ç…§ï¼›2. è°ƒç”¨äº†overwritableRecord() å‡½æ•°ï¼› Snapshot å¿«ç…§çš„çŸ¥è¯†æˆ‘ä»¬å¯ä»¥å…ˆå¿½ç•¥ï¼Œæ¥çœ‹ overwritableRecord() åšäº†ä»€ä¹ˆï¼š 12345678910111213141516171819internal fun &lt;T : StateRecord&gt; T.overwritableRecord( state: StateObject, snapshot: Snapshot, candidate: T): T { if (snapshot.readOnly) { snapshot.recordModified(state) } val id = snapshot.id if (candidate.snapshotId == id) return candidate val newData = newOverwritableRecord(state) newData.snapshotId = id snapshot.recordModified(state) return newData} è¿™æ®µä»£ç åˆæ¶‰åŠåˆ°äº†å¦å¤–ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šSnapshotï¼ˆå¿«ç…§ï¼‰ã€‚ æˆ‘ä»¬å°†ä»£ç åˆ†ä¸ºä¸¤ç«¯æ¥çœ‹ï¼š ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/9b9068d1ad9357f3b556a0a502884f0c.png =700x) æ ¸å¿ƒä»£ç å— 1ï¼šå¦‚æœä¼ è¿›æ¥çš„ StateRecord çš„å¿«ç…§ id æ­£å¥½å¯¹åº”å½“å‰ snapshot çš„ idï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ã€‚ æ ¸å¿ƒä»£ç å— 2ï¼šå¦åˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æˆ–è€…è¿”å›ä¸€ä¸ªå¼ƒç”¨çš„ StateRecordï¼Œç„¶åå°†å¿«ç…§ id èµ‹äºˆæ–°çš„ StateRecordã€‚ è¯´ç™½äº†æœ€ç»ˆå°±æ˜¯è¦å–åˆ°ä¸€ä¸ªå¯¹åº”å½“å‰ snapshot çš„ StateRecordï¼ ğŸ¤” æ­¤æ—¶å°±å­˜åœ¨ä¸€ä¸ªå¾ˆå¤§çš„ç–‘é—®äº†ï¼Ÿä»€ä¹ˆæ˜¯ Snapshotï¼ˆå¿«ç…§ï¼‰ï¼ŸSnapshot æ€ä¹ˆå’Œ StateRecord ç»‘åœ¨ä¸€èµ·äº†ï¼Ÿ å…³äº Compose çš„ Snapshot æœºåˆ¶ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç«  æ­ç§˜ Jetpack Composeå¿«ç…§ç³»ç»Ÿ ï¼Œè®²çš„å¾ˆå¥½ã€‚ ä½†ç”±äº Snapshot çœŸçš„ä¸æ˜¯ä¸€ä¸¤å¥å°±èƒ½è¯´æ¸…æ¥šçš„ï¼Œä½†æˆ‘ä»ç„¶å‘Šè¯‰ä½ å®ƒä¸å½±å“ä½ å¯¹è¿™ç¯‡æ–‡ç« åŸç†çš„ç†è§£ã€‚ ç»§ç»­å›åˆ°ä»£ç ï¼š 1234567891011121314internal inline fun &lt;T : StateRecord, R&gt; T.overwritable( state: StateObject, candidate: T, block: T.() -&gt; R): R { var snapshot: Snapshot = snapshotInitializer return sync { snapshot = Snapshot.current // å–åˆ°ä¸€ä¸ªå¯¹åº”å½“å‰ snapshot çš„ StateRecord this.overwritableRecord(state, snapshot, candidate).block() }.also { notifyWrite(snapshot, state) }} å–åˆ°å¯¹åº”å½“å‰ snapshot çš„ StateRecord åï¼Œç´§æ¥ç€è°ƒç”¨äº† block()ï¼Œå®ƒæ˜¯ä¼ è¿›æ¥çš„å‚æ•°ï¼Œæ˜¯å¤–é¢ä¼ è¿›æ¥çš„ï¼Œä¹Ÿå°±æ˜¯ {this.value = value}ã€‚ 123456set(value) = next.withCurrent { // åˆ¤æ–­æ–°æ—§å€¼ if (!policy.equivalent(it.value, value)) { next.overwritable(this, it) { this.value = value } }} åˆæ‹å›æ¥äº†ï¼ŒæŠŠä¼ å…¥çš„æ–°å€¼èµ‹å€¼ç»™æ‹¿åˆ°çš„ StateRecord å†…éƒ¨çš„ valueï¼Œè¿™ä¸å°±æ˜¯å†™æ–°å€¼çš„æ“ä½œä¹ˆï¼Ÿ åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯ set() æµç¨‹æ˜¯ä¸æ˜¯æˆ‘ä»¬å°±è®²å®Œäº†ï¼Ÿ Noï½ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ overwritable() æ–¹æ³•å†…éƒ¨ï¼š 1234567891011121314internal inline fun &lt;T : StateRecord, R&gt; T.overwritable( state: StateObject, candidate: T, block: T.() -&gt; R): R { var snapshot: Snapshot = snapshotInitializer return sync { snapshot = Snapshot.current // è¿™é‡Œè®²å®Œäº† this.overwritableRecord(state, snapshot, candidate).block() }.also { notifyWrite(snapshot, state) // ä½†è¿™é‡Œè¿˜æœ‰ä¸ª notifyWrite }} è¿˜æœ‰ä¸€è¡Œæˆ‘ä»¬é—æ¼äº†ï¼ŒnotifyWrite() åˆåšäº†ä»€ä¹ˆï¼Ÿ 123internal fun notifyWrite(snapshot: Snapshot, state: StateObject) { snapshot.writeObserver?.invoke(state)} æœ‰ç§ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿè§‰ï¼Œåœ¨å‰é¢åˆ†æ get() å‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿‡å•å‚æ•°çš„ readable() é‡Œé¢æœ‰ä¸€è¡Œï¼š 1snapshot.readObserver?.invoke(state) é‚£è¿™é‡Œçš„ä½œç”¨å‘¢ï¼Ÿ â‡’ å¯»æ‰¾å˜é‡åœ¨å“ªé‡Œè¢«è¯»äº†ï¼Œç„¶åå°†è¿™éƒ¨åˆ†å†…å®¹çš„ç»„åˆæ ‡è®°ä¸ºå¤±æ•ˆï¼Œç­‰åˆ°ä¸‹ä¸€å¸§çš„æ—¶å€™ä¼šé‡ç»„åˆ·æ–°ã€‚ æ‰€ä»¥ï¼Œæ•´ä¸ª set() æ–¹æ³•å°±å¹²äº†ä¸¤ä»¶äº‹ï¼š å°†ä¼ å…¥çš„å€¼èµ‹å€¼ç»™ StateRecord å†…éƒ¨çš„ value å†™å…¥é€šçŸ¥åˆ·æ–° åˆ°è¿™é‡Œæˆ‘ä»¬å°±åŸºæœ¬ä¸Šèƒ½å¤Ÿå¾ˆæ¸…æ™°çš„æ˜ç™½äº†çŠ¶æ€è®¢é˜…&amp;è‡ªåŠ¨åˆ·æ–°æœºåˆ¶çš„åŸç†äº†ï¼š å½“ get() è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¸ä»…è¿”å›å€¼ï¼Œè¿˜ä¼šè®°å½•è¯»å€¼çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯å“ªé‡Œè°ƒç”¨äº†ï¼ˆç›¸å½“äºè®¢é˜…ï¼‰ã€‚ å½“ set() è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¸ä»…ä¿®æ”¹å€¼ï¼Œè¿˜ä¼šæŸ¥æ‰¾è¯»å€¼çš„åœ°æ–¹ï¼Œç„¶åè¿›è¡Œåˆ·æ–°æ“ä½œï¼ˆç›¸å½“äºé€šçŸ¥ï¼‰ã€‚ ğŸ““ by åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¦‚æœæ¯æ¬¡è·å–å€¼éƒ½è¦åŠ ä¸Š value ä¼šæ˜¾å¾—å¾ˆå†—ä½™ï¼Œæ‰€ä»¥ Compose ç»™æˆ‘ä»¬æä¾›äº†ä¸€ç§æ›´æ–¹ä¾¿çš„å†™æ³•ï¼šbyã€‚å®ƒæ˜¯ Kotlin çš„ä¸€ä¸ªå…³é”®å­—ï¼Œè¡¨ç¤ºå·¦è¾¹çš„å˜é‡ç”¨å³è¾¹çš„å¯¹è±¡ä½œä¸ºä»£ç†ï¼ˆå§”æ‰˜ï¼‰ã€‚ 12345678910111213class MainActivity : ComponentActivity() { override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) val name by mutableStateOf(&quot;Compose&quot;) setContent { ComposeBlogTheme { Text(name) // å¯ä»¥ç›´æ¥ nameï¼Œè€Œä¸éœ€è¦ name.value } } }} å¦‚æœä½ è¿™ä¹ˆå†™ï¼ŒIDLE ä¼šæç¤ºæŠ¥é”™ï¼Œå› ä¸º name å§”æ‰˜ç»™äº† mutableStateOfï¼Œå¦‚æœæˆ‘ä»¬è¦è·å– name çš„å€¼ï¼Œé‚£å§”æ‰˜å¯¹è±¡éœ€è¦è°ƒç”¨ getValue() å’Œ setValue() ä¸¤ä¸ªå‡½æ•°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°éœ€è¦è‡ªå·±å®ç°ã€‚ ä½†å®é™…ä¸Šå¹¶ä¸éœ€è¦æˆ‘ä»¬å®ç°ï¼Œä½ é€šè¿‡æç¤ºä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¼å…¥ï¼Œå› ä¸º Compose å†…éƒ¨å·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº†è¿™ä¸ªæ–¹æ³•ã€‚ 12import androidx.compose.runtime.getValueimport androidx.compose.runtime.setValue è‡ªæ­¤ï¼Œå…³äº Compose çš„çŠ¶æ€è®¢é˜…&amp;è‡ªåŠ¨åˆ·æ–°æœºåˆ¶çš„åŸç†ç®—æ˜¯è®²æ˜ç™½äº†å§â€¦","link":"/2024/07/05/Compose%20--%20%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85%20&%20%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0%20--%2001.%20%E8%A7%A3%E6%9E%90%20mutableStateOf%20%E6%BA%90%E7%A0%81/"}],"tags":[{"name":"åç¨‹","slug":"åç¨‹","link":"/tags/%E5%8D%8F%E7%A8%8B/"},{"name":"çŠ¶æ€è®¢é˜… &amp; è‡ªåŠ¨æ›´æ–°","slug":"çŠ¶æ€è®¢é˜…-è‡ªåŠ¨æ›´æ–°","link":"/tags/%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/"}],"categories":[{"name":"Kotlin","slug":"Kotlin","link":"/categories/Kotlin/"},{"name":"Compose","slug":"Compose","link":"/categories/Compose/"},{"name":"åç¨‹","slug":"Kotlin/åç¨‹","link":"/categories/Kotlin/%E5%8D%8F%E7%A8%8B/"},{"name":"çŠ¶æ€è®¢é˜… &amp; è‡ªåŠ¨æ›´æ–°","slug":"Compose/çŠ¶æ€è®¢é˜…-è‡ªåŠ¨æ›´æ–°","link":"/categories/Compose/%E7%8A%B6%E6%80%81%E8%AE%A2%E9%98%85-%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/"}],"pages":[]}